<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pod | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.78bc0a69.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/283.0348af06.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.628f2b18.js"><link rel="prefetch" href="/noteSite/assets/js/100.282037ec.js"><link rel="prefetch" href="/noteSite/assets/js/101.3ec8c27f.js"><link rel="prefetch" href="/noteSite/assets/js/102.1a2b6eb7.js"><link rel="prefetch" href="/noteSite/assets/js/103.a3bf1dbd.js"><link rel="prefetch" href="/noteSite/assets/js/104.cfa69812.js"><link rel="prefetch" href="/noteSite/assets/js/105.889a8d1f.js"><link rel="prefetch" href="/noteSite/assets/js/106.40ec5dd8.js"><link rel="prefetch" href="/noteSite/assets/js/107.140f58aa.js"><link rel="prefetch" href="/noteSite/assets/js/108.fee713e2.js"><link rel="prefetch" href="/noteSite/assets/js/109.7200bc48.js"><link rel="prefetch" href="/noteSite/assets/js/11.094c1246.js"><link rel="prefetch" href="/noteSite/assets/js/110.91c77482.js"><link rel="prefetch" href="/noteSite/assets/js/111.0773e203.js"><link rel="prefetch" href="/noteSite/assets/js/112.5f252bfb.js"><link rel="prefetch" href="/noteSite/assets/js/113.a10a72d6.js"><link rel="prefetch" href="/noteSite/assets/js/114.1c61ea53.js"><link rel="prefetch" href="/noteSite/assets/js/115.555820e5.js"><link rel="prefetch" href="/noteSite/assets/js/116.1293de89.js"><link rel="prefetch" href="/noteSite/assets/js/117.f69650c9.js"><link rel="prefetch" href="/noteSite/assets/js/118.3ec9591b.js"><link rel="prefetch" href="/noteSite/assets/js/119.8db13744.js"><link rel="prefetch" href="/noteSite/assets/js/12.c34daa91.js"><link rel="prefetch" href="/noteSite/assets/js/120.ac60d308.js"><link rel="prefetch" href="/noteSite/assets/js/121.d218cf75.js"><link rel="prefetch" href="/noteSite/assets/js/122.55bed989.js"><link rel="prefetch" href="/noteSite/assets/js/123.1c0794c8.js"><link rel="prefetch" href="/noteSite/assets/js/124.e96b183f.js"><link rel="prefetch" href="/noteSite/assets/js/125.0c941fd1.js"><link rel="prefetch" href="/noteSite/assets/js/126.add326fd.js"><link rel="prefetch" href="/noteSite/assets/js/127.9882ace8.js"><link rel="prefetch" href="/noteSite/assets/js/128.9d64e490.js"><link rel="prefetch" href="/noteSite/assets/js/129.83d70ca4.js"><link rel="prefetch" href="/noteSite/assets/js/13.f5480015.js"><link rel="prefetch" href="/noteSite/assets/js/130.10d0158c.js"><link rel="prefetch" href="/noteSite/assets/js/131.d8842462.js"><link rel="prefetch" href="/noteSite/assets/js/132.c35a7f51.js"><link rel="prefetch" href="/noteSite/assets/js/133.b0b449d1.js"><link rel="prefetch" href="/noteSite/assets/js/134.80d10c6b.js"><link rel="prefetch" href="/noteSite/assets/js/135.c2899a28.js"><link rel="prefetch" href="/noteSite/assets/js/136.05464e5e.js"><link rel="prefetch" href="/noteSite/assets/js/137.c7f286cd.js"><link rel="prefetch" href="/noteSite/assets/js/138.ea14543e.js"><link rel="prefetch" href="/noteSite/assets/js/139.aaab20fc.js"><link rel="prefetch" href="/noteSite/assets/js/14.6195d2f0.js"><link rel="prefetch" href="/noteSite/assets/js/140.179ab391.js"><link rel="prefetch" href="/noteSite/assets/js/141.332b3aef.js"><link rel="prefetch" href="/noteSite/assets/js/142.d9bb7a8d.js"><link rel="prefetch" href="/noteSite/assets/js/143.2315d524.js"><link rel="prefetch" href="/noteSite/assets/js/144.5a063d55.js"><link rel="prefetch" href="/noteSite/assets/js/145.477dc678.js"><link rel="prefetch" href="/noteSite/assets/js/146.59b8ec7f.js"><link rel="prefetch" href="/noteSite/assets/js/147.c0a79bfa.js"><link rel="prefetch" href="/noteSite/assets/js/148.d16acb1a.js"><link rel="prefetch" href="/noteSite/assets/js/149.cba6037f.js"><link rel="prefetch" href="/noteSite/assets/js/15.ed2e2f3d.js"><link rel="prefetch" href="/noteSite/assets/js/150.1016b71d.js"><link rel="prefetch" href="/noteSite/assets/js/151.3b8e2c5e.js"><link rel="prefetch" href="/noteSite/assets/js/152.0b3941f8.js"><link rel="prefetch" href="/noteSite/assets/js/153.69581b97.js"><link rel="prefetch" href="/noteSite/assets/js/154.1b1a32b2.js"><link rel="prefetch" href="/noteSite/assets/js/155.3d608b91.js"><link rel="prefetch" href="/noteSite/assets/js/156.6426d84c.js"><link rel="prefetch" href="/noteSite/assets/js/157.4d8f6aca.js"><link rel="prefetch" href="/noteSite/assets/js/158.66cadbe0.js"><link rel="prefetch" href="/noteSite/assets/js/159.cd20bcec.js"><link rel="prefetch" href="/noteSite/assets/js/16.bbb3b0e4.js"><link rel="prefetch" href="/noteSite/assets/js/160.fb1465a5.js"><link rel="prefetch" href="/noteSite/assets/js/161.cf80c8b7.js"><link rel="prefetch" href="/noteSite/assets/js/162.3c9e9570.js"><link rel="prefetch" href="/noteSite/assets/js/163.c25e9714.js"><link rel="prefetch" href="/noteSite/assets/js/164.dd6a24a5.js"><link rel="prefetch" href="/noteSite/assets/js/165.df1998cb.js"><link rel="prefetch" href="/noteSite/assets/js/166.feb66be5.js"><link rel="prefetch" href="/noteSite/assets/js/167.68a92314.js"><link rel="prefetch" href="/noteSite/assets/js/168.a3a2177b.js"><link rel="prefetch" href="/noteSite/assets/js/169.56eb2d3f.js"><link rel="prefetch" href="/noteSite/assets/js/17.204dc718.js"><link rel="prefetch" href="/noteSite/assets/js/170.630d733c.js"><link rel="prefetch" href="/noteSite/assets/js/171.ff8b61bd.js"><link rel="prefetch" href="/noteSite/assets/js/172.32a326ea.js"><link rel="prefetch" href="/noteSite/assets/js/173.4f2eb5ee.js"><link rel="prefetch" href="/noteSite/assets/js/174.2121be31.js"><link rel="prefetch" href="/noteSite/assets/js/175.8d21940b.js"><link rel="prefetch" href="/noteSite/assets/js/176.811437b3.js"><link rel="prefetch" href="/noteSite/assets/js/177.98cfc47a.js"><link rel="prefetch" href="/noteSite/assets/js/178.723c48c9.js"><link rel="prefetch" href="/noteSite/assets/js/179.33dcc1fa.js"><link rel="prefetch" href="/noteSite/assets/js/18.b9adc259.js"><link rel="prefetch" href="/noteSite/assets/js/180.78ce7195.js"><link rel="prefetch" href="/noteSite/assets/js/181.97c0341c.js"><link rel="prefetch" href="/noteSite/assets/js/182.6c8c8fa8.js"><link rel="prefetch" href="/noteSite/assets/js/183.dc9920c4.js"><link rel="prefetch" href="/noteSite/assets/js/184.41fb24ad.js"><link rel="prefetch" href="/noteSite/assets/js/185.f05e3211.js"><link rel="prefetch" href="/noteSite/assets/js/186.83ecdcaf.js"><link rel="prefetch" href="/noteSite/assets/js/187.b80efad8.js"><link rel="prefetch" href="/noteSite/assets/js/188.144d6601.js"><link rel="prefetch" href="/noteSite/assets/js/189.f9b42496.js"><link rel="prefetch" href="/noteSite/assets/js/19.811bf034.js"><link rel="prefetch" href="/noteSite/assets/js/190.ade8431c.js"><link rel="prefetch" href="/noteSite/assets/js/191.f0d2ef47.js"><link rel="prefetch" href="/noteSite/assets/js/192.f305241b.js"><link rel="prefetch" href="/noteSite/assets/js/193.b9996bb7.js"><link rel="prefetch" href="/noteSite/assets/js/194.b30751d1.js"><link rel="prefetch" href="/noteSite/assets/js/195.8b9aed53.js"><link rel="prefetch" href="/noteSite/assets/js/196.d7e19144.js"><link rel="prefetch" href="/noteSite/assets/js/197.90b99159.js"><link rel="prefetch" href="/noteSite/assets/js/198.40484679.js"><link rel="prefetch" href="/noteSite/assets/js/199.971278e3.js"><link rel="prefetch" href="/noteSite/assets/js/20.78824865.js"><link rel="prefetch" href="/noteSite/assets/js/200.38d5aea5.js"><link rel="prefetch" href="/noteSite/assets/js/201.ca6479dd.js"><link rel="prefetch" href="/noteSite/assets/js/202.96d3a78f.js"><link rel="prefetch" href="/noteSite/assets/js/203.0306cc42.js"><link rel="prefetch" href="/noteSite/assets/js/204.574441a0.js"><link rel="prefetch" href="/noteSite/assets/js/205.d841779b.js"><link rel="prefetch" href="/noteSite/assets/js/206.7b411230.js"><link rel="prefetch" href="/noteSite/assets/js/207.2e366762.js"><link rel="prefetch" href="/noteSite/assets/js/208.2c9e1402.js"><link rel="prefetch" href="/noteSite/assets/js/209.9e026a69.js"><link rel="prefetch" href="/noteSite/assets/js/21.3060b19d.js"><link rel="prefetch" href="/noteSite/assets/js/210.db70770d.js"><link rel="prefetch" href="/noteSite/assets/js/211.126ac552.js"><link rel="prefetch" href="/noteSite/assets/js/212.a835c98a.js"><link rel="prefetch" href="/noteSite/assets/js/213.38b7cc2d.js"><link rel="prefetch" href="/noteSite/assets/js/214.22cf4cc5.js"><link rel="prefetch" href="/noteSite/assets/js/215.1fe74f0b.js"><link rel="prefetch" href="/noteSite/assets/js/216.4641e8c7.js"><link rel="prefetch" href="/noteSite/assets/js/217.cf474399.js"><link rel="prefetch" href="/noteSite/assets/js/218.eda994ff.js"><link rel="prefetch" href="/noteSite/assets/js/219.00ac3ec8.js"><link rel="prefetch" href="/noteSite/assets/js/22.f7b382c7.js"><link rel="prefetch" href="/noteSite/assets/js/220.35856088.js"><link rel="prefetch" href="/noteSite/assets/js/221.5c177eab.js"><link rel="prefetch" href="/noteSite/assets/js/222.93f8e761.js"><link rel="prefetch" href="/noteSite/assets/js/223.fe2f1e30.js"><link rel="prefetch" href="/noteSite/assets/js/224.f07c05c9.js"><link rel="prefetch" href="/noteSite/assets/js/225.9b7e7d32.js"><link rel="prefetch" href="/noteSite/assets/js/226.29291757.js"><link rel="prefetch" href="/noteSite/assets/js/227.9cd87366.js"><link rel="prefetch" href="/noteSite/assets/js/228.504a771e.js"><link rel="prefetch" href="/noteSite/assets/js/229.b4da6564.js"><link rel="prefetch" href="/noteSite/assets/js/23.0ee0c5eb.js"><link rel="prefetch" href="/noteSite/assets/js/230.82e9257b.js"><link rel="prefetch" href="/noteSite/assets/js/231.faa352cf.js"><link rel="prefetch" href="/noteSite/assets/js/232.9c0d51f2.js"><link rel="prefetch" href="/noteSite/assets/js/233.3cabb969.js"><link rel="prefetch" href="/noteSite/assets/js/234.bda5fd11.js"><link rel="prefetch" href="/noteSite/assets/js/235.41973943.js"><link rel="prefetch" href="/noteSite/assets/js/236.d7e9b2a7.js"><link rel="prefetch" href="/noteSite/assets/js/237.c6ab032b.js"><link rel="prefetch" href="/noteSite/assets/js/238.ab8fba20.js"><link rel="prefetch" href="/noteSite/assets/js/239.d747fd3f.js"><link rel="prefetch" href="/noteSite/assets/js/24.1a933e6c.js"><link rel="prefetch" href="/noteSite/assets/js/240.a6e05789.js"><link rel="prefetch" href="/noteSite/assets/js/241.b6267449.js"><link rel="prefetch" href="/noteSite/assets/js/242.60a5ac0b.js"><link rel="prefetch" href="/noteSite/assets/js/243.45e55930.js"><link rel="prefetch" href="/noteSite/assets/js/244.4484bdbe.js"><link rel="prefetch" href="/noteSite/assets/js/245.04a4c97c.js"><link rel="prefetch" href="/noteSite/assets/js/246.f4b01c95.js"><link rel="prefetch" href="/noteSite/assets/js/247.332d625f.js"><link rel="prefetch" href="/noteSite/assets/js/248.36e0d016.js"><link rel="prefetch" href="/noteSite/assets/js/249.2dc0c292.js"><link rel="prefetch" href="/noteSite/assets/js/25.df04ad1a.js"><link rel="prefetch" href="/noteSite/assets/js/250.a5ee5940.js"><link rel="prefetch" href="/noteSite/assets/js/251.499f34c5.js"><link rel="prefetch" href="/noteSite/assets/js/252.950b9505.js"><link rel="prefetch" href="/noteSite/assets/js/253.fd934acd.js"><link rel="prefetch" href="/noteSite/assets/js/254.907bdc13.js"><link rel="prefetch" href="/noteSite/assets/js/255.84f527c5.js"><link rel="prefetch" href="/noteSite/assets/js/256.d4045ce3.js"><link rel="prefetch" href="/noteSite/assets/js/257.87980787.js"><link rel="prefetch" href="/noteSite/assets/js/258.cc11e8e8.js"><link rel="prefetch" href="/noteSite/assets/js/259.4e85abd0.js"><link rel="prefetch" href="/noteSite/assets/js/26.4eb6fe37.js"><link rel="prefetch" href="/noteSite/assets/js/260.86680f2a.js"><link rel="prefetch" href="/noteSite/assets/js/261.2d91722e.js"><link rel="prefetch" href="/noteSite/assets/js/262.46b709a1.js"><link rel="prefetch" href="/noteSite/assets/js/263.80916e4b.js"><link rel="prefetch" href="/noteSite/assets/js/264.d2145b6a.js"><link rel="prefetch" href="/noteSite/assets/js/265.849fcf0e.js"><link rel="prefetch" href="/noteSite/assets/js/266.d0fee337.js"><link rel="prefetch" href="/noteSite/assets/js/267.fd9d75ad.js"><link rel="prefetch" href="/noteSite/assets/js/268.b4b731ae.js"><link rel="prefetch" href="/noteSite/assets/js/269.4725f346.js"><link rel="prefetch" href="/noteSite/assets/js/27.4f9dbcf8.js"><link rel="prefetch" href="/noteSite/assets/js/270.870390ab.js"><link rel="prefetch" href="/noteSite/assets/js/271.fd5a958d.js"><link rel="prefetch" href="/noteSite/assets/js/272.a4b45a6f.js"><link rel="prefetch" href="/noteSite/assets/js/273.d00537f4.js"><link rel="prefetch" href="/noteSite/assets/js/274.e11f06ca.js"><link rel="prefetch" href="/noteSite/assets/js/275.d4065601.js"><link rel="prefetch" href="/noteSite/assets/js/276.c0740696.js"><link rel="prefetch" href="/noteSite/assets/js/277.2c960ec4.js"><link rel="prefetch" href="/noteSite/assets/js/278.48cab14f.js"><link rel="prefetch" href="/noteSite/assets/js/279.dc23be7b.js"><link rel="prefetch" href="/noteSite/assets/js/28.8963a888.js"><link rel="prefetch" href="/noteSite/assets/js/280.9c4698e8.js"><link rel="prefetch" href="/noteSite/assets/js/281.d9110a36.js"><link rel="prefetch" href="/noteSite/assets/js/282.5842414e.js"><link rel="prefetch" href="/noteSite/assets/js/284.2f1c27b7.js"><link rel="prefetch" href="/noteSite/assets/js/285.acba88b9.js"><link rel="prefetch" href="/noteSite/assets/js/286.606a186b.js"><link rel="prefetch" href="/noteSite/assets/js/287.c15bd9ad.js"><link rel="prefetch" href="/noteSite/assets/js/288.a7dea751.js"><link rel="prefetch" href="/noteSite/assets/js/289.633d5757.js"><link rel="prefetch" href="/noteSite/assets/js/29.04f603ce.js"><link rel="prefetch" href="/noteSite/assets/js/290.218516da.js"><link rel="prefetch" href="/noteSite/assets/js/291.49481ae5.js"><link rel="prefetch" href="/noteSite/assets/js/292.26675bf4.js"><link rel="prefetch" href="/noteSite/assets/js/293.377a3647.js"><link rel="prefetch" href="/noteSite/assets/js/294.e965a965.js"><link rel="prefetch" href="/noteSite/assets/js/295.868d6151.js"><link rel="prefetch" href="/noteSite/assets/js/296.e7e6c1cf.js"><link rel="prefetch" href="/noteSite/assets/js/297.165242fb.js"><link rel="prefetch" href="/noteSite/assets/js/298.5ed0d68a.js"><link rel="prefetch" href="/noteSite/assets/js/299.3ab53994.js"><link rel="prefetch" href="/noteSite/assets/js/3.b99bc5ae.js"><link rel="prefetch" href="/noteSite/assets/js/30.3df858ff.js"><link rel="prefetch" href="/noteSite/assets/js/300.9a209449.js"><link rel="prefetch" href="/noteSite/assets/js/301.9749584a.js"><link rel="prefetch" href="/noteSite/assets/js/302.27722632.js"><link rel="prefetch" href="/noteSite/assets/js/303.42675b80.js"><link rel="prefetch" href="/noteSite/assets/js/304.c648e4e2.js"><link rel="prefetch" href="/noteSite/assets/js/305.71ecfaea.js"><link rel="prefetch" href="/noteSite/assets/js/306.63f00f92.js"><link rel="prefetch" href="/noteSite/assets/js/307.cb926dfb.js"><link rel="prefetch" href="/noteSite/assets/js/308.e3ba67f9.js"><link rel="prefetch" href="/noteSite/assets/js/309.c9f060ac.js"><link rel="prefetch" href="/noteSite/assets/js/31.3affb8bf.js"><link rel="prefetch" href="/noteSite/assets/js/32.9594ce12.js"><link rel="prefetch" href="/noteSite/assets/js/33.39c3f980.js"><link rel="prefetch" href="/noteSite/assets/js/34.d451f5d8.js"><link rel="prefetch" href="/noteSite/assets/js/35.956398a7.js"><link rel="prefetch" href="/noteSite/assets/js/36.a2f9b5ef.js"><link rel="prefetch" href="/noteSite/assets/js/37.ed56e679.js"><link rel="prefetch" href="/noteSite/assets/js/38.a302264c.js"><link rel="prefetch" href="/noteSite/assets/js/39.d4ec8557.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/40.bb4e9d8d.js"><link rel="prefetch" href="/noteSite/assets/js/41.3bff4415.js"><link rel="prefetch" href="/noteSite/assets/js/42.05904970.js"><link rel="prefetch" href="/noteSite/assets/js/43.b66267b7.js"><link rel="prefetch" href="/noteSite/assets/js/44.34ab495d.js"><link rel="prefetch" href="/noteSite/assets/js/45.5b47dd8c.js"><link rel="prefetch" href="/noteSite/assets/js/46.af6bc4ca.js"><link rel="prefetch" href="/noteSite/assets/js/47.1afd53d1.js"><link rel="prefetch" href="/noteSite/assets/js/48.ed1311a7.js"><link rel="prefetch" href="/noteSite/assets/js/49.3e5206df.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.118c4f5c.js"><link rel="prefetch" href="/noteSite/assets/js/51.5d056a28.js"><link rel="prefetch" href="/noteSite/assets/js/52.6f79a86f.js"><link rel="prefetch" href="/noteSite/assets/js/53.32be0296.js"><link rel="prefetch" href="/noteSite/assets/js/54.186fd282.js"><link rel="prefetch" href="/noteSite/assets/js/55.2a874220.js"><link rel="prefetch" href="/noteSite/assets/js/56.e8e5e0f5.js"><link rel="prefetch" href="/noteSite/assets/js/57.456e67d8.js"><link rel="prefetch" href="/noteSite/assets/js/58.5acd6529.js"><link rel="prefetch" href="/noteSite/assets/js/59.15fce7ff.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.c678e019.js"><link rel="prefetch" href="/noteSite/assets/js/61.2ba18d78.js"><link rel="prefetch" href="/noteSite/assets/js/62.841775c7.js"><link rel="prefetch" href="/noteSite/assets/js/63.a9993bf8.js"><link rel="prefetch" href="/noteSite/assets/js/64.1ddf279f.js"><link rel="prefetch" href="/noteSite/assets/js/65.b299ab47.js"><link rel="prefetch" href="/noteSite/assets/js/66.296fca64.js"><link rel="prefetch" href="/noteSite/assets/js/67.e8296499.js"><link rel="prefetch" href="/noteSite/assets/js/68.11521d20.js"><link rel="prefetch" href="/noteSite/assets/js/69.c793ef18.js"><link rel="prefetch" href="/noteSite/assets/js/7.f685cce4.js"><link rel="prefetch" href="/noteSite/assets/js/70.c7cfccac.js"><link rel="prefetch" href="/noteSite/assets/js/71.d35f74ae.js"><link rel="prefetch" href="/noteSite/assets/js/72.c85c8a37.js"><link rel="prefetch" href="/noteSite/assets/js/73.147b232f.js"><link rel="prefetch" href="/noteSite/assets/js/74.3dd31a8d.js"><link rel="prefetch" href="/noteSite/assets/js/75.35eafb0f.js"><link rel="prefetch" href="/noteSite/assets/js/76.82cffb73.js"><link rel="prefetch" href="/noteSite/assets/js/77.14a747da.js"><link rel="prefetch" href="/noteSite/assets/js/78.a4660cda.js"><link rel="prefetch" href="/noteSite/assets/js/79.7efb39a5.js"><link rel="prefetch" href="/noteSite/assets/js/8.976ce270.js"><link rel="prefetch" href="/noteSite/assets/js/80.fef2c333.js"><link rel="prefetch" href="/noteSite/assets/js/81.7226e5bc.js"><link rel="prefetch" href="/noteSite/assets/js/82.e90de050.js"><link rel="prefetch" href="/noteSite/assets/js/83.a6da0428.js"><link rel="prefetch" href="/noteSite/assets/js/84.046c88fa.js"><link rel="prefetch" href="/noteSite/assets/js/85.34eed660.js"><link rel="prefetch" href="/noteSite/assets/js/86.84b7db2f.js"><link rel="prefetch" href="/noteSite/assets/js/87.3e2d7a81.js"><link rel="prefetch" href="/noteSite/assets/js/88.e40df72b.js"><link rel="prefetch" href="/noteSite/assets/js/89.0bb511ab.js"><link rel="prefetch" href="/noteSite/assets/js/9.599a8138.js"><link rel="prefetch" href="/noteSite/assets/js/90.19771b7a.js"><link rel="prefetch" href="/noteSite/assets/js/91.8885479b.js"><link rel="prefetch" href="/noteSite/assets/js/92.0001d7dd.js"><link rel="prefetch" href="/noteSite/assets/js/93.2da2b7c3.js"><link rel="prefetch" href="/noteSite/assets/js/94.daf40c65.js"><link rel="prefetch" href="/noteSite/assets/js/95.1d6a5f7f.js"><link rel="prefetch" href="/noteSite/assets/js/96.83af16dc.js"><link rel="prefetch" href="/noteSite/assets/js/97.4fa1483c.js"><link rel="prefetch" href="/noteSite/assets/js/98.1d4e53ce.js"><link rel="prefetch" href="/noteSite/assets/js/99.89a53379.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link router-link-active">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link router-link-active">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux 基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Shell 脚本</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux IO</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/linux/k8s/k8s-introduction.html" class="sidebar-link">Kubernetes 简介</a></li><li><a href="/noteSite/linux/k8s/k8s-concept.html" class="sidebar-link">Kubernetes 名词</a></li><li><a href="/noteSite/linux/k8s/k8s-clusterbuild.html" class="sidebar-link">Kubernetes 集群搭建</a></li><li><a href="/noteSite/linux/k8s/k8s-namespace.html" class="sidebar-link">Namespace</a></li><li><a href="/noteSite/linux/k8s/k8s-label.html" class="sidebar-link">Label</a></li><li><a href="/noteSite/linux/k8s/k8s-pod.html" aria-current="page" class="active sidebar-link">Pod</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#一、pod-简介" class="sidebar-link">一、Pod 简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_1-pod-结构" class="sidebar-link">1. Pod 结构</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_2-pod-模板" class="sidebar-link">2. Pod 模板</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#二、查看-pod" class="sidebar-link">二、查看 Pod</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_1-查看所有-pod" class="sidebar-link">1. 查看所有 Pod</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_2-查看指定的-pod" class="sidebar-link">2. 查看指定的 Pod</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_3-查看指定-namespace-的-pod" class="sidebar-link">3. 查看指定 namespace 的 Pod</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_4-查看-pod-详细信息" class="sidebar-link">4. 查看 Pod 详细信息</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#三、运行-pod" class="sidebar-link">三、运行 Pod</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#四、访问-pod" class="sidebar-link">四、访问 Pod</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#五、创建-pod" class="sidebar-link">五、创建 Pod</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#六、删除-pod" class="sidebar-link">六、删除 Pod</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_1-通过命令行删除" class="sidebar-link">1. 通过命令行删除</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_2-通过配置文件删除" class="sidebar-link">2. 通过配置文件删除</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#七、pod-配置" class="sidebar-link">七、Pod 配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_1-查看配置项" class="sidebar-link">1. 查看配置项</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_2-基本配置" class="sidebar-link">2. 基本配置</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_3-镜像拉取策略" class="sidebar-link">3. 镜像拉取策略</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_4-启动命令" class="sidebar-link">4. 启动命令</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_5-环境变量" class="sidebar-link">5. 环境变量</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_6-端口设置" class="sidebar-link">6. 端口设置</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_7-资源配额" class="sidebar-link">7. 资源配额</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#八、pod-生命周期" class="sidebar-link">八、Pod 生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_1-pod-阶段" class="sidebar-link">1. Pod 阶段</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_2-pod-状况" class="sidebar-link">2. Pod 状况</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_3-容器状态" class="sidebar-link">3. 容器状态</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_4-pod-创建" class="sidebar-link">4. Pod 创建</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_5-pod-终止" class="sidebar-link">5. Pod 终止</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_6-init-容器" class="sidebar-link">6. init 容器</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_7-钩子函数" class="sidebar-link">7. 钩子函数</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_8-容器探测" class="sidebar-link">8. 容器探测</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_9-重启策略" class="sidebar-link">9. 重启策略</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#九、pod-调度" class="sidebar-link">九、Pod 调度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_1-定向调度" class="sidebar-link">1. 定向调度</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_2-亲和性调度" class="sidebar-link">2. 亲和性调度</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_3-污点" class="sidebar-link">3. 污点</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_4-容忍" class="sidebar-link">4. 容忍</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#十、临时容器" class="sidebar-link">十、临时容器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_1-临时容器简介" class="sidebar-link">1. 临时容器简介</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_2-临时容器作用" class="sidebar-link">2. 临时容器作用</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_3-临时容器配置" class="sidebar-link">3. 临时容器配置</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#_4-使用临时容器在线-debug" class="sidebar-link">4. 使用临时容器在线 debug</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#十一、服务质量-qos" class="sidebar-link">十一、服务质量 Qos</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-pod.html#十二、pod-控制器" class="sidebar-link">十二、Pod 控制器</a></li></ul></li><li><a href="/noteSite/linux/k8s/k8s-rs.html" class="sidebar-link">ReplicaSet</a></li><li><a href="/noteSite/linux/k8s/k8s-deployment.html" class="sidebar-link">Deployment</a></li><li><a href="/noteSite/linux/k8s/k8s-HPA.html" class="sidebar-link">Horizontal Pod Autoscaler</a></li><li><a href="/noteSite/linux/k8s/k8s-ds.html" class="sidebar-link">DaemonSet</a></li><li><a href="/noteSite/linux/k8s/k8s-job.html" class="sidebar-link">Job</a></li><li><a href="/noteSite/linux/k8s/k8s-service.html" class="sidebar-link">Service</a></li><li><a href="/noteSite/linux/k8s/k8s-ingress.html" class="sidebar-link">Ingress</a></li><li><a href="/noteSite/linux/k8s/k8s-ss.html" class="sidebar-link">StatefulSet</a></li><li><a href="/noteSite/linux/k8s/k8s-store.html" class="sidebar-link">Kubernetes 数据存储</a></li><li><a href="/noteSite/linux/k8s/k8s-auth.html" class="sidebar-link">Kubernetes 安全认证</a></li><li><a href="/noteSite/linux/k8s/k8s-dashboard.html" class="sidebar-link">Kubernetes DashBoard</a></li><li><a href="/noteSite/linux/k8s/interview.html" class="sidebar-link">面试题丨Kubernetes</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="pod"><a href="#pod" class="header-anchor">#</a> Pod</h1> <blockquote><p><em>Pod</em> 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。</p></blockquote> <h2 id="一、pod-简介"><a href="#一、pod-简介" class="header-anchor">#</a> 一、Pod 简介</h2> <h3 id="_1-pod-结构"><a href="#_1-pod-结构" class="header-anchor">#</a> 1. Pod 结构</h3> <img src="https://tva1.sinaimg.cn/large/008i3skNly1gs5tq1ha13j30q80iy42g.jpg" alt="image-20210705093808217" style="zoom:50%;"> <p>每个Pod中都包含一个或者多个容器，这些容器可以分为两类：</p> <ul><li><p>用户程序所在的容器，数量可多可少</p></li> <li><p>Pause 容器，这是每个 Pod 都会有的一个根容器，它的作用有两个：</p> <ul><li><p>可以以它为依据，评估整个 Pod 的健康状况。</p></li> <li><p>可以在根容器上设置 IP 地址，其它容器都共享此 IP（Pod 的 IP），以实现Pod内部的网络通信</p> <blockquote><p>这里是 <strong>Pod 内部</strong>的通讯。</p> <p><strong>Pod 之间</strong>的通讯采用<strong>虚拟二层网络技术</strong>来实现，我们当前环境使用的是 <strong>Flannel</strong>。</p></blockquote></li></ul></li></ul> <h3 id="_2-pod-模板"><a href="#_2-pod-模板" class="header-anchor">#</a> 2. Pod 模板</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1     <span class="token comment">#必选，版本号，例如v1</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod       　 <span class="token comment">#必选，资源类型，例如 Pod</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>       　 <span class="token comment">#必选，元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> string     <span class="token comment">#必选，Pod名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> string  <span class="token comment">#Pod所属的命名空间,默认为&quot;default&quot;</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>       　　  <span class="token comment">#自定义标签列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string      　          
<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token comment">#必选，Pod中容器的详细定义</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token comment">#必选，Pod中容器列表</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string   <span class="token comment">#必选，容器名称</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> string  <span class="token comment">#必选，容器的镜像名称</span>
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> Always<span class="token punctuation">|</span>Never<span class="token punctuation">|</span>IfNotPresent <span class="token punctuation">]</span>  <span class="token comment">#获取镜像的策略 </span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>   <span class="token comment">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>      <span class="token comment">#容器的启动命令参数列表</span>
    <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> string  <span class="token comment">#容器的工作目录</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>       <span class="token comment">#挂载到容器内部的存储卷配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string      <span class="token comment">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> string <span class="token comment">#存储卷在容器内mount的绝对路径，应少于512字符</span>
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> boolean <span class="token comment">#是否为只读模式</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment">#需要暴露的端口库号列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string        <span class="token comment">#端口的名称</span>
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> int  <span class="token comment">#容器需要监听的端口号</span>
      <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> int       <span class="token comment">#容器所在主机需要监听的端口号，默认与Container相同</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> string    <span class="token comment">#端口协议，支持TCP和UDP，默认TCP</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>   <span class="token comment">#容器运行前需设置的环境变量列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string  <span class="token comment">#环境变量名称</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> string <span class="token comment">#环境变量的值</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment">#资源限制和请求的设置</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment">#资源限制的设置</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> string     <span class="token comment">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> string  <span class="token comment">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment">#资源请求的设置</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> string    <span class="token comment">#Cpu请求，容器启动的初始可用数量</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> string <span class="token comment">#内存请求,容器启动的初始可用数量</span>
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span> <span class="token comment">#生命周期钩子</span>
		<span class="token key atrule">postStart</span><span class="token punctuation">:</span> <span class="token comment">#容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
		<span class="token key atrule">preStop</span><span class="token punctuation">:</span> <span class="token comment">#容器终止前执行此钩子,无论结果如何,容器都会终止</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>  <span class="token comment">#对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>       　 <span class="token comment">#对Pod容器内检查方式设置为exec方式</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>  <span class="token comment">#exec方式需要制定的命令或脚本</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>       <span class="token comment">#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> string
        <span class="token key atrule">port</span><span class="token punctuation">:</span> number
        <span class="token key atrule">host</span><span class="token punctuation">:</span> string
        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> string
        <span class="token key atrule">HttpHeaders</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string
          <span class="token key atrule">value</span><span class="token punctuation">:</span> string
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>     <span class="token comment">#对Pod内个容器健康检查方式设置为tcpSocket方式</span>
         <span class="token key atrule">port</span><span class="token punctuation">:</span> number
       <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>       <span class="token comment">#容器启动完成后首次探测的时间，单位为秒</span>
       <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> 0    　　    <span class="token comment">#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
       <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> 0     　　    <span class="token comment">#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
       <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">0</span>
       <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">0</span>
       <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
         <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Always <span class="token punctuation">|</span> Never <span class="token punctuation">|</span> OnFailure<span class="token punctuation">]</span>  <span class="token comment">#Pod的重启策略</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">&gt;</span> <span class="token comment">#设置NodeName表示将该Pod调度到指定到名称的node节点上</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> obeject <span class="token comment">#设置NodeSelector表示将该Pod调度到包含这个label的node上</span>
  <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span> <span class="token comment">#Pull镜像时使用的secret名称，以key：secretkey格式指定</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>   <span class="token comment">#在该pod上定义共享存储卷列表</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string    <span class="token comment">#共享存储卷名称 （volumes类型有很多种）</span>
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token comment">#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> string   <span class="token comment">#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> string      　　        <span class="token comment">#Pod所在宿主机的目录，将被用于同期中mount的目录</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>       　　　<span class="token comment">#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
      <span class="token key atrule">scretname</span><span class="token punctuation">:</span> string  
      <span class="token key atrule">items</span><span class="token punctuation">:</span>     
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> string
        <span class="token key atrule">path</span><span class="token punctuation">:</span> string
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token comment">#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> string
      <span class="token key atrule">items</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> string
        <span class="token key atrule">path</span><span class="token punctuation">:</span> string
</code></pre></div><p><strong>❓记不住怎么办？</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看某种资源可以配置的一级配置</span>
kubectl explain 资源类型 
<span class="token comment"># 查看属性的子属性</span>
kubectl explain 资源类型.属性
</code></pre></div><p>示例：查看资源类型为 pod 的可配置项</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod</span>
KIND:     Pod
VERSION:  v1

DESCRIPTION:
     Pod is a collection of containers that can run on a host. This resource is
     created by clients and scheduled onto hosts.

FIELDS:
   apiVersion	<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
   kind	<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
   metadata	<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
   spec	<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
   status	<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
</code></pre></div><p>Kubernetes 中基本所有资源的一级属性都是一样的，主要包含 5 个部分：</p> <ul><li>apiVersion  &lt;string&gt;：版本，由 Kubernetes 内部定义，版本号必须用 <code>kubectl api-versions</code> 查询。</li> <li>kind &lt;string&gt;：资源类型，由 Kubernetes 内部定义，类型必须用 <code>kubectl api-resources</code> 查询。</li> <li>metadata  &lt;Object&gt;：元数据，主要是资源标识和说明，常用的有 name、namespace、labels 等。</li> <li>spec &lt;Object&gt;：描述，这是配置中最重要的一部分，里面是对各种资源配置的详细描述。</li> <li>status &lt;Object&gt;：状态信息，里面的内容不需要定义，由 Kubernetes 自动生成。</li></ul> <p>在上面的属性中，<strong>spec</strong> 是接下来研究的重点，继续看下它的常见子属性：</p> <ul><li>containers &lt;[]Object&gt;：容器列表，用于定义容器的详细信息。</li> <li>nodeName &lt;String&gt;：根据 nodeName 的值将 Pod 调度到指定的 Node 节点上。</li> <li>nodeSelector &lt;map[]&gt; ：根据 NodeSelector 中定义的信息选择该 Pod 调度到包含这些 Label 的 Node 上。</li> <li>hostNetwork  &lt;boolean&gt;：是否使用<strong>主机网络模式</strong>，默认为 false，如果设置为 true，表示使用宿主机网络。</li> <li>volumes  &lt;[]Object&gt; ：存储卷，用于定义 Pod 上面挂载的存储信息。</li> <li>restartPolicy &lt;string&gt;：重启策略，表示 Pod 在遇到故障的时候的处理策略。</li></ul> <h2 id="二、查看-pod"><a href="#二、查看-pod" class="header-anchor">#</a> 二、查看 Pod</h2> <h3 id="_1-查看所有-pod"><a href="#_1-查看所有-pod" class="header-anchor">#</a> 1. 查看所有 Pod</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pods
</code></pre></div><h3 id="_2-查看指定的-pod"><a href="#_2-查看指定的-pod" class="header-anchor">#</a> 2. 查看指定的 Pod</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pods podName
</code></pre></div><h3 id="_3-查看指定-namespace-的-pod"><a href="#_3-查看指定-namespace-的-pod" class="header-anchor">#</a> 3. 查看指定 namespace 的 Pod</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pods -n ns名称
</code></pre></div><h3 id="_4-查看-pod-详细信息"><a href="#_4-查看-pod-详细信息" class="header-anchor">#</a> 4. 查看 Pod 详细信息</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe pods <span class="token punctuation">[</span>podName<span class="token punctuation">]</span> <span class="token punctuation">[</span>-n ns名称<span class="token punctuation">]</span>
</code></pre></div><h2 id="三、运行-pod"><a href="#三、运行-pod" class="header-anchor">#</a> 三、运行 Pod</h2> <p>Kubernetes 没有提供单独运行 Pod 的命令，都是通过 Pod 的控制器来实现的。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl run <span class="token punctuation">[</span>pod控制层名称<span class="token punctuation">]</span> <span class="token punctuation">[</span>参数<span class="token punctuation">]</span>
</code></pre></div><p>参数：</p> <ul><li>--image：指定 Pod 的镜像</li> <li>--port：指定端口</li> <li>--namespace：指定 namespace</li></ul> <p>举例：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run nginx --image=nginx:1.17.1 --port=80 --namespace=dev</span>
pod/nginx created
</code></pre></div><h2 id="四、访问-pod"><a href="#四、访问-pod" class="header-anchor">#</a> 四、访问 Pod</h2> <ul><li><p>获取 Pod 的 IP</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n dev -o wide</span>
NAME    READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES
nginx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          81s   <span class="token number">10.244</span>.1.3   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>访问 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token number">10.244</span>.1.3:80
</code></pre></div></li></ul> <h2 id="五、创建-pod"><a href="#五、创建-pod" class="header-anchor">#</a> 五、创建 Pod</h2> <p>前面「<strong>运行 Pod</strong>」 的时候就是创建 Pod 的一种方式。</p> <p>另外一种是通过<strong>配置文件</strong>来创建的：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create -f 配置文件路径
</code></pre></div><h2 id="六、删除-pod"><a href="#六、删除-pod" class="header-anchor">#</a> 六、删除 Pod</h2> <h3 id="_1-通过命令行删除"><a href="#_1-通过命令行删除" class="header-anchor">#</a> 1. 通过命令行删除</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete pod <span class="token punctuation">[</span>pod名称<span class="token punctuation">]</span> <span class="token punctuation">[</span>-n 命名空间<span class="token punctuation">]</span>
</code></pre></div><blockquote><p>删除 Pod，可以直接删除 Pod，也可以直接删除 Pod 对应的控制器。</p></blockquote> <h3 id="_2-通过配置文件删除"><a href="#_2-通过配置文件删除" class="header-anchor">#</a> 2. 通过配置文件删除</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete pod -f 配置文件路径
</code></pre></div><h2 id="七、pod-配置"><a href="#七、pod-配置" class="header-anchor">#</a> 七、Pod 配置</h2> <blockquote><p>本小节主要来研究 <strong>pod.spec.containers</strong> 属性，这也是 Pod 配置中最为关键的一项配置。</p></blockquote> <h3 id="_1-查看配置项"><a href="#_1-查看配置项" class="header-anchor">#</a> 1. 查看配置项</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers</span>
<span class="token comment"># 下面只展现出重要属性</span>
KIND:     Pod
VERSION:  v1
RESOURCE: containers <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">&gt;</span>   <span class="token comment"># 数组，代表可以有多个容器 FIELDS:</span>
  - name  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>     <span class="token comment"># 容器名称</span>
    image <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>     <span class="token comment"># 容器需要的镜像地址</span>
    imagePullPolicy  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token comment"># 镜像拉取策略 </span>
    <span class="token builtin class-name">command</span>  <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token operator">&gt;</span> <span class="token comment"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
    args   <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token operator">&gt;</span> <span class="token comment"># 容器的启动命令需要的参数列表 </span>
    <span class="token function">env</span>    <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">&gt;</span> <span class="token comment"># 容器环境变量的配置</span>
    ports  <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">&gt;</span>  <span class="token comment"># 容器需要暴露的端口号列表</span>
    resources <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token comment"># 资源限制和资源请求的设置</span>
</code></pre></div><h3 id="_2-基本配置"><a href="#_2-基本配置" class="header-anchor">#</a> 2. 基本配置</h3> <ul><li><p>创建一个 <code>pod-base.yaml</code> 文件，内容如下</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
	<span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>base
	<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
	<span class="token key atrule">labels</span><span class="token punctuation">:</span>
		<span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
	<span class="token key atrule">containers</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment">#容器名称</span>
	  <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment">#镜像名称</span>
	<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
</code></pre></div><p>上面定义了一个比较简单的 Pod 的配置，里面有两个容器：</p> <ul><li><p>nginx：用的是 1.17.1 版本的 nginx 镜像创建（nginx 是一个轻量级的 web 容器）。</p></li> <li><p>busybox：用的是 1.30 版本的 busybo 镜像创建（busybox 是一个小巧的 linux 命令集合）。</p></li></ul></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-base.yaml </span>
pod/pod-base created
</code></pre></div></li> <li><p>查看 Pod 状况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-base</span>
NAME       READY   STATUS             RESTARTS   AGE
pod-base   <span class="token number">1</span>/2     CrashLoopBackOff   <span class="token number">2</span>          77s
</code></pre></div><p>我们会发现它已经起来了，但是有问题。</p></li> <li><p>查看 Pod 详情</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-base</span>
Events:
  Type     Reason     Age              From                Message
  ----     ------     ----             ----                -------
  Normal   Scheduled  <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>        default-scheduler   Successfully assigned default/pod-base to k8s-node1
  Normal   Pulled     86s              kubelet, k8s-node1  Container image <span class="token string">&quot;nginx:1.17.1&quot;</span> already present on machine
  Normal   Created    86s              kubelet, k8s-node1  Created container nginx
  Normal   Started    85s              kubelet, k8s-node1  Started container nginx
  Normal   Pulling    85s              kubelet, k8s-node1  Pulling image <span class="token string">&quot;busybox:1.30&quot;</span>
  Normal   Pulled     9s               kubelet, k8s-node1  Successfully pulled image <span class="token string">&quot;busybox:1.30&quot;</span>
  Normal   Created    8s <span class="token punctuation">(</span>x2 over 9s<span class="token punctuation">)</span>  kubelet, k8s-node1  Created container busybox
  Normal   Started    8s <span class="token punctuation">(</span>x2 over 9s<span class="token punctuation">)</span>  kubelet, k8s-node1  Started container busybox
  Normal   Pulled     8s               kubelet, k8s-node1  Container image <span class="token string">&quot;busybox:1.30&quot;</span> already present on machine
  Warning  BackOff    6s <span class="token punctuation">(</span>x2 over 7s<span class="token punctuation">)</span>  kubelet, k8s-node1  Back-off restarting failed container
</code></pre></div></li></ul> <h3 id="_3-镜像拉取策略"><a href="#_3-镜像拉取策略" class="header-anchor">#</a> 3. 镜像拉取策略</h3> <blockquote><p>imagePullPolicy：用于设置镜像拉取的策略。</p></blockquote> <p>k8s 支持配置三种拉取策略：</p> <ul><li>Always：总是从远程仓库拉取镜像</li> <li>IfNotPresent：本地有则使用本地镜像，本地没有则从远程仓库拉取镜像</li> <li>Never：只使用本地镜像，从不去远程仓库拉取，本地没有就报错</li></ul> <blockquote><p>默认值说明：</p> <ul><li>如果镜像 tag 为具体的版本号，默认策略是 IfNotPresent</li> <li>如果镜像 tag 为 latest（最终版本），默认策略是 Always</li></ul></blockquote> <h3 id="_4-启动命令"><a href="#_4-启动命令" class="header-anchor">#</a> 4. 启动命令</h3> <blockquote><p>command：用于在Pod中的容器初始化完毕之后执行一个命令。</p></blockquote> <p>在前面的案例中，一直有一个问题没有解决，就是 busybox 容器一直没有成功运行，那么到底是什么原因导致这个容器的故障的呢？</p> <ul><li>原来 busybox 并不是一个程序，而是类似于一个工具类的集合，k8s 集群启动管理后，它会自动关闭。解决方法就是让其一直在运行，这就用到了 command 的配置。</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>command
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment"># 设置镜像拉取策略</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span> <span class="token comment"># 容器需要的镜像地址</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt;sleep 3;done;&quot;</span><span class="token punctuation">]</span>
</code></pre></div><ul><li>&quot;/bin/sh&quot;,&quot;-c&quot;：使用 sh 执行命令。</li> <li>touch /tmp/hello.txt：创建一个 <code>/tmp/hello.txt</code> 的文件。</li> <li>while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt;sleep 3;done：每隔 3 秒，向文件写入当前时间</li></ul> <blockquote><p>特别说明：通过上面发现 command 已经可以完成启动命令和传递参数的功能，为什么还要提供一个 args 选项，用于传递参数？</p> <p>其实和 Docker 有点关系，k8s 中的 <strong>command</strong> 和 <strong>args</strong> 两个参数其实是为了实现覆盖 <strong>Dockerfile</strong> 中的 <strong>ENTRYPOINT</strong> 的功能：</p> <ul><li>如果 command 和 args 均没有写，那么用 Dockerfile 的配置。</li> <li>如果 command 写了，但是 args 没有写，那么 Dockerfile 默认的配置会被忽略，执行注入的 command。</li> <li>如果 command 没有写，但是 args 写了，那么 Dockerfile 中配置的 ENTRYPOINT 命令会被执行，使用当前 args 的参数。</li> <li>如果 command 和 args 都写了，那么 Dockerfile 中的配置会被忽略，执行 command 并追加上 args 参数。</li></ul> <p>一句话：command 和 args 优先于 Dockerfile。</p></blockquote> <h3 id="_5-环境变量"><a href="#_5-环境变量" class="header-anchor">#</a> 5. 环境变量</h3> <blockquote><p>env：环境变量，用于在 Pod 中的容器设置环境变量。</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>env
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span> <span class="token comment"># 容器需要的镜像地址</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;touch /tmp/hello.txt;while true;do /bin/echo $(date +%T) &gt;&gt; /tmp/hello.txt;sleep 3;done;&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;username&quot;</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;admin&quot;</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;password&quot;</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
</code></pre></div><p>进入容器查看环境变量：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl exec pod-env -c busybox -it /bin/sh</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
/ <span class="token comment"># echo $username</span>
admin
/ <span class="token comment"># echo $password</span>
<span class="token number">123456</span>
/ <span class="token comment"># exit</span>
</code></pre></div><p>语法：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span> pod名称 <span class="token punctuation">[</span>-n 命名空间<span class="token punctuation">]</span> -c 容器名称 -it /bin/sh
</code></pre></div><ul><li>exec：执行命令</li> <li>-n：指定命名空间，默认为 default</li> <li>-c：指定容器名称</li> <li>-it：前台交互运行</li> <li>/bin/sh：进入容器后要执行的命令</li></ul> <h3 id="_6-端口设置"><a href="#_6-端口设置" class="header-anchor">#</a> 6. 端口设置</h3> <blockquote><p>ports：配置容器的端口信息。</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers.ports</span>
FIELDS:
  name <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token comment"># 端口名称，如果指定，必须保证 name 在 pod 中是唯一的</span>
  containerPort <span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span> <span class="token comment"># 容器要监听的端口(0&lt;x&lt;65536)</span>
  hostPort <span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span> <span class="token comment"># 容器要在主机上公开的端口，如果设置，主机上只能运行容器的一个副本(一般省略）</span>
  hostIP <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>  <span class="token comment"># 要将外部端口绑定到的主机IP(一般省略)</span>
  protocol <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>  <span class="token comment"># 端口协议。必须是UDP、TCP或SCTP。默认为“TCP”</span>
</code></pre></div><ul><li>访问Pod中的容器中的程序使用的是 <strong>PodIp:containerPort</strong></li></ul> <img src="https://tva1.sinaimg.cn/large/008i3skNly1gs5vmr7dj5j30mc0dkae5.jpg" alt="image-20210705104412416" style="zoom:50%;"> <h3 id="_7-资源配额"><a href="#_7-资源配额" class="header-anchor">#</a> 7. 资源配额</h3> <p>容器中的程序要运行，肯定会占用一定的资源，比如 CPU 和内存等，如果不对某个容器的资源做限制，那么它就可能吃掉大量的资源，导致其他的容器无法运行。针对这种情况，k8s 提供了对内存和 CPU 的资源进行配额的机制，这种机制主要通过 <strong>resources</strong> 选项实现，它有两个子选项：</p> <ul><li>limits：用于限制运行的容器的最大占用资源，当容器占用资源超过 limits 时会被终止，并进行重启。</li> <li>requests：用于设置容器需要的最小资源，如果环境资源不够，容器将无法启动。</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>resoures
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment"># 设置镜像拉取策略</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 端口设置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port <span class="token comment"># 端口名称，如果执行，必须保证name在Pod中是唯一的</span>
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 容器要监听的端口 （0~65536）</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment"># 端口协议</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 资源配额</span>
        <span class="token key atrule">limits</span><span class="token punctuation">:</span> <span class="token comment"># 限制资源的上限</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span> <span class="token comment"># CPU限制，单位是core数</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Gi&quot;</span> <span class="token comment"># 内存限制</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># 限制资源的下限</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span> <span class="token comment"># CPU限制，单位是core数 </span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Mi&quot;</span> <span class="token comment"># 内存限制</span>
</code></pre></div><ul><li>cpu：core 数，可以为整数或小数</li> <li>memory：内存大小，可以使用 Gi、Mi、G、M 等形式</li></ul> <h2 id="八、pod-生命周期"><a href="#八、pod-生命周期" class="header-anchor">#</a> 八、Pod 生命周期</h2> <p>我们一般将 Pod 对象<strong>从创建到终止</strong>的这段时间范围称为 Pod 的生命周期，它主要包含下面的过程：</p> <ol><li>Pod 创建过程</li> <li>运行初始化容器（init container）过程</li> <li>运行主容器（main container）：
<ol><li>容器启动后钩子（post start）、容器终止前钩子（pre stop）</li> <li>容器的存活性探测（liveness probe）、就绪性探测（readiness probe）</li></ol></li> <li>Pod终止过程。</li></ol> <img src="https://tva1.sinaimg.cn/large/008i3skNly1gs5vuc8j1bj314k0m27gl.jpg" alt="image-20210705105129499" style="zoom:50%;"> <h3 id="_1-pod-阶段"><a href="#_1-pod-阶段" class="header-anchor">#</a> 1. Pod 阶段</h3> <table><thead><tr><th style="text-align:left;">取值</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>Pending</code>（悬决）</td> <td style="text-align:left;">Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</td></tr> <tr><td style="text-align:left;"><code>Running</code>（运行中）</td> <td style="text-align:left;">Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态。</td></tr> <tr><td style="text-align:left;"><code>Succeeded</code>（成功）</td> <td style="text-align:left;">Pod 中的所有容器都已成功终止，并且不会再重启。</td></tr> <tr><td style="text-align:left;"><code>Failed</code>（失败）</td> <td style="text-align:left;">Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</td></tr> <tr><td style="text-align:left;"><code>Unknown</code>（未知）</td> <td style="text-align:left;">因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</td></tr></tbody></table> <blockquote><p>如果某节点死掉或者与集群中其他节点失联，Kubernetes 会实施一种策略，将失去的节点上运行的所有 Pod 的 <code>phase</code> 设置为 <code>Failed</code>。</p></blockquote> <h3 id="_2-pod-状况"><a href="#_2-pod-状况" class="header-anchor">#</a> 2. Pod 状况</h3> <p>Pod 有一个 <code>PodStatus</code> 对象，其中包含一个 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.21/#podcondition-v1-core" target="_blank" rel="noopener noreferrer">PodConditions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 数组。Pod 可能通过也可能未通过其中的一些状况测试。</p> <ul><li><code>PodScheduled</code>：Pod 已经被调度到某节点；</li> <li><code>ContainersReady</code>：Pod 中所有容器都已就绪；</li> <li><code>Initialized</code>：所有的 <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener noreferrer">Init 容器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 都已成功启动；</li> <li><code>Ready</code>：Pod 可以为请求提供服务，并且应该被添加到对应服务的负载均衡池中。</li></ul> <table><thead><tr><th style="text-align:left;">字段名称</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>type</code></td> <td style="text-align:left;">Pod 状况的名称</td></tr> <tr><td style="text-align:left;"><code>status</code></td> <td style="text-align:left;">表明该状况是否适用，可能的取值有 &quot;<code>True</code>&quot;, &quot;<code>False</code>&quot; 或 &quot;<code>Unknown</code>&quot;</td></tr> <tr><td style="text-align:left;"><code>lastProbeTime</code></td> <td style="text-align:left;">上次探测 Pod 状况时的时间戳</td></tr> <tr><td style="text-align:left;"><code>lastTransitionTime</code></td> <td style="text-align:left;">Pod 上次从一种状态转换到另一种状态时的时间戳</td></tr> <tr><td style="text-align:left;"><code>reason</code></td> <td style="text-align:left;">机器可读的、驼峰编码（UpperCamelCase）的文字，表述上次状况变化的原因</td></tr> <tr><td style="text-align:left;"><code>message</code></td> <td style="text-align:left;">人类可读的消息，给出上次状态转换的详细信息</td></tr></tbody></table> <h3 id="_3-容器状态"><a href="#_3-容器状态" class="header-anchor">#</a> 3. 容器状态</h3> <p>一旦 Kube Scheduler 将 Pod 分派给某个节点，<code>kubelet</code> 就通过 Container Runtime 开始为 Pod 创建容器。</p> <p>容器的状态有三种：</p> <ul><li><code>Waiting</code>（等待）</li> <li><code>Running</code>（运行中）</li> <li><code>Terminated</code>（已终止）</li></ul> <h3 id="_4-pod-创建"><a href="#_4-pod-创建" class="header-anchor">#</a> 4. Pod 创建</h3> <ol><li><p>用户通过 <strong>kubectl</strong> 或其他的 API 客户端提交需要创建的 Pod 信息给 <strong>API Server</strong></p></li> <li><p>API Server 开始生成 Pod 对象的信息，并将信息存入 <strong>etcd</strong>，然后返回确认信息至客户端</p></li> <li><p>API Server 开始反映 <strong>etcd</strong> 中的 Pod 对象的变化，其它组件使用 <strong>watch 机制</strong>来跟踪检查 API Server上 的变动</p> <p>3.1 Scheduler 发现有新的 Pod 对象要创建，开始为 Pod 分配主机并将结果信息更新至 API Server</p> <p>3.2 Node 节点上的 kubelet 发现有 Pod 调度过来，尝试调度 Docker 启动容器，并将结果回送至 API Server</p></li> <li><p>API Server 将接收到的 Pod 状态信息存入到 etcd 中</p></li></ol> <p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gs5wpf9dj5j312c0k0130.jpg" alt="image-20210705112122258"></p> <h3 id="_5-pod-终止"><a href="#_5-pod-终止" class="header-anchor">#</a> 5. Pod 终止</h3> <ol><li>用户向 API Server 发送删除 Pod 对象的命令</li> <li>API Server 中的 Pod 对象信息会随着时间的推移而更新，在宽限期内（默认30s），Pod 被视为 <strong>dead</strong></li> <li>将 Pod 标记为 <strong>Terminating</strong> 状态</li> <li><strong>kubelet</strong> 在监控到 Pod 对象转为 <strong>Terminating</strong> 状态的同时启动 Pod 关闭过程</li> <li><strong>端点控制器</strong>监控到 Pod 对象的关闭行为时将其从所有匹配到此端点的 <strong>Service</strong> 资源的端点列表中移除</li> <li>如果当前 Pod 对象定义了 <strong>preStop 钩子处理器</strong>，则在其标记为 Terminating 后会以<strong>同步</strong>的方式启动执行</li> <li>Pod 对象中的容器进程收到停止信号</li> <li>宽限期结束后，如果 Pod 中还存在运行的进程，那么 Pod 对象会收到立即终止的信号</li> <li>kubectl 请求 API Server 将此 Pod 资源的宽限期设置为 0 从而完成删除操作，此时Pod对于用户已经不可用了</li></ol> <h3 id="_6-init-容器"><a href="#_6-init-容器" class="header-anchor">#</a> 6. init 容器</h3> <p>init 容器是在 Pod 的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p> <ul><li><strong>必须成功</strong>：初始化容器必须运行完成直至结束，如果某个初始化容器运行失败，那么 k8s 需要重启它直至成功完成</li> <li><strong>顺序执行</strong>：初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行</li></ul> <p>init 容器有很多的应用场景，下面列出的是最常见的几个：</p> <ul><li>提供主容器镜像中不具备的工具程序或自定义代码</li> <li>init 容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足</li></ul> <blockquote><p>下面做一个案例，来感受一下 init 容器的作用。</p> <ul><li>假设要以主容器来运行 Nginx，但是要求在运行 Nginx 之前要能够连接上 MySQL 和 Redis 所在的服务器</li> <li>为了简化测试，事先规定好 MySQL 和 Redis 所在的 IP 地址分别为 172.16.58.203 和 172.16.58.204，能 ping 通就表示我们能连接上。</li></ul></blockquote> <p><strong>6.1 创建 pod-initcontainer.yaml 文件</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
	<span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>initcontainer
	<span class="token key atrule">labels</span><span class="token punctuation">:</span>
		<span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
	<span class="token key atrule">containers</span><span class="token punctuation">:</span>
		<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
			<span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
			<span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
			<span class="token key atrule">ports</span><span class="token punctuation">:</span>
				<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
					<span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
					<span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
			<span class="token key atrule">resources</span><span class="token punctuation">:</span>
				<span class="token key atrule">limits</span><span class="token punctuation">:</span>
					<span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>
					<span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Gi&quot;</span>
				<span class="token key atrule">requests</span><span class="token punctuation">:</span>
					<span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
					<span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Mi&quot;</span>
	<span class="token key atrule">initContainers</span><span class="token punctuation">:</span>  <span class="token comment"># init 容器配置：跟 containers 平级</span>
		<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>mysql
			<span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
			<span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;until ping 172.16.58.203 -c 1;do echo waiting for mysql ....;sleep 2;done;&quot;</span><span class="token punctuation">]</span>
			<span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
				<span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#使用特权模式运行容器</span>
		<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>redis
			<span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
			<span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;until ping 172.16.58.204 -c 1;do echo waiting for redis ....;sleep 2;done;&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p><strong>6.2 创建 Pod</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-initconatiner.yaml </span>
pod/pod-initcontainer created
</code></pre></div><p><strong>6.3 查看 Pod 状态</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-initcontainer</span>
NAME                READY   STATUS     RESTARTS   AGE
pod-initcontainer   <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          93s
</code></pre></div><p>发现 <code>Init:0/2</code>，说明我们的 <strong>init 容器</strong> 并没有执行成功，需要一直重试。<strong>这里失败的原因是我们并没有 172.16.58.203 和 172.16.58.204 这两个地址，所以必然是失败的。</strong></p> <p><strong>6.4 动态监听 Pod 状态</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-initcontainer -w</span>
NAME                READY   STATUS     RESTARTS   AGE
pod-initcontainer   <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          3m31s
<span class="token comment">#监听中</span>
</code></pre></div><p><strong>6.5 新增 IP</strong></p> <p>我们新开一个 Shell 来为当前服务器新增 172.16.58.203 和 172.16.58.204 这两个 IP。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ifconfig</span> ens33:1 <span class="token number">172.16</span>.58.203 netmask <span class="token number">255.255</span>.255.0 up
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ifconfig</span> ens33:2 <span class="token number">172.16</span>.58.204 netmask <span class="token number">255.255</span>.255.0 up
</code></pre></div><p>可以查看：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># ifconfig</span>
<span class="token comment"># 刚刚新增的两个 IP</span>
ens33:1: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">172.16</span>.58.203  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">172.16</span>.58.255
        ether 00:0c:29:da:d1:91  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
ens33:2: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">172.16</span>.58.204  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">172.16</span>.58.255
        ether 00:0c:29:da:d1:91  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
</code></pre></div><p>同时监控到 pod-initcontainer 的变化：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-initcontainer -w</span>
NAME                READY   STATUS     RESTARTS   AGE
pod-initcontainer   <span class="token number">0</span>/1     Init:0/2   <span class="token number">0</span>          3m31s
pod-initcontainer   <span class="token number">0</span>/1     Init:1/2   <span class="token number">0</span>          6m38s
pod-initcontainer   <span class="token number">0</span>/1     PodInitializing   <span class="token number">0</span>          6m39s
pod-initcontainer   <span class="token number">1</span>/1     Running           <span class="token number">0</span>          6m40s
</code></pre></div><p>这就是 init 容器的简单演示了。</p> <h3 id="_7-钩子函数"><a href="#_7-钩子函数" class="header-anchor">#</a> 7. 钩子函数</h3> <p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。</p> <p>k8s 在主容器启动之后和停止之前提供了两个钩子函数：</p> <ul><li>postStart：容器创建之后执行，如果失败会重启容器</li> <li>preStop：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</li></ul> <p>钩子处理器支持使用下面的三种方式定义动作：</p> <ul><li><p>exec 命令：在容器内执行一次的命令</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
     <span class="token key atrule">postStart</span><span class="token punctuation">:</span> 
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
           <span class="token key atrule">command</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> cat
             <span class="token punctuation">-</span> /tmp/healthy
……
</code></pre></div></li> <li><p>tcpSocket：当前容器尝试访问指定的 socket</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>…… 
   <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
         <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
……
</code></pre></div></li> <li><p>httpGet：在当前容器中向某 url 发起 HTTP 请求</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>…… 
   <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
         <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI地址</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> 172.16.58.200 <span class="token comment">#主机地址  </span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http或者https</span>
……
</code></pre></div></li></ul> <blockquote><p>接下来，以 exec 方式为例，演示下钩子函数的使用。</p></blockquote> <p><strong>7.1 创建 pod-hook-exec.yaml 文件</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
	<span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>exec
	<span class="token key atrule">labels</span><span class="token punctuation">:</span>
		<span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
	<span class="token key atrule">containers</span><span class="token punctuation">:</span>
		<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
		  <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
			<span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
			<span class="token key atrule">ports</span><span class="token punctuation">:</span>
				<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
					<span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
					<span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
			<span class="token key atrule">resources</span><span class="token punctuation">:</span>
				<span class="token key atrule">limits</span><span class="token punctuation">:</span>
					<span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>
					<span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Gi&quot;</span>
				<span class="token key atrule">requests</span><span class="token punctuation">:</span>
					<span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
					<span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Mi&quot;</span>
			<span class="token key atrule">lifecycle</span><span class="token punctuation">:</span> <span class="token comment">#生命周期的相关配置</span>
				<span class="token key atrule">postStart</span><span class="token punctuation">:</span> <span class="token comment">#容器创建之后执行，如果失败会重启容器</span>
					<span class="token key atrule">exec</span><span class="token punctuation">:</span> <span class="token comment">#只执行一次的命令，下面命令在容器启动的时候，执行一条命令，修改掉Nginx的首页内容</span>
						<span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;echo postStart ... &gt; /usr/share/nginx/html/index.html&quot;</span><span class="token punctuation">]</span>
				<span class="token key atrule">preStop</span><span class="token punctuation">:</span> <span class="token comment">#容器终止之前执行，执行完成之后容器将成功停止，在其完成之前会阻塞删除容器</span>
						<span class="token key atrule">exec</span><span class="token punctuation">:</span> <span class="token comment">#下面命令在容器停止之前停止 Nginx 的服务</span>
							<span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/usr/sbin/nginx&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-s&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;quit&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p><strong>7.2 创建 Pod</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-hook-exec.yaml </span>
pod/pod<span class="token punctuation">-</span>hook<span class="token punctuation">-</span>exec created
</code></pre></div><p><strong>7.3 查看 Pod 状况</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-hook-exec -o wide</span>
NAME            READY   STATUS    RESTARTS   AGE     IP            NODE        NOMINATED NODE   READINESS GATES
pod-hook-exec   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m31s   <span class="token number">10.244</span>.1.14   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p><strong>7.4 访问 Nginx 首页，看看 postStart 是否成功</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># curl 10.244.1.14</span>
postStart <span class="token punctuation">..</span>.
</code></pre></div><h3 id="_8-容器探测"><a href="#_8-容器探测" class="header-anchor">#</a> 8. 容器探测</h3> <p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么k8s 就会把该问题实例“<strong>摘除</strong>”，不承担业务流量。</p> <p>k8s 提供了两种探针来实现容器探测，分别是：</p> <ul><li><strong>liveness probes（存活性探测）</strong>：用于检测应用实例当前是否处于正常运行状态，如果不是，k8s  会重启容器</li> <li><strong>readiness probes（就绪性探测）</strong>：用于检测应用实例是否可以接受请求，如果不能，k8s 不会转发流量</li></ul> <blockquote><p>k8s 在 <code>1.16</code> 版本之后新增了 <strong>startupProbe</strong> 探针，用于判断容器内应用程序<strong>是否已经启动</strong>。如果配置了 startupProbe 探针，就会先禁止其他的探针，直到 startupProbe 探针成功为止，一旦成功将不再进行探测。</p></blockquote> <p><strong>上述探针目前均支持三种探测方式：</strong></p> <ul><li><p>exec 命令：在容器内支线一次命令，如何命令执行的退出吗为 0，则认为程序正常，否则异常</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
     <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> cat
          <span class="token punctuation">-</span> /tmp/healthy
……
</code></pre></div></li> <li><p>tcpSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则异常</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
   <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
         <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
……
</code></pre></div></li> <li><p>httpGet：调用容器内 web 应用的 URL，如果返回的状态码在 200 和 399 之间，则认为程序正常，否则异常</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
   <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
         <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI地址</span>
         <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span>
         <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1 <span class="token comment">#主机地址</span>
         <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http或者https</span>
……
</code></pre></div></li></ul> <p><strong>限制探测条件：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment"># kubectl explain pod.spec.containers.livenessProbe</span>
FIELDS:
   <span class="token builtin class-name">exec</span>	<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>

   failureThreshold	<span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span>     <span class="token comment">#探测多少次被认定为失败，默认是3个，最小值是1</span>

   httpGet	<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>

   initialDelaySeconds	<span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span> <span class="token comment">#容器启动后等待多少秒执行第一次探测</span>

   periodSeconds	<span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span>       <span class="token comment">#执行探测的评率，默认是10秒每次，最小1秒每次</span>

   successThreshold	<span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span>     <span class="token comment">#连续成功探测多少次才被认定为成功，默认是1</span>

   tcpSocket	<span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
   
   timeoutSeconds	<span class="token operator">&lt;</span>integer<span class="token operator">&gt;</span>        <span class="token comment">#探测超时时间，默认是1秒，最小1秒</span>
</code></pre></div><h3 id="_9-重启策略"><a href="#_9-重启策略" class="header-anchor">#</a> 9. 重启策略</h3> <p>Pod 的 <code>spec</code> 中包含一个 <code>restartPolicy</code> 字段，其可能取值包括：</p> <ul><li><strong>Always</strong>（默认）</li> <li><strong>OnFailure</strong></li> <li><strong>Never</strong></li></ul> <p><code>restartPolicy</code> 适用于 Pod 中的所有容器。<code>restartPolicy</code> 仅针对同一节点上 <code>kubelet</code>的容器重启动作。</p> <p>首次需要重启的容器，将在其需要的时候立即进行重启，随后再次重启的操作将由 kubelet 延迟一段时间后进行，且反复的重启操作的延迟时长以此为 10s、20s、40s、80s、160s 和 300s，300s 是最大的延迟时长。</p> <p>一旦某容器执行了 10 分钟并且没有出现问题，<code>kubelet</code> 对该容器的重启回退计时器执行重置操作。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restart<span class="token punctuation">-</span>policy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span> <span class="token comment"># 存活性探测</span>
        <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
          <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /hello
          <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
          <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略</span>
</code></pre></div><h2 id="九、pod-调度"><a href="#九、pod-调度" class="header-anchor">#</a> 九、Pod 调度</h2> <p>在默认情况下，一个 Pod 在哪个 Node 节点上运行，是由 <strong>Scheduler</strong> 组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足需求，因为很多情况下，我们想控制某些 Pod 到达某些节点上，那么应该怎么做？这就要求了解k8s 对 Pod的调度规则，ks8 提供了四大类调度方式：</p> <ul><li>自动调度：运行在哪个 Node 节点上完全由 Scheduler 经过一系列的算法计算得出</li> <li>定向调度：NodeName、NodeSelector</li> <li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity</li> <li>污点（容忍）调度：Taints、Toleration</li></ul> <h3 id="_1-定向调度"><a href="#_1-定向调度" class="header-anchor">#</a> 1. 定向调度</h3> <blockquote><p>定向调度，指的是利用在 Pod 上声明的 nodeName 或 nodeSelector，以此将 Pod 调度到期望的 Node 节点上。</p> <p>‼️​注意，这里的调度是<strong>强制</strong>的，这就意味着即使要调度的目标 Node 不存在，也会向上面进行调度，只不过 Pod 运行失败而已。</p></blockquote> <ul><li><p><strong>nodeName</strong></p> <p>nodeName 用于强制约束将 Pod 调度到指定的 name 的 Node 节点上。这种方式，其实是直接跳过 Scheduler 的调度逻辑，直接将Pod 调度到指定名称的节点。</p> <ul><li><p>创建 <code>pod-nodename.yaml</code> 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodename
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node1 <span class="token comment"># 指定调度到k8s-node1节点上</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-nodename.yaml </span>
pod/pod-nodename created
</code></pre></div></li> <li><p>查看 Pod 信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodename -o wide</span>
NAME           READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod-nodename   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          59s   <span class="token number">10.244</span>.1.15   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>可以看到 Pod 被调度到 k8s-node1 节点了。</p></li></ul></li> <li><p><strong>nodeSelector</strong></p> <p>nodeSelector 用于将 Pod 调度到添加了指定标签的 Node 节点上，它是通过 k8s 的 <strong>label-selector</strong> 机制实现的，换言之，在 Pod 创建之前，会由 Scheduler 使用 MatchNodeSelector 调度策略进行 Label 匹配，找出目标 node，然后将 Pod 调度到目标节点，该匹配规则是强制约束。</p> <ul><li><p>首先给 node 添加标签</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-node1 nodeevn=pro</span>
node/k8s-node1 labeled
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-node2 nodeevn=test</span>
node/k8s-node2 labeled
</code></pre></div></li> <li><p>查看 node 标签</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes --show-labels</span>
NAME         STATUS   ROLES    AGE     VERSION   LABELS
k8s-master   Ready    master   3d23h   v1.18.0   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>k8s-master,kubernetes.io/os<span class="token operator">=</span>linux,node-role.kubernetes.io/master<span class="token operator">=</span>
k8s-node1    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3d23h   v1.18.0   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>k8s-node1,kubernetes.io/os<span class="token operator">=</span>linux,nodeevn<span class="token operator">=</span>pro
k8s-node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3d23h   v1.18.0   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>k8s-node2,kubernetes.io/os<span class="token operator">=</span>linux,nodeevn<span class="token operator">=</span>test
</code></pre></div></li> <li><p>创建  <code>pod-nodeselector.yaml</code> 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeselector
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
  	<span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeenv</span><span class="token punctuation">:</span> pro <span class="token comment"># 指定调度到具有 nodeenv=pro 标签的 Node 节点上</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-nodeselector.yaml </span>
pod/pod-nodeselector created
</code></pre></div></li> <li><p>查看 Pod 信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodeselector -o wide</span>
NAME               READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod-nodeselector   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12s   <span class="token number">10.244</span>.1.16   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>因为 k8s-node1 有 nodeevn=pro 这个标签，所以被调度到了 k8s-node1 节点上了。</p></li></ul></li></ul> <h3 id="_2-亲和性调度"><a href="#_2-亲和性调度" class="header-anchor">#</a> 2. 亲和性调度</h3> <p>虽然定向调度的两种方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的 Node，那么 Pod 将不会被运行，即使在集群中还有可用的 Node 列表也不行，这就限制了它的使用场景。</p> <p>基于上面的问题，k8s 还提供了一种亲和性调度（Affinity）。它在 nodeSelector 的基础之上进行了扩展，可以通过配置的形式，实现优先选择满足条件的 Node 进行调度，如果没有，也可以调度到不满足条件的节点上，使得调度更加灵活。</p> <p><strong>Affinity</strong> 主要分为三类：</p> <ul><li><strong>nodeAffinity（node 亲和性）</strong>：站在 Pod 的角度上，设置 Pod 希望调度到什么 Node 上</li> <li><strong>podAffinity（pod 亲和性）</strong>：站在 Pod 的角度上，设置 Pod 希望和哪些已经运行的 Pod 在一起运行</li> <li><strong>podAntiAffinity（pod 反亲和性）</strong>：站在 Pod 的角度上，设置 Pod <strong>不希望</strong>和哪些 Pod 在一起运行</li></ul> <blockquote><p>关于亲和性和反亲和性的使用场景的说明：</p> <ul><li><p>亲和性：如果两个应用频繁交互，那么就有必要利用亲和性让两个应用尽可能的靠近，这样可以较少因网络通信而带来的性能损耗。</p></li> <li><p>反亲和性：当应用采用多副本部署的时候，那么就有必要利用反亲和性让各个应用实例打散分布在各 Node 上，这样可以提高服务的高可用性。</p></li></ul></blockquote> <h4 id="_2-1-nodeaffinity"><a href="#_2-1-nodeaffinity" class="header-anchor">#</a> 2.1 nodeAffinity</h4> <blockquote><p>站在 Pod 的角度上，设置 Pod 希望调度到什么 Node 上。</p></blockquote> <ul><li>preferredDuringSchedulingIgnoredDuringExecution &lt;[]Object&gt;：优先调度到满足指定的规则的 Node，相当于软限制
<ul><li>preference	&lt;Object&gt; -required-   ：一个节点选择器项，与相应的权重相关联
<ul><li>matchExpressions	&lt;[]Object&gt;：按节点标签列出的节点选择器要求列表（推荐）
<ul><li>key	&lt;string&gt; -required-</li> <li>values	&lt;[]string&gt;</li> <li>operator	&lt;string&gt; -required-：操作符可以为 In, NotIn, Exists, DoesNotExist. Gt, and Lt.</li></ul></li> <li>matchFields	&lt;[]Object&gt;：按节点字段列出的节点选择器要求列表
<ul><li>key	&lt;string&gt; -required-</li> <li>values	&lt;[]string&gt;</li> <li>operator	&lt;string&gt; -required-</li></ul></li></ul></li> <li>weight	&lt;integer&gt; -required- ：倾向权重，在范围 1-100</li></ul></li> <li>requiredDuringSchedulingIgnoredDuringExecution  &lt;Object&gt;：Node 节点必须满足指定的所有规则才可以，相当于硬限制
<ul><li>nodeSelectorTerms	&lt;[]Object&gt; -required-：节点选择列表
<ul><li>matchExpressions	&lt;[]Object&gt;</li> <li>matchFields	&lt;[]Object&gt;</li></ul></li></ul></li></ul> <p>举例：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv <span class="token comment"># 匹配存在标签的key为nodeenv的节点</span>
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists   
  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv <span class="token comment"># 匹配标签的key为nodeenv,且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span>
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> In    
    <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;yyy&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv <span class="token comment"># 匹配标签的key为nodeenv,且value大于&quot;xxx&quot;的节点</span>
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Gt   
    <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token string">&quot;xxx&quot;</span>
</code></pre></div><blockquote><p><strong>案例1：</strong></p> <p>演示 requiredDuringSchedulingIgnoredDuringExecution</p></blockquote> <ul><li><p>创建 pod-nodeaffinity-required.yaml 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment">#亲和性配置</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment">#node 亲和性配置</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment">#强制满足所有条件</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span> <span class="token comment">#节点选择列表</span>
          <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeevn <span class="token comment">#存在标签nodeevn的节点，则值要在xxx或yyy</span>
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;xxx&quot;</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;yyy&quot;</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-nodeaffinity-required.yaml </span>
pod/pod-nodeaffinity-required created
</code></pre></div></li> <li><p>查看 Pod 分配情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodeaffinity-required -o wide</span>
NAME                        READY   STATUS    RESTARTS   AGE    IP       NODE     NOMINATED NODE   READINESS GATES
pod-nodeaffinity-required   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          106s   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>没找到 Pod 的分配情况。</p></li> <li><p>查看 Pod 详细信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod pod-nodeaffinity-required</span>
Name:         pod-nodeaffinity-required
  Type     Reason            Age        From               Message
  ----     ------            ----       ----               -------
  Warning  FailedScheduling  <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>  default-scheduler  <span class="token number">0</span>/3 nodes are available: <span class="token number">3</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t match node selector.
  Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/3 nodes are available: 3 node(s) didn'</span>t match node selector.
</code></pre></div><p>可以看到没有匹配到符合规则的 Node。</p></li> <li><p>给 k8s-node2 打上标签 nodeevn=xxx</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-node2 nodeevn=xxx --overwrite</span>
node/k8s-node2 labeled
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes --show-labels</span>
NAME         STATUS   ROLES    AGE     VERSION   LABELS
k8s-master   Ready    master   4d      v1.18.0   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>k8s-master,kubernetes.io/os<span class="token operator">=</span>linux,node-role.kubernetes.io/master<span class="token operator">=</span>
k8s-node1    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   4d      v1.18.0   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>k8s-node1,kubernetes.io/os<span class="token operator">=</span>linux,nodeevn<span class="token operator">=</span>pro
k8s-node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3d23h   v1.18.0   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>k8s-node2,kubernetes.io/os<span class="token operator">=</span>linux,nodeevn<span class="token operator">=</span>xxx
</code></pre></div></li> <li><p>查看 Pod 分配情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodeaffinity-required -o wide</span>
NAME                        READY   STATUS    RESTARTS   AGE     IP            NODE        NOMINATED NODE   READINESS GATES
pod-nodeaffinity-required   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m47s   <span class="token number">10.244</span>.2.11   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>k8s-node2 现在已经符合规则，pod 分配成功。</p></li></ul> <blockquote><p><strong>案例2：</strong></p> <p>演示 preferredDuringSchedulingIgnoredDuringExecution</p></blockquote> <ul><li><p>创建 <code>pod-nodeaffinity-preferred.yaml</code> 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>perferred
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment">#亲和性配置</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment">#node 亲和性配置</span>
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment">#偏好配置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">preference</span><span class="token punctuation">:</span> <span class="token comment">#偏好列表，有对应的权重</span>
            <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeAffinity
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;kkk&quot;</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;jjj&quot;</span>
          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#权重</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-nodeaffinity-preferred.yaml </span>
pod/pod-nodeaffinity-perferred created
</code></pre></div></li> <li><p>查看 Pod 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodeaffinity-perferred -o wide</span>
NAME                         READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod-nodeaffinity-perferred   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          50s   <span class="token number">10.244</span>.2.12   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>此时 k8s-node1 和 k8s-node2 都没有 nodeAffinity=kkk 或 jjj 的标签，但是这只是偏好配置，所以还是分配到了其中一个节点，现在我们来给 k8s-node1 加上 nodeAffinity=kkk 的标签。</p></li> <li><p>给 k8s-node1 加标签</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl label node k8s-node1 nodeAffinity=kkk</span>
node/k8s-node1 labeled
</code></pre></div></li> <li><p>重启 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl replace --force -f pod-nodeaffinity-preferred.yaml </span>
pod <span class="token string">&quot;pod-nodeaffinity-perferred&quot;</span> deleted
pod/pod-nodeaffinity-perferred replaced
</code></pre></div></li> <li><p>查看 Pod 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-nodeaffinity-perferred -o wide</span>
NAME                         READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod-nodeaffinity-perferred   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          19s   <span class="token number">10.244</span>.1.17   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>调度到了 k8s-node1 上了。</p></li></ul> <p><font color="red">‼️<strong>nodeAffinity 规则设置的注意事项</strong></font></p> <blockquote><ol><li>如果同时定义了 nodeSelector 和 nodeAffinity，那么必须两个条件都得到满足，Pod 才能运行到指定的 Node 上；</li> <li>如果 nodeAffinity 指定了多个 nodeSelectorTerms，那么只需其中一个能够匹配成功即可；</li> <li>如果一个 nodeSelectorTerms 中有多个 matchExpressions，则一个节点必须满足所有的才能匹配成功；</li> <li>如果一个 Pod 所在的 Node 在 Pod 运行期间其标签发生了变化，不再符合该 Pod 的亲和性需求，系统会忽略此变化。</li></ol></blockquote> <h4 id="_2-2-podaffinity"><a href="#_2-2-podaffinity" class="header-anchor">#</a> 2.2 podAffinity</h4> <blockquote><p>站在 Pod 的角度上，设置 Pod 希望和哪些已经运行的 Pod 在一起运行。</p></blockquote> <ul><li>requiredDuringSchedulingIgnoredDuringExecution	&lt;[]Object&gt;：强制
<ul><li>labelSelector	&lt;Object&gt; ：标签选择器
<ul><li>matchExpressions	&lt;[]Object&gt;：按节点标签列出的节点选择器要求列表(推荐)
<ul><li>key</li> <li>value</li> <li>operator</li></ul></li> <li>matchLabels	&lt;map[string]string&gt;：指多个matchExpressions映射的内容</li></ul></li> <li>namespaces	&lt;[]string&gt;：指定参照 pod 的 namespace</li> <li>topologyKey	&lt;string&gt; -required-  ：指定调度作用域</li></ul></li> <li>preferredDuringSchedulingIgnoredDuringExecution	&lt;[]Object&gt;：偏好
<ul><li>podAffinityTerm	&lt;Object&gt; -required-
<ul><li>labelSelector	&lt;Object&gt;
<ul><li>matchExpressions	&lt;[]Object&gt;</li> <li>matchLabels	&lt;map[string]string&gt;</li></ul></li> <li>namespaces	&lt;[]string&gt;</li> <li>topologyKey	&lt;string&gt; -required-</li></ul></li> <li>weight	&lt;integer&gt; -required-：权重，值在 1-100 之间</li></ul></li></ul> <blockquote><p>topologyKey 用于指定调度的作用域，例如:</p> <ul><li>如果指定为 <strong>kubernetes.io/hostname</strong>，那就是以 Node 节点为区分范围。</li> <li>如果指定为 <strong>beta.kubernetes.io/os</strong>，则以 Node 节点的操作系统类型来区分。</li></ul></blockquote> <blockquote><p><strong>案例1：</strong></p> <p>演示 requiredDuringSchedulingIgnoredDuringExecution</p></blockquote> <ul><li><p>创建参照 Pod</p> <ul><li><p>创建 <code>pod-podaffinity-target.yaml</code> 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>target
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">podenv</span><span class="token punctuation">:</span> pro <span class="token comment"># 设置标签</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node1 <span class="token comment"># 将目标pod定向调度到k8s-node1</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-podaffinity-target.yaml </span>
pod/pod-podaffinity-target created
</code></pre></div></li> <li><p>查看 Pod 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code>oot@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-podaffinity-target -o wide</span>
NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod-podaffinity-target   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          23s   <span class="token number">10.244</span>.1.20   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div></li></ul></li> <li><p>创建新 Pod 去亲和参照 Pod</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>required
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment">#亲和性配置</span>
    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span> <span class="token comment">#配置pod亲和</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment">#强制</span>
        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>  <span class="token comment"># 该Pod必须和拥有标签podenv=xxx或者podenv=yyy</span>
            <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;xxx&quot;</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;yyy&quot;</span>
          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname <span class="token comment">#以Node节点为区分度</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-podaffinity-required.yaml </span>
pod/pod-podaffinity-required created
</code></pre></div></li> <li><p>查看 Pod 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-podaffinity-required -o wide</span>
NAME                       READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES
pod-podaffinity-required   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          40s   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>因为我们没有符合条件的 Pod，所以新 Pod 得不到调度。</p></li> <li><p>给参照 Pod 上标签 podenv=xxx</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl label pod pod-podaffinity-target podenv=xxx --overwrite</span>
pod/pod-podaffinity-target labeled
</code></pre></div></li> <li><p>再查看 Pod 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-podaffinity-required -o wide</span>
NAME                       READY   STATUS    RESTARTS   AGE    IP            NODE        NOMINATED NODE   READINESS GATES
pod-podaffinity-required   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          107s   <span class="token number">10.244</span>.1.21   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>它就由于 Pod 亲和性跟参照 Pod 一起被调度到 k8s-node1 节点上了。</p></li></ul> <h4 id="_2-3-podantiaffinity"><a href="#_2-3-podantiaffinity" class="header-anchor">#</a> 2.3 podAntiAffinity</h4> <blockquote><p>站在 Pod 的角度上，设置 Pod 不希望和哪些已经运行的 Pod 在一起运行。</p></blockquote> <ul><li><p>编写 <code>pod-podantiaffinity-required.yaml</code> 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podantiaffinity<span class="token punctuation">-</span>required
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment">#亲和性配置</span>
    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span> <span class="token comment">#配置pod反亲和性</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment">#强制</span>
        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>  <span class="token comment"># 该Pod不想podenv=xxx的Pod一起运行</span>
            <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;xxx&quot;</span>
          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname <span class="token comment">#以Node节点为区分度</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl create -f pod-podantiaffinity-required.yaml </span>
pod/pod-podantiaffinity-required created
</code></pre></div></li> <li><p>查看 Pod 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-podantiaffinity-required -o wide</span>
NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod-podantiaffinity-required   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          39s   <span class="token number">10.244</span>.2.15   k8s-node2   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>可以看到当前 Pod 避开了在 k8s-node1 的拥有 proenv=xxx 的 Pod，被调度到了 k8s-node2。</p></li></ul> <h3 id="_3-污点"><a href="#_3-污点" class="header-anchor">#</a> 3. 污点</h3> <p>前面的调度方式都是站在 Pod 的角度上，通过在 Pod 上添加属性，来确定 Pod 是否要调度到指定的 Node 上，其实我们也可以<strong>站在 Node 的角度上</strong>，通过在 Node 上添加<strong>污点属性</strong>，来决定是否运行 Pod 调度过来。</p> <p>Node 被设置了污点之后就和 Pod 之间存在了一种相斥的关系，进而拒绝 Pod 调度进来，甚至可以将已经存在的 Pod 驱逐出去。</p> <p>污点的格式为：<code>key=value:effect</code>，key 和 value 是污点的标签，effect 描述污点的作用，支持如下三个选项：</p> <ul><li>PreferNoSchedule：k8s 将尽量避免把 Pod 调度到具有该污点的 Node 上，除非没有其他节点可以调度</li> <li>NoSchedule：k8s 将不会把 Pod 调度到具有该污点的 Node 上，但是不会影响当前 Node 上已经存在的 Pod</li> <li>NoExecute：k8s 将不会把 Pod 调度到具有该污点的 Node 上，同时也会将 Node 上已经存在的 Pod 驱逐</li></ul> <p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gs879hva3wj30sb06gmyo.jpg" alt="污点的三种格式.png"></p> <ul><li><p>设置污点</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl taint node xxx <span class="token assign-left variable">key</span><span class="token operator">=</span>value:effect
</code></pre></div></li> <li><p>去除污点</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl taint node xxx key:effect-
</code></pre></div></li> <li><p>去除所有污点</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl taint node xxx key-
</code></pre></div></li> <li><p>查看 Node 上的污点</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe node xxx
</code></pre></div></li></ul> <blockquote><p><strong>案例：</strong></p> <p>演示污点效果。</p></blockquote> <ul><li><p>前提</p> <p>准备节点 k8s-node1，为了演示效果，暂时停止 k8s-node2</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl delete node k8s-node2</span>
node <span class="token string">&quot;k8s-node2&quot;</span> deleted
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME         STATUS   ROLES    AGE     VERSION
k8s-master   Ready    master   4d23h   v1.18.0
k8s-node1    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   26m     v1.18.0
</code></pre></div></li> <li><p>为 k8s-node1 节点设置一个污点：<code>tag=hedon:PreferNoSchedule</code>，然后创建 pod1</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 添加污点</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl taint node k8s-node1 tag=hedon:PreferNoSchedule</span>
node/k8s-node1 tainted

<span class="token comment"># 创建 pod1</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl run pod1 --image=nginx:1.17.1</span>
pod/pod1 created

<span class="token comment"># 检查 pod1 调度情况</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod1 -o wide</span>
NAME   READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          16s   <span class="token number">10.244</span>.1.27   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>符合预期：“<strong>尽量不要调度过来</strong>”。因为没有别的节点可用的，还是可以调度到 k8s-node1 的。</p></li> <li><p>为 k8s-node1 取消<code>tag=hedon:PreferNoSchedule</code> 污点，然后设置新污点 <code>tag=hedon:NoSchedule</code>，然后创建 pod2</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 取消污点</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl taint node k8s-node1 tag:PreferNoSchedule-</span>
node/k8s-node1 untainted
<span class="token comment"># 设置污点</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl taint node k8s-node1 tag=hedon:NoSchedule</span>
node/k8s-node1 tainted
<span class="token comment"># 创建 pod2</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl run pod2 --image=nginx:1.17.1</span>
pod/pod2 created
<span class="token comment"># 查看 pod2 调度情况</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod2 -o wide</span>
NAME   READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES
pod2   <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          8s    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>符合预期：“<strong>新的别来</strong>”。</p></li> <li><p>为 k8s-node1 取消<code>tag=hedon:NoSchedule</code> 污点，然后设置新污点 <code>tag=hedon:NoExecute</code>，然后查看前面的 pod1 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看 Pod1 调度情况</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod1 -o wide</span>
NAME   READY   STATUS    RESTARTS   AGE     IP            NODE        NOMINATED NODE   READINESS GATES
pod1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m21s   <span class="token number">10.244</span>.1.27   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
<span class="token comment"># 取消污点</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl taint node k8s-node1 tag:NoSchedule-</span>
node/k8s-node1 untainted
<span class="token comment"># 设置污点</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl taint node k8s-node1 tag=hedon:NoExecute</span>
node/k8s-node1 tainted
<span class="token comment"># 查看 Pod1 调度情况</span>
<span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod1 -o wide</span>
Error from server <span class="token punctuation">(</span>NotFound<span class="token punctuation">)</span>: pods <span class="token string">&quot;pod1&quot;</span> not found
</code></pre></div><p>符合预期：“<strong>在的赶紧走</strong>”。Pod</p></li></ul> <h3 id="_4-容忍"><a href="#_4-容忍" class="header-anchor">#</a> 4. 容忍</h3> <p>上面介绍了污点的作用，我们可以在 Node 上添加污点用来拒绝 Pod 调度上来，但是如果就是想让一个 Pod 调度到一个有污点的 Node 上去，这时候应该怎么做？这就需要使用到<strong>容忍</strong>。</p> <p>容忍的详细配置：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl explain pod.spec.tolerations
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
FIELDS:
  key       <span class="token comment"># 对应着要容忍的污点的键，空意味着匹配所有的键</span>
  value     <span class="token comment"># 对应着要容忍的污点的值</span>
  operator  <span class="token comment"># key-value的运算符，支持Equal和Exists（默认）</span>
  effect    <span class="token comment"># 对应污点的effect，空意味着匹配所有影响</span>
  tolerationSeconds   <span class="token comment"># 容忍时间, 当effect为NoExecute时生效，表示pod在Node上的停留时间</span>
</code></pre></div><ul><li><p>当 operator 为 Equal 的时候，如果 Node 节点有多个 Taint，那么 Pod 每个 Taint 都需要容忍才能部署上去</p></li> <li><p>当 operator 为 Exists 的时候，有如下的三种写法：</p> <ul><li><p>容忍指定的污点，污点带有指定的 effect</p> <div class="language-shell extra-class"><pre class="language-shell"><code>tolerations: <span class="token comment"># 容忍</span>
    - key: <span class="token string">&quot;tag&quot;</span> <span class="token comment"># 要容忍的污点的key</span>
      operator: Exists <span class="token comment"># 操作符</span>
      effect: NoExecute <span class="token comment"># 添加容忍的规则，这里必须和标记的污点规则相同</span>
</code></pre></div></li> <li><p>容忍指定的污点，不考虑具体的effect：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>  tolerations: <span class="token comment"># 容忍</span>
    - key: <span class="token string">&quot;tag&quot;</span> <span class="token comment"># 要容忍的污点的key</span>
      operator: Exists <span class="token comment"># 操作符</span>
</code></pre></div></li> <li><p>容忍一切污点（慎用）：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>tolerations: <span class="token comment"># 容忍</span>
    - operator: Exists <span class="token comment"># 操作符</span>
</code></pre></div></li></ul></li></ul> <blockquote><p><strong>案例：</strong></p> <p>在上面的污点中，已经给 k8s-node1 打上了 NoExecute 的污点，此时 Pod 是调度不上去的，此时可以通过在 Pod 中添加容忍，将 Pod 调度上去。</p></blockquote> <ul><li><p>创建 <code>pod-toleration.yaml</code> 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>toleration
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> hedon
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token comment"># 容忍配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;tag&quot;</span>        <span class="token comment">#要容忍的污点的key</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> Equal   <span class="token comment">#操作符</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;hedon&quot;</span>    <span class="token comment">#要容忍的污点的value</span>
      <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute <span class="token comment">#增加容忍的规则，这里必须和标记的污点规则相同</span>
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pod-toleration.yaml </span>
pod/pod-toleration created
</code></pre></div></li> <li><p>查看 Pod 调度情况</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get pod pod-toleration -o wide</span>
NAME             READY   STATUS    RESTARTS   AGE   IP            NODE        NOMINATED NODE   READINESS GATES
pod-toleration   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          31s   <span class="token number">10.244</span>.1.29   k8s-node1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div><p>可以看到 pod-toleration 容忍了 k8s-node1 上的污点，调度到了 k8s-node1 上面了。</p></li></ul> <blockquote><p><strong>恢复环境：</strong></p> <ol><li><p>删除 k8s-node1 的一切污点</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl taint node k8s-node1 tag-</span>
node/k8s-node1 untainted
</code></pre></div></li> <li><p>k8s-node2 重新加入集群</p> <p>在 k8s-master 生成永久令牌</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubeadm token create --ttl 0 --print-join-command</span>
W0706 <span class="token number">20</span>:21:03.410825   <span class="token number">22427</span> configset.go:202<span class="token punctuation">]</span> WARNING: kubeadm cannot validate component configs <span class="token keyword">for</span> API <span class="token function">groups</span> <span class="token punctuation">[</span>kubelet.config.k8s.io kubeproxy.config.k8s.io<span class="token punctuation">]</span>
kubeadm <span class="token function">join</span> <span class="token number">172.16</span>.58.200:6443 --token ag80av.jnp23j2405k78sr9     --discovery-token-ca-cert-hash sha256:e4959de30bb94df662147bdf32044d5278eecd7c77f2e56b51ae07860a52fd79 
</code></pre></div><p>k8s-node2 删除原来的 CA 文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># rm -rf /etc/kubernetes/pki/ca.crt</span>
</code></pre></div><p>k8s-node2 删除原来的 k8s 配置文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># rm -rf /etc/kubernetes/kubelet.conf</span>
</code></pre></div><p>k8s-node2 停止原来的 k8s 进程</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看 PID</span>
<span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># ps -ef | grep k8s</span>
avahi       <span class="token number">599</span>      <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">11</span>:05 ?        00:00:01 avahi-daemon: running <span class="token punctuation">[</span>k8s-node2.local<span class="token punctuation">]</span>
root       <span class="token number">9681</span>      <span class="token number">1</span>  <span class="token number">1</span> <span class="token number">11</span>:13 ?        00:10:47 /usr/bin/kubelet --bootstrap-kubeconfig<span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig<span class="token operator">=</span>/etc/kubernetes/kubelet.conf --config<span class="token operator">=</span>/var/lib/kubelet/config.yaml --cgroup-driver<span class="token operator">=</span>systemd --network-plugin<span class="token operator">=</span>cni --pod-infra-container-image<span class="token operator">=</span>k8s.gcr.io/pause:3.2 --cgroup-driver<span class="token operator">=</span>systemd
root     <span class="token number">121478</span> <span class="token number">121182</span>  <span class="token number">0</span> <span class="token number">20</span>:24 pts/0    00:00:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto k8s
<span class="token comment"># kill</span>
<span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># kill -9 9681</span>
</code></pre></div><p>k8s-node2 加入 集群</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-node2 ~<span class="token punctuation">]</span><span class="token comment"># kubeadm join 172.16.58.200:6443 --token ag80av.jnp23j2405k78sr9     --discovery-token-ca-cert-hash sha256:e4959de30bb94df662147bdf32044d5278eecd7c77f2e56b51ae07860a52fd79</span>
<span class="token punctuation">..</span>.
This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this node <span class="token function">join</span> the cluster
</code></pre></div><p>k8s-master 检查 node 情况：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl get nodes</span>
NAME         STATUS   ROLES    AGE     VERSION
k8s-master   Ready    master   4d23h   v1.18.0
k8s-node1    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   3m3s    v1.18.0
k8s-node2    Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   106s    v1.18.0
</code></pre></div></li></ol></blockquote> <h2 id="十、临时容器"><a href="#十、临时容器" class="header-anchor">#</a> 十、临时容器</h2> <h3 id="_1-临时容器简介"><a href="#_1-临时容器简介" class="header-anchor">#</a> 1. 临时容器简介</h3> <p>临时容器是一种特殊的容器，该容器可以在现有的 Pod 中临时运行，以便完成我们发起的操作，比如故障排查。我们应该使用临时容器来检查服务，而不是用临时容器来构建应用程序。</p> <p>Pod 是 k8s 集群进行管理的最小单元，由于 Pod 是一次性且可以替换的，因此 Pod 一旦被创建，就无法将容器加入到 Pod 中。而且，我们通常使用 Deployment 来删除并替换P od。但是，有的时候我们需要检查现有 Pod 的状态，比如对难以复现的故障进行排查。在这些场景中，可以在现有 Pod 中运行临时容器来检查其状态并运行任意命令。</p> <p>临时容器和其他容器的不同之处在于，<strong>它们缺少对资源或执行的保证，并且永远不会自动重启，因此不适合用来构建应用程序</strong>。临时容器使用和常规容器相同的 <code>ContainerSpec</code>来描述，但是许多字段是不兼容或者不允许的：</p> <ul><li>临时容器没有端口配置，因此像 <code>ports</code>、<code>livenessProbe</code>、<code>readinessProbe</code>这样的字段是没有的</li> <li>Pod 的资源分配是不可变的，因此 <code>resources</code> 这样的配置临时容器也是没有的</li></ul> <p>临时容器是使用 <code>ephemeralcontainers</code>来进行创建的，而不是直接添加到 <code>pod.spec</code>中，所以是无法使用 <code>kubectl edit</code> 来添加一个临时容器。</p> <p>和常规容器一样，将临时容器添加到 Pod 后，不能更改或删除临时容器。</p> <h3 id="_2-临时容器作用"><a href="#_2-临时容器作用" class="header-anchor">#</a> 2. 临时容器作用</h3> <ul><li>当由于容器奔溃或容器镜像不包含调试工具而导致 <code>kubectl exec</code> 无用的时候，临时容器对于<strong>交互式故障排查</strong>非常有用。</li> <li>比如，像 <code>distroless 镜像</code> 允许用户部署最小的容器镜像，从而减少攻击面并减少故障和漏洞的暴露。由于 <code>distroless 镜像</code>不包含 Shell 或任何的调试工具，因此很难单独使用 <code>kubectl exec</code> 命令进行故障排查。</li> <li>使用临时容器的时候，启用 <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/share-process-namespace/" target="_blank" rel="noopener noreferrer">进程名字空间共享<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 很有帮助，可以查看其他容器中的进程。</li></ul> <h3 id="_3-临时容器配置"><a href="#_3-临时容器配置" class="header-anchor">#</a> 3. 临时容器配置</h3> <ul><li><p>查看临时容器是否开启（默认关闭）</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubelet -h | grep EphemeralContainers</span>
                <span class="token assign-left variable">EphemeralContainers</span><span class="token operator">=</span>true<span class="token operator">|</span><span class="token boolean">false</span> <span class="token punctuation">(</span>ALPHA - <span class="token assign-left variable">default</span><span class="token operator">=</span>false<span class="token punctuation">)</span>
</code></pre></div></li> <li><p>在每个节点（不管 Master 节点还是 Node 节点）修改 kubectl 的参数</p> <blockquote><p>注意：kubectl 的启动文件的路径是 /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 修改 /etc/sysconfig/kubelet 文件，添加 --feature-gates EphemeralContainers=true</span>
$ <span class="token function">vim</span> /etc/sysconfig/kubelet

<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span><span class="token string">&quot;--cgroup-driver=systemd --feature-gates EphemeralContainers=true&quot;</span>
<span class="token assign-left variable">KUBE_PROXY_MODE</span><span class="token operator">=</span>&quot;ipvs

<span class="token comment"># 修改 /var/lib/kubelet/config.yaml 文件，添加 featureGates: EphemeralContainers: true</span>
$ <span class="token function">vim</span> /var/lib/kubelet/config.yaml

apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: <span class="token boolean">false</span>
  webhook:
    cacheTTL: 0s
    enabled: <span class="token boolean">true</span>
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 0s
    cacheUnauthorizedTTL: 0s
clusterDNS:
- <span class="token number">10.96</span>.0.10
clusterDomain: cluster.local
cpuManagerReconcilePeriod: 0s
evictionPressureTransitionPeriod: 0s
fileCheckFrequency: 0s
healthzBindAddress: <span class="token number">127.0</span>.0.1
healthzPort: <span class="token number">10248</span>
httpCheckFrequency: 0s
imageMinimumGCAge: 0s
kind: KubeletConfiguration
nodeStatusReportFrequency: 0s
nodeStatusUpdateFrequency: 0s
rotateCertificates: <span class="token boolean">true</span>
runtimeRequestTimeout: 0s
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 0s
syncFrequency: 0s
volumeStatsAggPeriod: 0s
<span class="token comment"># 修改部分</span>
featureGates:
  EphemeralContainers: <span class="token boolean">true</span>
</code></pre></div><p>加载配置文件重启 kubelet</p> <div class="language-shell extra-class"><pre class="language-shell"><code>systemctl daemon-reload
systemctl restart kubelet
</code></pre></div></li> <li><p>在 Master 节点修改 <code>kube-apiserver.yaml</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/manifests/kube-apiserver.yaml</span>
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: <span class="token number">192.168</span>.49.100:6443
  creationTimestamp: null
  labels:
    component: kube-apiserver
    tier: control-plane
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-apiserver
    - --advertise-address<span class="token operator">=</span><span class="token number">192.168</span>.49.100
    - --allow-privileged<span class="token operator">=</span>true
    - --authorization-mode<span class="token operator">=</span>Node,RBAC
    - --client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/ca.crt
    - --enable-admission-plugins<span class="token operator">=</span>NodeRestriction
    - --enable-bootstrap-token-auth<span class="token operator">=</span>true
    - --etcd-cafile<span class="token operator">=</span>/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-etcd-client.key
    - --etcd-servers<span class="token operator">=</span>https://127.0.0.1:2379
    - --insecure-port<span class="token operator">=</span><span class="token number">0</span>
    - --kubelet-client-certificate<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-kubelet-client.crt
    - --kubelet-client-key<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-kubelet-client.key
    - --kubelet-preferred-address-types<span class="token operator">=</span>InternalIP,ExternalIP,Hostname
    - --proxy-client-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.crt
    - --proxy-client-key-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-client.key
    - --requestheader-allowed-names<span class="token operator">=</span>front-proxy-client
    - --requestheader-client-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/front-proxy-ca.crt
    - --requestheader-extra-headers-prefix<span class="token operator">=</span>X-Remote-Extra-
    - --requestheader-group-headers<span class="token operator">=</span>X-Remote-Group
    - --requestheader-username-headers<span class="token operator">=</span>X-Remote-User
    - --secure-port<span class="token operator">=</span><span class="token number">6443</span>
    - --service-account-issuer<span class="token operator">=</span>https://kubernetes.default.svc.cluster.local
    - --service-account-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.pub
    - --service-account-signing-key-file<span class="token operator">=</span>/etc/kubernetes/pki/sa.key
    - --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12
    - --tls-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file<span class="token operator">=</span>/etc/kubernetes/pki/apiserver.key
    <span class="token comment"># 修改部分</span>
    - --feature-gates<span class="token operator">=</span>EphemeralContainers<span class="token operator">=</span>true
</code></pre></div></li> <li><p>在 Master 节点上修改 <code>kube-scheduler.yaml</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/manifests/kube-scheduler.yaml</span>
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    component: kube-scheduler
    tier: control-plane
  name: kube-scheduler
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-scheduler
    - --authentication-kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.conf
    - --authorization-kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.conf
    - --bind-address<span class="token operator">=</span><span class="token number">127.0</span>.0.1
    - --kubeconfig<span class="token operator">=</span>/etc/kubernetes/scheduler.conf
    - --leader-elect<span class="token operator">=</span>true
    <span class="token comment"># 修改部分</span>
    - --feature-gates<span class="token operator">=</span>EphemeralContainers<span class="token operator">=</span>true
</code></pre></div></li></ul> <h3 id="_4-使用临时容器在线-debug"><a href="#_4-使用临时容器在线-debug" class="header-anchor">#</a> 4. 使用临时容器在线 debug</h3> <ul><li><p>创建一个 <code>nginx-yaml</code> 文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">shareProcessNamespace</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 这个配置非常重要，一定要配置</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
</code></pre></div></li> <li><p>创建 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f nginx.yaml </span>
pod/nginx created
</code></pre></div></li> <li><p>创建 <code>ec.json</code> 文件，内容如下（注意：name 是 Pod 的名称）</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;apiVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;v1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;EphemeralContainers&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;metadata&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nginx&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ephemeralContainers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;sh&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;busybox&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;imagePullPolicy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;IfNotPresent&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;debugger&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;stdin&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;tty&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">&quot;terminationMessagePolicy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;File&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>更新已经运行的容器</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl replace --raw /api/v1/namespaces/default/pods/nginx/ephemeralcontainers  -f ec.json
</code></pre></div></li> <li><p>查看新创建的临时容器的状态</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod nginx</span>
<span class="token comment"># 临时容器</span>
Ephemeral Containers:
  debugger:
    Container ID:  docker://15f9aa6f6a98fcaff2d6ee85c8a5a6bc7d85293ca832e81a16f0df8c7c61b395
    Image:         busybox
    Image ID:      docker-pullable://busybox@sha256:930490f97e5b921535c153e0e7110d251134cc4b72bbb8133c6a5065cc68580d
    Port:          <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Host Port:     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Command:
      <span class="token function">sh</span>
    State:          Running
      Started:      Tue, 06 Jul <span class="token number">2021</span> <span class="token number">20</span>:46:11 -0700
    Ready:          False
    Restart Count:  <span class="token number">0</span>
    Environment:    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
    Mounts:         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>可以使用如下的命令连接临时容器</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span> -it nginx -c debugger -- <span class="token function">sh</span>
<span class="token comment"># 或</span>
kubectl attach -it nginx -c debugger
</code></pre></div></li></ul> <h2 id="十一、服务质量-qos"><a href="#十一、服务质量-qos" class="header-anchor">#</a> 十一、服务质量 Qos</h2> <p>k8s 创建Pod的时候就会指定 QoS</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master pod<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod nginx</span>
QoS Class:       BestEffort
</code></pre></div><p>QoS 分为如下的三类：</p> <ul><li>Guaranteed
<ul><li>Pod 中的<strong>每个</strong>容器，包含初始化容器，必须指定内存请求和内存限制，并且两者要相等</li> <li>Pod 中的<strong>每个</strong>容器，包含初始化容器，必须指定 CPU 请求和 CPU 限制，并且两者要相等</li></ul></li> <li>Burstable
<ul><li>Pod 不符合 Guaranteed QoS 类的标准</li> <li>Pod 中<strong>至少</strong>一个容器具有内存或 CPU 请求，但是值不相等</li></ul></li> <li>BestEffort
<ul><li>Pod 中的容器<strong>必须没有</strong>设置内存和 CPU 限制或请求</li></ul></li></ul> <blockquote><p>一旦出现 OOM，k8s 为了保证服务的可用，会先删除 QoS 为 BestEffort 的 Pod，然后删除 QoS 为 Burstable 的Pod，最后删除 QoS 为 Guaranteed 的 Pod。</p></blockquote> <h2 id="十二、pod-控制器"><a href="#十二、pod-控制器" class="header-anchor">#</a> 十二、Pod 控制器</h2> <p>在 k8s 中，按照 Pod 的创建方式可以将其分为两类：</p> <ul><li>自主式 Pod：k8s 直接创建出来的 Pod，这种 Pod 删除后就没有了，也不会重建</li> <li>控制器创建 Pod：通过 Pod 控制器创建的 Pod，这种 Pod 删除之后还会自动重建</li></ul> <p>Pod 控制器：Pod 控制器是管理 Pod 的中间层，使用了 Pod 控制器之后，我们只需要告诉 Pod 控制器，想要多少个什么样的 Pod 就可以了，它就会创建出满足条件的 Pod 并确保每一个 Pod 处于用户期望的状态，如果 Pod 在运行中出现故障，控制器会基于指定的策略重启或重建 Pod。</p> <p>在 k8s 中，有很多类型的 Pod 控制器，每种都有自己的适合的场景，常见的有下面这些：</p> <ul><li>ReplicationController：比较原始的 Pod 控制器，已经被废弃，由 ReplicaSet 替代</li> <li>ReplicaSet：保证指定数量的 Pod 运行，并支持 Pod 数量变更，镜像版本变更</li> <li>Deployment：通过控制 ReplicaSet 来控制 Pod，并支持滚动升级、版本回退</li> <li>Horizontal Pod Autoscaler：可以根据集群负载自动调整 Pod 的数量，实现削峰填谷</li> <li>DaemonSet：在集群中的指定 Node 上都运行一个副本，一般用于守护进程类的任务</li> <li>Job：它创建出来的 Pod 只要完成任务就立即退出，用于执行一次性任务</li> <li>CronJob：它创建的 Pod 会周期性的执行，用于执行周期性的任务</li> <li>StatefulSet：管理有状态的应用</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/8/2021, 11:28:32 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/linux/k8s/k8s-label.html" class="prev">
        Label
      </a></span> <span class="next"><a href="/noteSite/linux/k8s/k8s-rs.html">
        ReplicaSet
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.78bc0a69.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/283.0348af06.js" defer></script>
  </body>
</html>
