<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Job | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.19c58630.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.0f8877a4.js" as="script"><link rel="preload" href="/noteSite/assets/js/58.d4388ae7.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.f3b00718.js"><link rel="prefetch" href="/noteSite/assets/js/11.82b5bb56.js"><link rel="prefetch" href="/noteSite/assets/js/12.1bd2f9cc.js"><link rel="prefetch" href="/noteSite/assets/js/13.f45d544e.js"><link rel="prefetch" href="/noteSite/assets/js/14.c4835766.js"><link rel="prefetch" href="/noteSite/assets/js/15.637c455d.js"><link rel="prefetch" href="/noteSite/assets/js/16.588a856e.js"><link rel="prefetch" href="/noteSite/assets/js/17.42c5f955.js"><link rel="prefetch" href="/noteSite/assets/js/18.574f909b.js"><link rel="prefetch" href="/noteSite/assets/js/19.e82bb137.js"><link rel="prefetch" href="/noteSite/assets/js/20.b8985a34.js"><link rel="prefetch" href="/noteSite/assets/js/21.241b10b3.js"><link rel="prefetch" href="/noteSite/assets/js/22.0b1cbcb5.js"><link rel="prefetch" href="/noteSite/assets/js/23.9417af7f.js"><link rel="prefetch" href="/noteSite/assets/js/24.cc23bd66.js"><link rel="prefetch" href="/noteSite/assets/js/25.70e57329.js"><link rel="prefetch" href="/noteSite/assets/js/26.b102af09.js"><link rel="prefetch" href="/noteSite/assets/js/27.2b7f7a06.js"><link rel="prefetch" href="/noteSite/assets/js/28.c96d20c5.js"><link rel="prefetch" href="/noteSite/assets/js/29.d4be952c.js"><link rel="prefetch" href="/noteSite/assets/js/3.337055d6.js"><link rel="prefetch" href="/noteSite/assets/js/30.0feeb6b8.js"><link rel="prefetch" href="/noteSite/assets/js/31.29056a48.js"><link rel="prefetch" href="/noteSite/assets/js/32.091e921c.js"><link rel="prefetch" href="/noteSite/assets/js/33.175609c6.js"><link rel="prefetch" href="/noteSite/assets/js/34.67a4f534.js"><link rel="prefetch" href="/noteSite/assets/js/35.43a44608.js"><link rel="prefetch" href="/noteSite/assets/js/36.4689e98c.js"><link rel="prefetch" href="/noteSite/assets/js/37.cd08994b.js"><link rel="prefetch" href="/noteSite/assets/js/38.d1934c7f.js"><link rel="prefetch" href="/noteSite/assets/js/39.6fdc77b4.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/40.05764c13.js"><link rel="prefetch" href="/noteSite/assets/js/41.3b4564fc.js"><link rel="prefetch" href="/noteSite/assets/js/42.811569a8.js"><link rel="prefetch" href="/noteSite/assets/js/43.bf024261.js"><link rel="prefetch" href="/noteSite/assets/js/44.e5261c4a.js"><link rel="prefetch" href="/noteSite/assets/js/45.f472307d.js"><link rel="prefetch" href="/noteSite/assets/js/46.7d23314d.js"><link rel="prefetch" href="/noteSite/assets/js/47.31509015.js"><link rel="prefetch" href="/noteSite/assets/js/48.4f44d079.js"><link rel="prefetch" href="/noteSite/assets/js/49.ef911a2f.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.521dce92.js"><link rel="prefetch" href="/noteSite/assets/js/51.b0046c23.js"><link rel="prefetch" href="/noteSite/assets/js/52.15aa5c82.js"><link rel="prefetch" href="/noteSite/assets/js/53.b2473f21.js"><link rel="prefetch" href="/noteSite/assets/js/54.72ddb691.js"><link rel="prefetch" href="/noteSite/assets/js/55.fba89a1c.js"><link rel="prefetch" href="/noteSite/assets/js/56.c381e5e7.js"><link rel="prefetch" href="/noteSite/assets/js/57.8e68eda8.js"><link rel="prefetch" href="/noteSite/assets/js/59.1f65fbf3.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.006ce500.js"><link rel="prefetch" href="/noteSite/assets/js/61.876726e2.js"><link rel="prefetch" href="/noteSite/assets/js/62.39ee2d37.js"><link rel="prefetch" href="/noteSite/assets/js/63.95c608f3.js"><link rel="prefetch" href="/noteSite/assets/js/64.753a74e3.js"><link rel="prefetch" href="/noteSite/assets/js/65.d13a6496.js"><link rel="prefetch" href="/noteSite/assets/js/66.97d92c37.js"><link rel="prefetch" href="/noteSite/assets/js/67.bff02f7f.js"><link rel="prefetch" href="/noteSite/assets/js/68.2277979c.js"><link rel="prefetch" href="/noteSite/assets/js/69.1a58bbca.js"><link rel="prefetch" href="/noteSite/assets/js/7.80f82a7b.js"><link rel="prefetch" href="/noteSite/assets/js/70.ccf8809d.js"><link rel="prefetch" href="/noteSite/assets/js/71.3b9c3b54.js"><link rel="prefetch" href="/noteSite/assets/js/72.9bc88b73.js"><link rel="prefetch" href="/noteSite/assets/js/73.3355a085.js"><link rel="prefetch" href="/noteSite/assets/js/74.5f4e529e.js"><link rel="prefetch" href="/noteSite/assets/js/75.3438e9b2.js"><link rel="prefetch" href="/noteSite/assets/js/8.5d822633.js"><link rel="prefetch" href="/noteSite/assets/js/9.409ee5bd.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link router-link-active">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link router-link-active">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/linux/k8s/k8s-introduction.html" class="sidebar-link">Kubernetes 简介</a></li><li><a href="/noteSite/linux/k8s/k8s-concept.html" class="sidebar-link">Kubernetes 名词</a></li><li><a href="/noteSite/linux/k8s/k8s-clusterbuild.html" class="sidebar-link">Kubernetes 集群搭建</a></li><li><a href="/noteSite/linux/k8s/k8s-namespace.html" class="sidebar-link">Namespace</a></li><li><a href="/noteSite/linux/k8s/k8s-label.html" class="sidebar-link">Label</a></li><li><a href="/noteSite/linux/k8s/k8s-pod.html" class="sidebar-link">Pod</a></li><li><a href="/noteSite/linux/k8s/k8s-rs.html" class="sidebar-link">ReplicaSet</a></li><li><a href="/noteSite/linux/k8s/k8s-deployment.html" class="sidebar-link">Deployment</a></li><li><a href="/noteSite/linux/k8s/k8s-HPA.html" class="sidebar-link">Horizontal Pod Autoscaler</a></li><li><a href="/noteSite/linux/k8s/k8s-ds.html" class="sidebar-link">DaemonSet</a></li><li><a href="/noteSite/linux/k8s/k8s-job.html" aria-current="page" class="active sidebar-link">Job</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-job.html#一、job-使用" class="sidebar-link">一、Job 使用</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-job.html#二、job-场景" class="sidebar-link">二、Job 场景</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-job.html#三、job-模式" class="sidebar-link">三、Job 模式</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-job.html#四、job-回退" class="sidebar-link">四、Job 回退</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-job.html#五、job-终止和清理" class="sidebar-link">五、Job 终止和清理</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-job.html#六、job-挂起" class="sidebar-link">六、Job 挂起</a></li><li class="sidebar-sub-header"><a href="/noteSite/linux/k8s/k8s-job.html#七、cronjob" class="sidebar-link">七、CronJob</a></li></ul></li><li><a href="/noteSite/linux/k8s/k8s-service.html" class="sidebar-link">Service</a></li><li><a href="/noteSite/linux/k8s/k8s-ingress.html" class="sidebar-link">Ingress</a></li><li><a href="/noteSite/linux/k8s/k8s-ss.html" class="sidebar-link">StatefulSet</a></li><li><a href="/noteSite/linux/k8s/k8s-store.html" class="sidebar-link">Kubernetes 数据存储</a></li><li><a href="/noteSite/linux/k8s/k8s-auth.html" class="sidebar-link">Kubernetes 安全认证</a></li><li><a href="/noteSite/linux/k8s/k8s-dashboard.html" class="sidebar-link">Kubernetes DashBoard</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="job"><a href="#job" class="header-anchor">#</a> Job</h1> <p>Job 会创建一个或者多个 Pods，并将继续重试 Pods 的执行，直到指定数量的 Pods 成功终止。 随着 Pods 成功结束，Job 跟踪记录成功完成的 Pods 个数。 当数量达到指定的成功个数阈值时，任务（即 Job）结束。 删除 Job 的操作会清除所创建的全部 Pods。 挂起 Job 的操作会删除 Job 的所有活跃 Pod，直到 Job 被再次恢复执行。</p> <p>一种简单的使用场景下，你会创建一个 Job 对象以便以一种可靠的方式运行某 Pod 直到完成。 当第一个 Pod 失败或者被删除（比如因为节点硬件失效或者重启）时，Job 对象会启动一个新的 Pod。</p> <p>你也可以使用 Job 以并行的方式运行多个 Pod。</p> <h2 id="一、job-使用"><a href="#一、job-使用" class="header-anchor">#</a> 一、Job 使用</h2> <p>下面是一个 Job 配置示例。它负责计算 π 到小数点后 2000 位，并将结果打印出来。 此计算大约需要 10 秒钟完成。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pi
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pi
        <span class="token key atrule">image</span><span class="token punctuation">:</span> perl
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;perl&quot;</span><span class="token punctuation">,</span>  <span class="token string">&quot;-Mbignum=bpi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-wle&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print bpi(2000)&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">4</span>
</code></pre></div><p><strong>1. 创建 Job</strong></p> <div class="language- extra-class"><pre class="language-text"><code>$ kubectl apply -f job.yaml
job.batch/pi created
</code></pre></div><p><strong>2. 检查 Job 状态</strong></p> <div class="language- extra-class"><pre class="language-text"><code>$ kubectl describe jobs/pi
Name:           pi
Namespace:      default
Selector:       controller-uid=25e92d1d-2204-47c9-a531-26067bc7b4f6
Labels:         controller-uid=25e92d1d-2204-47c9-a531-26067bc7b4f6
                job-name=pi
Annotations:    &lt;none&gt;
Parallelism:    1
Completions:    1
Start Time:     Mon, 28 Jun 2021 11:06:23 +0800
Pods Statuses:  1 Running / 0 Succeeded / 0 Failed
Pod Template:
  Labels:  controller-uid=25e92d1d-2204-47c9-a531-26067bc7b4f6
           job-name=pi
  Containers:
   pi:
    Image:      perl
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Command:
      perl
      -Mbignum=bpi
      -wle
      print bpi(2000)
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Events:
  Type    Reason            Age   From            Message
  ----    ------            ----  ----            -------
  Normal  SuccessfulCreate  42s   job-controller  Created pod: pi-xzbr2
</code></pre></div><p><strong>3. 查看 Pod</strong></p> <p>要查看 Job 对应的已完成的 Pods，可以执行 <code>kubectl get pods</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>$ kubectl get pods
NAME                                READY   STATUS      RESTARTS   AGE
pi-xzbr2                            0/1     Completed   0          71s
</code></pre></div><p>要以机器可读的方式列举隶属于某 Job 的全部 Pods，可以使用类似下面这条命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">pods</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods --selector<span class="token operator">=</span>job-name<span class="token operator">=</span>pi --output<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.items[*].metadata.name}'</span><span class="token variable">)</span></span>
<span class="token builtin class-name">echo</span> <span class="token variable">$pods</span>
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>pi-xzbr2
</code></pre></div><p>这里，选择算符与 Job 的选择算符相同。<code>--output=jsonpath</code> 选项给出了一个表达式， 用来从返回的列表中提取每个 Pod 的 name 字段。</p> <p><strong>4. 查看结果</strong></p> <div class="language- extra-class"><pre class="language-text"><code>$ kubectl logs $pods
3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275901
</code></pre></div><h2 id="二、job-场景"><a href="#二、job-场景" class="header-anchor">#</a> 二、Job 场景</h2> <p>适合以 Job 形式来运行的任务主要有三种：</p> <ol><li>非并行 Job：
<ul><li>通常只启动一个 Pod，除非该 Pod 失败。</li> <li>当 Pod 成功终止时，立即视 Job 为完成状态。</li></ul></li> <li>具有确定完成计数的并行 Job：
<ul><li><code>.spec.completions</code> 字段设置为非 0 的正数值。</li> <li>Job 用来代表整个任务，当成功的 Pod 个数达到 <code>.spec.completions</code> 时，Job 被视为完成。</li> <li>当使用 <code>.spec.completionMode=&quot;Indexed&quot;</code> 时，每个 Pod 都会获得一个不同的 索引值，介于 0 和 <code>.spec.completions-1</code> 之间。</li></ul></li> <li>带工作队列的并行 Job：
<ul><li>不设置 <code>spec.completions</code>，默认值为 <code>.spec.parallelism</code>。</li> <li>多个 Pod 之间必须相互协调，或者借助外部服务确定每个 Pod 要处理哪个工作条目。 例如，任一 Pod 都可以从工作队列中取走最多 N 个工作条目。</li> <li>每个 Pod 都可以独立确定是否其它 Pod 都已完成，进而确定 Job 是否完成。</li> <li>当 Job 中 <em>任何</em> Pod 成功终止，不再创建新 Pod。</li> <li>一旦至少 1 个 Pod 成功完成，并且所有 Pod 都已终止，即可宣告 Job 成功完成。</li> <li>一旦任何 Pod 成功退出，任何其它 Pod 都不应再对此任务执行任何操作或生成任何输出。 所有 Pod 都应启动退出过程。</li></ul></li></ol> <p>对于 <em>非并行</em> 的 Job，你可以不设置 <code>spec.completions</code> 和 <code>spec.parallelism</code>。 这两个属性都不设置时，均取默认值 1。</p> <p>对于 <em>确定完成计数</em> 类型的 Job，你应该设置 <code>.spec.completions</code> 为所需要的完成个数。 你可以设置 <code>.spec.parallelism</code>，也可以不设置。其默认值为 1。</p> <p>对于一个 <em>工作队列</em> Job，你不可以设置 <code>.spec.completions</code>，但要将<code>.spec.parallelism</code> 设置为一个非负整数。</p> <p>关于如何利用不同类型的 Job 的更多信息，请参见 「Job 模式」一节。</p> <p><strong>控制并行性</strong></p> <p>并行性请求（<code>.spec.parallelism</code>）可以设置为任何非负整数。 如果未设置，则默认为 1。 如果设置为 0，则 Job 相当于启动之后便被暂停，直到此值被增加。</p> <p>实际并行性（在任意时刻运行状态的 Pods 个数）可能比并行性请求略大或略小， 原因如下：</p> <ul><li>对于 <em>确定完成计数</em> Job，实际上并行执行的 Pods 个数不会超出剩余的完成数。 如果 <code>.spec.parallelism</code> 值较高，会被忽略。</li> <li>对于 <em>工作队列</em> Job，有任何 Job 成功结束之后，不会有新的 Pod 启动。 不过，剩下的 Pods 允许执行完毕。</li> <li>如果 Job 控制器没有来得及作出响应，或者如果 Job 控制器因为任何原因（例如，缺少 <code>ResourceQuota</code> 或者没有权限）无法创建 Pods。 Pods 个数可能比请求的数目小。</li> <li>Job 控制器可能会因为之前同一 Job 中 Pod 失效次数过多而压制新 Pod 的创建。</li> <li>当 Pod 处于体面终止进程中，需要一定时间才能停止。</li></ul> <h2 id="三、job-模式"><a href="#三、job-模式" class="header-anchor">#</a> 三、Job 模式</h2> <p>Job 对象可以用来支持多个 Pod 的可靠的并发执行。 Job 对象不是设计用来支持相互通信的并行进程的，后者一般在科学计算中应用较多。 Job 的确能够支持对一组相互独立而又有所关联的 <em>工作条目</em> 的并行处理。 这类工作条目可能是要发送的电子邮件、要渲染的视频帧、要编解码的文件、NoSQL 数据库中要扫描的主键范围等等。</p> <p>在一个复杂系统中，可能存在多个不同的工作条目集合。这里我们仅考虑用户希望一起管理的 工作条目集合之一 — <em>批处理作业</em>。</p> <p>并行计算的模式有好多种，每种都有自己的强项和弱点。这里要权衡的因素有：</p> <ul><li>每个工作条目对应一个 Job 或者所有工作条目对应同一 Job 对象。 后者更适合处理大量工作条目的场景； 前者会给用户带来一些额外的负担，而且需要系统管理大量的 Job 对象。</li> <li>创建与工作条目相等的 Pod 或者令每个 Pod 可以处理多个工作条目。 前者通常不需要对现有代码和容器做较大改动； 后者则更适合工作条目数量较大的场合，原因同上。</li> <li>有几种技术都会用到工作队列。这意味着需要运行一个队列服务，并修改现有程序或容器 使之能够利用该工作队列。 与之比较，其他方案在修改现有容器化应用以适应需求方面可能更容易一些。</li></ul> <p>下面是对这些权衡的汇总，列 2 到 4 对应上面的权衡比较。 模式的名称对应了相关示例和更详细描述的链接。</p> <table><thead><tr><th>模式</th> <th style="text-align:center;">单个 Job 对象</th> <th style="text-align:center;">Pods 数少于工作条目数？</th> <th style="text-align:center;">直接使用应用无需修改?</th></tr></thead> <tbody><tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/coarse-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">每工作条目一 Pod 的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">✓</td> <td style="text-align:center;"></td> <td style="text-align:center;">有时</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/fine-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">Pod 数量可变的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">✓</td> <td style="text-align:center;">✓</td> <td style="text-align:center;"></td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/indexed-parallel-processing-static" target="_blank" rel="noopener noreferrer">静态任务分派的带索引的 Job<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">✓</td> <td style="text-align:center;"></td> <td style="text-align:center;">✓</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/parallel-processing-expansion/" target="_blank" rel="noopener noreferrer">Job 模版扩展<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;">✓</td></tr></tbody></table> <p>当你使用 <code>.spec.completions</code> 来设置完成数时，Job 控制器所创建的每个 Pod 使用完全相同的 <a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener noreferrer"><code>spec</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。 这意味着任务的所有 Pod 都有相同的命令行，都使用相同的镜像和数据卷，甚至连 环境变量都（几乎）相同。 这些模式是让每个 Pod 执行不同工作的几种不同形式。</p> <p>下表显示的是每种模式下 <code>.spec.parallelism</code> 和 <code>.spec.completions</code> 所需要的设置。 其中，<code>W</code> 表示的是工作条目的个数。</p> <table><thead><tr><th>模式</th> <th style="text-align:center;"><code>.spec.completions</code></th> <th style="text-align:center;"><code>.spec.parallelism</code></th></tr></thead> <tbody><tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/coarse-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">每工作条目一 Pod 的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">W</td> <td style="text-align:center;">任意值</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/fine-parallel-processing-work-queue/" target="_blank" rel="noopener noreferrer">Pod 个数可变的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">1</td> <td style="text-align:center;">任意值</td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/indexed-parallel-processing-static" target="_blank" rel="noopener noreferrer">静态任务分派的带索引的 Job<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">W</td> <td style="text-align:center;"></td></tr> <tr><td><a href="https://kubernetes.io/zh/docs/tasks/job/parallel-processing-expansion/" target="_blank" rel="noopener noreferrer">Job 模版扩展<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td style="text-align:center;">1</td> <td style="text-align:center;">应该为 1</td></tr></tbody></table> <h2 id="四、job-回退"><a href="#四、job-回退" class="header-anchor">#</a> 四、Job 回退</h2> <p>Pod 中的容器可能因为多种不同原因失效，例如因为其中的进程退出时返回值非零， 或者容器因为超出内存约束而被杀死等等。 如果发生这类事件，并且 <code>.spec.template.spec.restartPolicy = &quot;OnFailure&quot;</code>， Pod 则继续留在当前节点，但容器会被重新运行。 因此，你的程序需要能够处理在本地被重启的情况，或者要设置 <code>.spec.template.spec.restartPolicy = &quot;Never&quot;</code>。</p> <p>整个 Pod 也可能会失败，且原因各不相同。 例如，当 Pod 启动时，节点失效（被升级、被重启、被删除等）或者其中的容器失败而 <code>.spec.template.spec.restartPolicy = &quot;Never&quot;</code>。 当 Pod 失败时，Job 控制器会启动一个新的 Pod。 这意味着，你的应用需要处理在一个新 Pod 中被重启的情况。 尤其是应用需要处理之前运行所产生的临时文件、锁、不完整的输出等问题。</p> <p>注意，即使你将 <code>.spec.parallelism</code> 设置为 1，且将 <code>.spec.completions</code> 设置为 1，并且 <code>.spec.template.spec.restartPolicy</code> 设置为 &quot;Never&quot;，同一程序仍然有可能被启动两次。</p> <p>如果你确实将 <code>.spec.parallelism</code> 和 <code>.spec.completions</code> 都设置为比 1 大的值， 那就有可能同时出现多个 Pod 运行的情况。 为此，你的 Pod 也必须能够处理并发性问题。</p> <p><strong>Pod 回退失效策略：</strong></p> <p>在有些情形下，你可能希望 Job 在经历若干次重试之后直接进入失败状态，因为这很可能意味着遇到了配置错误。</p> <p>为了实现这点，可以将 <code>.spec.backoffLimit</code> 设置为视 Job 为失败之前的重试次数。 失效回退的限制值默认为 6。 与 Job 相关的失效的 Pod 会被 Job 控制器重建，回退重试时间将会按指数增长 （从 10 秒、20 秒到 40 秒）最多至 6 分钟。 当 Job 的 Pod 被删除时，或者 Pod 成功时没有其它 Pod 处于失败状态，失效回退的次数也会被重置（为 0）。</p> <h2 id="五、job-终止和清理"><a href="#五、job-终止和清理" class="header-anchor">#</a> 五、Job 终止和清理</h2> <p>Job 完成时不会再创建新的 Pod，<strong>不过已有的 Pod 也不会被删除</strong>。 保留这些 Pod 使得你可以查看已完成的 Pod 的日志输出，以便检查错误、警告 或者其它诊断性输出。 Job 完成时 Job 对象也一样被保留下来，这样你就可以查看它的状态。 在查看了 Job 状态之后删除老的 Job 的操作留给了用户自己。 你可以使用 <code>kubectl</code> 来删除 Job。</p> <p>例如：</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl delete jobs/pi
</code></pre></div><p>或者</p> <div class="language- extra-class"><pre class="language-text"><code>kubectl delete -f ./job.yaml
</code></pre></div><p>当使用 <code>kubectl</code> 来删除 Job 时，该 Job 所创建的 Pods 也会被删除。</p> <p>默认情况下，Job 会持续运行，除非某个 Pod 失败（<code>restartPolicy=Never</code>） 或者某个容器出错退出（<code>restartPolicy=OnFailure</code>）。 这时，Job 基于前述的 <code>spec.backoffLimit</code> 来决定是否以及如何重试。 一旦重试次数到达 <code>.spec.backoffLimit</code> 所设的上限，Job 会被标记为失败， 其中运行的 Pods 都会被终止。</p> <p>终止 Job 的另一种方式是设置一个活跃期限。 你可以为 Job 的 <code>.spec.activeDeadlineSeconds</code> 设置一个秒数值。 该值适用于 Job 的整个生命期，无论 Job 创建了多少个 Pod。 一旦 Job 运行时间达到 <code>activeDeadlineSeconds</code> 秒，其所有运行中的 Pod 都会被终止，并且 Job 的状态更新为 <code>type: Failed</code> 及 <code>reason: DeadlineExceeded</code>。</p> <p>注意 Job 的 <code>.spec.activeDeadlineSeconds</code> 优先级高于其 <code>.spec.backoffLimit</code> 设置。 因此，如果一个 Job 正在重试一个或多个失效的 Pod，该 Job 一旦到达 <code>activeDeadlineSeconds</code> 所设的时限即不再部署额外的 Pod，即使其重试次数还未 达到 <code>backoffLimit</code> 所设的限制。</p> <p>例如：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pi<span class="token punctuation">-</span>with<span class="token punctuation">-</span>timeout
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pi
        <span class="token key atrule">image</span><span class="token punctuation">:</span> perl
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;perl&quot;</span><span class="token punctuation">,</span>  <span class="token string">&quot;-Mbignum=bpi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-wle&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print bpi(2000)&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
</code></pre></div><p>还要注意的是，<code>restartPolicy</code> 对应的是 Pod，而不是 Job 本身： 一旦 Job 状态变为 <code>type: Failed</code>，就不会再发生 Job 重启的动作。 换言之，由 <code>.spec.activeDeadlineSeconds</code> 和 <code>.spec.backoffLimit</code> 所触发的 Job 终结机制都会导致 Job 永久性的失败，而这类状态都需要手工干预才能解决。</p> <p><strong>自动清理完成的 Job</strong>：</p> <p>完成的 Job 通常不需要留存在系统中。在系统中一直保留它们会给 API 服务器带来额外的压力。 如果 Job 由某种更高级别的控制器来管理，例如 CronJobs， 则 Job 可以被 CronJob 基于特定的根据容量裁定的清理策略清理掉。</p> <p><strong>已完成 Job 的 TTL 机制</strong></p> <p>自动清理已完成 Job （状态为 <code>Complete</code> 或 <code>Failed</code>）的另一种方式是使用由 <strong>TTL 控制器</strong>所提供 的 TTL 机制。 通过设置 Job 的 <code>.spec.ttlSecondsAfterFinished</code> 字段，可以让该控制器清理掉已结束的资源。</p> <p>TTL 控制器清理 Job 时，会级联式地删除 Job 对象。 换言之，它会删除所有依赖的对象，包括 Pod 及 Job 本身。 注意，当 Job 被删除时，系统会考虑其生命周期保障，例如其 Finalizers。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pi<span class="token punctuation">-</span>with<span class="token punctuation">-</span>ttl
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ttlSecondsAfterFinished</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pi
        <span class="token key atrule">image</span><span class="token punctuation">:</span> perl
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;perl&quot;</span><span class="token punctuation">,</span>  <span class="token string">&quot;-Mbignum=bpi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-wle&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;print bpi(2000)&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
</code></pre></div><p>Job <code>pi-with-ttl</code> 在结束 100 秒之后，可以成为被自动删除的对象。</p> <p>如果该字段设置为 <code>0</code>，Job 在结束之后立即成为可被自动删除的对象。 如果该字段没有设置，Job 不会在结束之后被 TTL 控制器自动清除。</p> <p>注意这种 TTL 机制仍然是一种 Alpha 状态的功能特性，需要配合 <code>TTLAfterFinished</code> 特性门控使用。有关详细信息，可参考 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/ttlafterfinished/" target="_blank" rel="noopener noreferrer">TTL 控制器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的文档。</p> <h2 id="六、job-挂起"><a href="#六、job-挂起" class="header-anchor">#</a> 六、Job 挂起</h2> <p>要挂起一个 Job，你可以将 Job 的 <code>.spec.suspend</code> 字段更新为 true。 之后，当你希望恢复其执行时，将其更新为 false。 创建一个 <code>.spec.suspend</code> 被设置为 true 的 Job 本质上会将其创建为<strong>被挂起状态</strong>。</p> <p>当 Job 被从挂起状态恢复执行时，其 <code>.status.startTime</code> 字段会被重置为当前的时间。这意味着 <code>.spec.activeDeadlineSeconds</code> 计时器会在 Job 挂起时被停止，并在 Job 恢复执行时复位。</p> <p>要记住的是，挂起 Job <strong>会删除其所有活跃的 Pod</strong>。当 Job 被挂起时，你的 Pod 会 收到 SIGTERM 信号而被终止。 Pod 的体面终止期限会被考虑，不过 Pod 自身也必须在此期限之内处理完信号。 处理逻辑可能包括保存进度以便将来恢复，或者取消已经做出的变更等等。 Pod 以这种形式终止时，不会被记入 Job 的 <code>completions</code> 计数。</p> <p>处于被挂起状态的 Job 的定义示例可能是这样子：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myjob
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">suspend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
</code></pre></div><p>Job 的 <code>status</code> 可以用来确定 Job 是否被挂起，或者曾经被挂起：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job
<span class="token comment"># .metadata and .spec omitted</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">conditions</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token string">&quot;2021-02-05T13:14:33Z&quot;</span>
    <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token string">&quot;2021-02-05T13:14:33Z&quot;</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">&quot;True&quot;</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Suspended
  <span class="token key atrule">startTime</span><span class="token punctuation">:</span> <span class="token string">&quot;2021-02-05T13:13:48Z&quot;</span>
</code></pre></div><p>Job 的 &quot;Suspended&quot; 类型的状况在状态值为 &quot;True&quot; 时意味着 Job 正被 挂起；<code>lastTransitionTime</code> 字段可被用来确定 Job 被挂起的时长。 如果此状况字段的取值为 &quot;False&quot;，则 Job 之前被挂起且现在在运行。 如果 &quot;Suspended&quot; 状况在 <code>status</code> 字段中不存在，则意味着 Job 从未 被停止执行。</p> <p>当 Job 被挂起和恢复执行时，也会生成事件：</p> <div class="language- extra-class"><pre class="language-text"><code>Name:           myjob
...
Events:
  Type    Reason            Age   From            Message
  ----    ------            ----  ----            -------
  Normal  SuccessfulCreate  12m   job-controller  Created pod: myjob-hlrpl
  Normal  SuccessfulDelete  11m   job-controller  Deleted pod: myjob-hlrpl
  Normal  Suspended         11m   job-controller  Job suspended
  Normal  SuccessfulCreate  3s    job-controller  Created pod: myjob-jvb44
  Normal  Resumed           3s    job-controller  Job resumed
</code></pre></div><h2 id="七、cronjob"><a href="#七、cronjob" class="header-anchor">#</a> 七、CronJob</h2> <p>CronJob 创建基于时隔重复调度的 Job。</p> <p>一个 CronJob 对象就像 <em>crontab</em> (cron table) 文件中的一行。 它用 Cron 格式进行编写， 并周期性地在给定的调度时间执行 Job。</p> <blockquote><p><strong>注意：</strong></p> <p>所有 <strong>CronJob</strong> 的 <code>schedule:</code> 时间都是基于 <a href="https://kubernetes.io/docs/reference/generated/kube-controller-manager/" target="_blank" rel="noopener noreferrer">kube-controller-manager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. 的时区。</p> <p>如果你的控制平面在 Pod 或是裸容器中运行了 kube-controller-manager， 那么为该容器所设置的时区将会决定 Cron Job 的控制器所使用的时区。</p></blockquote> <p>为 CronJob 资源创建清单时，请确保所提供的名称是一个合法的 <a href="https://kubernetes.io/zh/docs/concepts/overview/working-with-objects/names#dns-subdomain-names" target="_blank" rel="noopener noreferrer">DNS 子域名<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. 名称不能超过 52 个字符。 这是因为 CronJob 控制器将自动在提供的 Job 名称后附加 11 个字符，并且存在一个限制， 即 Job 名称的最大长度不能超过 63 个字符。</p> <p><strong>示例：每分钟打印出当前时间和问候消息</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">&quot;*/1 * * * *&quot;</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
            <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
            <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
            <span class="token punctuation">-</span> date; echo Hello from the Kubernetes cluster
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
</code></pre></div><p>Kubernetes 官网中的 「<a href="https://kubernetes.io/zh/docs/tasks/job/automated-tasks-with-cron-jobs/" target="_blank" rel="noopener noreferrer">使用 CronJob 运行自动化任务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 」一文会为你详细讲解此例。</p> <p><strong>cron 表达式：</strong></p> <div class="language- extra-class"><pre class="language-text"><code># ┌───────────── 分钟 (0 - 59)
# │ ┌───────────── 小时 (0 - 23)
# │ │ ┌───────────── 月的某天 (1 - 31)
# │ │ │ ┌───────────── 月份 (1 - 12)
# │ │ │ │ ┌───────────── 周的某天 (0 - 6) （周日到周一；在某些系统上，7 也是星期日）
# │ │ │ │ │                                   
# │ │ │ │ │
# │ │ │ │ │
# * * * * *
</code></pre></div><p>示例：</p> <table><thead><tr><th>输入</th> <th>描述</th> <th>相当于</th></tr></thead> <tbody><tr><td>@yearly (or @annually)</td> <td>每年 1 月 1 日的午夜运行一次</td> <td>0 0 1 1 *</td></tr> <tr><td>@monthly</td> <td>每月第一天的午夜运行一次</td> <td>0 0 1 * *</td></tr> <tr><td>@weekly</td> <td>每周的周日午夜运行一次</td> <td>0 0 * * 0</td></tr> <tr><td>@daily (or @midnight)</td> <td>每天午夜运行一次</td> <td>0 0 * * *</td></tr> <tr><td>@hourly</td> <td>每小时的开始一次</td> <td>0 * * * *</td></tr></tbody></table></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">6/28/2021, 11:37:52 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/linux/k8s/k8s-ds.html" class="prev">
        DaemonSet
      </a></span> <span class="next"><a href="/noteSite/linux/k8s/k8s-service.html">
        Service
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.19c58630.js" defer></script><script src="/noteSite/assets/js/2.0f8877a4.js" defer></script><script src="/noteSite/assets/js/58.d4388ae7.js" defer></script>
  </body>
</html>
