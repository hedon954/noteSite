(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{451:function(t,s,a){"use strict";a.r(s);var n=a(47),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_14-channel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-channel"}},[t._v("#")]),t._v(" 14. channel")]),t._v(" "),a("h2",{attrs:{id:"_14-1-底层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-1-底层"}},[t._v("#")]),t._v(" 14.1 底层")]),t._v(" "),a("p",[t._v("channel 底层是 "),a("code",[t._v("runtime/chan.go")]),t._v(" 的 "),a("code",[t._v("hchan")]),t._v(" 结构体：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" hchan "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tqcount   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// total data in the queue")]),t._v("\n\tdataqsiz "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// size of the circular queue")]),t._v("\n\tbuf      unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Pointer "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// points to an array of dataqsiz elements")]),t._v("\n\telemsize "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint16")]),t._v("\n\tclosed   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n\telemtype "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("_type "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// element type")]),t._v("\n\tsendx    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// send index")]),t._v("\n\trecvx    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// receive index")]),t._v("\n\trecvq    waitq  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// list of recv waiters")]),t._v("\n\tsendq    waitq  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// list of send waiters")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// lock protects all fields in hchan, as well as several")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// fields in sudogs blocked on this channel.")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Do not change another G's status while holding this lock")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// (in particular, do not ready a G), as this can deadlock")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// with stack shrinking.")]),t._v("\n\tlock mutex\t\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" waitq "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfirst "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("sudog\n\tlast  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("sudog\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("其中以下五个字段组成了一个 "),a("strong",[t._v("环形缓冲队列")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("\tqcount   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 当前在队列中的数据个数")]),t._v("\n\tdataqsiz "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("           "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 环形队列大小")]),t._v("\n\tbuf      unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Pointer "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 指向环形队列的指针")]),t._v("\n\telemsize "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint16")]),t._v("\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 每个数据大小")]),t._v("\n\telemtype "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("_type \t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 数据类型")]),t._v("\n")])])]),a("ul",[a("li",[t._v("环形缓存可以大幅降低 GC 的开销。")])]),t._v(" "),a("p",[t._v("其中还有四个字段组成了两个 "),a("strong",[t._v("链表")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("sendx    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 下次要发送的数据的 index")]),t._v("\nrecvx    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 下个要接收的数据的 index")]),t._v("\nrecvq    waitq  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 接受者等待队列")]),t._v("\nsendq    waitq  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发送者等待队列")]),t._v("\n")])])]),a("p",[t._v("还有一个 "),a("strong",[t._v("锁")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("lock mutex\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 保存 hchan 中的所有字段")]),t._v("\n")])])]),a("ul",[a("li",[t._v("互斥锁并不是排队发送 / 接收数据，它保护的是 hchan 结构体本身。")])]),t._v(" "),a("p",[t._v("还有一个 "),a("strong",[t._v("标记")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("closed   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 标记 channel 是否已经关闭")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/e6c9d24egy1h5fztbxrzej21ka0u0q62.jpg",alt:"image-20220823000852833"}})]),t._v(" "),a("h2",{attrs:{id:"_14-2-发送"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-2-发送"}},[t._v("#")]),t._v(" 14.2 发送")]),t._v(" "),a("h2",{attrs:{id:"_14-3-接收"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_14-3-接收"}},[t._v("#")]),t._v(" 14.3 接收")]),t._v(" "),a("Vssue")],1)}),[],!1,null,null,null);s.default=e.exports}}]);