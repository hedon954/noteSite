(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{501:function(s,t,a){"use strict";a.r(t);var e=a(47),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"九、redis-集群分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#九、redis-集群分片"}},[s._v("#")]),s._v(" 九、Redis 集群分片")]),s._v(" "),a("h2",{attrs:{id:"_1-集群介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-集群介绍"}},[s._v("#")]),s._v(" 1. 集群介绍")]),s._v(" "),a("p",[s._v("集群（cluster）就是一组计算机，它们作为一个整体向用户提供一组网络资源，这些单个的计算机系统就是集群的节点（node）。集群提供了以下关键的特性：")]),s._v(" "),a("ul",[a("li",[s._v("可扩展性")]),s._v(" "),a("li",[s._v("高可用性")]),s._v(" "),a("li",[s._v("负载均衡")]),s._v(" "),a("li",[s._v("错误恢复")])]),s._v(" "),a("p",[s._v("分布式与集群的联系与区别如下：")]),s._v(" "),a("ul",[a("li",[s._v("分布式即各个业务分开部署，集群指的是几台服务器集中在一起实现同一个业务。")]),s._v(" "),a("li",[s._v("分布式的每一个节点都可以做成集群，而集群并不一定就是分布式的。")])]),s._v(" "),a("p",[s._v("集群主要分为三大类：")]),s._v(" "),a("ul",[a("li",[s._v("HA（High Availability Cluster）：高可用集群")]),s._v(" "),a("li",[s._v("LBC（Load Balance Cluster）：负载均衡集群")]),s._v(" "),a("li",[s._v("HPC（High Performance Computing Cluster）：高性能集群")])]),s._v(" "),a("h2",{attrs:{id:"_2-redis-集群架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-集群架构"}},[s._v("#")]),s._v(" 2. Redis 集群架构")]),s._v(" "),a("h3",{attrs:{id:"_2-1-架构简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-架构简介"}},[s._v("#")]),s._v(" 2.1 架构简介")]),s._v(" "),a("ul",[a("li",[s._v("并发量大了 → 主从复制解决 → 主从稳定性 → 哨兵解决 → 单节点存储能力 → 集群 Cluster 解决")]),s._v(" "),a("li",[s._v("Redis Cluster 集群模式具有高可用、可扩展性、分布式、容错等特性。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6vbt70waj30hs0c5js8.jpg",alt:"img"}})]),s._v(" "),a("p",[s._v("Redis Cluster 采用无中心结构，每个节点都可以保存数据和整个集群状态，每个节点都和其他所有节点连接，Cluster 至少为 6 个才能保证组成完成高可用集群，分为 3 主 3 从。主节点分配槽，处理客户端的命令请求，从节点可用在主节点故障后，顶替主节点。")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("为什么至少 6 台呢？")]),s._v(" "),a("p",[s._v("我们可以在 Redis 官方找到这么一句话：")]),s._v(" "),a("blockquote",[a("p",[s._v("Note that the minial cluster that works as expected requires to contain at least three master nodes.")])]),s._v(" "),a("p",[s._v("因为最小的 Redis 集群，需要至少 3 个主节点（哨兵），既然有 3 个主节点，而一个主节点搭配至少一个从节点，因此至少得 6 台 Redis。")])]),s._v(" "),a("p",[s._v("如上图所示，该集群中包括 6 个 Redis 节点，3 主 3 从，分别为 M1、M2、M3、S1、S2、S3。除了主从 Redis 节点之间进行数据复制外，所有 Redis 节点之间采用 Gossip 协议进行通信，交换维护节点元数据信息。")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("Gossip")])]),s._v(" "),a("h3",{attrs:{id:"_2-2-主从模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-主从模式"}},[s._v("#")]),s._v(" 2.2 主从模式")]),s._v(" "),a("ul",[a("li",[s._v("一个主节点搭配一个或多个从节点，从而保证高可用。")])]),s._v(" "),a("h3",{attrs:{id:"_2-3-优点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-优点"}},[s._v("#")]),s._v(" 2.3 优点")]),s._v(" "),a("ul",[a("li",[s._v("去中心化")]),s._v(" "),a("li",[s._v("可扩展性")]),s._v(" "),a("li",[s._v("高可用性")]),s._v(" "),a("li",[s._v("自动故障转移")])]),s._v(" "),a("h3",{attrs:{id:"_2-4-缺点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-缺点"}},[s._v("#")]),s._v(" 2.4 缺点")]),s._v(" "),a("ul",[a("li",[s._v("数据通过异步复制，无法保证数据强一致性")]),s._v(" "),a("li",[s._v("集群环境搭建略微复杂")])]),s._v(" "),a("h2",{attrs:{id:"_3-数据分区方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-数据分区方式"}},[s._v("#")]),s._v(" 3. 数据分区方式")]),s._v(" "),a("p",[s._v("随着请求量和数据量的增加，一台机器已经无法满足需求，我们就需要把数据和请求分割到多台机器，这时候就需要引入分布式存储。分布式分成有以下几个特性：")]),s._v(" "),a("ul",[a("li",[s._v("增强可用性")]),s._v(" "),a("li",[s._v("维护方便")]),s._v(" "),a("li",[s._v("均衡 IO")]),s._v(" "),a("li",[s._v("改善查询性能")])]),s._v(" "),a("p",[s._v("分布式存储首先要解决的就是把整个数据集安全分区规则映射到多个节点的问题。")]),s._v(" "),a("p",[s._v("下面介绍几个常见的分区算法。")]),s._v(" "),a("h3",{attrs:{id:"_3-1-范围分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-范围分区"}},[s._v("#")]),s._v(" 3.1 范围分区")]),s._v(" "),a("ul",[a("li",[s._v("优点：同一范围内的范围查询不需要跨节点，提升查询速度")]),s._v(" "),a("li",[s._v("应用场景：MySQL、Oracle")])]),s._v(" "),a("h3",{attrs:{id:"_3-2-节点取余分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-节点取余分区"}},[s._v("#")]),s._v(" 3.2 节点取余分区")]),s._v(" "),a("p",[s._v("hash(object) % N")]),s._v(" "),a("ul",[a("li",[s._v("优点：实现简单，数据均匀分摊")]),s._v(" "),a("li",[s._v("缺点：当扩容或缩容节点时，需要迁移的数据量大（翻倍扩容可以相对减少迁移量）。")])]),s._v(" "),a("h3",{attrs:{id:"_3-3-一致性哈希分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-一致性哈希分区"}},[s._v("#")]),s._v(" 3.3 一致性哈希分区")]),s._v(" "),a("ul",[a("li",[s._v("优点：相比节点取余最大的好处在于加入和删除节点只影响哈希环中相邻的节点，对其他节点无影响。")]),s._v(" "),a("li",[s._v("缺点：当使用少量节点时，节点变化将大范围影响哈希环中数据映射，因此这种方式不适合少量数据节点的分布式方案。")]),s._v(" "),a("li",[s._v("应用场景：Memcached")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6wrph6gnj30hz0dddgo.jpg",alt:"img"}})]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("一致性哈希算法")]),s._v(" "),a("blockquote",[a("p",[s._v("参考：https://zhuanlan.zhihu.com/p/98030096")])]),s._v(" "),a("p",[a("strong",[s._v("1. 普通 hash 算法在分布式系统中的缺陷")])]),s._v(" "),a("p",[s._v("在分布式的存储系统中，要将数据存储到具体的节点上，如果我们采用普通的 hash 算法进行路由，将数据映射到具体的节点上，如 key%N，key 是数据的 key，N 是机器节点数，如果有一个机器加入或退出这个集群，则所有的数据映射都无效了，如果是持久化存储则要做数据迁移，如果是分布式缓存，则其他缓存就失效了。")]),s._v(" "),a("p",[a("strong",[s._v("2. 一致性哈希")])]),s._v(" "),a("p",[s._v("一致性哈希提出了在动态变化的 Cache 环境中，哈希算法应该满足的 4 个适应条件：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("均衡性（Balance）")]),s._v(" "),a("p",[s._v("平衡性是指哈希的结果能够尽可能分布到所有的缓冲中去，这样可以使得所有的缓冲空间都得到利用。很多哈希算法都能够满足这一条件。")])]),s._v(" "),a("li",[a("p",[s._v("单调性（Monotonicity）")]),s._v(" "),a("p",[s._v("单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲区加入到系统中，那么哈希的结果应能够保证原有已分配的内容可以被映射到新的缓冲区中去，而不会被映射到旧的缓冲集合中的其他缓冲区。（"),a("strong",[s._v("这段翻译信息有负面价值的，当缓冲区大小变化时一致性哈希（Consistent hashing）尽量保护已分配的内容不会被重新映射到新缓冲区。")]),s._v("）")])]),s._v(" "),a("li",[a("p",[s._v("低分散性（Spread）")]),s._v(" "),a("p",[s._v("在分布式环境中，终端有可能看不到所有的缓冲，而是只能看到其中的一部分。当终端希望通过哈希过程将内容映射到缓冲上时，由于不同终端所见的缓冲范围有可能不同，从而导致哈希的结果不一致，最终的结果是相同的内容被不同的终端映射到不同的缓冲区中。这种情况显然是应该避免的，因为它导致相同内容被存储到不同缓冲中去，降低了系统存储的效率。分散性的定义就是上述情况发生的严重程度。好的哈希算法应能够尽量避免不一致的情况发生，也就是尽量降低分散性。")])]),s._v(" "),a("li",[a("p",[s._v("低负载（Load）")]),s._v(" "),a("p",[s._v("负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。与分散性一样，这种情况也是应当避免的，因此好的哈希算法应能够尽量降低缓冲的负荷。")])])]),s._v(" "),a("p",[a("strong",[s._v("3. 一致性哈希算法实现")])]),s._v(" "),a("ul",[a("li",[a("p",[s._v("环形 hash 空间")]),s._v(" "),a("p",[s._v("按照常用的 hash 算法来将对应的 key 哈希到一个具有 2"),a("sup",[s._v("32")]),s._v(" 次方个节点的空间中，即 0 ~ （2"),a("sup",[s._v("32")]),s._v("-1）的数字空间中。现在我们可以将这些数字头尾相连，想象成一个闭合的环形。")]),s._v(" "),a("p",[s._v("节点的个数可以自定义，整个 hash 环我们可以用 TreeMap 来实现，因为 TreeMap 是有序的，我们刚好可以利用上。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6x9qckxuj30bh0c70so.jpg",alt:"img"}})])]),s._v(" "),a("li",[a("p",[s._v("映射服务器节点")]),s._v(" "),a("p",[s._v("将各个服务器使用 hash 进行一个哈希，具体可以选择服务器的 IP 或唯一主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假设我们将四台服务器使用 IP 地址哈希后在环空间的位置如下：")]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6xcfnug3j30i50iy3yw.jpg",alt:"img"}})]),s._v(" "),a("li",[a("p",[s._v("映射数据")]),s._v(" "),a("p",[s._v("现在我们将 objectA、objectB、objectC、objectD 四个对象通过特定的 hash 函数计算出对应的 key 值，然后散列到 hash 环上,然后从数据所在位置沿环顺时针“行走”，第一台遇到的服务器就是其应该定位到的服务器。")]),s._v(" "),a("img",{staticStyle:{zoom:"43%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6xd1r9oaj30u00ut0u3.jpg",alt:"img"}})]),s._v(" "),a("li",[a("p",[s._v("节点的删除与增加")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("如果此时 NodeC 宕机了，此时 Object A、B、D 不会受到影响，只有 ObjectC 会重新分配到 NodeD 上面去，而其他数据对象不会发生变化。")])]),s._v(" "),a("li",[a("p",[s._v("如果在环境中新增一台服务器 Node X，通过 hash 算法将 Node X 映射到环中，通过按顺时针迁移的规则，那么ObjectC 被迁移到了 NodeX中，其它对象还保持这原有的存储位置。通过对节点的添加和删除的分析，一致性哈希算法在保持了单调性的同时，还是数据的迁移达到了最小，这样的算法对分布式集群来说是非常合适的，避免了大量数据迁移，减小了服务器的的压力。")]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6xfab1kkj30u00v7wg1.jpg",alt:"img"}})])])]),s._v(" "),a("li",[a("p",[s._v("虚拟节点")]),s._v(" "),a("p",[s._v("到目前为止一致性哈希也可以算做完成了，但是有一个问题还需要解决，那就是"),a("strong",[s._v("平衡性")]),s._v("。从下图我们可以看出，当服务器节点比较少的时候，会出现一个问题，就是此时必然造成大量数据集中到一个节点上面，极少数数据集中到另外的节点上面。")]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6xfpinraj30cq0imdfz.jpg",alt:"img"}}),s._v(" "),a("p",[s._v("为了解决这种数据倾斜问题，一致性哈希算法引入了虚拟节点机制，即对每一个服务节点计算多个哈希，每个计算结果位置都放置一个此服务节点，称为虚拟节点。具体做法可以先确定每个物理节点关联的虚拟节点数量，然后在 IP 或者主机名后面增加编号。例如上面的情况，可以为每台服务器计算三个虚拟节点，于是可以分别计算 “Node A#1”、“Node A#2”、“Node A#3”、“Node B#1”、“Node B#2”、“Node B#3”的哈希值，于是形成六个虚拟节点：")]),s._v(" "),a("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt6xg5m7rtj30hq0ii74v.jpg",alt:"img"}}),s._v(" "),a("p",[s._v("同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射，例如定位到“Node A#1”、“Node A#2”、“Node A#3”三个虚拟节点的数据均定位到 NodeA上。这样就解决了服务节点少时数据倾斜的问题。每个物理节点关联的虚拟节点数量就根据具体的生产环境情况在确定。")])])])]),s._v(" "),a("h3",{attrs:{id:"_3-4-虚拟槽分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-虚拟槽分区"}},[s._v("#")]),s._v(" 3.4 虚拟槽分区")]),s._v(" "),a("p",[s._v("Redis 内部内置了序号 0-16383 个槽位，每个槽位可以用来存储一个数据集合，将这些槽位按顺序分配到集群中的各个节点。每次新的数据到来，会通过哈希函数 CRC16(key) 算出将要存储的槽位下标，然后通过该下标找到前面分配的 Redis 节点，最后将数据存储到该节点中。")]),s._v(" "),a("p",[s._v("这种结构很容易添加或者删除节点，并且无论是添加删除或者修改某一个节点，都不会造成集群不可用的状态。"),a("strong",[s._v("使用哈希槽的好处就在于可以方便的添加或移除节点。")])]),s._v(" "),a("ol",[a("li",[s._v("当需要增加节点时，只需要把其他节点的某些哈希槽挪到新节点就可以了；")]),s._v(" "),a("li",[s._v("当需要移除节点时，只需要把移除节点上的哈希槽挪到其他节点就行了。")])]),s._v(" "),a("ul",[a("li",[s._v("优点：每个 node 均匀的分配了 slot，缩小增减节点影响的范围。")]),s._v(" "),a("li",[s._v("缺点：需要存储 node 和 slot 的对应信息。")]),s._v(" "),a("li",[s._v("应用场景：Redis Cluster。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt78ks8cd9j31fq0ncgom.jpg",alt:"image-20210806181759610"}})]),s._v(" "),a("h2",{attrs:{id:"_4-集群环境搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-集群环境搭建"}},[s._v("#")]),s._v(" 4. 集群环境搭建")]),s._v(" "),a("blockquote",[a("p",[s._v("为了方便，本节集群环境中准备 3 台虚拟机，每台虚拟机上跑 2 个 Redis，模拟 6 台机器，搭建 3 主 3 从集群。")])]),s._v(" "),a("h3",{attrs:{id:"_4-1-环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-环境准备"}},[s._v("#")]),s._v(" 4.1 环境准备")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("IP")]),s._v(" "),a("th",[s._v("端口")]),s._v(" "),a("th",[s._v("操作系统")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("172.16.58.200")]),s._v(" "),a("td",[s._v("6371, 6372")]),s._v(" "),a("td",[s._v("CentOS 7")])]),s._v(" "),a("tr",[a("td",[s._v("172.16.58.201")]),s._v(" "),a("td",[s._v("6373, 6374")]),s._v(" "),a("td",[s._v("CentOS 7")])]),s._v(" "),a("tr",[a("td",[s._v("172.16.58.202")]),s._v(" "),a("td",[s._v("6375, 6376")]),s._v(" "),a("td",[s._v("CentOS 7")])])])]),s._v(" "),a("h3",{attrs:{id:"_4-2-安装-redis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-安装-redis"}},[s._v("#")]),s._v(" 4.2 安装 Redis")]),s._v(" "),a("p",[s._v("分别在三台机器上下载 Redis："),a("RouterLink",{attrs:{to:"/backend/middleware/redis/redis_intro.html#_2-2-安装-redis"}},[s._v("Redis 安装")])],1),s._v(" "),a("h3",{attrs:{id:"_4-3-创建目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-创建目录"}},[s._v("#")]),s._v(" 4.3 创建目录")]),s._v(" "),a("p",[s._v("在三台机器上都创建以下目录")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/redis/cluster/conf\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/redis/cluster/data\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/redis/cluster/log\n")])])]),a("h3",{attrs:{id:"_4-4-创建配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-创建配置文件"}},[s._v("#")]),s._v(" 4.4 创建配置文件")]),s._v(" "),a("p",[s._v("三台机器都创建两个配置文件，6371 的如下，其余的同理。")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/local/redis/cluster/conf/redis-6371.conf\n")])])]),a("p",[s._v("内容如下：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 放行 IP 限制")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 端口")]),s._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6371")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后台启动")]),s._v("\ndaemonize "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志存储目录以及日志文件名")]),s._v("\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/redis/cluster/log/redis-6371.log"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# RDB 数据文件名")]),s._v("\ndbfilename dump-6371.rbd\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# AOF 模式开启和 AOF 数据文件名")]),s._v("\nappendonly "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nappendfilename "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly-6371.aof"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# RDB 数据文件和 AOF 数据文件的存储目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /usr/local/redis/cluster/data\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置密码")]),s._v("\nrequirepass "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从节点访问主节点密码（必须与 requirepass 一致）")]),s._v("\nmasterauth "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否开启集群模式，默认是 no")]),s._v("\ncluster-enabled "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群节点信息文件，会保存在 dir 配置对应目录下")]),s._v("\ncluster-config-file nodes-6371.conf\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群节点连接超时时间，单位是毫秒")]),s._v("\ncluster-node-timeout "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群节点 IP")]),s._v("\ncluster-announce-ip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群节点映射端口")]),s._v("\ncluster-announce-port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6371")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群节点总线端口")]),s._v("\ncluster-announce-bus-port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16371")]),s._v("\n")])])]),a("h3",{attrs:{id:"_4-5-启动-redis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-启动-redis"}},[s._v("#")]),s._v(" 4.5 启动 Redis")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 172.16.58.200")]),s._v("\n/usr/local/redis/bin/redis-server /usr/local/redis/cluster/conf/redis-6371.conf \n/usr/local/redis/bin/redis-server /usr/local/redis/cluster/conf/redis-6372.conf \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 172.16.58.201")]),s._v("\n/usr/local/redis/bin/redis-server /usr/local/redis/cluster/conf/redis-6373.conf \n/usr/local/redis/bin/redis-server /usr/local/redis/cluster/conf/redis-6374.conf \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 172.16.58.202")]),s._v("\n/usr/local/redis/bin/redis-server /usr/local/redis/cluster/conf/redis-6375.conf \n/usr/local/redis/bin/redis-server /usr/local/redis/cluster/conf/redis-6376.conf \n")])])]),a("h3",{attrs:{id:"_4-6-启动-redis-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-启动-redis-cluster"}},[s._v("#")]),s._v(" 4.6 启动 Redis Cluster")]),s._v(" "),a("p",[s._v("随便找一个节点，执行以下命令，就可以创建 Redis Cluster 了：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("/usr/local/redis/bin/redis-cli -a "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --cluster create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6372 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6376 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--cluster-replicas "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])])]),a("ul",[a("li",[a("code",[s._v("--cluster create")]),s._v("：创建集群")]),s._v(" "),a("li",[a("code",[s._v("--cluster-replicas")]),s._v("：主从比例，"),a("code",[s._v("1")]),s._v(" 表示一主一从")])]),s._v(" "),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Performing "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("hash")]),s._v(" slots allocation on "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" nodes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nMaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Slots "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5460")]),s._v("\nMaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Slots "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10922")]),s._v("\nMaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Slots "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10923")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16383")]),s._v("\nAdding replica "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374 to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371\nAdding replica "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6376 to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373\nAdding replica "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6372 to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375\nM: 8306858f71a9a4f43c644bf4426ae2c6561b36a5 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-5460"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\nS: 8f18a0cf21cc4bcc3d96c0e672edf0949abefad1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6372\n   replicates be0ddf4921a4a2f077b8c0a72504c8714c69b836\nM: ad98c789913e6cb9db293379509d39d8856d41b2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v("-10922"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5462")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\nS: 3c95fde7335c16c7f3fe323bde9cfc9778ca1d38 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374\n   replicates 8306858f71a9a4f43c644bf4426ae2c6561b36a5\nM: be0ddf4921a4a2f077b8c0a72504c8714c69b836 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10923")]),s._v("-16383"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\nS: 7ba9475d72e3ff57b409e9ff2ee7ecbfce4a024f "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6376\n   replicates ad98c789913e6cb9db293379509d39d8856d41b2\nCan I "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the above configuration? "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("type "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yes'")]),s._v(" to accept"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Nodes configuration updated\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Assign a different config epoch to each node\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Sending CLUSTER MEET messages to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" the cluster\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the cluster to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Performing Cluster Check "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("using node "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nM: 8306858f71a9a4f43c644bf4426ae2c6561b36a5 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-5460"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" additional replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nS: 8f18a0cf21cc4bcc3d96c0e672edf0949abefad1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6372\n   slots: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" slave\n   replicates be0ddf4921a4a2f077b8c0a72504c8714c69b836\nM: be0ddf4921a4a2f077b8c0a72504c8714c69b836 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10923")]),s._v("-16383"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" additional replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nM: ad98c789913e6cb9db293379509d39d8856d41b2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v("-10922"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5462")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" additional replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nS: 3c95fde7335c16c7f3fe323bde9cfc9778ca1d38 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374\n   slots: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" slave\n   replicates 8306858f71a9a4f43c644bf4426ae2c6561b36a5\nS: 7ba9475d72e3ff57b409e9ff2ee7ecbfce4a024f "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6376\n   slots: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" slave\n   replicates ad98c789913e6cb9db293379509d39d8856d41b2\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" All nodes agree about slots configuration.\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Check "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Check slots coverage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" All "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v(" slots covered.\n")])])]),a("h2",{attrs:{id:"_5-集群状态检查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-集群状态检查"}},[s._v("#")]),s._v(" 5. 集群状态检查")]),s._v(" "),a("h3",{attrs:{id:"_5-1-检查集群状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-检查集群状态"}},[s._v("#")]),s._v(" 5.1 检查集群状态")]),s._v(" "),a("p",[s._v("命令："),a("code",[s._v("check")])]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("redis-cli -a "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" --cluster check "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373\n")])])]),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主节点信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ad98c789"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5462")]),s._v(" slots "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" slaves.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("8306858f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" slaves.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("be0ddf49"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" keys "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" slaves.\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主节点中都有多少 key")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" keys "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" masters.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" keys per slot on average.\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Performing Cluster Check "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("using node "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主从详细信息")]),s._v("\nM: ad98c789913e6cb9db293379509d39d8856d41b2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373\n\t "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分槽情况")]),s._v("\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v("-10922"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5462")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从节点个数")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" additional replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nS: 3c95fde7335c16c7f3fe323bde9cfc9778ca1d38 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374\n\t "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从节点无槽")]),s._v("\n   slots: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" slave\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从节点在复制哪个主节点")]),s._v("\n   replicates 8306858f71a9a4f43c644bf4426ae2c6561b36a5\nS: 8f18a0cf21cc4bcc3d96c0e672edf0949abefad1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6372\n   slots: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" slave\n   replicates be0ddf4921a4a2f077b8c0a72504c8714c69b836\nM: 8306858f71a9a4f43c644bf4426ae2c6561b36a5 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-5460"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" additional replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nM: be0ddf4921a4a2f077b8c0a72504c8714c69b836 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375\n   slots:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10923")]),s._v("-16383"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" master\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" additional replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nS: 7ba9475d72e3ff57b409e9ff2ee7ecbfce4a024f "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6376\n   slots: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" slave\n   replicates ad98c789913e6cb9db293379509d39d8856d41b2\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" All nodes agree about slots configuration.\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Check "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" slots"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Check slots coverage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" All "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v(" slots covered.\n")])])]),a("h3",{attrs:{id:"_5-2-集群日志分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-集群日志分析"}},[s._v("#")]),s._v(" 5.2 集群日志分析")]),s._v(" "),a("p",[s._v("由输出日志 "),a("code",[s._v("Adding replica 172.16.58.201:6374 to 172.16.58.200:6371")]),s._v(" 我们可以知道 "),a("code",[s._v("6371")]),s._v(" 是 "),a("code",[s._v("6374")]),s._v(" 的主节点，我们就来分析这两个节点的日志。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("6371")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6371")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" -f -n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" /usr/local/redis/cluster/log/redis-6371.log\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化 Redis 服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":36:50.916 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Server initialized")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":36:50.916 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo madvise > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled (set to 'madvise' or 'never').")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":36:50.916 * Ready to accept connections\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:38.570 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# configEpoch set to 1 via CLUSTER SET-CONFIG-EPOCH")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从节点 6374 请求 SYNC 复制")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.047 * Replica "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374 asks "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" synchronization\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.047 * Partial resynchronization not accepted: Replication ID mismatch "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Replica asked "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2deebf1e2e8995cd7e561153ce643056c542f05e'")]),s._v(", my replication IDs are "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'9fed7c28df63218d0d29b9041a683ca7213dcad8'")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0000000000000000000000000000000000000000'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建 backlog 以及对应的复制 ID")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.047 * Replication backlog created, my new replication IDs are "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'145f1a07ead94288b0324a632fcb1d1c2debbba7'")]),s._v(" and "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'0000000000000000000000000000000000000000'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# bgsave")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.047 * Starting BGSAVE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" SYNC with target: disk\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.047 * Background saving started by pid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89219")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89219")]),s._v(":C 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.052 * DB saved on disk\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89219")]),s._v(":C 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.052 * RDB: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" MB of memory used by copy-on-write\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.115 * Background saving terminated with success\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.116 * Synchronization with replica "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374 succeeded\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("83479")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:43.522 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Cluster state changed: ok")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("6374")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6374")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("tail")]),s._v(" -f -n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" /usr/local/redis/cluster/log/redis-6374.log\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化 Redis 服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":44:37.923 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Server initialized")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":44:37.923 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo madvise > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled (set to 'madvise' or 'never').")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":44:37.924 * Ready to accept connections\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":M 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:38.749 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# configEpoch set to 4 via CLUSTER SET-CONFIG-EPOCH")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在变为从节点之前，要做一些准备工作")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:40.769 * Before turning into a replica, using my own master parameters to synthesize a cached master: I may be able to synchronize with the new master with just a partial transfer.\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群环境准备 ok")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:40.769 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Cluster state changed: ok")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接主节点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.213 * Connecting to MASTER "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始主从复制")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.213 * MASTER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" REPLICA "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v(" started\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 触发了 SYNC 主从同步非阻塞命令")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.214 * Non blocking connect "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" SYNC fired the event.\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主从 PING-PONG 通信")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.216 * Master replied to PING, replication can continue"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 尝试一个部分同步")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.221 * Trying a partial resynchronization "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("request 2deebf1e2e8995cd7e561153ce643056c542f05e:1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 因为环境刚搭好，需要全量复制，所以被 master 拒绝了，开始全量复制")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.223 * Full resync from master: 145f1a07ead94288b0324a632fcb1d1c2debbba7:0\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 抛弃之前缓存的数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.223 * Discarding previously cached master state.\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始从主节点那拉数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.291 * MASTER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" REPLICA sync: receiving "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("175")]),s._v(" bytes from master to disk\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.292 * MASTER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" REPLICA sync: Flushing old data\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.292 * MASTER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" REPLICA sync: Loading DB "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" memory\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加载 RDB")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.293 * Loading RDB produced by version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6.0")]),s._v(".9\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.293 * RDB age "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" seconds\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.293 * RDB memory usage when created "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.54")]),s._v(" Mb\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.293 * MASTER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" REPLICA sync: Finished with success\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.293 * Background append only "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" rewriting started by pid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100901")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加载 AOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.318 * AOF rewrite child asks to stop sending diffs.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100901")]),s._v(":C 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.318 * Parent agreed to stop sending diffs. Finalizing AOF"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100901")]),s._v(":C 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.318 * Concatenating "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" MB of AOF "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" received from parent.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100901")]),s._v(":C 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.318 * SYNC append only "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" rewrite performed\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100901")]),s._v(":C 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.319 * AOF rewrite: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" MB of memory used by copy-on-write\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.414 * Background AOF rewrite terminated with success\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.414 * Residual parent "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("diff")]),s._v(" successfully flushed to the rewritten AOF "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98575")]),s._v(":S 05 Aug "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(":52:41.414 * Background AOF rewrite finished successfully\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"_5-3-查看集群信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-查看集群信息"}},[s._v("#")]),s._v(" 5.3 查看集群信息")]),s._v(" "),a("p",[s._v("随便找一个节点，连进 Redis Cluster，核心选项 "),a("code",[s._v("-c")]),s._v("，表示以集群的模式连接：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("redis-cli -c -a "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" -h "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6371")]),s._v("\n")])])]),a("h4",{attrs:{id:"_5-3-1-查看集群信息-cluster-info"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-1-查看集群信息-cluster-info"}},[s._v("#")]),s._v(" 5.3.1 查看集群信息 CLUSTER INFO")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" CLUSTER INFO\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群状态")]),s._v("\ncluster_state:ok\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 总槽数")]),s._v("\ncluster_slots_assigned:16384\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分配好的槽")]),s._v("\ncluster_slots_ok:16384\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可能失败的槽")]),s._v("\ncluster_slots_pfail:0\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 真实失败的槽")]),s._v("\ncluster_slots_fail:0\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 已知集群节点")]),s._v("\ncluster_known_nodes:6\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 集群主节点个数")]),s._v("\ncluster_size:3\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前集群最大最新的 epoch")]),s._v("\ncluster_current_epoch:6\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前节点所在 epoch，后面都会同步到跟 cluster_current_epoch 一样")]),s._v("\ncluster_my_epoch:1\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ping-pong 信息")]),s._v("\ncluster_stats_messages_ping_sent:1306\ncluster_stats_messages_pong_sent:1304\ncluster_stats_messages_sent:2610\ncluster_stats_messages_ping_received:1299\ncluster_stats_messages_pong_received:1306\ncluster_stats_messages_meet_received:5\ncluster_stats_messages_received:2610\n")])])]),a("h4",{attrs:{id:"_5-3-2-查看节点信息-cluster-nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-2-查看节点信息-cluster-nodes"}},[s._v("#")]),s._v(" 5.3.2 查看节点信息 CLUSTER NODES")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" CLUSTER NODES\n8f18a0cf21cc4bcc3d96c0e672edf0949abefad1 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6372@16372 slave be0ddf4921a4a2f077b8c0a72504c8714c69b836 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1628234206407")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" connected\nbe0ddf4921a4a2f077b8c0a72504c8714c69b836 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375@16375 master - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1628234205407")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" connected "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10923")]),s._v("-16383\nad98c789913e6cb9db293379509d39d8856d41b2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6373@16373 master - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1628234203400")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" connected "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v("-10922\n3c95fde7335c16c7f3fe323bde9cfc9778ca1d38 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.201:6374@16374 slave 8306858f71a9a4f43c644bf4426ae2c6561b36a5 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1628234205000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" connected\n7ba9475d72e3ff57b409e9ff2ee7ecbfce4a024f "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6376@16376 slave ad98c789913e6cb9db293379509d39d8856d41b2 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1628234204000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" connected\n8306858f71a9a4f43c644bf4426ae2c6561b36a5 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371@16371 myself,master - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1628234205000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" connected "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("-5460\n")])])]),a("h2",{attrs:{id:"_6-集群环境测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-集群环境测试"}},[s._v("#")]),s._v(" 6.  集群环境测试")]),s._v(" "),a("h3",{attrs:{id:"_6-1-set-get"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-set-get"}},[s._v("#")]),s._v(" 6.1 SET/GET")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 我们在 set 的时候，redis 首先会对 key 进行 hash，找到它对应的槽上")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" username hedon\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# username 经过 hash 后需要放在 6375 对应的槽上，所以重定向到 6375 上")]),s._v("\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Redirected to slot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14315")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" located at "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375\nOK\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 因为 username 在 6375 上，当前是 6375，所以在 6375 上可以直接拿")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("5")]),s._v(">")]),s._v(" get username\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hedon"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("5")]),s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" address beijing\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Redirected to slot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3680")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" located at "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371\nOK\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("1")]),s._v(">")]),s._v(" get username\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 因为 username 在 6375 上，当前是 6371，所以需要重定向到 6375 上拿")]),s._v("\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Redirected to slot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14315")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" located at "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hedon"')]),s._v("\n")])])]),a("h3",{attrs:{id:"_6-2-从节点只读模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-从节点只读模式"}},[s._v("#")]),s._v(" 6.2 从节点只读模式")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6372 是一个从节点，所以命令会跳转到它对应的主节点上")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" get username\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Redirected to slot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14315")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" located at "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.202:6375\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zhangsan"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以设置 6372 只读，可以通过 READWRITE 来恢复")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" READONLY  \nOK\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加上只读模式，6372 读取它的主节点 6375 上的数据，就不需要重定向了")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" get username\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"zhangsan"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当时读取集群中不是它的主节点的数据，还是需要重定向，因为 6372 只复制 6375 的数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:637"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),s._v(" get address\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Redirected to slot "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3680")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" located at "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200:6371\n"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"beijing"')]),s._v("\n")])])]),a("h2",{attrs:{id:"_7-集群性能测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-集群性能测试"}},[s._v("#")]),s._v(" 7. 集群性能测试")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("结果")]),s._v(" "),a("p",[s._v("很显然单机的性能肯定是更高的，因为：")]),s._v(" "),a("ol",[a("li",[s._v("集群需要对 key 做哈希运算；")]),s._v(" "),a("li",[s._v("集群在 SET/GET 的时候需要做转发；")])]),s._v(" "),a("p",[s._v("但是，集群的可用性更强，更加容灾。")])]),s._v(" "),a("h3",{attrs:{id:"_7-1-redis-benchmark-命令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-redis-benchmark-命令"}},[s._v("#")]),s._v(" 7.1 redis-benchmark 命令")]),s._v(" "),a("p",[a("code",[s._v("redis-benchmark")]),s._v(" 是一个测试 Redis 性能的工具，Redis 性能测试是通过同时执行多个命令实现的。")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("redis-benchmark "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("option"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("option value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),a("p",[s._v("可选参数：")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("选项")]),s._v(" "),a("th",[s._v("描述")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("-h")]),s._v(" "),a("td",[s._v("指定服务器主机名")])]),s._v(" "),a("tr",[a("td",[s._v("-p")]),s._v(" "),a("td",[s._v("指定服务器端口")])]),s._v(" "),a("tr",[a("td",[s._v("-s")]),s._v(" "),a("td",[s._v("指定服务器（socket 方式）")])]),s._v(" "),a("tr",[a("td",[s._v("-c")]),s._v(" "),a("td",[s._v("指定并发连接数")])]),s._v(" "),a("tr",[a("td",[s._v("-n")]),s._v(" "),a("td",[s._v("指定请求数")])]),s._v(" "),a("tr",[a("td",[s._v("-d")]),s._v(" "),a("td",[s._v("以字节的形式指定 SET/GET 值的数据大小")])]),s._v(" "),a("tr",[a("td",[s._v("-k")]),s._v(" "),a("td",[s._v("连接方式：1=keep alive（长连接）； 0=reconnect")])]),s._v(" "),a("tr",[a("td",[s._v("-r")]),s._v(" "),a("td",[s._v("指定 SET/GET/INCR 使用随机 key")])]),s._v(" "),a("tr",[a("td",[s._v("-P")]),s._v(" "),a("td",[s._v("通过管道传输请求")])]),s._v(" "),a("tr",[a("td",[s._v("-q")]),s._v(" "),a("td",[s._v("强制退出 Redis")])]),s._v(" "),a("tr",[a("td",[s._v("--csv")]),s._v(" "),a("td",[s._v("以  CSV 格式输出")])]),s._v(" "),a("tr",[a("td",[s._v("-l（小写的 L）")]),s._v(" "),a("td",[s._v("生成循环，永久执行测试")])]),s._v(" "),a("tr",[a("td",[s._v("-t")]),s._v(" "),a("td",[s._v("仅运行以逗号分隔的测试命令列表")])]),s._v(" "),a("tr",[a("td",[s._v("-I（大写的 i）")]),s._v(" "),a("td",[s._v("Idle （空闲）模式，仅打开 N 个 Idle 连接并等待")])])])]),s._v(" "),a("h3",{attrs:{id:"_7-2-单机测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-单机测试"}},[s._v("#")]),s._v(" 7.2 单机测试")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("准备单机配置文件 "),a("code",[s._v("redis.conf")])]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /usr/local/redis/conf/redis.conf /usr/local/redis/conf/redis.conf.backup\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /usr/local/redis/conf/redis.conf\n")])])]),a("p",[s._v("内容：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 放行 IP")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 后台启动")]),s._v("\ndaemonize "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 日志存储目录及日志名")]),s._v("\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/redis/log/redis.log"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rdb 数据文件名")]),s._v("\ndbfilename "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dump.rdb"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# aof 模式开启和 aof 数据文件名")]),s._v("\nappendonly "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\nappendfilename "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly.aof"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rdb 数据文件和 aof 数据文件的存储目录")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/redis/data"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置密码")]),s._v("\nrequirepass "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("启动单机 Redis")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果之前有运行单机 Redis，则杀死")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -ef "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" redis\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" -9 PID\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动")]),s._v("\n/usr/local/redis/bin/redis-server /usr/local/redis/conf/redis.conf\n")])])])]),s._v(" "),a("li",[a("p",[s._v("测试")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("/usr/local/redis/bin/redis-benchmark -a "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" -h "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" -t set,get -r "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" -n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" -c "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("结果")]),s._v(" "),a("div",{staticClass:"language-markdown extra-class"},[a("pre",{pre:!0,attrs:{class:"language-markdown"}},[a("code",[a("span",{pre:!0,attrs:{class:"token title important"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" SET 一百万次在 18.9s 内完成，每秒 52912.85 次")]),s._v('\n====== SET ======\n  1000000 requests completed in 18.90 seconds\n  1000 parallel clients\n  3 bytes payload\n  keep alive: 1\n  host configuration "save": \n  host configuration "appendonly": yes\n  multi-thread: no\n\n0.00% <= 3 milliseconds\n...\n100.00% <= 36 milliseconds\n52912.85 requests per second\n\n'),a("span",{pre:!0,attrs:{class:"token title important"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" GET 一百万次在 19.92 内完成，每秒 50210.89 次")]),s._v('\n====== GET ======\n  1000000 requests completed in 19.92 seconds\n  1000 parallel clients\n  3 bytes payload\n  keep alive: 1\n  host configuration "save": \n  host configuration "appendonly": yes\n  multi-thread: no\n\n0.00% <= 2 milliseconds\n...\n100.00% <= 47 milliseconds\n50210.89 requests per second\n')])])])]),s._v(" "),a("li",[a("p",[s._v("总结")]),s._v(" "),a("ul",[a("li",[s._v("SET：一百万次在 18.9s 内完成，每秒 52912.85 次")]),s._v(" "),a("li",[s._v("GET：一百万次在 19.92 内完成，每秒 50210.89 次")])])])]),s._v(" "),a("h3",{attrs:{id:"_7-3-集群测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-集群测试"}},[s._v("#")]),s._v(" 7.3 集群测试")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("随便先一个节点执行")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("/usr/local/redis/bin/redis-benchmark -a "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" -h "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.16")]),s._v(".58.200 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6371")]),s._v(" -t set,get -r "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" -n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" -c "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("结果")]),s._v(" "),a("div",{staticClass:"language-markdown extra-class"},[a("pre",{pre:!0,attrs:{class:"language-markdown"}},[a("code",[a("span",{pre:!0,attrs:{class:"token title important"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" SET 一百万次在 23.58s 内完成，每秒 42399.83 次")]),s._v('\n====== SET ======\n  1000000 requests completed in 23.58 seconds\n  1000 parallel clients\n  3 bytes payload\n  keep alive: 1\n  host configuration "save": \n  host configuration "appendonly": yes\n  multi-thread: no\n\n0.00% <= 3 milliseconds\n....\n100.00% <= 113 milliseconds\n42399.83 requests per second\n\n'),a("span",{pre:!0,attrs:{class:"token title important"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("#")]),s._v(" GET 一百万次在 29.20 内完成，每秒 34241.88 次")]),s._v('\n====== GET ======\n  1000000 requests completed in 29.20 seconds\n  1000 parallel clients\n  3 bytes payload\n  keep alive: 1\n  host configuration "save": \n  host configuration "appendonly": yes\n  multi-thread: no\n\n0.00% <= 3 milliseconds\n...\n100.00% <= 238 milliseconds\n34241.88 requests per second\n')])])])]),s._v(" "),a("li",[a("p",[s._v("总结")]),s._v(" "),a("ul",[a("li",[s._v("SET：一百万次在 23.58s 内完成，每秒 42399.83 次")]),s._v(" "),a("li",[s._v("GET：一百万次在 29.20 内完成，每秒 34241.88 次")])])])]),s._v(" "),a("h2",{attrs:{id:"_8-集群原理总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-集群原理总结"}},[s._v("#")]),s._v(" 8. 集群原理总结")]),s._v(" "),a("h3",{attrs:{id:"_8-1-哈希槽"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-哈希槽"}},[s._v("#")]),s._v(" 8.1 哈希槽")]),s._v(" "),a("p",[s._v("Redis Cluster 并没有选用一致性哈希算法，而是采用了哈希槽（SLOT），主要原因是一致性哈希算法对于数据分布、节点位置的控制并不是很友好，一致性哈希算法不太适合节点数目较少的情景。")]),s._v(" "),a("p",[s._v("哈希槽其实是两个概念：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("哈希算法：Redis Cluster 的哈希算法并不是简单的 hash()，而是 "),a("code",[s._v("CRC16")]),s._v(" 算法，这是一种校验算法；")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("CRC16")]),s._v(" "),a("p",[s._v("所以 CRC，就是循环冗余校验法，可以参考："),a("RouterLink",{attrs:{to:"/cs/cn/cn-link-layer.html#_6-2-循环冗余校验码-crc"}},[s._v("计算机网络丨链路层丨差错检测丨循环冗余校验码")]),s._v("。")],1)])]),s._v(" "),a("li",[a("p",[s._v("槽位的概念：空间分配的规则。")])])]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("对于槽位的转移和分派，Redis Cluster 是不会自动进行的，而是需要人工配置的。所以 Redis Cluster 的高可用是依赖于节点的主从复制与主从间的自动故障转移。")])]),s._v(" "),a("h3",{attrs:{id:"_8-2-16384-个-slot"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-16384-个-slot"}},[s._v("#")]),s._v(" 8.2 16384 个 slot")]),s._v(" "),a("p",[s._v("Redis Cluster 没有单机的那种 16 个数据库（0-15）的概念，而是分成了 16384 个 slot，每个节点负责其中的一部分 slots。")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("为什么 Redis Cluster 会设计成 16384 个槽位呢？")]),s._v(" "),a("p",[s._v("正常的心跳包携带一个节点的完整配置，可以用幂等的方式替换旧的配置，以便更新旧的配置。这意味着它们以原始形式包含节点的槽配置，该节点使用 2k 的空间和 16k 的槽，但使用 65k 的槽将使用 8k 的空间。")]),s._v(" "),a("p",[s._v("同时，由于其他的设计权衡，Redis Cluster 不太可能扩展到超过 1000 个 master 节点。")]),s._v(" "),a("p",[s._v("所以 16k 是在正确的范围内，以确保每个主机有足够的插槽，最大 1000 个master，但足够小的数字传播插槽配置作为一个原始位图容易。注意，在小集群中，位图将很难压缩，因为当 N 很小时，位图将设置槽 N 位，这是设置的位的很大百分比。")]),s._v(" "),a("p",[a("strong",[s._v("1. 如果槽位为 65536，发送心跳信息的消息头达 8k，发送的心跳包过于庞大。")])]),s._v(" "),a("p",[s._v("如上所述，在消息头中，最占空间的是 "),a("code",[s._v("myslots[CLUSTER_SLOTS/8]")]),s._v("。 当槽位为 65536 时，这块的大小是: "),a("code",[s._v("65536÷8÷1024=8kb")]),s._v("。因为每秒钟，Redis 节点需要发送一定数量的 ping 消息作为心跳包，如果槽位为 65536，这个 ping 消息的消息头太大了，浪费带宽。")]),s._v(" "),a("p",[a("strong",[s._v("2. Redis 的集群主节点数量基本不可能超过 1000 个。")])]),s._v(" "),a("p",[s._v("如上所述，集群节点越多，心跳包的消息体内携带的数据越多。如果节点过 1000 个，也会导致网络拥堵。因此 Redis 作者，不建议 Redis Cluster 节点数量超过 1000 个。 那么，对于节点数在 1000 以内的 Redis Cluster 集群，16384 个槽位够用了，没有必要拓展到65536个。")]),s._v(" "),a("p",[a("strong",[s._v("3. 槽位越小，节点少的情况下，压缩率高。")])]),s._v(" "),a("p",[s._v("Redis 主节点的配置信息中，它所负责的哈希槽是通过一张 bitmap 的形式来保存的，在传输过程中，会对 bitmap 进行压缩，但是如果bitmap 的填充率 slots / N 很高的话（N 表示节点数），bitmap 的压缩率就很低。 如果节点数很少，而哈希槽数量很多的话，bitmap 的压缩率就很低。")])]),s._v(" "),a("h3",{attrs:{id:"_8-3-槽位定位算法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-槽位定位算法"}},[s._v("#")]),s._v(" 8.3 槽位定位算法")]),s._v(" "),a("p",[s._v("Redis Cluster 默认会对 key 值使用 CRC16 算法进行 hash 得到一个整数值，然后用这个整数值对 16384 进行取模来得到具体的槽位。")]),s._v(" "),a("p",[s._v("即："),a("code",[s._v("HASH_SLOT = CRC16(key) mod 16384")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gt78koy9i5j31fq0ncgom.jpg",alt:"image-20210806181754810"}})]),s._v(" "),a("h3",{attrs:{id:"_8-4-扩容原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-扩容原理"}},[s._v("#")]),s._v(" 8.4 扩容原理")]),s._v(" "),a("h4",{attrs:{id:"_8-4-1-添加主节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-1-添加主节点"}},[s._v("#")]),s._v(" 8.4.1 添加主节点")]),s._v(" "),a("ol",[a("li",[s._v("准备节点 M4；")]),s._v(" "),a("li",[s._v("启动节点 M4；")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("add-node")]),s._v(" 将节点加入到集群当中；")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("reshard")]),s._v(" 对集群重新分配，给 M4 分配槽；")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gtbhrzpg7lj30l40k00tq.jpg",alt:"image-20210810103452785"}}),s._v(" "),a("h4",{attrs:{id:"_8-4-2-添加从节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-2-添加从节点"}},[s._v("#")]),s._v(" 8.4.2 添加从节点")]),s._v(" "),a("ol",[a("li",[s._v("准备节点 S4；")]),s._v(" "),a("li",[s._v("启动节点 S4；")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("add-node")]),s._v(" 将节点加入到集群当中，并用 "),a("code",[s._v("--cluater-salve")]),s._v(" 声明该节点为从节点，且使用 "),a("code",[s._v("--cluster-master-id")]),s._v(" 指定主节点 ID；")])]),s._v(" "),a("h3",{attrs:{id:"_8-5-缩容原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-缩容原理"}},[s._v("#")]),s._v(" 8.5 缩容原理")]),s._v(" "),a("h4",{attrs:{id:"_8-5-1-删除从节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-1-删除从节点"}},[s._v("#")]),s._v(" 8.5.1 删除从节点")]),s._v(" "),a("ol",[a("li",[s._v("使用 "),a("code",[s._v("del-node")]),s._v(" 将节点从集群中移除；")]),s._v(" "),a("li",[s._v("使用 kill 或 SHUTDOWN 停止节点进程。")])]),s._v(" "),a("h4",{attrs:{id:"_8-5-2-删除主节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-2-删除主节点"}},[s._v("#")]),s._v(" 8.5.2 删除主节点")]),s._v(" "),a("p",[s._v("删除主节点稍微麻烦一点，因为主节点分配了槽，所以必须先把槽分配给其他可用节点后，才可以移除节点，不然会造成数据丢失。")]),s._v(" "),a("ol",[a("li",[s._v("使用 "),a("code",[s._v("reshard")]),s._v(" 将要删除的主节点 M4 的槽分配给其他节点；")]),s._v(" "),a("li",[s._v("使用 "),a("code",[s._v("del-node")]),s._v(" 将 M4 从集群中移除；")]),s._v(" "),a("li",[s._v("停止 M4 进程。")])]),s._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNly1gtbhthuzsej30mw0k8jsg.jpg",alt:"image-20210810103747994"}}),s._v(" "),a("Vssue")],1)}),[],!1,null,null,null);t.default=n.exports}}]);