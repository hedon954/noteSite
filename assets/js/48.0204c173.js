(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{460:function(t,s,a){"use strict";a.r(s);var n=a(47),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_16-内存模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-内存模型"}},[t._v("#")]),t._v(" 16. 内存模型")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5ufk0o0yuj21ez0u076f.jpg",alt:"image-20220904114448954"}})]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("总结")]),t._v(" "),a("p",[t._v("内存结构：")]),t._v(" "),a("ul",[a("li",[t._v("Go 将堆内存抽象为 "),a("strong",[t._v("mheap")]),t._v(" 结构体；")]),t._v(" "),a("li",[t._v("Go 进程会从虚拟内存中申请 n 个 "),a("strong",[t._v("heapArena")]),t._v("；")]),t._v(" "),a("li",[t._v("每个 heapArena 被按需划分成不同 class 的 "),a("strong",[t._v("mspan")]),t._v("，class 有 68 个等级；")]),t._v(" "),a("li",[t._v("每个 mspan 由 n 个相同大小的 span 组成；")]),t._v(" "),a("li",[t._v("为了快速寻找到对应 span，为 mheap 建立了 136 个中央索引 "),a("strong",[t._v("mcentral")]),t._v("；")]),t._v(" "),a("li",[t._v("每个 mcentral 存储每种 class 的 mspan，每种 mspan 又划分为 gc scan 和 no scan 两种，故共有 68 × 2 = 136 个 mcentral；")]),t._v(" "),a("li",[t._v("为了解决中央索引在并发性的锁竞争问题，为每一个 p（thread）建立一个本地缓存 "),a("strong",[t._v("mcache")]),t._v("；")]),t._v(" "),a("li",[t._v("每个 mcache 存储 128 个 span，分别是每种 class 的 mspan 的一个 scan 和 noscan 的 span；")])]),t._v(" "),a("p",[t._v("内存分配：")]),t._v(" "),a("ul",[a("li",[t._v("Go 中将根据对象大小分为 tiny、small 和 large 三种对象；")]),t._v(" "),a("li",[t._v("tiny 和 small 对象会被分配到 class1 ~ class67 的 span 中；")]),t._v(" "),a("li",[t._v("large 对象会量身定做分配到 class0 的 span 中，直接从 mheap 上申请；")]),t._v(" "),a("li",[t._v("为对象分配内存时，会先从 mcache 上找 span，找不到就去 mcentral 上交换，还找不到，就去 mheap 上申请，还找不到，就 OOM。")])])]),t._v(" "),a("h2",{attrs:{id:"_16-1-协程栈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-协程栈"}},[t._v("#")]),t._v(" 16.1 协程栈")]),t._v(" "),a("h3",{attrs:{id:"_16-1-1-作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-1-作用"}},[t._v("#")]),t._v(" 16.1.1 作用")]),t._v(" "),a("ul",[a("li",[t._v("记录协程的执行路径")]),t._v(" "),a("li",[t._v("记录局部变量")]),t._v(" "),a("li",[t._v("函数传参")]),t._v(" "),a("li",[t._v("函数返回值")])]),t._v(" "),a("h3",{attrs:{id:"_16-1-2-位置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-2-位置"}},[t._v("#")]),t._v(" 16.1.2 位置")]),t._v(" "),a("ul",[a("li",[t._v("Go 协程栈位于 Go 堆内存上")]),t._v(" "),a("li",[t._v("Go 堆内存位于操作系统虚拟内存上")])]),t._v(" "),a("h3",{attrs:{id:"_16-1-3-图解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-3-图解"}},[t._v("#")]),t._v(" 16.1.3 图解")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n  sum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" b\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" sum\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n  b "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5ti4vk965j21i70u0gow.jpg",alt:"image-20220903163506814"}})]),t._v(" "),a("h3",{attrs:{id:"_16-1-4-参数传递"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-4-参数传递"}},[t._v("#")]),t._v(" 16.1.4 参数传递")]),t._v(" "),a("ul",[a("li",[t._v("Go 是值传递")]),t._v(" "),a("li",[t._v("传递结构体时：会拷贝结构体中的全部内容")]),t._v(" "),a("li",[t._v("传递结构体指针时：会拷贝结构体指针")])]),t._v(" "),a("h3",{attrs:{id:"_16-1-5-栈大小"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-5-栈大小"}},[t._v("#")]),t._v(" 16.1.5 栈大小")]),t._v(" "),a("p",[t._v("默认 2KB")]),t._v(" "),a("h3",{attrs:{id:"_16-1-6-逃逸分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-6-逃逸分析"}},[t._v("#")]),t._v(" 16.1.6 逃逸分析")]),t._v(" "),a("p",[t._v("不是所有的变量都能放在协程栈上，例如栈帧回收后需要继续使用的变量和太大的变量，都会逃逸到 "),a("strong",[t._v("堆")]),t._v(" 上。")]),t._v(" "),a("p",[t._v("具体有三种逃逸：")]),t._v(" "),a("ul",[a("li",[t._v("指针逃逸：函数返回对象的指针")]),t._v(" "),a("li",[t._v("空接口逃逸：函数参数为 interface{}，那么函数的实参很可能会逃逸，因为底层很可能会用到反射")]),t._v(" "),a("li",[t._v("大变量逃逸：变量太大，栈帧放不下，就逃逸到堆上了。64 位机器中，一般超过 64KB 的变量就会逃逸")])]),t._v(" "),a("h3",{attrs:{id:"_16-1-7-栈扩容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-1-7-栈扩容"}},[t._v("#")]),t._v(" 16.1.7 栈扩容")]),t._v(" "),a("p",[t._v("Go 栈的初始空间为 2KB。在函数调用前会执行 "),a("code",[t._v("morestack")]),t._v(" 判断栈空间是否足够，如果不够，就需要对栈进行扩容。")]),t._v(" "),a("ul",[a("li",[t._v("分段栈：Go1.13 之前\n"),a("ul",[a("li",[t._v("没有空间浪费，但是栈帧会在不连续的空间之间横跳，性能较差。")])])]),t._v(" "),a("li",[t._v("连续栈：Go1.13 及之后\n"),a("ul",[a("li",[t._v("开辟一整块新的大栈，然后把老的拷贝过来，保证了空间一直连续。但是伸缩时的开销较大。")])])])]),t._v(" "),a("h2",{attrs:{id:"_16-2-虚拟内存单元-heaparena"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-2-虚拟内存单元-heaparena"}},[t._v("#")]),t._v(" 16.2 虚拟内存单元 heapArena")]),t._v(" "),a("h3",{attrs:{id:"_16-2-1-概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-2-1-概述"}},[t._v("#")]),t._v(" 16.2.1 概述")]),t._v(" "),a("ul",[a("li",[t._v("物理内存为 64G 的机器中，每个 Go 进程可以会被分配到 256TB 的虚拟内存。")]),t._v(" "),a("li",[t._v("Go 的虚拟内存单元为 "),a("code",[t._v("heapArena")]),t._v("，每次申请 64M。")]),t._v(" "),a("li",[t._v("最多可以申请 2"),a("sup",[t._v("20")]),t._v(" 个。")]),t._v(" "),a("li",[t._v("所有的 "),a("code",[t._v("heapArena")]),t._v(" 组成了 "),a("code",[t._v("mheap")]),t._v("（Go 堆内存）")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5udzzl461j21ia0ekdhw.jpg",alt:"image-20220904105731381"}})]),t._v(" "),a("blockquote",[a("p",[t._v("PS："),a("a",{attrs:{href:"https://hedon954.github.io/noteSite/cs/os/04-os-store.html#_6-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98",target:"_blank",rel:"noopener noreferrer"}},[t._v("操作系统 - 虚拟内存"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"_16-2-2-底层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-2-2-底层"}},[t._v("#")]),t._v(" 16.2.2 底层")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" heapArena "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   bitmap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("heapArenaBitmapBytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),t._v("\n   spans "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pagesPerArena"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan\t\t\t\t  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// heapArena 会被分成很多个 mspan")]),t._v("\n   pageInUse "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pagesPerArena "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint8")]),t._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 哪些页正在被使用中")]),t._v("\n   pageMarks "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pagesPerArena "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint8")]),t._v("\n   pageSpecials "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pagesPerArena "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint8")]),t._v("\n   checkmarks "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("checkmarksMap\n   zeroedBase "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_16-2-3-分配策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-2-3-分配策略"}},[t._v("#")]),t._v(" 16.2.3 分配策略")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("线性分配")]),t._v(" "),a("th",[t._v("链表分配")]),t._v(" "),a("th",[t._v("分级分配")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[a("img",{staticStyle:{zoom:"33%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5uebsvbasj21ei0ne76j.jpg",alt:"image-20220904110854548"}})]),t._v(" "),a("td",[a("img",{staticStyle:{zoom:"33%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5ueba2f53j21fi0n641m.jpg",alt:"image-20220904110824878"}})]),t._v(" "),a("td",[a("img",{staticStyle:{zoom:"33%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5uedvcmcdj21dw0mm79w.jpg",alt:"image-20220904111053653"}})])]),t._v(" "),a("tr",[a("td",[t._v("实现简单，但内存碎片较多。")]),t._v(" "),a("td",[t._v("将空闲块连接起来，牺牲了一部分性能，来能缓解一部分的内存碎片。")]),t._v(" "),a("td",[t._v("将 heapArena 按级别分成很多个块，根据对象大小存放在能容纳它的最小的块中。")])]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td"),t._v(" "),a("td",[t._v("Go 参考了分级分配策略，将每一个级定义为 "),a("code",[t._v("mspan")]),t._v("，"),a("code",[t._v("mspan")]),t._v(" 为 N 个相同大小 "),a("code",[t._v("span")]),t._v(" 组成")])])])]),t._v(" "),a("blockquote",[a("p",[t._v("PS：分级分配参考了 "),a("a",{attrs:{href:"http://goog-perftools.sourceforge.net/doc/tcmalloc.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("TCMalloc"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"_16-3-内存管理单元-mspan"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-3-内存管理单元-mspan"}},[t._v("#")]),t._v(" 16.3 内存管理单元 mspan")]),t._v(" "),a("h3",{attrs:{id:"_16-3-1-概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-3-1-概述"}},[t._v("#")]),t._v(" 16.3.1 概述")]),t._v(" "),a("ul",[a("li",[t._v("Go 使用内存时的最小单位是 "),a("code",[t._v("mspan")]),t._v("。")]),t._v(" "),a("li",[t._v("每个 "),a("code",[t._v("mspan")]),t._v(" 为 N 个相同大小的 "),a("code",[t._v("span")]),t._v(" 组成。")]),t._v(" "),a("li",[t._v("Go 中一个有 "),a("code",[t._v("67")]),t._v(" 种 "),a("code",[t._v("mspan")]),t._v("。")])]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// runtime/sizeclasses.go")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// class  bytes/obj  bytes/span  objects  tail waste  max waste")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     1          8        8192     1024           0     87.50%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     2         16        8192      512           0     43.75%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     3         24        8192      341           8     29.24%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//                                ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    62      20480       40960        2           0      6.87%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    63      21760       65536        3         256      6.25%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    64      24576       24576        1           0     11.45%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    65      27264       81920        3         128     10.00%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    66      28672       57344        2           0      4.91%")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    67      32768       32768        1           0     12.50%")]),t._v("\n")])])]),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5uemrzou7j217a0kwadr.jpg",alt:"image-20220904111927956"}})]),t._v(" "),a("h3",{attrs:{id:"_16-3-2-底层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-3-2-底层"}},[t._v("#")]),t._v(" 16.3.2 底层")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" mspan "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   next "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan     \t\t\t\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 下一个 span\t")]),t._v("\n   prev "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan     \t\t\t\t\t\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 上一个 span")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n   spanclass   spanClass     \t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 级别")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"_16-4-中心索引-mcentral"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-4-中心索引-mcentral"}},[t._v("#")]),t._v(" 16.4 中心索引 mcentral")]),t._v(" "),a("h3",{attrs:{id:"_16-4-1-概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-4-1-概述"}},[t._v("#")]),t._v(" 16.4.1 概述")]),t._v(" "),a("p",[t._v("heapArena 中的 mspan 不是一开始就全部划分好的，而且按需划分。")]),t._v(" "),a("p",[t._v("由于每个 heapArena 中的 mspan 都是不确定的，为了给要分配空间的对象快速定位到合适的 mspan，Go 中定义了中心索引 "),a("code",[t._v("mcentral")]),t._v("。")]),t._v(" "),a("p",[t._v("总共有 "),a("code",[t._v("136")]),t._v(" 个 "),a("code",[t._v("mcentral")]),t._v(" 结构体，其中 "),a("code",[t._v("68")]),t._v(" 个需要 gc 扫描的 mspan，"),a("code",[t._v("68")]),t._v(" 个不需要 gc 的 mspan。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5uf0kf27jj21iw0rg0xy.jpg",alt:"image-20220904113242511"}})]),t._v(" "),a("h3",{attrs:{id:"_16-4-2-底层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-4-2-底层"}},[t._v("#")]),t._v(" 16.4.2 底层")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" mcentral "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   spanclass spanClass\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// class 级别")]),t._v("\n   partial "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("spanSet \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 未满的 span")]),t._v("\n   full    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("spanSet \t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 满的 span")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"_16-5-线程缓存-mcache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-5-线程缓存-mcache"}},[t._v("#")]),t._v(" 16.5 线程缓存 mcache")]),t._v(" "),a("h3",{attrs:{id:"_16-5-1-概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-5-1-概述"}},[t._v("#")]),t._v(" 16.5.1 概述")]),t._v(" "),a("p",[a("code",[t._v("mcentral")]),t._v(" 实际是一个中心索引，修改它需要使用互斥锁进行保护，锁冲突会造成性能问题。Go 参考 GMP 模型，增加线程本地缓存。给每一个线程做了一个二级缓存 "),a("code",[t._v("mcache")]),t._v("，极大缓解了并发锁争夺的性能消耗。")]),t._v(" "),a("ul",[a("li",[t._v("每个 "),a("code",[t._v("P")]),t._v(" 有一个 "),a("code",[t._v("mcahce")]),t._v("。")]),t._v(" "),a("li",[t._v("对于每一种 class 的 mcentral，取一个 scan 和一个 noscan，这样一个 "),a("code",[t._v("mcache")]),t._v(" 拥有 "),a("code",[t._v("136")]),t._v(" 个 "),a("code",[t._v("mspan")]),t._v("。其中 68 个需要 GC 扫描，68 个不需要。")]),t._v(" "),a("li",[t._v("当本地索引用完了之后，就上锁，去中央索引进行交换。")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5ufd5lnvxj21ez0u0n3h.jpg",alt:"image-20220904114448954"}})]),t._v(" "),a("h3",{attrs:{id:"_16-5-2-底层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-5-2-底层"}},[t._v("#")]),t._v(" 16.5.2 底层")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" mcache "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   nextSample "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),t._v(" \n   scanAlloc  "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),t._v(" \n   tiny       "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),t._v("\n   tinyoffset "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),t._v("\n   tinyAllocs "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),t._v("\n   alloc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("numSpanClasses"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 136 个 msapn")]),t._v("\n   stackcache "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("_NumStackOrders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("stackfreelist\n   flushGen "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint32")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" p "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n   mcache      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mcache\n\t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"_16-6-堆-mheap"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-6-堆-mheap"}},[t._v("#")]),t._v(" 16.6 堆 mheap")]),t._v(" "),a("p",[t._v("最后，我们来看看 Go 中对堆内存的抽象结构：mheap")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" mheap "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 锁")]),t._v("\n\tlock      mutex\n  \n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mspan 是按需分级的，这里保存了所有一个划分好的 mspan")]),t._v("\n\tallspans "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan \n  \n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mheap 被划分为多个 heapArena")]),t._v("\n\tarenas "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" arenaL1Bits"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" arenaL2Bits"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("heapArena\n\n\t "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 中心索引 ")]),t._v("\n\tcentral "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("numSpanClasses"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tmcentral mcentral\n\t\tpad      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("cpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CacheLinePadSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v("cpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CacheLinePadSize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  \n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 其他省略")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"_16-7-内存分配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-内存分配"}},[t._v("#")]),t._v(" 16.7 内存分配")]),t._v(" "),a("h3",{attrs:{id:"_16-7-1-对象分级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-1-对象分级"}},[t._v("#")]),t._v(" 16.7.1 对象分级")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Tiny（0 ~ 16B）")]),t._v(" ：微对象，无指针")]),t._v(" "),a("li",[a("code",[t._v("Small（16B~32KB）")]),t._v("：小对象")]),t._v(" "),a("li",[a("code",[t._v("Large（32KB，+∞）")]),t._v("：大对象")])]),t._v(" "),a("p",[a("code",[t._v("Tiny")]),t._v(" 和 "),a("code",[t._v("Small")]),t._v(" 会被分配到普通的 mspan（class1 ~ class67）")]),t._v(" "),a("p",[a("code",[t._v("Large")]),t._v(" 会被分配到量身定做的 mspan（class0）")]),t._v(" "),a("h3",{attrs:{id:"_16-7-2-微对象分配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-2-微对象分配"}},[t._v("#")]),t._v(" 16.7.2 微对象分配")]),t._v(" "),a("ol",[a("li",[t._v("从 mcache 拿到 mspan-class2；")]),t._v(" "),a("li",[t._v("将多个 "),a("code",[t._v("tiny")]),t._v(" 合并成一个 16Bytes 存入；")]),t._v(" "),a("li",[t._v("如果 mcache 中没有空闲的 span，那就去 mcentral 兑换新的 span；")]),t._v(" "),a("li",[t._v("如果 mcentral 中还没，那就去 mheap 上申请；")])]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/e6c9d24egy1h5ulg364i2j21nk09uq4s.jpg",alt:"image-20220904151512726"}}),t._v(" "),a("h3",{attrs:{id:"_16-7-3-小对象分配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-3-小对象分配"}},[t._v("#")]),t._v(" 16.7.3 小对象分配")]),t._v(" "),a("ol",[a("li",[t._v("根据对象大小确定 mspan 的 class；")]),t._v(" "),a("li",[t._v("在 mcache 中寻找对应 class 的 span 进行分配；")]),t._v(" "),a("li",[t._v("如果 mcache 中没有空闲的 span，那就去 mcentral 兑换新的 span；")]),t._v(" "),a("li",[t._v("如果 mcentral 中还没，那就去 mheap 上申请；")])]),t._v(" "),a("h3",{attrs:{id:"_16-7-4-大对象分配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-4-大对象分配"}},[t._v("#")]),t._v(" 16.7.4 大对象分配")]),t._v(" "),a("p",[t._v("量身定做 class0，直接从 mheap 上申请内存。")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// allocLarge allocates a span for a large object.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mcache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("allocLarge")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" needzero "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" noscan "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 检查 OOM，对象太大了顶不住 ")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("_PageSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" size "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"out of memory"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 检查大对象需要多少 page")]),t._v("\n\t npages "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" _PageShift\n\t "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("_PageMask "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t npages"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("\n\t "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 大对象统一分配到 class0")]),t._v("\n   spc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("makeSpanClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" noscan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 直接从 mheap 中申请 class0 的 span")]),t._v("\n   s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alloc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("npages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" needzero"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 5. 申请完了之后，再将该 span 的索引建立到 mcentral 上，方便 gc 扫描")]),t._v("\n   mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("central"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fullSwept")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sweepgen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("limit "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" size\n   "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("heapBitsForAddr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_16-7-5-mcache-替换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-5-mcache-替换"}},[t._v("#")]),t._v(" 16.7.5 mcache 替换")]),t._v(" "),a("ul",[a("li",[t._v("在 mcache 中，每个 class 的 mspan 只有一个，当 mspan 满了之后，会从 mcentral 中兑换一个新的。")])]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mcache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextFree")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("spc spanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v gclinkptr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" shouldhelpgc "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\ts "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\tshouldhelpgc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\tfreeIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextFreeIndex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" freeIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("nelems "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// mcache 中的 span 满了，要去 mcentral 中兑换一个新的")]),t._v("\n\t\tc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("refill")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\tshouldhelpgc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\t\ts "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n\t\tfreeIndex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextFreeIndex")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mcache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("refill")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("spc spanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 将当前 mcache 中的 span 释放回 mcentral")]),t._v("\n   s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("emptymspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sweepgen "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sweepgen"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("throw")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bad sweepgen in refill"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("central"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uncacheSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 从 mcentral 中获得一个新的 span")]),t._v("\n   s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("central"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cacheSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_16-7-6-mcentral-扩容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-6-mcentral-扩容"}},[t._v("#")]),t._v(" 16.7.6 mcentral 扩容")]),t._v(" "),a("ul",[a("li",[t._v("mcentral 中，只有有限数量的 mspan，当 mspan 缺少时，会像 mheap 中开辟新的 heapArena，并申请对应 class 的 span。")])]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Allocate a span to use in an mcache.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cacheSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. mcache 想从 mcentral 中兑换新的span，")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 发现 mcentral 已经没有可用的 span 了")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 那就只能开辟新的 heapArena，并申请对应 class 的 span 了")]),t._v("\n   s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// grow allocates a new empty span from the heap and initializes it for c's size class.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mcentral"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   npages "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("class_to_allocnpages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("spanclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sizeclass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("class_to_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("spanclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sizeclass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t \n   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在 mheap 中分配新的 heapArena 和申请对应 class 的 span")]),t._v("\n   s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" mheap_"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alloc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("npages"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("spanclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("npages "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" _PageShift"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("divShift "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("divMul"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("divShift2\n   s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("limit "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("n\n   "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("heapBitsForAddr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("initSpan")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" s\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_16-7-7-mallocgc-源码分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_16-7-7-mallocgc-源码分析"}},[t._v("#")]),t._v(" 16.7.7 mallocgc 源码分析")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mallocgc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" typ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" needzero "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Pointer "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n\t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" span "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("mspan\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" x unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Pointer\n   noscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" typ "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" typ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ptrdata "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n  \n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" maxSmallSize "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ① tiny 微对象")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" noscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" maxTinySize "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 合并多个微对象，尽可能到 16B")]),t._v("\n         off "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tinyoffset\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            off "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alignUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PtrSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            off "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alignUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            off "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alignUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            off "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alignUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" off"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" maxTinySize "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tiny "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tiny "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" off"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tinyoffset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" off "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" size\n            c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tinyAllocs"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("\n            mp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mallocing "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("releasem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 在 mcache 中找到分配给当前线程的 span")]),t._v("\n         span "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("tinySpanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 尝试获取 mcache 中的 span")]),t._v("\n         v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextFreeFast")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 如果 mcache 中对应 class 的 span 已经被分配了")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     就去中央索引中交换空闲的 span")]),t._v("\n            v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" shouldhelpgc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextFree")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tinySpanClass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 5. 分配内存")]),t._v("\n         x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint64")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tinyoffset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tiny "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tiny "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tinyoffset "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" size\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" maxTinySize\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ② small 小对象")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" sizeclass "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("uint8")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 根据对象大小去查表，找到对应 class 的级别")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" smallSizeMax"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            sizeclass "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" size_to_class8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("divRoundUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" smallSizeDiv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            sizeclass "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" size_to_class128"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("divRoundUp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("smallSizeMax"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" largeSizeDiv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("uintptr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("class_to_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("sizeclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 确定 mspan 的 class")]),t._v("\n         spc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("makeSpanClass")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sizeclass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" noscan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 在 mcache 中找到分配给当前线程的 span")]),t._v("\n         span "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("alloc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 尝试获取 mcache 中的 span")]),t._v("\n         v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextFreeFast")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 5. 如果 mcache 中对应 class 的 span 已经被分配了")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 就去中央索引换空闲的 span 来分配")]),t._v("\n            v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" shouldhelpgc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nextFree")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("spc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 6. 分配内存")]),t._v("\n         x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" needzero "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("needzero "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("memclrNoHeapPointers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ③ large 大对象")]),t._v("\n      shouldhelpgc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 针对大对象量身定制一个 class0 的 span")]),t._v("\n      span "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("allocLarge")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" needzero"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" noscan"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("freeindex "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n      span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("allocCount "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n      x "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pointer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      size "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" span"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elemsize\n   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" x\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("Vssue")],1)}),[],!1,null,null,null);s.default=e.exports}}]);