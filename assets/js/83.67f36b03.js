(window.webpackJsonp=window.webpackJsonp||[]).push([[83],{497:function(s,t,a){"use strict";a.r(t);var n=a(47),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"七、mongodb-数据分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、mongodb-数据分片"}},[s._v("#")]),s._v(" 七、MongoDB 数据分片")]),s._v(" "),a("h2",{attrs:{id:"_1-分片目标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-分片目标"}},[s._v("#")]),s._v(" 1. 分片目标")]),s._v(" "),a("ul",[a("li",[s._v("缓解单机压力，解决数据量过大引起的 IO 性能下降问题；")]),s._v(" "),a("li",[s._v("增加可扩展性；")])]),s._v(" "),a("h2",{attrs:{id:"_2-分区方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-分区方式"}},[s._v("#")]),s._v(" 2. 分区方式")]),s._v(" "),a("p",[s._v("数据分区是一种将数据分割到多个独立数据存储中的机制，以此来减少每个索引的大小和更新记录所需的 IO 访问量。")]),s._v(" "),a("h3",{attrs:{id:"_2-1-垂直分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-垂直分区"}},[s._v("#")]),s._v(" 2.1 垂直分区")]),s._v(" "),a("p",[s._v("在数据库的传统视图中，数据以行和列的方式存储。垂直分区的实现为：拆分列边界上的记录，并将各个部分存储在不同的表或集合中。可以认为，关系数据库通过按照一对一关系使用连接表构成的是本地垂直数据分区。")]),s._v(" "),a("p",[s._v("不过，MongoDB 并未使用这种形式的分区，因为它的记录结构（文档）并不适合整洁的行列模型。因此，几乎很难根据列边界将行清楚地分开。MongoDB 还采用了嵌入式文档，它并未直接提供在服务器上连接关联集合的能力。")]),s._v(" "),a("h3",{attrs:{id:"_2-2-水平分区"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-水平分区"}},[s._v("#")]),s._v(" 2.2 水平分区")]),s._v(" "),a("p",[s._v("使用 MongoDB 时，水平分区是唯一可采用的方式，而分片就是各种流行水平分区的通用术语。通过分片，可将集合分割到多个服务器，从而改善包含大量文档的集合的性能。")]),s._v(" "),a("p",[s._v("MongoDB 使用一种唯一的方法用于分片，由 MongoS 路径进程管理数据的分割，并将请求路由到必需的分片服务器。如果查询需要访问多个分片中的数据，MongoS 将管理从多个分片获取数据并将数据合并成单个游标的过程。")]),s._v(" "),a("h2",{attrs:{id:"_3-分片需求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-分片需求"}},[s._v("#")]),s._v(" 3. 分片需求")]),s._v(" "),a("img",{staticStyle:{zoom:"43%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNgy1gx5kwy9f3pj30no0j2jru.jpg",alt:"image-20211207211503186"}}),s._v(" "),a("ol",[a("li",[s._v("数据均匀分散；")]),s._v(" "),a("li",[s._v("具有容错性，某个分片出问题了没关系；")]),s._v(" "),a("li",[s._v("可以在系统运行时添加或删除分片；")])]),s._v(" "),a("h2",{attrs:{id:"_4-分片架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-分片架构"}},[s._v("#")]),s._v(" 4. 分片架构")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNgy1gx5lgopvxhj316i0o4jtx.jpg",alt:"image-20211207213403354"}})]),s._v(" "),a("h3",{attrs:{id:"_4-1-主分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-主分片"}},[s._v("#")]),s._v(" 4.1 主分片")]),s._v(" "),a("ul",[a("li",[s._v("集群中的每个数据库都会选择一个分片作为主分片；")]),s._v(" "),a("li",[s._v("主分片存储所有不需要分片的集合；")]),s._v(" "),a("li",[s._v("创建数据库时，数据最少的分片需要被选为主分片；")])]),s._v(" "),a("h3",{attrs:{id:"_4-2-mongos-分片控制器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-mongos-分片控制器"}},[s._v("#")]),s._v(" 4.2 mongos 分片控制器")]),s._v(" "),a("ul",[a("li",[s._v("负责管理应用发送到 MongoDB 服务器的所有命令；")]),s._v(" "),a("li",[s._v("聚合多个分片的查询结果；")])]),s._v(" "),a("h3",{attrs:{id:"_4-3-mongod-配置服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-mongod-配置服务器"}},[s._v("#")]),s._v(" 4.3 mongod 配置服务器")]),s._v(" "),a("ul",[a("li",[s._v("存储分片服务器的配置及信息；")]),s._v(" "),a("li",[s._v("存储各分片数据段列表和数据段范围；")]),s._v(" "),a("li",[s._v("存储集群的认证和授权配置；")]),s._v(" "),a("li",[s._v("不同的集群不要共用配置服务器；")]),s._v(" "),a("li",[s._v("主节点故障时，配置服务器进入只读模式，该模式下，数据段分裂和集群平衡都不可执行；")]),s._v(" "),a("li",[s._v("整个复制集故障时，分片集群不可用；")])]),s._v(" "),a("h2",{attrs:{id:"_5-分片片键"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-分片片键"}},[s._v("#")]),s._v(" 5. 分片片键")]),s._v(" "),a("ul",[a("li",[s._v("区间划分")]),s._v(" "),a("li",[s._v("哈希片键")]),s._v(" "),a("li",[s._v("复合片键")]),s._v(" "),a("li",[s._v("标签分片")])]),s._v(" "),a("h2",{attrs:{id:"_6-分片搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-分片搭建"}},[s._v("#")]),s._v(" 6. 分片搭建")]),s._v(" "),a("blockquote",[a("p",[s._v("Docker")])]),s._v(" "),a("h3",{attrs:{id:"_6-1-服务器实例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-服务器实例"}},[s._v("#")]),s._v(" 6.1 服务器实例")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("服务")]),s._v(" "),a("th",[s._v("守护进程")]),s._v(" "),a("th",[s._v("镜像")]),s._v(" "),a("th",[s._v("端口")]),s._v(" "),a("th",[s._v("数据库路径")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("分片控制器")]),s._v(" "),a("td",[s._v("mongos")]),s._v(" "),a("td",[s._v("mongo:4")]),s._v(" "),a("td",[s._v("27021")]),s._v(" "),a("td")]),s._v(" "),a("tr",[a("td",[s._v("配置服务器")]),s._v(" "),a("td",[s._v("mongod")]),s._v(" "),a("td",[s._v("mongo:4")]),s._v(" "),a("td",[s._v("27022")]),s._v(" "),a("td",[s._v("$HOME/mymongo/data27022:/data/db")])]),s._v(" "),a("tr",[a("td",[s._v("分片 0")]),s._v(" "),a("td",[s._v("mongod")]),s._v(" "),a("td",[s._v("mongo:4")]),s._v(" "),a("td",[s._v("27023")]),s._v(" "),a("td",[s._v("$HOME/mymongo/data27023:/data/db")])]),s._v(" "),a("tr",[a("td",[s._v("分片 1")]),s._v(" "),a("td",[s._v("mongod")]),s._v(" "),a("td",[s._v("mongo:4")]),s._v(" "),a("td",[s._v("27024")]),s._v(" "),a("td",[s._v("$HOME/mymongo/data27024:/data/db")])])])]),s._v(" "),a("h3",{attrs:{id:"_6-2-创建-docker-network"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-创建-docker-network"}},[s._v("#")]),s._v(" 6.2 创建 docker network")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker network create sharding-network\n")])])]),a("h3",{attrs:{id:"_6-3-创建配置服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-创建配置服务器"}},[s._v("#")]),s._v(" 6.3 创建配置服务器")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("启动一个 mongod 进程，用作配置服务器")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker run --net sharding-network --name mongo27022 -v "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/mymongo/data27022:/data/db -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27022")]),s._v(":27017 -d mongo:4 --configsvr --replSet configSet --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v("\n")])])]),a("ul",[a("li",[a("code",[s._v("--net")]),s._v(": 指定 Docker 网络，这样组成分片集群的不同容器才可以进行连接")]),s._v(" "),a("li",[a("code",[s._v("--name")]),s._v(": 指定容器名称")]),s._v(" "),a("li",[a("code",[s._v("--v")]),s._v(": 数据挂载")]),s._v(" "),a("li",[a("code",[s._v("-p")]),s._v(": 端口映射")]),s._v(" "),a("li",[a("code",[s._v("-d")]),s._v(": 后台运行")]),s._v(" "),a("li",[a("code",[s._v("--configsvr")]),s._v(": 指定作为配置服务器")]),s._v(" "),a("li",[a("code",[s._v("--replSet")]),s._v(": 指定复制集，这里配置服务器我们用复制集")]),s._v(" "),a("li",[a("code",[s._v("--port")]),s._v(": 指定 mongod 启动的端口")])])]),s._v(" "),a("li",[a("p",[s._v("因为这是一个复制集，所以我们需要初始化它，先进入 mongo27022")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mongo27022 mongo\n")])])])]),s._v(" "),a("li",[a("p",[s._v("初始化复制集，运行")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("rs.initiate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"info2"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"no configuration specified. Using a default configuration for the set"')]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"me"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0644ee04a016:27017"')]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$gleStats")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lastOpTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638934296")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"electionId"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"000000000000000000000000"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lastCommittedOpTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"_6-4-创建分片控制器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-创建分片控制器"}},[s._v("#")]),s._v(" 6.4 创建分片控制器")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("这里我们再运行一个 MongoDB 进程，我们需要这里需要加两个端口映射，因为我们需要在该容器里面运行 mongos 进程，它也需要监听一个端口 27021")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker run --net sharding-network --name mongo27021 -v "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/mymongo/data27021:/data/db -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v(":27017 -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27021")]),s._v(":27021 -d mongo:4 --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("进入该容器")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mongo27021 /bin/bash\n")])])])]),s._v(" "),a("li",[a("p",[s._v("启动 mongos")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("mongos --configdb configSet/mongo27022:27017 --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27021")]),s._v(" --bind_ip_all\n")])])]),a("p",[a("code",[s._v("--config")]),s._v(": 指定配置服务器："),a("code",[s._v("<config replset name>/<host1:port>,<host2:port>,[...]")])]),s._v(" "),a("p",[a("code",[s._v("--bind_ip_all")]),s._v(": 允许所有 IP 访问，这样后面才能在主机上连接该 mongos 进程")])])]),s._v(" "),a("h3",{attrs:{id:"_6-5-创建两个分片"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-创建两个分片"}},[s._v("#")]),s._v(" 6.5 创建两个分片")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("创建两个分片，启动新的 mongodb")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker run --net sharding-network --name mongo27023 -v "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/mymongo/data27023:/data/db -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27023")]),s._v(":27017 -d mongo:4 --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v(" --shardsvr\n")])])]),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker run --net sharding-network --name mongo27024 -v "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/mymongo/data27024:/data/db -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27024")]),s._v(":27017 -d mongo:4 --port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("27017")]),s._v(" --shardsvr\n")])])]),a("ul",[a("li",[a("code",[s._v("--shardsvr")]),s._v(": 指明这是一个分片")])])]),s._v(" "),a("li",[a("p",[s._v("在本机连接 mongo27021 中的 mongos 进程，这里本机需要先安装好 MongoDB：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("mongo localhost:27021\n")])])])]),s._v(" "),a("li",[a("p",[s._v("添加两个分片")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("sh.addShard"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo27023:27017"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shardAdded"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shard0000"')]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"operationTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638934720")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$clusterTime")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638934720")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"signature"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hash"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" BinData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AAAAAAAAAAAAAAAAAAAAAAAAAAA="')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keyId"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" NumberLong"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("p",[s._v("再加")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("sh.addShard"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo27024:27017"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shardAdded"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shard0001"')]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"operationTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638934745")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$clusterTime")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638934745")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"signature"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hash"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" BinData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AAAAAAAAAAAAAAAAAAAAAAAAAAA="')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keyId"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" NumberLong"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("查看集群状态")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("sh.status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("--- Sharding Status ---\n  sharding version: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  \t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n  \t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"minCompatibleVersion"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(",\n  \t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"currentVersion"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(",\n  \t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterId"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" ObjectId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"61b02718995d33fc87f70c68"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  shards:\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shard0000"')]),s._v(",  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"host"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo27023:27017"')]),s._v(",  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"state"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"shard0001"')]),s._v(",  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"host"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongo27024:27017"')]),s._v(",  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"state"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  active mongoses:\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4.4.10"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  autosplit:\n        Currently enabled: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n  balancer:\n        Currently enabled:  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n        Currently running:  no\n        Failed balancer rounds "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" last "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" attempts:  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        Migration Results "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the last "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" hours:\n                No recent migrations\n  databases:\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"_id"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"config"')]),s._v(",  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"primary"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"config"')]),s._v(",  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"partitioned"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"_6-6-创建数据库和集合"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-创建数据库和集合"}},[s._v("#")]),s._v(" 6.6 创建数据库和集合")]),s._v(" "),a("p",[s._v("现在分片环境已经可以正常运行，但没有分片数据：接下来窗户就一个名为 testdb 的数据库，然后在该数据库中激活一个名为 testcollection 的集合，对该集合进行分配，赋予它一个名为 testkey 的参数，用作分片函数。")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("连接 mongos")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("mongo localhost:27021\n")])])])]),s._v(" "),a("li",[a("p",[s._v("给 testdb 开启分片")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("sh.enableSharding"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"testdb"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"operationTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638935020")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$clusterTime")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638935020")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"signature"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hash"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" BinData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AAAAAAAAAAAAAAAAAAAAAAAAAAA="')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keyId"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" NumberLong"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("激活分片集合，添加分片函数")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("sh.shardCollection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"testdb.testcollection"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("testkey: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),a("p",[s._v("输出：")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"collectionsharded"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"testdb.testcollection"')]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"collectionUUID"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" UUID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"88e5b51e-ca77-4f38-a4ab-cc3a3a0f1b42"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ok"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"operationTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638935102")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$clusterTime")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clusterTime"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Timestamp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1638935102")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"signature"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hash"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" BinData"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AAAAAAAAAAAAAAAAAAAAAAAAAAA="')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(",\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"keyId"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" NumberLong"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"_6-7-修改-chunksize"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-7-修改-chunksize"}},[s._v("#")]),s._v(" 6.7 修改 chunksize")]),s._v(" "),a("p",[s._v("MongoDB 默认的 chunksize 是 64M，为了使后面的分片效果显著，这里我们改成 1M。")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("进入 mongos")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("mongo localhost:27021\n")])])])]),s._v(" "),a("li",[a("p",[s._v("使用 config 数据库")]),s._v(" "),a("div",{staticClass:"language-shj extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("use config\n")])])])]),s._v(" "),a("li",[a("p",[s._v("设置 chunksize 为 1M")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("db.settings.save"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" _id:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"chunksize"')]),s._v(", value: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"_6-8-客户端插入数据"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-8-客户端插入数据"}},[s._v("#")]),s._v(" 6.8 客户端插入数据")]),s._v(" "),a("blockquote",[a("p",[s._v("这里使用 Go 程序来插入数据。")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("创建测试程序目录")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/mongo-sharding-go\n")])])])]),s._v(" "),a("li",[a("p",[s._v("进入该目录")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/mongo-sharding-go\n")])])])]),s._v(" "),a("li",[a("p",[s._v("初始化 go 程序")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("go mod init mongo-sharding-go\n")])])])]),s._v(" "),a("li",[a("p",[s._v("创建 main.go 文件")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" main.go\n")])])])]),s._v(" "),a("li",[a("p",[s._v("拉取 mongo-driver 驱动库")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("go get go.mongodb.org/mongo-driver/mongo\n")])])])]),s._v(" "),a("li",[a("p",[s._v("编写 main.go")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" main.go\n")])])]),a("p",[s._v("内容如下：")]),s._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" main\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"context"')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"fmt"')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"math/rand"')]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"go.mongodb.org/mongo-driver/mongo"')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"go.mongodb.org/mongo-driver/mongo/options"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Test "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tTestKey  "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("`bson: testkey`")]),s._v("\n\tTestText "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("`bson: testtext`")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 注意，要连接的是 mongos 所监听的端口")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t\tMONGODB_URL "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mongodb://localhost:27021"')]),s._v("\n\t\tDATABASE    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"testdb"')]),s._v("\n\t\tCOLLECTION  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"testcollection"')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1. 建立连接")]),s._v("\n\tclient"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" mongo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Connect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("TODO")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ApplyURI")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("MONGODB_URL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("SetRetryWrites")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("nil")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("panic")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2. 选择数据库 testdb")]),s._v("\n\tdb "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Database")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("DATABASE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3. 选择表 testcollection")]),s._v("\n\tcollection "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Collection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("COLLECTION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4. 插入数据")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\ttest "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("Test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\tTestKey"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  rand"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Intn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t\tTestText"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Hello everyone, this is the test created by hedon while learning mongodb shrading cluster."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" collection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("InsertOne")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("TODO")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"插入完成..."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])]),s._v(" "),a("li",[a("p",[s._v("执行 go 程序")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("go run main.go\n")])])])])]),s._v(" "),a("h3",{attrs:{id:"_6-9-查看分片效果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-9-查看分片效果"}},[s._v("#")]),s._v(" 6.9 查看分片效果")]),s._v(" "),a("p",[a("strong",[s._v("先看 mongos")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("进入 mongos")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("mongo localhost:27021\n")])])])]),s._v(" "),a("li",[a("p",[s._v("切换数据库")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("use testdb\n")])])])]),s._v(" "),a("li",[a("p",[s._v("查看集合文档条数")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("mongos"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.testcollection.count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),s._v("\n")])])]),a("p",[s._v("可以看到 10W 条文档已经插进去了，分片集群访问是没有问题的。")])])]),s._v(" "),a("p",[a("strong",[s._v("再看分片 0")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("进入分片 0 —— mongo27023")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mongo27023 mongo\n")])])])]),s._v(" "),a("li",[a("p",[s._v("切换数据库")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("use testdb\n")])])])]),s._v(" "),a("li",[a("p",[s._v("查看文档条数")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.testcollection.count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("43242")]),s._v("\n")])])])])]),s._v(" "),a("p",[a("strong",[s._v("再看分片 1")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("进入分片 1 —— mongo27024")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it mongo27024 mongo\n")])])])]),s._v(" "),a("li",[a("p",[s._v("切换数据库")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("use testdb\n")])])])]),s._v(" "),a("li",[a("p",[s._v("查看文档条数")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" db.testcollection.count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56758")]),s._v("\n")])])])])]),s._v(" "),a("p",[s._v("至此，MongoDB 分片集群就搭建完毕了。")]),s._v(" "),a("h2",{attrs:{id:"_7-分片平衡"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-分片平衡"}},[s._v("#")]),s._v(" 7. 分片平衡")]),s._v(" "),a("img",{staticStyle:{zoom:"33%"},attrs:{src:"https://hedonspace.oss-cn-beijing.aliyuncs.com/img2/008i3skNgy1gx5lqoovxtj314a0fsta1.jpg",alt:"image-20211207214339583"}}),s._v(" "),a("p",[s._v("MongoDB 中会有一个均衡器，如果数据在分片中分配不平衡的话，它会在后台自己转移数据，使其平衡。")]),s._v(" "),a("Vssue")],1)}),[],!1,null,null,null);t.default=e.exports}}]);