<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java 多线程 | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.2b5d8ceb.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.bcda4898.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/65.445b3f90.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.2457a131.js"><link rel="prefetch" href="/noteSite/assets/js/100.282037ec.js"><link rel="prefetch" href="/noteSite/assets/js/101.3ec8c27f.js"><link rel="prefetch" href="/noteSite/assets/js/102.dbaeb1b7.js"><link rel="prefetch" href="/noteSite/assets/js/103.ea3d0288.js"><link rel="prefetch" href="/noteSite/assets/js/104.5c8fedec.js"><link rel="prefetch" href="/noteSite/assets/js/105.721fdfb0.js"><link rel="prefetch" href="/noteSite/assets/js/106.29718338.js"><link rel="prefetch" href="/noteSite/assets/js/107.140f58aa.js"><link rel="prefetch" href="/noteSite/assets/js/108.23be13b5.js"><link rel="prefetch" href="/noteSite/assets/js/109.816344eb.js"><link rel="prefetch" href="/noteSite/assets/js/11.4fcb6d6b.js"><link rel="prefetch" href="/noteSite/assets/js/110.91c77482.js"><link rel="prefetch" href="/noteSite/assets/js/111.0773e203.js"><link rel="prefetch" href="/noteSite/assets/js/112.5f252bfb.js"><link rel="prefetch" href="/noteSite/assets/js/113.a10a72d6.js"><link rel="prefetch" href="/noteSite/assets/js/114.d7545a94.js"><link rel="prefetch" href="/noteSite/assets/js/115.d4223625.js"><link rel="prefetch" href="/noteSite/assets/js/116.1293de89.js"><link rel="prefetch" href="/noteSite/assets/js/117.f69650c9.js"><link rel="prefetch" href="/noteSite/assets/js/118.3ec9591b.js"><link rel="prefetch" href="/noteSite/assets/js/119.8db13744.js"><link rel="prefetch" href="/noteSite/assets/js/12.c90a7522.js"><link rel="prefetch" href="/noteSite/assets/js/120.9ca8204e.js"><link rel="prefetch" href="/noteSite/assets/js/121.a28bf4ed.js"><link rel="prefetch" href="/noteSite/assets/js/122.57452c9e.js"><link rel="prefetch" href="/noteSite/assets/js/123.4bbf359c.js"><link rel="prefetch" href="/noteSite/assets/js/124.e96b183f.js"><link rel="prefetch" href="/noteSite/assets/js/125.0c941fd1.js"><link rel="prefetch" href="/noteSite/assets/js/126.add326fd.js"><link rel="prefetch" href="/noteSite/assets/js/127.9882ace8.js"><link rel="prefetch" href="/noteSite/assets/js/128.3d3e6199.js"><link rel="prefetch" href="/noteSite/assets/js/129.b8330812.js"><link rel="prefetch" href="/noteSite/assets/js/13.be95d60f.js"><link rel="prefetch" href="/noteSite/assets/js/130.10d0158c.js"><link rel="prefetch" href="/noteSite/assets/js/131.77f1ff4d.js"><link rel="prefetch" href="/noteSite/assets/js/132.9e0b7543.js"><link rel="prefetch" href="/noteSite/assets/js/133.b0b449d1.js"><link rel="prefetch" href="/noteSite/assets/js/134.5b008722.js"><link rel="prefetch" href="/noteSite/assets/js/135.64122050.js"><link rel="prefetch" href="/noteSite/assets/js/136.11ecc747.js"><link rel="prefetch" href="/noteSite/assets/js/137.e00c1b9f.js"><link rel="prefetch" href="/noteSite/assets/js/138.87cbe079.js"><link rel="prefetch" href="/noteSite/assets/js/139.813d6a4f.js"><link rel="prefetch" href="/noteSite/assets/js/14.a91dc8fb.js"><link rel="prefetch" href="/noteSite/assets/js/140.179ab391.js"><link rel="prefetch" href="/noteSite/assets/js/141.332b3aef.js"><link rel="prefetch" href="/noteSite/assets/js/142.d9bb7a8d.js"><link rel="prefetch" href="/noteSite/assets/js/143.2315d524.js"><link rel="prefetch" href="/noteSite/assets/js/144.e8a6f5c9.js"><link rel="prefetch" href="/noteSite/assets/js/145.83e0596a.js"><link rel="prefetch" href="/noteSite/assets/js/146.59b8ec7f.js"><link rel="prefetch" href="/noteSite/assets/js/147.3233eb53.js"><link rel="prefetch" href="/noteSite/assets/js/148.e7b28083.js"><link rel="prefetch" href="/noteSite/assets/js/149.e7d1453a.js"><link rel="prefetch" href="/noteSite/assets/js/15.ace436c4.js"><link rel="prefetch" href="/noteSite/assets/js/150.144d8775.js"><link rel="prefetch" href="/noteSite/assets/js/151.3b8e2c5e.js"><link rel="prefetch" href="/noteSite/assets/js/152.0b3941f8.js"><link rel="prefetch" href="/noteSite/assets/js/153.69581b97.js"><link rel="prefetch" href="/noteSite/assets/js/154.1b1a32b2.js"><link rel="prefetch" href="/noteSite/assets/js/155.3d608b91.js"><link rel="prefetch" href="/noteSite/assets/js/156.6426d84c.js"><link rel="prefetch" href="/noteSite/assets/js/157.4d8f6aca.js"><link rel="prefetch" href="/noteSite/assets/js/158.66cadbe0.js"><link rel="prefetch" href="/noteSite/assets/js/159.cd20bcec.js"><link rel="prefetch" href="/noteSite/assets/js/16.ba5205e2.js"><link rel="prefetch" href="/noteSite/assets/js/160.fb1465a5.js"><link rel="prefetch" href="/noteSite/assets/js/161.10733159.js"><link rel="prefetch" href="/noteSite/assets/js/162.6215f2be.js"><link rel="prefetch" href="/noteSite/assets/js/163.a3e3c4cd.js"><link rel="prefetch" href="/noteSite/assets/js/164.f8d12cc1.js"><link rel="prefetch" href="/noteSite/assets/js/165.597ccef9.js"><link rel="prefetch" href="/noteSite/assets/js/166.f05205e5.js"><link rel="prefetch" href="/noteSite/assets/js/167.68a92314.js"><link rel="prefetch" href="/noteSite/assets/js/168.24e93983.js"><link rel="prefetch" href="/noteSite/assets/js/169.8207e533.js"><link rel="prefetch" href="/noteSite/assets/js/17.204dc718.js"><link rel="prefetch" href="/noteSite/assets/js/170.e8e69635.js"><link rel="prefetch" href="/noteSite/assets/js/171.81175a4a.js"><link rel="prefetch" href="/noteSite/assets/js/172.a4b39fe7.js"><link rel="prefetch" href="/noteSite/assets/js/173.9a73f4c4.js"><link rel="prefetch" href="/noteSite/assets/js/174.2121be31.js"><link rel="prefetch" href="/noteSite/assets/js/175.ddfde6e9.js"><link rel="prefetch" href="/noteSite/assets/js/176.8d9e38bf.js"><link rel="prefetch" href="/noteSite/assets/js/177.88aad887.js"><link rel="prefetch" href="/noteSite/assets/js/178.bc0a14d5.js"><link rel="prefetch" href="/noteSite/assets/js/179.ef9b049a.js"><link rel="prefetch" href="/noteSite/assets/js/18.b9adc259.js"><link rel="prefetch" href="/noteSite/assets/js/180.ebc68b15.js"><link rel="prefetch" href="/noteSite/assets/js/181.66e846fd.js"><link rel="prefetch" href="/noteSite/assets/js/182.5fb7062c.js"><link rel="prefetch" href="/noteSite/assets/js/183.202710af.js"><link rel="prefetch" href="/noteSite/assets/js/184.99a4476c.js"><link rel="prefetch" href="/noteSite/assets/js/185.68cc62f4.js"><link rel="prefetch" href="/noteSite/assets/js/186.25b7c434.js"><link rel="prefetch" href="/noteSite/assets/js/187.2ea958f6.js"><link rel="prefetch" href="/noteSite/assets/js/188.d886c6aa.js"><link rel="prefetch" href="/noteSite/assets/js/189.741c61a9.js"><link rel="prefetch" href="/noteSite/assets/js/19.811bf034.js"><link rel="prefetch" href="/noteSite/assets/js/190.d8b95ca2.js"><link rel="prefetch" href="/noteSite/assets/js/191.47d0ad44.js"><link rel="prefetch" href="/noteSite/assets/js/192.f305241b.js"><link rel="prefetch" href="/noteSite/assets/js/193.cd0ed807.js"><link rel="prefetch" href="/noteSite/assets/js/194.2d088087.js"><link rel="prefetch" href="/noteSite/assets/js/195.bb042bd0.js"><link rel="prefetch" href="/noteSite/assets/js/196.99a92d9a.js"><link rel="prefetch" href="/noteSite/assets/js/197.aafc2d63.js"><link rel="prefetch" href="/noteSite/assets/js/198.01d32971.js"><link rel="prefetch" href="/noteSite/assets/js/199.060f2286.js"><link rel="prefetch" href="/noteSite/assets/js/20.78824865.js"><link rel="prefetch" href="/noteSite/assets/js/200.d91720a5.js"><link rel="prefetch" href="/noteSite/assets/js/201.17c4e500.js"><link rel="prefetch" href="/noteSite/assets/js/202.fbcbd81a.js"><link rel="prefetch" href="/noteSite/assets/js/203.c3222d2d.js"><link rel="prefetch" href="/noteSite/assets/js/204.574441a0.js"><link rel="prefetch" href="/noteSite/assets/js/205.d841779b.js"><link rel="prefetch" href="/noteSite/assets/js/206.b18adf97.js"><link rel="prefetch" href="/noteSite/assets/js/207.8727d2f0.js"><link rel="prefetch" href="/noteSite/assets/js/208.39e1cfd5.js"><link rel="prefetch" href="/noteSite/assets/js/209.9b566472.js"><link rel="prefetch" href="/noteSite/assets/js/21.cea73218.js"><link rel="prefetch" href="/noteSite/assets/js/210.11558b76.js"><link rel="prefetch" href="/noteSite/assets/js/211.1583fc79.js"><link rel="prefetch" href="/noteSite/assets/js/212.a835c98a.js"><link rel="prefetch" href="/noteSite/assets/js/213.5ee1312e.js"><link rel="prefetch" href="/noteSite/assets/js/214.71ed8e9c.js"><link rel="prefetch" href="/noteSite/assets/js/215.03338399.js"><link rel="prefetch" href="/noteSite/assets/js/216.e79a9588.js"><link rel="prefetch" href="/noteSite/assets/js/217.cf474399.js"><link rel="prefetch" href="/noteSite/assets/js/218.eda994ff.js"><link rel="prefetch" href="/noteSite/assets/js/219.ff310079.js"><link rel="prefetch" href="/noteSite/assets/js/22.d6ead87c.js"><link rel="prefetch" href="/noteSite/assets/js/220.538d10ec.js"><link rel="prefetch" href="/noteSite/assets/js/221.2dc4c8de.js"><link rel="prefetch" href="/noteSite/assets/js/222.ab254ffa.js"><link rel="prefetch" href="/noteSite/assets/js/223.b7ba52d9.js"><link rel="prefetch" href="/noteSite/assets/js/224.f900eeec.js"><link rel="prefetch" href="/noteSite/assets/js/225.eb8df945.js"><link rel="prefetch" href="/noteSite/assets/js/226.29291757.js"><link rel="prefetch" href="/noteSite/assets/js/227.f0eb4286.js"><link rel="prefetch" href="/noteSite/assets/js/228.504a771e.js"><link rel="prefetch" href="/noteSite/assets/js/229.4bd536cc.js"><link rel="prefetch" href="/noteSite/assets/js/23.0ee0c5eb.js"><link rel="prefetch" href="/noteSite/assets/js/230.68d8fa8b.js"><link rel="prefetch" href="/noteSite/assets/js/231.faa352cf.js"><link rel="prefetch" href="/noteSite/assets/js/232.ecb44463.js"><link rel="prefetch" href="/noteSite/assets/js/233.3cabb969.js"><link rel="prefetch" href="/noteSite/assets/js/234.e152dbb8.js"><link rel="prefetch" href="/noteSite/assets/js/235.eac7e157.js"><link rel="prefetch" href="/noteSite/assets/js/236.7ef9f82f.js"><link rel="prefetch" href="/noteSite/assets/js/237.f8fad403.js"><link rel="prefetch" href="/noteSite/assets/js/238.40e33080.js"><link rel="prefetch" href="/noteSite/assets/js/239.5ffc02a0.js"><link rel="prefetch" href="/noteSite/assets/js/24.1a933e6c.js"><link rel="prefetch" href="/noteSite/assets/js/240.5b0ae508.js"><link rel="prefetch" href="/noteSite/assets/js/241.d5d87bca.js"><link rel="prefetch" href="/noteSite/assets/js/242.f603233d.js"><link rel="prefetch" href="/noteSite/assets/js/243.1b250ba3.js"><link rel="prefetch" href="/noteSite/assets/js/244.10054be5.js"><link rel="prefetch" href="/noteSite/assets/js/245.1cf9c4da.js"><link rel="prefetch" href="/noteSite/assets/js/246.ab9e933a.js"><link rel="prefetch" href="/noteSite/assets/js/247.df0bfa0f.js"><link rel="prefetch" href="/noteSite/assets/js/248.e71f0b52.js"><link rel="prefetch" href="/noteSite/assets/js/249.88114b20.js"><link rel="prefetch" href="/noteSite/assets/js/25.df04ad1a.js"><link rel="prefetch" href="/noteSite/assets/js/250.d3674244.js"><link rel="prefetch" href="/noteSite/assets/js/251.b647b420.js"><link rel="prefetch" href="/noteSite/assets/js/252.f722ccfd.js"><link rel="prefetch" href="/noteSite/assets/js/253.50b93301.js"><link rel="prefetch" href="/noteSite/assets/js/254.6e0024c9.js"><link rel="prefetch" href="/noteSite/assets/js/255.45b7a84e.js"><link rel="prefetch" href="/noteSite/assets/js/256.43a008e8.js"><link rel="prefetch" href="/noteSite/assets/js/257.36fa2928.js"><link rel="prefetch" href="/noteSite/assets/js/258.c9aa5226.js"><link rel="prefetch" href="/noteSite/assets/js/259.cf5f1e15.js"><link rel="prefetch" href="/noteSite/assets/js/26.4eb6fe37.js"><link rel="prefetch" href="/noteSite/assets/js/260.b0461665.js"><link rel="prefetch" href="/noteSite/assets/js/261.b8ac8008.js"><link rel="prefetch" href="/noteSite/assets/js/262.24d525c4.js"><link rel="prefetch" href="/noteSite/assets/js/263.86ed03b9.js"><link rel="prefetch" href="/noteSite/assets/js/264.0b8cfd9d.js"><link rel="prefetch" href="/noteSite/assets/js/265.1829dfa9.js"><link rel="prefetch" href="/noteSite/assets/js/266.3c6632c2.js"><link rel="prefetch" href="/noteSite/assets/js/267.3017b3f9.js"><link rel="prefetch" href="/noteSite/assets/js/268.9da3349c.js"><link rel="prefetch" href="/noteSite/assets/js/269.91d8db40.js"><link rel="prefetch" href="/noteSite/assets/js/27.92ef4fae.js"><link rel="prefetch" href="/noteSite/assets/js/270.290f869f.js"><link rel="prefetch" href="/noteSite/assets/js/271.363b42d1.js"><link rel="prefetch" href="/noteSite/assets/js/272.91917ac6.js"><link rel="prefetch" href="/noteSite/assets/js/273.e9eced15.js"><link rel="prefetch" href="/noteSite/assets/js/274.d14be490.js"><link rel="prefetch" href="/noteSite/assets/js/275.16431fb1.js"><link rel="prefetch" href="/noteSite/assets/js/276.6e9572ba.js"><link rel="prefetch" href="/noteSite/assets/js/277.ff3f61ed.js"><link rel="prefetch" href="/noteSite/assets/js/278.d10705fd.js"><link rel="prefetch" href="/noteSite/assets/js/279.da930915.js"><link rel="prefetch" href="/noteSite/assets/js/28.88f99f79.js"><link rel="prefetch" href="/noteSite/assets/js/280.fdcdcd14.js"><link rel="prefetch" href="/noteSite/assets/js/281.b9737e9c.js"><link rel="prefetch" href="/noteSite/assets/js/282.d34bfe58.js"><link rel="prefetch" href="/noteSite/assets/js/283.b69937e2.js"><link rel="prefetch" href="/noteSite/assets/js/284.8b6be79b.js"><link rel="prefetch" href="/noteSite/assets/js/285.c805d6cb.js"><link rel="prefetch" href="/noteSite/assets/js/286.e913edd5.js"><link rel="prefetch" href="/noteSite/assets/js/287.87aca343.js"><link rel="prefetch" href="/noteSite/assets/js/288.e3fedb29.js"><link rel="prefetch" href="/noteSite/assets/js/289.ec88668a.js"><link rel="prefetch" href="/noteSite/assets/js/29.6cba673a.js"><link rel="prefetch" href="/noteSite/assets/js/290.af4b9a88.js"><link rel="prefetch" href="/noteSite/assets/js/291.f0eb4185.js"><link rel="prefetch" href="/noteSite/assets/js/292.67f5b7d5.js"><link rel="prefetch" href="/noteSite/assets/js/293.93355ff9.js"><link rel="prefetch" href="/noteSite/assets/js/294.cee6242c.js"><link rel="prefetch" href="/noteSite/assets/js/295.78bb95f7.js"><link rel="prefetch" href="/noteSite/assets/js/296.87b69904.js"><link rel="prefetch" href="/noteSite/assets/js/297.12c68168.js"><link rel="prefetch" href="/noteSite/assets/js/298.eabbd03c.js"><link rel="prefetch" href="/noteSite/assets/js/299.3cc9c9e8.js"><link rel="prefetch" href="/noteSite/assets/js/3.01ff9906.js"><link rel="prefetch" href="/noteSite/assets/js/30.0be426ff.js"><link rel="prefetch" href="/noteSite/assets/js/300.7215ac2f.js"><link rel="prefetch" href="/noteSite/assets/js/301.1f7507df.js"><link rel="prefetch" href="/noteSite/assets/js/302.02a4394d.js"><link rel="prefetch" href="/noteSite/assets/js/303.4d47ce8a.js"><link rel="prefetch" href="/noteSite/assets/js/304.0f46dc9c.js"><link rel="prefetch" href="/noteSite/assets/js/305.f03ff520.js"><link rel="prefetch" href="/noteSite/assets/js/306.dce070cf.js"><link rel="prefetch" href="/noteSite/assets/js/307.2495f1d8.js"><link rel="prefetch" href="/noteSite/assets/js/308.7ed44a2e.js"><link rel="prefetch" href="/noteSite/assets/js/31.3affb8bf.js"><link rel="prefetch" href="/noteSite/assets/js/32.437b68d8.js"><link rel="prefetch" href="/noteSite/assets/js/33.0d8d1ace.js"><link rel="prefetch" href="/noteSite/assets/js/34.85f8d0f4.js"><link rel="prefetch" href="/noteSite/assets/js/35.956398a7.js"><link rel="prefetch" href="/noteSite/assets/js/36.a2f9b5ef.js"><link rel="prefetch" href="/noteSite/assets/js/37.ed56e679.js"><link rel="prefetch" href="/noteSite/assets/js/38.caf7b4b1.js"><link rel="prefetch" href="/noteSite/assets/js/39.3235028f.js"><link rel="prefetch" href="/noteSite/assets/js/4.80421812.js"><link rel="prefetch" href="/noteSite/assets/js/40.20882ae0.js"><link rel="prefetch" href="/noteSite/assets/js/41.2a0678f6.js"><link rel="prefetch" href="/noteSite/assets/js/42.191a81ff.js"><link rel="prefetch" href="/noteSite/assets/js/43.f7570860.js"><link rel="prefetch" href="/noteSite/assets/js/44.10633104.js"><link rel="prefetch" href="/noteSite/assets/js/45.26a82295.js"><link rel="prefetch" href="/noteSite/assets/js/46.2ffa92cf.js"><link rel="prefetch" href="/noteSite/assets/js/47.3e3893e2.js"><link rel="prefetch" href="/noteSite/assets/js/48.7e7b91db.js"><link rel="prefetch" href="/noteSite/assets/js/49.b1c28419.js"><link rel="prefetch" href="/noteSite/assets/js/5.4170108b.js"><link rel="prefetch" href="/noteSite/assets/js/50.6f09ab11.js"><link rel="prefetch" href="/noteSite/assets/js/51.7d986c4e.js"><link rel="prefetch" href="/noteSite/assets/js/52.6f79a86f.js"><link rel="prefetch" href="/noteSite/assets/js/53.32be0296.js"><link rel="prefetch" href="/noteSite/assets/js/54.186fd282.js"><link rel="prefetch" href="/noteSite/assets/js/55.2a874220.js"><link rel="prefetch" href="/noteSite/assets/js/56.9a735ade.js"><link rel="prefetch" href="/noteSite/assets/js/57.106c99d0.js"><link rel="prefetch" href="/noteSite/assets/js/58.d28c84f2.js"><link rel="prefetch" href="/noteSite/assets/js/59.285a831b.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.42583b94.js"><link rel="prefetch" href="/noteSite/assets/js/61.8729ece7.js"><link rel="prefetch" href="/noteSite/assets/js/62.a8804c76.js"><link rel="prefetch" href="/noteSite/assets/js/63.7f590648.js"><link rel="prefetch" href="/noteSite/assets/js/64.1d0b611f.js"><link rel="prefetch" href="/noteSite/assets/js/66.944ecaa7.js"><link rel="prefetch" href="/noteSite/assets/js/67.e8296499.js"><link rel="prefetch" href="/noteSite/assets/js/68.11521d20.js"><link rel="prefetch" href="/noteSite/assets/js/69.c793ef18.js"><link rel="prefetch" href="/noteSite/assets/js/7.f685cce4.js"><link rel="prefetch" href="/noteSite/assets/js/70.c7cfccac.js"><link rel="prefetch" href="/noteSite/assets/js/71.69a8329a.js"><link rel="prefetch" href="/noteSite/assets/js/72.94c682ad.js"><link rel="prefetch" href="/noteSite/assets/js/73.4aa52a09.js"><link rel="prefetch" href="/noteSite/assets/js/74.3dd31a8d.js"><link rel="prefetch" href="/noteSite/assets/js/75.35eafb0f.js"><link rel="prefetch" href="/noteSite/assets/js/76.707f6d7d.js"><link rel="prefetch" href="/noteSite/assets/js/77.4e7c39d5.js"><link rel="prefetch" href="/noteSite/assets/js/78.c42519cf.js"><link rel="prefetch" href="/noteSite/assets/js/79.df35c1a1.js"><link rel="prefetch" href="/noteSite/assets/js/8.976ce270.js"><link rel="prefetch" href="/noteSite/assets/js/80.d29db4a3.js"><link rel="prefetch" href="/noteSite/assets/js/81.fc934844.js"><link rel="prefetch" href="/noteSite/assets/js/82.e90de050.js"><link rel="prefetch" href="/noteSite/assets/js/83.abbff5a2.js"><link rel="prefetch" href="/noteSite/assets/js/84.69ddc064.js"><link rel="prefetch" href="/noteSite/assets/js/85.b72fae5f.js"><link rel="prefetch" href="/noteSite/assets/js/86.84b7db2f.js"><link rel="prefetch" href="/noteSite/assets/js/87.b25dddaf.js"><link rel="prefetch" href="/noteSite/assets/js/88.f837c1cf.js"><link rel="prefetch" href="/noteSite/assets/js/89.0bb511ab.js"><link rel="prefetch" href="/noteSite/assets/js/9.599a8138.js"><link rel="prefetch" href="/noteSite/assets/js/90.3fd489aa.js"><link rel="prefetch" href="/noteSite/assets/js/91.8885479b.js"><link rel="prefetch" href="/noteSite/assets/js/92.8c5081db.js"><link rel="prefetch" href="/noteSite/assets/js/93.003ec9bd.js"><link rel="prefetch" href="/noteSite/assets/js/94.897ace9f.js"><link rel="prefetch" href="/noteSite/assets/js/95.fae86dc8.js"><link rel="prefetch" href="/noteSite/assets/js/96.83af16dc.js"><link rel="prefetch" href="/noteSite/assets/js/97.a0104751.js"><link rel="prefetch" href="/noteSite/assets/js/98.1d4e53ce.js"><link rel="prefetch" href="/noteSite/assets/js/99.89a53379.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.2b5d8ceb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 常用类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 高级特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java 多线程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/java/concurrent/synchronized.html" class="sidebar-link">Synchronized</a></li><li><a href="/noteSite/backend/java/concurrent/multithreading.html" aria-current="page" class="active sidebar-link">Java 多线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_1-thread-类" class="sidebar-link">1. Thread 类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_1-1-thread-类的特性" class="sidebar-link">1.1 Thread 类的特性</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_1-2-thread-类的构造器" class="sidebar-link">1.2 Thread 类的构造器</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_1-3-thread-类常用方法" class="sidebar-link">1.3 Thread 类常用方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_2-线程的创建" class="sidebar-link">2. 线程的创建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_2-1-创建方法一-继承-thread-类" class="sidebar-link">2.1 创建方法一：继承 Thread 类</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_2-2-创建方法二-实现-runnable-接口" class="sidebar-link">2.2 创建方法二：实现 Runnable 接口</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_2-3-创建方法三-实现-callable-接口" class="sidebar-link">2.3 创建方法三：实现 Callable 接口</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_2-4-创建方法四-使用线程池" class="sidebar-link">2.4 创建方法四：使用线程池</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_3-线程的停止" class="sidebar-link">3. 线程的停止</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_3-1-线程停止的情况" class="sidebar-link">3.1 线程停止的情况</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_3-2-正确的两种方式" class="sidebar-link">3.2 正确的两种方式</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_3-3-能够响应中断的方法总结" class="sidebar-link">3.3 能够响应中断的方法总结</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_3-4-几个错误的方式" class="sidebar-link">3.4 几个错误的方式</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_3-5-停止线程相关的重要方法解析" class="sidebar-link">3.5 停止线程相关的重要方法解析</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_4-线程的生命周期" class="sidebar-link">4. 线程的生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_4-1-六种状态-thread-state" class="sidebar-link">4.1 六种状态 —— Thread.State</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_4-2-示意图" class="sidebar-link">4.2 示意图</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_5-线程的属性" class="sidebar-link">5. 线程的属性</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_6-线程的异常" class="sidebar-link">6. 线程的异常</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_6-1-为什么需要-uncaughtexceptionhandler" class="sidebar-link">6.1 为什么需要 UncaughtExceptionHandler？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_6-2-两种解决方案" class="sidebar-link">6.2 两种解决方案</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_6-3-uncaughtexception-异常处理器的调用策略" class="sidebar-link">6.3 UncaughtException 异常处理器的调用策略</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_6-4-自定义-uncaughtexceptionhandler" class="sidebar-link">6.4 自定义 UncaughtExceptionHandler</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_7-线程的弊端" class="sidebar-link">7. 线程的弊端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_7-1-线程安全问题" class="sidebar-link">7.1 线程安全问题</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_7-2-性能问题" class="sidebar-link">7.2 性能问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_8-java-内存模型" class="sidebar-link">8. Java 内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_8-1-jvm-内存结构" class="sidebar-link">8.1 JVM 内存结构</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_8-2-java-内存模型" class="sidebar-link">8.2 Java 内存模型</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_8-3-java-对象模型" class="sidebar-link">8.3 Java 对象模型</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_9-线程的同步" class="sidebar-link">9. 线程的同步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_9-1-线程安全问题" class="sidebar-link">9.1 线程安全问题</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_9-2-示意图" class="sidebar-link">9.2 示意图</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_9-3-原因分析" class="sidebar-link">9.3 原因分析</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_9-4-解决措施" class="sidebar-link">9.4 解决措施</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-单例模式" class="sidebar-link">10. 单例模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-1-饿汉式-静态常量-可用" class="sidebar-link">10.1 饿汉式 - 静态常量[可用]</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-2-饿汉式-静态代码块-可用" class="sidebar-link">10.2 饿汉式 - 静态代码块[可用]</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-3-懒汉式-无处理-不可用" class="sidebar-link">10.3 懒汉式 - 无处理[不可用]</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-4-懒汉式-同步方法-不推荐用" class="sidebar-link">10.4 懒汉式 - 同步方法[不推荐用]</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-5-懒汉式-同步代码块-不可用" class="sidebar-link">10.5 懒汉式 - 同步代码块[不可用]</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-6-懒汉式-双重检查-推荐用" class="sidebar-link">10.6 懒汉式 - 双重检查[推荐用]</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-7-懒汉式-静态内部类-可用" class="sidebar-link">10.7 懒汉式 - 静态内部类[可用]</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-8-懒汉式-枚举-最佳" class="sidebar-link">10.8 懒汉式 - 枚举[最佳]</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-线程的死锁" class="sidebar-link">11. 线程的死锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-1-现象" class="sidebar-link">11.1 现象</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-2-演示死锁" class="sidebar-link">11.2 演示死锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-3-必要条件" class="sidebar-link">11.3 必要条件</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-4-如何定位死锁" class="sidebar-link">11.4 如何定位死锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-5-解决措施" class="sidebar-link">11.5 解决措施</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-6-修复死锁" class="sidebar-link">11.6 修复死锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-7-避免死锁" class="sidebar-link">11.7 避免死锁</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_12-线程的活锁" class="sidebar-link">12. 线程的活锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_12-1-活锁演示" class="sidebar-link">12.1 活锁演示</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_12-2-解决措施" class="sidebar-link">12.2 解决措施</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_13-线程的饥饿" class="sidebar-link">13. 线程的饥饿</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_14-线程的通信" class="sidebar-link">14. 线程的通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_14-1-object-类的三个重要方法" class="sidebar-link">14.1 Object 类的三个重要方法</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_14-2-生产者-消费者问题" class="sidebar-link">14.2 生产者/消费者问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_15-面试问题" class="sidebar-link">15. 面试问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_1-start-和-run-的区别" class="sidebar-link">1. start() 和 run() 的区别？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_2-一个线程两次调用-start-方法会出现什么情况-为什么" class="sidebar-link">2. 一个线程两次调用 start() 方法会出现什么情况？为什么？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_3-既然-start-方法会调用-run-方法-为什么不直接调用-run-呢" class="sidebar-link">3. 既然 start() 方法会调用 run() 方法，为什么不直接调用 run() 呢？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_4-thread-sleep-1000-1000ms后是否立即执行" class="sidebar-link">4. Thread.sleep(1000)， 1000ms后是否立即执行?</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_5-thread-sleep-0-是否有用" class="sidebar-link">5. Thread.sleep(0) 是否有用?</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_6-线程交替打印" class="sidebar-link">6. 线程交替打印</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_9-为什么-wait-需要放在-synchronized-代码块中而-sleep-不需要" class="sidebar-link">9. 为什么 wait() 需要放在 synchronized 代码块中而  sleep() 不需要？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_10-为什么-wait-、notify-和-notifyall-放在-object-类中而-sleep-放在-thread-中" class="sidebar-link">10. 为什么 wait()、notify() 和 notifyAll() 放在 Object 类中而 sleep() 放在 Thread 中？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_11-守护线程和普通线程的区别" class="sidebar-link">11. 守护线程和普通线程的区别</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_12-我们是否需要给线程设置为守护线程" class="sidebar-link">12. 我们是否需要给线程设置为守护线程？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_13-java-异常体系图" class="sidebar-link">13. Java 异常体系图</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_14-实际工作中-如何全局处理异常-为什么要全局处理-不处理行不行" class="sidebar-link">14. 实际工作中，如何全局处理异常？为什么要全局处理？不处理行不行？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_15-写一个必然死锁的例子-生产者什么场景下回发生死锁" class="sidebar-link">15. 写一个必然死锁的例子，生产者什么场景下回发生死锁？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_16-死锁的四个必要条件" class="sidebar-link">16. 死锁的四个必要条件</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_17-如何定位死锁" class="sidebar-link">17. 如何定位死锁？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_18-有哪些解决死锁问题的策略" class="sidebar-link">18. 有哪些解决死锁问题的策略？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_19-哲学家就餐问题" class="sidebar-link">19. 哲学家就餐问题</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_20-实际工程中如何避免死锁" class="sidebar-link">20. 实际工程中如何避免死锁？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/concurrent/multithreading.html#_21-什么是活跃性问题-活锁、饥饿和死锁有什么区别" class="sidebar-link">21. 什么是活跃性问题？活锁、饥饿和死锁有什么区别？</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 并发工具类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM 面试题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring 5</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot 2.x</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Hoxton</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Alibaba</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 3.4.5</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="java-多线程"><a href="#java-多线程" class="header-anchor">#</a> Java 多线程</h1> <hr> <h2 id="_1-thread-类"><a href="#_1-thread-类" class="header-anchor">#</a> 1. Thread 类</h2> <blockquote><p>Java 语言的 JVM 允许程序运行多个线程，它通过 java.lang.Thread 类来体现。</p></blockquote> <h3 id="_1-1-thread-类的特性"><a href="#_1-1-thread-类的特性" class="header-anchor">#</a> 1.1 Thread 类的特性</h3> <ul><li>每个线程都是通过某个特定 Thread 对象的 run() 方法来完成操作的，经常把 run() 方法的主体称为线程体。</li> <li>通过该 Thread 对象的 start() 方法来启动这个线程，而非直接调用 run()。</li></ul> <h3 id="_1-2-thread-类的构造器"><a href="#_1-2-thread-类的构造器" class="header-anchor">#</a> 1.2 Thread 类的构造器</h3> <ul><li>Thread()：创建新的 Thread 对象。</li> <li>Thread(String threadname)：创建线程并指定线程实例名。</li> <li>Thread(Runnable target)：指定创建线程的目标对象，它实现了 Runnable 接口中的 run() 方法。</li> <li>Thread(Runnable target, String name)：创建新的 Thread 对象。</li></ul> <h3 id="_1-3-thread-类常用方法"><a href="#_1-3-thread-类常用方法" class="header-anchor">#</a> 1.3 Thread 类常用方法</h3> <ul><li>void start()：启动线程，并执行对象的 run() 方法</li> <li>run()：线程在被调度时执行的操作</li> <li>String getName()：返回线程的名称</li> <li>void setName(String name)：设置该线程名称</li> <li>static Thread currentThread()：返回当前线程</li> <li>static void yield()：线程让步
<ul><li>释放时间片，暂停当前正在执行的线程，把执行机会让给优先级相同或更高的线程；</li> <li>若队列中没有同优先级的线程，忽略此方法；</li> <li>调用 yield() 后还是 <strong>RUNNABLE</strong> 状态，并不一定会释放 CPU，也不会释放锁。</li></ul></li> <li>join()
<ul><li><p>当某个程序执行流中调用其他线程的 join() 方法时，调用线程将被阻塞，直到 join() 方法加入的 join 线程执行完为止</p></li> <li><p>低优先级的线程也可以获得执行</p></li> <li><p>join() 底层调用了 wait(long timeout);</p> <blockquote><p>thread.join()</p> <p>等价于</p> <p>synchronized(thread){</p> <p>​	thread.wait();</p> <p>};</p></blockquote></li> <li><p>join() 没传参的时候会执行 wait(0)，但是没有 notify()，那谁来 notify() 的呢？</p> <blockquote><p>每一个 Thread 对象执行完成后，JVM 会自动执行 notifyAll() 方法。</p></blockquote></li></ul></li> <li>static void sleep(long millis)
<ul><li>令当前活动线程在指定时间段内放弃对CPU控制，使其他线程有机会被执行，时间到后重排队；</li> <li><strong>不会释放锁</strong>（synchronized 和 lock）；</li> <li>可以响应 interrupt() 中断，并抛出 InterruptedException 异常，然后清除中断标志。</li></ul></li> <li>stop()：强制线程生命期结束，不推荐使用</li> <li>boolean isAlive()：返回 boolean，判断线程是否还活着</li></ul> <div class="custom-block tip"><p class="custom-block-title">线程的优先级</p> <ul><li>getPriority()：返回线程优先值</li> <li>setPriority(int newPriority)：改变线程的优先级
<ul><li>MAX_PRIORITY：10</li> <li>MIN _PRIORITY：1</li> <li>NORM_PRIORITY：5</li></ul></li></ul> <p>说明：</p> <ul><li>线程创建时继承父线程的优先级；</li> <li>低优先级只是获得调度的<strong>概率</strong>低，并非一定是在高优先级线程之后才被调用。</li></ul></div> <div class="custom-block tip"><p class="custom-block-title">守护线程</p> <ul><li>setDaemon(Boolean on)：是否为守护线程</li></ul> <blockquote><p>Java 中的线程分为两类：一种是守护线程，一种是用户线程。</p></blockquote> <ul><li>它们在几乎每个方面都是相同的，唯一的区别是判断 JVM 何时离开；</li> <li>守护线程是用来服务用户线程的，通过在 start() 法前调用 thread.setDaemon(true) 可以把一个用户线程变成一个守护线程;</li> <li>Java 垃圾回收就是一个典型的守护线程;</li> <li>若 JVM 中都是守护线程，当前 JVM 将退出;</li> <li>形象理解：<strong>兔死狗烹，鸟尽弓藏。</strong></li></ul></div> <h2 id="_2-线程的创建"><a href="#_2-线程的创建" class="header-anchor">#</a> 2. 线程的创建</h2> <h3 id="_2-1-创建方法一-继承-thread-类"><a href="#_2-1-创建方法一-继承-thread-类" class="header-anchor">#</a> 2.1 创建方法一：继承 Thread 类</h3> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 步骤</span>
<span class="token list punctuation">1.</span> 定义子类继承 Thread 类
<span class="token list punctuation">2.</span> 子类中重写 Thread 类的 run() 方法
<span class="token list punctuation">3.</span> 创建 Thread 子类对象，即创建了线程对象。
<span class="token list punctuation">4.</span> 调用线程对象 start() 方法：启动线程，调用 run() 方法。
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ThreadWayOne</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>

    <span class="token comment">//构造方法</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadWayOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//线程体 =&gt; 重写 run() 方法</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程输出：&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadWayOneTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadWayOne</span> threadWayOne1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadWayOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadWayOne</span> threadWayOne2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadWayOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadWayOne</span> threadWayOne3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadWayOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//调用的是start()方法而不是run()方法</span>
        threadWayOne1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadWayOne2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        threadWayOne3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出：</p> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1giy97u1b8hj313y0f8myv.jpg" alt="image-20200921142631556" style="zoom:50%;"> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 注意点：</span>
<span class="token list punctuation">1.</span> 如果自己手动调用 run() 方法，那么就只是普通方法，没有启动多线程模式。
<span class="token list punctuation">2.</span> run() 方法由 JVM 调用，什么时候调用，执行的过程控制都有操作系统的 CPU 调度决定。
<span class="token list punctuation">3.</span> 想要启动多线程，必须调用 start() 方法。
<span class="token list punctuation">4.</span> 一个线程对象只能调用一次 start() 方法启动，如果重复调用了，则将抛出以上的异常 <span class="token code keyword">`IllegalThreadStateException`</span>。
</code></pre></div><h3 id="_2-2-创建方法二-实现-runnable-接口"><a href="#_2-2-创建方法二-实现-runnable-接口" class="header-anchor">#</a> 2.2 创建方法二：实现 Runnable 接口</h3> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 步骤：</span>
<span class="token list punctuation">1.</span> 定义类实现 Runnable 接口
<span class="token list punctuation">2.</span> 子类中重写 Runnable 接口中的 run() 方法。
<span class="token list punctuation">3.</span> 通过 Thread 类含参构造器创建线程对象。
<span class="token list punctuation">4.</span> 将 Runnable 接口的子类对象作为实际参数传递给 Thread 类的构造器中。
<span class="token list punctuation">5.</span> 调用 Thread 类的 start() 方法开启线程，调用 Runnable 子类接口的 run() 方法。
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//1. 实现 Runnable 接口</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadWayTwo</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token comment">//2. 子类中重写 Runnable 接口中的run方法 =&gt;  编写线程体</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;这是继承  Runnable 接口实现的多线程-&gt;&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;：&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadWayTwoTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//4.将 Runnable 接口的子类对象作为实际参数传递给Thread类的构造器中。</span>
        <span class="token class-name">ThreadWayTwo</span> threadWayTwo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadWayTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3. 通过 Thread 类含参构造器创建线程对象</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadWayTwo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//5. 调用 Thread 类的 start() 方法开启线程，调用 Runnable 子类接口的 run() 方法。</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;主线程：&quot;</span><span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述两种创建线程方式的比较：</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> Thread 类与 Runnable 类的联系：</span>
  public class Thread implements Runnable
  Thread 类其实也是实现了 Runnable 接口然后重写了 run() 方法
<span class="token title important"><span class="token punctuation">#</span> 区别：</span>
  继承 Thread：线程代码存放在 Thread 子类 run() 方法中。
  实现 Runnable：线程代码存在接口的实现类的 run() 方法。
<span class="token title important"><span class="token punctuation">#</span> 实现 Runnable 接口的好处：</span>
  避免了单继承的局限性；
  多个线程可以共享同一个接口实现类的对象，非常适合多个相同线程来处理同一份资源。
  使用 Runnable 可以一直利用同一个 Thread 对象，不断更改其 target 即可，这样减少了新建线程的消耗。
<span class="token title important"><span class="token punctuation">#</span> 同时用 Thread 和 Runnable 两个方法会怎么样？</span>
继承了 Thread 类的会重写 Thread 中的 run() 方法，所以 Thread 中的 run() 方法不会去判断 target 是否为空，而是被直接覆盖了，所以只会执行继承了 Thread 类的线程类。
</code></pre></div><h3 id="_2-3-创建方法三-实现-callable-接口"><a href="#_2-3-创建方法三-实现-callable-接口" class="header-anchor">#</a> 2.3 创建方法三：实现 Callable 接口</h3> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 步骤</span>
<span class="token list punctuation">1.</span> 创建一个实现 Callable 的实现类
<span class="token list punctuation">2.</span> 重写 call() 方法，将此线程需要做的事情放在 call() 里面
<span class="token list punctuation">3.</span> 创建 Callable 实现类的对象
<span class="token list punctuation">4.</span> 将上述对象作为参数传递到 FutureTask 构造器中，创建 FutureTask 对象
<span class="token list punctuation">5.</span> 将 FutureTask 对象作为参数传递到 Thread 构造器中，创建 Thread 对象
<span class="token list punctuation">6.</span> 调用 Thread 对象的 start() 启动线程
<span class="token list punctuation">7.</span> 可以通过 FutureTask 对象获取 call() 方法的返回值等信息

<span class="token title important"><span class="token punctuation">#</span> 与实现 Runnable 相比，Callable 功能更强大些</span>
<span class="token list punctuation">-</span> ① call() 方法相比 run() 方法，可以有返回值
<span class="token list punctuation">-</span> ② call() 方法可以抛出异常
<span class="token list punctuation">-</span> ③ 支持泛型的返回值
<span class="token list punctuation">-</span> ④ 需要借助 FutureTask 类，比如获取返回结果

<span class="token title important"><span class="token punctuation">#</span> Future 接口</span>
<span class="token list punctuation">-</span> 可以对具体 Runnable、Callable 任务的执行结果进行取消、查询是否完成、获取结果等;
<span class="token list punctuation">-</span> FutureTask 是 Future 接口的唯一的实现类;
<span class="token list punctuation">-</span> FutureTask 同时实现了 Runnable, Future 接口。它既可以作为 Runnable 被线程执行，又可以作为 Future 得到 Callable 的返	回值。
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ThreadNew</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token punctuation">{</span>
    <span class="token comment">/**
     * 实现 Callable 是重写 call() 方法
     * @return              有返回值
     * @throws Exception    可以抛异常
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sum <span class="token operator">+=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadByCallable</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadNew</span> threadNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FutureTask</span> futureTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureTask</span><span class="token punctuation">(</span>threadNew<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//还是得 new 一个 Thread</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>futureTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动线程</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//通过 get() 方法获取 call() 返回的值</span>
            <span class="token class-name">Object</span> sum <span class="token operator">=</span> futureTask<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;sum = &quot;</span><span class="token operator">+</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gj3c8r9ki3j31sy09m3zg.jpg" alt="image-20200925235913878"></p> <h3 id="_2-4-创建方法四-使用线程池"><a href="#_2-4-创建方法四-使用线程池" class="header-anchor">#</a> 2.4 创建方法四：使用线程池</h3> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 背景</span>
经常创建和销毁、使用量特别大的资源，比如并发情况下的线程， 对性能影响很大。
<span class="token title important"><span class="token punctuation">#</span> 思路</span>
提前创建好多个线程，放入线程池中，使用时直接获取，使用完放回池中。可以避免频繁创建销毁、实现重复利用。类似生活中的公共交通工具。
<span class="token title important"><span class="token punctuation">#</span> 好处</span>
<span class="token list punctuation">-</span> 提高响应速度(减少了创建新线程的时间)
<span class="token list punctuation">-</span> 降低资源消耗(重复利用线程池中线程，不需要每次都创建)
<span class="token list punctuation">-</span> 便于线程管理
	<span class="token list punctuation">-</span> corePoolSize: 核心池的大小
	<span class="token list punctuation">-</span> maximumPoolSize: 最大线程数
	<span class="token list punctuation">-</span> keepAliveTime: 线程没有任务时最多保持多长时间后会终止
	<span class="token list punctuation">-</span> ...
<span class="token title important"><span class="token punctuation">#</span> Executors</span>
工具类、线程池的工厂类，用于创建并返回不同类型的线程池
<span class="token list punctuation">-</span> Executors.newCachedThreadPool(): 创建一个可根据需要创建新线程的线程池
<span class="token list punctuation">-</span> Executors.newFixedThreadPool(n): 创建一个可重用固定线程数的线程池
<span class="token list punctuation">-</span> Executors.newSingleThreadExecutor(): 创建一个只有一个线程的线程池
<span class="token list punctuation">-</span> Executors.newScheduledThreadPool(n): 创建一个线程池，它可安排在给定延迟后运行命令或者定期地执行。
<span class="token title important"><span class="token punctuation">#</span> ExecutorService</span>
真正的线程池接口。常见子类 ThreadPoolExecutor。
<span class="token list punctuation">-</span> void execute(Runnable command): 执行任务/命令，没有返回值，一般用来执行 Runnable
<span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span> Future<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span> submit(Callable<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>T</span><span class="token punctuation">&gt;</span></span> task): 执行任务，有返回值，一般用来执行 Callable
<span class="token list punctuation">-</span> void shutdown(): 关闭连接池
</code></pre></div><ul><li>示例</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>

        <span class="token comment">//创建使用单个线程的线程池</span>
        <span class="token class-name">ExecutorService</span> es1 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            es1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//创建使用固定线程数的线程池</span>
        <span class="token class-name">ExecutorService</span> es2 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">//execute 适用于 Runnable</span>
            es2<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">//submit 适用于 Callable （Runnable 也可以）</span>
            es2<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//创建一个会根据需要创建新线程的线程池</span>
        <span class="token class-name">ExecutorService</span> es3 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            es3<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//创建拥有固定线程数量的定时线程任务的线程池</span>
        <span class="token class-name">ScheduledExecutorService</span> es4 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;时间：&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            es4<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;时间：&quot;</span><span class="token operator">+</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;--&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//创建只有一个线程的定时线程任务的线程池</span>
        <span class="token class-name">ScheduledExecutorService</span> es5 <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;时间：&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            es5<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;时间：&quot;</span><span class="token operator">+</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;--&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在执行任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      	<span class="token comment">//关闭线程池</span>
        es1<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        es2<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        es3<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        es4<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        es5<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gj3ddluf7cj325o0kc0xs.jpg" alt="image-20200926003828408"></p> <h2 id="_3-线程的停止"><a href="#_3-线程的停止" class="header-anchor">#</a> 3. 线程的停止</h2> <blockquote><p>核心：使用 interrupt() 来通知线程自己去停止，而不是强制线程停止。</p></blockquote> <h3 id="_3-1-线程停止的情况"><a href="#_3-1-线程停止的情况" class="header-anchor">#</a> 3.1 线程停止的情况</h3> <h4 id="_1-正常情况下停止"><a href="#_1-正常情况下停止" class="header-anchor">#</a> ① 正常情况下停止</h4> <ol><li>主线程使用<code>子线程.interrupt()</code>通知子线程停止线程；</li> <li>子线程使用<code>Thread.currentThread().isInterrupted()</code>检测当前线程是否被中断，如果 true，就中断当前线程。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * run() 方法内没有 sleep() 或 wait() 方法时，停止线程的正确方式
 *
 * @author Hedon Wang
 * @create 2021-02-19 9:52 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RightStopThreadWithoutSleep</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这里需要对 interrupt() 方法进行响应，否则不会停止线程</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span> i <span class="token operator">%</span> <span class="token number">10000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">&quot;是10000的倍数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//下面这句使用 interrupt() 的话会输出，采用 thread.stop() 的话不会</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;over....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//新建线程</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RightStopThreadWithoutSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动线程</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//阻塞main线程</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通知子线程停止</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        thread.stop();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-线程阻塞情况下停止"><a href="#_2-线程阻塞情况下停止" class="header-anchor">#</a> ② 线程阻塞情况下停止</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 在阻塞情况下如何正确停止线程
 *
 * @author Hedon Wang
 * @create 2021-02-19 9:59 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RightStopThreadWithSleep</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//这里希望子线程快速执行然后进入阻塞状态</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;=</span> <span class="token number">300</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token string">&quot;是100的倍数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                num<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//子线程睡眠，等待</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token comment">//新建线程</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RightStopThreadWithSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//启动子线程</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//阻塞当前线程，这里阻塞时间比子线程阻塞时间短，确保会执行到子线程阻塞的过程中</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//通知子线程停止</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnubt9tf0wj31jc0bg40k.jpg" alt="image-20210220213556672"></p> <p>会抛出异常的原因：</p> <ul><li>线程在 sleep() 过程中如果被通知要中断的时候，就会报 InterruptedException 异常。</li></ul> <h4 id="_3-线程在每次迭代后都阻塞的情况下停止"><a href="#_3-线程在每次迭代后都阻塞的情况下停止" class="header-anchor">#</a> ③ 线程在每次迭代后都阻塞的情况下停止</h4> <p><strong>【情况一： try/catch 包围 while】</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 执行过程中每一次循环都阻塞（sleep或wait），该如何正确停止线程：情况一
 *
 * @author Hedon Wang
 * @create 2021-02-19 10:10 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RightStopThreadWithSleepEveryLoop</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 这里不需要判断 Thread.currentThread().isInterrupted()
             * 原因：代码大部分实现都在 sleep()，而 sleep 过程中如果被 interrupt() 的话自然会捕获异常然后抛出
             */</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token string">&quot;是100的倍数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                num<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment">//每次迭代都阻塞子线程</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RightStopThreadWithSleepEveryLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnuc2cax44j31m80cqq5c.jpg" alt="image-20210220214439059"></p> <p><strong>【情况二：try/catch 在 while 中】</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 执行过程中每一次循环都阻塞（sleep或wait），该如何正确停止线程：情况二
 *
 * @author Hedon Wang
 * @create 2021-02-19 10:10 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RightStopThreadWithSleepEveryLoop</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//将 try/catch 放在 while 中</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              	<span class="token comment">//不管使不使用Thread.currentThread().isInterrupted()结果都一样</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token string">&quot;是100的倍数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                num<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment">//每次迭代都阻塞子线程</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RightStopThreadWithSleepEveryLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnuc507qmyj31pc0duwh3.jpg" alt="image-20210220214713028"></p> <p>报错后子线程并没有停止，而是继续执行的原因：</p> <ul><li><code>interrupt()</code> 只是通知线程中断，而不是强制线程中断，线程何时中断以及是否要中断的决定权都在线程本身。</li> <li>所以 <code>try/catch</code> 后还是会进入下一轮循环。而 Java 中如果捕获到 <code>InterruptedException</code> 异常并处理后，会<strong>将中断标记位清除</strong>，所以在下一轮循环中，线程检测不到被中断，就会继续执行。</li></ul> <h3 id="_3-2-正确的两种方式"><a href="#_3-2-正确的两种方式" class="header-anchor">#</a> 3.2 正确的两种方式</h3> <h4 id="_1-优先选择-传递中断"><a href="#_1-优先选择-传递中断" class="header-anchor">#</a> ① 优先选择：传递中断</h4> <ol><li>业务方法捕获到中断信息后不要 try/catch，而是 throws 给调用方。</li> <li>调用方感知到线程被中断后再进行相应的处理。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 优先选择：传递中断
 *  说明：
 *      catch 了 InterruptedException 后在方法前面中抛出异常
 *      那么在子线程中的 run() 方法就会强制 try/catch
 *
 * @author Hedon Wang
 * @create 2021-02-20 9:59 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RightWayStopThreadByDelivery</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//模拟业务</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;go&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//因为方法传递了中断，所以调用方可以感知到，然后可以进行相应的处理</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">throwInMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用方知道中断后进行了一系列操作....[保存日志/停止程序/...]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 一次会抛出异常的方法
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">throwInMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//e.printStackTrace()打印日志信息，看似处理了异常</span>
            <span class="token comment">//但是其实没有处理，因为程序运行到服务器上，你打印的信息一般是看不到的</span>
            <span class="token comment">//所以这里实际上是把中断给吞了，调用方是感知不到的</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//所以最好是把中断传递给调用方</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RightWayStopThreadByDelivery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><font color="red">注意：run() 不允许抛出异常，只能 try/catch。</font></p> <h4 id="_2-不想或无法传递-恢复中断"><a href="#_2-不想或无法传递-恢复中断" class="header-anchor">#</a> ② 不想或无法传递：恢复中断</h4> <ol><li>使用 try/catch 来捕获中断异常</li> <li>在 catch 中使用 <code>Thread.currentThread().interrupt()</code> 恢复中断</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 不想或无法传递中断：恢复中断
 *  说明：
 *      当捕获到中断信息后，由于方法限制无法 throws InterruptedException 或者不想 throws 的话
 *      可以在 try/catch 语句中的 catch 块中调用 Thread.currentThread().interrupt() 来中断当前线程
 *      这样就可以一直保持一个中断的情况，就不会吞掉中断信息，这样后续执行过程中还是可以检查到中断的
 *
 *
 * @author Hedon Wang
 * @create 2021-02-20 10:29 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RightWayStopThreadByRecovery</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;go&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;程序已被中断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//恢复中断</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RightWayStopThreadByRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果：</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnudlerfsjj31na0cqgoa.jpg" alt="image-20210220223735267"></p> <h3 id="_3-3-能够响应中断的方法总结"><a href="#_3-3-能够响应中断的方法总结" class="header-anchor">#</a> 3.3 能够响应中断的方法总结</h3> <ul><li>Object.wait() / wait(long) / wait(long, int)</li> <li>Thread.sleep(long) / sleep(long, int)</li> <li>Thread.join() / join(long) / join(long, int)</li> <li>java.util.concurrent.BlockingQueue.take() / put(E)</li> <li>java.util.concurrent.locks.Lock.lockInterruptibly()</li> <li>java.util.concurrent.CountDownLatch.await()</li> <li>java.util.concurrent.CyclicBarrier.await()</li> <li>java.util.concurrent.Exchanger.exchange(V)</li> <li>java.nio.channels.InterruptibleChannel 的相关方法</li> <li>java.nio.channels.Selector 的相关方法</li></ul> <h3 id="_3-4-几个错误的方式"><a href="#_3-4-几个错误的方式" class="header-anchor">#</a> 3.4 几个错误的方式</h3> <h4 id="_1-被弃用的-stop-、suspend-和-resume-方法"><a href="#_1-被弃用的-stop-、suspend-和-resume-方法" class="header-anchor">#</a> ① 被弃用的 stop()、suspend() 和 resume() 方法</h4> <ul><li>stop()</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">stopthreads</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 停止线程的错误方法：stop()
 *     说明：
 *          会导致线程运行一半突然停止，没办法完成一个基本单位的操作；
 *     举例：
 *          下面模拟一个军队领物资的请教，调用 stop() 瞬间停止线程会导致有的连队多领取，而有的连队少领取装备，
 *          这就产生了脏数据
 *
 * @author Hedon Wang
 * @create 2021-02-20 10:48 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WrongWayStopThreadByStop</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//模拟指挥军队：5个连队，每个连队10人，以连队为单位发放弹药，叫到号的士兵前去领取</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;连队&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;开始领取武器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;连队&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;中的士兵&quot;</span><span class="token operator">+</span>j<span class="token operator">+</span><span class="token string">&quot;开始领取武器&gt;&gt;&gt;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;连队&quot;</span><span class="token operator">+</span>i<span class="token operator">+</span><span class="token string">&quot;中的士兵&quot;</span><span class="token operator">+</span>j<span class="token operator">+</span><span class="token string">&quot;领取完武器&lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WrongWayStopThreadByStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//强制停止线程</span>
        thread<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出结果：</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnue3m68yhj31du0e6ju0.jpg" alt="image-20210220225505091" style="zoom:33%;"> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 为什么 Thread.stop() 会被弃用？</span>
因为它本质上是不安全的。
停止线程会导致它解锁已锁定的所有监视器。(当 ThreadDeath 异常传播到堆栈中时，监视器将被解锁)。
如果先前受这些监视器保护的任何对象处于不一致状态，则其他线程现在可以以不一致的状态查看这些对象。
当线程对受损对象进行操作时，可能会导致任意行为。这种行为可能很微妙并且难以检测，或者可能是明显的。
与其他未经检查的异常不同，它会 ThreadDeath 默默地杀死线程。
因此，用户没有警告他的程序可能被破坏。腐败可以在实际损害发生后的任何时间显现，甚至在未来几小时或几天。
</code></pre></div><ul><li><p>suspend()、resume()</p> <ul><li>suspend() 是挂起，resume() 是唤醒线程</li> <li>supsend() 是带着锁去挂起线程，所以它需要另一个线程来唤醒它。如果它需要的那个线程被它给锁住了，就永远不可能来唤醒它了，就造成了死锁。</li></ul></li></ul> <h4 id="_2-用-volatile-设置-boolean-标记位"><a href="#_2-用-volatile-设置-boolean-标记位" class="header-anchor">#</a> ② 用 volatile 设置 boolean 标记位</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 生产者
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> canceled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storage <span class="token operator">=</span> storage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;=</span> <span class="token number">100000</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>canceled<span class="token punctuation">)</span><span class="token punctuation">{</span>
              	<span class="token comment">//生产者生产特别快</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  	<span class="token comment">//这里如果 storage 满了，就会被阻塞</span>
                    storage<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token string">&quot;是100的倍数，被放到仓库中了...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                num<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者停止运行..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 消费者
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storage <span class="token operator">=</span> storage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 是否还需要数字
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">needMoreNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">double</span> c <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolitileOne</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token comment">//仓库</span>
        <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//生产者</span>
        <span class="token class-name">Producer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>producer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//消费者</span>
        <span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>consumer<span class="token punctuation">.</span><span class="token function">needMoreNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;被消费了....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">//消费者消费速度远小于生产者生产速度</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者不需要更多数据了....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//让生产者停下来</span>
        producer<span class="token punctuation">.</span>canceled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>producer<span class="token punctuation">.</span>canceled<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnx8vzsjtyj31ca0fs41t.jpg" alt="image-20210223101127496" style="zoom:50%;"> <p>原因分析：</p> <ul><li>生产者在 <code>storage.put(num)</code> 那个地方阻塞的，不会执行到 <code>while (num &lt;= 100000 &amp;&amp; !canceled)</code> 的判断语句中，所以不会检测到 cancel 已经被置为 true 了，导致程序一直处于阻塞状态没有停止。</li></ul> <p>用 interrupt() 改进：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 生产者
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>


    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storage <span class="token operator">=</span> storage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;=</span> <span class="token number">100000</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    storage<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num <span class="token operator">+</span> <span class="token string">&quot;是100的倍数，被放到仓库中了...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                num<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者停止运行..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 消费者
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token punctuation">{</span>

    <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storage <span class="token operator">=</span> storage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 是否还需要数字
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">needMoreNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">double</span> c <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;</span> <span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolitileOne</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token comment">//仓库</span>
        <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//生产者</span>
        <span class="token class-name">Producer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>producer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//消费者</span>
        <span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>consumer<span class="token punctuation">.</span><span class="token function">needMoreNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;被消费了....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者不需要更多数据了....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//让生产者停下来</span>
        thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：线程可以正确结束</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnx911u6j8j31ds0bqtax.jpg" alt="image-20210223101619099" style="zoom:50%;"> <h3 id="_3-5-停止线程相关的重要方法解析"><a href="#_3-5-停止线程相关的重要方法解析" class="header-anchor">#</a> 3.5 停止线程相关的重要方法解析</h3> <h4 id="interrupt"><a href="#interrupt" class="header-anchor">#</a> interrupt()</h4> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnx93fkukoj316s0juwgm.jpg" alt="image-20210223101813134" style="zoom:50%;"> <h4 id="static-boolean-interrupted"><a href="#static-boolean-interrupted" class="header-anchor">#</a> static boolean interrupted()</h4> <ul><li><p>返回当前线程是否被中断，返回后会清除中断标志。</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnx9d5djeej30z404ajry.jpg" alt="image-20210223102756326" style="zoom:50%;"></li></ul> <h4 id="boolean-isinterrupted"><a href="#boolean-isinterrupted" class="header-anchor">#</a> boolean isInterrupted()</h4> <ul><li><p>返回当前线程是否被中断。</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnx9dggxbbj30y004ggm9.jpg" alt="image-20210223102814648" style="zoom:50%;"></li></ul> <h4 id="thread-interrupted"><a href="#thread-interrupted" class="header-anchor">#</a> Thread.interrupted()</h4> <ul><li><p>目标对象是当前运行的线程。</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnx9ivd53nj318i04cq3m.jpg" alt="image-20210223103326608" style="zoom:50%;"></li></ul> <h2 id="_4-线程的生命周期"><a href="#_4-线程的生命周期" class="header-anchor">#</a> 4. 线程的生命周期</h2> <h3 id="_4-1-六种状态-thread-state"><a href="#_4-1-六种状态-thread-state" class="header-anchor">#</a> 4.1 六种状态 —— Thread.State</h3> <p>JDK 中用 Thread.State 类定义了线程的几种状态。</p> <p>要想实现多线程，必须在主线程中创建新的线程对象。Java 语言使用 Thread 类及其子类的对象来表示线程，在它的一个完整的生命周期中通常要经历如下的六种状态：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    NEW<span class="token punctuation">,</span>
    RUNNABLE<span class="token punctuation">,</span>
  	BLOCKED<span class="token punctuation">,</span>
    WAITING<span class="token punctuation">,</span>
    TIMED_WAITING<span class="token punctuation">,</span>
    TERMINATED<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-2-示意图"><a href="#_4-2-示意图" class="header-anchor">#</a> 4.2 示意图</h3> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1go01rpgdjrj30ja0kpn6s.jpg" alt="image-20210225202149750"></p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 特殊情况</span>
从 Object.wait() 状态刚被唤醒时，通常不能立刻抢到 monitor 锁，那就会从 WAITING 先进入 BLOCKED 状态，抢到锁后再转换为 RUNNABLE 状态。如果发生异常，可以直接跳到终止 TERMINATED 状态，不必再遵循路径，比如可以从 WAITING 直接到 TERMINATED。
</code></pre></div><h2 id="_5-线程的属性"><a href="#_5-线程的属性" class="header-anchor">#</a> 5. 线程的属性</h2> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1goethaev9dj31d40mix31.jpg" alt="image-20210310145826044" style="zoom:33%;"> <p><strong>ID</strong></p> <ul><li>线程 ID 是自增的，而且每次重启应用后会重新从 1 开始递增。</li></ul> <p><strong>Name</strong></p> <ul><li>便于开发者识别各个线程。</li></ul> <p><strong>守护线程</strong></p> <ul><li>守护线程是作用是给用户线程提供服务。</li> <li>如果所有线程都是守护线程，那么所有的守护线程和 JVM 会一起停止工作。</li></ul> <p><strong>优先级</strong></p> <ul><li>表明开发者希望哪些线程多被执行，哪些线程少被执行。</li> <li>默认和父线程的优先级相等，共有 10 个等级，默认值是 5。</li> <li>不同操作系统对优先级的定义是不一样的，Java 线程最终是由操作系统来执行的，而 Java 中的优先级映射到不同的操作系统的线程优先级是不一样的。</li> <li>所以最好是不要设置线程的优先级，因为 Java 可以运行在不同的操作系统中，这就会导致线程优先级映射结果不同，这样就造成了我们程序的不可靠。</li></ul> <h2 id="_6-线程的异常"><a href="#_6-线程的异常" class="header-anchor">#</a> 6. 线程的异常</h2> <h3 id="_6-1-为什么需要-uncaughtexceptionhandler"><a href="#_6-1-为什么需要-uncaughtexceptionhandler" class="header-anchor">#</a> 6.1 为什么需要 UncaughtExceptionHandler？</h3> <ul><li>主线程可以轻松发现异常，子线程却不行（子线程会有堆栈信息输出，但是主线程还是畅通无阻地执行）。</li> <li>子线程的异常无法在主线程中用传统方法捕获（try/catch 只能捕获当前线程的异常）。</li> <li>不捕获子线程的异常的话，子线程会直接停止，会影响程序的正常执行。</li></ul> <h3 id="_6-2-两种解决方案"><a href="#_6-2-两种解决方案" class="header-anchor">#</a> 6.2 两种解决方案</h3> <p>① 手动在每个 run() 方法中进行 try/catch —— 不推荐</p> <ul><li>无法预料线程中是否有异常及其异常类型。</li> <li>每个线程类都 try/catch 的话代码太冗余。</li></ul> <p>② 利用 UncaughtExceptionHandler —— 推荐</p> <ul><li>可以捕获线程由于未捕获异常而终止的情况，并可以对其进行处理。</li> <li>void uncaughtException(Thread t, Throwable e)</li></ul> <h3 id="_6-3-uncaughtexception-异常处理器的调用策略"><a href="#_6-3-uncaughtexception-异常处理器的调用策略" class="header-anchor">#</a> 6.3 UncaughtException 异常处理器的调用策略</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadGroup</span> <span class="token keyword">implements</span> <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">//默认情况下 parent 是 null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          	<span class="token comment">//调用 Thread.getDefaultUncaughtExceptionHandler() 方法设置的全局 handler 进行处理</span>
            <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> ueh <span class="token operator">=</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">getDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ueh <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">//全局 handler 存在就处理异常</span>
                ueh<span class="token punctuation">.</span><span class="token function">uncaughtException</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ThreadDeath</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">//全局 handler 不存在就输出异常</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in thread \&quot;&quot;</span>
                                 <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>所以我们需要做的就是定义一个全局异常处理器，让它来处理子线程未捕获的异常并对其进行处理。</li></ul> <h3 id="_6-4-自定义-uncaughtexceptionhandler"><a href="#_6-4-自定义-uncaughtexceptionhandler" class="header-anchor">#</a> 6.4 自定义 UncaughtExceptionHandler</h3> <p>自定义 UncaughtExceptionHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 自定义 UncaughtExceptionHandler
 *
 * @author Hedon Wang
 * @create 2021-03-10 3:42 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUncaughtExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">Logger</span><span class="token punctuation">.</span><span class="token function">getAnonymousLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span>t<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;线程异常终止啦&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 演示使用自定义的 UncaughtExceptionHandler
 *
 * @author Hedon Wang
 * @create 2021-03-10 3:46 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UseOwnUncaughtExceptionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>

        <span class="token comment">//设置全局异常处理器</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">setDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token string">&quot;捕获器1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UseOwnUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UseOwnUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UseOwnUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UseOwnUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>三月 10, 2021 3:47:58 下午 threadException.MyUncaughtExceptionHandler uncaughtException
警告: Thread-0线程异常终止啦
java.lang.RuntimeException
	at threadException.UseOwnUncaughtExceptionHandler.run(UseOwnUncaughtExceptionHandler.java:13)
	at java.lang.Thread.run(Thread.java:748)

三月 10, 2021 3:47:58 下午 threadException.MyUncaughtExceptionHandler uncaughtException
警告: Thread-2线程异常终止啦
java.lang.RuntimeException
	at threadException.UseOwnUncaughtExceptionHandler.run(UseOwnUncaughtExceptionHandler.java:13)
	at java.lang.Thread.run(Thread.java:748)

三月 10, 2021 3:47:58 下午 threadException.MyUncaughtExceptionHandler uncaughtException
警告: Thread-3线程异常终止啦
java.lang.RuntimeException
	at threadException.UseOwnUncaughtExceptionHandler.run(UseOwnUncaughtExceptionHandler.java:13)
	at java.lang.Thread.run(Thread.java:748)

三月 10, 2021 3:47:59 下午 threadException.MyUncaughtExceptionHandler uncaughtException
警告: Thread-4线程异常终止啦
java.lang.RuntimeException
	at threadException.UseOwnUncaughtExceptionHandler.run(UseOwnUncaughtExceptionHandler.java:13)
	at java.lang.Thread.run(Thread.java:748)


Process finished with exit code 0
</code></pre></div><h2 id="_7-线程的弊端"><a href="#_7-线程的弊端" class="header-anchor">#</a> 7. 线程的弊端</h2> <h3 id="_7-1-线程安全问题"><a href="#_7-1-线程安全问题" class="header-anchor">#</a> 7.1 线程安全问题</h3> <blockquote><p>当多个线程访问一个对象时，如果<strong>不用考虑</strong>这些线程在运行时环境下的调度和交替执行，<strong>也不需要进行额外的同步</strong>，或者在掉方法进行任何其他的协调操作，调用这个对象的行为都可以获得<strong>正确的结果</strong>，那么这个对象是线程安全的。</p></blockquote> <h4 id="_7-1-1-临界资源"><a href="#_7-1-1-临界资源" class="header-anchor">#</a> 7.1.1 临界资源</h4> <p>a++</p> <h4 id="_7-1-2-死锁"><a href="#_7-1-2-死锁" class="header-anchor">#</a> 7.1.2 死锁</h4> <p>多个线程对同一临界资源的争夺有可能造成死锁而导致整个系统终止。</p> <h4 id="_7-1-3-对象发布和初始化"><a href="#_7-1-3-对象发布和初始化" class="header-anchor">#</a> 7.1.3 对象发布和初始化</h4> <h5 id="对象溢出"><a href="#对象溢出" class="header-anchor">#</a> 对象溢出</h5> <ol><li><p>方法返回一个 private 对象（private 的本意是不让外部访问）；</p> <p><font color="green">解决：返回一个副本，而不是返回对象本身。</font></p></li> <li><p>还未完全初始化就把对象提供给外界，如：</p> <ul><li>在构造函数中未初始化完毕就 this 赋值；</li> <li>隐式溢出 —— 注册监听事件；</li> <li>构造函数中运行线程；</li></ul> <p><font color="green">解决：利用工厂模式。</font></p></li></ol> <h3 id="_7-2-性能问题"><a href="#_7-2-性能问题" class="header-anchor">#</a> 7.2 性能问题</h3> <h4 id="_7-2-1-调度-上下文切换"><a href="#_7-2-1-调度-上下文切换" class="header-anchor">#</a> 7.2.1 调度：上下文切换</h4> <ol><li>挂起当前线程</li> <li>保存现场</li> <li>切换线程</li> <li>回到现场</li> <li>切换回当前线程</li></ol> <ul><li>保存现场消耗 CPU 时间片</li> <li>缓存开销：缓存失效</li> <li>抢锁、IO 会导致密集的上下文切换</li></ul> <h4 id="_7-2-2-协作-内存同步"><a href="#_7-2-2-协作-内存同步" class="header-anchor">#</a> 7.2.2 协作：内存同步</h4> <h2 id="_8-java-内存模型"><a href="#_8-java-内存模型" class="header-anchor">#</a> 8. Java 内存模型</h2> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gohd1bjzt5j30u01cwqf0.jpg" alt="2Java内存模型底层原理"></p> <h3 id="_8-1-jvm-内存结构"><a href="#_8-1-jvm-内存结构" class="header-anchor">#</a> 8.1 JVM 内存结构</h3> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1goijcik637j31jo0o2di7.jpg" alt="image-20210221161535687"></p> <h4 id="程序计数器"><a href="#程序计数器" class="header-anchor">#</a> 程序计数器</h4> <blockquote><ol><li>每个线程都拥有一个 PC 寄存器，是<strong>线程私有</strong>的。<strong>用来存储指向下一条指令的地址</strong>。</li> <li>在创建线程的时候，同时会创建相应的 PC 寄存器。</li> <li>执行本地方法（JNI）时，PC 寄存器的值为 undefined。</li> <li>PC 寄存器是一块较小的内存空间，是唯一一个在 JVM 规范中没有规定 OutOfMemoryError 的内存区域。</li></ol></blockquote> <h4 id="虚拟机栈"><a href="#虚拟机栈" class="header-anchor">#</a> 虚拟机栈</h4> <blockquote><ol><li>栈由一系列<strong>帧（Frame）<strong>组成，是</strong>线程私有</strong>的。</li> <li>帧用来保存一个方法的局部变量、操作数栈（Java 没有寄存器，所有参数传递使用操作数栈）、常量池指针、动态链接、方法返回值等。</li> <li>每一次方法调用创建一个帧，并压栈。退出方法的时候，修改栈顶指针就可以把栈帧中的内容销毁。</li> <li><strong>局部变量表</strong>存放了编译期可知的各种<strong>基本数据类型</strong>和<strong>引用类型</strong>，每个 <strong>slot</strong> 存放 <strong>32</strong> 位数据，long、double 占 2 个槽位。</li> <li>栈的优点：存取速度比堆快，仅次于寄存器。</li> <li>栈的缺点：存在栈中的数据大小、生存期是在编译期决定的，缺乏灵活性。</li></ol></blockquote> <h4 id="堆"><a href="#堆" class="header-anchor">#</a> 堆</h4> <blockquote><ol><li>用来存放应用系统创建的对象和数组，<strong>所有线程共享</strong> Java 堆。</li> <li>GC 主要就管理堆空间，对<strong>分代</strong> CG 来说，堆也是分代的。</li> <li>堆的优点：运行期<strong>动态分配</strong>内存大小，自动进行垃圾回收。</li> <li>堆的缺点：效率相对较慢。</li></ol></blockquote> <h4 id="方法区"><a href="#方法区" class="header-anchor">#</a> 方法区</h4> <blockquote><ol><li>方法区是线程共享的，通常用来保存装载的类的结构信息。
<ul><li>常量池</li> <li>字段、方法</li> <li>特殊方法</li> <li>永久引用（static修饰的）</li></ul></li> <li>通常和<strong>元空间</strong>关联在一起，但具体的跟 JVM 实现和版本有关。
<ul><li>🔺 String 在 JDK7 之前是放在方法区的，但是 JDK7 以后就移到堆了。</li></ul></li> <li>JVM 规范把方法区描述为堆的一个逻辑部分，但它有一个别名称为 <strong>Non-heap（非堆）</strong>，主要是为了与 Java 堆区分开。</li></ol></blockquote> <h4 id="运行时常量池"><a href="#运行时常量池" class="header-anchor">#</a> 运行时常量池</h4> <blockquote><ol><li>是 Class 文件中每个类或接口的常量池表，在运行期间的表示形式。通常包括：
<ul><li>类的版本</li> <li>字段</li> <li>方法</li> <li>接口</li> <li>...</li></ul></li> <li>在方法区中分配。</li> <li>通常在加载类和接口到 JVM 后，就创建相应的运行时常量池。</li></ol></blockquote> <h4 id="本地方法栈"><a href="#本地方法栈" class="header-anchor">#</a> 本地方法栈</h4> <blockquote><ol><li>在 JVM 中用来支持 native 方法执行的栈就是本地方法栈。</li></ol></blockquote> <h3 id="_8-2-java-内存模型"><a href="#_8-2-java-内存模型" class="header-anchor">#</a> 8.2 Java 内存模型</h3> <h4 id="_8-2-1-重排序"><a href="#_8-2-1-重排序" class="header-anchor">#</a> 8.2.1 重排序</h4> <p>在某一线程内部的两行代码的实际执行顺序和代码在 Java 文件中的顺序不一致，代码指令并不是严格按照代码语句顺序执行的，它们的顺序被改变了，这就是重排序。</p> <p><strong>好处</strong>：提高处理速度。</p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gohf49gbsrj31ee0hdn4p.jpg" alt="image-20210312205812237"></p> <h4 id="_8-2-2-可见性"><a href="#_8-2-2-可见性" class="header-anchor">#</a> 8.2.2 可见性</h4> <h5 id="_8-2-2-1-可见性演示"><a href="#_8-2-2-1-可见性演示" class="header-anchor">#</a> 8.2.2.1 可见性演示</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 描述：     演示可见性带来的问题
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FieldVisibility</span> <span class="token punctuation">{</span>

    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b=&quot;</span> <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">&quot;;a=&quot;</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">FieldVisibility</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FieldVisibility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    test<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    test<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3 个非常容易分析出来的情况：</p> <ul><li>b=2;a=1;</li> <li>b=3;a=3;</li> <li>b=2;a=3;</li></ul> <p>但是还有1个比较隐秘的结果：</p> <ul><li>b=3;a=1</li></ul> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 为什么会出现这种情况？</span>
原因是线程1和线程2看到的东西是不一样的，比如线程1执行了 a=3，线程1也执行了 b=a，但是线程2看到了真正的b是3，但是看到a只看到了自己那份a是1，所以就出现了b=3;a=1。
</code></pre></div><h5 id="_8-2-2-2-为什么会有可见性"><a href="#_8-2-2-2-为什么会有可见性" class="header-anchor">#</a> 8.2.2.2 为什么会有可见性？</h5> <p><strong>操作系统层</strong></p> <ul><li>从内存到 CPU 是存在多层缓存的，每一片缓存都是数据的一份拷贝，所以不同缓存之间数据不一定的一致的。</li></ul> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1goika3dwzfj30r70d9juw.jpg" alt="image-20210313204227557"></p> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gp42ue73i6j30k10csjzf.jpg" alt="img"></p> <p><strong>JVM 层</strong></p> <ul><li>Java 作为高级语言，屏蔽了内存到 CPU 之间的多层缓存这些底层细节，用 JMM 定义了一套读写内存数据的规范。虽然我们不再需要关心一级缓存和二级缓存的问题，但是 JMM 抽象了主内存和本地内存的概念。</li> <li>这里说的本地内存并不是真的是一块给每个线程分配的内存，而是 JMM 的一个抽象，是对于寄存器、一级缓存、二级缓存等的抽象。</li></ul> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1goikd8ckmaj30k50f7jtt.jpg" alt="image-20210313204527766" style="zoom:50%;"> <ul><li>所有的变量都存储在<strong>主内存</strong>中，同时每个线程也有自己独立的<strong>工作内存</strong>，工作内存中的变量内存是主内存中的<strong>拷贝</strong>。</li> <li>线程不能直接读写主内存中的变量，而只能操作自己工作内存中的变量，然后再同步到主内存中。</li> <li>主内存是多个线程共享的，但线程间不共享工作内存，如果线程间需要通信，必须借助主内存中转来完成，这个中转不是实时的，所以才存在了可见性的问题。</li></ul> <h5 id="_8-2-2-3-happens-before-原则"><a href="#_8-2-2-3-happens-before-原则" class="header-anchor">#</a> 8.2.2.3 Happens-Before 原则</h5> <blockquote><p>Happens-Before 原则是用来解决可见性问题的：在时间上，动作 A 发生在动作 B之 前，B 保证能看到 A，这就是 Happens-Before。</p></blockquote> <ol><li><p>单线程原则</p> <p>后一条语句一定能看到前一条语句执行的结果。</p></li> <li><p>锁操作（synchronized 和 Lock）</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1goikle1uvrj30ix0f5ju6.jpg" alt="image-20210313205317447" style="zoom:67%;"></li> <li><p>volatile 变量</p></li> <li><p>线程启动</p> <p>子线程启动之后一定能看到主线程之前所做的所有事情。</p></li> <li><p>线程 join()</p> <p>主线程在子线程 join() 语句之后一定可以看到子线程执行的所有事情。</p></li> <li><p>传递性</p> <p>如果 hb(A,B) 且 hb(B,C)，那么可以推出 hb(A,C)。</p></li> <li><p>中断</p> <p>一个线程被其他线程 interrupt 时，那么检查中断（isInterrupted）或者抛出 InterruptedException 一定能看到。</p></li> <li><p>构造方法</p> <p>对象构造方法的最后一行指令一定先与 finalize() 方法的第一行指令。</p></li> <li><p>工具类：</p> <ol><li>线程安全的容器 get 一定能看到在此之前的 put 等存入操作；</li> <li>CountDownLatch</li> <li>Semaphore</li> <li>Future</li> <li>线程池</li> <li>CyclicBarrier</li></ol></li></ol> <div class="custom-block tip"><p class="custom-block-title">volatile 关键字</p> <h4 id="_1-是什么"><a href="#_1-是什么" class="header-anchor">#</a> ① 是什么</h4> <ul><li>volatile 是一种同步机制，比 synchronized 和 Lock 相关类更轻量，因为适用 volatile 并不会发生上下文切换等开销很大的行为。</li> <li>如果一个变量被修饰成 volatile，那么 JVM 就知道了这个变量可能会被并发修改。</li> <li>但是开销小，相应能力也小。虽然说 volatile 是用来同步的保证线程安全的，但是 volatile 做不到 synchronized 那样的原子保护。</li></ul> <h4 id="_2-适用场景"><a href="#_2-适用场景" class="header-anchor">#</a> ② 适用场景</h4> <p><font color="red">不适用：a++</font></p> <ol><li><p>boolean flag，如果一个共享变量自始至终只被各个线程赋值，而没有其他的操作，那么就可以用 volatile 来代替 synchronized 或者代替原子变量，因为赋值自身是带有原子性的，而 volatile 又保证了可见性，所以就足以保证线程安全。</p></li> <li><p>作为刷新之前变量的触发器。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  b <span class="token operator">=</span> a<span class="token punctuation">;</span>	<span class="token comment">//这个时候，因为 b 被 volatile 修饰，所以可以保证其他线程看到的 b=a，这个时候又同时保证了其他线程看到的 a 也是真实的 a，也就是 a =3。所以 volatile 不仅保证了 b 的可见性，也作为触发线刷新了 b=a 之前的所有语句。</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h4 id="_3-作用"><a href="#_3-作用" class="header-anchor">#</a> ③ 作用</h4> <ul><li>可见性</li> <li>禁止重排序</li> <li>使得 long 和 double 的赋值是原子的</li></ul> <h4 id="_4-与-synchronized-的关系"><a href="#_4-与-synchronized-的关系" class="header-anchor">#</a> ④ 与 synchronized 的关系</h4> <p>（1）使用上的区别</p> <p>volatile 只能修饰变量，synchronized 只能修饰方法和语句块</p> <p>（2）对原子性的保证</p> <p>synchronized 可以保证原子性，volatile 不能保证原子性</p> <p>（3）对可见性的保证</p> <p>都可以保证可见性，但实现原理不同</p> <p>volatile 对变量加了 lock，synchronized 使用了 monitorenter 和 monitorexit</p> <p>（4）对有序性保证</p> <p>volatile 能保证有序性，synchronized 可以保证有序性，但是代价（重量级）大，并发退化到串行</p> <p>（5）其他</p> <p>synchronized 引起阻塞，volatile 不会引起阻塞</p></div> <h4 id="_8-2-3-原子性"><a href="#_8-2-3-原子性" class="header-anchor">#</a> 8.2.3 原子性</h4> <blockquote><p>一系列的操作，要么全部执行成功，要么全部不执行，不会出现执行一半的情况，是不可分割的。</p></blockquote> <p>Java 中的原子操作：</p> <ul><li>除了 long 和 double 之外的基本类型的赋值操作。</li> <li>所有引用 reference 的赋值操作，不管是 32 位还是 64 位的机器。</li> <li>java.concurrent.Atomic.* 包中所有类的原子操作</li></ul> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> long 和 double 的原子性问题</span>
出于 Java 编程语言存储器模型的目的，对 long 和 double 值的单个写入被视为两个单独写入：每个 32 位写一次，总共写 2 次。这可能导致线程从一次写入看到 64 位值的前 32 位，而从另一次写入看到第二次 32 位的情况。
用 volatile 可以解决 long 和 double 的原子性问题。
在 32 位的 JVM 上，long 和 double 操作不是原子性的。
在 64 位的 JVM 上，long 和 double 操作是原子性的。
商用 JVM 中都已经解决了 long 和 double 的原子性问题，我们不需要专门去考虑。
</code></pre></div><h3 id="_8-3-java-对象模型"><a href="#_8-3-java-对象模型" class="header-anchor">#</a> 8.3 Java 对象模型</h3> <h4 id="_8-3-1-对象组成成分"><a href="#_8-3-1-对象组成成分" class="header-anchor">#</a> 8.3.1 对象组成成分</h4> <p>以 HotSpot 虚拟机为例，对象在内存中的布局分为以下 3 个部分：</p> <ul><li>对象头：
<ul><li>Mark Word：存储对象自身的运行数据。如：Hashcode、GC 分代年龄、锁状态标志等。</li> <li>类型指针：对象指向它的类元数据的指针。</li></ul></li> <li>实例数据：
<ul><li>真正存放对象实例数据的地方。</li></ul></li> <li>对齐填充：
<ul><li>这部分不一定存在，也没有什么特别含义，仅仅是占位符。因为 HotSpot 要求对象起始地址都是 <strong>8 字节</strong>的整数倍，如果不是，就对齐。</li></ul></li></ul> <h4 id="_8-3-2-对象的访问定位"><a href="#_8-3-2-对象的访问定位" class="header-anchor">#</a> 8.3.2 对象的访问定位</h4> <h5 id="_1-使用句柄"><a href="#_1-使用句柄" class="header-anchor">#</a> ① 使用句柄</h5> <blockquote><p>Java 堆中会划分一块内存来作为句柄池，reference 中存放句柄的地址，句柄中存储对象的实例数据和类元数据的地址。</p></blockquote> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1goijhj8n6oj30l80bwgmq.jpg" alt="image-20210225151358190"></p> <ul><li>间接指针，效率慢</li> <li>修改对象引用的时候只需要修改到对象实例数据的指针即可。</li></ul> <h5 id="_2-使用指针"><a href="#_2-使用指针" class="header-anchor">#</a> ② 使用指针</h5> <blockquote><p>Java 堆中会存放访问类元数据的地址，reference 存储的就直接是对象的地址。</p> <p>HotStop 用的是使用指针。</p></blockquote> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnzswna4p1j30nn0b1tgm.jpg" alt="image-20210225151510797"> <ul><li>reference 直接指向对象，效率快。</li></ul> <h2 id="_9-线程的同步"><a href="#_9-线程的同步" class="header-anchor">#</a> 9. 线程的同步</h2> <h3 id="_9-1-线程安全问题"><a href="#_9-1-线程安全问题" class="header-anchor">#</a> 9.1 线程安全问题</h3> <ul><li><p>代码</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hedon<span class="token punctuation">.</span>window</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">sun<span class="token punctuation">.</span>plugin2<span class="token punctuation">.</span>os<span class="token punctuation">.</span>windows<span class="token punctuation">.</span></span><span class="token class-name">Windows</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Hedon Wang
 * @create 2020-09-21 15:51
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Window2</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;：卖票，票号为 &quot;</span><span class="token operator">+</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//延迟执行过程，提高线程出现安全问题的概率</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    ticket <span class="token operator">--</span> <span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest2</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Window2</span> window2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Window2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>window2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;窗口1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>window2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;窗口2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>window2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;窗口3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gj2z35y5rbj31zq098jsy.jpg" alt="image-20200925162404887"></p></li> <li><p>问题</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 问题描述</span>
上述代码模仿了一个窗口卖票的过程，三个线程共用同一个 windows 对象的 ticket 变量，按道理是不会卖出同一张票的，但是实际结果如上图，卖出了 3 张100号的票，这是不应该出现的状况。
事实上，还有一定概率卖出票号为0或者-1的票，这也是不对的。
</code></pre></div></li></ul> <h3 id="_9-2-示意图"><a href="#_9-2-示意图" class="header-anchor">#</a> 9.2 示意图</h3> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gj2yhsvfl5j31cx0u0wkl.jpg" alt="image-20200925160332069" style="zoom:33%;"> <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gj2yic6k63j31ee0u0dl2.jpg" alt="image-20200925160403282" style="zoom:33%;"> <h3 id="_9-3-原因分析"><a href="#_9-3-原因分析" class="header-anchor">#</a> 9.3 原因分析</h3> <p>当多条语句在操作同一个线程<strong>共享数据</strong>时，一个线程对多条语句只执行了一部分，还没有执行完，另一个线程参与进来执行，导致共享数据的错误。</p> <h3 id="_9-4-解决措施"><a href="#_9-4-解决措施" class="header-anchor">#</a> 9.4 解决措施</h3> <p>对多条操作共享数据的语句，只能让一个线程都执行完，在执行过程中，不管有没有阻塞，其他线程都不可以参与执行。</p> <h4 id="_9-4-1-法1-同步代码块"><a href="#_9-4-1-法1-同步代码块" class="header-anchor">#</a> 9.4.1 法1：同步代码块</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">synchronized</span><span class="token punctuation">(</span>同步监视器<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//需要被同步的代码</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>需要被同步的代码：操作共享数据的代码</li> <li>共享数据：多个线程共同操作的变量，如上述代码的 ticket</li> <li>同步监视器：俗称，锁。任何一个类的对象，都可以充当锁，==但是所有线程要共用同一个锁==。</li></ul> <p>修改上述代码中的 Window2 类，加入同步代码块，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Window2</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token comment">//同步监视器</span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//需要被同步的代码</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;：卖票，票号为 &quot;</span><span class="token operator">+</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">//延迟执行过程，提高线程出现安全问题的概率</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    ticket <span class="token operator">--</span> <span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再次运行测试方法，会发现线程安全问题已经得到解决了。</p> <p><font color="Red"> △ 注意点：</font></p> <p>每一个线程都要共用同一个锁，比如如下代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Window</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>

    <span class="token comment">//得声明成静态的</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token comment">//同步监视器</span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//需要被同步的代码</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:卖票，票号为：&quot;</span> <span class="token operator">+</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ticket<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Window</span> window <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Window</span> window1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Window</span> window2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        window<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;柜台1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window1<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;柜台2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window2<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;柜台3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        window<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述代码我们在测试的时候，其实是 new 了 3 个 Window 对象的，所以是有 3 个不同的 object 对象的，这样锁是起不到作用的。</p> <p>这时候改成 <strong>private static Object object = new Object()</strong>，就可以起到作用了！</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 好处</span>
解决了线程的安全问题。
<span class="token title important"><span class="token punctuation">#</span> 缺点</span>
<span class="token list punctuation">-</span> 操作同步代码时，只能有一个线程参与，其他线程等待，这相当于是一个单线程的过程了，效率会比较低下；
<span class="token list punctuation">-</span> 死锁
<span class="token title important"><span class="token punctuation">#</span> 重点重点重点</span>
所有线程要共用同一个锁
所有线程要共用同一个锁
所有线程要共用同一个锁
</code></pre></div><hr> <h4 id="_9-4-2-法2-同步方法"><a href="#_9-4-2-法2-同步方法" class="header-anchor">#</a> 9.4.2 法2：同步方法</h4> <p>如果操作共享数据的代码完整的声明在一个方法中，我们不妨将此方法声明为同步的。</p> <h5 id="_9-4-2-1-runnable-版本"><a href="#_9-4-2-1-runnable-版本" class="header-anchor">#</a> 9.4.2.1 Runnable 版本</h5> <p>把售票的过程提取出来作为一个方法 show()，加上 synchronized 表明这是一个同步方法，这样线程安全问题也得到了解决。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Window3</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token comment">//同步监视器</span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//把售票的过程提取出来作为一个方法，加上 synchronized 表明这是一个同步方法</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//需要被同步的代码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;：卖票，票号为 &quot;</span> <span class="token operator">+</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//延迟执行过程，提高线程出现安全问题的概率</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ticket<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_5-4-2-2-thread-版本"><a href="#_5-4-2-2-thread-版本" class="header-anchor">#</a> 5.4.2.2 Thread 版本</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Window4</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>

    <span class="token comment">//得声明成静态的</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token comment">//同步监视器</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//必须声明为静态的</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//需要被同步的代码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:卖票，票号为：&quot;</span> <span class="token operator">+</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ticket<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h5> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 同步监视器</span>
同步方法仍然涉及到同步监视器的问题，只是不需要我们显示的声明：
<span class="token list punctuation">-</span> 非静态的同步方法，同步监视器是 this
<span class="token list punctuation">-</span> 静态的同步方法，同步监视器是当前类本身，如 Windows4.class
</code></pre></div><h4 id="_9-4-3-法3-lock-锁"><a href="#_9-4-3-法3-lock-锁" class="header-anchor">#</a> 9.4.3 法3：Lock 锁</h4> <blockquote><p>从JDK 5.0开始，Java提供了更强大的线程同步机制——通过显式定义同步锁对象来实现同步。同步锁使用Lock对象充当。</p></blockquote> <h5 id="_9-4-3-1-lock-接口"><a href="#_9-4-3-1-lock-接口" class="header-anchor">#</a> 9.4.3.1 Lock 接口</h5> <p>java.util.concurrent.locks.Lock 接口是控制多个线程对共享资源进行访问的工具。锁提供了对共享资源的独占访问，每次只能有一个线程对 Lock对象加锁，线程开始访问共享资源之前应先获得 Lock 对象。</p> <h5 id="_9-4-3-2-reentrantlock-类"><a href="#_9-4-3-2-reentrantlock-类" class="header-anchor">#</a> 9.4.3.2 ReentrantLock 类</h5> <p>ReentrantLock 类实现了 Lock ，它拥有与 synchronized 相同的并发性和 内存语义，在实现线程安全的控制中，比较常用的是ReentrantLock，可以显式加锁、释放锁。</p> <h5 id="_9-4-3-3-代码"><a href="#_9-4-3-3-代码" class="header-anchor">#</a> 9.4.3.3 代码</h5> <ol><li>声明 ReentrantLock 对象</li> <li>上锁 =&gt; lock()</li> <li>解锁 =&gt; unlock()</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Window5</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        fair 参数：
        - true：公平的，符合先来后到
        - false：谁抢得到就是谁的
     */</span>
    <span class="token comment">//1. 声明 ReentrantLock 对象</span>
    <span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token comment">//2. 上锁 =&gt; lock()</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//需要被同步的代码块</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;：卖票，票号为 &quot;</span> <span class="token operator">+</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//延迟执行过程，提高线程出现安全问题的概率</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    ticket<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">//3. 解锁 =&gt; unlock()</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_9-4-3-4-面试题-synchronized-与-lock-的异同"><a href="#_9-4-3-4-面试题-synchronized-与-lock-的异同" class="header-anchor">#</a> 9.4.3.4 面试题：synchronized 与 Lock 的异同</h5> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 相同</span>
二者都可以解决线程的安全问题；

<span class="token hr punctuation">----------------------------------------------------------------------------------------------------------</span>
<span class="token title important"><span class="token punctuation">#</span> 不同</span>
<span class="token title important"><span class="token punctuation">##</span> ① 用法</span>
在需要同步的对象中加入synchronized控制，synchronized既可以加在方法上，也可以加在特定代码中，括号中表示需要锁的对象。而Lock需要显示的指定起始位置和终点位置。synchronized是托管给JVM执行的，而Lock的锁定是通过代码实现的，它有比synchronized更精确的线程定义。
<span class="token title important"><span class="token punctuation">##</span> ② 性能</span>
在JDK 5中增加的ReentrantLock。它不仅拥有和synchronized相同的并发性和内存语义，还增加了锁投票，定时锁，等候和中断锁等。它们的性能在不同情况下会不同：在资源竞争不是很激励的情况下，synchronized的性能要优于ReentrantLock，带在资源紧张很激烈的情况下，synchronized的性能会下降的很快，而ReentrantLock的性能基本保持不变。
<span class="token title important"><span class="token punctuation">##</span> ③ 锁机制</span>
锁机制不一样。synchronized获得锁和释放锁的机制都在代码块结构中，当获得锁时，必须以相反的机制去释放，并且自动解锁，不会因为异常导致没有被释放而导致死锁。而Lock需要开发人员手动去释放，并且写在finally代码块中，否则会可能引起死锁问题的发生。
此外，Lock还提供的更强大的功能，可以通过tryLock的方式采用非阻塞的方式取获得锁。
而且，Lock还提供公平锁，即锁的获得按照线程先来后到的顺序依次获得，不会产生饥饿现象。默认是非公平锁，可通过传入构造方法的参数实现公平锁。synchronized提供的是非公平锁。

<span class="token hr punctuation">----------------------------------------------------------------------------------------------------------</span>
<span class="token title important"><span class="token punctuation">#</span> 用哪个</span>
Lock -&gt; 同步代码块 -&gt; 同步方法
</code></pre></div><h2 id="_10-单例模式"><a href="#_10-单例模式" class="header-anchor">#</a> 10. 单例模式</h2> <p>单例的好处：</p> <ul><li>节省内存和计算</li> <li>保证结果正确</li> <li>方便管理</li></ul> <p>适用场景：</p> <ul><li>无状态的工具类</li> <li>全局信息类</li></ul> <h3 id="_10-1-饿汉式-静态常量-可用"><a href="#_10-1-饿汉式-静态常量-可用" class="header-anchor">#</a> 10.1 饿汉式 - 静态常量[可用]</h3> <ul><li>简单</li> <li>类装载时便完成了实例化，类加载由 JVM 保证线程安全，所以没有线程安全问题。</li> <li>效率低，可能不需要，但是还是加载了。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton1</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Singleton1</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton1</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-2-饿汉式-静态代码块-可用"><a href="#_10-2-饿汉式-静态代码块-可用" class="header-anchor">#</a> 10.2 饿汉式 - 静态代码块[可用]</h3> <ul><li>优缺点同静态变量</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton2</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Singleton2</span> INSTANCE<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton2</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-3-懒汉式-无处理-不可用"><a href="#_10-3-懒汉式-无处理-不可用" class="header-anchor">#</a> 10.3 懒汉式 - 无处理[不可用]</h3> <ul><li>线程不安全。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton3</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton3</span> INSTANCE<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Singleton3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton3</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>INSTANCE <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-4-懒汉式-同步方法-不推荐用"><a href="#_10-4-懒汉式-同步方法-不推荐用" class="header-anchor">#</a> 10.4 懒汉式 - 同步方法[不推荐用]</h3> <ul><li>线程安全。</li> <li>synchronized 加锁，效率低。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton4</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton4</span> INSTANCE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token class-name">Singleton4</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>INSTANCE <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-5-懒汉式-同步代码块-不可用"><a href="#_10-5-懒汉式-同步代码块-不可用" class="header-anchor">#</a> 10.5 懒汉式 - 同步代码块[不可用]</h3> <ul><li>线程不安全。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton5</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton5</span> INSTANCE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton5</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>INSTANCE <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton5</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-6-懒汉式-双重检查-推荐用"><a href="#_10-6-懒汉式-双重检查-推荐用" class="header-anchor">#</a> 10.6 懒汉式 - 双重检查[推荐用]</h3> <ul><li>懒汉式，延迟加载，效率高。</li> <li>线程安全。</li> <li>volatile 禁用了重排序，保证了可见性。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton6</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton6</span> INSTANCE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton6</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>INSTANCE <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Singleton6</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>INSTANCE <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton6</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>思考：</p> <img src="https://i.loli.net/2021/03/14/v1g4BAp8Ye7Tm9D.png" alt="image-20210314143959862" style="zoom:50%;"> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 为什么要 volatile？</span>
<span class="token list punctuation">1.</span> 新建对象不是原子操作，新建对象实际上有 3 个操作
  ① 新建空的对象
  ② 执行构造方法
  ③ 赋值给 INSTANCE
<span class="token list punctuation">2.</span> CPU 和 JVM 具有重排序功能，这 3 行有可能被 CPU 或者 JVM 进行重排序。有可能在第一个线程构造方法还没执行的时候已经将对象赋值给 INSTANCE 了，那第二个对象判断 INSTANCE != NULL，然后就直接拿去用了。用的时候发现里面的属性其实是 NULL 的，还不可用，这就造成了线程不安全。
<span class="token list punctuation">3.</span> 有 volatile，对象一实例好，就会被 flush 到主内存中，所有线程可见。
</code></pre></div><h3 id="_10-7-懒汉式-静态内部类-可用"><a href="#_10-7-懒汉式-静态内部类-可用" class="header-anchor">#</a> 10.7 懒汉式 - 静态内部类[可用]</h3> <ul><li>SingletonInstance 是内部类，JVM 在加载类 Singleton7 的时候是不会将 SingletonInstance.INSTANCE 进行实例化的，只有当调用 SingletonInstance.INSTANCE 才会去实例化。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton7</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingletonInstance</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Singleton7</span> INSTANCE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton7</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton7</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SingletonInstance</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-8-懒汉式-枚举-最佳"><a href="#_10-8-懒汉式-枚举-最佳" class="header-anchor">#</a> 10.8 懒汉式 - 枚举[最佳]</h3> <ul><li>写法简单</li> <li>线程安全有保证（JVM 会保证）</li> <li>懒加载</li> <li><font color="pink">避免反序列化破坏单例</font></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Singleton8</span> <span class="token punctuation">{</span>
    INSTANCE<span class="token punctuation">;</span>
    
    <span class="token comment">//随便做点事</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">whatever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_11-线程的死锁"><a href="#_11-线程的死锁" class="header-anchor">#</a> 11. 线程的死锁</h2> <h3 id="_11-1-现象"><a href="#_11-1-现象" class="header-anchor">#</a> 11.1 现象</h3> <ul><li>不同的线程分别占用对方需要的同步资源不放弃，都在等待对方放弃 自己需要的同步资源，就形成了线程的死锁。</li> <li>出现死锁后，不会出现异常，不会出现提示，只是所有的线程都处于阻塞状态，无法继续。</li></ul> <h3 id="_11-2-演示死锁"><a href="#_11-2-演示死锁" class="header-anchor">#</a> 11.2 演示死锁</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Thread-0 有 o1 想要 o2，Thread-1 有 o2 想要 o1，互相等待，成死锁。
 * @author Hedon Wang
 * @create 2021-03-16 11:20 AM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MustDeadLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeadLockModel</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeadLockModel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;两个线程都已经运行完毕~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DeadLockModel</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token comment">//两把锁</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> o1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//标志，一个线程运行一种情况</span>
    <span class="token keyword">int</span> flag<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DeadLockModel</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

            <span class="token comment">//申请第一把锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o1 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//故意等待5s，让第二个线程拿到o2锁</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//想要第二把锁</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o2 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经运行完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//申请第二把锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o2 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//故意等待2s，让第一个线程拿到o1锁</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o1 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经运行完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：</p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1goll52uoxuj21bi05ogml.jpg" alt="image-20210316112824739" style="zoom:50%;"> <h3 id="_11-3-必要条件"><a href="#_11-3-必要条件" class="header-anchor">#</a> 11.3 必要条件</h3> <ul><li>互斥条件</li> <li>请求与保持条件</li> <li>不剥夺条件</li> <li>循环等待条件</li></ul> <h3 id="_11-4-如何定位死锁"><a href="#_11-4-如何定位死锁" class="header-anchor">#</a> 11.4 如何定位死锁</h3> <h4 id="法1-jstack"><a href="#法1-jstack" class="header-anchor">#</a> [法1-jstack]</h4> <ul><li><p>jps：找到在运行的程序的 PID</p></li> <li><p>jstack：打印出线程堆栈信息</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1golm6ubaj0j214y0k6gts.jpg" alt="image-20210316120512802"></p></li></ul> <h4 id="法2-threadmxbean"><a href="#法2-threadmxbean" class="header-anchor">#</a> [法2-ThreadMXBean]</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">deadlock</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">ManagementFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">ThreadInfo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">ThreadMXBean</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Hedon Wang
 * @create 2021-03-16 11:20 AM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MustDeadLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeadLockModel</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeadLockModel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ThreadMXBean帮助找到死锁</span>
        <span class="token class-name">ThreadMXBean</span> threadMXBean <span class="token operator">=</span> <span class="token class-name">ManagementFactory</span><span class="token punctuation">.</span><span class="token function">getThreadMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> deadlockedThreads <span class="token operator">=</span> threadMXBean<span class="token punctuation">.</span><span class="token function">findDeadlockedThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发现死锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deadlockedThreads <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> deadlockedThreads<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deadlockedThreads<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ThreadInfo</span> threadInfo <span class="token operator">=</span> threadMXBean<span class="token punctuation">.</span><span class="token function">getThreadInfo</span><span class="token punctuation">(</span>deadlockedThreads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;发现死锁了 ---&gt; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>threadInfo<span class="token punctuation">.</span><span class="token function">getThreadName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;两个线程都已经运行完毕~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DeadLockModel</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token comment">//两把锁</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> o1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//标志，一个线程运行一种情况</span>
    <span class="token keyword">int</span> flag<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DeadLockModel</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flag <span class="token operator">=</span> flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

            <span class="token comment">//申请第一把锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o1 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//故意等待5s钟，让第二个线程拿到o2锁</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//想要第二把锁</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o2 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经运行完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//申请第二把锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o2 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//故意等待2s钟，让第一个线程拿到o1锁</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已经拿到 o1 锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：</p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1golmcmjrbvj216g0843zy.jpg" alt="image-20210316121047131" style="zoom:50%;"> <h3 id="_11-5-解决措施"><a href="#_11-5-解决措施" class="header-anchor">#</a> 11.5 解决措施</h3> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 线上发生死锁怎么办？</span>
<span class="token list punctuation">1.</span> 线程问题都需要防患于未然，不造成损失地扑灭几乎是不可能的；
<span class="token list punctuation">2.</span> 保存案发现场然后立刻重启服务器；
<span class="token list punctuation">3.</span> 暂时保证线上服务的安全，然后再利用刚才保存的信息，排查死锁，修改代码，重新发版。
</code></pre></div><h4 id="_1-避免策略"><a href="#_1-避免策略" class="header-anchor">#</a> ① 避免策略</h4> <ul><li>哲学家就餐的换手方案、转账换序方案。</li></ul> <h4 id="_2-检测与恢复策略"><a href="#_2-检测与恢复策略" class="header-anchor">#</a> ② 检测与恢复策略</h4> <ul><li><p>一段时间检测是否有死锁，如果有就剥夺某一个资源来打开死锁。</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 死锁检查算法</span>
<span class="token list punctuation">1.</span> 每次调用锁都有记录，用一个图来记录；
<span class="token list punctuation">2.</span> 定期检查“锁的调用链路图”中是否存在环路；
<span class="token list punctuation">3.</span> 存在环路的话：①逐个终止线程，直到死锁消除；② 资源抢占：让部分线程回退几步（可能会造成饥饿）。
</code></pre></div></li></ul> <h4 id="_3-鸵鸟策略"><a href="#_3-鸵鸟策略" class="header-anchor">#</a> ③ 鸵鸟策略</h4> <ul><li>如果我们发送死锁的概率极其低，那么我们就直接忽略它，直到死锁发生的时候，再人工修复。</li></ul> <h3 id="_11-6-修复死锁"><a href="#_11-6-修复死锁" class="header-anchor">#</a> 11.6 修复死锁</h3> <h4 id="_1-换序解决转账问题"><a href="#_1-换序解决转账问题" class="header-anchor">#</a> ① 换序解决转账问题</h4> <p>规定顺序，一定先拿到 hashCode 小的那个对象的锁，然后再去拿大的锁。这样就不会造成我拿着自己的锁在等你的锁，而你也拿着自己的锁在等我的锁这样的死锁情况。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">deadlock</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 修复死锁：换序解决转账问题
 *
 * @author Hedon Wang
 * @create 2021-03-16 2:37 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SolveDeadLockByChangeOrder</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">int</span> flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Account</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Account</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SolveDeadLockByChangeOrder</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SolveDeadLockByChangeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SolveDeadLockByChangeOrder</span> s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SolveDeadLockByChangeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        s1<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        s2<span class="token punctuation">.</span>flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;a的余额&quot;</span> <span class="token operator">+</span> a<span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b的余额&quot;</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">transfer</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">transfer</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 转账
     *
     * @param from   从哪来
     * @param to     转哪去
     * @param amount 转多少
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">Account</span> from<span class="token punctuation">,</span> <span class="token class-name">Account</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token keyword">int</span> amount<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">class</span> <span class="token class-name">Helper</span><span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>from<span class="token punctuation">.</span>balance <span class="token operator">-</span> amount <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    from<span class="token punctuation">.</span>balance <span class="token operator">-=</span> amount<span class="token punctuation">;</span>
                    <span class="token keyword">to</span><span class="token punctuation">.</span>balance <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;成功转账 &quot;</span> <span class="token operator">+</span> amount <span class="token operator">+</span> <span class="token string">&quot;元。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;余额不足，转账失败。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//根据 hash 值来进行排序，小的排前面</span>
        <span class="token keyword">int</span> fromHash <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> toHash <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromHash <span class="token operator">&lt;</span> toHash<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">new</span> <span class="token class-name">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>fromHash <span class="token operator">&gt;</span> toHash<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">new</span> <span class="token class-name">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//相等的话，引入第三个锁，让他们竞争一下</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">new</span> <span class="token class-name">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 账户类
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Account</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> balance<span class="token punctuation">;</span>        <span class="token comment">//余额</span>
        <span class="token keyword">public</span> <span class="token class-name">Account</span><span class="token punctuation">(</span><span class="token keyword">int</span> balance<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">=</span> balance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-哲学家换手解决死锁"><a href="#_2-哲学家换手解决死锁" class="header-anchor">#</a> ② 哲学家换手解决死锁</h4> <p>演示死锁：五位哲学家都拿起了左边的筷子，都在等右边的筷子，形成闭环，这就导致了死锁。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 哲学家问题导致的死锁
 *
 * @author Hedon Wang
 * @create 2021-03-16 2:52 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Philosopher</span><span class="token punctuation">[</span><span class="token punctuation">]</span> philosophers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopsticks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>philosophers<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//初始化筷子</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chopsticks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chopsticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//初始化哲学家</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> philosophers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//左筷子</span>
            <span class="token class-name">Object</span> leftChopstick <span class="token operator">=</span> chopsticks<span class="token punctuation">[</span>i <span class="token operator">%</span> chopsticks<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//右筷子</span>
            <span class="token class-name">Object</span> rightChopstick <span class="token operator">=</span> chopsticks<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> chopsticks<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            philosophers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span>leftChopstick<span class="token punctuation">,</span>rightChopstick<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//启动</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>philosophers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 哲学家实体类
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Philosopher</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">Object</span> leftChopstick<span class="token punctuation">;</span>   <span class="token comment">//左边的筷子</span>
        <span class="token keyword">private</span> <span class="token class-name">Object</span> rightChopstick<span class="token punctuation">;</span>  <span class="token comment">//右边的筷子</span>
        
        <span class="token keyword">public</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token class-name">Object</span> leftChopstick<span class="token punctuation">,</span> <span class="token class-name">Object</span> rightChopstick<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>leftChopstick <span class="token operator">=</span> leftChopstick<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rightChopstick <span class="token operator">=</span> rightChopstick<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//思考</span>
                <span class="token function">thinking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//吃饭</span>
                <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 吃饭
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//拿起左边筷子</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>leftChopstick<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 拿起左边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//拿起右边筷子</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>rightChopstick<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 拿起右边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//吃饭</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 正在吃饭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家&quot;</span> <span class="token operator">+</span>  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot; 放下右边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家&quot;</span> <span class="token operator">+</span>  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot; 放下左边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 思考
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">thinking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 正在思考&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>结果：</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1golrjh6jmpj21s60ha0vr.jpg" alt="image-20210316151019001"></p> <p><font color="red">解决：其中一位哲学家换手，也就是先拿右边的，再拿左边的，这样就永远不可能出现<code>循环等待条件</code>。</font></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 哲学家问题解决
 *
 * @author Hedon Wang
 * @create 2021-03-16 2:52 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiningPhilosophers</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Philosopher</span><span class="token punctuation">[</span><span class="token punctuation">]</span> philosophers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chopsticks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>philosophers<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//初始化筷子</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chopsticks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chopsticks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//初始化哲学家</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> philosophers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//左筷子</span>
            <span class="token class-name">Object</span> leftChopstick <span class="token operator">=</span> chopsticks<span class="token punctuation">[</span>i <span class="token operator">%</span> chopsticks<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//右筷子</span>
            <span class="token class-name">Object</span> rightChopstick <span class="token operator">=</span> chopsticks<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> chopsticks<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//最后一位哲学家换手</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">==</span> philosophers<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
                philosophers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span>rightChopstick<span class="token punctuation">,</span>leftChopstick<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                philosophers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span>leftChopstick<span class="token punctuation">,</span>rightChopstick<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//启动</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>philosophers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 哲学家实体类
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Philosopher</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">Object</span> leftChopstick<span class="token punctuation">;</span>   <span class="token comment">//左边的筷子</span>
        <span class="token keyword">private</span> <span class="token class-name">Object</span> rightChopstick<span class="token punctuation">;</span>  <span class="token comment">//右边的筷子</span>
        
        <span class="token keyword">public</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token class-name">Object</span> leftChopstick<span class="token punctuation">,</span> <span class="token class-name">Object</span> rightChopstick<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>leftChopstick <span class="token operator">=</span> leftChopstick<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rightChopstick <span class="token operator">=</span> rightChopstick<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//思考</span>
                <span class="token function">thinking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//吃饭</span>
                <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 吃饭
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//拿起左边筷子</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>leftChopstick<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 拿起左边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//拿起右边筷子</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>rightChopstick<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 拿起右边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//吃饭</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 正在吃饭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家&quot;</span> <span class="token operator">+</span>  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot; 放下右边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家&quot;</span> <span class="token operator">+</span>  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot; 放下左边筷子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 思考
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">thinking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;哲学家 &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 正在思考&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>其他思路：</p> <ul><li>服务员检查（避免策略）：拿筷子之前询问一下服务员，服务员决定是否给筷子。</li> <li>餐票（避免策略）：吃饭之前必须拿到餐票才能车，n 个人只有 n-1 张餐票，保证一定会有人能拿到 2 支筷子。</li> <li>领导调节（检测与恢复策略）：领导定期巡视，如果出现死锁，命令一个哲学家放下筷子。</li></ul> <h3 id="_11-7-避免死锁"><a href="#_11-7-避免死锁" class="header-anchor">#</a> 11.7 避免死锁</h3> <ul><li>设置超时时间（ReentrantLock）</li> <li>使用并发类而不是自己设计锁</li></ul> <h2 id="_12-线程的活锁"><a href="#_12-线程的活锁" class="header-anchor">#</a> 12. 线程的活锁</h2> <blockquote><p>虽然线程并没有阻塞，也始终在运行，但是程序却得不到进展，因为线程始终重复做相同的事情。</p></blockquote> <p>在完全相同的时刻进入餐厅，并同时拿起左边的餐叉，那么这些哲学家就会等待五分钟，同时放下手中的餐叉，再等五分钟，又同时拿起这些餐叉。—— 缺乏共享资源</p> <p>程序一直在运行，但是做的事情没有意义。</p> <h3 id="_12-1-活锁演示"><a href="#_12-1-活锁演示" class="header-anchor">#</a> 12.1 活锁演示</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 活锁问题
 *
 * @author Hedon Wang
 * @create 2021-03-16 3:35 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LiveLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Diner</span> husband  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Diner</span><span class="token punctuation">(</span><span class="token string">&quot;牛郎&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Diner</span> wife <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Diner</span><span class="token punctuation">(</span><span class="token string">&quot;织女&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        husband<span class="token punctuation">.</span>isHungry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        wife<span class="token punctuation">.</span>isHungry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">Spoon</span> spoon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spoon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spoon<span class="token punctuation">.</span><span class="token function">setDiner</span><span class="token punctuation">(</span>husband<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                husband<span class="token punctuation">.</span><span class="token function">eatWith</span><span class="token punctuation">(</span>spoon<span class="token punctuation">,</span>wife<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wife<span class="token punctuation">.</span><span class="token function">eatWith</span><span class="token punctuation">(</span>spoon<span class="token punctuation">,</span>husband<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 勺子
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Spoon</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Diner</span> diner<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">Diner</span> <span class="token function">getDiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> diner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDiner</span><span class="token punctuation">(</span><span class="token class-name">Diner</span> diner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>diner <span class="token operator">=</span> diner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has eaten!&quot;</span><span class="token punctuation">,</span>diner<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 吃饭者
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Diner</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isHungry<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Diner</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * @param spoon 餐具
         * @param diner 一起就餐的人
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eatWith</span><span class="token punctuation">(</span><span class="token class-name">Spoon</span> spoon<span class="token punctuation">,</span> <span class="token class-name">Diner</span> diner<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>isHungry<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>spoon<span class="token punctuation">.</span>diner <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">//等待对方吃完</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">//对方饿了就把餐具让给对方</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>diner<span class="token punctuation">.</span>isHungry<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;让出了勺子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        spoon<span class="token punctuation">.</span>diner <span class="token operator">=</span> diner<span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//对方不饿的话就自己吃</span>
                spoon<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//吃完了</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>isHungry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;吃完了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                spoon<span class="token punctuation">.</span><span class="token function">setDiner</span><span class="token punctuation">(</span>diner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：互相谦让，一直在让，从未在吃。</p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1golsld2640j219q0b8ab2.jpg" alt="image-20210316154646859" style="zoom:50%;"> <h3 id="_12-2-解决措施"><a href="#_12-2-解决措施" class="header-anchor">#</a> 12.2 解决措施</h3> <ul><li>以太网的指数退避算法</li> <li>引入随机因素（就不是始终都在谦让）</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LiveLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Diner</span> husband  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Diner</span><span class="token punctuation">(</span><span class="token string">&quot;牛郎&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Diner</span> wife <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Diner</span><span class="token punctuation">(</span><span class="token string">&quot;织女&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        husband<span class="token punctuation">.</span>isHungry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        wife<span class="token punctuation">.</span>isHungry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token class-name">Spoon</span> spoon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spoon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spoon<span class="token punctuation">.</span><span class="token function">setDiner</span><span class="token punctuation">(</span>husband<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                husband<span class="token punctuation">.</span><span class="token function">eatWith</span><span class="token punctuation">(</span>spoon<span class="token punctuation">,</span>wife<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wife<span class="token punctuation">.</span><span class="token function">eatWith</span><span class="token punctuation">(</span>spoon<span class="token punctuation">,</span>husband<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 勺子
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Spoon</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">Diner</span> diner<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">Diner</span> <span class="token function">getDiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> diner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDiner</span><span class="token punctuation">(</span><span class="token class-name">Diner</span> diner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>diner <span class="token operator">=</span> diner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s has eaten!&quot;</span><span class="token punctuation">,</span>diner<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 吃饭者
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Diner</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isHungry<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Diner</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * @param spoon 餐具
         * @param diner 一起就餐的人
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eatWith</span><span class="token punctuation">(</span><span class="token class-name">Spoon</span> spoon<span class="token punctuation">,</span> <span class="token class-name">Diner</span> diner<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>isHungry<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>spoon<span class="token punctuation">.</span>diner <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">//等待对方吃完</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">//对方饿了就把餐具让给对方</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>diner<span class="token punctuation">.</span>isHungry<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//引入随机因素，一半的几率会让出勺子，一半的几率不让</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;让出了勺子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            spoon<span class="token punctuation">.</span>diner <span class="token operator">=</span> diner<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;决定不让出勺子=================&gt;&gt;&gt;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//对方不饿的话就自己吃</span>
                spoon<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//吃完了</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>isHungry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;吃完了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                spoon<span class="token punctuation">.</span><span class="token function">setDiner</span><span class="token punctuation">(</span>diner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：</p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1golsox12b0j21fk09ugmz.jpg" alt="image-20210316155010951" style="zoom:50%;"> <h2 id="_13-线程的饥饿"><a href="#_13-线程的饥饿" class="header-anchor">#</a> 13. 线程的饥饿</h2> <p>当线程需要某些资源（例如 CPU），但是始终得不到。</p> <p>别人要插队，一直谦让，就会源源不断有人来插队，自己一直饿着。</p> <h2 id="_14-线程的通信"><a href="#_14-线程的通信" class="header-anchor">#</a> 14. 线程的通信</h2> <h3 id="_14-1-object-类的三个重要方法"><a href="#_14-1-object-类的三个重要方法" class="header-anchor">#</a> 14.1 Object 类的三个重要方法</h3> <h4 id="_14-1-1-wait"><a href="#_14-1-1-wait" class="header-anchor">#</a> 14.1.1 wait()</h4> <ul><li>在当前线程中调用方法: 对象名.wait()；</li> <li>wait() 方法使当前线程进入等待(某对象)状态 ，直到：
<ul><li>另一线程对该对象发出 notify（或 notifyAll )）</li> <li>过了 wait(long timeout) 规定的超时时间，如果传入 0 就是永久等待</li> <li>线程自身调用了 interrupt()，会报 InterruptedException 异常，然后释放 monitor</li></ul></li> <li>调用方法的必要条件：<strong>当前线程必须具有对该对象的监控权(加锁)</strong> ；</li> <li>调用此方法后，当前线程将释放对象监控权 ，然后进入等待；</li> <li>在当前线程被 notify 后，要重新获得监控权，然后从断点处继续代码的执行。</li></ul> <h4 id="_14-1-2-notify"><a href="#_14-1-2-notify" class="header-anchor">#</a> 14.1.2 notify()</h4> <ul><li>唤醒正在排队等待同步资源的线程中优先级最高者结束等待。</li></ul> <h4 id="_14-1-3-notifyall"><a href="#_14-1-3-notifyall" class="header-anchor">#</a> 14.1.3 notifyAll()</h4> <ul><li>唤醒正在排队等待资源的所有线程结束等待。</li></ul> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 注意点</span>
① 这三个方法只有在 synchronized 方法或 synchronized 代码块中才能使用，否则会报 java.lang.IllegalMonitorStateException 异常。
② 因为这三个方法必须由锁对象调用，而任意对象都可以作为 synchronized 的同步锁，因此这三个方法只能在 Object 类中声明。
③ 这三个方法的调用者必须是同步代码块或同步方法中的同步监视器，否则会报 IllegalMonitorStateException 异常。

<span class="token title important"><span class="token punctuation">#</span> sleep() 和 wait() 的异同</span>
同：
<span class="token list punctuation">-</span> ① 一旦执行方法，都可以使得当前的线程进入阻塞状态；
异：
<span class="token list punctuation">-</span> ① 两个方法声明的位置不同：Thread 类中声明 sleep()，Object 类中声明 wait()
<span class="token list punctuation">-</span> ② 调用的要求不同：sleep() 可以在任何需要的场景下调用，wait() 必须是在用同步代码中
<span class="token list punctuation">-</span> ③ sleep() 不会释放同步监视器, wait() 会释放同步监视器，而且会加入到等待队列中
<span class="token list punctuation">-</span> ④ sleep() 不需要被唤醒（休眠之后推出阻塞），但是 wait() 需要（不指定时间需要被别人中断）
</code></pre></div><h3 id="_14-2-生产者-消费者问题"><a href="#_14-2-生产者-消费者问题" class="header-anchor">#</a> 14.2 生产者/消费者问题</h3> <h4 id="_14-2-1-题目"><a href="#_14-2-1-题目" class="header-anchor">#</a> 14.2.1 题目</h4> <p>生产者(Productor)将产品交给店员(Clerk)，而消费者(Customer)从店员处取走产品，店员一次只能持有固定数量的产品(比如:20)，如果生产者试图生产更多的产品，店员会叫生产者停一下，如果店中有空位放产品了再通知生产者继续生产；如果店中没有产品了，店员会告诉消费者等一下，如果店中有产品了再通知消费者来取走产品。</p> <ul><li>生产者比消费者快时，消费者会漏掉一些数据没有取到；</li> <li>消费者比生产者快时，消费者会取相同的数据。</li></ul> <h4 id="_14-2-2-法一-synchronized-搭配-wait-nofity"><a href="#_14-2-2-法一-synchronized-搭配-wait-nofity" class="header-anchor">#</a> 14.2.2 法一：synchronized 搭配 wait/nofity</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//产品</span>
<span class="token keyword">class</span> <span class="token class-name">Product</span><span class="token punctuation">{</span>
  
  	<span class="token comment">//产品个数</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//生产</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//超过20个，先等等</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">&gt;=</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;满20个了！消费者快来！================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者生产了第 &quot;</span><span class="token operator">+</span>count<span class="token operator">+</span><span class="token string">&quot; 个产品。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//现在肯定有产品了，赶紧通知人来消费</span>
            <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//消费</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//没产品了，咱就先候着</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;*******************没货啦！生产者在哪里！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者消费了第：&quot;</span><span class="token operator">+</span>count<span class="token operator">+</span><span class="token string">&quot; 个产品。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token comment">//消费了1个，现在肯定还有位置可以放，通知生产者可以继续生产了</span>
            <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//生产者</span>
<span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Product</span> product<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>product <span class="token operator">=</span> product<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//随机生产速度</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            product<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//消费者</span>
<span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Product</span> product<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">Product</span> product<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>product <span class="token operator">=</span> product<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">//随机消费速度</span>
                <span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            product<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Product</span> product <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Producer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>

        producer<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;生产者&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;消费者&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_14-2-3-法二-blockingqueue"><a href="#_14-2-3-法二-blockingqueue" class="header-anchor">#</a> 14.2.3 法二：BlockingQueue</h4> <h2 id="_15-面试问题"><a href="#_15-面试问题" class="header-anchor">#</a> 15. 面试问题</h2> <h3 id="_1-start-和-run-的区别"><a href="#_1-start-和-run-的区别" class="header-anchor">#</a> 1. start() 和 run() 的区别？</h3> <blockquote><ol><li>调用 run() 的话就只是调用普通调用；</li> <li>调用 start() 的话，会由 JVM 去调用 run() 方法，JVM 在调用 run() 的时候就去创建一个新的线程，让它来调用 run() 方法；</li> <li>start() 做三件事：① 启动新线程检查线程状态；② 加入线程组；③ 调用 start0()</li></ol></blockquote> <h3 id="_2-一个线程两次调用-start-方法会出现什么情况-为什么"><a href="#_2-一个线程两次调用-start-方法会出现什么情况-为什么" class="header-anchor">#</a> 2. 一个线程两次调用 start() 方法会出现什么情况？为什么？</h3> <blockquote><p>会报 IllegalMonitorStateException 异常。</p> <p>因为调用 start() 方法会对当前线程的状态进行检查，一个线程的状态先从 new，再到 runnable，最后到 terminated。一个线程调用了 start() 方法后就进入这些状态中的一个了，所以检查不通过，就报错了。</p></blockquote> <h3 id="_3-既然-start-方法会调用-run-方法-为什么不直接调用-run-呢"><a href="#_3-既然-start-方法会调用-run-方法-为什么不直接调用-run-呢" class="header-anchor">#</a> 3. 既然 start() 方法会调用 run() 方法，为什么不直接调用 run() 呢？</h3> <blockquote><p>因为调用 start() 方法开始真正意义上创建一个新的线程，run() 只是普通调用。</p></blockquote> <h3 id="_4-thread-sleep-1000-1000ms后是否立即执行"><a href="#_4-thread-sleep-1000-1000ms后是否立即执行" class="header-anchor">#</a> 4. Thread.sleep(1000)， 1000ms后是否立即执行?</h3> <blockquote><p>不一定，在未来的 1000 毫秒内，线程不想再参与到 CPU 竞争。那么 1000 毫秒过去之后，这时候也许另外一个
线程正在使用C PU，那么这时候操作系统是不会重新分配 CPU 的，直到那个线程挂起或结束；
况且，即使这个时候恰巧轮到操作系统进行CPU分配，那么当前线程也不一定就是总优先级最高的那个，CPU还是可能被其他线程抢占去。</p></blockquote> <h3 id="_5-thread-sleep-0-是否有用"><a href="#_5-thread-sleep-0-是否有用" class="header-anchor">#</a> 5. Thread.sleep(0) 是否有用?</h3> <blockquote><p>Thread. Sleep(0) 的作用，就是触发操作系统立刻重新进行一次 CPU 竞争，重新计算优先级。竞争的结果也许
是当前线程仍然获得 CPU 控制权，也许会换成别的线程获得 CPU 控制权。这也是我们在大循环里面经常会写一
句 Thread.sleep(0)，因为这样就给了其他线程比如 Paint 线程获得 CPU 控制权的权力，这样界面就不会假死在
那里。</p></blockquote> <h3 id="_6-线程交替打印"><a href="#_6-线程交替打印" class="header-anchor">#</a> 6. 线程交替打印</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 四个线程（ABCD），写一个程序，按照以下要求输出字符串，4个线程总共输出1000次即可
 * &lt;p&gt;
 * 线程A=1
 * 线程B=2
 * 线程C=3
 * 线程D=4
 * 线程A=1
 * 线程B=2
 * 线程C=3
 * 线程D=4
 * （以下重复）
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FourThreadPrintThousand</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token comment">//声明4把锁</span>
        <span class="token class-name">Object</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ThreadPrinter</span> threadA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPrinter</span><span class="token punctuation">(</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> d<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadPrinter</span> threadB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPrinter</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadPrinter</span> threadC <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPrinter</span><span class="token punctuation">(</span><span class="token string">&quot;C&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadPrinter</span> threadD <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPrinter</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//确保 ABCD 顺序运行</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadC<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>threadD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ThreadPrinter</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> threadName<span class="token punctuation">;</span>  <span class="token comment">//线程名称</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> number<span class="token punctuation">;</span>         <span class="token comment">//线程要打印的数字</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> preLock<span class="token punctuation">;</span>     <span class="token comment">//前一个线程的锁</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> selfLock<span class="token punctuation">;</span>    <span class="token comment">//当前线程的锁</span>


    <span class="token keyword">public</span> <span class="token class-name">ThreadPrinter</span><span class="token punctuation">(</span><span class="token class-name">String</span> threadName<span class="token punctuation">,</span> <span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token class-name">Object</span> preLock<span class="token punctuation">,</span> <span class="token class-name">Object</span> selfLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>threadName <span class="token operator">=</span> threadName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>number <span class="token operator">=</span> number<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>preLock <span class="token operator">=</span> preLock<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selfLock <span class="token operator">=</span> selfLock<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//先获取 preLock，因为必须要前一个线程释放了其对应的对象锁，本线程才可以操作</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>preLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//然后再获取当前线程锁</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>selfLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//打印</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>threadName <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    count<span class="token operator">--</span><span class="token punctuation">;</span>

                    <span class="token comment">//当前线程操作完后，唤醒其他被当前线程锁住的线程</span>
                    selfLock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//如果count为0,说明这是最后一次打印操作，通过 notifyAll 操作释放对象锁。</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        preLock<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">//释放上一个锁</span>
                        preLock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_9-为什么-wait-需要放在-synchronized-代码块中而-sleep-不需要"><a href="#_9-为什么-wait-需要放在-synchronized-代码块中而-sleep-不需要" class="header-anchor">#</a> 9. 为什么 wait() 需要放在 synchronized 代码块中而  sleep() 不需要？</h3> <blockquote><p>为了避免死锁。设计者的思路是先 wait() 在 notify()。</p> <p>限制 wait() 只能在 synchronized 代码块中可以保证调用 wait() 的对象拥有本身这把锁，而不会出现还没 wait() 的时候其他地方就已经调用完 notify() 了，导致后面没人来 notify() 而一直处于等待状态。</p></blockquote> <h3 id="_10-为什么-wait-、notify-和-notifyall-放在-object-类中而-sleep-放在-thread-中"><a href="#_10-为什么-wait-、notify-和-notifyall-放在-object-类中而-sleep-放在-thread-中" class="header-anchor">#</a> 10. 为什么 wait()、notify() 和 notifyAll() 放在 Object 类中而 sleep() 放在 Thread 中？</h3> <blockquote><p>wait()、notify() 和 notifyAll() 是一个锁级别的操作，该锁是绑定到某一个对象中的，而不是绑定到线程中。</p> <p>这样还有另外一个好处，一个线程可以拥有多把锁，更加灵活。</p></blockquote> <h3 id="_11-守护线程和普通线程的区别"><a href="#_11-守护线程和普通线程的区别" class="header-anchor">#</a> 11. 守护线程和普通线程的区别</h3> <blockquote><p>二者整体上没有什么区别。</p> <p>主要是区别点是如果所有线程都是守护线程的话，那么所有守护线程会和 JVM 一起停止工作。</p> <p>同时普通线程是执行我们逻辑的，而守护线程的服务于我们的普通线程的。</p></blockquote> <h3 id="_12-我们是否需要给线程设置为守护线程"><a href="#_12-我们是否需要给线程设置为守护线程" class="header-anchor">#</a> 12. 我们是否需要给线程设置为守护线程？</h3> <blockquote><p>不是需不需要，而是应不应该。</p> <p>这里是不应该的，因为如果这个线程还有工作没有完成，而其他普通线程都已经完成了，那么所有守护线程和 JVM 会一起停止工作，这样就会导致有部分工作没有完成。</p></blockquote> <h3 id="_13-java-异常体系图"><a href="#_13-java-异常体系图" class="header-anchor">#</a> 13. Java 异常体系图</h3> <h3 id="_14-实际工作中-如何全局处理异常-为什么要全局处理-不处理行不行"><a href="#_14-实际工作中-如何全局处理异常-为什么要全局处理-不处理行不行" class="header-anchor">#</a> 14. 实际工作中，如何全局处理异常？为什么要全局处理？不处理行不行？</h3> <blockquote><p>用一个 UncaughtExceptionHandler，然后在主线程中设置其为全局异常处理器。</p></blockquote> <h3 id="_15-写一个必然死锁的例子-生产者什么场景下回发生死锁"><a href="#_15-写一个必然死锁的例子-生产者什么场景下回发生死锁" class="header-anchor">#</a> 15. 写一个必然死锁的例子，生产者什么场景下回发生死锁？</h3> <blockquote><p>一个方法中占有多种锁，锁存在循环。</p></blockquote> <h3 id="_16-死锁的四个必要条件"><a href="#_16-死锁的四个必要条件" class="header-anchor">#</a> 16. 死锁的四个必要条件</h3> <blockquote><p>互斥条件</p> <p>请求与保持条件</p> <p>不剥夺条件</p> <p>循环等待条件</p></blockquote> <h3 id="_17-如何定位死锁"><a href="#_17-如何定位死锁" class="header-anchor">#</a> 17. 如何定位死锁？</h3> <blockquote><p>jps + jstack</p> <p>ThreadMXBean</p></blockquote> <h3 id="_18-有哪些解决死锁问题的策略"><a href="#_18-有哪些解决死锁问题的策略" class="header-anchor">#</a> 18. 有哪些解决死锁问题的策略？</h3> <blockquote><p>① 避免策略：哲学家就餐换手、转账换序方案</p> <p>② 检测与恢复策略</p> <p>③ 鸵鸟策略</p></blockquote> <h3 id="_19-哲学家就餐问题"><a href="#_19-哲学家就餐问题" class="header-anchor">#</a> 19. 哲学家就餐问题</h3> <h3 id="_20-实际工程中如何避免死锁"><a href="#_20-实际工程中如何避免死锁" class="header-anchor">#</a> 20. 实际工程中如何避免死锁？</h3> <blockquote><p>① 设置超时时间</p> <p>② 使用并发工具类</p> <p>③ 降低锁的粒度</p> <p>④ synchronized</p> <p>⑤ 线程起名字，便于 debug</p> <p>⑥ 避免锁的嵌套</p> <p>⑦ 专锁专用</p></blockquote> <h3 id="_21-什么是活跃性问题-活锁、饥饿和死锁有什么区别"><a href="#_21-什么是活跃性问题-活锁、饥饿和死锁有什么区别" class="header-anchor">#</a> 21. 什么是活跃性问题？活锁、饥饿和死锁有什么区别？</h3> <blockquote><p>活锁：一直在运行，但是一直没进展</p> <p>饥饿：一个人一直得不到 CPU 资源，一直在等待</p> <p>死锁：一群人一直在互相等待，互不谦让</p></blockquote> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/27/2021, 10:33:23 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/java/concurrent/synchronized.html" class="prev">
        Synchronized
      </a></span> <span class="next"><a href="/noteSite/backend/java/juc/01-threadpool.html">
        一、线程池
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.bcda4898.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/65.445b3f90.js" defer></script>
  </body>
</html>
