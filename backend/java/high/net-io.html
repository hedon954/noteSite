<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaSE —— BIO/NIO/AIO | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.bd2eec7c.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/71.69a8329a.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.628f2b18.js"><link rel="prefetch" href="/noteSite/assets/js/100.7ca68cf6.js"><link rel="prefetch" href="/noteSite/assets/js/101.3ec8c27f.js"><link rel="prefetch" href="/noteSite/assets/js/102.e335645f.js"><link rel="prefetch" href="/noteSite/assets/js/103.fdcda50f.js"><link rel="prefetch" href="/noteSite/assets/js/104.5c8fedec.js"><link rel="prefetch" href="/noteSite/assets/js/105.721fdfb0.js"><link rel="prefetch" href="/noteSite/assets/js/106.29718338.js"><link rel="prefetch" href="/noteSite/assets/js/107.140f58aa.js"><link rel="prefetch" href="/noteSite/assets/js/108.fee713e2.js"><link rel="prefetch" href="/noteSite/assets/js/109.7200bc48.js"><link rel="prefetch" href="/noteSite/assets/js/11.0f1631cd.js"><link rel="prefetch" href="/noteSite/assets/js/110.91c77482.js"><link rel="prefetch" href="/noteSite/assets/js/111.0773e203.js"><link rel="prefetch" href="/noteSite/assets/js/112.5f252bfb.js"><link rel="prefetch" href="/noteSite/assets/js/113.a10a72d6.js"><link rel="prefetch" href="/noteSite/assets/js/114.d7545a94.js"><link rel="prefetch" href="/noteSite/assets/js/115.d4223625.js"><link rel="prefetch" href="/noteSite/assets/js/116.55a420ff.js"><link rel="prefetch" href="/noteSite/assets/js/117.1fe4b76a.js"><link rel="prefetch" href="/noteSite/assets/js/118.3ec9591b.js"><link rel="prefetch" href="/noteSite/assets/js/119.8db13744.js"><link rel="prefetch" href="/noteSite/assets/js/12.c90a7522.js"><link rel="prefetch" href="/noteSite/assets/js/120.ac60d308.js"><link rel="prefetch" href="/noteSite/assets/js/121.d218cf75.js"><link rel="prefetch" href="/noteSite/assets/js/122.55bed989.js"><link rel="prefetch" href="/noteSite/assets/js/123.1c0794c8.js"><link rel="prefetch" href="/noteSite/assets/js/124.8e17dc21.js"><link rel="prefetch" href="/noteSite/assets/js/125.84079b1f.js"><link rel="prefetch" href="/noteSite/assets/js/126.add326fd.js"><link rel="prefetch" href="/noteSite/assets/js/127.7b7caf3e.js"><link rel="prefetch" href="/noteSite/assets/js/128.ad6aa19e.js"><link rel="prefetch" href="/noteSite/assets/js/129.83d70ca4.js"><link rel="prefetch" href="/noteSite/assets/js/13.f5480015.js"><link rel="prefetch" href="/noteSite/assets/js/130.10d0158c.js"><link rel="prefetch" href="/noteSite/assets/js/131.d8842462.js"><link rel="prefetch" href="/noteSite/assets/js/132.068e675f.js"><link rel="prefetch" href="/noteSite/assets/js/133.069a1a01.js"><link rel="prefetch" href="/noteSite/assets/js/134.0ff18d15.js"><link rel="prefetch" href="/noteSite/assets/js/135.c2899a28.js"><link rel="prefetch" href="/noteSite/assets/js/136.11ecc747.js"><link rel="prefetch" href="/noteSite/assets/js/137.e00c1b9f.js"><link rel="prefetch" href="/noteSite/assets/js/138.ea14543e.js"><link rel="prefetch" href="/noteSite/assets/js/139.61b6db90.js"><link rel="prefetch" href="/noteSite/assets/js/14.25e91c17.js"><link rel="prefetch" href="/noteSite/assets/js/140.4bfe5614.js"><link rel="prefetch" href="/noteSite/assets/js/141.c8c2d8ea.js"><link rel="prefetch" href="/noteSite/assets/js/142.fb6767fd.js"><link rel="prefetch" href="/noteSite/assets/js/143.6f3edcc3.js"><link rel="prefetch" href="/noteSite/assets/js/144.0bb87dad.js"><link rel="prefetch" href="/noteSite/assets/js/145.83e0596a.js"><link rel="prefetch" href="/noteSite/assets/js/146.59b8ec7f.js"><link rel="prefetch" href="/noteSite/assets/js/147.c0a79bfa.js"><link rel="prefetch" href="/noteSite/assets/js/148.535012ea.js"><link rel="prefetch" href="/noteSite/assets/js/149.d7beaff3.js"><link rel="prefetch" href="/noteSite/assets/js/15.6fd503b0.js"><link rel="prefetch" href="/noteSite/assets/js/150.4d02fe32.js"><link rel="prefetch" href="/noteSite/assets/js/151.3b8e2c5e.js"><link rel="prefetch" href="/noteSite/assets/js/152.0b3941f8.js"><link rel="prefetch" href="/noteSite/assets/js/153.06324daa.js"><link rel="prefetch" href="/noteSite/assets/js/154.5373289c.js"><link rel="prefetch" href="/noteSite/assets/js/155.3d608b91.js"><link rel="prefetch" href="/noteSite/assets/js/156.6426d84c.js"><link rel="prefetch" href="/noteSite/assets/js/157.43554f21.js"><link rel="prefetch" href="/noteSite/assets/js/158.55aba470.js"><link rel="prefetch" href="/noteSite/assets/js/159.ecf017c9.js"><link rel="prefetch" href="/noteSite/assets/js/16.bbb3b0e4.js"><link rel="prefetch" href="/noteSite/assets/js/160.f51c86e8.js"><link rel="prefetch" href="/noteSite/assets/js/161.cf80c8b7.js"><link rel="prefetch" href="/noteSite/assets/js/162.3c9e9570.js"><link rel="prefetch" href="/noteSite/assets/js/163.c25e9714.js"><link rel="prefetch" href="/noteSite/assets/js/164.dd6a24a5.js"><link rel="prefetch" href="/noteSite/assets/js/165.597ccef9.js"><link rel="prefetch" href="/noteSite/assets/js/166.c1909db4.js"><link rel="prefetch" href="/noteSite/assets/js/167.68a92314.js"><link rel="prefetch" href="/noteSite/assets/js/168.40785599.js"><link rel="prefetch" href="/noteSite/assets/js/169.8207e533.js"><link rel="prefetch" href="/noteSite/assets/js/17.8b015d56.js"><link rel="prefetch" href="/noteSite/assets/js/170.d80a3df4.js"><link rel="prefetch" href="/noteSite/assets/js/171.ff8b61bd.js"><link rel="prefetch" href="/noteSite/assets/js/172.bb459e74.js"><link rel="prefetch" href="/noteSite/assets/js/173.5f1f3dd7.js"><link rel="prefetch" href="/noteSite/assets/js/174.ac394194.js"><link rel="prefetch" href="/noteSite/assets/js/175.5cbe7ad5.js"><link rel="prefetch" href="/noteSite/assets/js/176.fee40359.js"><link rel="prefetch" href="/noteSite/assets/js/177.88aad887.js"><link rel="prefetch" href="/noteSite/assets/js/178.723c48c9.js"><link rel="prefetch" href="/noteSite/assets/js/179.5eb8a55b.js"><link rel="prefetch" href="/noteSite/assets/js/18.d9742110.js"><link rel="prefetch" href="/noteSite/assets/js/180.359f8fc7.js"><link rel="prefetch" href="/noteSite/assets/js/181.111a9153.js"><link rel="prefetch" href="/noteSite/assets/js/182.6c8c8fa8.js"><link rel="prefetch" href="/noteSite/assets/js/183.dc9920c4.js"><link rel="prefetch" href="/noteSite/assets/js/184.55410779.js"><link rel="prefetch" href="/noteSite/assets/js/185.f258641d.js"><link rel="prefetch" href="/noteSite/assets/js/186.25b7c434.js"><link rel="prefetch" href="/noteSite/assets/js/187.27815247.js"><link rel="prefetch" href="/noteSite/assets/js/188.144d6601.js"><link rel="prefetch" href="/noteSite/assets/js/189.f9b42496.js"><link rel="prefetch" href="/noteSite/assets/js/19.811bf034.js"><link rel="prefetch" href="/noteSite/assets/js/190.d8b95ca2.js"><link rel="prefetch" href="/noteSite/assets/js/191.09401d7f.js"><link rel="prefetch" href="/noteSite/assets/js/192.75b05832.js"><link rel="prefetch" href="/noteSite/assets/js/193.cd0ed807.js"><link rel="prefetch" href="/noteSite/assets/js/194.6a82b17f.js"><link rel="prefetch" href="/noteSite/assets/js/195.8b9aed53.js"><link rel="prefetch" href="/noteSite/assets/js/196.a9f2a282.js"><link rel="prefetch" href="/noteSite/assets/js/197.f4118182.js"><link rel="prefetch" href="/noteSite/assets/js/198.55b9d6db.js"><link rel="prefetch" href="/noteSite/assets/js/199.971278e3.js"><link rel="prefetch" href="/noteSite/assets/js/20.78824865.js"><link rel="prefetch" href="/noteSite/assets/js/200.38d5aea5.js"><link rel="prefetch" href="/noteSite/assets/js/201.9486cf17.js"><link rel="prefetch" href="/noteSite/assets/js/202.4af91c67.js"><link rel="prefetch" href="/noteSite/assets/js/203.40a336d1.js"><link rel="prefetch" href="/noteSite/assets/js/204.ed0135d4.js"><link rel="prefetch" href="/noteSite/assets/js/205.d841779b.js"><link rel="prefetch" href="/noteSite/assets/js/206.c1a6e004.js"><link rel="prefetch" href="/noteSite/assets/js/207.8727d2f0.js"><link rel="prefetch" href="/noteSite/assets/js/208.e7d76abb.js"><link rel="prefetch" href="/noteSite/assets/js/209.caa140f0.js"><link rel="prefetch" href="/noteSite/assets/js/21.3060b19d.js"><link rel="prefetch" href="/noteSite/assets/js/210.acf7578a.js"><link rel="prefetch" href="/noteSite/assets/js/211.99217e58.js"><link rel="prefetch" href="/noteSite/assets/js/212.a835c98a.js"><link rel="prefetch" href="/noteSite/assets/js/213.38b7cc2d.js"><link rel="prefetch" href="/noteSite/assets/js/214.d48228c0.js"><link rel="prefetch" href="/noteSite/assets/js/215.a30bd463.js"><link rel="prefetch" href="/noteSite/assets/js/216.4641e8c7.js"><link rel="prefetch" href="/noteSite/assets/js/217.78568faa.js"><link rel="prefetch" href="/noteSite/assets/js/218.9f011909.js"><link rel="prefetch" href="/noteSite/assets/js/219.9ce9d6a1.js"><link rel="prefetch" href="/noteSite/assets/js/22.a4945f58.js"><link rel="prefetch" href="/noteSite/assets/js/220.538d10ec.js"><link rel="prefetch" href="/noteSite/assets/js/221.2dc4c8de.js"><link rel="prefetch" href="/noteSite/assets/js/222.ab254ffa.js"><link rel="prefetch" href="/noteSite/assets/js/223.aac8264a.js"><link rel="prefetch" href="/noteSite/assets/js/224.349df0b6.js"><link rel="prefetch" href="/noteSite/assets/js/225.6561ba98.js"><link rel="prefetch" href="/noteSite/assets/js/226.a0a673cd.js"><link rel="prefetch" href="/noteSite/assets/js/227.f08c2ac5.js"><link rel="prefetch" href="/noteSite/assets/js/228.4d8c8d9e.js"><link rel="prefetch" href="/noteSite/assets/js/229.28a58da8.js"><link rel="prefetch" href="/noteSite/assets/js/23.079aa224.js"><link rel="prefetch" href="/noteSite/assets/js/230.80a8115e.js"><link rel="prefetch" href="/noteSite/assets/js/231.db7cc581.js"><link rel="prefetch" href="/noteSite/assets/js/232.0a1887b8.js"><link rel="prefetch" href="/noteSite/assets/js/233.08577c84.js"><link rel="prefetch" href="/noteSite/assets/js/234.f803aa39.js"><link rel="prefetch" href="/noteSite/assets/js/235.eea81382.js"><link rel="prefetch" href="/noteSite/assets/js/236.5d559daa.js"><link rel="prefetch" href="/noteSite/assets/js/237.b280ff38.js"><link rel="prefetch" href="/noteSite/assets/js/238.ab8fba20.js"><link rel="prefetch" href="/noteSite/assets/js/239.d747fd3f.js"><link rel="prefetch" href="/noteSite/assets/js/24.1a933e6c.js"><link rel="prefetch" href="/noteSite/assets/js/240.2a0abba7.js"><link rel="prefetch" href="/noteSite/assets/js/241.d5d87bca.js"><link rel="prefetch" href="/noteSite/assets/js/242.f603233d.js"><link rel="prefetch" href="/noteSite/assets/js/243.a12a5b58.js"><link rel="prefetch" href="/noteSite/assets/js/244.10054be5.js"><link rel="prefetch" href="/noteSite/assets/js/245.14c7ae1b.js"><link rel="prefetch" href="/noteSite/assets/js/246.88b92c41.js"><link rel="prefetch" href="/noteSite/assets/js/247.81eec9e7.js"><link rel="prefetch" href="/noteSite/assets/js/248.3dc6acbf.js"><link rel="prefetch" href="/noteSite/assets/js/249.e76336bc.js"><link rel="prefetch" href="/noteSite/assets/js/25.df04ad1a.js"><link rel="prefetch" href="/noteSite/assets/js/250.1a52d524.js"><link rel="prefetch" href="/noteSite/assets/js/251.f5425089.js"><link rel="prefetch" href="/noteSite/assets/js/252.f2f132ed.js"><link rel="prefetch" href="/noteSite/assets/js/253.f0a8a1ce.js"><link rel="prefetch" href="/noteSite/assets/js/254.d2f5d459.js"><link rel="prefetch" href="/noteSite/assets/js/255.4675af9d.js"><link rel="prefetch" href="/noteSite/assets/js/256.43a008e8.js"><link rel="prefetch" href="/noteSite/assets/js/257.36fa2928.js"><link rel="prefetch" href="/noteSite/assets/js/258.aea85972.js"><link rel="prefetch" href="/noteSite/assets/js/259.7f819da2.js"><link rel="prefetch" href="/noteSite/assets/js/26.4eb6fe37.js"><link rel="prefetch" href="/noteSite/assets/js/260.b0461665.js"><link rel="prefetch" href="/noteSite/assets/js/261.b8ac8008.js"><link rel="prefetch" href="/noteSite/assets/js/262.24d525c4.js"><link rel="prefetch" href="/noteSite/assets/js/263.86ed03b9.js"><link rel="prefetch" href="/noteSite/assets/js/264.0b8cfd9d.js"><link rel="prefetch" href="/noteSite/assets/js/265.1829dfa9.js"><link rel="prefetch" href="/noteSite/assets/js/266.760d5513.js"><link rel="prefetch" href="/noteSite/assets/js/267.3017b3f9.js"><link rel="prefetch" href="/noteSite/assets/js/268.b5c8bc79.js"><link rel="prefetch" href="/noteSite/assets/js/269.872e420f.js"><link rel="prefetch" href="/noteSite/assets/js/27.4f9dbcf8.js"><link rel="prefetch" href="/noteSite/assets/js/270.290f869f.js"><link rel="prefetch" href="/noteSite/assets/js/271.94b66974.js"><link rel="prefetch" href="/noteSite/assets/js/272.91917ac6.js"><link rel="prefetch" href="/noteSite/assets/js/273.1d144dda.js"><link rel="prefetch" href="/noteSite/assets/js/274.8399e077.js"><link rel="prefetch" href="/noteSite/assets/js/275.478e7988.js"><link rel="prefetch" href="/noteSite/assets/js/276.6e9572ba.js"><link rel="prefetch" href="/noteSite/assets/js/277.078c22c4.js"><link rel="prefetch" href="/noteSite/assets/js/278.25a3b693.js"><link rel="prefetch" href="/noteSite/assets/js/279.29af8d3f.js"><link rel="prefetch" href="/noteSite/assets/js/28.8963a888.js"><link rel="prefetch" href="/noteSite/assets/js/280.9aed4efa.js"><link rel="prefetch" href="/noteSite/assets/js/281.b9737e9c.js"><link rel="prefetch" href="/noteSite/assets/js/282.09573ede.js"><link rel="prefetch" href="/noteSite/assets/js/283.b69937e2.js"><link rel="prefetch" href="/noteSite/assets/js/284.b82424ce.js"><link rel="prefetch" href="/noteSite/assets/js/285.a81a759f.js"><link rel="prefetch" href="/noteSite/assets/js/286.64a5eb61.js"><link rel="prefetch" href="/noteSite/assets/js/287.87aca343.js"><link rel="prefetch" href="/noteSite/assets/js/288.8b894f83.js"><link rel="prefetch" href="/noteSite/assets/js/289.ec88668a.js"><link rel="prefetch" href="/noteSite/assets/js/29.6cba673a.js"><link rel="prefetch" href="/noteSite/assets/js/290.af4b9a88.js"><link rel="prefetch" href="/noteSite/assets/js/291.858cb346.js"><link rel="prefetch" href="/noteSite/assets/js/292.b0b368e2.js"><link rel="prefetch" href="/noteSite/assets/js/293.5d320535.js"><link rel="prefetch" href="/noteSite/assets/js/294.acc0d312.js"><link rel="prefetch" href="/noteSite/assets/js/295.6be2d4f5.js"><link rel="prefetch" href="/noteSite/assets/js/296.783aa504.js"><link rel="prefetch" href="/noteSite/assets/js/297.d7a51034.js"><link rel="prefetch" href="/noteSite/assets/js/298.0028f8e5.js"><link rel="prefetch" href="/noteSite/assets/js/299.3cc9c9e8.js"><link rel="prefetch" href="/noteSite/assets/js/3.01ff9906.js"><link rel="prefetch" href="/noteSite/assets/js/30.0be426ff.js"><link rel="prefetch" href="/noteSite/assets/js/300.7215ac2f.js"><link rel="prefetch" href="/noteSite/assets/js/301.1f7507df.js"><link rel="prefetch" href="/noteSite/assets/js/302.45e8ef80.js"><link rel="prefetch" href="/noteSite/assets/js/303.f14aacb6.js"><link rel="prefetch" href="/noteSite/assets/js/304.0f46dc9c.js"><link rel="prefetch" href="/noteSite/assets/js/305.1ea0c673.js"><link rel="prefetch" href="/noteSite/assets/js/306.6feb2e67.js"><link rel="prefetch" href="/noteSite/assets/js/307.2495f1d8.js"><link rel="prefetch" href="/noteSite/assets/js/308.7ed44a2e.js"><link rel="prefetch" href="/noteSite/assets/js/31.3affb8bf.js"><link rel="prefetch" href="/noteSite/assets/js/32.9594ce12.js"><link rel="prefetch" href="/noteSite/assets/js/33.eb71398f.js"><link rel="prefetch" href="/noteSite/assets/js/34.85f8d0f4.js"><link rel="prefetch" href="/noteSite/assets/js/35.543c629f.js"><link rel="prefetch" href="/noteSite/assets/js/36.a2f9b5ef.js"><link rel="prefetch" href="/noteSite/assets/js/37.8c70cc71.js"><link rel="prefetch" href="/noteSite/assets/js/38.197326c0.js"><link rel="prefetch" href="/noteSite/assets/js/39.3235028f.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/40.bb4e9d8d.js"><link rel="prefetch" href="/noteSite/assets/js/41.bca6e7f2.js"><link rel="prefetch" href="/noteSite/assets/js/42.05904970.js"><link rel="prefetch" href="/noteSite/assets/js/43.b66267b7.js"><link rel="prefetch" href="/noteSite/assets/js/44.51fea18b.js"><link rel="prefetch" href="/noteSite/assets/js/45.c6ba8a4d.js"><link rel="prefetch" href="/noteSite/assets/js/46.af6bc4ca.js"><link rel="prefetch" href="/noteSite/assets/js/47.3e3893e2.js"><link rel="prefetch" href="/noteSite/assets/js/48.0af901d8.js"><link rel="prefetch" href="/noteSite/assets/js/49.2d8c3f04.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.118c4f5c.js"><link rel="prefetch" href="/noteSite/assets/js/51.c5eefaf9.js"><link rel="prefetch" href="/noteSite/assets/js/52.4ff44c2e.js"><link rel="prefetch" href="/noteSite/assets/js/53.85a2b5e3.js"><link rel="prefetch" href="/noteSite/assets/js/54.186fd282.js"><link rel="prefetch" href="/noteSite/assets/js/55.2a874220.js"><link rel="prefetch" href="/noteSite/assets/js/56.ef3d5c38.js"><link rel="prefetch" href="/noteSite/assets/js/57.106c99d0.js"><link rel="prefetch" href="/noteSite/assets/js/58.64857b0f.js"><link rel="prefetch" href="/noteSite/assets/js/59.66ca90c3.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.80b00377.js"><link rel="prefetch" href="/noteSite/assets/js/61.761c797a.js"><link rel="prefetch" href="/noteSite/assets/js/62.a8804c76.js"><link rel="prefetch" href="/noteSite/assets/js/63.7f590648.js"><link rel="prefetch" href="/noteSite/assets/js/64.1d0b611f.js"><link rel="prefetch" href="/noteSite/assets/js/65.445b3f90.js"><link rel="prefetch" href="/noteSite/assets/js/66.56415d50.js"><link rel="prefetch" href="/noteSite/assets/js/67.e8296499.js"><link rel="prefetch" href="/noteSite/assets/js/68.940725b6.js"><link rel="prefetch" href="/noteSite/assets/js/69.c793ef18.js"><link rel="prefetch" href="/noteSite/assets/js/7.f685cce4.js"><link rel="prefetch" href="/noteSite/assets/js/70.c7cfccac.js"><link rel="prefetch" href="/noteSite/assets/js/72.3a1ea709.js"><link rel="prefetch" href="/noteSite/assets/js/73.147b232f.js"><link rel="prefetch" href="/noteSite/assets/js/74.3dd31a8d.js"><link rel="prefetch" href="/noteSite/assets/js/75.35eafb0f.js"><link rel="prefetch" href="/noteSite/assets/js/76.82cffb73.js"><link rel="prefetch" href="/noteSite/assets/js/77.14a747da.js"><link rel="prefetch" href="/noteSite/assets/js/78.0a67aba1.js"><link rel="prefetch" href="/noteSite/assets/js/79.e4bc6e34.js"><link rel="prefetch" href="/noteSite/assets/js/8.976ce270.js"><link rel="prefetch" href="/noteSite/assets/js/80.df5ed501.js"><link rel="prefetch" href="/noteSite/assets/js/81.7226e5bc.js"><link rel="prefetch" href="/noteSite/assets/js/82.e90de050.js"><link rel="prefetch" href="/noteSite/assets/js/83.a6da0428.js"><link rel="prefetch" href="/noteSite/assets/js/84.4254b6a9.js"><link rel="prefetch" href="/noteSite/assets/js/85.f57bd586.js"><link rel="prefetch" href="/noteSite/assets/js/86.990cf934.js"><link rel="prefetch" href="/noteSite/assets/js/87.d7eafc42.js"><link rel="prefetch" href="/noteSite/assets/js/88.64dac8ea.js"><link rel="prefetch" href="/noteSite/assets/js/89.3a5e735e.js"><link rel="prefetch" href="/noteSite/assets/js/9.599a8138.js"><link rel="prefetch" href="/noteSite/assets/js/90.6d2c8ffe.js"><link rel="prefetch" href="/noteSite/assets/js/91.8885479b.js"><link rel="prefetch" href="/noteSite/assets/js/92.0001d7dd.js"><link rel="prefetch" href="/noteSite/assets/js/93.2da2b7c3.js"><link rel="prefetch" href="/noteSite/assets/js/94.daf40c65.js"><link rel="prefetch" href="/noteSite/assets/js/95.1d6a5f7f.js"><link rel="prefetch" href="/noteSite/assets/js/96.83af16dc.js"><link rel="prefetch" href="/noteSite/assets/js/97.2132ced3.js"><link rel="prefetch" href="/noteSite/assets/js/98.8440c347.js"><link rel="prefetch" href="/noteSite/assets/js/99.033d03c9.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 常用类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java 高级特性</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/java/high/file.html" class="sidebar-link">JavaSE —— File 类</a></li><li><a href="/noteSite/backend/java/high/io.html" class="sidebar-link">JavaSE —— IO</a></li><li><a href="/noteSite/backend/java/high/net-io.html" aria-current="page" class="active sidebar-link">JavaSE —— BIO/NIO/AIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#一、网络编程基础" class="sidebar-link">一、网络编程基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_1-url-的解析和构造" class="sidebar-link">1. URL 的解析和构造</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_2-dns-解析" class="sidebar-link">2. DNS 解析</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_3-网络协议" class="sidebar-link">3. 网络协议</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_4-java-io" class="sidebar-link">4. Java IO</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_5-socket" class="sidebar-link">5. Socket</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_6-阻塞-非阻塞-vs-异步-同步" class="sidebar-link">6. 阻塞/非阻塞 vs 异步/同步</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_7-linux-5-种-io" class="sidebar-link">7. Linux 5 种 IO</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#二、bio" class="sidebar-link">二、BIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_1-简介" class="sidebar-link">1. 简介</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_2-编程模型" class="sidebar-link">2. 编程模型</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_3-缺点" class="sidebar-link">3. 缺点</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_4-实战多人聊天室" class="sidebar-link">4. 实战多人聊天室</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#三、nio" class="sidebar-link">三、NIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_1-bio-中的阻塞" class="sidebar-link">1. BIO 中的阻塞</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_2-简介" class="sidebar-link">2. 简介</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_3-特点" class="sidebar-link">3. 特点</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_4-buffer" class="sidebar-link">4. Buffer</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_5-channel" class="sidebar-link">5. Channel</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_6-多种方式实现本地文件拷贝" class="sidebar-link">6. 多种方式实现本地文件拷贝</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_7-selector" class="sidebar-link">7. Selector</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_8-编程模型" class="sidebar-link">8. 编程模型</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_9-实战多人聊天室" class="sidebar-link">9. 实战多人聊天室</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#四、aio" class="sidebar-link">四、AIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_1-简介-2" class="sidebar-link">1. 简介</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_2-异步实现" class="sidebar-link">2. 异步实现</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_3-原理" class="sidebar-link">3. 原理</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_4-编程模型" class="sidebar-link">4. 编程模型</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_5-实现-回音壁" class="sidebar-link">5. 实现“回音壁”</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_6-实战多人聊天室" class="sidebar-link">6. 实战多人聊天室</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#五、使用场景" class="sidebar-link">五、使用场景</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#六、web-服务器" class="sidebar-link">六、Web 服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_1-tomcat-架构" class="sidebar-link">1. Tomcat 架构</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/high/net-io.html#_2-实现简易版-web-服务器" class="sidebar-link">2. 实现简易版 Web 服务器</a></li></ul></li></ul></li><li><a href="/noteSite/backend/java/high/enum.html" class="sidebar-link">JavaSE —— 枚举类</a></li><li><a href="/noteSite/backend/java/high/reflect.html" class="sidebar-link">Java SE —— 反射</a></li><li><a href="/noteSite/backend/java/high/annotation.html" class="sidebar-link">Java SE —— 注解</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 多线程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 并发工具类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM 面试题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring 5</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot 2.x</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Hoxton</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Alibaba</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 3.4.5</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="javase-bio-nio-aio"><a href="#javase-bio-nio-aio" class="header-anchor">#</a> JavaSE —— BIO/NIO/AIO</h1> <h2 id="一、网络编程基础"><a href="#一、网络编程基础" class="header-anchor">#</a> 一、网络编程基础</h2> <h3 id="_1-url-的解析和构造"><a href="#_1-url-的解析和构造" class="header-anchor">#</a> 1. URL 的解析和构造</h3> <img src="https://tva1.sinaimg.cn/large/008i3skNgy1gujenl60kpj61so0aeq5502.jpg" alt="image-20210917101524042" style="zoom:25%;"> <div class="custom-block tip"><p class="custom-block-title">URI 和 URL 的区别与联系</p> <ul><li>URI: Uniform Resource Identifier</li> <li>URL: Uniform Resource Locator</li> <li>URN: Uniform Resource Name</li></ul> <p>URI 是抽象的定义，不管用什么方法表示，只要能定位一个资源，就叫 URI，本来设想的的使用两种方法定位：</p> <ol><li>URL：用地址定位</li> <li>URN：用名称定位</li></ol></div> <h3 id="_2-dns-解析"><a href="#_2-dns-解析" class="header-anchor">#</a> 2. DNS 解析</h3> <p>域名 -&gt; IP 地址</p> <h3 id="_3-网络协议"><a href="#_3-网络协议" class="header-anchor">#</a> 3. 网络协议</h3> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gujeyyroq8j60u016ijy802.jpg" alt="img"></p> <h3 id="_4-java-io"><a href="#_4-java-io" class="header-anchor">#</a> 4. Java IO</h3> <ul><li>参考：<a href="/noteSite/backend/java/high/io.html">JavaSE —— IO</a></li></ul> <h3 id="_5-socket"><a href="#_5-socket" class="header-anchor">#</a> 5. Socket</h3> <p>对于底层网络应用开发者而言，几乎所有网络编程都是 Socket，因为大部分底层网络 的编程都离不开 Socket 编程。 HTTP 编程、 Web 开发、 IM 通信 、视频流传输的底层都是 Socket 编程 。</p> <p>日常生活中我们每天打开浏览器浏览网页、使用 QQ 聊天、 邮件收发、 直播等，客户端和服务器端的通信在底层看来都是依靠 Socket 通信的。</p> <p>Socket 起源于 UNIX，而 UNIX 的基本哲学之一就是“一切皆文件”，都可以用 <strong>“打开（open）→读写（write/read）→关闭（close）”</strong> 模式来操作， Socket 就是该模式的一个实现，网络的 Socket 数据传输是 一种特殊的 I/0，Socket 也是一种文件描述符。 Socket 也具有一个类似于打开文件的函数调用：Socket()， 该函数返回一个整型的 Socket 描述符， 随后的连接建立、数据传输等操作都是通过该 Socket 实现的 。</p> <p>网络中的进程之间如何通过 Socket 通信呢？首要解决的问题是如何唯一标识一个进程，否则通信无从谈起 ! 在本地可以通过进程 PID 来唯一标识一个进程，但是在网络中这是行不通的。其实 TCP/IP 协议族己经帮我们解决了这个问题，网络层的“IP 地址”可以唯一标识网络中的主机，而传输层的“协议+端口” 可以唯一标识主机中的应用程序（进程）。这样利用三大要素（<strong>IP 地址</strong>、<strong>协议</strong>、<strong>端口</strong>）就可以标识网络的进程了，网络中需要互相通信的进程，就可以利用这个标志在它们之间进行交互。</p> <p>使用 TCP/IP 协议的应用程序通常采用应用编程接口：UNIX BSD 的套接字和 UNIX System V 的 TLI（己经被淘汰），来实现网络进程之间的通信。就目前而言， 几乎所有的应用程序都是采用 Socket，而现在又是网络时代，网络中进程通信是无处不在的，这就是为什么说“一切皆 Socket”。</p> <p>Socket 有两种：</p> <ul><li>TCPSocket</li> <li>UDP Socket</li></ul> <p>TCP 和 UDP 是协议，而要确定一个进程得需要三要素， 所以还需要 IP 地址和端口。</p> <h3 id="_6-阻塞-非阻塞-vs-异步-同步"><a href="#_6-阻塞-非阻塞-vs-异步-同步" class="header-anchor">#</a> 6. 阻塞/非阻塞 vs 异步/同步</h3> <p><strong>阻塞/非阻塞</strong></p> <blockquote><p>👀 从调用方的角度来看）</p></blockquote> <ul><li>如果调用方在被调用方返回结果之前只能傻傻等待，那就是阻塞的。</li> <li>如果调用方在被调用方返回结果之前可以先干别的事情，那就是非阻塞的。</li></ul> <p><strong>同步/异步</strong></p> <blockquote><p>（从被调用方的角度来看👀</p></blockquote> <ul><li>如果被调用方被调用之后需要立刻返回结果，那么就是同步的。</li> <li>如果被调用方被调用之后先返回一个空的结果，等到任务执行完成后再通知调用方，那就是异步的。</li></ul> <blockquote><p>同步和异步的区别：是否开启新线程。</p> <p>阻塞和非阻塞的区别：当前线程是否挂起，即是否释放 CPU。</p></blockquote> <h3 id="_7-linux-5-种-io"><a href="#_7-linux-5-种-io" class="header-anchor">#</a> 7. Linux 5 种 IO</h3> <ul><li>参考：<a href="/noteSite/linux/linux-io/0-concept.html">Linux IO</a></li></ul> <h2 id="二、bio"><a href="#二、bio" class="header-anchor">#</a> 二、BIO</h2> <h3 id="_1-简介"><a href="#_1-简介" class="header-anchor">#</a> 1. 简介</h3> <ul><li>Java BIO 就是传统的 java io 编程，其相关接口在 java.io。</li> <li>BIO（Blocking I/O）：同步阻塞，服务器实现模式为一个连接一个线程，即客户端有连接请求时，服务器端就需要一个启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销，可以通过线程池机制改善（实现多个客户连接服务器）。</li> <li>BIO 适用于连接数目较小且固定架构，这种方式对服务器资源要求较高，并发局限于应用中，JDK1.4 之前的唯一选择，程序简单易理解。</li></ul> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> 阻塞体现在哪里？</span>
accept() ：阻塞接收客户端的连接
read()/write()
connect()：和服务端建立连接，连接的过程中 connect() 会阻塞
</code></pre></div><h3 id="_2-编程模型"><a href="#_2-编程模型" class="header-anchor">#</a> 2. 编程模型</h3> <ol><li>服务器启动一个 ServerSocket；</li> <li>客户端启动 Socket 对服务器进行通信，默认情况下服务器需要对每个客户建立一个线程与之通讯；</li> <li>客户端发出请求后，先咨询服务器，是否有线程响应，如果没有则会等待，或者被拒绝；</li> <li>如果有响应，客户端线程会等待请求结束后，再继续执行。</li></ol> <h3 id="_3-缺点"><a href="#_3-缺点" class="header-anchor">#</a> 3. 缺点</h3> <ol><li>每个请求都需要创建独立线程，与对应的客户端进行数据 Read 业务处理，数据 Write。</li> <li>当并发数量较大，需要<strong>创建大量线程来处理连接</strong>，系统资源占用较大。</li> <li>连接建立后，如果当前线程没有数据可读，则线程就阻塞在 Read 操作上，造成线程资源浪费。</li></ol> <h3 id="_4-实战多人聊天室"><a href="#_4-实战多人聊天室" class="header-anchor">#</a> 4. 实战多人聊天室</h3> <h4 id="_4-1-架构设计"><a href="#_4-1-架构设计" class="header-anchor">#</a> 4.1 架构设计</h4> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gujwxoq4aoj60pq0we76502.jpg" alt="bio-chatroom-sequence-diagram"></p> <p>服务端：</p> <ul><li>一个线程来负责添加和删除客户端，并维护一个在线的客户端列表；</li> <li>一个线程来负责接收和广播客户端的信息；</li></ul> <p>客户端：</p> <ul><li>一个线程来负责等待用户输入；</li> <li>一个线程来负责接收其他客户端发来的信息；</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 目录结构</span>
<span class="token builtin class-name">.</span>
├── client
│   ├── ChatClient.java
│   ├── ChatClientStarter.java
│   └── UserInputHandler.java
└── server
    ├── ChatHandler.java
    ├── ChatServer.java
    └── ChatServerStarter.java
</code></pre></div><h4 id="_4-2-服务端实现"><a href="#_4-2-服务端实现" class="header-anchor">#</a> 4.2 服务端实现</h4> <ul><li><p>ChatServer</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> DEFAULT_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>                                <span class="token comment">// 默认端口</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUIT <span class="token operator">=</span> <span class="token string">&quot;quit&quot;</span><span class="token punctuation">;</span>                             <span class="token comment">// 客户端退出命令</span>

    <span class="token keyword">private</span> <span class="token class-name">ServerSocket</span> serverSocket<span class="token punctuation">;</span>                              <span class="token comment">// socket</span>

    <span class="token keyword">private</span> <span class="token class-name">ExecutorService</span> executorService<span class="token punctuation">;</span>                        <span class="token comment">// 线程池</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Writer</span><span class="token punctuation">&gt;</span></span> connectedClients<span class="token punctuation">;</span>              <span class="token comment">// 端口：写对象</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connectedClients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 客户端上线
     * @param socket        accept 到的客户端 socket
     * @throws IOException  获取 socket 的 outputStream 时可能抛出 IOException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">addClient</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> port <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BufferedWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 添加</span>
            connectedClients<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 日志</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端 [&quot;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">&quot;] 已连接到服务器&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 客户端下线
     * @param socket        accept 到的客户端 socket
     * @throws IOException  关闭 socket 的 outputStream 时可能抛出 IOException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">removeClient</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> port <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connectedClients<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 关闭 writer 对象</span>
                connectedClients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 移除</span>
                connectedClients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 日志</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端 [&quot;</span> <span class="token operator">+</span> socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] 已下线&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 服务端转发信息给除发送者之外的所有客户端
     * @param socket        发送者
     * @param message       消息
     * @throws IOException  向 socket 的 outputStream 进行写操作时可能抛出 IOException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">forwardMessage</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socket<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>message<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> port<span class="token operator">:</span> connectedClients<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>port<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Writer</span> writer <span class="token operator">=</span> connectedClients<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 检查用户是否准备退出
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">readyToQuit</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> QUIT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 服务端主线程
     * 1. 监听客户端，等待客户端连接
     * 2. 接收客户端信息，并进行转发
     * 3. 维护在线的客户端列表
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 绑定监听端口</span>
            serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;启动服务器，监听端口：&quot;</span> <span class="token operator">+</span> DEFAULT_PORT <span class="token operator">+</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 监听客户端请求</span>
            <span class="token class-name">Socket</span> accept<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 等待客户端连接</span>
                accept <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 创建 ChatHandler 线程</span>
                executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChatHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> accept<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 关闭服务器
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSocket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                serverSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务器正常退出...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务器退出异常...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ChatHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ChatServer</span> chatServer<span class="token punctuation">;</span>          <span class="token comment">// 服务端</span>
    <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>                  <span class="token comment">// 客户端</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatHandler</span><span class="token punctuation">(</span><span class="token class-name">ChatServer</span> chatServer<span class="token punctuation">,</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatServer <span class="token operator">=</span> chatServer<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 存储新上线的客户端</span>
            chatServer<span class="token punctuation">.</span><span class="token function">addClient</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;添加客户端 [&quot;</span> <span class="token operator">+</span> socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] 成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 读取用户发送的信息</span>
            <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msg <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 检查用户是否是退出命令</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chatServer<span class="token punctuation">.</span><span class="token function">readyToQuit</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 转发消息到其他在线的客户端</span>
                chatServer<span class="token punctuation">.</span><span class="token function">forwardMessage</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token string">&quot;客户端 [&quot;</span> <span class="token operator">+</span> socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]： &quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;添加客户端 [&quot;</span> <span class="token operator">+</span> socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] 失败...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 移除客户端</span>
                chatServer<span class="token punctuation">.</span><span class="token function">removeClient</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;客户端 [&quot;</span> <span class="token operator">+</span> socket<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] 下线异常...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ChatServerStarter</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServerStarter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChatServer</span> chatServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="_4-3-客户端实现"><a href="#_4-3-客户端实现" class="header-anchor">#</a> 4.3 客户端实现</h4> <ul><li><p>ChatClient</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_SERVER_HOST <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">;</span>     <span class="token comment">// 服务端主机</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_SERVER_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>               <span class="token comment">// 服务端端口</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUIT <span class="token operator">=</span> <span class="token string">&quot;quit&quot;</span><span class="token punctuation">;</span>                         <span class="token comment">// 客户端退出命令</span>

    <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span>  <span class="token comment">// 客户端 socket</span>
    <span class="token keyword">private</span> <span class="token class-name">BufferedReader</span> reader<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">BufferedWriter</span> writer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 发送消息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">isOutputShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>writer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>message <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 接收消息
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">isInputShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>reader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 检查用户是否准备退出
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">readyToQuit</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> QUIT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 启动客户端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 创建 socket，绑定服务端</span>
            socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>DEFAULT_SERVER_HOST<span class="token punctuation">,</span> DEFAULT_SERVER_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 创建 IO 流</span>
            reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 处理用户输入</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserInputHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 读取服务器转发的其他客户端的信息</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token function">receiveMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 关闭客户端
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>reader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>writer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>UserInputHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInputHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>          <span class="token comment">// 对应的客户端</span>

    <span class="token keyword">public</span> <span class="token class-name">UserInputHandler</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 等待用户输入消息</span>
        <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 读取用户输入</span>
                message <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 向服务器发送消息</span>
                chatClient<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 检查用户是否准备退出</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chatClient<span class="token punctuation">.</span><span class="token function">readyToQuit</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ChatClientStarter</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClientStarter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatClient<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="_4-4-演示"><a href="#_4-4-演示" class="header-anchor">#</a> 4.4 演示</h4> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gum7gp4c5lj61910u0acp02.jpg" alt="image-20210919202314400"></p> <h2 id="三、nio"><a href="#三、nio" class="header-anchor">#</a> 三、NIO</h2> <h3 id="_1-bio-中的阻塞"><a href="#_1-bio-中的阻塞" class="header-anchor">#</a> 1. BIO 中的阻塞</h3> <ul><li>ServerSocket.accept()</li> <li>InputStream.read()</li> <li>OutputStream.writer()</li> <li>无法在同一个线程里面处理多个 Stream I/O</li></ul> <h3 id="_2-简介"><a href="#_2-简介" class="header-anchor">#</a> 2. 简介</h3> <p>NIO 中的 N 可以理解为 Non-blocking，不单纯是 New。它支持面向缓冲的，基于通道的 I/O 操作方法。 NIO 提供了与传统 BIO 模型中的 <code>Socket</code> 和 <code>ServerSocket</code> 相对应的 <code>SocketChannel</code> 和 <code>ServerSocketChannel</code> 两种不同的套接字通道实现。两种通道都支持阻塞和非阻塞两种模式。</p> <p>阻塞模式使用就像传统中的支持一样，比较简单，但是性能和可靠性都不好；非阻塞模式正好与之相反。</p> <p>对于低负载、低并发的应用程序，可以使用同步阻塞 I/O 来提升开发速率和更好的维护性；对于高负载、高并发的（网络）应用，应使用 NIO 的非阻塞模式来开发。</p> <h3 id="_3-特点"><a href="#_3-特点" class="header-anchor">#</a> 3. 特点</h3> <ul><li>使用 Channel 代替 Stream</li> <li>使用 Selector 监控多条 Channel</li> <li>可以在一个线程里处理多个 Channel I/O</li></ul> <h3 id="_4-buffer"><a href="#_4-buffer" class="header-anchor">#</a> 4. Buffer</h3> <div><center><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gun4feqtekj60qw0omt9u02.jpg" alt="image-20210920152348572" style="zoom:33%;"></center></div> <ul><li>position: 当前指针</li> <li>limit: 能写或者能读的最远地方</li> <li>capacity: 缓冲区容量</li></ul> <h4 id="_4-1-向-buffer-写入数据"><a href="#_4-1-向-buffer-写入数据" class="header-anchor">#</a> 4.1 向 Buffer 写入数据</h4> <ul><li>从 position 位置写，然后移动 position 指针，在到达 limit 之前都是可以写的</li></ul> <h4 id="_4-2-从-buffer-读取数据"><a href="#_4-2-从-buffer-读取数据" class="header-anchor">#</a> 4.2 从 Buffer 读取数据</h4> <ul><li>调用 <code>flip()</code> 方法，将 Buffer 的写模式反转成读模式；</li> <li><code>flip()</code> 放把  position 移动回写的初始位置，然后把 limit 移动到刚刚写入的最远位置；</li></ul> <div><center><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gun4k65i1sj60qk0o075s02.jpg" alt="image-20210920152823069" style="zoom:33%;"></center></div> <h4 id="_4-2-刷新-buffer"><a href="#_4-2-刷新-buffer" class="header-anchor">#</a> 4.2 刷新 Buffer</h4> <ul><li>Buffer 里所有数据都已经被读完了，调用 <code>clear()</code>：
<ul><li>会把 position 和 limit 都复原到原位置。</li></ul></li> <li>Buffer 里面数据只读了一半，调用 <code>clear()</code>：
<ul><li>会调用 <code>compact()</code> 方法把未读的位置挪到前面，然后移动 position 指针到已有数据的下面，然后继续接受写或者读。</li></ul></li></ul> <h3 id="_5-channel"><a href="#_5-channel" class="header-anchor">#</a> 5. Channel</h3> <p>Channel 通过 Buffer 来写入和读取数据，Channel 也可以直接跟 Channel 进行数据的传输。</p> <p>几个重要的 Channel：</p> <ul><li>FileChannel</li> <li>SocketChannel</li> <li>ServerSocketChannel</li></ul> <h3 id="_6-多种方式实现本地文件拷贝"><a href="#_6-多种方式实现本地文件拷贝" class="header-anchor">#</a> 6. 多种方式实现本地文件拷贝</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">interface</span> <span class="token class-name">FileCopyRunner</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> source<span class="token punctuation">,</span> <span class="token class-name">File</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileCopyDemo</span> <span class="token punctuation">{</span>
		
  	<span class="token comment">// 性能测试</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">benchmark</span><span class="token punctuation">(</span><span class="token class-name">FileCopyRunner</span> fileCopyRunner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Date</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;a.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">File</span> target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;b.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileCopyRunner<span class="token punctuation">.</span><span class="token function">copyFile</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Date</span> end <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;总时间：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// 关闭资源</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closeable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closeable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">/**
         * ① BIO: 不利用缓冲区
         */</span>
        <span class="token class-name">FileCopyRunner</span> noBufferStreamCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileCopyRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> source<span class="token punctuation">,</span> <span class="token class-name">File</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">InputStream</span> fin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">OutputStream</span> fout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    fin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 读文件</span>
                    <span class="token keyword">int</span> result<span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> fin<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 写文件</span>
                        fout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * ② BIO: 利用缓冲区
         */</span>
        <span class="token class-name">FileCopyRunner</span> bufferredStreamCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileCopyRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> source<span class="token punctuation">,</span> <span class="token class-name">File</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">InputStream</span> fin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">OutputStream</span> fout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    fin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> result<span class="token punctuation">;</span>

                    <span class="token comment">// 读</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>result <span class="token operator">=</span> fin<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 写</span>
                        fout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * ③ NIO: 利用缓冲区
         */</span>
        <span class="token class-name">FileCopyRunner</span> nioBufferCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileCopyRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> source<span class="token punctuation">,</span> <span class="token class-name">File</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FileChannel</span> fin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">FileChannel</span> fout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 通过文件流来获取对应通道</span>
                    fin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 缓冲区</span>
                    <span class="token class-name">ByteBuffer</span> byteBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 读数据，写 Buffer</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span> fin<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 需要将 Buffer 从写模式转移到读模式</span>
                        byteBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// 读 Buffer，传进 channel</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            fout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// 读模式再转为写模式</span>
                        byteBuffer<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        byteBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * ④ NIO: 不利用缓冲区，channel 直接交互
         */</span>
        <span class="token class-name">FileCopyRunner</span> nioTransferCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileCopyRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">copyFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> source<span class="token punctuation">,</span> <span class="token class-name">File</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">FileChannel</span> fin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">FileChannel</span> fout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    fin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// channel 直接传输</span>
                    <span class="token keyword">long</span> hasTransferred <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>hasTransferred <span class="token operator">!=</span> fin<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        hasTransferred <span class="token operator">+=</span> fin<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>hasTransferred<span class="token punctuation">,</span> fin<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">closeResource</span><span class="token punctuation">(</span>fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

      	<span class="token comment">// 测试</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;noBufferStreamCopy &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">benchmark</span><span class="token punctuation">(</span>noBufferStreamCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;bufferredStreamCopy &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">benchmark</span><span class="token punctuation">(</span>bufferredStreamCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;nioBufferCopy &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">benchmark</span><span class="token punctuation">(</span>nioBufferCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;nioTransferCopy &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">benchmark</span><span class="token punctuation">(</span>nioTransferCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>noBufferStreamCopy 总时间：25588
bufferredStreamCopy 总时间：206
nioBufferCopy 总时间：271
nioTransferCopy 总时间：240
</code></pre></div><p>经过多次实验，得出结论：</p> <ul><li>文件大的话，使用 Channel 的优势会更明显；</li> <li>Buffer 的用处非常大；</li> <li>单线程下 BIO 和 NIO 区别不大，多线程下 NIO 的优势明显；</li></ul> <h3 id="_7-selector"><a href="#_7-selector" class="header-anchor">#</a> 7. Selector</h3> <p>Selector 是用来管理 Channel 的一个工具，开发者可以将 Channel 注册到特定的 Selector，Selector 会为 Channel 生成一个 SelectorKey，然后就可以通过 SelectorKey 的各种方法来管理 Channel，如以下方法：</p> <ul><li>interestOps(): 开发者希望 Selector 监控到 Channel 的哪些状态；</li> <li>readyOps(): 获得目前的 Channel 处于哪些可操作的状态；</li> <li>channel(): 返回对应的 Channel 对象；</li> <li>selector(): 返回 Channel 所注册 Selector 对象；</li> <li>attachment(): 开发者可以将任意对象附着在 Channel 上，通过该方法可以获取该对象；</li></ul> <p>其中 <code>Ops</code> 代表了 Channel 的某种状态，也可以理解为 Channel 所监听的某种事件，有如下：</p> <ul><li>CONNECT</li> <li>ACCEPT</li> <li>READ</li> <li>WRITE</li></ul> <p>Selector 对象有以下方法可以获取 Channel 的信息：</p> <ul><li>select(): 返回有几个 Channel 处于满足 Selector 所监听的状态；</li></ul> <h3 id="_8-编程模型"><a href="#_8-编程模型" class="header-anchor">#</a> 8. 编程模型</h3> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gunfpvkfjkj61es0lggpo02.jpg" alt="image-20210920215427218"></p> <h3 id="_9-实战多人聊天室"><a href="#_9-实战多人聊天室" class="header-anchor">#</a> 9. 实战多人聊天室</h3> <h4 id="_9-1-架构设计"><a href="#_9-1-架构设计" class="header-anchor">#</a> 9.1 架构设计</h4> <p>与 BIO 不同的是，NIO 的实现方式不需要再手动维护一个 Map，因为 Selector 会维护一个所有注册到它上面 SelectionKey 组成的 Set。</p> <p>另外，NIO 也不需要每连接一个客户端就派一个线程去处理，而是支持在单线程下对多个客户端进行处理，因为用到了 Channel，而 Selector 又可以用来管理 Channel。</p> <p>读写数据都是要经过 Buffer 的，且要注意，每次往 Buffer 里面写完东西后，都需要调用 <code>flip()</code> 将 Buffer 从写模式切换到读模式：</p> <ul><li>写数据：先写到 wBuffer，再转到 Channel</li> <li>读数据：从 Channel 将数据读到 rBuffer，再冲 rBuffer 中读出数据</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 目录结构</span>
├── client
│   ├── ChatClient.java
│   ├── ChatClientStarter.java
│   └── UserInputHandler.java
└── server
    ├── ChatServer.java
    └── ChatServerStarter.java
</code></pre></div><h4 id="_9-2-服务端实现"><a href="#_9-2-服务端实现" class="header-anchor">#</a> 9.2 服务端实现</h4> <ul><li><p>ChatServer</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUIT <span class="token operator">=</span> <span class="token string">&quot;quit&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BUFFER <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ServerSocketChannel</span> serverSocketChannel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ByteBuffer</span> rBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ByteBuffer</span> wBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Charset</span> charset <span class="token operator">=</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 启动服务端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获得服务端的通道</span>
            serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 修改为非阻塞模式</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 绑定端口</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 获得 Channel 控制器 Selector 对象</span>
            selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将服务端 Channel 注册到 Selector 中，注册 ACCEPT 事件</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;启动服务器，监听端口：&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">+</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Selector 监听事件</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 处理所有被触发的事件</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> selectionKey <span class="token operator">:</span> selectionKeys<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">handles</span><span class="token punctuation">(</span>selectionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 清空之前的事件集</span>
                selectionKeys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">closeResource</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理被触发的事件
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handles</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> selectionKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ACCEPT 事件 —— 即和客户端建立连接</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerSocketChannel</span> server <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span>selectionKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取客户端 channel</span>
            <span class="token class-name">SocketChannel</span> client <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将客户端 channel 转为非阻塞模式</span>
            client<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 为客户端 channel 注册 READ 事件</span>
            <span class="token comment">// 当 READ 事件触发时，表示有客户端写东西了，channel 有可以读的东西</span>
            client<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已连接&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// READ 事件 —— 即客户端发来信息，需要转发给其他客户端</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>selectionKey<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SocketChannel</span> client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span>selectionKey<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取客户端发来的信息</span>
            <span class="token class-name">String</span> fwdMsg <span class="token operator">=</span> <span class="token function">receive</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fwdMsg<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 空信息 -&gt; 客户端异常 -&gt; 退出客户端</span>
                selectionKey<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                selector<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> fwdMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 转发信息</span>
                <span class="token function">forwardMessage</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> fwdMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 判断用户是否准备退出</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readyToQuit</span><span class="token punctuation">(</span>fwdMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    selectionKey<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selector<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;已断开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将 client 发来的信息转发给其他客户端
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">forwardMessage</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> client<span class="token punctuation">,</span> <span class="token class-name">String</span> fwdMsg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key <span class="token operator">:</span> selector<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Channel</span> connectedChannel <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 不转发给服务端</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connectedChannel <span class="token keyword">instanceof</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 不转发给自身</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> connectedChannel <span class="token keyword">instanceof</span> <span class="token class-name">SocketChannel</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>connectedChannel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                wBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 先将数据写到 wBuffer 中</span>
                wBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> fwdMsg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将从 rBuffer 将数据送到 channel</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>wBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span>connectedChannel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>wBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 接收客户端发来的信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> client<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        rBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将 channel 数据读到 rBuffer</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>rBuffer<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment">// 将 rBuffer 的写模式转为读模式</span>
        rBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>rBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 构建客户端名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;客户端 [&quot;</span> <span class="token operator">+</span> client<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] &quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断客户端是否准备退出
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">readyToQuit</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> QUIT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                closable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ChatServerStarter</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServerStarter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChatServer</span> chatServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="_9-3-客户端实现"><a href="#_9-3-客户端实现" class="header-anchor">#</a> 9.3 客户端实现</h4> <ul><li><p>ChatClient</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEFAULT_SERVER_HOST <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_SERVER_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUIT <span class="token operator">=</span> <span class="token string">&quot;quit&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BUFFER <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SocketChannel</span> clientSocketChannel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ByteBuffer</span> rBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ByteBuffer</span> wBuffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Charset</span> charset <span class="token operator">=</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_SERVER_HOST<span class="token punctuation">,</span> DEFAULT_SERVER_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 启动客户端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取客户端 channel</span>
            clientSocketChannel <span class="token operator">=</span> <span class="token class-name">SocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置为非阻塞模式</span>
            clientSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 创建一个通道管理器 selector</span>
            selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// channel 注册 CONNECT 事件到 selector</span>
            clientSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 连接服务端</span>
            clientSocketChannel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 监听事件</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key <span class="token operator">:</span> selectionKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">handles</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                selectionKeys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClosedSelectorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 正常退出，无需处理</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">closeResource</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 处理被触发的事件
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handles</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// CONNECT 事件 —— 客户端已经连接上服务端了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isConnectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SocketChannel</span> client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span>key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 判断是否已经完成连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">isConnectionPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                client<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 处理用户输入</span>
                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserInputHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 注册 READ 事件</span>
            client<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// READ 事件 —— 服务端转发别的客户端的消息过来</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SocketChannel</span> clientSocketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token function">receive</span><span class="token punctuation">(</span>clientSocketChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 空信息 -&gt; 服务端异常 -&gt; 客户端退出</span>
                <span class="token function">closeResource</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 从通道中读取信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> clientSocketChannel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        rBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>clientSocketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>rBuffer<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
        rBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>rBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 发送消息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> input<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 先写入 wBuffer</span>
        wBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 再转到 channel</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>wBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            clientSocketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>wBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 监控用户是否退出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readyToQuit</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">closeResource</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断客户端是否准备退出
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">readyToQuit</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> QUIT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                closable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>UserInputHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInputHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserInputHandler</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 等待用户输入消息</span>
            <span class="token class-name">BufferedReader</span> consoleReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> input <span class="token operator">=</span> consoleReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 像服务器发送消息</span>
                chatClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 检查用户是否退出</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chatClient<span class="token punctuation">.</span><span class="token function">readyToQuit</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ChatClientStarter</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClientStarter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChatClient</span> chatClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChatClient</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">7777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chatClient<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="_9-4-演示"><a href="#_9-4-演示" class="header-anchor">#</a> 9.4 演示</h4> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1guqsnbsg7qj613g0u0whe02.jpg" alt="image-20210923193826991"></p> <h2 id="四、aio"><a href="#四、aio" class="header-anchor">#</a> 四、AIO</h2> <h3 id="_1-简介-2"><a href="#_1-简介-2" class="header-anchor">#</a> 1. 简介</h3> <p>与 NIO 不同，使用 AIO 进行读写操作时，只须直接调用 API 的 <code>read</code> 或 <code>write</code> 方法即可。这两种方法均为异步的：</p> <ul><li>对于读操作而言，当有流可读取时，操作系统会将可读的流传入 <code>read</code> 方法的缓冲区，并通知应用程序；</li> <li>对于写操作而言，当操作系统将 <code>write</code> 方法传递的流写入完毕时，操作系统主动通知应用程序。</li></ul> <p>即可以理解为，read/write 方法都是异步的，完成后会主动调用回调函数。  在 JDK1.7 中，这部分内容被称作 NIO.2，主要在java.nio.channels 包下增加了下面四个异步通道：</p> <ul><li>AsynchronousSocketChannel</li> <li>AsynchronousServerSocketChannel</li> <li>AsynchronousFileChannel</li> <li>AsynchronousDatagramChannel</li></ul> <p>其中的 read/write 方法，会返回一个带回调函数的对象，当执行完读取/写入操作后，直接调用回调函数。</p> <h3 id="_2-异步实现"><a href="#_2-异步实现" class="header-anchor">#</a> 2. 异步实现</h3> <h4 id="_2-1-通过-future"><a href="#_2-1-通过-future" class="header-anchor">#</a> 2.1 通过 Future</h4> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gurquj7oosj61a808k0t402.jpg" alt="image-20210924152147217"></p> <h4 id="_2-2-通过-completionhandler"><a href="#_2-2-通过-completionhandler" class="header-anchor">#</a> 2.2 通过 CompletionHandler</h4> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gurqwjgqcdj61h2088t9c02.jpg" alt="image-20210924152342721"></p> <h3 id="_3-原理"><a href="#_3-原理" class="header-anchor">#</a> 3. 原理</h3> <h3 id="_4-编程模型"><a href="#_4-编程模型" class="header-anchor">#</a> 4. 编程模型</h3> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gurt0cvun0j61i20qyadl02.jpg" alt="image-20210924163634768"></p> <h3 id="_5-实现-回音壁"><a href="#_5-实现-回音壁" class="header-anchor">#</a> 5. 实现“回音壁”</h3> <ul><li>服务器端采用 CompletionHandler 来实现异步</li> <li>客户端采用 Future 来实现异步</li></ul> <p>Server:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">String</span> LOCALHOST <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> BUFFER <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> READ_OP <span class="token operator">=</span> <span class="token string">&quot;read&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> WRITE_OP <span class="token operator">=</span> <span class="token string">&quot;write&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">AsynchronousServerSocketChannel</span> serverSocketChannel<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 启动服务端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 绑定监听端口</span>
            serverSocketChannel <span class="token operator">=</span> <span class="token class-name">AsynchronousServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>LOCALHOST<span class="token punctuation">,</span> DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;启动服务器，监听端口：&quot;</span> <span class="token operator">+</span> DEFAULT_PORT <span class="token operator">+</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 监听客户端，accept 的第二个参数就是一个回调函数 CompletionHandler</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 异步，直接返回</span>
                serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AcceptHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 阻塞一下，避免一直循环</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">closeResource</span><span class="token punctuation">(</span>serverSocketChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closeable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>closeable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;关闭&quot;</span> <span class="token operator">+</span> closeable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * IO 完成后要调用的回调
     *
     * CompletionHandler&lt;V,A&gt;
     *      @param   '&lt;V&gt;'     The result type of the I/O operation 这里我们要返回的就是客户端对应的异步通道
     *      @param   '&lt;A&gt;'     The type of the object attached to the I/O operation 要附带的对象的类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">AcceptHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AsynchronousSocketChannel</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>

        <span class="token comment">/**
         * IO 正常结束后要做的事情
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> result<span class="token punctuation">,</span> <span class="token class-name">Object</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 服务端还在线的话，要继续监听</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 处理客户端请求</span>
            <span class="token class-name">AsynchronousSocketChannel</span> clientChannel <span class="token operator">=</span> result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientChannel <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> clientChannel<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// attachment</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> READ_OP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;buffer&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 参数1：目标 Buffer</span>
                <span class="token comment">// 参数2：attachment</span>
                <span class="token comment">// 参数3：IO 完成后要执行的回调</span>
                clientChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ClientHandler</span><span class="token punctuation">(</span>clientChannel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * IO 异常后要做的事情
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">Object</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;AcceptHandler 出现异常了，exception: &quot;</span> <span class="token operator">+</span> exc<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，attachment：&quot;</span> <span class="token operator">+</span> attachment<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 读取完客户端发来的信息后要执行的回调
     *
     * CompletionHandler&lt;Integer,? super A&gt; handler
     *      @param   '&lt;Integer&gt;'     The result type of the I/O operation 这里是返回读到了多少个字节
     *      @param   '&lt;? super A&gt;'   The type of the object attached to the I/O operation 需要是 A 的父类，A 是 attachment
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ClientHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">AsynchronousSocketChannel</span> clientChannel<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">ClientHandler</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> clientChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientChannel <span class="token operator">=</span> clientChannel<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * IO 正常结束后要做的事情
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> result<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> type <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> attachment<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// READ -&gt; 即服务端收到来自客户端的信息了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>READ_OP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 回音壁：读出客户端发来的数据，然后再回传回去</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">)</span> attachment<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 从写模式切换为读模式</span>
                buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将 buffer 中的数据写进 channel 中</span>
                attachment<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> WRITE_OP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> attachment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// WRITE -&gt; 即服务端回传数据了</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>WRITE_OP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 服务端回传完后让服务端继续监听客户端有可能发来的数据</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachment<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> READ_OP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachment<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;buffer&quot;</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> attachment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * IO 异常后要做的事情
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ClientHandler 出现异常了，exception: &quot;</span> <span class="token operator">+</span> exc<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;，attachment：&quot;</span> <span class="token operator">+</span> attachment<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Client:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">String</span> LOCALHOST <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token class-name">AsynchronousSocketChannel</span> clientSocketChannel<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Client</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 启动客户端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 连接服务端</span>
            clientSocketChannel <span class="token operator">=</span> <span class="token class-name">AsynchronousSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获得 Future 对象</span>
            <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> connectFuture <span class="token operator">=</span> clientSocketChannel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>LOCALHOST<span class="token punctuation">,</span> DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ========================================</span>
            <span class="token comment">// 此处可以加一些其他的操作，因为可以是异步非阻塞的</span>
            <span class="token comment">// ========================================</span>

            <span class="token comment">// 等待连接建立完成</span>
            connectFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 处理用户输入</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BufferedReader</span> consoleReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> input <span class="token operator">=</span> consoleReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inputBytes <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>inputBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 传给服务端</span>
                <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> writeFuture <span class="token operator">=</span> clientSocketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ========================================</span>
                <span class="token comment">// 此处可以加一些其他的操作，因为可以是异步非阻塞的</span>
                <span class="token comment">// ========================================</span>

                <span class="token comment">// 等待写入完成</span>
                writeFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 读取服务器返回的消息</span>
                buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> readFuture <span class="token operator">=</span> clientSocketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ========================================</span>
                <span class="token comment">// 此处可以加一些其他的操作，因为可以是异步非阻塞的</span>
                <span class="token comment">// ========================================</span>

                <span class="token comment">// 等待读取完成</span>
                readFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> echo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务端：&quot;</span> <span class="token operator">+</span> echo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">closeResource</span><span class="token punctuation">(</span>clientSocketChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closeable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>closeable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;关闭&quot;</span> <span class="token operator">+</span> closeable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>演示：</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gursnetbi6j61rm0bg75602.jpg" alt="image-20210924162408192"></p> <h3 id="_6-实战多人聊天室"><a href="#_6-实战多人聊天室" class="header-anchor">#</a> 6. 实战多人聊天室</h3> <h4 id="_6-1-架构设计"><a href="#_6-1-架构设计" class="header-anchor">#</a> 6.1 架构设计</h4> <p>跟 BIO 很像，只不过这会儿是异步的。在服务端我们采用 CompletionHandler 来实现异步，在客户端我们采用 Future 来实现异步。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 目录结构</span>
├── client
│   ├── ChatClient.java							<span class="token comment"># 客户端实现</span>
│   ├── ChatClientStarter.java			<span class="token comment"># 客户端启动器</span>
│   └── UserInputHandler.java				<span class="token comment"># 处理用户输入</span>
└── server
    ├── AcceptHandler.java					<span class="token comment"># 客户端连接到服务器时的回调</span>
    ├── ChatServer.java							<span class="token comment"># 服务端实现</span>
    ├── ChatServerStarter.java			<span class="token comment"># 服务端启动器</span>
    └── ClientHandler.java				  <span class="token comment"># 服务器收到客户端信息时的回调</span>
</code></pre></div><h4 id="_6-2-服务端实现"><a href="#_6-2-服务端实现" class="header-anchor">#</a> 6.2 服务端实现</h4> <ul><li><p>ChatServer</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOCALHOST <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> THREAD_POOL_SIZE <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AsynchronousChannelGroup</span> channelGroup<span class="token punctuation">;</span>                  <span class="token comment">// 自定义 asyncChannelGroup</span>
    <span class="token keyword">private</span> <span class="token class-name">AsynchronousServerSocketChannel</span> serverSocketChannel<span class="token punctuation">;</span>    <span class="token comment">// 服务端异步通道</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientHandler</span><span class="token punctuation">&gt;</span></span> connectedClients<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 启动服务器
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定义一个线程池，给 channel group 用</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>THREAD_POOL_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 自定义 asyncChannelGroup</span>
            channelGroup <span class="token operator">=</span> <span class="token class-name">AsynchronousChannelGroup</span><span class="token punctuation">.</span><span class="token function">withThreadPool</span><span class="token punctuation">(</span>executorService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 开一个服务端通道</span>
            serverSocketChannel <span class="token operator">=</span> <span class="token class-name">AsynchronousServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>channelGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 绑定端口</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>LOCALHOST<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;启动服务端，监听端口：&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">+</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 监听客户端的连接请求</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 参数1：附带对象</span>
                <span class="token comment">// 参数2：客户端连接后要进行的回调</span>
                serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AcceptHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 阻塞一下，避免一直循环。</span>
                <span class="token comment">// accept 后，read 前可以做其他一些操作，因为是异步非阻塞的</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">closeResource</span><span class="token punctuation">(</span>serverSocketChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channelGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channelGroup<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closeable<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closeable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ChatServerStarter</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatServerStarter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">ChatServer</span><span class="token punctuation">(</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>AcceptHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 客户端连接完成后要做的回调
 *
 * @param   '&lt;V&gt;'     The result type of the I/O operation                      这里要返回的是客户端对应的异步通道
 * @param   '&lt;A&gt;'     The type of the object attached to the I/O operation      附加对象的类型
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AcceptHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AsynchronousSocketChannel</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BUFFER <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AsynchronousServerSocketChannel</span> serverSocketChannel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientHandler</span><span class="token punctuation">&gt;</span></span> connectedClients<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">AcceptHandler</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousServerSocketChannel</span> serverSocketChannel<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientHandler</span><span class="token punctuation">&gt;</span></span> connectedClients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel <span class="token operator">=</span> serverSocketChannel<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients <span class="token operator">=</span> connectedClients<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * IO 正常完成后要做的回调： 接收客户端发来的信息 -&gt; 转发给其他客户端
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> clientChannel<span class="token punctuation">,</span> <span class="token class-name">Object</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果服务端还在线的话，要继续监听客户端的连接请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientChannel <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> clientChannel<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ClientHandler</span> clientHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientHandler</span><span class="token punctuation">(</span>clientChannel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 添加新客户端</span>
            clientHandler<span class="token punctuation">.</span><span class="token function">addClient</span><span class="token punctuation">(</span>clientHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 接收客户端发来的信息</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 参数1：把客户端发来的信息读要 buffer 缓冲区中</span>
            <span class="token comment">// 参数2：将 buffer 作为附加对象传给回调对象</span>
            <span class="token comment">// 参数3：回调对象，每个客户端对应一个自己的 ClientHandler</span>
            clientChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> clientHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * IO 异常结束后要做的回调
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">Object</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;AcceptHandler 发生异常了，exception: &quot;</span> <span class="token operator">+</span> exc <span class="token operator">+</span> <span class="token string">&quot;，attachment: &quot;</span> <span class="token operator">+</span> attachment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ClientHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 收到客户端发来的信息后，IO 完成后要做的回调
 *
 * @param   '&lt;V&gt;'     The result type of the I/O operation                      这里是从客户端读到了多少数据，所以是 Integer
 * @param   '&lt;A&gt;'     The type of the object attached to the I/O operation      附加对象的类型，这里是 ByteBuffer
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientHandler</span> <span class="token keyword">implements</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUIT <span class="token operator">=</span> <span class="token string">&quot;quit&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Charset</span> charset <span class="token operator">=</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AsynchronousSocketChannel</span> clientChannel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientHandler</span><span class="token punctuation">&gt;</span></span> connectedClients<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ClientHandler</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> clientChannel<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientHandler</span><span class="token punctuation">&gt;</span></span> connectedClients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientChannel <span class="token operator">=</span> clientChannel<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients <span class="token operator">=</span> connectedClients<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * IO 正常完成后要做的回调： 将客户端发来的消息转发给其他客户端
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">completed</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> result<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> attachment<span class="token punctuation">;</span>

        <span class="token comment">// 如果 attachment 为空，则表示之前服务器刚刚对 buffer 完成了读操作（即已经转发了），不需要额外的操作</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
        <span class="token comment">// 如果 attachment 不为空，则表示服务器刚刚对 buffer 完成了写操作（即还没转发），现在可以来读取它</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 客户端异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">removeClient</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 将 buffer 从写模式切换为读模式</span>
            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取客户端发来的消息</span>
            <span class="token class-name">String</span> fwdMsg <span class="token operator">=</span> <span class="token function">receive</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientChannel<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;：&quot;</span> <span class="token operator">+</span> fwdMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 转发</span>
            <span class="token function">forwardMessage</span><span class="token punctuation">(</span>clientChannel<span class="token punctuation">,</span> fwdMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 判断用户是否要退出</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readyToQuit</span><span class="token punctuation">(</span>fwdMsg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 退出，移除客户端</span>
                <span class="token function">removeClient</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 不退出，继续监听客户端信息</span>
                clientChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * IO 异常结束后要做的回调
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">failed</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> exc<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> attachment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ClientHandler 发生异常了，exception: &quot;</span> <span class="token operator">+</span> exc <span class="token operator">+</span> <span class="token string">&quot;，attachment: &quot;</span> <span class="token operator">+</span> attachment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取客户端发来的消息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 构建客户端名称
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> socketChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> port <span class="token operator">=</span> <span class="token string">&quot;UNKNOWN_CLIENT&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">InetSocketAddress</span> remoteAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">)</span>clientChannel<span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            port <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> remoteAddress<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;客户端 [&quot;</span> <span class="token operator">+</span> port <span class="token operator">+</span> <span class="token string">&quot;] &quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断客户端是否要下线
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">readyToQuit</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>QUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closeable<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closeable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 添加新客户端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">addClient</span><span class="token punctuation">(</span><span class="token class-name">ClientHandler</span> clientHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clientHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span>clientHandler<span class="token punctuation">.</span>clientChannel<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;上线&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 移除异常客户端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">removeClient</span><span class="token punctuation">(</span><span class="token class-name">ClientHandler</span> clientHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span>clientHandler<span class="token punctuation">.</span>clientChannel<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;下线&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closeResource</span><span class="token punctuation">(</span>clientHandler<span class="token punctuation">.</span>clientChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 转发 self 的消息给 connectedClients 中其他的信息
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">forwardMessage</span><span class="token punctuation">(</span><span class="token class-name">AsynchronousSocketChannel</span> self<span class="token punctuation">,</span> <span class="token class-name">String</span> fwdMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClientHandler</span> clientHandler<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectedClients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 不转发给自身</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clientHandler<span class="token punctuation">.</span>clientChannel<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 转发给其他客户端</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                clientHandler<span class="token punctuation">.</span>clientChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token function">getClientName</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">+</span> fwdMsg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> clientHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 捕获异常是为了避免某个客户端出意外而导致整个系统瘫痪</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="_6-3-客户端实现"><a href="#_6-3-客户端实现" class="header-anchor">#</a> 6.3 客户端实现</h4> <ul><li><p>ChatClient</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LOCALHOST <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_PORT <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUIT <span class="token operator">=</span> <span class="token string">&quot;quit&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BUFFER <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Charset</span> charset <span class="token operator">=</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AsynchronousSocketChannel</span> clientSocketChannel<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>LOCALHOST<span class="token punctuation">,</span> DEFAULT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ChatClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 启动客户端
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获得一个客户端异步通道</span>
            clientSocketChannel <span class="token operator">=</span> <span class="token class-name">AsynchronousSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 连接服务端</span>
            <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> connectFuture <span class="token operator">=</span> clientSocketChannel<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// ======================================</span>
            <span class="token comment">// 此处可以加一些其他的操作，因为是异步非阻塞的</span>
            <span class="token comment">// ======================================</span>

            <span class="token comment">// 等待连接结束</span>
            connectFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 处理用户输入</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserInputHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 接收其他客户端的消息</span>
            <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BUFFER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> readFuture <span class="token operator">=</span> clientSocketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> result <span class="token operator">=</span> readFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;服务器断开...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">closeResource</span><span class="token punctuation">(</span>clientSocketChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 向服务器发送信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> writeFuture <span class="token operator">=</span> clientSocketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>charset<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            writeFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 判断客户端是否要下线
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">readyToQuit</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> msg<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>QUIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放资源
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">closeResource</span><span class="token punctuation">(</span><span class="token class-name">Closeable</span> closeable<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closeable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                closeable<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ChatClientStarter</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChatClientStarter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">ChatClient</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>UserInputHandler</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInputHandler</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserInputHandler</span><span class="token punctuation">(</span><span class="token class-name">ChatClient</span> chatClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chatClient <span class="token operator">=</span> chatClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">BufferedReader</span> consoleReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> input <span class="token operator">=</span> consoleReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 向服务器发送信息</span>
                chatClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 检查用户是否退出</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chatClient<span class="token punctuation">.</span><span class="token function">readyToQuit</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h4 id="_6-4-演示"><a href="#_6-4-演示" class="header-anchor">#</a> 6.4 演示</h4> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gurz0ms4zjj614k0u0n0l02.jpg" alt="image-20210924200423608"></p> <h2 id="五、使用场景"><a href="#五、使用场景" class="header-anchor">#</a> 五、使用场景</h2> <ul><li>BIO 方式适用于连接数目比较小且固定的架构，这种方式对服务器资源要求比较高，并发局限于应用中，JDK1.4 以前的唯一选择，但程序直观简单易理解。</li> <li>NIO 方式适用于连接数目多且连接比较短（轻操作）的架构，比如聊天服务器，并发局限于应用中，编程比较复杂，JDK1.4 开始支持。</li> <li>AIO 方式使用于连接数目多且连接比较长（重操作）的架构，比如相册服务器，充分调用 OS 参与并发操作，编程比较复杂，JDK7 开始支持。</li></ul> <h2 id="六、web-服务器"><a href="#六、web-服务器" class="header-anchor">#</a> 六、Web 服务器</h2> <h3 id="_1-tomcat-架构"><a href="#_1-tomcat-架构" class="header-anchor">#</a> 1. Tomcat 架构</h3> <img src="https://tva1.sinaimg.cn/large/008i3skNgy1guskg4ue1pj61hm0u0tcy02.jpg" alt="image-20210925082554884" style="zoom:33%;"> <ul><li><p>Server</p> <blockquote><ul><li>Tomcat 服务器的最顶层组件；</li> <li>负责运行 Tomcat 服务器；</li> <li>负责加载服务器资源和环境变量；</li></ul></blockquote></li> <li><p>Service</p> <blockquote><ul><li>集合 Connector 和 Engine 等其他重要组件的抽象组件；</li> <li>一个 Server 可以包含多个 Server；</li> <li>一个 Server 可以包含多个 Connector 和一个 Engine；</li></ul></blockquote></li> <li><p>Connector、Processor</p> <blockquote><ul><li>Connector 提供基于不同特定协议的实现；</li> <li>Connector 负责接收请求和回传响应；</li> <li>Processor 负责接收来自 Connector 的请求并对其进行解析和处理，并派遣至 Engine 进行处理；</li></ul></blockquote></li> <li><p>Engine</p> <blockquote><ul><li>Engine 可以理解为容器，Tomcat 中一个处理请求的组件；</li> <li>容器内部的组件按照层级排列；</li> <li>Engine 是容器的顶层组件；</li> <li>Engine 根据请求的内容进行一定的解析，然后进一步派遣请求；</li></ul></blockquote></li> <li><p>Host</p> <blockquote><ul><li>Host 代表一个虚拟主机；</li> <li>一个 Engine 可以支持多个 Host 的请求；</li> <li>Engine 通过解析请求来决定将请求发送给哪一个 Host；</li></ul></blockquote></li> <li><p>Context</p> <blockquote><ul><li>每一个 Context 代表一个 Web Application；</li> <li>Tomcat 最复杂的组件之一；</li> <li>负责应用资源管理、应用类加载、Servlet 管理和安全管理等；</li></ul></blockquote></li> <li><p>Wrapper</p> <blockquote><ul><li>Wrapper 是容器的最底层组件；</li> <li>包裹住 Servlet 实例；</li> <li>负责管理 Servlet 实例的生命周期；</li></ul></blockquote></li> <li><p>Servlet</p> <blockquote><ul><li>Servlet 是运行在 Web 服务器或应用服务器上的程序，它是作为来自 Web 浏览器或其他 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。</li> <li>使用 Servlet，可以收集来自网页表单的用户输入，呈现来自数据库或者其他源的记录，还可以动态创建网页。</li></ul></blockquote></li></ul> <h3 id="_2-实现简易版-web-服务器"><a href="#_2-实现简易版-web-服务器" class="header-anchor">#</a> 2. 实现简易版 Web 服务器</h3> <ul><li>待补充。</li></ul> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/27/2021, 10:33:23 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/java/high/io.html" class="prev">
        JavaSE —— IO
      </a></span> <span class="next"><a href="/noteSite/backend/java/high/enum.html">
        JavaSE —— 枚举类
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.bd2eec7c.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/71.69a8329a.js" defer></script>
  </body>
</html>
