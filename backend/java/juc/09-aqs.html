<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>九、AQS | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.982938bc.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/82.89fc466f.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.628f2b18.js"><link rel="prefetch" href="/noteSite/assets/js/100.7d306b5e.js"><link rel="prefetch" href="/noteSite/assets/js/101.160551e6.js"><link rel="prefetch" href="/noteSite/assets/js/102.7c6f9e17.js"><link rel="prefetch" href="/noteSite/assets/js/103.fff19bb7.js"><link rel="prefetch" href="/noteSite/assets/js/104.d01908f8.js"><link rel="prefetch" href="/noteSite/assets/js/105.80c271ab.js"><link rel="prefetch" href="/noteSite/assets/js/106.89c9d739.js"><link rel="prefetch" href="/noteSite/assets/js/107.1cb7ab0b.js"><link rel="prefetch" href="/noteSite/assets/js/108.61f8fec1.js"><link rel="prefetch" href="/noteSite/assets/js/109.992ef243.js"><link rel="prefetch" href="/noteSite/assets/js/11.0f1631cd.js"><link rel="prefetch" href="/noteSite/assets/js/110.efbfb9cd.js"><link rel="prefetch" href="/noteSite/assets/js/111.9d73b118.js"><link rel="prefetch" href="/noteSite/assets/js/112.b23eb722.js"><link rel="prefetch" href="/noteSite/assets/js/113.325c98fb.js"><link rel="prefetch" href="/noteSite/assets/js/114.9ccf23ae.js"><link rel="prefetch" href="/noteSite/assets/js/115.37da2c1c.js"><link rel="prefetch" href="/noteSite/assets/js/116.74f2e867.js"><link rel="prefetch" href="/noteSite/assets/js/117.34460619.js"><link rel="prefetch" href="/noteSite/assets/js/118.d94b2b0e.js"><link rel="prefetch" href="/noteSite/assets/js/119.c7b9bd35.js"><link rel="prefetch" href="/noteSite/assets/js/12.c90a7522.js"><link rel="prefetch" href="/noteSite/assets/js/120.f347447d.js"><link rel="prefetch" href="/noteSite/assets/js/121.5e4abb40.js"><link rel="prefetch" href="/noteSite/assets/js/122.933551fd.js"><link rel="prefetch" href="/noteSite/assets/js/123.ddc60b06.js"><link rel="prefetch" href="/noteSite/assets/js/124.f5caf8d5.js"><link rel="prefetch" href="/noteSite/assets/js/125.813aa0ae.js"><link rel="prefetch" href="/noteSite/assets/js/126.d6d26b8a.js"><link rel="prefetch" href="/noteSite/assets/js/127.8dd077f9.js"><link rel="prefetch" href="/noteSite/assets/js/128.5d433104.js"><link rel="prefetch" href="/noteSite/assets/js/129.a16ebab1.js"><link rel="prefetch" href="/noteSite/assets/js/13.f5480015.js"><link rel="prefetch" href="/noteSite/assets/js/130.7ae16ab0.js"><link rel="prefetch" href="/noteSite/assets/js/131.42024b9f.js"><link rel="prefetch" href="/noteSite/assets/js/132.146c6bb0.js"><link rel="prefetch" href="/noteSite/assets/js/133.9c656bda.js"><link rel="prefetch" href="/noteSite/assets/js/134.b789212a.js"><link rel="prefetch" href="/noteSite/assets/js/135.d5293e46.js"><link rel="prefetch" href="/noteSite/assets/js/136.30394187.js"><link rel="prefetch" href="/noteSite/assets/js/137.732aeac4.js"><link rel="prefetch" href="/noteSite/assets/js/138.68be92f0.js"><link rel="prefetch" href="/noteSite/assets/js/139.1457f144.js"><link rel="prefetch" href="/noteSite/assets/js/14.38b5da2a.js"><link rel="prefetch" href="/noteSite/assets/js/140.89b7c848.js"><link rel="prefetch" href="/noteSite/assets/js/141.31c48ab7.js"><link rel="prefetch" href="/noteSite/assets/js/142.3e5352bb.js"><link rel="prefetch" href="/noteSite/assets/js/143.d4a915cc.js"><link rel="prefetch" href="/noteSite/assets/js/144.e43553ca.js"><link rel="prefetch" href="/noteSite/assets/js/145.8ee422be.js"><link rel="prefetch" href="/noteSite/assets/js/146.5cbc525c.js"><link rel="prefetch" href="/noteSite/assets/js/147.facdbe6f.js"><link rel="prefetch" href="/noteSite/assets/js/148.9a8c077e.js"><link rel="prefetch" href="/noteSite/assets/js/149.4d4e9cbc.js"><link rel="prefetch" href="/noteSite/assets/js/15.6fd503b0.js"><link rel="prefetch" href="/noteSite/assets/js/150.b8f1f558.js"><link rel="prefetch" href="/noteSite/assets/js/151.8330bf08.js"><link rel="prefetch" href="/noteSite/assets/js/152.761ff2bd.js"><link rel="prefetch" href="/noteSite/assets/js/153.720bac4e.js"><link rel="prefetch" href="/noteSite/assets/js/154.7d43471a.js"><link rel="prefetch" href="/noteSite/assets/js/155.ecaf0258.js"><link rel="prefetch" href="/noteSite/assets/js/156.9e9ee316.js"><link rel="prefetch" href="/noteSite/assets/js/157.55d37bef.js"><link rel="prefetch" href="/noteSite/assets/js/158.013d5bb9.js"><link rel="prefetch" href="/noteSite/assets/js/159.5bf7d03b.js"><link rel="prefetch" href="/noteSite/assets/js/16.ba5205e2.js"><link rel="prefetch" href="/noteSite/assets/js/160.6341dce8.js"><link rel="prefetch" href="/noteSite/assets/js/161.6fa4d730.js"><link rel="prefetch" href="/noteSite/assets/js/162.258c5e92.js"><link rel="prefetch" href="/noteSite/assets/js/163.f730f7ed.js"><link rel="prefetch" href="/noteSite/assets/js/164.f9b86d26.js"><link rel="prefetch" href="/noteSite/assets/js/165.b3e9162f.js"><link rel="prefetch" href="/noteSite/assets/js/166.d6681897.js"><link rel="prefetch" href="/noteSite/assets/js/167.6217dcc0.js"><link rel="prefetch" href="/noteSite/assets/js/168.cb8a769d.js"><link rel="prefetch" href="/noteSite/assets/js/169.1ee8576a.js"><link rel="prefetch" href="/noteSite/assets/js/17.204dc718.js"><link rel="prefetch" href="/noteSite/assets/js/170.12ef6829.js"><link rel="prefetch" href="/noteSite/assets/js/171.fc257906.js"><link rel="prefetch" href="/noteSite/assets/js/172.a5b4c485.js"><link rel="prefetch" href="/noteSite/assets/js/173.444e623e.js"><link rel="prefetch" href="/noteSite/assets/js/174.4d26301c.js"><link rel="prefetch" href="/noteSite/assets/js/175.279b00a9.js"><link rel="prefetch" href="/noteSite/assets/js/176.8164f7b6.js"><link rel="prefetch" href="/noteSite/assets/js/177.8e7566fe.js"><link rel="prefetch" href="/noteSite/assets/js/178.c7947b50.js"><link rel="prefetch" href="/noteSite/assets/js/179.1429b7a9.js"><link rel="prefetch" href="/noteSite/assets/js/18.b9adc259.js"><link rel="prefetch" href="/noteSite/assets/js/180.c794ae05.js"><link rel="prefetch" href="/noteSite/assets/js/181.3a1626eb.js"><link rel="prefetch" href="/noteSite/assets/js/182.6f3e1601.js"><link rel="prefetch" href="/noteSite/assets/js/183.598b59d3.js"><link rel="prefetch" href="/noteSite/assets/js/184.e969f132.js"><link rel="prefetch" href="/noteSite/assets/js/185.388b5ce0.js"><link rel="prefetch" href="/noteSite/assets/js/186.0f673ceb.js"><link rel="prefetch" href="/noteSite/assets/js/187.36881f36.js"><link rel="prefetch" href="/noteSite/assets/js/188.6a799b2d.js"><link rel="prefetch" href="/noteSite/assets/js/189.e579eda6.js"><link rel="prefetch" href="/noteSite/assets/js/19.811bf034.js"><link rel="prefetch" href="/noteSite/assets/js/190.7506fadf.js"><link rel="prefetch" href="/noteSite/assets/js/191.106f242e.js"><link rel="prefetch" href="/noteSite/assets/js/192.d6aceb24.js"><link rel="prefetch" href="/noteSite/assets/js/193.2ebba9d2.js"><link rel="prefetch" href="/noteSite/assets/js/194.13f462e4.js"><link rel="prefetch" href="/noteSite/assets/js/195.754d3c13.js"><link rel="prefetch" href="/noteSite/assets/js/196.364755c8.js"><link rel="prefetch" href="/noteSite/assets/js/197.e3ca3386.js"><link rel="prefetch" href="/noteSite/assets/js/198.3d3a0db6.js"><link rel="prefetch" href="/noteSite/assets/js/199.ef0ba7a6.js"><link rel="prefetch" href="/noteSite/assets/js/20.1e1303e3.js"><link rel="prefetch" href="/noteSite/assets/js/200.00447b17.js"><link rel="prefetch" href="/noteSite/assets/js/201.355daaf1.js"><link rel="prefetch" href="/noteSite/assets/js/202.29520685.js"><link rel="prefetch" href="/noteSite/assets/js/203.6ae4c241.js"><link rel="prefetch" href="/noteSite/assets/js/204.0673f94d.js"><link rel="prefetch" href="/noteSite/assets/js/205.f15a43a6.js"><link rel="prefetch" href="/noteSite/assets/js/206.ac53bd28.js"><link rel="prefetch" href="/noteSite/assets/js/207.14a713da.js"><link rel="prefetch" href="/noteSite/assets/js/208.51e6a79c.js"><link rel="prefetch" href="/noteSite/assets/js/209.decb8a3c.js"><link rel="prefetch" href="/noteSite/assets/js/21.441725c7.js"><link rel="prefetch" href="/noteSite/assets/js/210.456e406e.js"><link rel="prefetch" href="/noteSite/assets/js/211.7f24d463.js"><link rel="prefetch" href="/noteSite/assets/js/212.3aead310.js"><link rel="prefetch" href="/noteSite/assets/js/213.c35a3c6e.js"><link rel="prefetch" href="/noteSite/assets/js/214.163c76cb.js"><link rel="prefetch" href="/noteSite/assets/js/215.cf51c97a.js"><link rel="prefetch" href="/noteSite/assets/js/216.6724bf2f.js"><link rel="prefetch" href="/noteSite/assets/js/217.521a6e8c.js"><link rel="prefetch" href="/noteSite/assets/js/218.9c9d5dda.js"><link rel="prefetch" href="/noteSite/assets/js/219.73cf48d0.js"><link rel="prefetch" href="/noteSite/assets/js/22.f7b382c7.js"><link rel="prefetch" href="/noteSite/assets/js/220.766c1467.js"><link rel="prefetch" href="/noteSite/assets/js/221.19ae02a5.js"><link rel="prefetch" href="/noteSite/assets/js/222.68582cec.js"><link rel="prefetch" href="/noteSite/assets/js/223.616685ad.js"><link rel="prefetch" href="/noteSite/assets/js/224.c39a2b5a.js"><link rel="prefetch" href="/noteSite/assets/js/225.e417d2b6.js"><link rel="prefetch" href="/noteSite/assets/js/226.d91de7a1.js"><link rel="prefetch" href="/noteSite/assets/js/227.2f317234.js"><link rel="prefetch" href="/noteSite/assets/js/228.6966fc2b.js"><link rel="prefetch" href="/noteSite/assets/js/229.dbe59769.js"><link rel="prefetch" href="/noteSite/assets/js/23.8f0590d2.js"><link rel="prefetch" href="/noteSite/assets/js/230.ae79a6b7.js"><link rel="prefetch" href="/noteSite/assets/js/231.a5a3c809.js"><link rel="prefetch" href="/noteSite/assets/js/232.c6a21570.js"><link rel="prefetch" href="/noteSite/assets/js/233.e7f3150a.js"><link rel="prefetch" href="/noteSite/assets/js/234.67230dec.js"><link rel="prefetch" href="/noteSite/assets/js/235.3bf9527b.js"><link rel="prefetch" href="/noteSite/assets/js/236.41a0cf2f.js"><link rel="prefetch" href="/noteSite/assets/js/237.08d7ccd1.js"><link rel="prefetch" href="/noteSite/assets/js/238.611d9a1f.js"><link rel="prefetch" href="/noteSite/assets/js/239.c2136c89.js"><link rel="prefetch" href="/noteSite/assets/js/24.482618e6.js"><link rel="prefetch" href="/noteSite/assets/js/240.3c6819ab.js"><link rel="prefetch" href="/noteSite/assets/js/241.704d3e6b.js"><link rel="prefetch" href="/noteSite/assets/js/242.eb880d58.js"><link rel="prefetch" href="/noteSite/assets/js/243.47e12efe.js"><link rel="prefetch" href="/noteSite/assets/js/244.43f072eb.js"><link rel="prefetch" href="/noteSite/assets/js/245.0c34b77d.js"><link rel="prefetch" href="/noteSite/assets/js/246.0de68b1d.js"><link rel="prefetch" href="/noteSite/assets/js/247.42b44bd2.js"><link rel="prefetch" href="/noteSite/assets/js/248.40ec38ed.js"><link rel="prefetch" href="/noteSite/assets/js/249.5b79a578.js"><link rel="prefetch" href="/noteSite/assets/js/25.14b70d0b.js"><link rel="prefetch" href="/noteSite/assets/js/250.d1f10c25.js"><link rel="prefetch" href="/noteSite/assets/js/251.b15f5a76.js"><link rel="prefetch" href="/noteSite/assets/js/252.afecc36d.js"><link rel="prefetch" href="/noteSite/assets/js/253.bf747d9c.js"><link rel="prefetch" href="/noteSite/assets/js/254.42639d54.js"><link rel="prefetch" href="/noteSite/assets/js/255.025e2caa.js"><link rel="prefetch" href="/noteSite/assets/js/256.a4e88e55.js"><link rel="prefetch" href="/noteSite/assets/js/257.da0c6776.js"><link rel="prefetch" href="/noteSite/assets/js/258.fd563b44.js"><link rel="prefetch" href="/noteSite/assets/js/259.37ddc4bb.js"><link rel="prefetch" href="/noteSite/assets/js/26.3824ff3c.js"><link rel="prefetch" href="/noteSite/assets/js/260.7859cb26.js"><link rel="prefetch" href="/noteSite/assets/js/261.fa5308d8.js"><link rel="prefetch" href="/noteSite/assets/js/262.d7d7ee1a.js"><link rel="prefetch" href="/noteSite/assets/js/263.4015b1c1.js"><link rel="prefetch" href="/noteSite/assets/js/264.b2107564.js"><link rel="prefetch" href="/noteSite/assets/js/265.c4a53f75.js"><link rel="prefetch" href="/noteSite/assets/js/266.0e1ef200.js"><link rel="prefetch" href="/noteSite/assets/js/267.e163d745.js"><link rel="prefetch" href="/noteSite/assets/js/268.77e888dc.js"><link rel="prefetch" href="/noteSite/assets/js/269.46036138.js"><link rel="prefetch" href="/noteSite/assets/js/27.c31353e5.js"><link rel="prefetch" href="/noteSite/assets/js/270.a6458943.js"><link rel="prefetch" href="/noteSite/assets/js/271.e230b419.js"><link rel="prefetch" href="/noteSite/assets/js/272.13f4e8d5.js"><link rel="prefetch" href="/noteSite/assets/js/273.9a4e7dd3.js"><link rel="prefetch" href="/noteSite/assets/js/274.3aa60dcb.js"><link rel="prefetch" href="/noteSite/assets/js/275.551d6f77.js"><link rel="prefetch" href="/noteSite/assets/js/276.77d06f47.js"><link rel="prefetch" href="/noteSite/assets/js/277.dd58ec69.js"><link rel="prefetch" href="/noteSite/assets/js/278.dbbd2550.js"><link rel="prefetch" href="/noteSite/assets/js/279.8ab0ac93.js"><link rel="prefetch" href="/noteSite/assets/js/28.8963a888.js"><link rel="prefetch" href="/noteSite/assets/js/280.b4553e38.js"><link rel="prefetch" href="/noteSite/assets/js/281.e5167fd3.js"><link rel="prefetch" href="/noteSite/assets/js/282.a0117b49.js"><link rel="prefetch" href="/noteSite/assets/js/283.393fd4e0.js"><link rel="prefetch" href="/noteSite/assets/js/284.2c742f89.js"><link rel="prefetch" href="/noteSite/assets/js/285.6da585c3.js"><link rel="prefetch" href="/noteSite/assets/js/286.d9c24565.js"><link rel="prefetch" href="/noteSite/assets/js/287.fe345bbb.js"><link rel="prefetch" href="/noteSite/assets/js/288.d042012e.js"><link rel="prefetch" href="/noteSite/assets/js/289.46c14e72.js"><link rel="prefetch" href="/noteSite/assets/js/29.6cba673a.js"><link rel="prefetch" href="/noteSite/assets/js/290.a4aae21a.js"><link rel="prefetch" href="/noteSite/assets/js/291.7b3a2d3c.js"><link rel="prefetch" href="/noteSite/assets/js/292.5d978984.js"><link rel="prefetch" href="/noteSite/assets/js/293.f2441bb1.js"><link rel="prefetch" href="/noteSite/assets/js/294.de71cf3e.js"><link rel="prefetch" href="/noteSite/assets/js/295.3b97f4ab.js"><link rel="prefetch" href="/noteSite/assets/js/296.3205eaa3.js"><link rel="prefetch" href="/noteSite/assets/js/297.ebf18f1d.js"><link rel="prefetch" href="/noteSite/assets/js/298.900bfcd7.js"><link rel="prefetch" href="/noteSite/assets/js/299.9ecaecb3.js"><link rel="prefetch" href="/noteSite/assets/js/3.62138a35.js"><link rel="prefetch" href="/noteSite/assets/js/30.7a286695.js"><link rel="prefetch" href="/noteSite/assets/js/300.0ac50035.js"><link rel="prefetch" href="/noteSite/assets/js/301.3db350d4.js"><link rel="prefetch" href="/noteSite/assets/js/302.8851cb81.js"><link rel="prefetch" href="/noteSite/assets/js/303.c0b1fae8.js"><link rel="prefetch" href="/noteSite/assets/js/304.cee6c429.js"><link rel="prefetch" href="/noteSite/assets/js/305.4fb0190f.js"><link rel="prefetch" href="/noteSite/assets/js/306.556813b5.js"><link rel="prefetch" href="/noteSite/assets/js/307.3337f911.js"><link rel="prefetch" href="/noteSite/assets/js/308.ab0b26a2.js"><link rel="prefetch" href="/noteSite/assets/js/309.25e1b196.js"><link rel="prefetch" href="/noteSite/assets/js/31.0a3bb7fc.js"><link rel="prefetch" href="/noteSite/assets/js/310.1b80da75.js"><link rel="prefetch" href="/noteSite/assets/js/311.f15a50be.js"><link rel="prefetch" href="/noteSite/assets/js/312.ffa651d8.js"><link rel="prefetch" href="/noteSite/assets/js/32.247ecfd6.js"><link rel="prefetch" href="/noteSite/assets/js/33.0d8d1ace.js"><link rel="prefetch" href="/noteSite/assets/js/34.d451f5d8.js"><link rel="prefetch" href="/noteSite/assets/js/35.956398a7.js"><link rel="prefetch" href="/noteSite/assets/js/36.aadcf7c5.js"><link rel="prefetch" href="/noteSite/assets/js/37.d4153187.js"><link rel="prefetch" href="/noteSite/assets/js/38.a302264c.js"><link rel="prefetch" href="/noteSite/assets/js/39.016e8561.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/40.bb4e9d8d.js"><link rel="prefetch" href="/noteSite/assets/js/41.3bff4415.js"><link rel="prefetch" href="/noteSite/assets/js/42.8c1c0cec.js"><link rel="prefetch" href="/noteSite/assets/js/43.59446b08.js"><link rel="prefetch" href="/noteSite/assets/js/44.4385e348.js"><link rel="prefetch" href="/noteSite/assets/js/45.c6ba8a4d.js"><link rel="prefetch" href="/noteSite/assets/js/46.af6bc4ca.js"><link rel="prefetch" href="/noteSite/assets/js/47.1afd53d1.js"><link rel="prefetch" href="/noteSite/assets/js/48.9c553cac.js"><link rel="prefetch" href="/noteSite/assets/js/49.992692d4.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.707d7a0d.js"><link rel="prefetch" href="/noteSite/assets/js/51.6d728c33.js"><link rel="prefetch" href="/noteSite/assets/js/52.9b50022b.js"><link rel="prefetch" href="/noteSite/assets/js/53.9b4a076a.js"><link rel="prefetch" href="/noteSite/assets/js/54.d1563c6b.js"><link rel="prefetch" href="/noteSite/assets/js/55.81a03e44.js"><link rel="prefetch" href="/noteSite/assets/js/56.c9fddb70.js"><link rel="prefetch" href="/noteSite/assets/js/57.106c99d0.js"><link rel="prefetch" href="/noteSite/assets/js/58.d28c84f2.js"><link rel="prefetch" href="/noteSite/assets/js/59.285a831b.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.42583b94.js"><link rel="prefetch" href="/noteSite/assets/js/61.4949dafc.js"><link rel="prefetch" href="/noteSite/assets/js/62.df072eca.js"><link rel="prefetch" href="/noteSite/assets/js/63.0ccb8bdb.js"><link rel="prefetch" href="/noteSite/assets/js/64.5935571d.js"><link rel="prefetch" href="/noteSite/assets/js/65.df8e926a.js"><link rel="prefetch" href="/noteSite/assets/js/66.26019a22.js"><link rel="prefetch" href="/noteSite/assets/js/67.d70ff038.js"><link rel="prefetch" href="/noteSite/assets/js/68.44700a00.js"><link rel="prefetch" href="/noteSite/assets/js/69.a9ca22d1.js"><link rel="prefetch" href="/noteSite/assets/js/7.f685cce4.js"><link rel="prefetch" href="/noteSite/assets/js/70.69059b94.js"><link rel="prefetch" href="/noteSite/assets/js/71.c6865a58.js"><link rel="prefetch" href="/noteSite/assets/js/72.effa60ca.js"><link rel="prefetch" href="/noteSite/assets/js/73.04ac42aa.js"><link rel="prefetch" href="/noteSite/assets/js/74.2b837ef2.js"><link rel="prefetch" href="/noteSite/assets/js/75.efc117db.js"><link rel="prefetch" href="/noteSite/assets/js/76.5990ce89.js"><link rel="prefetch" href="/noteSite/assets/js/77.c514ff0c.js"><link rel="prefetch" href="/noteSite/assets/js/78.3784c459.js"><link rel="prefetch" href="/noteSite/assets/js/79.0c4367c4.js"><link rel="prefetch" href="/noteSite/assets/js/8.976ce270.js"><link rel="prefetch" href="/noteSite/assets/js/80.d051aec2.js"><link rel="prefetch" href="/noteSite/assets/js/81.9c0f97b7.js"><link rel="prefetch" href="/noteSite/assets/js/83.320ed96e.js"><link rel="prefetch" href="/noteSite/assets/js/84.bf3d8a98.js"><link rel="prefetch" href="/noteSite/assets/js/85.80d5a739.js"><link rel="prefetch" href="/noteSite/assets/js/86.eb338f34.js"><link rel="prefetch" href="/noteSite/assets/js/87.3e2d0a09.js"><link rel="prefetch" href="/noteSite/assets/js/88.9f33d625.js"><link rel="prefetch" href="/noteSite/assets/js/89.bcd59f0a.js"><link rel="prefetch" href="/noteSite/assets/js/9.599a8138.js"><link rel="prefetch" href="/noteSite/assets/js/90.ba56afcb.js"><link rel="prefetch" href="/noteSite/assets/js/91.aca80f9b.js"><link rel="prefetch" href="/noteSite/assets/js/92.74693ade.js"><link rel="prefetch" href="/noteSite/assets/js/93.2b45c8ef.js"><link rel="prefetch" href="/noteSite/assets/js/94.49c19f23.js"><link rel="prefetch" href="/noteSite/assets/js/95.75569abd.js"><link rel="prefetch" href="/noteSite/assets/js/96.64fd1eef.js"><link rel="prefetch" href="/noteSite/assets/js/97.60c0a07f.js"><link rel="prefetch" href="/noteSite/assets/js/98.2a5e029f.js"><link rel="prefetch" href="/noteSite/assets/js/99.05e50471.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 常用类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 高级特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 多线程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java 并发工具类</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/java/juc/01-threadpool.html" class="sidebar-link">一、线程池</a></li><li><a href="/noteSite/backend/java/juc/02-threadloacl.html" class="sidebar-link">二、ThreadLocal</a></li><li><a href="/noteSite/backend/java/juc/03-lock.html" class="sidebar-link">三、锁</a></li><li><a href="/noteSite/backend/java/juc/04-atomic.html" class="sidebar-link">四、atomic 包</a></li><li><a href="/noteSite/backend/java/juc/05-cas.html" class="sidebar-link">五、CAS</a></li><li><a href="/noteSite/backend/java/juc/06-final.html" class="sidebar-link">六、final</a></li><li><a href="/noteSite/backend/java/juc/07-concurrentcollection.html" class="sidebar-link">七、并发集合</a></li><li><a href="/noteSite/backend/java/juc/08-concurrentcontrol.html" class="sidebar-link">八、控制并发流程</a></li><li><a href="/noteSite/backend/java/juc/09-aqs.html" aria-current="page" class="active sidebar-link">九、AQS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_1-aqs-地位" class="sidebar-link">1. AQS 地位</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_2-aqs-三要素" class="sidebar-link">2. AQS 三要素</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_2-1-state-状态" class="sidebar-link">2.1 state 状态</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_2-2-控制线程抢锁和配合的-fifo-队列" class="sidebar-link">2.2 控制线程抢锁和配合的 FIFO 队列</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_2-3-期望协作工具类去实现的获取-释放等重要方法" class="sidebar-link">2.3 期望协作工具类去实现的获取/释放等重要方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_3-countdownlatch-和-aqs-的关系" class="sidebar-link">3. CountDownLatch 和 AQS 的关系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_3-1-构造函数" class="sidebar-link">3.1 构造函数</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_3-2-getcount" class="sidebar-link">3.2 getCount()</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_3-3-countdown" class="sidebar-link">3.3 countDown()</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_3-4-await" class="sidebar-link">3.4 await()</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_4-semaphore-和-aqs-的关系" class="sidebar-link">4. Semaphore 和 AQS 的关系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_4-1-构造函数" class="sidebar-link">4.1 构造函数</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_4-2-acquire" class="sidebar-link">4.2 acquire()</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_5-aqs-和-reentrantlock-的关系" class="sidebar-link">5. AQS 和 ReentrantLock 的关系</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_5-1-构造函数" class="sidebar-link">5.1 构造函数</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_5-2-unlock" class="sidebar-link">5.2 unlock()</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_5-3-lock" class="sidebar-link">5.3 lock()</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/09-aqs.html#_6-使用-aqs-自定义一个简化版-coundownlatch" class="sidebar-link">6. 使用 AQS 自定义一个简化版 CounDownLatch</a></li></ul></li><li><a href="/noteSite/backend/java/juc/10-future.html" class="sidebar-link">十、Future</a></li><li><a href="/noteSite/backend/java/juc/11-pratice.html" class="sidebar-link">十一、实战：实现高性能缓存</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM 面试题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring 5</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot 2.x</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Hoxton</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Alibaba</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 3.4.5</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="九、aqs"><a href="#九、aqs" class="header-anchor">#</a> 九、AQS</h1> <h2 id="_1-aqs-地位"><a href="#_1-aqs-地位" class="header-anchor">#</a> 1. AQS 地位</h2> <p>事实上，不仅是 ReentrantLock 和 Semaphore，包括 CountDownLatch、ReentrantReadWriteLock 底层都用了一个共同的基类 <code>AbstractQueuedSynchronizer</code>，也就是 AQS。</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEly1gov1b0ytyrj31960gmn2k.jpg" alt="image-20210324153807263" style="zoom:50%;"> <p>因为上面的那些协作类它们有很多工作都是类似的，所以如果能提取出一个工具类，那么就可以直接使用。对于 ReentrantLock 和 Semaphore 而言就可以屏蔽很多细节，只关注它们自己的“业务逻辑”就可以了。</p> <p>如果没有 AQS，就需要每个协作工具自己实现：</p> <ol><li>同步状态的原子性管理</li> <li>线程的阻塞与解除阻塞</li> <li>队列的管理</li></ol> <p>然而这些东西都是相同的，所以提取出一个 AQS 后要实现协作工具会简单很多。</p> <h2 id="_2-aqs-三要素"><a href="#_2-aqs-三要素" class="header-anchor">#</a> 2. AQS 三要素</h2> <h3 id="_2-1-state-状态"><a href="#_2-1-state-状态" class="header-anchor">#</a> 2.1 state 状态</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
</code></pre></div><p>这里的 state 的含义会根据具体实现类的不同而不同，比如：</p> <ul><li>Semaphore 中，state 表示“<strong>剩余的许可证的数量</strong>”，当 state 为 0 的时候，说明许可证可以用完了。</li> <li>CountDownLatch 中，state 表示**“还需要倒数的数量”**，当 state(count) 为 0 的时候，表示倒计时结束了，线程继续执行。</li> <li>ReentrantLock 中，state 表示**“锁的占有情况，包括可重入计数”**，当 state 值为 0 的时候，标识着该 Lock 不被任何线程占有。</li></ul> <p>state 是 volatile 修饰的，会被并发的修改。所以所有修改 state 的方法都需要保证线程安全。</p> <p>比如 getState()、setState() 以及 compareAndSetState() 操作来读取和更新这个状态，都需要保证线程安全，这些方法也都依赖于 j.u.c.atomic 包的支持。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-2-控制线程抢锁和配合的-fifo-队列"><a href="#_2-2-控制线程抢锁和配合的-fifo-队列" class="header-anchor">#</a> 2.2 控制线程抢锁和配合的 FIFO 队列</h3> <p>这个队列用来存放“<strong>等待的线程</strong>”，AQS 就是“排队管理器”，当多个线程争用同一把锁时，必须有排队机制将那些没拿到锁的线程串在一起。当锁释放时，锁管理器就会挑选一个合适的线程来占有这个刚刚释放的锁。</p> <img src="https://tva1.sinaimg.cn/large/008eGmZEly1gov1lb6fj3j31jq0d2tel.jpg" alt="image-20210324154809853" style="zoom:33%;"> <h3 id="_2-3-期望协作工具类去实现的获取-释放等重要方法"><a href="#_2-3-期望协作工具类去实现的获取-释放等重要方法" class="header-anchor">#</a> 2.3 期望协作工具类去实现的获取/释放等重要方法</h3> <h4 id="_2-3-1-获取方法"><a href="#_2-3-1-获取方法" class="header-anchor">#</a> 2.3.1 获取方法</h4> <p>获取操作会依赖 <code>state</code> 变量，经常会阻塞（比如获取不到锁的时候）。</p> <ul><li>在 Sempahore 中，获取就是 <code>acquire()</code> 方法，作用就是<strong>获取一个许可证</strong>。</li> <li>在 CountDownLatch 中，获取就是 <code>await()</code> 方法，作用是<strong>等待，直到倒数结束</strong>。</li></ul> <h4 id="_2-3-2-释放方法"><a href="#_2-3-2-释放方法" class="header-anchor">#</a> 2.3.2 释放方法</h4> <p>释放操作不会阻塞。</p> <ul><li>在 Semaphore 中，释放就是 <code>release()</code> 方法，作用是<strong>释放一个许可证</strong>。</li> <li>在 CountDownLatch 中，释放就是 <code>countDown()</code> 方法，作用是<strong>倒数一个数</strong>。</li></ul> <h2 id="_3-countdownlatch-和-aqs-的关系"><a href="#_3-countdownlatch-和-aqs-的关系" class="header-anchor">#</a> 3. CountDownLatch 和 AQS 的关系</h2> <p>内部有一个 Sync 类继承 AQS：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatch</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Synchronization control For CountDownLatch.
     * Uses AQS state to represent count.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">4982264981922014374L</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-1-构造函数"><a href="#_3-1-构造函数" class="header-anchor">#</a> 3.1 构造函数</h3> <ul><li><code>count</code> 就是 AQS 里面的 <code>state</code></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;count &lt; 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token function">setState</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-2-getcount"><a href="#_3-2-getcount" class="header-anchor">#</a> 3.2 getCount()</h3> <ul><li>直接就是返回 AQS 的 state</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-3-countdown"><a href="#_3-3-countdown" class="header-anchor">#</a> 3.3 countDown()</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//判断是否需要将线程从 FIFO 队列中释放（count-- 后等于 0 的时候需要） </span>
  	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">//返回 true 的话就做 doReleaseShared() 将线程从 FIFO 队列中释放</span>
    		<span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span>
  	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>tryReleaseShared(arg) 在 CountDownLatch 中实现的 Sync 类中有实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatch</span> <span class="token punctuation">{</span>
  	<span class="token comment">//....</span>
  
    <span class="token comment">/**
     * Synchronization control For CountDownLatch.
     * Uses AQS state to represent count.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
      
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 死循环一般都是为了自旋来做 CAS</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">//获取 count</span>
                <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              	<span class="token comment">//如果是 0，说明之前已经被释放过了，不需要 return true 去做 doReleaseShared()。</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
              	<span class="token comment">//不是0，那就做 count--</span>
                <span class="token keyword">int</span> nextc <span class="token operator">=</span> c<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
              	<span class="token comment">//进行 CAS，并返回当前 count 是否等于 0，等于 0 说明需要做 doReleaseShared() 释放线程</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
  	<span class="token comment">//....</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果 tryReleaseShared(args) 返回了 true，也是就当前 count = 0，倒计时结束了，那么还有调用 <code>doReleaseShared()</code> 将被 CountdownLatch 阻塞的线程从 FIFO 队列中释放：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//自旋</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
      	<span class="token comment">//循环释放所有被该 CountDownLatch 共享锁阻塞的线程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ws <span class="token operator">=</span> h<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>SIGNAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token comment">// loop to recheck cases</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span>PROPAGATE<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>                <span class="token comment">// loop on failed CAS</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> head<span class="token punctuation">)</span>                   <span class="token comment">// loop if head changed</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-4-await"><a href="#_3-4-await" class="header-anchor">#</a> 3.4 await()</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//如果小于0，那就入队</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//如果不小于0，那就说明当前 CountDownLatch 正常获取锁了。</span>
<span class="token punctuation">}</span>


</code></pre></div><p><code>tryAcquireShared(arg)</code> 在 CountDownLatch 中实现的 Sync 类中有实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatch</span> <span class="token punctuation">{</span>
  	<span class="token comment">//.....</span>
  	
    <span class="token comment">/**
     * Synchronization control For CountDownLatch.
     * Uses AQS state to represent count.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
      
				<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">//如果 state(也就是count) 是 0，那就返回正数，如果不是0，就返回负数</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
  
  	<span class="token comment">//.....</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以这也就符合了 CountDownLatch 的功能了，线程 await() 到 count = 0 的时候就可以获得锁继续执行了。</p> <p>CountDownLatch 中阻塞线程让其入队的过程 <code>doAcquireSharedInterruptibly()</code> 分析如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>		<span class="token comment">/**
     * Acquires in shared interruptible mode.
     * @param arg the acquire argument
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
      	<span class="token comment">//1. 将当前线程包装成一个 Node 结点（FIFO 队列就是用 Node 结点组成的）。</span>
        <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>SHARED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">//2. 将 Node 插入 FIFO 队列中</span>
                <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                        failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token comment">//3. 然后将线程陷入阻塞状态</span>
                    <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-semaphore-和-aqs-的关系"><a href="#_4-semaphore-和-aqs-的关系" class="header-anchor">#</a> 4. Semaphore 和 AQS 的关系</h2> <ul><li><p>Semaphore 中有一个 Sync 类，Sync 继承了 AQS，而 AQS 中的 state 在 Semaphore 的意义就是<strong>剩余的许可证数量</strong>。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Semaphore</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3222578661600680210L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync<span class="token punctuation">;</span>
    <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1192457210091910933L</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h3 id="_4-1-构造函数"><a href="#_4-1-构造函数" class="header-anchor">#</a> 4.1 构造函数</h3> <ul><li>permits（许可证）就是 AQS 中的 state：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * Fair version 公平版本(非公平版本同理)
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
		<span class="token comment">//直接调用 setState</span>
    <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-2-acquire"><a href="#_4-2-acquire" class="header-anchor">#</a> 4.2 acquire()</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">permits</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用 <code>acquireSharedInterruptibly(int arg)</code>：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
  	<span class="token comment">//1. 判断线程是否已经被中断了，如果中断了就抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//2. 尝试获取锁，返回结果如果是负数的话，就将该线程放入 FIFO 阻塞队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  			<span class="token comment">//如果尝试结果是整数的话，那么说明该线程获取锁成功。</span>
<span class="token punctuation">}</span>
</code></pre></div><p>tryAcquireShared(arg) 方法在 Semaphore 中的 FairSync 和 NonFairSync 中均有实现，这里只看公平版本：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Fair version
 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">//死循环 -&gt; 自旋 -&gt; 做 CAS</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">//1. 判断当前线程是不是有队列前置</span>
            <span class="token comment">//（非公平版本没有这一步）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
          	<span class="token comment">//2. 获取当前许可证数量</span>
            <span class="token keyword">int</span> available <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">//3. 减去当前线程申请是许可证数量</span>
            <span class="token keyword">int</span> remaining <span class="token operator">=</span> available <span class="token operator">-</span> acquires<span class="token punctuation">;</span>
          	<span class="token comment">//4. 如果许可证小于0 说明不够，直接返回负数，阻塞线程；如果如果许可证大于等于0则做 CAS 后返回当前的许可证数量</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
                <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>available<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> remaining<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-aqs-和-reentrantlock-的关系"><a href="#_5-aqs-和-reentrantlock-的关系" class="header-anchor">#</a> 5. AQS 和 ReentrantLock 的关系</h2> <ul><li>在 ReentrantLock 中， AQS 的 state 就是当前锁被线程重入了多少次，0 表示当前锁没有被任何线程持有。</li></ul> <h3 id="_5-1-构造函数"><a href="#_5-1-构造函数" class="header-anchor">#</a> 5.1 构造函数</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-2-unlock"><a href="#_5-2-unlock" class="header-anchor">#</a> 5.2 unlock()</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//其实就是执行 state--</span>
    sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>release()：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//1. 尝试去做 state--，并返回锁是否被释放</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
      	<span class="token comment">//3. 通知其他线程锁已经被释放了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">//2. 如果锁没有被释放则返回 false</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>tryRelease() 在 ReentrantLock 中的 Sync 类有实现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//1. 进行 state--</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>
  	<span class="token comment">//2. 判断当前线程是否持有锁，没有锁的话就直接抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  	<span class="token comment">//3. state = 0 说明该锁已被释放</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      	<span class="token comment">//5. 将锁的持有者置为null</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">//6. 更新 state</span>
    <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//7. 返回当前锁是否已经被释放</span>
    <span class="token keyword">return</span> free<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-3-lock"><a href="#_5-3-lock" class="header-anchor">#</a> 5.3 lock()</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>sync.lock():  以非公平为例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">//1. 进行 CAS，只有当前 state 是 0，也就是没有人持有该锁的时候，才去设置 state 为 1 表示持有该锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          	<span class="token comment">//2. 将当前线程设置为持有该锁的线程</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
          	<span class="token comment">//2. CAS 失败，表示锁已经被占有了</span>
            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>sync.acquire():</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
      	<span class="token comment">//① !tryAcquire(arg) 尝试获取锁失败</span>
        <span class="token comment">//② acquireQueued(addWaiter(Node.EXCLUSIVE), arg)  竞争锁失败</span>
      	<span class="token comment">//中断锁</span>
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先去 tryAcquire(arg) 尝试获取锁：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//1. 获取当前线程</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//2. 获取当前 state</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//3. 如果 state = 0，那就占有该锁。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">//4. 如果当前线程本身就持有锁了</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">//5. 那就可重入，state + 1</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
      	<span class="token comment">//特殊情况：锁可重入次数超过了 int 的范围，整形溢出，直接忽略这种奇葩情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//6. 更新 state，也就是技术锁的重入次数</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//7. 返回 true</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">//8. 占不到锁，返回 false</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获取锁失败后，将当前线程封装成 Node 再 acquireQueued(final Node node, int arg) 。然后由于目前是 NonfairSync 非公平锁，那么它会尝试去竞争一下，看看有没有可能获取到锁，如果获取不到的话，再进入阻塞队列。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">//竞争失败标志</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      	<span class="token comment">//中断标志</span>
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      	<span class="token comment">//1. 循环尝试竞争</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
              	<span class="token comment">//2. 抢占成功</span>
                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
              	<span class="token comment">//目前 interrupt 是 false，表示不中断</span>
                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          	<span class="token comment">//3. 竞争失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      	<span class="token comment">//4. 竞争失败，就放弃获取锁，进入队列</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-使用-aqs-自定义一个简化版-coundownlatch"><a href="#_6-使用-aqs-自定义一个简化版-coundownlatch" class="header-anchor">#</a> 6. 使用 AQS 自定义一个简化版 CounDownLatch</h2> <div class="language-markdown extra-class"><pre class="language-markdown"><code><span class="token title important"><span class="token punctuation">#</span> AQS 用法</span>
<span class="token list punctuation">1.</span> 写一个类，想好协作的逻辑，实现获取/释放方法。
<span class="token list punctuation">2.</span> 内部写一个 Sync 类继承 AbstractQueuedSynchronizer。
<span class="token list punctuation">3.</span> 根据是否独占来重写 tryAcquires 和 tryReleaseShared(int releases) 等方法，在之前写的获取/是否方法中调用 AQS 的 acquire/release 或者 shared 方法。
</code></pre></div><p>目标：一次倒数，count 从 1-&gt; 0 后所有线程都出发。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 描述：自己用 AQS 实现一个简单的线程协作器。
 *      一个简易版 CountDownLatch，当 count 从 1-&gt;0 的时候，唤醒所有线程。
 *
 * @author Hedon Wang
 * @create 2021-03-24 4:54 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OneShotLatch</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sync</span> sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取锁</span>
        <span class="token comment">/*
            public final void acquireShared(int arg) {
                if (tryAcquireShared(arg) &lt; 0)
                     doAcquireShared(arg);
            }
         */</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放，打开门闩
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//释放锁</span>
        <span class="token comment">/*
            public final boolean releaseShared(int arg) {
                if (tryReleaseShared(arg)) {
                     doReleaseShared();
                     return true;
                }
                return false;
            }
         */</span>
        sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 内部类 Sync 继承 AQS
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">{</span>

        <span class="token comment">/**
         * 尝试获取锁
         *
         * return 正数：获得锁成功
         * return 负数：获得锁失败，阻塞
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 如果 state = 1，说明门闩已经被打开了，当前线程直接获得锁
             * 如果 state = 0，说明门闩没有被打开，会让当前线程去排队等待
             */</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 尝试释放锁
         */</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//简化版 CountDownLatch，直接将 state 置为 1，说明门闩已经被打开了，所以会唤醒所有被阻塞的线程</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 测试
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">OneShotLatch</span> oneShotLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OneShotLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	
      	<span class="token comment">//阻塞10个线程</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;尝试获取 Latch...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    oneShotLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获取 Latch 成功，继续执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//10秒后开门闩</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;================================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;==========主线程开门闩了==========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;================================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oneShotLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：</p> <div class="language- extra-class"><pre class="language-text"><code>Thread-0尝试获取 Latch...
Thread-2尝试获取 Latch...
Thread-4尝试获取 Latch...
Thread-3尝试获取 Latch...
Thread-1尝试获取 Latch...
Thread-7尝试获取 Latch...
Thread-6尝试获取 Latch...
Thread-5尝试获取 Latch...
Thread-9尝试获取 Latch...
Thread-8尝试获取 Latch...
================================
==========主线程开门闩了==========
================================
Thread-0获取 Latch 成功，继续执行
Thread-2获取 Latch 成功，继续执行
Thread-4获取 Latch 成功，继续执行
Thread-3获取 Latch 成功，继续执行
Thread-1获取 Latch 成功，继续执行
Thread-6获取 Latch 成功，继续执行
Thread-5获取 Latch 成功，继续执行
Thread-7获取 Latch 成功，继续执行
Thread-9获取 Latch 成功，继续执行
Thread-8获取 Latch 成功，继续执行
</code></pre></div><!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">11/1/2021, 10:07:49 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/java/juc/08-concurrentcontrol.html" class="prev">
        八、控制并发流程
      </a></span> <span class="next"><a href="/noteSite/backend/java/juc/10-future.html">
        十、Future
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.982938bc.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/82.89fc466f.js" defer></script>
  </body>
</html>
