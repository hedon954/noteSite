<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>三、锁 | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.2953f62f.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.691adf44.js" as="script"><link rel="preload" href="/noteSite/assets/js/42.4900306c.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.b5f22773.js"><link rel="prefetch" href="/noteSite/assets/js/100.4b33d7c3.js"><link rel="prefetch" href="/noteSite/assets/js/101.392f8227.js"><link rel="prefetch" href="/noteSite/assets/js/102.9bfe4167.js"><link rel="prefetch" href="/noteSite/assets/js/103.e4e03064.js"><link rel="prefetch" href="/noteSite/assets/js/104.62637337.js"><link rel="prefetch" href="/noteSite/assets/js/105.c8c805b7.js"><link rel="prefetch" href="/noteSite/assets/js/106.6f7d1cdb.js"><link rel="prefetch" href="/noteSite/assets/js/107.2652a056.js"><link rel="prefetch" href="/noteSite/assets/js/108.9a0c0b59.js"><link rel="prefetch" href="/noteSite/assets/js/109.eda50082.js"><link rel="prefetch" href="/noteSite/assets/js/11.0e4d5955.js"><link rel="prefetch" href="/noteSite/assets/js/110.0f1c8e4c.js"><link rel="prefetch" href="/noteSite/assets/js/111.eb555cb6.js"><link rel="prefetch" href="/noteSite/assets/js/112.03af3565.js"><link rel="prefetch" href="/noteSite/assets/js/113.6714b5af.js"><link rel="prefetch" href="/noteSite/assets/js/114.1b555101.js"><link rel="prefetch" href="/noteSite/assets/js/115.5392c099.js"><link rel="prefetch" href="/noteSite/assets/js/116.b378672a.js"><link rel="prefetch" href="/noteSite/assets/js/117.9ec786ab.js"><link rel="prefetch" href="/noteSite/assets/js/118.fe45acc6.js"><link rel="prefetch" href="/noteSite/assets/js/119.c138f8e8.js"><link rel="prefetch" href="/noteSite/assets/js/12.52df0590.js"><link rel="prefetch" href="/noteSite/assets/js/120.c4e15462.js"><link rel="prefetch" href="/noteSite/assets/js/121.2b93893a.js"><link rel="prefetch" href="/noteSite/assets/js/122.a57bf8ba.js"><link rel="prefetch" href="/noteSite/assets/js/123.2ee3c26c.js"><link rel="prefetch" href="/noteSite/assets/js/124.c4a4dd2d.js"><link rel="prefetch" href="/noteSite/assets/js/125.de456d51.js"><link rel="prefetch" href="/noteSite/assets/js/126.6a4b4255.js"><link rel="prefetch" href="/noteSite/assets/js/127.27b7263c.js"><link rel="prefetch" href="/noteSite/assets/js/128.1fcaa1ab.js"><link rel="prefetch" href="/noteSite/assets/js/129.2d108348.js"><link rel="prefetch" href="/noteSite/assets/js/13.d3c300ba.js"><link rel="prefetch" href="/noteSite/assets/js/130.7d2c279e.js"><link rel="prefetch" href="/noteSite/assets/js/131.24d246c4.js"><link rel="prefetch" href="/noteSite/assets/js/132.38d534e4.js"><link rel="prefetch" href="/noteSite/assets/js/133.d4a000c0.js"><link rel="prefetch" href="/noteSite/assets/js/134.932fe5cd.js"><link rel="prefetch" href="/noteSite/assets/js/135.145a50ba.js"><link rel="prefetch" href="/noteSite/assets/js/136.e40a7ffc.js"><link rel="prefetch" href="/noteSite/assets/js/137.ddd64399.js"><link rel="prefetch" href="/noteSite/assets/js/138.698fa45d.js"><link rel="prefetch" href="/noteSite/assets/js/139.24652a87.js"><link rel="prefetch" href="/noteSite/assets/js/14.c4835766.js"><link rel="prefetch" href="/noteSite/assets/js/140.2d1a81cf.js"><link rel="prefetch" href="/noteSite/assets/js/141.8d171f9e.js"><link rel="prefetch" href="/noteSite/assets/js/142.29ff1ed0.js"><link rel="prefetch" href="/noteSite/assets/js/143.4264324e.js"><link rel="prefetch" href="/noteSite/assets/js/144.48ebdf74.js"><link rel="prefetch" href="/noteSite/assets/js/145.c9ba968f.js"><link rel="prefetch" href="/noteSite/assets/js/146.0f709eac.js"><link rel="prefetch" href="/noteSite/assets/js/147.872f0a31.js"><link rel="prefetch" href="/noteSite/assets/js/148.71bc7655.js"><link rel="prefetch" href="/noteSite/assets/js/149.58adc4e3.js"><link rel="prefetch" href="/noteSite/assets/js/15.7076b1d5.js"><link rel="prefetch" href="/noteSite/assets/js/150.60b9b9b6.js"><link rel="prefetch" href="/noteSite/assets/js/151.a776fdc3.js"><link rel="prefetch" href="/noteSite/assets/js/152.a060453e.js"><link rel="prefetch" href="/noteSite/assets/js/153.5a2b0a23.js"><link rel="prefetch" href="/noteSite/assets/js/154.2606401c.js"><link rel="prefetch" href="/noteSite/assets/js/155.91d139e0.js"><link rel="prefetch" href="/noteSite/assets/js/156.8dc31ede.js"><link rel="prefetch" href="/noteSite/assets/js/157.855b58c4.js"><link rel="prefetch" href="/noteSite/assets/js/158.5d9ad288.js"><link rel="prefetch" href="/noteSite/assets/js/159.c87d7a7e.js"><link rel="prefetch" href="/noteSite/assets/js/16.d5e99138.js"><link rel="prefetch" href="/noteSite/assets/js/160.0c1693ab.js"><link rel="prefetch" href="/noteSite/assets/js/161.e1cbb71c.js"><link rel="prefetch" href="/noteSite/assets/js/162.a44399e8.js"><link rel="prefetch" href="/noteSite/assets/js/163.b1c01726.js"><link rel="prefetch" href="/noteSite/assets/js/164.2dcd039f.js"><link rel="prefetch" href="/noteSite/assets/js/165.9b6e81f2.js"><link rel="prefetch" href="/noteSite/assets/js/166.00c671f8.js"><link rel="prefetch" href="/noteSite/assets/js/167.470dab9b.js"><link rel="prefetch" href="/noteSite/assets/js/168.1285e02e.js"><link rel="prefetch" href="/noteSite/assets/js/169.cd0750ce.js"><link rel="prefetch" href="/noteSite/assets/js/17.8311cdff.js"><link rel="prefetch" href="/noteSite/assets/js/170.e6cf444f.js"><link rel="prefetch" href="/noteSite/assets/js/171.4d959750.js"><link rel="prefetch" href="/noteSite/assets/js/172.d850e914.js"><link rel="prefetch" href="/noteSite/assets/js/173.a7a8030a.js"><link rel="prefetch" href="/noteSite/assets/js/174.47f8be9c.js"><link rel="prefetch" href="/noteSite/assets/js/175.a00f8fa2.js"><link rel="prefetch" href="/noteSite/assets/js/176.c4ebe9a4.js"><link rel="prefetch" href="/noteSite/assets/js/177.eb7ae5e1.js"><link rel="prefetch" href="/noteSite/assets/js/178.d6c9ac03.js"><link rel="prefetch" href="/noteSite/assets/js/179.f45bf3fe.js"><link rel="prefetch" href="/noteSite/assets/js/18.f50c0ee3.js"><link rel="prefetch" href="/noteSite/assets/js/180.b49c2acf.js"><link rel="prefetch" href="/noteSite/assets/js/181.452ae7e3.js"><link rel="prefetch" href="/noteSite/assets/js/182.bf580942.js"><link rel="prefetch" href="/noteSite/assets/js/183.3b6f01d2.js"><link rel="prefetch" href="/noteSite/assets/js/19.c0215774.js"><link rel="prefetch" href="/noteSite/assets/js/20.359043f9.js"><link rel="prefetch" href="/noteSite/assets/js/21.7c0a6071.js"><link rel="prefetch" href="/noteSite/assets/js/22.c8731325.js"><link rel="prefetch" href="/noteSite/assets/js/23.6f74a633.js"><link rel="prefetch" href="/noteSite/assets/js/24.531b5cbf.js"><link rel="prefetch" href="/noteSite/assets/js/25.563da1a0.js"><link rel="prefetch" href="/noteSite/assets/js/26.cce0d974.js"><link rel="prefetch" href="/noteSite/assets/js/27.6a4f4064.js"><link rel="prefetch" href="/noteSite/assets/js/28.f6f1a60d.js"><link rel="prefetch" href="/noteSite/assets/js/29.8ba6931d.js"><link rel="prefetch" href="/noteSite/assets/js/3.3603e1d5.js"><link rel="prefetch" href="/noteSite/assets/js/30.1e496c21.js"><link rel="prefetch" href="/noteSite/assets/js/31.63c482b8.js"><link rel="prefetch" href="/noteSite/assets/js/32.d4097080.js"><link rel="prefetch" href="/noteSite/assets/js/33.8b44cb4f.js"><link rel="prefetch" href="/noteSite/assets/js/34.cfd0d2e5.js"><link rel="prefetch" href="/noteSite/assets/js/35.13330a0e.js"><link rel="prefetch" href="/noteSite/assets/js/36.897a22da.js"><link rel="prefetch" href="/noteSite/assets/js/37.d795ab98.js"><link rel="prefetch" href="/noteSite/assets/js/38.50e6bf7f.js"><link rel="prefetch" href="/noteSite/assets/js/39.86aa09aa.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/40.316c5032.js"><link rel="prefetch" href="/noteSite/assets/js/41.7369a57f.js"><link rel="prefetch" href="/noteSite/assets/js/43.53ebc897.js"><link rel="prefetch" href="/noteSite/assets/js/44.214ae715.js"><link rel="prefetch" href="/noteSite/assets/js/45.458561dd.js"><link rel="prefetch" href="/noteSite/assets/js/46.d6faa7e0.js"><link rel="prefetch" href="/noteSite/assets/js/47.6449c6cf.js"><link rel="prefetch" href="/noteSite/assets/js/48.63966bf4.js"><link rel="prefetch" href="/noteSite/assets/js/49.e747331c.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.1e60cc38.js"><link rel="prefetch" href="/noteSite/assets/js/51.e42b9312.js"><link rel="prefetch" href="/noteSite/assets/js/52.95b4e096.js"><link rel="prefetch" href="/noteSite/assets/js/53.87d3e53d.js"><link rel="prefetch" href="/noteSite/assets/js/54.0e70cdd1.js"><link rel="prefetch" href="/noteSite/assets/js/55.3c03c62b.js"><link rel="prefetch" href="/noteSite/assets/js/56.ddea3642.js"><link rel="prefetch" href="/noteSite/assets/js/57.40d3bee1.js"><link rel="prefetch" href="/noteSite/assets/js/58.a1197820.js"><link rel="prefetch" href="/noteSite/assets/js/59.917c2f49.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.0cb171dc.js"><link rel="prefetch" href="/noteSite/assets/js/61.3c63d1dc.js"><link rel="prefetch" href="/noteSite/assets/js/62.d431ec85.js"><link rel="prefetch" href="/noteSite/assets/js/63.915e94ec.js"><link rel="prefetch" href="/noteSite/assets/js/64.a120ec70.js"><link rel="prefetch" href="/noteSite/assets/js/65.fae8975f.js"><link rel="prefetch" href="/noteSite/assets/js/66.44b14cce.js"><link rel="prefetch" href="/noteSite/assets/js/67.b8c999a5.js"><link rel="prefetch" href="/noteSite/assets/js/68.1abd5336.js"><link rel="prefetch" href="/noteSite/assets/js/69.93fa5ecc.js"><link rel="prefetch" href="/noteSite/assets/js/7.db572721.js"><link rel="prefetch" href="/noteSite/assets/js/70.c6704a7b.js"><link rel="prefetch" href="/noteSite/assets/js/71.cf29baff.js"><link rel="prefetch" href="/noteSite/assets/js/72.39b7d291.js"><link rel="prefetch" href="/noteSite/assets/js/73.2be65c67.js"><link rel="prefetch" href="/noteSite/assets/js/74.e3aabfd0.js"><link rel="prefetch" href="/noteSite/assets/js/75.fb82b744.js"><link rel="prefetch" href="/noteSite/assets/js/76.bab04d24.js"><link rel="prefetch" href="/noteSite/assets/js/77.4b3b2e63.js"><link rel="prefetch" href="/noteSite/assets/js/78.26322910.js"><link rel="prefetch" href="/noteSite/assets/js/79.9b0fffb6.js"><link rel="prefetch" href="/noteSite/assets/js/8.1e22ea55.js"><link rel="prefetch" href="/noteSite/assets/js/80.7b4913f8.js"><link rel="prefetch" href="/noteSite/assets/js/81.6f4b7b65.js"><link rel="prefetch" href="/noteSite/assets/js/82.75af4f07.js"><link rel="prefetch" href="/noteSite/assets/js/83.ece5c212.js"><link rel="prefetch" href="/noteSite/assets/js/84.ae9a4cd0.js"><link rel="prefetch" href="/noteSite/assets/js/85.b7bb8f31.js"><link rel="prefetch" href="/noteSite/assets/js/86.947d90df.js"><link rel="prefetch" href="/noteSite/assets/js/87.36086bf1.js"><link rel="prefetch" href="/noteSite/assets/js/88.f43dcc5c.js"><link rel="prefetch" href="/noteSite/assets/js/89.26aaf9fd.js"><link rel="prefetch" href="/noteSite/assets/js/9.60e414aa.js"><link rel="prefetch" href="/noteSite/assets/js/90.f4e64e66.js"><link rel="prefetch" href="/noteSite/assets/js/91.8705d931.js"><link rel="prefetch" href="/noteSite/assets/js/92.c092e80b.js"><link rel="prefetch" href="/noteSite/assets/js/93.980edac0.js"><link rel="prefetch" href="/noteSite/assets/js/94.b4a3bebd.js"><link rel="prefetch" href="/noteSite/assets/js/95.fa620015.js"><link rel="prefetch" href="/noteSite/assets/js/96.7484da3f.js"><link rel="prefetch" href="/noteSite/assets/js/97.54df73e6.js"><link rel="prefetch" href="/noteSite/assets/js/98.6bb2ea29.js"><link rel="prefetch" href="/noteSite/assets/js/99.3ea28dc1.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 常用类</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 高级特性</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 多线程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java 并发工具类</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/java/juc/01-threadpool.html" class="sidebar-link">一、线程池</a></li><li><a href="/noteSite/backend/java/juc/02-threadloacl.html" class="sidebar-link">二、ThreadLocal</a></li><li><a href="/noteSite/backend/java/juc/03-lock.html" aria-current="page" class="active sidebar-link">三、锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_1-lock" class="sidebar-link">1. Lock</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_1-1-简介" class="sidebar-link">1.1 简介</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_1-2-为什么-synchronized-不够用" class="sidebar-link">1.2 为什么 synchronized 不够用？</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_1-3-主要方法" class="sidebar-link">1.3 主要方法</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_1-4-可见性的保证" class="sidebar-link">1.4 可见性的保证</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-锁的分类" class="sidebar-link">2. 锁的分类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-1-乐观锁和悲观锁" class="sidebar-link">2.1 乐观锁和悲观锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-2-可重入锁和非可重入锁" class="sidebar-link">2.2 可重入锁和非可重入锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-3-公平锁和非公平锁" class="sidebar-link">2.3 公平锁和非公平锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-4-共享锁和排它锁" class="sidebar-link">2.4 共享锁和排它锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-5-自旋锁和阻塞锁" class="sidebar-link">2.5 自旋锁和阻塞锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-6-可中断和不可中断锁" class="sidebar-link">2.6 可中断和不可中断锁</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/java/juc/03-lock.html#_2-7-锁优化" class="sidebar-link">2.7 锁优化</a></li></ul></li></ul></li><li><a href="/noteSite/backend/java/juc/04-atomic.html" class="sidebar-link">四、atomic 包</a></li><li><a href="/noteSite/backend/java/juc/05-cas.html" class="sidebar-link">五、CAS</a></li><li><a href="/noteSite/backend/java/juc/06-final.html" class="sidebar-link">六、final</a></li><li><a href="/noteSite/backend/java/juc/07-concurrentcollection.html" class="sidebar-link">七、并发集合</a></li><li><a href="/noteSite/backend/java/juc/08-concurrentcontrol.html" class="sidebar-link">八、控制并发流程</a></li><li><a href="/noteSite/backend/java/juc/09-aqs.html" class="sidebar-link">九、AQS</a></li><li><a href="/noteSite/backend/java/juc/10-future.html" class="sidebar-link">十、Future</a></li><li><a href="/noteSite/backend/java/juc/11-pratice.html" class="sidebar-link">十一、实战：实现高性能缓存</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java 虚拟机</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring 5</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot 2.x</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Hoxton</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud Alibaba</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MyBatis 3.4.5</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="三、锁"><a href="#三、锁" class="header-anchor">#</a> 三、锁</h1> <h2 id="_1-lock"><a href="#_1-lock" class="header-anchor">#</a> 1. Lock</h2> <h3 id="_1-1-简介"><a href="#_1-1-简介" class="header-anchor">#</a> 1.1 简介</h3> <ul><li>锁是一种工具，用于控制对共享资源的访问。</li> <li>Lock 和 synchronized，这两个是最常见的锁，它们都可以达到线程安全的目的，但是在使用上和功能上又有较大的不同。</li> <li>Lock 并不是用来代替 synchronized 的，而是当 synchronized 不适合或不足以满足要求的时候，来提供高级功能的。</li> <li>Lock 接口中最常见的实现类是 <code>ReentrantLock</code></li> <li>通常情况下，Lock 只允许一个线程来访问这个共享资源。不过有的时候，一些特殊的实现也可允许并发访问，比如 ReadWriteLock 里面的 ReadLock。</li></ul> <h3 id="_1-2-为什么-synchronized-不够用"><a href="#_1-2-为什么-synchronized-不够用" class="header-anchor">#</a> 1.2 为什么 synchronized 不够用？</h3> <ol><li>效率低：锁的释放情况少、试图获得锁时不能设定超时、不能中断一个正在尝试获得锁的线程。</li> <li>不够灵活（读写锁更灵活）：加锁和释放的时机单一，每个锁仅有单一的条件（某个对象），可能是不够的。</li> <li>无法知道是否成功获取到锁。</li></ol> <h3 id="_1-3-主要方法"><a href="#_1-3-主要方法" class="header-anchor">#</a> 1.3 主要方法</h3> <ul><li><p>void lock()</p> <blockquote><p>获取锁。如果锁已被其他线程获取，则等待。</p> <p>需要主动在 finally 中释放锁。</p> <p>lock() 方法不能被中断，这会带来很大的隐患：一旦陷入死锁，lock() 就会陷入永久等待。</p></blockquote></li> <li><p>boolean tryLock()</p> <blockquote><p>尝试获取锁，如果当前锁没有被其他线程占用，则获取成功，则返回 true，否则返回 false，代表获取失败。</p></blockquote></li> <li><p>boolean tryLock(long time, TimeUnit unit)</p> <blockquote><p>在一定时间内一直尝试获取锁，超时则放弃。</p></blockquote></li> <li><p>void lockInterruptibly() throws InterruptedException</p> <blockquote><p>相等于 tryLock(long time, TimeUnit unit) 把时间设置为无限。在等待锁的过程中，线程可以被中断。</p></blockquote></li> <li><p>void unLock()</p> <blockquote><p>尝试释放锁。</p></blockquote></li></ul> <p>ReentrantLock 的拓展方法</p> <ul><li><p>boolean isHeldByCurrentThread()</p> <blockquote><p>判断锁是否被当前线程持有。</p></blockquote></li> <li><p>int getQueueLength()</p> <blockquote><p>可以返回当前正在等待这把锁的队列有多长。</p></blockquote></li></ul> <h3 id="_1-4-可见性的保证"><a href="#_1-4-可见性的保证" class="header-anchor">#</a> 1.4 可见性的保证</h3> <img src="https://tva1.sinaimg.cn/large/008eGmZEly1gop30lbdx6j313g0siqc7.jpg" alt="image-20210319120402944" style="zoom:50%;"> <h2 id="_2-锁的分类"><a href="#_2-锁的分类" class="header-anchor">#</a> 2. 锁的分类</h2> <img src="https://tva1.sinaimg.cn/large/008eGmZEly1gop3232czuj31fa0satqu.jpg" alt="image-20210319120531375" style="zoom:50%;"> <h3 id="_2-1-乐观锁和悲观锁"><a href="#_2-1-乐观锁和悲观锁" class="header-anchor">#</a> 2.1 乐观锁和悲观锁</h3> <h4 id="_2-1-1-悲观锁的劣势"><a href="#_2-1-1-悲观锁的劣势" class="header-anchor">#</a> 2.1.1 悲观锁的劣势</h4> <ul><li>阻塞和唤醒带来的性能劣势。</li> <li>永久阻塞：如果持有锁的线程被永久阻塞，比如遇到了无限循环、死锁等活跃性问题，那么等待该线程释放锁的那几个悲催的线程，将永远也得不到执行。</li> <li>可能造成优先级反转。</li></ul> <h4 id="_2-1-2-乐观锁"><a href="#_2-1-2-乐观锁" class="header-anchor">#</a> 2.1.2 乐观锁</h4> <p>想假设不会有问题，继续操作，操作完再检查有没有问题，没问题就直接提交，有问题再具体处理。</p> <p>乐观锁的实现一般都是利用 <strong>CAS</strong> 算法来实现的。</p> <h4 id="_2-1-3-使用场景"><a href="#_2-1-3-使用场景" class="header-anchor">#</a> 2.1.3 使用场景</h4> <ul><li>悲观锁
<ul><li>适合并发写入多的情况，适用于临界区持锁时间比较长的情况，悲观锁可以避免大量无用自旋等消耗，典型情况：
<ul><li>临界区有 IO 操作</li> <li>临界区代码复杂或者循环量大</li> <li>临界区竞争非常激烈</li></ul></li></ul></li> <li>乐观锁
<ul><li>适合并发写入少、大部分是读取的场景，不加锁能让性能大幅度提高。</li></ul></li></ul> <h3 id="_2-2-可重入锁和非可重入锁"><a href="#_2-2-可重入锁和非可重入锁" class="header-anchor">#</a> 2.2 可重入锁和非可重入锁</h3> <h4 id="_2-2-1-可重入"><a href="#_2-2-1-可重入" class="header-anchor">#</a> 2.2.1 可重入</h4> <ul><li>同一个线程获得锁后，可以在不释放锁的情况下再次获得该锁。</li></ul> <h4 id="_2-2-2-源码对比-可重入锁-reentrantlock-和非可重入锁-threadpoolexecutor-的-worker-类"><a href="#_2-2-2-源码对比-可重入锁-reentrantlock-和非可重入锁-threadpoolexecutor-的-worker-类" class="header-anchor">#</a> 2.2.2 源码对比：可重入锁 ReentrantLock 和非可重入锁 ThreadPoolExecutor 的 Worker 类</h4> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEly1gopikzg6i3j30wf0lhn9o.jpg" alt="image-20210319210225187"></p> <h3 id="_2-3-公平锁和非公平锁"><a href="#_2-3-公平锁和非公平锁" class="header-anchor">#</a> 2.3 公平锁和非公平锁</h3> <h4 id="_2-3-1-什么是公平和非公平"><a href="#_2-3-1-什么是公平和非公平" class="header-anchor">#</a> 2.3.1 什么是公平和非公平</h4> <p>公平指的是按照线程请求的顺序来分配锁。</p> <p>非公平是指不完全按照请求的顺序，在一定情况下可以插队。</p> <blockquote><p>PS：非公平是指“在合适的时机”插队，而不是盲目插队。</p></blockquote> <p><font color="pink">只有在申请锁的那一瞬间可以插队，一旦进入了等待队列，就不能插队了。</font></p> <h4 id="_2-3-2-为什么要有非公平锁"><a href="#_2-3-2-为什么要有非公平锁" class="header-anchor">#</a> 2.3.2 为什么要有非公平锁</h4> <ul><li>提高效率</li> <li>避免唤醒带来的空档期。</li></ul> <h4 id="_2-3-3-演示"><a href="#_2-3-3-演示" class="header-anchor">#</a> 2.3.3 演示</h4> <ul><li><p>公平锁</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 演示公平锁
 *
 * @author Hedon Wang
 * @create 2021-03-19 9:17 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FairLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token class-name">PrintQueue</span> printQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">[</span><span class="token punctuation">]</span> threads <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Job</span><span class="token punctuation">(</span>printQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Job</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">PrintQueue</span> printQueue<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Job</span><span class="token punctuation">(</span><span class="token class-name">PrintQueue</span> printQueue<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>printQueue <span class="token operator">=</span> printQueue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;开始打印&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        printQueue<span class="token punctuation">.</span><span class="token function">printJob</span><span class="token punctuation">(</span>printQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;打印完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">PrintQueue</span><span class="token punctuation">{</span>

    <span class="token comment">//true 表示公平</span>
    <span class="token keyword">private</span> <span class="token class-name">Lock</span> queueLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printJob</span><span class="token punctuation">(</span><span class="token class-name">Object</span> document<span class="token punctuation">)</span><span class="token punctuation">{</span>
      
      	<span class="token comment">//打印第一次</span>
        queueLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在打印1，需要&quot;</span> <span class="token operator">+</span> duration<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            queueLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
				
      	<span class="token comment">//打印第二次</span>
        queueLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在打印2，需要&quot;</span> <span class="token operator">+</span> duration<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            queueLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：可以看出在公平锁的情况下，10个线程都进入队列，本来线程 Thread0 要打印 2 次的，但是因为打印完第 1 次后就释放锁了，锁就被排在队列的后面那个线程 Thread1 拿到了，然后当前线程 Thread0 想在获取锁就只能去队列后面继续排队了，所以打印顺序非常整齐。</p> <div class="language- extra-class"><pre class="language-text"><code>Thread-0开始打印
Thread-0正在打印1，需要2s
Thread-1开始打印
Thread-2开始打印
Thread-3开始打印
Thread-4开始打印
Thread-5开始打印
Thread-6开始打印
Thread-7开始打印
Thread-8开始打印
Thread-9开始打印
Thread-1正在打印1，需要7s         
Thread-2正在打印1，需要2s
Thread-3正在打印1，需要9s
Thread-4正在打印1，需要3s
Thread-5正在打印1，需要10s
Thread-6正在打印1，需要4s
Thread-7正在打印1，需要9s
Thread-8正在打印1，需要3s
Thread-9正在打印1，需要4s
Thread-0正在打印2，需要0s
Thread-0打印完毕
Thread-1正在打印2，需要0s
Thread-1打印完毕
Thread-2正在打印2，需要0s
Thread-2打印完毕
Thread-3正在打印2，需要0s
Thread-3打印完毕
Thread-4正在打印2，需要0s
Thread-4打印完毕
Thread-5正在打印2，需要0s
Thread-5打印完毕
Thread-6正在打印2，需要0s
Thread-6打印完毕
Thread-7正在打印2，需要0s
Thread-7打印完毕
Thread-8正在打印2，需要0s
Thread-8打印完毕
Thread-9正在打印2，需要0s
Thread-9打印完毕
</code></pre></div></li> <li><p>非公平锁</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 演示非公平锁
 *
 * @author Hedon Wang
 * @create 2021-03-19 9:17 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnFairLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token class-name">UnFairPrintQueue</span> unFairPrintQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnFairPrintQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">[</span><span class="token punctuation">]</span> threads <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UnFairJob</span><span class="token punctuation">(</span>unFairPrintQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threads<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            threads<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UnFairJob</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">UnFairPrintQueue</span> unFairPrintQueue<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">UnFairJob</span><span class="token punctuation">(</span><span class="token class-name">UnFairPrintQueue</span> unFairPrintQueue<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>unFairPrintQueue <span class="token operator">=</span> unFairPrintQueue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;开始打印&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        unFairPrintQueue<span class="token punctuation">.</span><span class="token function">printJob</span><span class="token punctuation">(</span>unFairPrintQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;打印完毕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UnFairPrintQueue</span><span class="token punctuation">{</span>

    <span class="token comment">//false 表示不公平，默认就是 false</span>
    <span class="token keyword">private</span> <span class="token class-name">Lock</span> queueLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">printJob</span><span class="token punctuation">(</span><span class="token class-name">Object</span> document<span class="token punctuation">)</span><span class="token punctuation">{</span>
        queueLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1000</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在打印1，需要&quot;</span> <span class="token operator">+</span> duration<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            queueLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        queueLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在打印2，需要&quot;</span> <span class="token operator">+</span> duration<span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            queueLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果：可以看到在非公平锁的情况下，因为唤醒线程需要开销，而且开销比较大， 而当 Thread0 释放锁后想再次尝试获取锁，它是不需要唤醒线程的，效率非常快，所以就插队成功，获取到锁了。于是就出现了 Thread0 连续打印 2 次的情况了。</p> <div class="language- extra-class"><pre class="language-text"><code>Thread-0开始打印
Thread-0正在打印1，需要10s
Thread-1开始打印
Thread-2开始打印
Thread-3开始打印
Thread-4开始打印
Thread-5开始打印
Thread-6开始打印
Thread-7开始打印
Thread-8开始打印
Thread-9开始打印
Thread-0正在打印2，需要0s
Thread-0打印完毕
Thread-1正在打印1，需要6s
Thread-1正在打印2，需要0s
Thread-1打印完毕
Thread-2正在打印1，需要8s
Thread-2正在打印2，需要0s
Thread-2打印完毕
Thread-3正在打印1，需要7s
Thread-3正在打印2，需要0s
Thread-3打印完毕
Thread-4正在打印1，需要6s
Thread-4正在打印2，需要0s
Thread-4打印完毕
Thread-5正在打印1，需要10s
Thread-5正在打印2，需要0s
Thread-5打印完毕
Thread-6正在打印1，需要6s
Thread-6正在打印2，需要0s
Thread-6打印完毕
Thread-7正在打印1，需要9s
Thread-8正在打印1，需要2s
Thread-8正在打印2，需要0s
Thread-8打印完毕
Thread-9正在打印1，需要4s
Thread-9正在打印2，需要0s
Thread-9打印完毕
Thread-7正在打印2，需要0s			//第二次打印前申请锁的时候没有抢到锁，所以只能进入队列里面按“公平锁”的方式等待。
Thread-7打印完毕
</code></pre></div></li></ul> <h4 id="_2-3-4-特例"><a href="#_2-3-4-特例" class="header-anchor">#</a> 2.3.4 特例</h4> <p>针对 <code>tryLock()</code> 方法，它不遵守设定的公平的规则。</p> <p>当有线程执行 tryLock() 的时候，一旦有现场释放了锁，那么这个正在 tryLock 的线程就能获取到锁，即使在它之前已经有其他线程在等待队列里了。</p> <h4 id="_2-3-5-对比"><a href="#_2-3-5-对比" class="header-anchor">#</a> 2.3.5 对比</h4> <img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gopjbirravj30vx0fcafu.jpg" alt="image-20210319212810726" style="zoom:50%;"> <h4 id="_2-3-6-源码"><a href="#_2-3-6-源码" class="header-anchor">#</a> 2.3.6 源码</h4> <p><img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gopjcto6jwj30z10ejtia.jpg" alt="image-20210319212926134"></p> <h3 id="_2-4-共享锁和排它锁"><a href="#_2-4-共享锁和排它锁" class="header-anchor">#</a> 2.4 共享锁和排它锁</h3> <h4 id="_2-4-1-什么是共享锁和排它锁"><a href="#_2-4-1-什么是共享锁和排它锁" class="header-anchor">#</a> 2.4.1 什么是共享锁和排它锁</h4> <ul><li>排它锁：独占锁、独享锁。</li> <li>共享锁：又称为读锁。获得共享锁后，可以查看但无法修改和删除数据，其他线程此时也可以获取到共享锁，也可以查看但无法修改和删除数据。</li> <li>ReentrantReadWriteLock，其中读锁是共享锁，写锁是排它锁。</li></ul> <h4 id="_2-4-2-作用"><a href="#_2-4-2-作用" class="header-anchor">#</a> 2.4.2 作用</h4> <ul><li>在没有读写锁之前，我们假设使用 ReentrantLock，那么虽然我们保证了线程安全，但是也浪费了一定的资源：多个读同时进行，并没有线程安全问题。</li> <li>在读的地方使用读锁，在写的地方使用写锁，灵活控制，提高了程序的执行效率。</li></ul> <h4 id="_2-4-3-规则"><a href="#_2-4-3-规则" class="header-anchor">#</a> 2.4.3 规则</h4> <ol><li>多个线程只申请读锁，都可以申请到。</li> <li>如果有一个线程已经占用了读锁，则此时其他线程如果要申请写锁，则申请写锁的线程会一直等待读锁的释放。</li> <li>如果有一个线程已经占用了写锁，则此时其他线程如果申请写锁或读锁，则申请的线程会一直等待释放写锁。</li> <li>要么多读，要么一写。</li></ol> <h4 id="_2-4-4-使用示例"><a href="#_2-4-4-使用示例" class="header-anchor">#</a> 2.4.4 使用示例</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 演示读写锁的用法
 *
 * @author Hedon Wang
 * @create 2021-03-20 11:00 AM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ReentrantReadWriteLock</span> reentrantReadWriteLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> readLock <span class="token operator">=</span> reentrantReadWriteLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writeLock <span class="token operator">=</span> reentrantReadWriteLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;得到了读锁。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;释放读锁。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;得到了写锁。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;释放写锁。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>结果：写锁可以共存，读锁只能有一个。</p> <div class="language- extra-class"><pre class="language-text"><code>Thread-0得到了读锁。
Thread-1得到了读锁。
Thread-1释放读锁。
Thread-0释放读锁。
Thread-2得到了写锁。
Thread-2释放写锁。
Thread-3得到了写锁。
Thread-3释放写锁。
</code></pre></div><h4 id="_2-4-5-读写锁交互方式"><a href="#_2-4-5-读写锁交互方式" class="header-anchor">#</a> 2.4.5 读写锁交互方式</h4> <h5 id="_1-读写锁插队策略"><a href="#_1-读写锁插队策略" class="header-anchor">#</a> ① 读写锁插队策略</h5> <ul><li><p>公平锁：<u>不插队</u></p></li> <li><p>非公平：<u>写锁可以随时插队，读锁仅在等待队列头结点不是想获取写锁的线程的时候可以插队。</u></p> <ul><li><p>假设线程2和线程4正在同时读取，线程3想要写入，拿不到锁，于是进入等待队列。线程5不在队列，现在过来想要读取。</p> <ul><li>策略[1]：让5插队。效率高，但是容易造成饥饿。</li></ul> <img src="https://tva1.sinaimg.cn/large/008eGmZEly1goq71x27u8j30ps0d3q77.jpg" alt="image-20210320110911731" style="zoom:67%;"> <ul><li>策略[2]：不让5插队。避免饥饿，但是效率较低。（<font color="pink">ReentrantReadWriteLock 默认采用该策略</font>）</li></ul> <img src="https://tva1.sinaimg.cn/large/008eGmZEly1goq73wrorzj30ov0ayq4q.jpg" alt="image-20210320111114564" style="zoom:67%;"></li></ul></li></ul> <h5 id="_2-锁的升降级策略"><a href="#_2-锁的升降级策略" class="header-anchor">#</a> ② 锁的升降级策略</h5> <ul><li>升级：读锁 -&gt; 写锁（<font color="pink">ReentrantReadWriteLock 不支持</font>）
<ul><li>读的话大家可以一起读，写只能一个写，读升级写的锁，就可能存在读和写共存的状态，所以要求其他读线程要释放读锁。</li> <li>如果这个时候2个读锁都要升级，那么这2个都要求对方释放读锁，就造成死锁。</li></ul></li> <li>降级：写锁 -&gt; 读锁（<font color="pink">ReentrantReadWriteLock 支持</font>）
<ul><li>写完后想读又不想被打断，可以提高性能。</li></ul></li></ul> <h3 id="_2-5-自旋锁和阻塞锁"><a href="#_2-5-自旋锁和阻塞锁" class="header-anchor">#</a> 2.5 自旋锁和阻塞锁</h3> <h4 id="_2-5-1-自旋锁的意义"><a href="#_2-5-1-自旋锁的意义" class="header-anchor">#</a> 2.5.1 自旋锁的意义</h4> <ul><li>阻塞和唤醒一个 Java 线程需要操作系统切换 CPU 状态来完成，这种状态转换需要耗费处理器时间。</li> <li>如果同步代码块中的内容过于简单，<u>状态转换消耗的时间有可能比用户代码执行的时间还要长</u>。</li> <li>在许多场景中，同步资源的锁定时间很短，为了这一小段时间去切换线程，线程挂起和恢复线程的花费可能会让系统得不偿失。</li> <li>如果物理机器有多个处理器，能够让两个或以上的线程同时并行执行，我们就可以让后面那个请求锁的线程不放弃 CPU 的执行时间，看看持有锁的线程是否很快就会释放锁。</li> <li>而为了让当前线程“稍等一下”，我们需让当前线程进行自旋，如果在自旋完成之前前面锁定同步资源的线程已经释放了锁，那么当前线程就可以不必阻塞而直接获取同步资源，从而避免切换线程的开销，这就是自旋锁。</li></ul> <h4 id="_2-5-2-自旋锁的缺点"><a href="#_2-5-2-自旋锁的缺点" class="header-anchor">#</a> 2.5.2 自旋锁的缺点</h4> <ul><li>如果锁被占用的时间很长，那么自旋的线程只会白白浪费 CPU 资源。</li></ul> <h4 id="_2-5-3-自旋锁的应用"><a href="#_2-5-3-自旋锁的应用" class="header-anchor">#</a> 2.5.3 自旋锁的应用</h4> <ul><li><p>在 java1.5 版本及以上的并发框架 JUC 和 atomic 包下的类基本都是自旋锁的实现。</p></li> <li><p>AtomicInteger 中自旋锁的实现原理是 CAS。</p> <ul><li><p>AtomicInteger 中调用 unsafe 进行自增操作的源码中的 do-while 循环就是一个自旋操作，如果修改过程中遇到其他线程竞争导致没修改成功，就在 while 里死循环，直至修改成功。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> <span class="token keyword">int</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> var5<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        var5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIntVolatile</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var5<span class="token punctuation">,</span> var5 <span class="token operator">+</span> var4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> var5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li></ul> <h4 id="_2-5-4-手写一个自旋锁"><a href="#_2-5-4-手写一个自旋锁" class="header-anchor">#</a> 2.5.4 手写一个自旋锁</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 实现一个自旋锁
 *
 * @author Hedon Wang
 * @create 2021-03-20 12:04 PM
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateSpinLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> sign <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 加锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//CAS 操作，锁就是期望将锁赋值为当前线程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>sign<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;正在自旋&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">//CAS 操作，就是希望将当前锁设置为 null，释放</span>
        sign<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CreateSpinLock</span> spinLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateSpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;尝试获取自旋锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                spinLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;获得了自旋锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    spinLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;释放了自旋锁&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>runnable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-6-可中断和不可中断锁"><a href="#_2-6-可中断和不可中断锁" class="header-anchor">#</a> 2.6 可中断和不可中断锁</h3> <ul><li>如果某一线程 A 正在执行锁中的代码，另一线程 B 正在等待获取该锁。可能由于等待时间过长，线程 B 不想等待了，想先处理其他的事情，我们可以中断它，这就是可中断锁。</li> <li>synchronized 就是不可中断锁，ReentrantLock 就是可中断锁。</li></ul> <h3 id="_2-7-锁优化"><a href="#_2-7-锁优化" class="header-anchor">#</a> 2.7 锁优化</h3> <h4 id="_2-7-1-自旋锁和自适应"><a href="#_2-7-1-自旋锁和自适应" class="header-anchor">#</a> 2.7.1 自旋锁和自适应</h4> <blockquote><p>自旋：如果线程可以很快获取锁，那么可以不在 OS 层挂起线程，而是让线程<strong>做几个忙循环</strong>，这就是自旋。</p></blockquote> <p><strong>自适应自旋</strong>：自旋的时间不再固定，而是由前一次在同一个锁上的自旋时间和锁的拥有者状态来决定。</p> <ul><li>如果锁被占用的时间很短，自旋成功，那么能节省线程挂起以及切换时间，从而提升系统性能。</li> <li>如果锁被占用时间很长，自旋失败，会白白耗费处理器资源，降低系统性能。</li></ul> <h4 id="_2-7-2-锁消除"><a href="#_2-7-2-锁消除" class="header-anchor">#</a> 2.7.2 锁消除</h4> <blockquote><p>在编译代码的时候，JVM 检查到根据不存在共享数据竞争，自然也就无需同步加锁了，JVM 会帮我们把我们加的锁去掉。</p></blockquote> <p>用 <code>-XX:+EliminateLocks</code> 来开启。</p> <p>同时要使用 <code>-XX:+DoEscapeAnalysis</code> 开启<strong>逃逸分析</strong>，所谓逃逸分析：</p> <ul><li>如果一个方法中定义的一个对象，可能被外部方法引用，称为方法逃逸。</li> <li>如果对象可能被其他外部线程访问，称为线程逃逸。
<ul><li>比如赋值给类变量或者可以在其他线程中访问的实例变量。</li></ul></li></ul> <p><font color="pink">（因为一旦出现逃逸，就不能轻易消除锁了，无法得知外部是如何使用我们的资源了，该同步还是得同步。）</font></p> <h4 id="_2-7-3-锁粗化"><a href="#_2-7-3-锁粗化" class="header-anchor">#</a> 2.7.3 锁粗化</h4> <blockquote><p>通常我们都要求同步块要小，但一系列连续的操作导致对一个对象反复的加锁和解锁，这会导致不必要的性能损耗，这种情况建议把锁同步的范围加大到整个操作序列。</p></blockquote> <h4 id="_2-7-4-轻量级锁"><a href="#_2-7-4-轻量级锁" class="header-anchor">#</a> 2.7.4 轻量级锁</h4> <p>轻量级是相对于传统锁机制而言的，本意是没有多线程竞争的情况下，减少传统锁机制使用 OS 实现互斥所产生的性能损耗。</p> <p>实现原理很简单，就是类似乐观锁的方式。</p> <p>如果轻量级锁失败，表示存在竞争，那么 JVM 就会将其升级为重量级锁，导致性能下降（因为多了一次尝试）。</p> <h4 id="_2-7-5-偏向锁"><a href="#_2-7-5-偏向锁" class="header-anchor">#</a> 2.7.5 偏向锁</h4> <blockquote><p>偏向锁是在无竞争情况下，直接把整个同步消除了，连乐观锁都不用，从而提高性能。</p> <p>所谓偏向，就是偏向，即锁会偏向于当前已经占有锁的线程。</p></blockquote> <p>只要没有竞争，获得偏向锁的线程在将来进入同步块也不需要做同步。</p> <p>当有其他线程请求相同的锁时，偏向模式结束。</p> <p>如果程序中大多数锁总是被多个线程访问的时候，也就是竞争比较激烈，偏向锁反而会降低性能。</p> <p>使用 <code>-XX:-UseBiasedLocking</code> 来禁用偏向锁，默认是开启的。</p> <h4 id="_2-7-6-jvm-中获取锁的步骤"><a href="#_2-7-6-jvm-中获取锁的步骤" class="header-anchor">#</a> 2.7.6 JVM 中获取锁的步骤</h4> <div class="language-flow extra-class"><pre class="language-flow"><code>st<span class="token operator">=&gt;</span>start<span class="token operator">:</span> 尝试偏向锁
e<span class="token operator">=&gt;</span>end<span class="token operator">:</span> 尝试普通锁，使用 <span class="token constant">OS</span> 互斥量在操作系统层挂起
op2<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> 尝试轻量级锁
op3<span class="token operator">=&gt;</span>operation<span class="token operator">:</span> 尝试自旋锁
st<span class="token operator">-</span><span class="token operator">&gt;</span>op2<span class="token operator">-</span><span class="token operator">&gt;</span>op3<span class="token operator">-</span><span class="token operator">&gt;</span>e
</code></pre></div><!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">9/17/2021, 12:28:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/java/juc/02-threadloacl.html" class="prev">
        二、ThreadLocal
      </a></span> <span class="next"><a href="/noteSite/backend/java/juc/04-atomic.html">
        四、atomic 包
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.2953f62f.js" defer></script><script src="/noteSite/assets/js/2.691adf44.js" defer></script><script src="/noteSite/assets/js/42.4900306c.js" defer></script>
  </body>
</html>
