<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Golang 标准库丨sync | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.2b5d8ceb.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.b9284a39.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/48.8b80dd37.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.cbe5c6e4.js"><link rel="prefetch" href="/noteSite/assets/js/100.19f69c48.js"><link rel="prefetch" href="/noteSite/assets/js/101.b4966c39.js"><link rel="prefetch" href="/noteSite/assets/js/102.c2854bda.js"><link rel="prefetch" href="/noteSite/assets/js/103.e1d37ed9.js"><link rel="prefetch" href="/noteSite/assets/js/104.504909b6.js"><link rel="prefetch" href="/noteSite/assets/js/105.9167b9d9.js"><link rel="prefetch" href="/noteSite/assets/js/106.e8a2cd8a.js"><link rel="prefetch" href="/noteSite/assets/js/107.5a7a3462.js"><link rel="prefetch" href="/noteSite/assets/js/108.92ddcbd8.js"><link rel="prefetch" href="/noteSite/assets/js/109.c9a08483.js"><link rel="prefetch" href="/noteSite/assets/js/11.c8c52c63.js"><link rel="prefetch" href="/noteSite/assets/js/110.e08eda89.js"><link rel="prefetch" href="/noteSite/assets/js/111.0c0568ba.js"><link rel="prefetch" href="/noteSite/assets/js/112.b9096957.js"><link rel="prefetch" href="/noteSite/assets/js/113.8efd8c16.js"><link rel="prefetch" href="/noteSite/assets/js/114.db861eb2.js"><link rel="prefetch" href="/noteSite/assets/js/115.053b7c2e.js"><link rel="prefetch" href="/noteSite/assets/js/116.7d038731.js"><link rel="prefetch" href="/noteSite/assets/js/117.bb87e769.js"><link rel="prefetch" href="/noteSite/assets/js/118.0d0dc9fd.js"><link rel="prefetch" href="/noteSite/assets/js/119.15203d32.js"><link rel="prefetch" href="/noteSite/assets/js/12.92824130.js"><link rel="prefetch" href="/noteSite/assets/js/120.a81b73ad.js"><link rel="prefetch" href="/noteSite/assets/js/121.89f608a6.js"><link rel="prefetch" href="/noteSite/assets/js/122.46cfa30c.js"><link rel="prefetch" href="/noteSite/assets/js/123.ea8b6bf9.js"><link rel="prefetch" href="/noteSite/assets/js/124.74c12ce2.js"><link rel="prefetch" href="/noteSite/assets/js/125.413f6994.js"><link rel="prefetch" href="/noteSite/assets/js/126.866db143.js"><link rel="prefetch" href="/noteSite/assets/js/127.009021e5.js"><link rel="prefetch" href="/noteSite/assets/js/128.3f2d30e3.js"><link rel="prefetch" href="/noteSite/assets/js/129.7e2b74ef.js"><link rel="prefetch" href="/noteSite/assets/js/13.1cc5b2e9.js"><link rel="prefetch" href="/noteSite/assets/js/130.d14b5a02.js"><link rel="prefetch" href="/noteSite/assets/js/131.41a194b1.js"><link rel="prefetch" href="/noteSite/assets/js/132.71c1476c.js"><link rel="prefetch" href="/noteSite/assets/js/133.19c26e39.js"><link rel="prefetch" href="/noteSite/assets/js/134.b634e0af.js"><link rel="prefetch" href="/noteSite/assets/js/135.cc3ee90a.js"><link rel="prefetch" href="/noteSite/assets/js/136.9f841708.js"><link rel="prefetch" href="/noteSite/assets/js/137.88d7d4ec.js"><link rel="prefetch" href="/noteSite/assets/js/138.c4b27a7b.js"><link rel="prefetch" href="/noteSite/assets/js/139.5a6afcf2.js"><link rel="prefetch" href="/noteSite/assets/js/14.07f62b45.js"><link rel="prefetch" href="/noteSite/assets/js/140.06a64080.js"><link rel="prefetch" href="/noteSite/assets/js/141.b84f71be.js"><link rel="prefetch" href="/noteSite/assets/js/142.833c9e53.js"><link rel="prefetch" href="/noteSite/assets/js/143.24707960.js"><link rel="prefetch" href="/noteSite/assets/js/144.57954177.js"><link rel="prefetch" href="/noteSite/assets/js/145.20a210f5.js"><link rel="prefetch" href="/noteSite/assets/js/146.eafa8df6.js"><link rel="prefetch" href="/noteSite/assets/js/147.583369d0.js"><link rel="prefetch" href="/noteSite/assets/js/148.b889e775.js"><link rel="prefetch" href="/noteSite/assets/js/149.a96b08e4.js"><link rel="prefetch" href="/noteSite/assets/js/15.d07ec6b9.js"><link rel="prefetch" href="/noteSite/assets/js/150.9c65e35f.js"><link rel="prefetch" href="/noteSite/assets/js/151.d5c8a5bc.js"><link rel="prefetch" href="/noteSite/assets/js/152.dbae70c4.js"><link rel="prefetch" href="/noteSite/assets/js/153.064d77eb.js"><link rel="prefetch" href="/noteSite/assets/js/154.32b6abdc.js"><link rel="prefetch" href="/noteSite/assets/js/155.9a697ad7.js"><link rel="prefetch" href="/noteSite/assets/js/156.40c2a7b4.js"><link rel="prefetch" href="/noteSite/assets/js/157.82609f44.js"><link rel="prefetch" href="/noteSite/assets/js/158.2152fa0c.js"><link rel="prefetch" href="/noteSite/assets/js/159.a1a376b2.js"><link rel="prefetch" href="/noteSite/assets/js/16.48cf37d9.js"><link rel="prefetch" href="/noteSite/assets/js/160.beb90d27.js"><link rel="prefetch" href="/noteSite/assets/js/161.b8936bb8.js"><link rel="prefetch" href="/noteSite/assets/js/162.e764d26f.js"><link rel="prefetch" href="/noteSite/assets/js/163.888ebe37.js"><link rel="prefetch" href="/noteSite/assets/js/164.4ba57c40.js"><link rel="prefetch" href="/noteSite/assets/js/165.9292ad3f.js"><link rel="prefetch" href="/noteSite/assets/js/166.df95e28c.js"><link rel="prefetch" href="/noteSite/assets/js/167.513c7165.js"><link rel="prefetch" href="/noteSite/assets/js/168.169d86c1.js"><link rel="prefetch" href="/noteSite/assets/js/169.122360d8.js"><link rel="prefetch" href="/noteSite/assets/js/17.3d6b3528.js"><link rel="prefetch" href="/noteSite/assets/js/170.c8ac44aa.js"><link rel="prefetch" href="/noteSite/assets/js/171.1ec4603d.js"><link rel="prefetch" href="/noteSite/assets/js/172.6d19d64e.js"><link rel="prefetch" href="/noteSite/assets/js/173.0431c7e4.js"><link rel="prefetch" href="/noteSite/assets/js/174.0de084dd.js"><link rel="prefetch" href="/noteSite/assets/js/175.a61b6126.js"><link rel="prefetch" href="/noteSite/assets/js/176.9cc07d05.js"><link rel="prefetch" href="/noteSite/assets/js/177.98020514.js"><link rel="prefetch" href="/noteSite/assets/js/178.1c6633f0.js"><link rel="prefetch" href="/noteSite/assets/js/179.c475c0b5.js"><link rel="prefetch" href="/noteSite/assets/js/18.920cb685.js"><link rel="prefetch" href="/noteSite/assets/js/180.e9c0a1c9.js"><link rel="prefetch" href="/noteSite/assets/js/181.6771acea.js"><link rel="prefetch" href="/noteSite/assets/js/182.9e8936aa.js"><link rel="prefetch" href="/noteSite/assets/js/183.cb1a15b2.js"><link rel="prefetch" href="/noteSite/assets/js/184.4d88e065.js"><link rel="prefetch" href="/noteSite/assets/js/185.4b54ff71.js"><link rel="prefetch" href="/noteSite/assets/js/186.0ee6a8f5.js"><link rel="prefetch" href="/noteSite/assets/js/187.a755f1c2.js"><link rel="prefetch" href="/noteSite/assets/js/188.2631663c.js"><link rel="prefetch" href="/noteSite/assets/js/189.f60ceca7.js"><link rel="prefetch" href="/noteSite/assets/js/19.7e79d0e6.js"><link rel="prefetch" href="/noteSite/assets/js/190.35481f1f.js"><link rel="prefetch" href="/noteSite/assets/js/191.691e6349.js"><link rel="prefetch" href="/noteSite/assets/js/192.87ec2d4c.js"><link rel="prefetch" href="/noteSite/assets/js/193.749a378f.js"><link rel="prefetch" href="/noteSite/assets/js/194.3acc69ee.js"><link rel="prefetch" href="/noteSite/assets/js/195.5bed5b38.js"><link rel="prefetch" href="/noteSite/assets/js/196.a94e02cb.js"><link rel="prefetch" href="/noteSite/assets/js/197.a3c0658a.js"><link rel="prefetch" href="/noteSite/assets/js/198.05cc3f02.js"><link rel="prefetch" href="/noteSite/assets/js/199.4c164648.js"><link rel="prefetch" href="/noteSite/assets/js/20.a9a32a1a.js"><link rel="prefetch" href="/noteSite/assets/js/200.b3c9273d.js"><link rel="prefetch" href="/noteSite/assets/js/201.0a3e60c8.js"><link rel="prefetch" href="/noteSite/assets/js/202.a9e9d608.js"><link rel="prefetch" href="/noteSite/assets/js/203.57354cc1.js"><link rel="prefetch" href="/noteSite/assets/js/204.fe42fb95.js"><link rel="prefetch" href="/noteSite/assets/js/205.0c08b9d2.js"><link rel="prefetch" href="/noteSite/assets/js/206.833dc871.js"><link rel="prefetch" href="/noteSite/assets/js/207.5a2a8b4c.js"><link rel="prefetch" href="/noteSite/assets/js/208.f795c213.js"><link rel="prefetch" href="/noteSite/assets/js/209.b0d23adf.js"><link rel="prefetch" href="/noteSite/assets/js/21.0f5e752e.js"><link rel="prefetch" href="/noteSite/assets/js/210.1280cd05.js"><link rel="prefetch" href="/noteSite/assets/js/211.98496298.js"><link rel="prefetch" href="/noteSite/assets/js/212.f2dc9891.js"><link rel="prefetch" href="/noteSite/assets/js/213.0f6425f2.js"><link rel="prefetch" href="/noteSite/assets/js/214.386ddcc3.js"><link rel="prefetch" href="/noteSite/assets/js/215.8236b389.js"><link rel="prefetch" href="/noteSite/assets/js/216.4be75104.js"><link rel="prefetch" href="/noteSite/assets/js/217.50f76d84.js"><link rel="prefetch" href="/noteSite/assets/js/218.67e5cb73.js"><link rel="prefetch" href="/noteSite/assets/js/219.8104ebba.js"><link rel="prefetch" href="/noteSite/assets/js/22.d1559e58.js"><link rel="prefetch" href="/noteSite/assets/js/220.0a207b0e.js"><link rel="prefetch" href="/noteSite/assets/js/221.4b6d2a73.js"><link rel="prefetch" href="/noteSite/assets/js/222.8d830201.js"><link rel="prefetch" href="/noteSite/assets/js/223.d9c77957.js"><link rel="prefetch" href="/noteSite/assets/js/224.87a748c5.js"><link rel="prefetch" href="/noteSite/assets/js/225.5fd45feb.js"><link rel="prefetch" href="/noteSite/assets/js/226.dd6836a8.js"><link rel="prefetch" href="/noteSite/assets/js/227.a1a7bb48.js"><link rel="prefetch" href="/noteSite/assets/js/228.a74693fd.js"><link rel="prefetch" href="/noteSite/assets/js/229.e469cd2d.js"><link rel="prefetch" href="/noteSite/assets/js/23.c42ab1cc.js"><link rel="prefetch" href="/noteSite/assets/js/230.be40d802.js"><link rel="prefetch" href="/noteSite/assets/js/231.a7ab891b.js"><link rel="prefetch" href="/noteSite/assets/js/232.0e9a0a51.js"><link rel="prefetch" href="/noteSite/assets/js/233.28b5c092.js"><link rel="prefetch" href="/noteSite/assets/js/24.833a668b.js"><link rel="prefetch" href="/noteSite/assets/js/25.26f30d29.js"><link rel="prefetch" href="/noteSite/assets/js/26.8716506f.js"><link rel="prefetch" href="/noteSite/assets/js/27.8db1b159.js"><link rel="prefetch" href="/noteSite/assets/js/28.eacfb905.js"><link rel="prefetch" href="/noteSite/assets/js/29.c7e2c8bd.js"><link rel="prefetch" href="/noteSite/assets/js/3.2b4bcb8b.js"><link rel="prefetch" href="/noteSite/assets/js/30.4500dccd.js"><link rel="prefetch" href="/noteSite/assets/js/31.6facda36.js"><link rel="prefetch" href="/noteSite/assets/js/32.c7a01519.js"><link rel="prefetch" href="/noteSite/assets/js/33.f350693e.js"><link rel="prefetch" href="/noteSite/assets/js/34.69de4dbc.js"><link rel="prefetch" href="/noteSite/assets/js/35.3c111ca9.js"><link rel="prefetch" href="/noteSite/assets/js/36.ca3be510.js"><link rel="prefetch" href="/noteSite/assets/js/37.ff09b3d4.js"><link rel="prefetch" href="/noteSite/assets/js/38.91c18363.js"><link rel="prefetch" href="/noteSite/assets/js/39.996192e0.js"><link rel="prefetch" href="/noteSite/assets/js/4.80421812.js"><link rel="prefetch" href="/noteSite/assets/js/40.4b5d823c.js"><link rel="prefetch" href="/noteSite/assets/js/41.dc76bc0d.js"><link rel="prefetch" href="/noteSite/assets/js/42.af68a448.js"><link rel="prefetch" href="/noteSite/assets/js/43.23c2aabe.js"><link rel="prefetch" href="/noteSite/assets/js/44.c5376c7d.js"><link rel="prefetch" href="/noteSite/assets/js/45.4c03ce4a.js"><link rel="prefetch" href="/noteSite/assets/js/46.82580081.js"><link rel="prefetch" href="/noteSite/assets/js/47.8592023b.js"><link rel="prefetch" href="/noteSite/assets/js/49.ec892e7c.js"><link rel="prefetch" href="/noteSite/assets/js/5.4170108b.js"><link rel="prefetch" href="/noteSite/assets/js/50.87731030.js"><link rel="prefetch" href="/noteSite/assets/js/51.c88291b3.js"><link rel="prefetch" href="/noteSite/assets/js/52.1570ab6d.js"><link rel="prefetch" href="/noteSite/assets/js/53.f8d89b4b.js"><link rel="prefetch" href="/noteSite/assets/js/54.c503353f.js"><link rel="prefetch" href="/noteSite/assets/js/55.4eb096b2.js"><link rel="prefetch" href="/noteSite/assets/js/56.9acd88d9.js"><link rel="prefetch" href="/noteSite/assets/js/57.fec3da97.js"><link rel="prefetch" href="/noteSite/assets/js/58.29fa0160.js"><link rel="prefetch" href="/noteSite/assets/js/59.f1c2ceb5.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.4af13e38.js"><link rel="prefetch" href="/noteSite/assets/js/61.af3d4457.js"><link rel="prefetch" href="/noteSite/assets/js/62.e6776798.js"><link rel="prefetch" href="/noteSite/assets/js/63.e408258b.js"><link rel="prefetch" href="/noteSite/assets/js/64.e0fb4ddf.js"><link rel="prefetch" href="/noteSite/assets/js/65.808aeb08.js"><link rel="prefetch" href="/noteSite/assets/js/66.a043b5cc.js"><link rel="prefetch" href="/noteSite/assets/js/67.b4609629.js"><link rel="prefetch" href="/noteSite/assets/js/68.a15edf4b.js"><link rel="prefetch" href="/noteSite/assets/js/69.64a0aef9.js"><link rel="prefetch" href="/noteSite/assets/js/7.da9921ea.js"><link rel="prefetch" href="/noteSite/assets/js/70.8577bde4.js"><link rel="prefetch" href="/noteSite/assets/js/71.358b208c.js"><link rel="prefetch" href="/noteSite/assets/js/72.c28cfb2d.js"><link rel="prefetch" href="/noteSite/assets/js/73.a6d848fd.js"><link rel="prefetch" href="/noteSite/assets/js/74.083f50d5.js"><link rel="prefetch" href="/noteSite/assets/js/75.e71366e4.js"><link rel="prefetch" href="/noteSite/assets/js/76.1a031531.js"><link rel="prefetch" href="/noteSite/assets/js/77.c89e07af.js"><link rel="prefetch" href="/noteSite/assets/js/78.5af1b33b.js"><link rel="prefetch" href="/noteSite/assets/js/79.419c081c.js"><link rel="prefetch" href="/noteSite/assets/js/8.e4fad7ac.js"><link rel="prefetch" href="/noteSite/assets/js/80.8776daa6.js"><link rel="prefetch" href="/noteSite/assets/js/81.cd8e1444.js"><link rel="prefetch" href="/noteSite/assets/js/82.38ccb604.js"><link rel="prefetch" href="/noteSite/assets/js/83.6fcdc196.js"><link rel="prefetch" href="/noteSite/assets/js/84.87960a87.js"><link rel="prefetch" href="/noteSite/assets/js/85.b62f762b.js"><link rel="prefetch" href="/noteSite/assets/js/86.8b90b136.js"><link rel="prefetch" href="/noteSite/assets/js/87.a8e0fd4a.js"><link rel="prefetch" href="/noteSite/assets/js/88.cb911b66.js"><link rel="prefetch" href="/noteSite/assets/js/89.134da86c.js"><link rel="prefetch" href="/noteSite/assets/js/9.f364677d.js"><link rel="prefetch" href="/noteSite/assets/js/90.4acef45f.js"><link rel="prefetch" href="/noteSite/assets/js/91.afbcbe47.js"><link rel="prefetch" href="/noteSite/assets/js/92.4f2da28e.js"><link rel="prefetch" href="/noteSite/assets/js/93.1b40953d.js"><link rel="prefetch" href="/noteSite/assets/js/94.3b86ad9a.js"><link rel="prefetch" href="/noteSite/assets/js/95.1e19ae4b.js"><link rel="prefetch" href="/noteSite/assets/js/96.d03c135b.js"><link rel="prefetch" href="/noteSite/assets/js/97.6613d899.js"><link rel="prefetch" href="/noteSite/assets/js/98.94299438.js"><link rel="prefetch" href="/noteSite/assets/js/99.66ced6a3.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.2b5d8ceb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>入门</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>底层</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>标准库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/golang/standard_packages/" aria-current="page" class="sidebar-link">Golang 标准库</a></li><li><a href="/noteSite/backend/golang/standard_packages/runtime.html" class="sidebar-link">Golang 标准库丨runtime</a></li><li><a href="/noteSite/backend/golang/standard_packages/sync.html" aria-current="page" class="active sidebar-link">Golang 标准库丨sync</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_1-waitgroup" class="sidebar-link">1. WaitGroup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_1-1-核心-api" class="sidebar-link">1.1 核心 API</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_1-2-官方示例" class="sidebar-link">1.2 官方示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_2-locker" class="sidebar-link">2. Locker</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_3-mutex" class="sidebar-link">3. Mutex</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_4-rwmutex" class="sidebar-link">4. RWMutex</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_4-1-核心-api" class="sidebar-link">4.1 核心 API</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_4-2-最佳实践" class="sidebar-link">4.2 最佳实践</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_5-map" class="sidebar-link">5. Map</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_5-1-核心-api" class="sidebar-link">5.1 核心 API</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_5-2-最佳实践" class="sidebar-link">5.2 最佳实践</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_6-once" class="sidebar-link">6. Once</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_6-1-核心-api" class="sidebar-link">6.1 核心 API</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_6-2-官方示例" class="sidebar-link">6.2 官方示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_7-pool" class="sidebar-link">7. Pool</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_7-1-核心-api" class="sidebar-link">7.1 核心 API</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_7-2-官方示例" class="sidebar-link">7.2 官方示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_8-cond" class="sidebar-link">8. Cond</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_8-1-核心-api" class="sidebar-link">8.1 核心 API</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/standard_packages/sync.html#_8-2-最佳实践" class="sidebar-link">8.2 最佳实践</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="golang-标准库丨sync"><a href="#golang-标准库丨sync" class="header-anchor">#</a> Golang 标准库丨sync</h1> <blockquote><p>Package sync provides basic synchronization primitives such as mutual exclusion locks. Other than the Once and WaitGroup types, most are intended for use by low-level library routines. Higher-level synchronization is better done via channels and communication.</p> <p>sync 包提供基本的同步原语，比如互斥锁。除了 Once 和 WaitGroup 类型外，大多数都是用于底层库的。更高级的同步最好通过 channel 通道和 communication 通信来完成。</p></blockquote> <h2 id="_1-waitgroup"><a href="#_1-waitgroup" class="header-anchor">#</a> 1. WaitGroup</h2> <blockquote><p>A WaitGroup waits for a collection of goroutines to finish. The main goroutine calls Add to set the number of goroutines to wait for. Then each of the goroutines runs and calls Done when finished. At the same time, Wait can be used to block until all goroutines have finished.</p> <p>WaitGroup 等待一组 Goroutine 完成。主 Goroutine 调用 Add 来设置要等待的 Goroutine 的数量。然后每个 Goroutine 运行并在完成时调用 Done。同时，可以使用 Wait 来阻塞，直到所有 Goroutine 完成</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// A WaitGroup waits for a collection of goroutines to finish.</span>
<span class="token comment">// The main goroutine calls Add to set the number of</span>
<span class="token comment">// goroutines to wait for. Then each of the goroutines</span>
<span class="token comment">// runs and calls Done when finished. At the same time,</span>
<span class="token comment">// Wait can be used to block until all goroutines have finished.</span>
<span class="token comment">//</span>
<span class="token comment">// A WaitGroup must not be copied after first use.</span>
<span class="token keyword">type</span> WaitGroup <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	noCopy noCopy

	<span class="token comment">// 64-bit value: high 32 bits are counter, low 32 bits are waiter count.</span>
	<span class="token comment">// 64-bit atomic operations require 64-bit alignment, but 32-bit</span>
	<span class="token comment">// compilers do not ensure it. So we allocate 12 bytes and then use</span>
	<span class="token comment">// the aligned 8 bytes in them as state, and the other 4 as storage</span>
	<span class="token comment">// for the sema.</span>
	state1 <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-1-核心-api"><a href="#_1-1-核心-api" class="header-anchor">#</a> 1.1 核心 API</h3> <ul><li><p><strong>wg.Add(delta int)</strong>：Add 将 delta（可能为负）添加到 WaitGroup 计数器。如果计数器变为 0，所有在 Wait 时阻塞的 Goroutine 将被释放。如果计数器变成负值，Add 会 panic。</p> <blockquote><p>注意：</p> <p>当计数器为 0 时发生的具有正 delta 的调用必须在等待之前发生。任何时候都可能发生具有负 delta 的调用，或者在计数器大于 0 时开始的具有正 delta 的调用。通常这意味着对 Add 的调用应该在创建 Goroutine 或其他要等待的事件的语句之前执行。如果重用 WaitGroup 来等待多个独立的事件集，则必须在所有先前的 Wait 调用返回后才进行新的 Add 调用。请参阅 WaitGroup 示例。</p></blockquote></li> <li><p><strong>wg.Done()</strong>：当 WaitGroup 同步等待组中的某个 Goroutine 执行完毕后，设置这个 WaitGroup 的 counter 数值减 1。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>wg <span class="token operator">*</span>WaitGroup<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//其实就是调用了 Add(-1)</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><strong>wg.Wait()</strong>：表示让当前的 Goroutine 等待，进入阻塞状态。一直到 WaitGroup 的计数器为 0，才能解除阻塞，这个 Goroutine 才能继续执行。</p></li></ul> <h3 id="_1-2-官方示例"><a href="#_1-2-官方示例" class="header-anchor">#</a> 1.2 官方示例</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> httpPkg <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>httpPkg<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> http httpPkg

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	<span class="token keyword">var</span> urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
		<span class="token string">&quot;http://www.golang.org/&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;http://www.google.com/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;https://hedon954.github.io/noteSite/&quot;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		<span class="token comment">// Increment the WaitGroup counter.</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token comment">// Launch a goroutine to fetch the URL.</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Decrement the counter when the goroutine completes.</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// Fetch the URL.</span>
			http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Wait for all HTTP fetches to complete.</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>https://hedon954.github.io/noteSite/
http://www.golang.org/
http://www.google.com/
</code></pre></div><h2 id="_2-locker"><a href="#_2-locker" class="header-anchor">#</a> 2. Locker</h2> <p>Locker 表示一个对象可以被 lock 和 unlock。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// A Locker represents an object that can be locked and unlocked.</span>
<span class="token keyword">type</span> Locker <span class="token keyword">interface</span> <span class="token punctuation">{</span>
   <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-mutex"><a href="#_3-mutex" class="header-anchor">#</a> 3. Mutex</h2> <p>Go 语言包中的 sync 包提供了两种锁类型：sync.Mutex 和 sync.RWMutex。</p> <p>Mutex 是最简单的一种锁类型 —— <strong>互斥锁</strong>，同时也比较暴力，当一个 Goroutine 获得了 Mutex 后，其他 Goroutine 就只能乖乖等到这个 Goroutine 释放该 Mutex。</p> <p>每个资源都对应于一个可称为 “互斥锁” 的标记，这个标记用来保证在任意时刻，只能有一个协程（线程）访问该资源，其它的协程只能等待。</p> <p>互斥锁是传统并发编程对共享资源进行访问控制的主要手段，它由标准库 sync 中的 Mutex 结构体类型表示。sync.Mutex 类型只有两个公开的指针方法：Lock 和 Unlock。</p> <ul><li>Lock 锁定当前的共享资源</li> <li>Unlock 进行解锁</li></ul> <blockquote><p>在使用互斥锁时，一定要注意：</p> <p>对资源操作完成后，一定要解锁，否则会出现流程执行异常，死锁等问题。通常借助 defer。锁定后，立即使用 defer 语句保证互斥锁及时解锁。</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// A Mutex is a mutual exclusion lock.</span>
<span class="token comment">// The zero value for a Mutex is an unlocked mutex.</span>
<span class="token comment">//</span>
<span class="token comment">// A Mutex must not be copied after first use.</span>
<span class="token keyword">type</span> Mutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   state <span class="token builtin">int32</span>
   sema  <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>

<span class="token comment">// Lock locks m.</span>
<span class="token comment">// If the lock is already in use, the calling goroutine</span>
<span class="token comment">// blocks until the mutex is available.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Fast path: grab unlocked mutex.</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mutexLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
			race<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Slow path (outlined so that the fast path can be inlined)</span>
	m<span class="token punctuation">.</span><span class="token function">lockSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Unlock unlocks m.</span>
<span class="token comment">// It is a run-time error if m is not locked on entry to Unlock.</span>
<span class="token comment">//</span>
<span class="token comment">// A locked Mutex is not associated with a particular goroutine.</span>
<span class="token comment">// It is allowed for one goroutine to lock a Mutex and then</span>
<span class="token comment">// arrange for another goroutine to unlock it.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> m<span class="token punctuation">.</span>state
		race<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Fast path: drop lock bit.</span>
	<span class="token builtin">new</span> <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token operator">-</span>mutexLocked<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token builtin">new</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// Outlined slow path to allow inlining the fast path.</span>
		<span class="token comment">// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.</span>
		m<span class="token punctuation">.</span><span class="token function">unlockSlow</span><span class="token punctuation">(</span><span class="token builtin">new</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-rwmutex"><a href="#_4-rwmutex" class="header-anchor">#</a> 4. RWMutex</h2> <blockquote><p>A RWMutex is a reader/writer mutual exclusion lock. The lock can be held by an arbitrary number of readers or a single writer. The zero value for a RWMutex is an unlocked mutex.</p> <p>A RWMutex must not be copied after first use.</p> <p>If a goroutine holds a RWMutex for reading and another goroutine might call Lock, no goroutine should expect to be able to acquire a read lock until the initial read lock is released. In particular, this prohibits recursive read locking. This is to ensure that the lock eventually becomes available; a blocked Lock call excludes new readers from acquiring the lock.</p> <p>RWMutex 是读写锁，该锁可以由任意数量的读者或单个写者持有。RWMutex 的零值是未锁定的互斥锁。</p> <p>RWMutex 被第一次使用后不得复制。</p> <p>如果一个 Goroutine 持有一个 RWMutex 的读锁并且另一个 Goroutine 可能会调用 Lock，那么在前面的读锁被释放之前，任何 Goroutine 都不应该期望能够获取读锁。特别是，禁止递归占有读锁，这是为了确保锁最终会被释放；被阻塞的 Lock 调用会将新的读者排除在获取锁之外。</p></blockquote> <p>我们怎么理解读写锁呢？当有一个 Goroutine 获得写锁，其它无论是读锁还是写锁都将阻塞直到写锁释放；当有一个 Goroutine 获得读锁，其它 Goroutine 仍然可以申请读锁；当有一个或任意多个读锁，写锁将等待所有读锁解锁之后才能够进行写锁。所以说这里的读锁（RLock）目的其实是告诉写锁：有很多人正在读取数据，你给我站一边去，等它们读完你再来写。我们可以将其总结为如下三条：</p> <ol><li>同时只能有一个 Goroutine 能够获得写锁</li> <li>同时可以有任意多个 Gorouinte 获得读锁</li> <li>同时只能存在写锁或读锁（读和写互斥）</li></ol> <p>所以，RWMutex 这个读写锁，该锁可以加多个读锁或者一个写锁，其经常用于读远远多于写的场景。</p> <p>读写锁的写锁只能锁定一次，解锁前不能多次锁定，读锁可以多次，但读解锁次数最多只能比读锁次数多一次，一般情况下我们不建议读解锁次数多余读锁次数。</p> <p>基本遵循两大原则：</p> <ol><li>可以随便读，多个 Goroutine 同时读</li> <li>写的时候，啥也不能干，不能读也不能写</li></ol> <p>读写锁即是针对于读写操作的互斥锁。它与普通的互斥锁最大的不同就是：它可以分别针对读操作和写操作进行锁定和解锁操作。读写锁遵循的访问控制规则与互斥锁有所不同。在读写锁管辖的范围内，它允许任意个读操作的同时进行。但是在同一时刻，它只允许有一个写操作在进行。</p> <h3 id="_4-1-核心-api"><a href="#_4-1-核心-api" class="header-anchor">#</a> 4.1 核心 API</h3> <ul><li><strong>rwm.RLock()</strong>：上读锁</li> <li><strong>rwm.RUnlock()</strong>：解读锁</li> <li><strong>rwm.Lock()</strong>：上写锁</li> <li><strong>rwm.Unlock()</strong>：解读锁</li></ul> <h3 id="_4-2-最佳实践"><a href="#_4-2-最佳实践" class="header-anchor">#</a> 4.2 最佳实践</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> rwLock sync<span class="token punctuation">.</span>RWMutex
<span class="token keyword">var</span> waitGroup sync<span class="token punctuation">.</span>WaitGroup

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rwLock <span class="token operator">=</span> sync<span class="token punctuation">.</span>RWMutex<span class="token punctuation">{</span><span class="token punctuation">}</span>
	waitGroup <span class="token operator">=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
	m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>
	m<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>

	waitGroup<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">write</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">read</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
	waitGroup<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">read</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> i <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	rwLock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;上了第&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">&quot;个读锁&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	rwLock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;释放了第&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">&quot;个读锁&quot;</span><span class="token punctuation">)</span>
	waitGroup<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">write</span><span class="token punctuation">(</span>m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	rwLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;上了写锁&quot;</span><span class="token punctuation">)</span>
	m<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;hedon&quot;</span>
	rwLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;释放了写锁&quot;</span><span class="token punctuation">)</span>
	waitGroup<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>上了第 1 个读锁
hello
上了第 3 个读锁
hello
上了第 2 个读锁
hello
上了第 6 个读锁
hello
上了第 4 个读锁
hello
释放了第 1 个读锁
释放了第 2 个读锁
释放了第 3 个读锁
释放了第 4 个读锁
释放了第 6 个读锁
上了写锁
释放了写锁
上了第 5 个读锁
hedon
释放了第 5 个读锁
</code></pre></div><h2 id="_5-map"><a href="#_5-map" class="header-anchor">#</a> 5. Map</h2> <blockquote><p>Map is like a Go map[interface{}]interface{} but is safe for concurrent use by multiple goroutines without additional locking or coordination. Loads, stores, and deletes run in amortized constant time.</p> <p>The Map type is specialized. Most code should use a plain Go map instead, with separate locking or coordination, for better type safety and to make it easier to maintain other invariants along with the map content.</p> <p>The Map type is optimized for two common use cases: (1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, or (2) when multiple goroutines read, write, and overwrite entries for disjoint sets of keys. In these two cases, use of a Map may significantly reduce lock contention compared to a Go map paired with a separate Mutex or RWMutex.</p> <p>The zero Map is empty and ready for use. A Map must not be copied after first use.</p> <p>Map 类似于 Go 的 <code>map[interface{}]interface{}</code>，但对于多个 Goroutine 并发使用是安全的，无需额外的锁定或协调。Load、Store 和 Delete 在分摊常数时间内运行。</p> <p>Map 类型是专门的。大多数代码应该使用带有单独锁定或协调的普通 Go map，以获得更好的类型安全性并更容易维护其他不变量以及映射内容。</p> <p>Map 类型针对两种常见用例进行了优化：</p> <ol><li>当给定 key 的条目只写入一次但读取多次时，如在只会增长的缓存中</li> <li>当多个 Goroutine 读取、写入和覆盖不相交的 key 集的条目</li></ol> <p>在这两种情况下，与使用单独的 Mutex 或 RWMutex 配对的 Go map 相比，使用 Map 可以显着减少锁争用。</p> <p>零映射是空的并且可以使用了，第一次使用后不得复制 Map。</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Map <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu Mutex
	read atomic<span class="token punctuation">.</span>Value <span class="token comment">// readOnly</span>
	dirty <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">*</span>entry
	misses <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>类似于 Java 的 ConcurrentMap。</p></blockquote> <h3 id="_5-1-核心-api"><a href="#_5-1-核心-api" class="header-anchor">#</a> 5.1 核心 API</h3> <ul><li><strong>m.Load(k) (v, ok)</strong>：并发安全的 get。</li> <li><strong>m.Store(k, v)</strong>：并发安全的 put。</li> <li><strong>m.Delete(k)</strong>：并发安全的 delete。</li> <li><strong>m.LoadAndDelete(k) (v, loaded)</strong>：LoadAndDelete 删除键的值，如果之前有值，则返回之前的值，loaded 表示是否有之前的值。</li> <li><strong>m.LoadAndStore(k, v) (actual, loaded)</strong>：LoadOrStore 返回键的现有值（如果存在）。否则，它存储并返回给定的值。loaded 为 true 表示返回现有值，loaded 为 false 表示存储给定值。</li> <li><strong>m.Range(func(k, v) bool)</strong>：按照传入的 func 规则遍历 Map。</li></ul> <h3 id="_5-2-最佳实践"><a href="#_5-2-最佳实践" class="header-anchor">#</a> 5.2 最佳实践</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> sync<span class="token punctuation">.</span>Map<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		m<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>检查数据冲突：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>go run -race concurrentMap.go
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;nil&gt; false
2 true
2 true
</code></pre></div><p>没有并发冲突。</p> <h2 id="_6-once"><a href="#_6-once" class="header-anchor">#</a> 6. Once</h2> <blockquote><p>Once is an object that will perform exactly one action.</p> <p>A Once must not be copied after first use.</p> <p>Once 是只执行一次的对象。</p> <p>Once 使用后不能复制。</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Once <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   <span class="token comment">// done indicates whether the action has been performed.</span>
   <span class="token comment">// It is first in the struct because it is used in the hot path.</span>
   <span class="token comment">// The hot path is inlined at every call site.</span>
   <span class="token comment">// Placing done first allows more compact instructions on some architectures (amd64/386),</span>
   <span class="token comment">// and fewer instructions (to calculate offset) on other architectures.</span>
   done <span class="token builtin">uint32</span>
   m    Mutex
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-1-核心-api"><a href="#_6-1-核心-api" class="header-anchor">#</a> 6.1 核心 API</h3> <ul><li><p><strong>once.Do(func)</strong>：执行某一函数</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>Once<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>o<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// Outlined slow-path to allow inlining of the fast-path.</span>
		o<span class="token punctuation">.</span><span class="token function">doSlow</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="_6-2-官方示例"><a href="#_6-2-官方示例" class="header-anchor">#</a> 6.2 官方示例</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once
	onceBody <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Only Once&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	doneChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>onceBody<span class="token punctuation">)</span>
			doneChan <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token operator">&lt;-</span> doneChan
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出：只执行了一次</p> <div class="language- extra-class"><pre class="language-text"><code>Only Once
</code></pre></div><h2 id="_7-pool"><a href="#_7-pool" class="header-anchor">#</a> 7. Pool</h2> <blockquote><p>A Pool is a set of temporary objects that may be individually saved and retrieved.</p> <p>Any item stored in the Pool may be removed automatically at any time without notification. If the Pool holds the only reference when this happens, the item might be deallocated.</p> <p>A Pool is safe for use by multiple goroutines simultaneously.</p> <p>Pool's purpose is to cache allocated but unused items for later reuse, relieving pressure on the garbage collector. That is, it makes it easy to build efficient, thread-safe free lists. However, it is not suitable for all free lists.</p> <p>An appropriate use of a Pool is to manage a group of temporary items silently shared among and potentially reused by concurrent independent clients of a package. Pool provides a way to amortize allocation overhead across many clients.</p> <p>An example of good use of a Pool is in the fmt package, which maintains a dynamically-sized store of temporary output buffers. The store scales under load (when many goroutines are actively printing) and shrinks when quiescent.</p> <p>On the other hand, a free list maintained as part of a short-lived object is not a suitable use for a Pool, since the overhead does not amortize well in that scenario. It is more efficient to have such objects implement their own free list.</p> <p>A Pool must not be copied after first use.</p> <p><strong>Pool 一个临时对象池。</strong></p> <p>存储在 Pool 中的任何项目都可以在不通知的情况下自动删除。如果在发生这种情况的时候 Pool 持有唯一的引用，则该项可能被释放。</p> <p>一个 Pool 可以被多个 Goroutine 同时使用。</p> <p>Pool 的目的是缓存已分配但未使用的项，以便以后重用，减轻垃圾收集器的压力。也就是说，它使构建高效、线程安全的空闲列表变得很容易。但是，它并不适合所有的空闲列表。</p> <p>Pool 的适当用途是管理一组临时项，这些临时项在包的并发独立客户端之间默默地共享，并可能被重用。Pol 提供了一种跨多个客户端分摊分配开销的方法。</p> <p>一个很好的使用 Pool 的例子是 fmt 包，它维护一个动态大小的临时输出缓冲区存储。这个存储在负载下伸缩（当许多goroutine正在积极打印时），在静止时收缩。</p> <p>另一方面，作为短期对象的一部分维护的空闲列表不适合使用 Pool，因为在这种情况下开销不能很好地分摊。让这些对象实现它们自己的自由列表会更有效。</p> <p>Pool 在第一次使用后不能被复制。</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Pool <span class="token keyword">struct</span> <span class="token punctuation">{</span>
   noCopy noCopy

   local     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// local fixed-size per-P pool, actual type is [P]poolLocal</span>
   localSize <span class="token builtin">uintptr</span>        <span class="token comment">// size of the local array</span>

   victim     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// local from previous cycle</span>
   victimSize <span class="token builtin">uintptr</span>        <span class="token comment">// size of victims array</span>

   <span class="token comment">// New optionally specifies a function to generate</span>
   <span class="token comment">// a value when Get would otherwise return nil.</span>
   <span class="token comment">// It may not be changed concurrently with calls to Get.</span>
   New <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-1-核心-api"><a href="#_7-1-核心-api" class="header-anchor">#</a> 7.1 核心 API</h3> <ul><li><p><strong>pool.Get()</strong>：<code>Pool</code> 会为每个 <code>P</code> 维护一个本地池，<code>P</code> 的本地池分为 私有池 <code>private</code> 和共享池 <code>shared</code>。私有池中的元素只能本地 <code>P</code> 使用，共享池中的元素可能会被其他 <code>P</code> 偷走，所以使用私有池 <code>private</code> 时不用加锁，而使用共享池 <code>shared</code> 时需加锁。</p> <p><code>Get</code> 会优先查找本地 <code>private</code>，再查找本地 <code>shared</code>，最后查找其他 <code>P</code> 的 <code>shared</code>，如果以上全部没有可用元素，最后会调用 <code>New</code> 函数获取新元素。</p></li> <li><p><strong>pool.Put(p)</strong>：<code>Put</code> 优先把元素放在 <code>private</code> 池中；如果 <code>private</code> 不为空，则放在 <code>shared</code> 池中。有趣的是，在入池之前，该元素有 1/4 可能被丢掉。</p></li></ul> <h3 id="_7-2-官方示例"><a href="#_7-2-官方示例" class="header-anchor">#</a> 7.2 官方示例</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> bufPool <span class="token operator">=</span> sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{</span>
	New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
		<span class="token comment">// The Pool's New function should generally only return pointer</span>
		<span class="token comment">// types, since a pointer can be put into the return interface</span>
		<span class="token comment">// value without an allocation:</span>
		<span class="token comment">// 总结：指针</span>
		<span class="token keyword">return</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// timeNow is a fake version of time.Now for tests.</span>
<span class="token keyword">func</span> <span class="token function">timeNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time <span class="token punctuation">{</span>
	<span class="token keyword">return</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token number">1136214245</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Log</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val <span class="token builtin">string</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	<span class="token comment">// 从 Pool 池中随便取一个 byte.Buffer 对象，注意，是指针</span>
	b <span class="token operator">:=</span> bufPool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Replace this with time.Now() in a real logger.</span>
	<span class="token comment">// 用 time.Now() 替换真实日志</span>
	b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token function">timeNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
	<span class="token comment">// 输出 b 的内容</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 再把 b 丢回 Pool</span>
	bufPool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">Log</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./search?q=flowers&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>2006-01-02T15:04:05Z path=./search?q=flowers
</code></pre></div><h2 id="_8-cond"><a href="#_8-cond" class="header-anchor">#</a> 8. Cond</h2> <blockquote><p>Cond implements a condition variable, a rendezvous point for goroutines waiting for or announcing the occurrence of an event.</p> <p>Each Cond has an associated Locker L (often a *Mutex or *RWMutex), which must be held when changing the condition and when calling the Wait method.</p> <p>A Cond must not be copied after first use.</p> <p>Cond 实现了一个条件变量，它是 Goroutine 等待或宣布事件发生的集合点。</p> <p>每个 Cond 都有一个关联的 Locker（通常是 *Mutex 或 *RWMutex），当改变条件和调用 Wait 方法时，必须持有它。</p> <p>Cond 在第一次使用后不能被复制。</p></blockquote> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Cond <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	noCopy noCopy

	<span class="token comment">// L is held while observing or changing the condition</span>
	L Locker

	notify  notifyList
	checker copyChecker
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-1-核心-api"><a href="#_8-1-核心-api" class="header-anchor">#</a> 8.1 核心 API</h3> <ul><li><strong>NewCond(locker)</strong>：使用一个 Locker 来创建一个 Cond。</li> <li><strong>cond.Broadcast()</strong>：广播，唤醒所有 Wait 了的 Goroutine，若没有 Wait 的，也不会报错。</li> <li><strong>cond.Signal()</strong>：唤醒一个 Wait 了的 Goroutine，若没有 Wait 的，也不会报错。<strong>Signal 通知的顺序是根据原来 Wait 的顺序，先入先出</strong>。</li> <li><strong>cond.Wait()</strong>：Unlock → 阻塞等待通知（即等待 Signal 或 Broadcast 的通知）→ 收到通知 → Lock</li></ul> <blockquote><p>类似于 Java 当中的 object.wait()、object.notify() 和 object.notifyAll()。</p></blockquote> <h3 id="_8-2-最佳实践"><a href="#_8-2-最佳实践" class="header-anchor">#</a> 8.2 最佳实践</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sync&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cond <span class="token operator">:=</span> sync<span class="token punctuation">.</span><span class="token function">NewCond</span><span class="token punctuation">(</span><span class="token function">new</span><span class="token punctuation">(</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">)</span><span class="token punctuation">)</span>
	condition <span class="token operator">:=</span> <span class="token number">0</span>

	<span class="token comment">// Consumer</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token comment">// 占有锁</span>
			cond<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// 没有可以消费的，阻塞</span>
			<span class="token keyword">for</span> condition <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				cond<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer consumes: %d\n&quot;</span><span class="token punctuation">,</span> condition<span class="token punctuation">)</span>
			condition <span class="token operator">--</span>
			<span class="token comment">// 消费了，必然不满，通知生产者可以生产</span>
			cond<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token comment">// 释放锁</span>
			cond<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Producer</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// 占有锁</span>
		cond<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 慢了就不生产了，阻塞</span>
		<span class="token keyword">if</span> condition <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">{</span>
			cond<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		condition <span class="token operator">++</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Producer produces: %d\n&quot;</span><span class="token punctuation">,</span> condition<span class="token punctuation">)</span>
		<span class="token comment">// 生产了，必然有可以消费的，唤醒消费者</span>
		cond<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 释放锁</span>
		cond<span class="token punctuation">.</span>L<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>输出：</p> <div class="language- extra-class"><pre class="language-text"><code>Producer produces: 1
Producer produces: 2
Producer produces: 3
Consumer consumes: 3
Consumer consumes: 2
Consumer consumes: 1
...
</code></pre></div><!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">7/28/2021, 3:25:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/golang/standard_packages/runtime.html" class="prev">
        Golang 标准库丨runtime
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.b9284a39.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/48.8b80dd37.js" defer></script>
  </body>
</html>
