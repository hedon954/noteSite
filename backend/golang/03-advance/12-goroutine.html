<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>12. Goroutine | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.44d0ef15.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/44.34ab495d.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.b469b6b6.js"><link rel="prefetch" href="/noteSite/assets/js/100.5a90b559.js"><link rel="prefetch" href="/noteSite/assets/js/101.d269e6bb.js"><link rel="prefetch" href="/noteSite/assets/js/102.dbaeb1b7.js"><link rel="prefetch" href="/noteSite/assets/js/103.ea3d0288.js"><link rel="prefetch" href="/noteSite/assets/js/104.5c8fedec.js"><link rel="prefetch" href="/noteSite/assets/js/105.889a8d1f.js"><link rel="prefetch" href="/noteSite/assets/js/106.40ec5dd8.js"><link rel="prefetch" href="/noteSite/assets/js/107.140f58aa.js"><link rel="prefetch" href="/noteSite/assets/js/108.fee713e2.js"><link rel="prefetch" href="/noteSite/assets/js/109.7200bc48.js"><link rel="prefetch" href="/noteSite/assets/js/11.094c1246.js"><link rel="prefetch" href="/noteSite/assets/js/110.91c77482.js"><link rel="prefetch" href="/noteSite/assets/js/111.0773e203.js"><link rel="prefetch" href="/noteSite/assets/js/112.32d2254c.js"><link rel="prefetch" href="/noteSite/assets/js/113.3fc975fb.js"><link rel="prefetch" href="/noteSite/assets/js/114.44381bfd.js"><link rel="prefetch" href="/noteSite/assets/js/115.d4223625.js"><link rel="prefetch" href="/noteSite/assets/js/116.55a420ff.js"><link rel="prefetch" href="/noteSite/assets/js/117.d6c87ee8.js"><link rel="prefetch" href="/noteSite/assets/js/118.1a38927a.js"><link rel="prefetch" href="/noteSite/assets/js/119.49165d6e.js"><link rel="prefetch" href="/noteSite/assets/js/12.c34daa91.js"><link rel="prefetch" href="/noteSite/assets/js/120.27309687.js"><link rel="prefetch" href="/noteSite/assets/js/121.d218cf75.js"><link rel="prefetch" href="/noteSite/assets/js/122.57452c9e.js"><link rel="prefetch" href="/noteSite/assets/js/123.4bbf359c.js"><link rel="prefetch" href="/noteSite/assets/js/124.fa89b463.js"><link rel="prefetch" href="/noteSite/assets/js/125.0c941fd1.js"><link rel="prefetch" href="/noteSite/assets/js/126.b26145c1.js"><link rel="prefetch" href="/noteSite/assets/js/127.6c2654a7.js"><link rel="prefetch" href="/noteSite/assets/js/128.5d3a5d64.js"><link rel="prefetch" href="/noteSite/assets/js/129.b8330812.js"><link rel="prefetch" href="/noteSite/assets/js/13.f5480015.js"><link rel="prefetch" href="/noteSite/assets/js/130.65553885.js"><link rel="prefetch" href="/noteSite/assets/js/131.6779a92a.js"><link rel="prefetch" href="/noteSite/assets/js/132.068e675f.js"><link rel="prefetch" href="/noteSite/assets/js/133.e33a1e92.js"><link rel="prefetch" href="/noteSite/assets/js/134.5dc0d37b.js"><link rel="prefetch" href="/noteSite/assets/js/135.8c747a2d.js"><link rel="prefetch" href="/noteSite/assets/js/136.05464e5e.js"><link rel="prefetch" href="/noteSite/assets/js/137.bbe63ed2.js"><link rel="prefetch" href="/noteSite/assets/js/138.ea14543e.js"><link rel="prefetch" href="/noteSite/assets/js/139.aaab20fc.js"><link rel="prefetch" href="/noteSite/assets/js/14.6195d2f0.js"><link rel="prefetch" href="/noteSite/assets/js/140.9dbbb562.js"><link rel="prefetch" href="/noteSite/assets/js/141.c8c2d8ea.js"><link rel="prefetch" href="/noteSite/assets/js/142.fb6767fd.js"><link rel="prefetch" href="/noteSite/assets/js/143.2315d524.js"><link rel="prefetch" href="/noteSite/assets/js/144.f0c1e248.js"><link rel="prefetch" href="/noteSite/assets/js/145.477dc678.js"><link rel="prefetch" href="/noteSite/assets/js/146.78dd1b62.js"><link rel="prefetch" href="/noteSite/assets/js/147.849bcfcf.js"><link rel="prefetch" href="/noteSite/assets/js/148.e7b28083.js"><link rel="prefetch" href="/noteSite/assets/js/149.b87b7ab7.js"><link rel="prefetch" href="/noteSite/assets/js/15.ed2e2f3d.js"><link rel="prefetch" href="/noteSite/assets/js/150.abf1e862.js"><link rel="prefetch" href="/noteSite/assets/js/151.3b8e2c5e.js"><link rel="prefetch" href="/noteSite/assets/js/152.0b3941f8.js"><link rel="prefetch" href="/noteSite/assets/js/153.69581b97.js"><link rel="prefetch" href="/noteSite/assets/js/154.0e3c82ec.js"><link rel="prefetch" href="/noteSite/assets/js/155.e89a8c61.js"><link rel="prefetch" href="/noteSite/assets/js/156.6426d84c.js"><link rel="prefetch" href="/noteSite/assets/js/157.f0590d48.js"><link rel="prefetch" href="/noteSite/assets/js/158.66cadbe0.js"><link rel="prefetch" href="/noteSite/assets/js/159.862b0d8e.js"><link rel="prefetch" href="/noteSite/assets/js/16.bbb3b0e4.js"><link rel="prefetch" href="/noteSite/assets/js/160.fb1465a5.js"><link rel="prefetch" href="/noteSite/assets/js/161.ec93c150.js"><link rel="prefetch" href="/noteSite/assets/js/162.6215f2be.js"><link rel="prefetch" href="/noteSite/assets/js/163.a3e3c4cd.js"><link rel="prefetch" href="/noteSite/assets/js/164.d7a86663.js"><link rel="prefetch" href="/noteSite/assets/js/165.ff2607af.js"><link rel="prefetch" href="/noteSite/assets/js/166.9456b8a1.js"><link rel="prefetch" href="/noteSite/assets/js/167.cdac3ff8.js"><link rel="prefetch" href="/noteSite/assets/js/168.5d25d4ad.js"><link rel="prefetch" href="/noteSite/assets/js/169.ed317945.js"><link rel="prefetch" href="/noteSite/assets/js/17.204dc718.js"><link rel="prefetch" href="/noteSite/assets/js/170.28453206.js"><link rel="prefetch" href="/noteSite/assets/js/171.91a6095a.js"><link rel="prefetch" href="/noteSite/assets/js/172.a4b39fe7.js"><link rel="prefetch" href="/noteSite/assets/js/173.6e97a63f.js"><link rel="prefetch" href="/noteSite/assets/js/174.417768d9.js"><link rel="prefetch" href="/noteSite/assets/js/175.6e4b0a7b.js"><link rel="prefetch" href="/noteSite/assets/js/176.7668e693.js"><link rel="prefetch" href="/noteSite/assets/js/177.88aad887.js"><link rel="prefetch" href="/noteSite/assets/js/178.bc0a14d5.js"><link rel="prefetch" href="/noteSite/assets/js/179.ef9b049a.js"><link rel="prefetch" href="/noteSite/assets/js/18.b9adc259.js"><link rel="prefetch" href="/noteSite/assets/js/180.359f8fc7.js"><link rel="prefetch" href="/noteSite/assets/js/181.97c0341c.js"><link rel="prefetch" href="/noteSite/assets/js/182.5fb7062c.js"><link rel="prefetch" href="/noteSite/assets/js/183.dc9920c4.js"><link rel="prefetch" href="/noteSite/assets/js/184.3350251c.js"><link rel="prefetch" href="/noteSite/assets/js/185.f258641d.js"><link rel="prefetch" href="/noteSite/assets/js/186.83ecdcaf.js"><link rel="prefetch" href="/noteSite/assets/js/187.27815247.js"><link rel="prefetch" href="/noteSite/assets/js/188.8c740d90.js"><link rel="prefetch" href="/noteSite/assets/js/189.741c61a9.js"><link rel="prefetch" href="/noteSite/assets/js/19.811bf034.js"><link rel="prefetch" href="/noteSite/assets/js/190.d8b95ca2.js"><link rel="prefetch" href="/noteSite/assets/js/191.47d0ad44.js"><link rel="prefetch" href="/noteSite/assets/js/192.f305241b.js"><link rel="prefetch" href="/noteSite/assets/js/193.cd0ed807.js"><link rel="prefetch" href="/noteSite/assets/js/194.2d088087.js"><link rel="prefetch" href="/noteSite/assets/js/195.bb042bd0.js"><link rel="prefetch" href="/noteSite/assets/js/196.99a92d9a.js"><link rel="prefetch" href="/noteSite/assets/js/197.aafc2d63.js"><link rel="prefetch" href="/noteSite/assets/js/198.01d32971.js"><link rel="prefetch" href="/noteSite/assets/js/199.060f2286.js"><link rel="prefetch" href="/noteSite/assets/js/20.78824865.js"><link rel="prefetch" href="/noteSite/assets/js/200.3aea7d7e.js"><link rel="prefetch" href="/noteSite/assets/js/201.ca6479dd.js"><link rel="prefetch" href="/noteSite/assets/js/202.7e9e2a58.js"><link rel="prefetch" href="/noteSite/assets/js/203.c3222d2d.js"><link rel="prefetch" href="/noteSite/assets/js/204.ed0135d4.js"><link rel="prefetch" href="/noteSite/assets/js/205.c3ebd951.js"><link rel="prefetch" href="/noteSite/assets/js/206.7c51c243.js"><link rel="prefetch" href="/noteSite/assets/js/207.8727d2f0.js"><link rel="prefetch" href="/noteSite/assets/js/208.39e1cfd5.js"><link rel="prefetch" href="/noteSite/assets/js/209.9b566472.js"><link rel="prefetch" href="/noteSite/assets/js/21.cea73218.js"><link rel="prefetch" href="/noteSite/assets/js/210.11558b76.js"><link rel="prefetch" href="/noteSite/assets/js/211.1583fc79.js"><link rel="prefetch" href="/noteSite/assets/js/212.a835c98a.js"><link rel="prefetch" href="/noteSite/assets/js/213.5ee1312e.js"><link rel="prefetch" href="/noteSite/assets/js/214.71ed8e9c.js"><link rel="prefetch" href="/noteSite/assets/js/215.1fe74f0b.js"><link rel="prefetch" href="/noteSite/assets/js/216.4641e8c7.js"><link rel="prefetch" href="/noteSite/assets/js/217.cf474399.js"><link rel="prefetch" href="/noteSite/assets/js/218.eda994ff.js"><link rel="prefetch" href="/noteSite/assets/js/219.0b34ae34.js"><link rel="prefetch" href="/noteSite/assets/js/22.d6ead87c.js"><link rel="prefetch" href="/noteSite/assets/js/220.35856088.js"><link rel="prefetch" href="/noteSite/assets/js/221.2dc4c8de.js"><link rel="prefetch" href="/noteSite/assets/js/222.93f8e761.js"><link rel="prefetch" href="/noteSite/assets/js/223.b7ba52d9.js"><link rel="prefetch" href="/noteSite/assets/js/224.f900eeec.js"><link rel="prefetch" href="/noteSite/assets/js/225.eb8df945.js"><link rel="prefetch" href="/noteSite/assets/js/226.29291757.js"><link rel="prefetch" href="/noteSite/assets/js/227.f08c2ac5.js"><link rel="prefetch" href="/noteSite/assets/js/228.4d8c8d9e.js"><link rel="prefetch" href="/noteSite/assets/js/229.4bd536cc.js"><link rel="prefetch" href="/noteSite/assets/js/23.0ee0c5eb.js"><link rel="prefetch" href="/noteSite/assets/js/230.82e9257b.js"><link rel="prefetch" href="/noteSite/assets/js/231.db7cc581.js"><link rel="prefetch" href="/noteSite/assets/js/232.52065441.js"><link rel="prefetch" href="/noteSite/assets/js/233.3cabb969.js"><link rel="prefetch" href="/noteSite/assets/js/234.bda5fd11.js"><link rel="prefetch" href="/noteSite/assets/js/235.eea81382.js"><link rel="prefetch" href="/noteSite/assets/js/236.3d8870c2.js"><link rel="prefetch" href="/noteSite/assets/js/237.c6ab032b.js"><link rel="prefetch" href="/noteSite/assets/js/238.ab8fba20.js"><link rel="prefetch" href="/noteSite/assets/js/239.d747fd3f.js"><link rel="prefetch" href="/noteSite/assets/js/24.1a933e6c.js"><link rel="prefetch" href="/noteSite/assets/js/240.1a2e710d.js"><link rel="prefetch" href="/noteSite/assets/js/241.af6d037d.js"><link rel="prefetch" href="/noteSite/assets/js/242.37470e14.js"><link rel="prefetch" href="/noteSite/assets/js/243.b98bfe04.js"><link rel="prefetch" href="/noteSite/assets/js/244.166251b7.js"><link rel="prefetch" href="/noteSite/assets/js/245.334459d6.js"><link rel="prefetch" href="/noteSite/assets/js/246.b560c902.js"><link rel="prefetch" href="/noteSite/assets/js/247.ebea684b.js"><link rel="prefetch" href="/noteSite/assets/js/248.52530c70.js"><link rel="prefetch" href="/noteSite/assets/js/249.9ab8b6b8.js"><link rel="prefetch" href="/noteSite/assets/js/25.df04ad1a.js"><link rel="prefetch" href="/noteSite/assets/js/250.601a7c0c.js"><link rel="prefetch" href="/noteSite/assets/js/251.6dcc6986.js"><link rel="prefetch" href="/noteSite/assets/js/252.b4632174.js"><link rel="prefetch" href="/noteSite/assets/js/253.084e78ee.js"><link rel="prefetch" href="/noteSite/assets/js/254.78337d37.js"><link rel="prefetch" href="/noteSite/assets/js/255.662d2022.js"><link rel="prefetch" href="/noteSite/assets/js/256.908ac57e.js"><link rel="prefetch" href="/noteSite/assets/js/257.02be3ff0.js"><link rel="prefetch" href="/noteSite/assets/js/258.4ca5da3a.js"><link rel="prefetch" href="/noteSite/assets/js/259.1fa4a27a.js"><link rel="prefetch" href="/noteSite/assets/js/26.4eb6fe37.js"><link rel="prefetch" href="/noteSite/assets/js/260.46f6c407.js"><link rel="prefetch" href="/noteSite/assets/js/261.a10138dd.js"><link rel="prefetch" href="/noteSite/assets/js/262.eebeade2.js"><link rel="prefetch" href="/noteSite/assets/js/263.d90b0d4b.js"><link rel="prefetch" href="/noteSite/assets/js/264.b1431386.js"><link rel="prefetch" href="/noteSite/assets/js/265.fa302e5b.js"><link rel="prefetch" href="/noteSite/assets/js/266.b9a1dc24.js"><link rel="prefetch" href="/noteSite/assets/js/267.4c7ea04d.js"><link rel="prefetch" href="/noteSite/assets/js/268.83a82781.js"><link rel="prefetch" href="/noteSite/assets/js/269.4d4ce76f.js"><link rel="prefetch" href="/noteSite/assets/js/27.92ef4fae.js"><link rel="prefetch" href="/noteSite/assets/js/270.d2d6e1e8.js"><link rel="prefetch" href="/noteSite/assets/js/271.b900cc61.js"><link rel="prefetch" href="/noteSite/assets/js/272.bfb985f0.js"><link rel="prefetch" href="/noteSite/assets/js/273.bf0b2dfc.js"><link rel="prefetch" href="/noteSite/assets/js/274.ff040b3e.js"><link rel="prefetch" href="/noteSite/assets/js/275.b8cc40a0.js"><link rel="prefetch" href="/noteSite/assets/js/276.5834daf3.js"><link rel="prefetch" href="/noteSite/assets/js/277.245f020c.js"><link rel="prefetch" href="/noteSite/assets/js/278.5aa2baf4.js"><link rel="prefetch" href="/noteSite/assets/js/279.89bcae12.js"><link rel="prefetch" href="/noteSite/assets/js/28.88f99f79.js"><link rel="prefetch" href="/noteSite/assets/js/280.845cd43a.js"><link rel="prefetch" href="/noteSite/assets/js/281.a2b93a44.js"><link rel="prefetch" href="/noteSite/assets/js/282.127a8c6e.js"><link rel="prefetch" href="/noteSite/assets/js/283.6fbf942c.js"><link rel="prefetch" href="/noteSite/assets/js/284.e8757550.js"><link rel="prefetch" href="/noteSite/assets/js/285.9eb2e48f.js"><link rel="prefetch" href="/noteSite/assets/js/286.216c2483.js"><link rel="prefetch" href="/noteSite/assets/js/287.6cf6ebf2.js"><link rel="prefetch" href="/noteSite/assets/js/288.f5587018.js"><link rel="prefetch" href="/noteSite/assets/js/289.8b3970e5.js"><link rel="prefetch" href="/noteSite/assets/js/29.6cba673a.js"><link rel="prefetch" href="/noteSite/assets/js/290.3a652cdf.js"><link rel="prefetch" href="/noteSite/assets/js/291.3a89188c.js"><link rel="prefetch" href="/noteSite/assets/js/292.09a840b1.js"><link rel="prefetch" href="/noteSite/assets/js/293.62b6294c.js"><link rel="prefetch" href="/noteSite/assets/js/294.7125ab28.js"><link rel="prefetch" href="/noteSite/assets/js/295.d6472d94.js"><link rel="prefetch" href="/noteSite/assets/js/296.4a722570.js"><link rel="prefetch" href="/noteSite/assets/js/297.6c3b39ec.js"><link rel="prefetch" href="/noteSite/assets/js/298.45411a92.js"><link rel="prefetch" href="/noteSite/assets/js/299.12dfdf18.js"><link rel="prefetch" href="/noteSite/assets/js/3.cf3dc5d9.js"><link rel="prefetch" href="/noteSite/assets/js/30.0be426ff.js"><link rel="prefetch" href="/noteSite/assets/js/300.5c82eb86.js"><link rel="prefetch" href="/noteSite/assets/js/301.0e7825c0.js"><link rel="prefetch" href="/noteSite/assets/js/302.df4c9530.js"><link rel="prefetch" href="/noteSite/assets/js/303.8498b616.js"><link rel="prefetch" href="/noteSite/assets/js/304.1c137831.js"><link rel="prefetch" href="/noteSite/assets/js/305.2a266763.js"><link rel="prefetch" href="/noteSite/assets/js/306.f90b354d.js"><link rel="prefetch" href="/noteSite/assets/js/307.b8fa6af8.js"><link rel="prefetch" href="/noteSite/assets/js/308.22f2a6a2.js"><link rel="prefetch" href="/noteSite/assets/js/309.47551ea6.js"><link rel="prefetch" href="/noteSite/assets/js/31.3affb8bf.js"><link rel="prefetch" href="/noteSite/assets/js/310.d117d767.js"><link rel="prefetch" href="/noteSite/assets/js/32.9594ce12.js"><link rel="prefetch" href="/noteSite/assets/js/33.eb71398f.js"><link rel="prefetch" href="/noteSite/assets/js/34.85f8d0f4.js"><link rel="prefetch" href="/noteSite/assets/js/35.0c2066c0.js"><link rel="prefetch" href="/noteSite/assets/js/36.5e85132b.js"><link rel="prefetch" href="/noteSite/assets/js/37.4a13d5ab.js"><link rel="prefetch" href="/noteSite/assets/js/38.5533f445.js"><link rel="prefetch" href="/noteSite/assets/js/39.3235028f.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/40.20882ae0.js"><link rel="prefetch" href="/noteSite/assets/js/41.2a0678f6.js"><link rel="prefetch" href="/noteSite/assets/js/42.8c1c0cec.js"><link rel="prefetch" href="/noteSite/assets/js/43.b66267b7.js"><link rel="prefetch" href="/noteSite/assets/js/45.5b47dd8c.js"><link rel="prefetch" href="/noteSite/assets/js/46.af6bc4ca.js"><link rel="prefetch" href="/noteSite/assets/js/47.1afd53d1.js"><link rel="prefetch" href="/noteSite/assets/js/48.7e7b91db.js"><link rel="prefetch" href="/noteSite/assets/js/49.8266acfe.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.118c4f5c.js"><link rel="prefetch" href="/noteSite/assets/js/51.5d056a28.js"><link rel="prefetch" href="/noteSite/assets/js/52.6f79a86f.js"><link rel="prefetch" href="/noteSite/assets/js/53.32be0296.js"><link rel="prefetch" href="/noteSite/assets/js/54.12e9d157.js"><link rel="prefetch" href="/noteSite/assets/js/55.2a874220.js"><link rel="prefetch" href="/noteSite/assets/js/56.e8e5e0f5.js"><link rel="prefetch" href="/noteSite/assets/js/57.456e67d8.js"><link rel="prefetch" href="/noteSite/assets/js/58.5b781556.js"><link rel="prefetch" href="/noteSite/assets/js/59.285a831b.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.42583b94.js"><link rel="prefetch" href="/noteSite/assets/js/61.8729ece7.js"><link rel="prefetch" href="/noteSite/assets/js/62.841775c7.js"><link rel="prefetch" href="/noteSite/assets/js/63.1942d209.js"><link rel="prefetch" href="/noteSite/assets/js/64.1ddf279f.js"><link rel="prefetch" href="/noteSite/assets/js/65.b299ab47.js"><link rel="prefetch" href="/noteSite/assets/js/66.296fca64.js"><link rel="prefetch" href="/noteSite/assets/js/67.e8296499.js"><link rel="prefetch" href="/noteSite/assets/js/68.11521d20.js"><link rel="prefetch" href="/noteSite/assets/js/69.c793ef18.js"><link rel="prefetch" href="/noteSite/assets/js/7.f685cce4.js"><link rel="prefetch" href="/noteSite/assets/js/70.c7cfccac.js"><link rel="prefetch" href="/noteSite/assets/js/71.02c5f529.js"><link rel="prefetch" href="/noteSite/assets/js/72.c85c8a37.js"><link rel="prefetch" href="/noteSite/assets/js/73.4aa52a09.js"><link rel="prefetch" href="/noteSite/assets/js/74.3dd31a8d.js"><link rel="prefetch" href="/noteSite/assets/js/75.35eafb0f.js"><link rel="prefetch" href="/noteSite/assets/js/76.07dcfa69.js"><link rel="prefetch" href="/noteSite/assets/js/77.4e7c39d5.js"><link rel="prefetch" href="/noteSite/assets/js/78.0a67aba1.js"><link rel="prefetch" href="/noteSite/assets/js/79.df35c1a1.js"><link rel="prefetch" href="/noteSite/assets/js/8.976ce270.js"><link rel="prefetch" href="/noteSite/assets/js/80.fef2c333.js"><link rel="prefetch" href="/noteSite/assets/js/81.7226e5bc.js"><link rel="prefetch" href="/noteSite/assets/js/82.e90de050.js"><link rel="prefetch" href="/noteSite/assets/js/83.a6da0428.js"><link rel="prefetch" href="/noteSite/assets/js/84.4254b6a9.js"><link rel="prefetch" href="/noteSite/assets/js/85.f57bd586.js"><link rel="prefetch" href="/noteSite/assets/js/86.990cf934.js"><link rel="prefetch" href="/noteSite/assets/js/87.b25dddaf.js"><link rel="prefetch" href="/noteSite/assets/js/88.64dac8ea.js"><link rel="prefetch" href="/noteSite/assets/js/89.0bb511ab.js"><link rel="prefetch" href="/noteSite/assets/js/9.9d614776.js"><link rel="prefetch" href="/noteSite/assets/js/90.ed1818cd.js"><link rel="prefetch" href="/noteSite/assets/js/91.4966d597.js"><link rel="prefetch" href="/noteSite/assets/js/92.0001d7dd.js"><link rel="prefetch" href="/noteSite/assets/js/93.2da2b7c3.js"><link rel="prefetch" href="/noteSite/assets/js/94.897ace9f.js"><link rel="prefetch" href="/noteSite/assets/js/95.fae86dc8.js"><link rel="prefetch" href="/noteSite/assets/js/96.83af16dc.js"><link rel="prefetch" href="/noteSite/assets/js/97.a0104751.js"><link rel="prefetch" href="/noteSite/assets/js/98.1d4e53ce.js"><link rel="prefetch" href="/noteSite/assets/js/99.69f955d2.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>入门</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>底层</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/golang/03-advance/01-为什么要使用Go.html" class="sidebar-link">1. 为什么要使用 Go 语言？</a></li><li><a href="/noteSite/backend/golang/03-advance/02-什么是Runtime.html" class="sidebar-link">2. 何为 Runtime？</a></li><li><a href="/noteSite/backend/golang/03-advance/03-Go是面向对象吗.html" class="sidebar-link">3. Go 是面向对象吗？</a></li><li><a href="/noteSite/backend/golang/03-advance/04-Go程序是如何编译的.html" class="sidebar-link">4. Go 程序是如何编译的？</a></li><li><a href="/noteSite/backend/golang/03-advance/05-Go程序是如何启动的.html" class="sidebar-link">5. Go 程序是如何启动起来的？</a></li><li><a href="/noteSite/backend/golang/03-advance/06-大小为0字节的变量.html" class="sidebar-link">6. 大小为 0 字节的变量</a></li><li><a href="/noteSite/backend/golang/03-advance/07-string.html" class="sidebar-link">7. string</a></li><li><a href="/noteSite/backend/golang/03-advance/08-slice.html" class="sidebar-link">8. slice</a></li><li><a href="/noteSite/backend/golang/03-advance/09-map.html" class="sidebar-link">9. map</a></li><li><a href="/noteSite/backend/golang/03-advance/10-interface.html" class="sidebar-link">10. interface</a></li><li><a href="/noteSite/backend/golang/03-advance/11-内存对齐.html" class="sidebar-link">11. 内存对齐</a></li><li><a href="/noteSite/backend/golang/03-advance/12-goroutine.html" aria-current="page" class="active sidebar-link">12. Goroutine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-1-底层" class="sidebar-link">12.1 底层</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-执行" class="sidebar-link">12.2 执行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-1-单线程循环-go-0-x" class="sidebar-link">12.2.1 单线程循环（Go 0.x）</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-2-多线程循环-go-1-0" class="sidebar-link">12.2.2 多线程循环（Go 1.0）</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-gmp" class="sidebar-link">12.3 GMP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-1-p-的底层" class="sidebar-link">12.3.1 P 的底层</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-2-概述" class="sidebar-link">12.3.2 概述</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-3-源码-go1-16" class="sidebar-link">12.3.3 源码（Go1.16）</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-4-新建协程" class="sidebar-link">12.3.4 新建协程</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-5-总原理图" class="sidebar-link">12.3.5 总原理图</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-并发" class="sidebar-link">12.4 并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-1-协程饥饿" class="sidebar-link">12.4.1 协程饥饿</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-2-触发切换" class="sidebar-link">12.4.2 触发切换</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-3-切换时机" class="sidebar-link">12.4.3 切换时机</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-弊端" class="sidebar-link">12.4 弊端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-1-问题" class="sidebar-link">12.4.1 问题</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-2-解决" class="sidebar-link">12.4.2 解决</a></li></ul></li></ul></li><li><a href="/noteSite/backend/golang/03-advance/13-锁.html" class="sidebar-link">13. 锁</a></li><li><a href="/noteSite/backend/golang/03-advance/14-channel.html" class="sidebar-link">14. channel</a></li><li><a href="/noteSite/backend/golang/03-advance/15-net.html" class="sidebar-link">15. 网络编程</a></li><li><a href="/noteSite/backend/golang/03-advance/16-memory.html" class="sidebar-link">16. 内存模型</a></li><li><a href="/noteSite/backend/golang/03-advance/17-gc.html" class="sidebar-link">17. 垃圾回收</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_12-goroutine"><a href="#_12-goroutine" class="header-anchor">#</a> 12. Goroutine</h1> <h2 id="_12-1-底层"><a href="#_12-1-底层" class="header-anchor">#</a> 12.1 底层</h2> <ul><li><p>协程的本质是 <code>runtime/runtime2.go</code> 中的 <code>g</code> 结构体：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> g <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	stack       stack   	<span class="token comment">// 当前协程的协程栈</span>
	sched        gobuf		<span class="token comment">// 保存协程运行现场</span>
	atomicstatus <span class="token builtin">uint32</span>		<span class="token comment">// 协程状态</span>
	goid         <span class="token builtin">int64</span>		<span class="token comment">// 协程 ID</span>
  m            <span class="token operator">*</span>m 			<span class="token comment">// 当前线程</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h569pjiiosj21cu0u040p.jpg" alt="image-20220814141535906"></p></li> <li><p>线程在 Go 中对应是的 <code>runtime/runtime2.go</code> 中的 <code>m</code> 结构体：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> m <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	g0      <span class="token operator">*</span>g     					<span class="token comment">// g0 协程，Go 中的主协程</span>
	curg          <span class="token operator">*</span>g       	<span class="token comment">// 现在正在运行的协程</span>
	id            <span class="token builtin">int64</span>		 	<span class="token comment">// 线程ID</span>
	mOS											<span class="token comment">// 当前操作系统对线程的额外描述信息</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="_12-2-执行"><a href="#_12-2-执行" class="header-anchor">#</a> 12.2 执行</h2> <h3 id="_12-2-1-单线程循环-go-0-x"><a href="#_12-2-1-单线程循环-go-0-x" class="header-anchor">#</a> 12.2.1 单线程循环（Go 0.x）</h3> <p><strong>总结图：</strong></p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57qxoptk4j21hm0simyy.jpg" alt="image-20220815205709047"></p> <p><strong>底层源码：</strong></p> <ul><li><p><code>runtime/proc.go</code> 中的 <code>schedule()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// schedule 寻找可以可以运行的协程并执行它</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获得当前运行的协程</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token comment">// 永远不调度正在调用 cgo 的协程，因为它要用到 g0 栈</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>incgo <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: in cgo&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
	<span class="token operator">...</span>
  <span class="token comment">// 2. 即将要调用的协程</span>
	<span class="token keyword">var</span> gp <span class="token operator">*</span>g
	<span class="token comment">// 3. 想办法在本地队列和全局队列中拿到一个可以运行的协程</span>
  <span class="token operator">...</span>
  <span class="token comment">// 4. 调用 execute()</span>
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 中的 <code>execute()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// execute 让 gp 运行在当前线程上</span>
<span class="token keyword">func</span> <span class="token function">execute</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 1. 将当前协程 _g_ 的线程信息复制到即将要调用的协程 gp</span>
	_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">=</span> gp
	gp<span class="token punctuation">.</span>m <span class="token operator">=</span> _g_<span class="token punctuation">.</span>m
	<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>waitsince <span class="token operator">=</span> <span class="token number">0</span>
	gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>
	gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> gp<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>lo <span class="token operator">+</span> _StackGuard
	<span class="token operator">...</span>
	
  <span class="token comment">// 2. 调用 gogo()</span>
	<span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>gogo()</code>  是用汇编写的</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// func gogo(buf *gobuf)</span>
<span class="token comment">// 往 g stack 插入一个 goexit() 栈帧并跳到程序计数器的位置，去执行业务方法</span>
TEXT runtime·<span class="token function">gogo</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">16</span><span class="token operator">-</span><span class="token number">8</span>
	MOVQ	buf<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX		
	MOVQ	<span class="token function">gobuf_g</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVQ	<span class="token function">0</span><span class="token punctuation">(</span>DX<span class="token punctuation">)</span><span class="token punctuation">,</span> CX		
	<span class="token function">get_tls</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>								<span class="token comment">// 使用 gobuf 拿到 g stack</span>
	MOVQ	DX<span class="token punctuation">,</span> <span class="token function">g</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>						
	MOVQ	<span class="token function">gobuf_sp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> SP		<span class="token comment">// 往 g stack 中插入一个 goexit 的栈帧</span>
	MOVQ	<span class="token function">gobuf_ret</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
	MOVQ	<span class="token function">gobuf_ctxt</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVQ	<span class="token function">gobuf_bp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> BP
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_sp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>	
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_ret</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_ctxt</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_bp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	<span class="token function">gobuf_pc</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> BX		<span class="token comment">// 跳转到现在协程的程序计数器的位置</span>
	JMP	BX
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>goexit()</code> 也是用汇编写的</p> <div class="language-go extra-class"><pre class="language-go"><code>TEXT runtime·<span class="token function">goexit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>
	BYTE	$<span class="token number">0x90</span>	
	CALL	runtime·<span class="token function">goexit1</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>	<span class="token comment">// 实际是调用了 runtime.goexit1()</span>
	BYTE	$<span class="token number">0x90</span>	
</code></pre></div></li> <li><p><code>runtime/proc.g</code> 中的 <code>goexit1()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 退出当前协程</span>
<span class="token keyword">func</span> <span class="token function">goexit1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>
		<span class="token function">racegoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
		<span class="token function">traceGoEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 跳转到 g0 stack 然后调用 goexit0 方法</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>goexit0<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>goexit0()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// goexit0 重置当前协程 gp，</span>
<span class="token keyword">func</span> <span class="token function">goexit0</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 重置 gp 的一些信息</span>
  <span class="token comment">// 2. 丢掉 gp</span>
	<span class="token function">dropg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
  <span class="token comment">// 3. 重新调度协程执行</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><strong>抽象图：</strong></p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57s0gq51ej20q409oq38.jpg" alt="image-20220815213427093" style="zoom:50%;"> <h3 id="_12-2-2-多线程循环-go-1-0"><a href="#_12-2-2-多线程循环-go-1-0" class="header-anchor">#</a> 12.2.2 多线程循环（Go 1.0）</h3> <ul><li>在操作系统层面还是线程在运行，对 Goroutine 无感知；</li> <li>操作系统线程执行一个协程调度，顺序执行 Goroutine；</li> <li>调度循环非常像 <strong>线程池</strong>；</li> <li>就目前（Go1.0）的模型，有多少线程，就最多有多少并发，且会抢夺协程队列的全局锁；</li> <li></li></ul> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57s3zsrgoj21bg0tu0un.jpg" alt="image-20220815213750855"></p> <h2 id="_12-3-gmp"><a href="#_12-3-gmp" class="header-anchor">#</a> 12.3 GMP</h2> <h3 id="_12-3-1-p-的底层"><a href="#_12-3-1-p-的底层" class="header-anchor">#</a> 12.3.1 P 的底层</h3> <p>P 即处理器，用来将 G 送到 M 上去执行。它维持了一个本地队列，这样每次获取 G 不一定都要去全局队列拿，大大减少了并发冲突的情况。</p> <p>它的本质是 <code>runtime/runtime2.go</code> 中的 <code>p</code> 结构体</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	m           muintptr   <span class="token comment">// 当前负责的线程</span>
	<span class="token comment">// 可运行的协程的队列，可无锁访问</span>
	runqhead <span class="token builtin">uint32</span>					 <span class="token comment">// 队头</span>
	runqtail <span class="token builtin">uint32</span>					 <span class="token comment">// 队尾</span>
	runq     <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span>guintptr   <span class="token comment">// 长度为 256</span>
	runnext guintptr				 <span class="token comment">// 下一个可用的协程的指针</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57sl36b40j20o40u8js7.jpg" alt="image-20220815215416942" style="zoom:50%;"> <h3 id="_12-3-2-概述"><a href="#_12-3-2-概述" class="header-anchor">#</a> 12.3.2 概述</h3> <ul><li>GMP 模型即每个 P 维护一个本地队列 runq，一般情况下，P 负责在 runq 上挑选 G 送到 M 上去运行，当 runq 上没有 G，就抢占锁去全局队列 globalq 上寻找 G。</li></ul> <h3 id="_12-3-3-源码-go1-16"><a href="#_12-3-3-源码-go1-16" class="header-anchor">#</a> 12.3.3 源码（Go1.16）</h3> <ul><li><p>再来看 <code>runtime/proc.go</code> 中的 <code>schedule()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// schedule 寻找可以可以运行的协程并执行它</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获得当前运行的协程</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token comment">// 永远不调度正在调用 cgo 的协程，因为它要用到 g0 栈</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>incgo <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: in cgo&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
	<span class="token operator">...</span>
  <span class="token comment">// 2. 即将要调用的协程</span>
	<span class="token keyword">var</span> gp <span class="token operator">*</span>g
	<span class="token comment">// 3. 想办法在本地队列和全局队列中拿到一个可以运行的协程</span>
  <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3.1 在本地队列中寻找 G</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
  <span class="token comment">// 4. 调用 execute()</span>
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 中的 <code>runqget()</code></p></li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runqget 从本地队列中获取 g</span>
<span class="token keyword">func</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 先找 p 中的 runnext，有就直接拿去执行</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		next <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>runnext
		<span class="token keyword">if</span> next <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> _p_<span class="token punctuation">.</span>runnext<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>findrunnable()</code> 就是先在全局队列中找，还找不到，就去别的 P 下的队列偷一半来，分为 <code>globrunqget()</code> 和 <code>runqsteal()</code></p></li> <li><p><code>runtime/proc.go</code> 的 <code>globrunqget()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 从全局队列中获取 G</span>
<span class="token comment">// 上锁</span>
<span class="token keyword">func</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">,</span> max <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 的 <code>runqsteal()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 从 p2 中偷一半的 G 给 _p_ 执行</span>
<span class="token keyword">func</span> <span class="token function">runqsteal</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> p2 <span class="token operator">*</span>p<span class="token punctuation">,</span> stealRunNextG <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="_12-3-4-新建协程"><a href="#_12-3-4-新建协程" class="header-anchor">#</a> 12.3.4 新建协程</h3> <ul><li>新建协程的时候，会随机放到一个本地队列中；</li> <li>如果本地队列都满了的话，才会放在全局队列；</li> <li>Go 会优先执行新建的协程；</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// newproc 新建一个协程</span>
<span class="token keyword">func</span> <span class="token function">newproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	argp <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先建 g 结构体值</span>
		newg <span class="token operator">:=</span> <span class="token function">newproc1</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> argp<span class="token punctuation">,</span> siz<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> pc<span class="token punctuation">)</span>

		_p_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 g 放到队列中</span>
		<span class="token function">runqput</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> newg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> mainStarted <span class="token punctuation">{</span>
			<span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 将 g 放到队列中</span>
<span class="token keyword">func</span> <span class="token function">runqput</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">,</span> gp <span class="token operator">*</span>g<span class="token punctuation">,</span> next <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token operator">...</span>
  <span class="token comment">// 1. 先看看能不能放到本地队列</span>
	h <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadAcq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>runqhead<span class="token punctuation">)</span> <span class="token comment">// load-acquire, synchronize with consumers</span>
	t <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>runqtail
	<span class="token keyword">if</span> t<span class="token operator">-</span>h <span class="token operator">&lt;</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>runq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_p_<span class="token punctuation">.</span>runq<span class="token punctuation">[</span>t<span class="token operator">%</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>runq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreRel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>runqtail<span class="token punctuation">,</span> t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// store-release, makes the item available for consumption</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 2. 本地队列满了，就放全局队列</span>
	<span class="token keyword">if</span> <span class="token function">runqputslow</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> h<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_12-3-5-总原理图"><a href="#_12-3-5-总原理图" class="header-anchor">#</a> 12.3.5 总原理图</h3> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57sa0idr0j20w60u0did.jpg" alt="img" style="zoom:50%;"> <table><thead><tr><th>代号</th> <th>名称</th> <th>定义位置</th> <th>作用</th></tr></thead> <tbody><tr><td>Sched</td> <td>调度器</td> <td>proc.c</td> <td>维护有存储 M 和 G 的队列以及调度器的一些状态信息等。</td></tr> <tr><td>M</td> <td>Machine 系统线程</td> <td>runtime.h</td> <td>它由操作系统管理的，Goroutine 就是跑在 M 之上的；M 是一个很大的结构，里面维护小对象内存 cache（mcache）、当前执行的 Goroutine、随机数发生器等等非常多的信息。</td></tr> <tr><td>P</td> <td>Processor 处理器</td> <td>runtime.h</td> <td>它的主要用途就是用来执行 Goroutine 的，它维护了一个 Goroutine 队列，即 runqueue。Processor 是让我们从 N:1 调度到 M:N 调度的重要部分。</td></tr> <tr><td>G</td> <td>Goroutine 实现的核心结构</td> <td>runtime.h</td> <td>它包含了栈，指令指针，以及其他对调度 Goroutine 很重要的信息，例如其阻塞的 channel。</td></tr></tbody></table> <h2 id="_12-4-并发"><a href="#_12-4-并发" class="header-anchor">#</a> 12.4 并发</h2> <h3 id="_12-4-1-协程饥饿"><a href="#_12-4-1-协程饥饿" class="header-anchor">#</a> 12.4.1 协程饥饿</h3> <ul><li>当有的协程执行时间过长，导致占用线程过久，其他协程得不到运行的机会，就出现了协程饥饿问题。</li></ul> <h3 id="_12-4-2-触发切换"><a href="#_12-4-2-触发切换" class="header-anchor">#</a> 12.4.2 触发切换</h3> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vi6wrdqj21ho0sqjtn.jpg" alt="image-20220815233517856"></p> <ul><li>全局队列协程饥饿问题：线程每循环 61 次，便会从全局队列中挑一个 G 去执行。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 每循环 61 次，便会从全局队列中挑一个 G 去执行</span>
		<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">%</span><span class="token number">61</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			gp <span class="token operator">=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_12-4-3-切换时机"><a href="#_12-4-3-切换时机" class="header-anchor">#</a> 12.4.3 切换时机</h3> <div class="custom-block tip"><p class="custom-block-title">总结</p> <ul><li>基于协作的抢占式调度
<ul><li>主动挂起：<code>runtime.gopark()</code></li> <li>系统调用结束时：<code>exitsyscall()</code></li> <li>函数跳转时：<code>morestack()</code></li></ul></li> <li>基于信号的抢占式调度
<ul><li>信号调度：<code>doSigPreempt()</code></li></ul></li></ul></div> <ul><li><p>主动挂起：<code>runtime.gopark()</code></p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vq4flf5j21j20s4jto.jpg" alt="image-20220815234253697"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token comment">// 挂起当前协程</span>
<span class="token keyword">func</span> <span class="token function">gopark</span><span class="token punctuation">(</span>unlockf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>g<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> lock unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> reason waitReason<span class="token punctuation">,</span> traceEv <span class="token builtin">byte</span><span class="token punctuation">,</span> traceskip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token comment">// 切换到 g0 stack，进行线程循环</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>park_m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>系统调用结束时：会执行 <code>exitsyscall()</code>，它里面会调用 <code>mcall()</code> 切换到 <code>g0 stack</code>。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vx0tfayj21g60r4tb4.jpg" alt="image-20220815234932384"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token comment">// 系统调用完成时会调用 exitsyscall</span>
<span class="token keyword">func</span> <span class="token function">exitsyscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// 切换到 g0 stack，进行线程循环</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>exitsyscall0<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>标记抢占：<code>morestack()</code></p> <p>当函数跳转时都会调用这个方法，它的本意在于检查当前协程栈空间是否有足够内存，如果不够就要扩大该栈空间。当系统监控到协程运行超过 <code>10ms</code>，就将 <code>g.stackguard0</code> 置为 <code>0xfffffade</code>（该值是一个抢占标志），让程序在只执行 <code>morestack()</code> 函数时顺便判断一下是否将 <code>g</code> 中的 <code>stackguard</code> 置为抢占 <code>preempt</code>，如果的确被标记抢占，就回到 <code>schedule()</code> 方法，并将当前协程放回队列中。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57w74gg19j21iq0smwgs.jpg" alt="image-20220815235915661"></p> <p><code>morestack()</code> 在需要创建更多栈空间的时候，会执行 <code>newstack()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/stack.go</span>
<span class="token comment">// newstack 创建新的栈空间</span>
<span class="token keyword">func</span> <span class="token function">newstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// 1. 判断 gp.stackguard0 是否被标记为抢占</span>
	preempt <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>stackguard0<span class="token punctuation">)</span> <span class="token operator">==</span> stackPreempt
	<span class="token operator">...</span>
  <span class="token comment">// 2. 如果被标记位抢占，调用 gogo()</span>
	<span class="token keyword">if</span> preempt <span class="token punctuation">{</span>
    <span class="token comment">// 3. 最终会去调用  schedule() 去调新的协程执行</span>
		<span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token comment">// never return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
		<span class="token function">traceGoPreempt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">goschedImpl</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">goschedImpl</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token comment">// 调用 schedule()</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>信号调度：<code>doSigPreempt()</code></p> <p>当程序在执行过程中既无法主动挂起，也不能进行系统调用，且无法进行函数调用时，就可以使用信号来调度。</p> <p>信号其实就是线程信号，在操作系统中有很多基于信号的底层通信方式（SIGPIPE / SIGURG / SIGHUP），而我们的线程可以注册对应信号的处理函数。</p> <p>Go 中是注册了 <code>SIGURG</code> 信号的处理函数 <code>doSigPreempt()</code>，在 GC 工作时，向目标线程发送信号。线程收到信号后，会触发调度。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57wecvgwdj21hk0ssgny.jpg" alt="image-20220816000612561"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/signal_unix.go</span>

<span class="token comment">// doSigPreempt 处理 gp 上的抢占信号</span>
<span class="token keyword">func</span> <span class="token function">doSigPreempt</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> ctxt <span class="token operator">*</span>sigctxt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 检查此 g 是否要被抢占并且安全抢占;</span>
	<span class="token keyword">if</span> <span class="token function">wantAsyncPreempt</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ok<span class="token punctuation">,</span> newpc <span class="token operator">:=</span> <span class="token function">isAsyncSafePoint</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigsp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">siglr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token comment">// 2. 调整程序计数器 PC 并异步调用 asyncPreempt</span>
			ctxt<span class="token punctuation">.</span><span class="token function">pushCall</span><span class="token punctuation">(</span><span class="token function">funcPC</span><span class="token punctuation">(</span>asyncPreempt<span class="token punctuation">)</span><span class="token punctuation">,</span> newpc<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/preempt.go</span>

<span class="token comment">// asyncPreempt 保存所有用户寄存器并调用 asyncPreempt2</span>
<span class="token keyword">func</span> <span class="token function">asyncPreempt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">asyncPreempt2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 调用 mcall，跳转到 g0 stack，去执行 schedule()</span>
	<span class="token keyword">if</span> gp<span class="token punctuation">.</span>preemptStop <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>preemptPark<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>gopreempt_m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="_12-4-弊端"><a href="#_12-4-弊端" class="header-anchor">#</a> 12.4 弊端</h2> <h3 id="_12-4-1-问题"><a href="#_12-4-1-问题" class="header-anchor">#</a> 12.4.1 问题</h3> <p>协程太多会导致：</p> <ul><li>文件打开数限制；</li> <li>内存限制；</li> <li>调度开销过大；</li></ul> <h3 id="_12-4-2-解决"><a href="#_12-4-2-解决" class="header-anchor">#</a> 12.4.2 解决</h3> <ul><li><p>优化业务逻辑；（优先考虑）</p></li> <li><p>利用 channel 的缓冲区；</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">do</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> ch <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
  <span class="token operator">&lt;-</span>ch
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 限制 channel 缓冲区为 3000，最多支持 3000 协程并发</span>
  c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> math<span class="token punctuation">.</span>MaxInt32<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    c <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token function">do</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>协程池；（一般不）</p></li> <li><p>调整系统资源；</p></li></ul> <p>​</p> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/16/2022, 12:18:14 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/golang/03-advance/11-内存对齐.html" class="prev">
        11. 内存对齐
      </a></span> <span class="next"><a href="/noteSite/backend/golang/03-advance/13-锁.html">
        13. 锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.44d0ef15.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/44.34ab495d.js" defer></script>
  </body>
</html>
