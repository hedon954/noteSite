<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>12. Goroutine | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.15b6de7e.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/40.f6a371fd.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.75282223.js"><link rel="prefetch" href="/noteSite/assets/js/100.fa2c2384.js"><link rel="prefetch" href="/noteSite/assets/js/101.01c2d0a1.js"><link rel="prefetch" href="/noteSite/assets/js/102.5fbda5b9.js"><link rel="prefetch" href="/noteSite/assets/js/103.3f7380a1.js"><link rel="prefetch" href="/noteSite/assets/js/104.a09deffa.js"><link rel="prefetch" href="/noteSite/assets/js/105.7bd15c0c.js"><link rel="prefetch" href="/noteSite/assets/js/106.038bcb55.js"><link rel="prefetch" href="/noteSite/assets/js/107.44add0a9.js"><link rel="prefetch" href="/noteSite/assets/js/108.b9449ed1.js"><link rel="prefetch" href="/noteSite/assets/js/109.e0380b9e.js"><link rel="prefetch" href="/noteSite/assets/js/11.0b552745.js"><link rel="prefetch" href="/noteSite/assets/js/110.a5dabe68.js"><link rel="prefetch" href="/noteSite/assets/js/111.26c3ec26.js"><link rel="prefetch" href="/noteSite/assets/js/112.5f7a1999.js"><link rel="prefetch" href="/noteSite/assets/js/113.754975cc.js"><link rel="prefetch" href="/noteSite/assets/js/114.72c208d8.js"><link rel="prefetch" href="/noteSite/assets/js/115.166d92cb.js"><link rel="prefetch" href="/noteSite/assets/js/116.d6a178ae.js"><link rel="prefetch" href="/noteSite/assets/js/117.efc1030b.js"><link rel="prefetch" href="/noteSite/assets/js/118.cde5518e.js"><link rel="prefetch" href="/noteSite/assets/js/119.f6c0df3b.js"><link rel="prefetch" href="/noteSite/assets/js/12.92824130.js"><link rel="prefetch" href="/noteSite/assets/js/120.6f697156.js"><link rel="prefetch" href="/noteSite/assets/js/121.dc6a74bb.js"><link rel="prefetch" href="/noteSite/assets/js/122.d95362ae.js"><link rel="prefetch" href="/noteSite/assets/js/123.e1d6ee99.js"><link rel="prefetch" href="/noteSite/assets/js/124.8d4acc41.js"><link rel="prefetch" href="/noteSite/assets/js/125.0d0c051c.js"><link rel="prefetch" href="/noteSite/assets/js/126.1c5c09dc.js"><link rel="prefetch" href="/noteSite/assets/js/127.1f7f8fce.js"><link rel="prefetch" href="/noteSite/assets/js/128.45469051.js"><link rel="prefetch" href="/noteSite/assets/js/129.37d826a8.js"><link rel="prefetch" href="/noteSite/assets/js/13.ebf19a2d.js"><link rel="prefetch" href="/noteSite/assets/js/130.88d6afb9.js"><link rel="prefetch" href="/noteSite/assets/js/131.774a74b7.js"><link rel="prefetch" href="/noteSite/assets/js/132.1704fcae.js"><link rel="prefetch" href="/noteSite/assets/js/133.fc3006db.js"><link rel="prefetch" href="/noteSite/assets/js/134.5716ef8b.js"><link rel="prefetch" href="/noteSite/assets/js/135.c50e9ea6.js"><link rel="prefetch" href="/noteSite/assets/js/136.20dfa2a7.js"><link rel="prefetch" href="/noteSite/assets/js/137.cb04b260.js"><link rel="prefetch" href="/noteSite/assets/js/138.19cad5d6.js"><link rel="prefetch" href="/noteSite/assets/js/139.6f2c07d8.js"><link rel="prefetch" href="/noteSite/assets/js/14.c9554d8e.js"><link rel="prefetch" href="/noteSite/assets/js/140.1b6c5422.js"><link rel="prefetch" href="/noteSite/assets/js/141.675c0f9b.js"><link rel="prefetch" href="/noteSite/assets/js/142.76209354.js"><link rel="prefetch" href="/noteSite/assets/js/143.19655c31.js"><link rel="prefetch" href="/noteSite/assets/js/144.df6e000f.js"><link rel="prefetch" href="/noteSite/assets/js/145.da6c4b93.js"><link rel="prefetch" href="/noteSite/assets/js/146.6cdb4866.js"><link rel="prefetch" href="/noteSite/assets/js/147.147e6d65.js"><link rel="prefetch" href="/noteSite/assets/js/148.0190a0de.js"><link rel="prefetch" href="/noteSite/assets/js/149.34f70845.js"><link rel="prefetch" href="/noteSite/assets/js/15.80ccce32.js"><link rel="prefetch" href="/noteSite/assets/js/150.e613dbbb.js"><link rel="prefetch" href="/noteSite/assets/js/151.5ad98d0d.js"><link rel="prefetch" href="/noteSite/assets/js/152.9d588c12.js"><link rel="prefetch" href="/noteSite/assets/js/153.b20bef21.js"><link rel="prefetch" href="/noteSite/assets/js/154.a48744d9.js"><link rel="prefetch" href="/noteSite/assets/js/155.c3ba408c.js"><link rel="prefetch" href="/noteSite/assets/js/156.4b410d86.js"><link rel="prefetch" href="/noteSite/assets/js/157.3de92249.js"><link rel="prefetch" href="/noteSite/assets/js/158.b2af571d.js"><link rel="prefetch" href="/noteSite/assets/js/159.ef85befc.js"><link rel="prefetch" href="/noteSite/assets/js/16.04c546fc.js"><link rel="prefetch" href="/noteSite/assets/js/160.d623ea16.js"><link rel="prefetch" href="/noteSite/assets/js/161.d8106190.js"><link rel="prefetch" href="/noteSite/assets/js/162.dbfa1714.js"><link rel="prefetch" href="/noteSite/assets/js/163.c24e5621.js"><link rel="prefetch" href="/noteSite/assets/js/164.b9eb66a9.js"><link rel="prefetch" href="/noteSite/assets/js/165.215f3273.js"><link rel="prefetch" href="/noteSite/assets/js/166.1c4660fa.js"><link rel="prefetch" href="/noteSite/assets/js/167.6a352d81.js"><link rel="prefetch" href="/noteSite/assets/js/168.ec322d81.js"><link rel="prefetch" href="/noteSite/assets/js/169.e770dabb.js"><link rel="prefetch" href="/noteSite/assets/js/17.931e78bb.js"><link rel="prefetch" href="/noteSite/assets/js/170.23b4c824.js"><link rel="prefetch" href="/noteSite/assets/js/171.dd1498dd.js"><link rel="prefetch" href="/noteSite/assets/js/172.8e0f461e.js"><link rel="prefetch" href="/noteSite/assets/js/173.dc35e674.js"><link rel="prefetch" href="/noteSite/assets/js/174.d2a55138.js"><link rel="prefetch" href="/noteSite/assets/js/175.f2338c25.js"><link rel="prefetch" href="/noteSite/assets/js/176.7fb42c0d.js"><link rel="prefetch" href="/noteSite/assets/js/177.7661d1d5.js"><link rel="prefetch" href="/noteSite/assets/js/178.da956398.js"><link rel="prefetch" href="/noteSite/assets/js/179.ca23bf7b.js"><link rel="prefetch" href="/noteSite/assets/js/18.920cb685.js"><link rel="prefetch" href="/noteSite/assets/js/180.9ccd5c8a.js"><link rel="prefetch" href="/noteSite/assets/js/181.8d428209.js"><link rel="prefetch" href="/noteSite/assets/js/182.34bb23ea.js"><link rel="prefetch" href="/noteSite/assets/js/183.16d76d78.js"><link rel="prefetch" href="/noteSite/assets/js/184.48340f37.js"><link rel="prefetch" href="/noteSite/assets/js/185.127bc886.js"><link rel="prefetch" href="/noteSite/assets/js/186.0edc4748.js"><link rel="prefetch" href="/noteSite/assets/js/187.0f344a00.js"><link rel="prefetch" href="/noteSite/assets/js/188.2f07742f.js"><link rel="prefetch" href="/noteSite/assets/js/189.02245f28.js"><link rel="prefetch" href="/noteSite/assets/js/19.899200c9.js"><link rel="prefetch" href="/noteSite/assets/js/190.2acf376c.js"><link rel="prefetch" href="/noteSite/assets/js/191.ae40cba3.js"><link rel="prefetch" href="/noteSite/assets/js/192.660e93fe.js"><link rel="prefetch" href="/noteSite/assets/js/193.918136eb.js"><link rel="prefetch" href="/noteSite/assets/js/194.b46b8ccf.js"><link rel="prefetch" href="/noteSite/assets/js/195.ee3473d6.js"><link rel="prefetch" href="/noteSite/assets/js/196.11e0771e.js"><link rel="prefetch" href="/noteSite/assets/js/197.1790eaff.js"><link rel="prefetch" href="/noteSite/assets/js/198.f60df26b.js"><link rel="prefetch" href="/noteSite/assets/js/199.37af66c6.js"><link rel="prefetch" href="/noteSite/assets/js/20.31cf6b87.js"><link rel="prefetch" href="/noteSite/assets/js/200.a8bf8cd4.js"><link rel="prefetch" href="/noteSite/assets/js/201.ba2c155d.js"><link rel="prefetch" href="/noteSite/assets/js/202.4c7ed5e5.js"><link rel="prefetch" href="/noteSite/assets/js/203.c013b9ae.js"><link rel="prefetch" href="/noteSite/assets/js/204.0005dab4.js"><link rel="prefetch" href="/noteSite/assets/js/205.03565aa4.js"><link rel="prefetch" href="/noteSite/assets/js/206.2faedf0d.js"><link rel="prefetch" href="/noteSite/assets/js/207.00aed5e0.js"><link rel="prefetch" href="/noteSite/assets/js/208.9ef9ebf7.js"><link rel="prefetch" href="/noteSite/assets/js/209.e3d37694.js"><link rel="prefetch" href="/noteSite/assets/js/21.16319045.js"><link rel="prefetch" href="/noteSite/assets/js/210.36a55d0a.js"><link rel="prefetch" href="/noteSite/assets/js/211.d3878160.js"><link rel="prefetch" href="/noteSite/assets/js/212.d72d3676.js"><link rel="prefetch" href="/noteSite/assets/js/213.fc33712b.js"><link rel="prefetch" href="/noteSite/assets/js/214.81ad4b34.js"><link rel="prefetch" href="/noteSite/assets/js/215.51b3c04f.js"><link rel="prefetch" href="/noteSite/assets/js/216.c1845506.js"><link rel="prefetch" href="/noteSite/assets/js/217.7964b1bd.js"><link rel="prefetch" href="/noteSite/assets/js/218.b690fe4b.js"><link rel="prefetch" href="/noteSite/assets/js/219.0608bdb7.js"><link rel="prefetch" href="/noteSite/assets/js/22.83c27518.js"><link rel="prefetch" href="/noteSite/assets/js/220.12f67b89.js"><link rel="prefetch" href="/noteSite/assets/js/221.30da5fc5.js"><link rel="prefetch" href="/noteSite/assets/js/222.42747282.js"><link rel="prefetch" href="/noteSite/assets/js/223.57ba2387.js"><link rel="prefetch" href="/noteSite/assets/js/224.e997e986.js"><link rel="prefetch" href="/noteSite/assets/js/225.4e536560.js"><link rel="prefetch" href="/noteSite/assets/js/226.ab97b466.js"><link rel="prefetch" href="/noteSite/assets/js/227.09b6f548.js"><link rel="prefetch" href="/noteSite/assets/js/228.a435f8a9.js"><link rel="prefetch" href="/noteSite/assets/js/229.b17d76a0.js"><link rel="prefetch" href="/noteSite/assets/js/23.4def1b30.js"><link rel="prefetch" href="/noteSite/assets/js/230.2467a235.js"><link rel="prefetch" href="/noteSite/assets/js/231.182c7fb6.js"><link rel="prefetch" href="/noteSite/assets/js/232.dacf767e.js"><link rel="prefetch" href="/noteSite/assets/js/233.f3af05cc.js"><link rel="prefetch" href="/noteSite/assets/js/234.5108b69a.js"><link rel="prefetch" href="/noteSite/assets/js/235.a0c3ec26.js"><link rel="prefetch" href="/noteSite/assets/js/236.a5196059.js"><link rel="prefetch" href="/noteSite/assets/js/24.833a668b.js"><link rel="prefetch" href="/noteSite/assets/js/25.0aa4ab15.js"><link rel="prefetch" href="/noteSite/assets/js/26.4bb01d00.js"><link rel="prefetch" href="/noteSite/assets/js/27.28e3df64.js"><link rel="prefetch" href="/noteSite/assets/js/28.6fd43352.js"><link rel="prefetch" href="/noteSite/assets/js/29.c7e2c8bd.js"><link rel="prefetch" href="/noteSite/assets/js/3.55ea5c47.js"><link rel="prefetch" href="/noteSite/assets/js/30.592a250a.js"><link rel="prefetch" href="/noteSite/assets/js/31.4117ddbf.js"><link rel="prefetch" href="/noteSite/assets/js/32.7dec0eab.js"><link rel="prefetch" href="/noteSite/assets/js/33.f350693e.js"><link rel="prefetch" href="/noteSite/assets/js/34.69de4dbc.js"><link rel="prefetch" href="/noteSite/assets/js/35.3c111ca9.js"><link rel="prefetch" href="/noteSite/assets/js/36.beda9626.js"><link rel="prefetch" href="/noteSite/assets/js/37.5d73cf22.js"><link rel="prefetch" href="/noteSite/assets/js/38.822c65a9.js"><link rel="prefetch" href="/noteSite/assets/js/39.108b5718.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/41.4ec05a60.js"><link rel="prefetch" href="/noteSite/assets/js/42.ced4d215.js"><link rel="prefetch" href="/noteSite/assets/js/43.518f3d73.js"><link rel="prefetch" href="/noteSite/assets/js/44.2f222349.js"><link rel="prefetch" href="/noteSite/assets/js/45.3cd8ec7e.js"><link rel="prefetch" href="/noteSite/assets/js/46.c63316fe.js"><link rel="prefetch" href="/noteSite/assets/js/47.8a98effd.js"><link rel="prefetch" href="/noteSite/assets/js/48.829750fe.js"><link rel="prefetch" href="/noteSite/assets/js/49.b9adb364.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.d6cd4367.js"><link rel="prefetch" href="/noteSite/assets/js/51.89c8f094.js"><link rel="prefetch" href="/noteSite/assets/js/52.a43424da.js"><link rel="prefetch" href="/noteSite/assets/js/53.85509c05.js"><link rel="prefetch" href="/noteSite/assets/js/54.57e84326.js"><link rel="prefetch" href="/noteSite/assets/js/55.d623e6e1.js"><link rel="prefetch" href="/noteSite/assets/js/56.48145fda.js"><link rel="prefetch" href="/noteSite/assets/js/57.0627ff74.js"><link rel="prefetch" href="/noteSite/assets/js/58.cb17d6f5.js"><link rel="prefetch" href="/noteSite/assets/js/59.30f9147e.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.2e516ce1.js"><link rel="prefetch" href="/noteSite/assets/js/61.fc84ae88.js"><link rel="prefetch" href="/noteSite/assets/js/62.7c3db4bc.js"><link rel="prefetch" href="/noteSite/assets/js/63.532775e5.js"><link rel="prefetch" href="/noteSite/assets/js/64.e36f0a6a.js"><link rel="prefetch" href="/noteSite/assets/js/65.ac27013a.js"><link rel="prefetch" href="/noteSite/assets/js/66.04eaaace.js"><link rel="prefetch" href="/noteSite/assets/js/67.0b9c8ac5.js"><link rel="prefetch" href="/noteSite/assets/js/68.e34d9385.js"><link rel="prefetch" href="/noteSite/assets/js/69.0f97c351.js"><link rel="prefetch" href="/noteSite/assets/js/7.da9921ea.js"><link rel="prefetch" href="/noteSite/assets/js/70.4e5c2434.js"><link rel="prefetch" href="/noteSite/assets/js/71.215c12d1.js"><link rel="prefetch" href="/noteSite/assets/js/72.e70166f6.js"><link rel="prefetch" href="/noteSite/assets/js/73.318584d8.js"><link rel="prefetch" href="/noteSite/assets/js/74.fc5edc93.js"><link rel="prefetch" href="/noteSite/assets/js/75.7dba2e9a.js"><link rel="prefetch" href="/noteSite/assets/js/76.20a748eb.js"><link rel="prefetch" href="/noteSite/assets/js/77.0e622806.js"><link rel="prefetch" href="/noteSite/assets/js/78.a3309481.js"><link rel="prefetch" href="/noteSite/assets/js/79.86216f31.js"><link rel="prefetch" href="/noteSite/assets/js/8.aeb5f827.js"><link rel="prefetch" href="/noteSite/assets/js/80.7df5c162.js"><link rel="prefetch" href="/noteSite/assets/js/81.fbfca43e.js"><link rel="prefetch" href="/noteSite/assets/js/82.574dbb1d.js"><link rel="prefetch" href="/noteSite/assets/js/83.b372cce8.js"><link rel="prefetch" href="/noteSite/assets/js/84.679ba992.js"><link rel="prefetch" href="/noteSite/assets/js/85.212e402d.js"><link rel="prefetch" href="/noteSite/assets/js/86.3290b388.js"><link rel="prefetch" href="/noteSite/assets/js/87.e0662abf.js"><link rel="prefetch" href="/noteSite/assets/js/88.a3bb83db.js"><link rel="prefetch" href="/noteSite/assets/js/89.9b166836.js"><link rel="prefetch" href="/noteSite/assets/js/9.f364677d.js"><link rel="prefetch" href="/noteSite/assets/js/90.5f4923fc.js"><link rel="prefetch" href="/noteSite/assets/js/91.5bffef3d.js"><link rel="prefetch" href="/noteSite/assets/js/92.7dfbd84c.js"><link rel="prefetch" href="/noteSite/assets/js/93.d293cff0.js"><link rel="prefetch" href="/noteSite/assets/js/94.c68b142b.js"><link rel="prefetch" href="/noteSite/assets/js/95.0cf57b3f.js"><link rel="prefetch" href="/noteSite/assets/js/96.9e11f6e1.js"><link rel="prefetch" href="/noteSite/assets/js/97.dad51d14.js"><link rel="prefetch" href="/noteSite/assets/js/98.74a1010a.js"><link rel="prefetch" href="/noteSite/assets/js/99.128d25fb.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>入门</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>底层</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/golang/03-advance/01-为什么要使用Go.html" class="sidebar-link">1. 为什么要使用 Go 语言？</a></li><li><a href="/noteSite/backend/golang/03-advance/02-什么是Runtime.html" class="sidebar-link">2. 何为 Runtime？</a></li><li><a href="/noteSite/backend/golang/03-advance/03-Go是面向对象吗.html" class="sidebar-link">3. Go 是面向对象吗？</a></li><li><a href="/noteSite/backend/golang/03-advance/04-Go程序是如何编译的.html" class="sidebar-link">4. Go 程序是如何编译的？</a></li><li><a href="/noteSite/backend/golang/03-advance/05-Go程序是如何启动的.html" class="sidebar-link">5. Go 程序是如何启动起来的？</a></li><li><a href="/noteSite/backend/golang/03-advance/06-大小为0字节的变量.html" class="sidebar-link">6. 大小为 0 字节的变量</a></li><li><a href="/noteSite/backend/golang/03-advance/07-string.html" class="sidebar-link">7. string</a></li><li><a href="/noteSite/backend/golang/03-advance/08-slice.html" class="sidebar-link">8. slice</a></li><li><a href="/noteSite/backend/golang/03-advance/09-map.html" class="sidebar-link">9. map</a></li><li><a href="/noteSite/backend/golang/03-advance/10-interface.html" class="sidebar-link">10. interface</a></li><li><a href="/noteSite/backend/golang/03-advance/11-内存对齐.html" class="sidebar-link">11. 内存对齐</a></li><li><a href="/noteSite/backend/golang/03-advance/12-goroutine.html" aria-current="page" class="active sidebar-link">12. Goroutine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-1-底层" class="sidebar-link">12.1 底层</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-执行" class="sidebar-link">12.2 执行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-1-单线程循环-go-0-x" class="sidebar-link">12.2.1 单线程循环（Go 0.x）</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-2-多线程循环-go-1-0" class="sidebar-link">12.2.2 多线程循环（Go 1.0）</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-gmp" class="sidebar-link">12.3 GMP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-1-p-的底层" class="sidebar-link">12.3.1 P 的底层</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-2-概述" class="sidebar-link">12.3.2 概述</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-3-源码-go1-16" class="sidebar-link">12.3.3 源码（Go1.16）</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-4-新建协程" class="sidebar-link">12.3.4 新建协程</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-5-总原理图" class="sidebar-link">12.3.5 总原理图</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-并发" class="sidebar-link">12.4 并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-1-协程饥饿" class="sidebar-link">12.4.1 协程饥饿</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-2-触发切换" class="sidebar-link">12.4.2 触发切换</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-3-切换时机" class="sidebar-link">12.4.3 切换时机</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-弊端" class="sidebar-link">12.4 弊端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-1-问题" class="sidebar-link">12.4.1 问题</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-2-解决" class="sidebar-link">12.4.2 解决</a></li></ul></li></ul></li><li><a href="/noteSite/backend/golang/03-advance/13-锁.html" class="sidebar-link">13. 锁</a></li><li><a href="/noteSite/backend/golang/03-advance/14-channel.html" class="sidebar-link">14. channel</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_12-goroutine"><a href="#_12-goroutine" class="header-anchor">#</a> 12. Goroutine</h1> <h2 id="_12-1-底层"><a href="#_12-1-底层" class="header-anchor">#</a> 12.1 底层</h2> <ul><li><p>协程的本质是 <code>runtime/runtime2.go</code> 中的 <code>g</code> 结构体：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> g <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	stack       stack   	<span class="token comment">// 当前协程的协程栈</span>
	sched        gobuf		<span class="token comment">// 保存协程运行现场</span>
	atomicstatus <span class="token builtin">uint32</span>		<span class="token comment">// 协程状态</span>
	goid         <span class="token builtin">int64</span>		<span class="token comment">// 协程 ID</span>
  m            <span class="token operator">*</span>m 			<span class="token comment">// 当前线程</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h569pjiiosj21cu0u040p.jpg" alt="image-20220814141535906"></p></li> <li><p>线程在 Go 中对应是的 <code>runtime/runtime2.go</code> 中的 <code>m</code> 结构体：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> m <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	g0      <span class="token operator">*</span>g     					<span class="token comment">// g0 协程，Go 中的主协程</span>
	curg          <span class="token operator">*</span>g       	<span class="token comment">// 现在正在运行的协程</span>
	id            <span class="token builtin">int64</span>		 	<span class="token comment">// 线程ID</span>
	mOS											<span class="token comment">// 当前操作系统对线程的额外描述信息</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="_12-2-执行"><a href="#_12-2-执行" class="header-anchor">#</a> 12.2 执行</h2> <h3 id="_12-2-1-单线程循环-go-0-x"><a href="#_12-2-1-单线程循环-go-0-x" class="header-anchor">#</a> 12.2.1 单线程循环（Go 0.x）</h3> <p><strong>总结图：</strong></p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57qxoptk4j21hm0simyy.jpg" alt="image-20220815205709047"></p> <p><strong>底层源码：</strong></p> <ul><li><p><code>runtime/proc.go</code> 中的 <code>schedule()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// schedule 寻找可以可以运行的协程并执行它</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获得当前运行的协程</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token comment">// 永远不调度正在调用 cgo 的协程，因为它要用到 g0 栈</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>incgo <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: in cgo&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
	<span class="token operator">...</span>
  <span class="token comment">// 2. 即将要调用的协程</span>
	<span class="token keyword">var</span> gp <span class="token operator">*</span>g
	<span class="token comment">// 3. 想办法在本地队列和全局队列中拿到一个可以运行的协程</span>
  <span class="token operator">...</span>
  <span class="token comment">// 4. 调用 execute()</span>
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 中的 <code>execute()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// execute 让 gp 运行在当前线程上</span>
<span class="token keyword">func</span> <span class="token function">execute</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 1. 将当前协程 _g_ 的线程信息复制到即将要调用的协程 gp</span>
	_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">=</span> gp
	gp<span class="token punctuation">.</span>m <span class="token operator">=</span> _g_<span class="token punctuation">.</span>m
	<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>waitsince <span class="token operator">=</span> <span class="token number">0</span>
	gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>
	gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> gp<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>lo <span class="token operator">+</span> _StackGuard
	<span class="token operator">...</span>
	
  <span class="token comment">// 2. 调用 gogo()</span>
	<span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>gogo()</code>  是用汇编写的</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// func gogo(buf *gobuf)</span>
<span class="token comment">// 往 g stack 插入一个 goexit() 栈帧并跳到程序计数器的位置，去执行业务方法</span>
TEXT runtime·<span class="token function">gogo</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">16</span><span class="token operator">-</span><span class="token number">8</span>
	MOVQ	buf<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX		
	MOVQ	<span class="token function">gobuf_g</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVQ	<span class="token function">0</span><span class="token punctuation">(</span>DX<span class="token punctuation">)</span><span class="token punctuation">,</span> CX		
	<span class="token function">get_tls</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>								<span class="token comment">// 使用 gobuf 拿到 g stack</span>
	MOVQ	DX<span class="token punctuation">,</span> <span class="token function">g</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>						
	MOVQ	<span class="token function">gobuf_sp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> SP		<span class="token comment">// 往 g stack 中插入一个 goexit 的栈帧</span>
	MOVQ	<span class="token function">gobuf_ret</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
	MOVQ	<span class="token function">gobuf_ctxt</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVQ	<span class="token function">gobuf_bp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> BP
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_sp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>	
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_ret</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_ctxt</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_bp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	<span class="token function">gobuf_pc</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> BX		<span class="token comment">// 跳转到现在协程的程序计数器的位置</span>
	JMP	BX
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>goexit()</code> 也是用汇编写的</p> <div class="language-go extra-class"><pre class="language-go"><code>TEXT runtime·<span class="token function">goexit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>
	BYTE	$<span class="token number">0x90</span>	
	CALL	runtime·<span class="token function">goexit1</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>	<span class="token comment">// 实际是调用了 runtime.goexit1()</span>
	BYTE	$<span class="token number">0x90</span>	
</code></pre></div></li> <li><p><code>runtime/proc.g</code> 中的 <code>goexit1()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 退出当前协程</span>
<span class="token keyword">func</span> <span class="token function">goexit1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>
		<span class="token function">racegoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
		<span class="token function">traceGoEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 跳转到 g0 stack 然后调用 goexit0 方法</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>goexit0<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>goexit0()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// goexit0 重置当前协程 gp，</span>
<span class="token keyword">func</span> <span class="token function">goexit0</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 重置 gp 的一些信息</span>
  <span class="token comment">// 2. 丢掉 gp</span>
	<span class="token function">dropg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
  <span class="token comment">// 3. 重新调度协程执行</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><strong>抽象图：</strong></p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57s0gq51ej20q409oq38.jpg" alt="image-20220815213427093" style="zoom:50%;"> <h3 id="_12-2-2-多线程循环-go-1-0"><a href="#_12-2-2-多线程循环-go-1-0" class="header-anchor">#</a> 12.2.2 多线程循环（Go 1.0）</h3> <ul><li>在操作系统层面还是线程在运行，对 Goroutine 无感知；</li> <li>操作系统线程执行一个协程调度，顺序执行 Goroutine；</li> <li>调度循环非常像 <strong>线程池</strong>；</li> <li>就目前（Go1.0）的模型，有多少线程，就最多有多少并发，且会抢夺协程队列的全局锁；</li> <li></li></ul> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57s3zsrgoj21bg0tu0un.jpg" alt="image-20220815213750855"></p> <h2 id="_12-3-gmp"><a href="#_12-3-gmp" class="header-anchor">#</a> 12.3 GMP</h2> <h3 id="_12-3-1-p-的底层"><a href="#_12-3-1-p-的底层" class="header-anchor">#</a> 12.3.1 P 的底层</h3> <p>P 即处理器，用来将 G 送到 M 上去执行。它维持了一个本地队列，这样每次获取 G 不一定都要去全局队列拿，大大减少了并发冲突的情况。</p> <p>它的本质是 <code>runtime/runtime2.go</code> 中的 <code>p</code> 结构体</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	m           muintptr   <span class="token comment">// 当前负责的线程</span>
	<span class="token comment">// 可运行的协程的队列，可无锁访问</span>
	runqhead <span class="token builtin">uint32</span>					 <span class="token comment">// 队头</span>
	runqtail <span class="token builtin">uint32</span>					 <span class="token comment">// 队尾</span>
	runq     <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span>guintptr   <span class="token comment">// 长度为 256</span>
	runnext guintptr				 <span class="token comment">// 下一个可用的协程的指针</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57sl36b40j20o40u8js7.jpg" alt="image-20220815215416942" style="zoom:50%;"> <h3 id="_12-3-2-概述"><a href="#_12-3-2-概述" class="header-anchor">#</a> 12.3.2 概述</h3> <ul><li>GMP 模型即每个 P 维护一个本地队列 runq，一般情况下，P 负责在 runq 上挑选 G 送到 M 上去运行，当 runq 上没有 G，就抢占锁去全局队列 globalq 上寻找 G。</li></ul> <h3 id="_12-3-3-源码-go1-16"><a href="#_12-3-3-源码-go1-16" class="header-anchor">#</a> 12.3.3 源码（Go1.16）</h3> <ul><li><p>再来看 <code>runtime/proc.go</code> 中的 <code>schedule()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// schedule 寻找可以可以运行的协程并执行它</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获得当前运行的协程</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token comment">// 永远不调度正在调用 cgo 的协程，因为它要用到 g0 栈</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>incgo <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: in cgo&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
	<span class="token operator">...</span>
  <span class="token comment">// 2. 即将要调用的协程</span>
	<span class="token keyword">var</span> gp <span class="token operator">*</span>g
	<span class="token comment">// 3. 想办法在本地队列和全局队列中拿到一个可以运行的协程</span>
  <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3.1 在本地队列中寻找 G</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
  <span class="token comment">// 4. 调用 execute()</span>
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 中的 <code>runqget()</code></p></li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runqget 从本地队列中获取 g</span>
<span class="token keyword">func</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 先找 p 中的 runnext，有就直接拿去执行</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		next <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>runnext
		<span class="token keyword">if</span> next <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> _p_<span class="token punctuation">.</span>runnext<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>findrunnable()</code> 就是先在全局队列中找，还找不到，就去别的 P 下的队列偷一半来，分为 <code>globrunqget()</code> 和 <code>runqsteal()</code></p></li> <li><p><code>runtime/proc.go</code> 的 <code>globrunqget()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 从全局队列中获取 G</span>
<span class="token comment">// 上锁</span>
<span class="token keyword">func</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">,</span> max <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 的 <code>runqsteal()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 从 p2 中偷一半的 G 给 _p_ 执行</span>
<span class="token keyword">func</span> <span class="token function">runqsteal</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> p2 <span class="token operator">*</span>p<span class="token punctuation">,</span> stealRunNextG <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="_12-3-4-新建协程"><a href="#_12-3-4-新建协程" class="header-anchor">#</a> 12.3.4 新建协程</h3> <ul><li>新建协程的时候，会随机放到一个本地队列中；</li> <li>如果本地队列都满了的话，才会放在全局队列；</li> <li>Go 会优先执行新建的协程；</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// newproc 新建一个协程</span>
<span class="token keyword">func</span> <span class="token function">newproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	argp <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先建 g 结构体值</span>
		newg <span class="token operator">:=</span> <span class="token function">newproc1</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> argp<span class="token punctuation">,</span> siz<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> pc<span class="token punctuation">)</span>

		_p_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 g 放到队列中</span>
		<span class="token function">runqput</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> newg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> mainStarted <span class="token punctuation">{</span>
			<span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 将 g 放到队列中</span>
<span class="token keyword">func</span> <span class="token function">runqput</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">,</span> gp <span class="token operator">*</span>g<span class="token punctuation">,</span> next <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token operator">...</span>
  <span class="token comment">// 1. 先看看能不能放到本地队列</span>
	h <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadAcq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>runqhead<span class="token punctuation">)</span> <span class="token comment">// load-acquire, synchronize with consumers</span>
	t <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>runqtail
	<span class="token keyword">if</span> t<span class="token operator">-</span>h <span class="token operator">&lt;</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>runq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_p_<span class="token punctuation">.</span>runq<span class="token punctuation">[</span>t<span class="token operator">%</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>runq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreRel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>runqtail<span class="token punctuation">,</span> t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// store-release, makes the item available for consumption</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 2. 本地队列满了，就放全局队列</span>
	<span class="token keyword">if</span> <span class="token function">runqputslow</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> h<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_12-3-5-总原理图"><a href="#_12-3-5-总原理图" class="header-anchor">#</a> 12.3.5 总原理图</h3> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57sa0idr0j20w60u0did.jpg" alt="img" style="zoom:50%;"> <table><thead><tr><th>代号</th> <th>名称</th> <th>定义位置</th> <th>作用</th></tr></thead> <tbody><tr><td>Sched</td> <td>调度器</td> <td>proc.c</td> <td>维护有存储 M 和 G 的队列以及调度器的一些状态信息等。</td></tr> <tr><td>M</td> <td>Machine 系统线程</td> <td>runtime.h</td> <td>它由操作系统管理的，Goroutine 就是跑在 M 之上的；M 是一个很大的结构，里面维护小对象内存 cache（mcache）、当前执行的 Goroutine、随机数发生器等等非常多的信息。</td></tr> <tr><td>P</td> <td>Processor 处理器</td> <td>runtime.h</td> <td>它的主要用途就是用来执行 Goroutine 的，它维护了一个 Goroutine 队列，即 runqueue。Processor 是让我们从 N:1 调度到 M:N 调度的重要部分。</td></tr> <tr><td>G</td> <td>Goroutine 实现的核心结构</td> <td>runtime.h</td> <td>它包含了栈，指令指针，以及其他对调度 Goroutine 很重要的信息，例如其阻塞的 channel。</td></tr></tbody></table> <h2 id="_12-4-并发"><a href="#_12-4-并发" class="header-anchor">#</a> 12.4 并发</h2> <h3 id="_12-4-1-协程饥饿"><a href="#_12-4-1-协程饥饿" class="header-anchor">#</a> 12.4.1 协程饥饿</h3> <ul><li>当有的协程执行时间过长，导致占用线程过久，其他协程得不到运行的机会，就出现了协程饥饿问题。</li></ul> <h3 id="_12-4-2-触发切换"><a href="#_12-4-2-触发切换" class="header-anchor">#</a> 12.4.2 触发切换</h3> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vi6wrdqj21ho0sqjtn.jpg" alt="image-20220815233517856"></p> <ul><li>全局队列协程饥饿问题：线程每循环 61 次，便会从全局队列中挑一个 G 去执行。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 每循环 61 次，便会从全局队列中挑一个 G 去执行</span>
		<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">%</span><span class="token number">61</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			gp <span class="token operator">=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_12-4-3-切换时机"><a href="#_12-4-3-切换时机" class="header-anchor">#</a> 12.4.3 切换时机</h3> <div class="custom-block tip"><p class="custom-block-title">总结</p> <ul><li>基于协作的抢占式调度
<ul><li>主动挂起：<code>runtime.gopark()</code></li> <li>系统调用结束时：<code>exitsyscall()</code></li> <li>函数跳转时：<code>morestack()</code></li></ul></li> <li>基于信号的抢占式调度
<ul><li>信号调度：<code>doSigPreempt()</code></li></ul></li></ul></div> <ul><li><p>主动挂起：<code>runtime.gopark()</code></p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vq4flf5j21j20s4jto.jpg" alt="image-20220815234253697"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token comment">// 挂起当前协程</span>
<span class="token keyword">func</span> <span class="token function">gopark</span><span class="token punctuation">(</span>unlockf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>g<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> lock unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> reason waitReason<span class="token punctuation">,</span> traceEv <span class="token builtin">byte</span><span class="token punctuation">,</span> traceskip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token comment">// 切换到 g0 stack，进行线程循环</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>park_m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>系统调用结束时：会执行 <code>exitsyscall()</code>，它里面会调用 <code>mcall()</code> 切换到 <code>g0 stack</code>。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vx0tfayj21g60r4tb4.jpg" alt="image-20220815234932384"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token comment">// 系统调用完成时会调用 exitsyscall</span>
<span class="token keyword">func</span> <span class="token function">exitsyscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// 切换到 g0 stack，进行线程循环</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>exitsyscall0<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>标记抢占：<code>morestack()</code></p> <p>当函数跳转时都会调用这个方法，它的本意在于检查当前协程栈空间是否有足够内存，如果不够就要扩大该栈空间。当系统监控到协程运行超过 <code>10ms</code>，就将 <code>g.stackguard0</code> 置为 <code>0xfffffade</code>（该值是一个抢占标志），让程序在只执行 <code>morestack()</code> 函数时顺便判断一下是否将 <code>g</code> 中的 <code>stackguard</code> 置为抢占 <code>preempt</code>，如果的确被标记抢占，就回到 <code>schedule()</code> 方法，并将当前协程放回队列中。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57w74gg19j21iq0smwgs.jpg" alt="image-20220815235915661"></p> <p><code>morestack()</code> 在需要创建更多栈空间的时候，会执行 <code>newstack()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/stack.go</span>
<span class="token comment">// newstack 创建新的栈空间</span>
<span class="token keyword">func</span> <span class="token function">newstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// 1. 判断 gp.stackguard0 是否被标记为抢占</span>
	preempt <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>stackguard0<span class="token punctuation">)</span> <span class="token operator">==</span> stackPreempt
	<span class="token operator">...</span>
  <span class="token comment">// 2. 如果被标记位抢占，调用 gogo()</span>
	<span class="token keyword">if</span> preempt <span class="token punctuation">{</span>
    <span class="token comment">// 3. 最终会去调用  schedule() 去调新的协程执行</span>
		<span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token comment">// never return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
		<span class="token function">traceGoPreempt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">goschedImpl</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">goschedImpl</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token comment">// 调用 schedule()</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>信号调度：<code>doSigPreempt()</code></p> <p>当程序在执行过程中既无法主动挂起，也不能进行系统调用，且无法进行函数调用时，就可以使用信号来调度。</p> <p>信号其实就是线程信号，在操作系统中有很多基于信号的底层通信方式（SIGPIPE / SIGURG / SIGHUP），而我们的线程可以注册对应信号的处理函数。</p> <p>Go 中是注册了 <code>SIGURG</code> 信号的处理函数 <code>doSigPreempt()</code>，在 GC 工作时，向目标线程发送信号。线程收到信号后，会触发调度。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57wecvgwdj21hk0ssgny.jpg" alt="image-20220816000612561"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/signal_unix.go</span>

<span class="token comment">// doSigPreempt 处理 gp 上的抢占信号</span>
<span class="token keyword">func</span> <span class="token function">doSigPreempt</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> ctxt <span class="token operator">*</span>sigctxt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 检查此 g 是否要被抢占并且安全抢占;</span>
	<span class="token keyword">if</span> <span class="token function">wantAsyncPreempt</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ok<span class="token punctuation">,</span> newpc <span class="token operator">:=</span> <span class="token function">isAsyncSafePoint</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigsp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">siglr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token comment">// 2. 调整程序计数器 PC 并异步调用 asyncPreempt</span>
			ctxt<span class="token punctuation">.</span><span class="token function">pushCall</span><span class="token punctuation">(</span><span class="token function">funcPC</span><span class="token punctuation">(</span>asyncPreempt<span class="token punctuation">)</span><span class="token punctuation">,</span> newpc<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/preempt.go</span>

<span class="token comment">// asyncPreempt 保存所有用户寄存器并调用 asyncPreempt2</span>
<span class="token keyword">func</span> <span class="token function">asyncPreempt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">asyncPreempt2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 调用 mcall，跳转到 g0 stack，去执行 schedule()</span>
	<span class="token keyword">if</span> gp<span class="token punctuation">.</span>preemptStop <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>preemptPark<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>gopreempt_m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="_12-4-弊端"><a href="#_12-4-弊端" class="header-anchor">#</a> 12.4 弊端</h2> <h3 id="_12-4-1-问题"><a href="#_12-4-1-问题" class="header-anchor">#</a> 12.4.1 问题</h3> <p>协程太多会导致：</p> <ul><li>文件打开数限制；</li> <li>内存限制；</li> <li>调度开销过大；</li></ul> <h3 id="_12-4-2-解决"><a href="#_12-4-2-解决" class="header-anchor">#</a> 12.4.2 解决</h3> <ul><li><p>优化业务逻辑；（优先考虑）</p></li> <li><p>利用 channel 的缓冲区；</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">do</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> ch <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
  <span class="token operator">&lt;-</span>ch
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 限制 channel 缓冲区为 3000，最多支持 3000 协程并发</span>
  c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> math<span class="token punctuation">.</span>MaxInt32<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    c <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token function">do</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>协程池；（一般不）</p></li> <li><p>调整系统资源；</p></li></ul> <p>​</p> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/16/2022, 12:18:14 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/golang/03-advance/11-内存对齐.html" class="prev">
        11. 内存对齐
      </a></span> <span class="next"><a href="/noteSite/backend/golang/03-advance/13-锁.html">
        13. 锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.15b6de7e.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/40.f6a371fd.js" defer></script>
  </body>
</html>
