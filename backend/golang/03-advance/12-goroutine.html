<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>12. Goroutine | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.2fd33669.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.cc1e379f.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/40.c3d6b0ec.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.abf5ce01.js"><link rel="prefetch" href="/noteSite/assets/js/100.381478df.js"><link rel="prefetch" href="/noteSite/assets/js/101.296e22b0.js"><link rel="prefetch" href="/noteSite/assets/js/102.b80519f7.js"><link rel="prefetch" href="/noteSite/assets/js/103.c9976fc1.js"><link rel="prefetch" href="/noteSite/assets/js/104.c3f73c81.js"><link rel="prefetch" href="/noteSite/assets/js/105.89d667c7.js"><link rel="prefetch" href="/noteSite/assets/js/106.f0d47092.js"><link rel="prefetch" href="/noteSite/assets/js/107.857af4ee.js"><link rel="prefetch" href="/noteSite/assets/js/108.7dc7e436.js"><link rel="prefetch" href="/noteSite/assets/js/109.af3311b5.js"><link rel="prefetch" href="/noteSite/assets/js/11.0b552745.js"><link rel="prefetch" href="/noteSite/assets/js/110.b7fca47c.js"><link rel="prefetch" href="/noteSite/assets/js/111.7bafaa88.js"><link rel="prefetch" href="/noteSite/assets/js/112.126f7524.js"><link rel="prefetch" href="/noteSite/assets/js/113.59996fac.js"><link rel="prefetch" href="/noteSite/assets/js/114.cd45d7b5.js"><link rel="prefetch" href="/noteSite/assets/js/115.5b432c26.js"><link rel="prefetch" href="/noteSite/assets/js/116.1b4052ca.js"><link rel="prefetch" href="/noteSite/assets/js/117.88334a1c.js"><link rel="prefetch" href="/noteSite/assets/js/118.8627267a.js"><link rel="prefetch" href="/noteSite/assets/js/119.2d1d7d55.js"><link rel="prefetch" href="/noteSite/assets/js/12.92824130.js"><link rel="prefetch" href="/noteSite/assets/js/120.b8755048.js"><link rel="prefetch" href="/noteSite/assets/js/121.957ecc9e.js"><link rel="prefetch" href="/noteSite/assets/js/122.981e643e.js"><link rel="prefetch" href="/noteSite/assets/js/123.08250b9f.js"><link rel="prefetch" href="/noteSite/assets/js/124.32c256b1.js"><link rel="prefetch" href="/noteSite/assets/js/125.241e4f3f.js"><link rel="prefetch" href="/noteSite/assets/js/126.2f526815.js"><link rel="prefetch" href="/noteSite/assets/js/127.a19a7f9f.js"><link rel="prefetch" href="/noteSite/assets/js/128.07fb9c33.js"><link rel="prefetch" href="/noteSite/assets/js/129.dd08437a.js"><link rel="prefetch" href="/noteSite/assets/js/13.731a2625.js"><link rel="prefetch" href="/noteSite/assets/js/130.046d9861.js"><link rel="prefetch" href="/noteSite/assets/js/131.4103f0c4.js"><link rel="prefetch" href="/noteSite/assets/js/132.960b15ca.js"><link rel="prefetch" href="/noteSite/assets/js/133.60a0dd98.js"><link rel="prefetch" href="/noteSite/assets/js/134.71a41cd9.js"><link rel="prefetch" href="/noteSite/assets/js/135.501918b7.js"><link rel="prefetch" href="/noteSite/assets/js/136.11ae598f.js"><link rel="prefetch" href="/noteSite/assets/js/137.8e3f6180.js"><link rel="prefetch" href="/noteSite/assets/js/138.961f41f0.js"><link rel="prefetch" href="/noteSite/assets/js/139.60ec7cad.js"><link rel="prefetch" href="/noteSite/assets/js/14.07f62b45.js"><link rel="prefetch" href="/noteSite/assets/js/140.70427ddd.js"><link rel="prefetch" href="/noteSite/assets/js/141.b086b14b.js"><link rel="prefetch" href="/noteSite/assets/js/142.e428eb27.js"><link rel="prefetch" href="/noteSite/assets/js/143.749a745f.js"><link rel="prefetch" href="/noteSite/assets/js/144.c4e50ac5.js"><link rel="prefetch" href="/noteSite/assets/js/145.146e3a4e.js"><link rel="prefetch" href="/noteSite/assets/js/146.8cf0b58f.js"><link rel="prefetch" href="/noteSite/assets/js/147.ded2faff.js"><link rel="prefetch" href="/noteSite/assets/js/148.a28ce1ad.js"><link rel="prefetch" href="/noteSite/assets/js/149.cdab9324.js"><link rel="prefetch" href="/noteSite/assets/js/15.2b6ee04e.js"><link rel="prefetch" href="/noteSite/assets/js/150.a4800bce.js"><link rel="prefetch" href="/noteSite/assets/js/151.740bc27a.js"><link rel="prefetch" href="/noteSite/assets/js/152.4c0fe466.js"><link rel="prefetch" href="/noteSite/assets/js/153.bcb00775.js"><link rel="prefetch" href="/noteSite/assets/js/154.2ae41c33.js"><link rel="prefetch" href="/noteSite/assets/js/155.85d5ab68.js"><link rel="prefetch" href="/noteSite/assets/js/156.d152595b.js"><link rel="prefetch" href="/noteSite/assets/js/157.a4aed1be.js"><link rel="prefetch" href="/noteSite/assets/js/158.a0aaf802.js"><link rel="prefetch" href="/noteSite/assets/js/159.14b91df7.js"><link rel="prefetch" href="/noteSite/assets/js/16.48cf37d9.js"><link rel="prefetch" href="/noteSite/assets/js/160.9703f5f0.js"><link rel="prefetch" href="/noteSite/assets/js/161.1ca9e492.js"><link rel="prefetch" href="/noteSite/assets/js/162.5fdf7943.js"><link rel="prefetch" href="/noteSite/assets/js/163.00faf4b5.js"><link rel="prefetch" href="/noteSite/assets/js/164.ff2867ab.js"><link rel="prefetch" href="/noteSite/assets/js/165.d5c0c459.js"><link rel="prefetch" href="/noteSite/assets/js/166.fc4f6929.js"><link rel="prefetch" href="/noteSite/assets/js/167.ff3783c8.js"><link rel="prefetch" href="/noteSite/assets/js/168.f2de6b6f.js"><link rel="prefetch" href="/noteSite/assets/js/169.edb622e6.js"><link rel="prefetch" href="/noteSite/assets/js/17.e1f8763b.js"><link rel="prefetch" href="/noteSite/assets/js/170.5e833839.js"><link rel="prefetch" href="/noteSite/assets/js/171.fc61b734.js"><link rel="prefetch" href="/noteSite/assets/js/172.0e51da0b.js"><link rel="prefetch" href="/noteSite/assets/js/173.5dc1c3df.js"><link rel="prefetch" href="/noteSite/assets/js/174.ca7c2ab0.js"><link rel="prefetch" href="/noteSite/assets/js/175.fa39764a.js"><link rel="prefetch" href="/noteSite/assets/js/176.d4faefc6.js"><link rel="prefetch" href="/noteSite/assets/js/177.e7e39729.js"><link rel="prefetch" href="/noteSite/assets/js/178.f04b0a83.js"><link rel="prefetch" href="/noteSite/assets/js/179.120ba233.js"><link rel="prefetch" href="/noteSite/assets/js/18.3181e6ae.js"><link rel="prefetch" href="/noteSite/assets/js/180.a798caae.js"><link rel="prefetch" href="/noteSite/assets/js/181.3f38bf72.js"><link rel="prefetch" href="/noteSite/assets/js/182.62c329f3.js"><link rel="prefetch" href="/noteSite/assets/js/183.6c5cd25b.js"><link rel="prefetch" href="/noteSite/assets/js/184.3e10b8bf.js"><link rel="prefetch" href="/noteSite/assets/js/185.7c389fb9.js"><link rel="prefetch" href="/noteSite/assets/js/186.59010cc2.js"><link rel="prefetch" href="/noteSite/assets/js/187.ddac4785.js"><link rel="prefetch" href="/noteSite/assets/js/188.e9848efe.js"><link rel="prefetch" href="/noteSite/assets/js/189.01b2de3b.js"><link rel="prefetch" href="/noteSite/assets/js/19.7e79d0e6.js"><link rel="prefetch" href="/noteSite/assets/js/190.da864df1.js"><link rel="prefetch" href="/noteSite/assets/js/191.834cec37.js"><link rel="prefetch" href="/noteSite/assets/js/192.dc90baf5.js"><link rel="prefetch" href="/noteSite/assets/js/193.e1edaa2d.js"><link rel="prefetch" href="/noteSite/assets/js/194.e985b57c.js"><link rel="prefetch" href="/noteSite/assets/js/195.c8a94758.js"><link rel="prefetch" href="/noteSite/assets/js/196.77981f92.js"><link rel="prefetch" href="/noteSite/assets/js/197.0951bddf.js"><link rel="prefetch" href="/noteSite/assets/js/198.02554e7c.js"><link rel="prefetch" href="/noteSite/assets/js/199.d9e3da64.js"><link rel="prefetch" href="/noteSite/assets/js/20.172f3ffd.js"><link rel="prefetch" href="/noteSite/assets/js/200.d55fc0dc.js"><link rel="prefetch" href="/noteSite/assets/js/201.2a024706.js"><link rel="prefetch" href="/noteSite/assets/js/202.7c3e5870.js"><link rel="prefetch" href="/noteSite/assets/js/203.d6733306.js"><link rel="prefetch" href="/noteSite/assets/js/204.f7c24528.js"><link rel="prefetch" href="/noteSite/assets/js/205.8894123b.js"><link rel="prefetch" href="/noteSite/assets/js/206.25aae204.js"><link rel="prefetch" href="/noteSite/assets/js/207.e690a080.js"><link rel="prefetch" href="/noteSite/assets/js/208.5a54cd6c.js"><link rel="prefetch" href="/noteSite/assets/js/209.34b8f2cc.js"><link rel="prefetch" href="/noteSite/assets/js/21.1f300626.js"><link rel="prefetch" href="/noteSite/assets/js/210.06065876.js"><link rel="prefetch" href="/noteSite/assets/js/211.a766b9ba.js"><link rel="prefetch" href="/noteSite/assets/js/212.85f3e643.js"><link rel="prefetch" href="/noteSite/assets/js/213.dbdabbd8.js"><link rel="prefetch" href="/noteSite/assets/js/214.af224615.js"><link rel="prefetch" href="/noteSite/assets/js/215.c7108942.js"><link rel="prefetch" href="/noteSite/assets/js/216.8988f475.js"><link rel="prefetch" href="/noteSite/assets/js/217.91c55937.js"><link rel="prefetch" href="/noteSite/assets/js/218.3898a2c1.js"><link rel="prefetch" href="/noteSite/assets/js/219.74de8300.js"><link rel="prefetch" href="/noteSite/assets/js/22.e83e32c9.js"><link rel="prefetch" href="/noteSite/assets/js/220.31f8aa70.js"><link rel="prefetch" href="/noteSite/assets/js/221.184baf54.js"><link rel="prefetch" href="/noteSite/assets/js/222.a0b05b9b.js"><link rel="prefetch" href="/noteSite/assets/js/223.7df8d229.js"><link rel="prefetch" href="/noteSite/assets/js/224.14b40202.js"><link rel="prefetch" href="/noteSite/assets/js/225.3ebfcb73.js"><link rel="prefetch" href="/noteSite/assets/js/226.8bb9cb93.js"><link rel="prefetch" href="/noteSite/assets/js/227.32bcf90d.js"><link rel="prefetch" href="/noteSite/assets/js/228.711e2c0c.js"><link rel="prefetch" href="/noteSite/assets/js/229.05c05744.js"><link rel="prefetch" href="/noteSite/assets/js/23.137ee52c.js"><link rel="prefetch" href="/noteSite/assets/js/230.64068b87.js"><link rel="prefetch" href="/noteSite/assets/js/231.a0ab2ef4.js"><link rel="prefetch" href="/noteSite/assets/js/232.86188408.js"><link rel="prefetch" href="/noteSite/assets/js/233.e981e91e.js"><link rel="prefetch" href="/noteSite/assets/js/234.158482e7.js"><link rel="prefetch" href="/noteSite/assets/js/235.1bfd8655.js"><link rel="prefetch" href="/noteSite/assets/js/24.1640db4c.js"><link rel="prefetch" href="/noteSite/assets/js/25.26f30d29.js"><link rel="prefetch" href="/noteSite/assets/js/26.8716506f.js"><link rel="prefetch" href="/noteSite/assets/js/27.8db1b159.js"><link rel="prefetch" href="/noteSite/assets/js/28.eacfb905.js"><link rel="prefetch" href="/noteSite/assets/js/29.1ed73b83.js"><link rel="prefetch" href="/noteSite/assets/js/3.30263573.js"><link rel="prefetch" href="/noteSite/assets/js/30.ae33dbbc.js"><link rel="prefetch" href="/noteSite/assets/js/31.ed9854a4.js"><link rel="prefetch" href="/noteSite/assets/js/32.c7a01519.js"><link rel="prefetch" href="/noteSite/assets/js/33.f350693e.js"><link rel="prefetch" href="/noteSite/assets/js/34.69de4dbc.js"><link rel="prefetch" href="/noteSite/assets/js/35.cf613b59.js"><link rel="prefetch" href="/noteSite/assets/js/36.1ebb4fb2.js"><link rel="prefetch" href="/noteSite/assets/js/37.5d73cf22.js"><link rel="prefetch" href="/noteSite/assets/js/38.9c61b9cf.js"><link rel="prefetch" href="/noteSite/assets/js/39.108b5718.js"><link rel="prefetch" href="/noteSite/assets/js/4.00d489fc.js"><link rel="prefetch" href="/noteSite/assets/js/41.4e7b3df4.js"><link rel="prefetch" href="/noteSite/assets/js/42.dabffa73.js"><link rel="prefetch" href="/noteSite/assets/js/43.7b36cf3d.js"><link rel="prefetch" href="/noteSite/assets/js/44.58f00f2f.js"><link rel="prefetch" href="/noteSite/assets/js/45.935308ca.js"><link rel="prefetch" href="/noteSite/assets/js/46.b0948b5f.js"><link rel="prefetch" href="/noteSite/assets/js/47.92ac732b.js"><link rel="prefetch" href="/noteSite/assets/js/48.916035a5.js"><link rel="prefetch" href="/noteSite/assets/js/49.de78c762.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.8e7c3081.js"><link rel="prefetch" href="/noteSite/assets/js/51.57c66660.js"><link rel="prefetch" href="/noteSite/assets/js/52.5b259dd4.js"><link rel="prefetch" href="/noteSite/assets/js/53.77326f9a.js"><link rel="prefetch" href="/noteSite/assets/js/54.f2910c2c.js"><link rel="prefetch" href="/noteSite/assets/js/55.3d8d2e0b.js"><link rel="prefetch" href="/noteSite/assets/js/56.341dcf38.js"><link rel="prefetch" href="/noteSite/assets/js/57.a4d8263d.js"><link rel="prefetch" href="/noteSite/assets/js/58.1b0b678d.js"><link rel="prefetch" href="/noteSite/assets/js/59.94459143.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.562d3896.js"><link rel="prefetch" href="/noteSite/assets/js/61.e0c3fa14.js"><link rel="prefetch" href="/noteSite/assets/js/62.65170864.js"><link rel="prefetch" href="/noteSite/assets/js/63.28f20b60.js"><link rel="prefetch" href="/noteSite/assets/js/64.d658bb65.js"><link rel="prefetch" href="/noteSite/assets/js/65.0c427bde.js"><link rel="prefetch" href="/noteSite/assets/js/66.56c8df85.js"><link rel="prefetch" href="/noteSite/assets/js/67.f4a4bdf2.js"><link rel="prefetch" href="/noteSite/assets/js/68.ac83ea15.js"><link rel="prefetch" href="/noteSite/assets/js/69.a799e614.js"><link rel="prefetch" href="/noteSite/assets/js/7.b387e7c6.js"><link rel="prefetch" href="/noteSite/assets/js/70.0f6f15a2.js"><link rel="prefetch" href="/noteSite/assets/js/71.3d2322ea.js"><link rel="prefetch" href="/noteSite/assets/js/72.30db9f04.js"><link rel="prefetch" href="/noteSite/assets/js/73.89369e64.js"><link rel="prefetch" href="/noteSite/assets/js/74.f179238d.js"><link rel="prefetch" href="/noteSite/assets/js/75.4215c6ce.js"><link rel="prefetch" href="/noteSite/assets/js/76.910428b7.js"><link rel="prefetch" href="/noteSite/assets/js/77.e6d6cca9.js"><link rel="prefetch" href="/noteSite/assets/js/78.08e11fce.js"><link rel="prefetch" href="/noteSite/assets/js/79.5185b7f6.js"><link rel="prefetch" href="/noteSite/assets/js/8.8201f3a6.js"><link rel="prefetch" href="/noteSite/assets/js/80.2d282bfd.js"><link rel="prefetch" href="/noteSite/assets/js/81.3899a335.js"><link rel="prefetch" href="/noteSite/assets/js/82.024730c4.js"><link rel="prefetch" href="/noteSite/assets/js/83.f5f8470a.js"><link rel="prefetch" href="/noteSite/assets/js/84.2261a5fd.js"><link rel="prefetch" href="/noteSite/assets/js/85.8403bb13.js"><link rel="prefetch" href="/noteSite/assets/js/86.b1e7228c.js"><link rel="prefetch" href="/noteSite/assets/js/87.8f50aa47.js"><link rel="prefetch" href="/noteSite/assets/js/88.476f01dc.js"><link rel="prefetch" href="/noteSite/assets/js/89.57dd462f.js"><link rel="prefetch" href="/noteSite/assets/js/9.605a57b3.js"><link rel="prefetch" href="/noteSite/assets/js/90.dc9a6751.js"><link rel="prefetch" href="/noteSite/assets/js/91.613b635d.js"><link rel="prefetch" href="/noteSite/assets/js/92.13fef2df.js"><link rel="prefetch" href="/noteSite/assets/js/93.e2d51c42.js"><link rel="prefetch" href="/noteSite/assets/js/94.05199e63.js"><link rel="prefetch" href="/noteSite/assets/js/95.7e83d6c7.js"><link rel="prefetch" href="/noteSite/assets/js/96.a59fa371.js"><link rel="prefetch" href="/noteSite/assets/js/97.27b67dd5.js"><link rel="prefetch" href="/noteSite/assets/js/98.c07a1068.js"><link rel="prefetch" href="/noteSite/assets/js/99.1a601bb3.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.2fd33669.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>入门</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>底层</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/golang/03-advance/01-为什么要使用Go.html" class="sidebar-link">1. 为什么要使用 Go 语言？</a></li><li><a href="/noteSite/backend/golang/03-advance/02-什么是Runtime.html" class="sidebar-link">2. 何为 Runtime？</a></li><li><a href="/noteSite/backend/golang/03-advance/03-Go是面向对象吗.html" class="sidebar-link">3. Go 是面向对象吗？</a></li><li><a href="/noteSite/backend/golang/03-advance/04-Go程序是如何编译的.html" class="sidebar-link">4. Go 程序是如何编译的？</a></li><li><a href="/noteSite/backend/golang/03-advance/05-Go程序是如何启动的.html" class="sidebar-link">5. Go 程序是如何启动起来的？</a></li><li><a href="/noteSite/backend/golang/03-advance/06-大小为0字节的变量.html" class="sidebar-link">6. 大小为 0 字节的变量</a></li><li><a href="/noteSite/backend/golang/03-advance/07-string.html" class="sidebar-link">7. string</a></li><li><a href="/noteSite/backend/golang/03-advance/08-slice.html" class="sidebar-link">8. slice</a></li><li><a href="/noteSite/backend/golang/03-advance/09-map.html" class="sidebar-link">9. map</a></li><li><a href="/noteSite/backend/golang/03-advance/10-interface.html" class="sidebar-link">10. interface</a></li><li><a href="/noteSite/backend/golang/03-advance/11-内存对齐.html" class="sidebar-link">11. 内存对齐</a></li><li><a href="/noteSite/backend/golang/03-advance/12-goroutine.html" aria-current="page" class="active sidebar-link">12. Goroutine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-1-底层" class="sidebar-link">12.1 底层</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-执行" class="sidebar-link">12.2 执行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-1-单线程循环-go-0-x" class="sidebar-link">12.2.1 单线程循环（Go 0.x）</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-2-2-多线程循环-go-1-0" class="sidebar-link">12.2.2 多线程循环（Go 1.0）</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-gmp" class="sidebar-link">12.3 GMP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-1-p-的底层" class="sidebar-link">12.3.1 P 的底层</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-2-概述" class="sidebar-link">12.3.2 概述</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-3-源码-go1-16" class="sidebar-link">12.3.3 源码（Go1.16）</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-4-新建协程" class="sidebar-link">12.3.4 新建协程</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-3-5-总原理图" class="sidebar-link">12.3.5 总原理图</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-并发" class="sidebar-link">12.4 并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-1-协程饥饿" class="sidebar-link">12.4.1 协程饥饿</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-2-触发切换" class="sidebar-link">12.4.2 触发切换</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-3-切换时机" class="sidebar-link">12.4.3 切换时机</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-弊端" class="sidebar-link">12.4 弊端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-1-问题" class="sidebar-link">12.4.1 问题</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/12-goroutine.html#_12-4-2-解决" class="sidebar-link">12.4.2 解决</a></li></ul></li></ul></li><li><a href="/noteSite/backend/golang/03-advance/13-锁.html" class="sidebar-link">13. 锁</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_12-goroutine"><a href="#_12-goroutine" class="header-anchor">#</a> 12. Goroutine</h1> <h2 id="_12-1-底层"><a href="#_12-1-底层" class="header-anchor">#</a> 12.1 底层</h2> <ul><li><p>协程的本质是 <code>runtime/runtime2.go</code> 中的 <code>g</code> 结构体：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> g <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	stack       stack   	<span class="token comment">// 当前协程的协程栈</span>
	sched        gobuf		<span class="token comment">// 保存协程运行现场</span>
	atomicstatus <span class="token builtin">uint32</span>		<span class="token comment">// 协程状态</span>
	goid         <span class="token builtin">int64</span>		<span class="token comment">// 协程 ID</span>
  m            <span class="token operator">*</span>m 			<span class="token comment">// 当前线程</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h569pjiiosj21cu0u040p.jpg" alt="image-20220814141535906"></p></li> <li><p>线程在 Go 中对应是的 <code>runtime/runtime2.go</code> 中的 <code>m</code> 结构体：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> m <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	g0      <span class="token operator">*</span>g     					<span class="token comment">// g0 协程，Go 中的主协程</span>
	curg          <span class="token operator">*</span>g       	<span class="token comment">// 现在正在运行的协程</span>
	id            <span class="token builtin">int64</span>		 	<span class="token comment">// 线程ID</span>
	mOS											<span class="token comment">// 当前操作系统对线程的额外描述信息</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="_12-2-执行"><a href="#_12-2-执行" class="header-anchor">#</a> 12.2 执行</h2> <h3 id="_12-2-1-单线程循环-go-0-x"><a href="#_12-2-1-单线程循环-go-0-x" class="header-anchor">#</a> 12.2.1 单线程循环（Go 0.x）</h3> <p><strong>总结图：</strong></p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57qxoptk4j21hm0simyy.jpg" alt="image-20220815205709047"></p> <p><strong>底层源码：</strong></p> <ul><li><p><code>runtime/proc.go</code> 中的 <code>schedule()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// schedule 寻找可以可以运行的协程并执行它</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获得当前运行的协程</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token comment">// 永远不调度正在调用 cgo 的协程，因为它要用到 g0 栈</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>incgo <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: in cgo&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
	<span class="token operator">...</span>
  <span class="token comment">// 2. 即将要调用的协程</span>
	<span class="token keyword">var</span> gp <span class="token operator">*</span>g
	<span class="token comment">// 3. 想办法在本地队列和全局队列中拿到一个可以运行的协程</span>
  <span class="token operator">...</span>
  <span class="token comment">// 4. 调用 execute()</span>
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 中的 <code>execute()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// execute 让 gp 运行在当前线程上</span>
<span class="token keyword">func</span> <span class="token function">execute</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 1. 将当前协程 _g_ 的线程信息复制到即将要调用的协程 gp</span>
	_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">=</span> gp
	gp<span class="token punctuation">.</span>m <span class="token operator">=</span> _g_<span class="token punctuation">.</span>m
	<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>waitsince <span class="token operator">=</span> <span class="token number">0</span>
	gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>
	gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> gp<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>lo <span class="token operator">+</span> _StackGuard
	<span class="token operator">...</span>
	
  <span class="token comment">// 2. 调用 gogo()</span>
	<span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>gogo()</code>  是用汇编写的</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// func gogo(buf *gobuf)</span>
<span class="token comment">// 往 g stack 插入一个 goexit() 栈帧并跳到程序计数器的位置，去执行业务方法</span>
TEXT runtime·<span class="token function">gogo</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> NOSPLIT<span class="token punctuation">,</span> $<span class="token number">16</span><span class="token operator">-</span><span class="token number">8</span>
	MOVQ	buf<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> BX		
	MOVQ	<span class="token function">gobuf_g</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVQ	<span class="token function">0</span><span class="token punctuation">(</span>DX<span class="token punctuation">)</span><span class="token punctuation">,</span> CX		
	<span class="token function">get_tls</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>								<span class="token comment">// 使用 gobuf 拿到 g stack</span>
	MOVQ	DX<span class="token punctuation">,</span> <span class="token function">g</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>						
	MOVQ	<span class="token function">gobuf_sp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> SP		<span class="token comment">// 往 g stack 中插入一个 goexit 的栈帧</span>
	MOVQ	<span class="token function">gobuf_ret</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
	MOVQ	<span class="token function">gobuf_ctxt</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVQ	<span class="token function">gobuf_bp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> BP
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_sp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>	
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_ret</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_ctxt</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">gobuf_bp</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span>
	MOVQ	<span class="token function">gobuf_pc</span><span class="token punctuation">(</span>BX<span class="token punctuation">)</span><span class="token punctuation">,</span> BX		<span class="token comment">// 跳转到现在协程的程序计数器的位置</span>
	JMP	BX
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>goexit()</code> 也是用汇编写的</p> <div class="language-go extra-class"><pre class="language-go"><code>TEXT runtime·<span class="token function">goexit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>
	BYTE	$<span class="token number">0x90</span>	
	CALL	runtime·<span class="token function">goexit1</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>	<span class="token comment">// 实际是调用了 runtime.goexit1()</span>
	BYTE	$<span class="token number">0x90</span>	
</code></pre></div></li> <li><p><code>runtime/proc.g</code> 中的 <code>goexit1()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 退出当前协程</span>
<span class="token keyword">func</span> <span class="token function">goexit1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>
		<span class="token function">racegoend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
		<span class="token function">traceGoEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 跳转到 g0 stack 然后调用 goexit0 方法</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>goexit0<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/stubs.go</code> 中的 <code>goexit0()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// goexit0 重置当前协程 gp，</span>
<span class="token keyword">func</span> <span class="token function">goexit0</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 重置 gp 的一些信息</span>
  <span class="token comment">// 2. 丢掉 gp</span>
	<span class="token function">dropg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
  <span class="token comment">// 3. 重新调度协程执行</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <p><strong>抽象图：</strong></p> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57s0gq51ej20q409oq38.jpg" alt="image-20220815213427093" style="zoom:50%;"> <h3 id="_12-2-2-多线程循环-go-1-0"><a href="#_12-2-2-多线程循环-go-1-0" class="header-anchor">#</a> 12.2.2 多线程循环（Go 1.0）</h3> <ul><li>在操作系统层面还是线程在运行，对 Goroutine 无感知；</li> <li>操作系统线程执行一个协程调度，顺序执行 Goroutine；</li> <li>调度循环非常像 <strong>线程池</strong>；</li> <li>就目前（Go1.0）的模型，有多少线程，就最多有多少并发，且会抢夺协程队列的全局锁；</li> <li></li></ul> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57s3zsrgoj21bg0tu0un.jpg" alt="image-20220815213750855"></p> <h2 id="_12-3-gmp"><a href="#_12-3-gmp" class="header-anchor">#</a> 12.3 GMP</h2> <h3 id="_12-3-1-p-的底层"><a href="#_12-3-1-p-的底层" class="header-anchor">#</a> 12.3.1 P 的底层</h3> <p>P 即处理器，用来将 G 送到 M 上去执行。它维持了一个本地队列，这样每次获取 G 不一定都要去全局队列拿，大大减少了并发冲突的情况。</p> <p>它的本质是 <code>runtime/runtime2.go</code> 中的 <code>p</code> 结构体</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	m           muintptr   <span class="token comment">// 当前负责的线程</span>
	<span class="token comment">// 可运行的协程的队列，可无锁访问</span>
	runqhead <span class="token builtin">uint32</span>					 <span class="token comment">// 队头</span>
	runqtail <span class="token builtin">uint32</span>					 <span class="token comment">// 队尾</span>
	runq     <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span>guintptr   <span class="token comment">// 长度为 256</span>
	runnext guintptr				 <span class="token comment">// 下一个可用的协程的指针</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57sl36b40j20o40u8js7.jpg" alt="image-20220815215416942" style="zoom:50%;"> <h3 id="_12-3-2-概述"><a href="#_12-3-2-概述" class="header-anchor">#</a> 12.3.2 概述</h3> <ul><li>GMP 模型即每个 P 维护一个本地队列 runq，一般情况下，P 负责在 runq 上挑选 G 送到 M 上去运行，当 runq 上没有 G，就抢占锁去全局队列 globalq 上寻找 G。</li></ul> <h3 id="_12-3-3-源码-go1-16"><a href="#_12-3-3-源码-go1-16" class="header-anchor">#</a> 12.3.3 源码（Go1.16）</h3> <ul><li><p>再来看 <code>runtime/proc.go</code> 中的 <code>schedule()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// schedule 寻找可以可以运行的协程并执行它</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获得当前运行的协程</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token comment">// 永远不调度正在调用 cgo 的协程，因为它要用到 g0 栈</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>incgo <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: in cgo&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
	<span class="token operator">...</span>
  <span class="token comment">// 2. 即将要调用的协程</span>
	<span class="token keyword">var</span> gp <span class="token operator">*</span>g
	<span class="token comment">// 3. 想办法在本地队列和全局队列中拿到一个可以运行的协程</span>
  <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// 3.1 在本地队列中寻找 G</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
  <span class="token comment">// 4. 调用 execute()</span>
	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 中的 <code>runqget()</code></p></li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runqget 从本地队列中获取 g</span>
<span class="token keyword">func</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 先找 p 中的 runnext，有就直接拿去执行</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		next <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>runnext
		<span class="token keyword">if</span> next <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> _p_<span class="token punctuation">.</span>runnext<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>next<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>findrunnable()</code> 就是先在全局队列中找，还找不到，就去别的 P 下的队列偷一半来，分为 <code>globrunqget()</code> 和 <code>runqsteal()</code></p></li> <li><p><code>runtime/proc.go</code> 的 <code>globrunqget()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 从全局队列中获取 G</span>
<span class="token comment">// 上锁</span>
<span class="token keyword">func</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">,</span> max <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/proc.go</code> 的 <code>runqsteal()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 从 p2 中偷一半的 G 给 _p_ 执行</span>
<span class="token keyword">func</span> <span class="token function">runqsteal</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> p2 <span class="token operator">*</span>p<span class="token punctuation">,</span> stealRunNextG <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>g <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="_12-3-4-新建协程"><a href="#_12-3-4-新建协程" class="header-anchor">#</a> 12.3.4 新建协程</h3> <ul><li>新建协程的时候，会随机放到一个本地队列中；</li> <li>如果本地队列都满了的话，才会放在全局队列；</li> <li>Go 会优先执行新建的协程；</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// newproc 新建一个协程</span>
<span class="token keyword">func</span> <span class="token function">newproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	argp <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先建 g 结构体值</span>
		newg <span class="token operator">:=</span> <span class="token function">newproc1</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> argp<span class="token punctuation">,</span> siz<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> pc<span class="token punctuation">)</span>

		_p_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 将 g 放到队列中</span>
		<span class="token function">runqput</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> newg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> mainStarted <span class="token punctuation">{</span>
			<span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 将 g 放到队列中</span>
<span class="token keyword">func</span> <span class="token function">runqput</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">,</span> gp <span class="token operator">*</span>g<span class="token punctuation">,</span> next <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token operator">...</span>
  <span class="token comment">// 1. 先看看能不能放到本地队列</span>
	h <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadAcq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>runqhead<span class="token punctuation">)</span> <span class="token comment">// load-acquire, synchronize with consumers</span>
	t <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>runqtail
	<span class="token keyword">if</span> t<span class="token operator">-</span>h <span class="token operator">&lt;</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>runq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		_p_<span class="token punctuation">.</span>runq<span class="token punctuation">[</span>t<span class="token operator">%</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>runq<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
		atomic<span class="token punctuation">.</span><span class="token function">StoreRel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>runqtail<span class="token punctuation">,</span> t<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// store-release, makes the item available for consumption</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 2. 本地队列满了，就放全局队列</span>
	<span class="token keyword">if</span> <span class="token function">runqputslow</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> h<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_12-3-5-总原理图"><a href="#_12-3-5-总原理图" class="header-anchor">#</a> 12.3.5 总原理图</h3> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57sa0idr0j20w60u0did.jpg" alt="img" style="zoom:50%;"> <table><thead><tr><th>代号</th> <th>名称</th> <th>定义位置</th> <th>作用</th></tr></thead> <tbody><tr><td>Sched</td> <td>调度器</td> <td>proc.c</td> <td>维护有存储 M 和 G 的队列以及调度器的一些状态信息等。</td></tr> <tr><td>M</td> <td>Machine 系统线程</td> <td>runtime.h</td> <td>它由操作系统管理的，Goroutine 就是跑在 M 之上的；M 是一个很大的结构，里面维护小对象内存 cache（mcache）、当前执行的 Goroutine、随机数发生器等等非常多的信息。</td></tr> <tr><td>P</td> <td>Processor 处理器</td> <td>runtime.h</td> <td>它的主要用途就是用来执行 Goroutine 的，它维护了一个 Goroutine 队列，即 runqueue。Processor 是让我们从 N:1 调度到 M:N 调度的重要部分。</td></tr> <tr><td>G</td> <td>Goroutine 实现的核心结构</td> <td>runtime.h</td> <td>它包含了栈，指令指针，以及其他对调度 Goroutine 很重要的信息，例如其阻塞的 channel。</td></tr></tbody></table> <h2 id="_12-4-并发"><a href="#_12-4-并发" class="header-anchor">#</a> 12.4 并发</h2> <h3 id="_12-4-1-协程饥饿"><a href="#_12-4-1-协程饥饿" class="header-anchor">#</a> 12.4.1 协程饥饿</h3> <ul><li>当有的协程执行时间过长，导致占用线程过久，其他协程得不到运行的机会，就出现了协程饥饿问题。</li></ul> <h3 id="_12-4-2-触发切换"><a href="#_12-4-2-触发切换" class="header-anchor">#</a> 12.4.2 触发切换</h3> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vi6wrdqj21ho0sqjtn.jpg" alt="image-20220815233517856"></p> <ul><li>全局队列协程饥饿问题：线程每循环 61 次，便会从全局队列中挑一个 G 去执行。</li></ul> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 每循环 61 次，便会从全局队列中挑一个 G 去执行</span>
		<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">%</span><span class="token number">61</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			gp <span class="token operator">=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_12-4-3-切换时机"><a href="#_12-4-3-切换时机" class="header-anchor">#</a> 12.4.3 切换时机</h3> <div class="custom-block tip"><p class="custom-block-title">总结</p> <ul><li>基于协作的抢占式调度
<ul><li>主动挂起：<code>runtime.gopark()</code></li> <li>系统调用结束时：<code>exitsyscall()</code></li> <li>函数跳转时：<code>morestack()</code></li></ul></li> <li>基于信号的抢占式调度
<ul><li>信号调度：<code>doSigPreempt()</code></li></ul></li></ul></div> <ul><li><p>主动挂起：<code>runtime.gopark()</code></p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vq4flf5j21j20s4jto.jpg" alt="image-20220815234253697"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token comment">// 挂起当前协程</span>
<span class="token keyword">func</span> <span class="token function">gopark</span><span class="token punctuation">(</span>unlockf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>g<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> lock unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> reason waitReason<span class="token punctuation">,</span> traceEv <span class="token builtin">byte</span><span class="token punctuation">,</span> traceskip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token comment">// 切换到 g0 stack，进行线程循环</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>park_m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>系统调用结束时：会执行 <code>exitsyscall()</code>，它里面会调用 <code>mcall()</code> 切换到 <code>g0 stack</code>。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57vx0tfayj21g60r4tb4.jpg" alt="image-20220815234932384"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token comment">// 系统调用完成时会调用 exitsyscall</span>
<span class="token keyword">func</span> <span class="token function">exitsyscall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// 切换到 g0 stack，进行线程循环</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>exitsyscall0<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>标记抢占：<code>morestack()</code></p> <p>当函数跳转时都会调用这个方法，它的本意在于检查当前协程栈空间是否有足够内存，如果不够就要扩大该栈空间。当系统监控到协程运行超过 <code>10ms</code>，就将 <code>g.stackguard0</code> 置为 <code>0xfffffade</code>（该值是一个抢占标志），让程序在只执行 <code>morestack()</code> 函数时顺便判断一下是否将 <code>g</code> 中的 <code>stackguard</code> 置为抢占 <code>preempt</code>，如果的确被标记抢占，就回到 <code>schedule()</code> 方法，并将当前协程放回队列中。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57w74gg19j21iq0smwgs.jpg" alt="image-20220815235915661"></p> <p><code>morestack()</code> 在需要创建更多栈空间的时候，会执行 <code>newstack()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/stack.go</span>
<span class="token comment">// newstack 创建新的栈空间</span>
<span class="token keyword">func</span> <span class="token function">newstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// 1. 判断 gp.stackguard0 是否被标记为抢占</span>
	preempt <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>stackguard0<span class="token punctuation">)</span> <span class="token operator">==</span> stackPreempt
	<span class="token operator">...</span>
  <span class="token comment">// 2. 如果被标记位抢占，调用 gogo()</span>
	<span class="token keyword">if</span> preempt <span class="token punctuation">{</span>
    <span class="token comment">// 3. 最终会去调用  schedule() 去调新的协程执行</span>
		<span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token comment">// never return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
		<span class="token function">traceGoPreempt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">goschedImpl</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">goschedImpl</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token comment">// 调用 schedule()</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>信号调度：<code>doSigPreempt()</code></p> <p>当程序在执行过程中既无法主动挂起，也不能进行系统调用，且无法进行函数调用时，就可以使用信号来调度。</p> <p>信号其实就是线程信号，在操作系统中有很多基于信号的底层通信方式（SIGPIPE / SIGURG / SIGHUP），而我们的线程可以注册对应信号的处理函数。</p> <p>Go 中是注册了 <code>SIGURG</code> 信号的处理函数 <code>doSigPreempt()</code>，在 GC 工作时，向目标线程发送信号。线程收到信号后，会触发调度。</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h57wecvgwdj21hk0ssgny.jpg" alt="image-20220816000612561"></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/signal_unix.go</span>

<span class="token comment">// doSigPreempt 处理 gp 上的抢占信号</span>
<span class="token keyword">func</span> <span class="token function">doSigPreempt</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> ctxt <span class="token operator">*</span>sigctxt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 检查此 g 是否要被抢占并且安全抢占;</span>
	<span class="token keyword">if</span> <span class="token function">wantAsyncPreempt</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ok<span class="token punctuation">,</span> newpc <span class="token operator">:=</span> <span class="token function">isAsyncSafePoint</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigsp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">siglr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token comment">// 2. 调整程序计数器 PC 并异步调用 asyncPreempt</span>
			ctxt<span class="token punctuation">.</span><span class="token function">pushCall</span><span class="token punctuation">(</span><span class="token function">funcPC</span><span class="token punctuation">(</span>asyncPreempt<span class="token punctuation">)</span><span class="token punctuation">,</span> newpc<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// runtime/preempt.go</span>

<span class="token comment">// asyncPreempt 保存所有用户寄存器并调用 asyncPreempt2</span>
<span class="token keyword">func</span> <span class="token function">asyncPreempt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">asyncPreempt2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 调用 mcall，跳转到 g0 stack，去执行 schedule()</span>
	<span class="token keyword">if</span> gp<span class="token punctuation">.</span>preemptStop <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>preemptPark<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>gopreempt_m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="_12-4-弊端"><a href="#_12-4-弊端" class="header-anchor">#</a> 12.4 弊端</h2> <h3 id="_12-4-1-问题"><a href="#_12-4-1-问题" class="header-anchor">#</a> 12.4.1 问题</h3> <p>协程太多会导致：</p> <ul><li>文件打开数限制；</li> <li>内存限制；</li> <li>调度开销过大；</li></ul> <h3 id="_12-4-2-解决"><a href="#_12-4-2-解决" class="header-anchor">#</a> 12.4.2 解决</h3> <ul><li><p>优化业务逻辑；（优先考虑）</p></li> <li><p>利用 channel 的缓冲区；</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">do</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> ch <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
  <span class="token operator">&lt;-</span>ch
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 限制 channel 缓冲区为 3000，最多支持 3000 协程并发</span>
  c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> math<span class="token punctuation">.</span>MaxInt32<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
    c <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token function">do</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>协程池；（一般不）</p></li> <li><p>调整系统资源；</p></li></ul> <p>​</p> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/16/2022, 12:18:14 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/golang/03-advance/11-内存对齐.html" class="prev">
        11. 内存对齐
      </a></span> <span class="next"><a href="/noteSite/backend/golang/03-advance/13-锁.html">
        13. 锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.cc1e379f.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/40.c3d6b0ec.js" defer></script>
  </body>
</html>
