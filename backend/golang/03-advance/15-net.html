<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>15. 网络编程 | Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.2b5d8ceb.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.bcda4898.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.6ff1f0ac.js" as="script"><link rel="preload" href="/noteSite/assets/js/47.3e3893e2.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.2457a131.js"><link rel="prefetch" href="/noteSite/assets/js/100.282037ec.js"><link rel="prefetch" href="/noteSite/assets/js/101.3ec8c27f.js"><link rel="prefetch" href="/noteSite/assets/js/102.dbaeb1b7.js"><link rel="prefetch" href="/noteSite/assets/js/103.ea3d0288.js"><link rel="prefetch" href="/noteSite/assets/js/104.5c8fedec.js"><link rel="prefetch" href="/noteSite/assets/js/105.721fdfb0.js"><link rel="prefetch" href="/noteSite/assets/js/106.29718338.js"><link rel="prefetch" href="/noteSite/assets/js/107.140f58aa.js"><link rel="prefetch" href="/noteSite/assets/js/108.23be13b5.js"><link rel="prefetch" href="/noteSite/assets/js/109.816344eb.js"><link rel="prefetch" href="/noteSite/assets/js/11.4fcb6d6b.js"><link rel="prefetch" href="/noteSite/assets/js/110.91c77482.js"><link rel="prefetch" href="/noteSite/assets/js/111.0773e203.js"><link rel="prefetch" href="/noteSite/assets/js/112.5f252bfb.js"><link rel="prefetch" href="/noteSite/assets/js/113.a10a72d6.js"><link rel="prefetch" href="/noteSite/assets/js/114.d7545a94.js"><link rel="prefetch" href="/noteSite/assets/js/115.d4223625.js"><link rel="prefetch" href="/noteSite/assets/js/116.1293de89.js"><link rel="prefetch" href="/noteSite/assets/js/117.f69650c9.js"><link rel="prefetch" href="/noteSite/assets/js/118.3ec9591b.js"><link rel="prefetch" href="/noteSite/assets/js/119.8db13744.js"><link rel="prefetch" href="/noteSite/assets/js/12.c90a7522.js"><link rel="prefetch" href="/noteSite/assets/js/120.9ca8204e.js"><link rel="prefetch" href="/noteSite/assets/js/121.a28bf4ed.js"><link rel="prefetch" href="/noteSite/assets/js/122.57452c9e.js"><link rel="prefetch" href="/noteSite/assets/js/123.4bbf359c.js"><link rel="prefetch" href="/noteSite/assets/js/124.e96b183f.js"><link rel="prefetch" href="/noteSite/assets/js/125.0c941fd1.js"><link rel="prefetch" href="/noteSite/assets/js/126.add326fd.js"><link rel="prefetch" href="/noteSite/assets/js/127.9882ace8.js"><link rel="prefetch" href="/noteSite/assets/js/128.3d3e6199.js"><link rel="prefetch" href="/noteSite/assets/js/129.b8330812.js"><link rel="prefetch" href="/noteSite/assets/js/13.be95d60f.js"><link rel="prefetch" href="/noteSite/assets/js/130.10d0158c.js"><link rel="prefetch" href="/noteSite/assets/js/131.77f1ff4d.js"><link rel="prefetch" href="/noteSite/assets/js/132.9e0b7543.js"><link rel="prefetch" href="/noteSite/assets/js/133.b0b449d1.js"><link rel="prefetch" href="/noteSite/assets/js/134.5b008722.js"><link rel="prefetch" href="/noteSite/assets/js/135.64122050.js"><link rel="prefetch" href="/noteSite/assets/js/136.11ecc747.js"><link rel="prefetch" href="/noteSite/assets/js/137.e00c1b9f.js"><link rel="prefetch" href="/noteSite/assets/js/138.87cbe079.js"><link rel="prefetch" href="/noteSite/assets/js/139.813d6a4f.js"><link rel="prefetch" href="/noteSite/assets/js/14.a91dc8fb.js"><link rel="prefetch" href="/noteSite/assets/js/140.179ab391.js"><link rel="prefetch" href="/noteSite/assets/js/141.332b3aef.js"><link rel="prefetch" href="/noteSite/assets/js/142.d9bb7a8d.js"><link rel="prefetch" href="/noteSite/assets/js/143.2315d524.js"><link rel="prefetch" href="/noteSite/assets/js/144.e8a6f5c9.js"><link rel="prefetch" href="/noteSite/assets/js/145.83e0596a.js"><link rel="prefetch" href="/noteSite/assets/js/146.59b8ec7f.js"><link rel="prefetch" href="/noteSite/assets/js/147.3233eb53.js"><link rel="prefetch" href="/noteSite/assets/js/148.e7b28083.js"><link rel="prefetch" href="/noteSite/assets/js/149.e7d1453a.js"><link rel="prefetch" href="/noteSite/assets/js/15.ace436c4.js"><link rel="prefetch" href="/noteSite/assets/js/150.144d8775.js"><link rel="prefetch" href="/noteSite/assets/js/151.3b8e2c5e.js"><link rel="prefetch" href="/noteSite/assets/js/152.0b3941f8.js"><link rel="prefetch" href="/noteSite/assets/js/153.69581b97.js"><link rel="prefetch" href="/noteSite/assets/js/154.1b1a32b2.js"><link rel="prefetch" href="/noteSite/assets/js/155.3d608b91.js"><link rel="prefetch" href="/noteSite/assets/js/156.6426d84c.js"><link rel="prefetch" href="/noteSite/assets/js/157.4d8f6aca.js"><link rel="prefetch" href="/noteSite/assets/js/158.66cadbe0.js"><link rel="prefetch" href="/noteSite/assets/js/159.cd20bcec.js"><link rel="prefetch" href="/noteSite/assets/js/16.ba5205e2.js"><link rel="prefetch" href="/noteSite/assets/js/160.fb1465a5.js"><link rel="prefetch" href="/noteSite/assets/js/161.10733159.js"><link rel="prefetch" href="/noteSite/assets/js/162.6215f2be.js"><link rel="prefetch" href="/noteSite/assets/js/163.a3e3c4cd.js"><link rel="prefetch" href="/noteSite/assets/js/164.f8d12cc1.js"><link rel="prefetch" href="/noteSite/assets/js/165.597ccef9.js"><link rel="prefetch" href="/noteSite/assets/js/166.f05205e5.js"><link rel="prefetch" href="/noteSite/assets/js/167.68a92314.js"><link rel="prefetch" href="/noteSite/assets/js/168.24e93983.js"><link rel="prefetch" href="/noteSite/assets/js/169.8207e533.js"><link rel="prefetch" href="/noteSite/assets/js/17.204dc718.js"><link rel="prefetch" href="/noteSite/assets/js/170.e8e69635.js"><link rel="prefetch" href="/noteSite/assets/js/171.81175a4a.js"><link rel="prefetch" href="/noteSite/assets/js/172.a4b39fe7.js"><link rel="prefetch" href="/noteSite/assets/js/173.9a73f4c4.js"><link rel="prefetch" href="/noteSite/assets/js/174.2121be31.js"><link rel="prefetch" href="/noteSite/assets/js/175.ddfde6e9.js"><link rel="prefetch" href="/noteSite/assets/js/176.8d9e38bf.js"><link rel="prefetch" href="/noteSite/assets/js/177.88aad887.js"><link rel="prefetch" href="/noteSite/assets/js/178.bc0a14d5.js"><link rel="prefetch" href="/noteSite/assets/js/179.ef9b049a.js"><link rel="prefetch" href="/noteSite/assets/js/18.b9adc259.js"><link rel="prefetch" href="/noteSite/assets/js/180.ebc68b15.js"><link rel="prefetch" href="/noteSite/assets/js/181.66e846fd.js"><link rel="prefetch" href="/noteSite/assets/js/182.5fb7062c.js"><link rel="prefetch" href="/noteSite/assets/js/183.202710af.js"><link rel="prefetch" href="/noteSite/assets/js/184.99a4476c.js"><link rel="prefetch" href="/noteSite/assets/js/185.68cc62f4.js"><link rel="prefetch" href="/noteSite/assets/js/186.25b7c434.js"><link rel="prefetch" href="/noteSite/assets/js/187.2ea958f6.js"><link rel="prefetch" href="/noteSite/assets/js/188.d886c6aa.js"><link rel="prefetch" href="/noteSite/assets/js/189.741c61a9.js"><link rel="prefetch" href="/noteSite/assets/js/19.811bf034.js"><link rel="prefetch" href="/noteSite/assets/js/190.d8b95ca2.js"><link rel="prefetch" href="/noteSite/assets/js/191.47d0ad44.js"><link rel="prefetch" href="/noteSite/assets/js/192.f305241b.js"><link rel="prefetch" href="/noteSite/assets/js/193.cd0ed807.js"><link rel="prefetch" href="/noteSite/assets/js/194.2d088087.js"><link rel="prefetch" href="/noteSite/assets/js/195.bb042bd0.js"><link rel="prefetch" href="/noteSite/assets/js/196.99a92d9a.js"><link rel="prefetch" href="/noteSite/assets/js/197.aafc2d63.js"><link rel="prefetch" href="/noteSite/assets/js/198.01d32971.js"><link rel="prefetch" href="/noteSite/assets/js/199.060f2286.js"><link rel="prefetch" href="/noteSite/assets/js/20.78824865.js"><link rel="prefetch" href="/noteSite/assets/js/200.d91720a5.js"><link rel="prefetch" href="/noteSite/assets/js/201.17c4e500.js"><link rel="prefetch" href="/noteSite/assets/js/202.fbcbd81a.js"><link rel="prefetch" href="/noteSite/assets/js/203.c3222d2d.js"><link rel="prefetch" href="/noteSite/assets/js/204.574441a0.js"><link rel="prefetch" href="/noteSite/assets/js/205.d841779b.js"><link rel="prefetch" href="/noteSite/assets/js/206.b18adf97.js"><link rel="prefetch" href="/noteSite/assets/js/207.8727d2f0.js"><link rel="prefetch" href="/noteSite/assets/js/208.39e1cfd5.js"><link rel="prefetch" href="/noteSite/assets/js/209.9b566472.js"><link rel="prefetch" href="/noteSite/assets/js/21.cea73218.js"><link rel="prefetch" href="/noteSite/assets/js/210.11558b76.js"><link rel="prefetch" href="/noteSite/assets/js/211.1583fc79.js"><link rel="prefetch" href="/noteSite/assets/js/212.a835c98a.js"><link rel="prefetch" href="/noteSite/assets/js/213.5ee1312e.js"><link rel="prefetch" href="/noteSite/assets/js/214.71ed8e9c.js"><link rel="prefetch" href="/noteSite/assets/js/215.03338399.js"><link rel="prefetch" href="/noteSite/assets/js/216.e79a9588.js"><link rel="prefetch" href="/noteSite/assets/js/217.cf474399.js"><link rel="prefetch" href="/noteSite/assets/js/218.eda994ff.js"><link rel="prefetch" href="/noteSite/assets/js/219.ff310079.js"><link rel="prefetch" href="/noteSite/assets/js/22.d6ead87c.js"><link rel="prefetch" href="/noteSite/assets/js/220.538d10ec.js"><link rel="prefetch" href="/noteSite/assets/js/221.2dc4c8de.js"><link rel="prefetch" href="/noteSite/assets/js/222.ab254ffa.js"><link rel="prefetch" href="/noteSite/assets/js/223.b7ba52d9.js"><link rel="prefetch" href="/noteSite/assets/js/224.f900eeec.js"><link rel="prefetch" href="/noteSite/assets/js/225.eb8df945.js"><link rel="prefetch" href="/noteSite/assets/js/226.29291757.js"><link rel="prefetch" href="/noteSite/assets/js/227.f0eb4286.js"><link rel="prefetch" href="/noteSite/assets/js/228.504a771e.js"><link rel="prefetch" href="/noteSite/assets/js/229.4bd536cc.js"><link rel="prefetch" href="/noteSite/assets/js/23.0ee0c5eb.js"><link rel="prefetch" href="/noteSite/assets/js/230.68d8fa8b.js"><link rel="prefetch" href="/noteSite/assets/js/231.faa352cf.js"><link rel="prefetch" href="/noteSite/assets/js/232.ecb44463.js"><link rel="prefetch" href="/noteSite/assets/js/233.3cabb969.js"><link rel="prefetch" href="/noteSite/assets/js/234.e152dbb8.js"><link rel="prefetch" href="/noteSite/assets/js/235.eac7e157.js"><link rel="prefetch" href="/noteSite/assets/js/236.7ef9f82f.js"><link rel="prefetch" href="/noteSite/assets/js/237.f8fad403.js"><link rel="prefetch" href="/noteSite/assets/js/238.40e33080.js"><link rel="prefetch" href="/noteSite/assets/js/239.5ffc02a0.js"><link rel="prefetch" href="/noteSite/assets/js/24.1a933e6c.js"><link rel="prefetch" href="/noteSite/assets/js/240.5b0ae508.js"><link rel="prefetch" href="/noteSite/assets/js/241.d5d87bca.js"><link rel="prefetch" href="/noteSite/assets/js/242.f603233d.js"><link rel="prefetch" href="/noteSite/assets/js/243.1b250ba3.js"><link rel="prefetch" href="/noteSite/assets/js/244.10054be5.js"><link rel="prefetch" href="/noteSite/assets/js/245.1cf9c4da.js"><link rel="prefetch" href="/noteSite/assets/js/246.ab9e933a.js"><link rel="prefetch" href="/noteSite/assets/js/247.df0bfa0f.js"><link rel="prefetch" href="/noteSite/assets/js/248.e71f0b52.js"><link rel="prefetch" href="/noteSite/assets/js/249.88114b20.js"><link rel="prefetch" href="/noteSite/assets/js/25.df04ad1a.js"><link rel="prefetch" href="/noteSite/assets/js/250.d3674244.js"><link rel="prefetch" href="/noteSite/assets/js/251.b647b420.js"><link rel="prefetch" href="/noteSite/assets/js/252.f722ccfd.js"><link rel="prefetch" href="/noteSite/assets/js/253.50b93301.js"><link rel="prefetch" href="/noteSite/assets/js/254.6e0024c9.js"><link rel="prefetch" href="/noteSite/assets/js/255.45b7a84e.js"><link rel="prefetch" href="/noteSite/assets/js/256.43a008e8.js"><link rel="prefetch" href="/noteSite/assets/js/257.36fa2928.js"><link rel="prefetch" href="/noteSite/assets/js/258.c9aa5226.js"><link rel="prefetch" href="/noteSite/assets/js/259.cf5f1e15.js"><link rel="prefetch" href="/noteSite/assets/js/26.4eb6fe37.js"><link rel="prefetch" href="/noteSite/assets/js/260.b0461665.js"><link rel="prefetch" href="/noteSite/assets/js/261.b8ac8008.js"><link rel="prefetch" href="/noteSite/assets/js/262.24d525c4.js"><link rel="prefetch" href="/noteSite/assets/js/263.86ed03b9.js"><link rel="prefetch" href="/noteSite/assets/js/264.0b8cfd9d.js"><link rel="prefetch" href="/noteSite/assets/js/265.1829dfa9.js"><link rel="prefetch" href="/noteSite/assets/js/266.3c6632c2.js"><link rel="prefetch" href="/noteSite/assets/js/267.3017b3f9.js"><link rel="prefetch" href="/noteSite/assets/js/268.9da3349c.js"><link rel="prefetch" href="/noteSite/assets/js/269.91d8db40.js"><link rel="prefetch" href="/noteSite/assets/js/27.92ef4fae.js"><link rel="prefetch" href="/noteSite/assets/js/270.290f869f.js"><link rel="prefetch" href="/noteSite/assets/js/271.363b42d1.js"><link rel="prefetch" href="/noteSite/assets/js/272.91917ac6.js"><link rel="prefetch" href="/noteSite/assets/js/273.e9eced15.js"><link rel="prefetch" href="/noteSite/assets/js/274.d14be490.js"><link rel="prefetch" href="/noteSite/assets/js/275.16431fb1.js"><link rel="prefetch" href="/noteSite/assets/js/276.6e9572ba.js"><link rel="prefetch" href="/noteSite/assets/js/277.ff3f61ed.js"><link rel="prefetch" href="/noteSite/assets/js/278.d10705fd.js"><link rel="prefetch" href="/noteSite/assets/js/279.da930915.js"><link rel="prefetch" href="/noteSite/assets/js/28.88f99f79.js"><link rel="prefetch" href="/noteSite/assets/js/280.fdcdcd14.js"><link rel="prefetch" href="/noteSite/assets/js/281.b9737e9c.js"><link rel="prefetch" href="/noteSite/assets/js/282.d34bfe58.js"><link rel="prefetch" href="/noteSite/assets/js/283.b69937e2.js"><link rel="prefetch" href="/noteSite/assets/js/284.8b6be79b.js"><link rel="prefetch" href="/noteSite/assets/js/285.c805d6cb.js"><link rel="prefetch" href="/noteSite/assets/js/286.e913edd5.js"><link rel="prefetch" href="/noteSite/assets/js/287.87aca343.js"><link rel="prefetch" href="/noteSite/assets/js/288.e3fedb29.js"><link rel="prefetch" href="/noteSite/assets/js/289.ec88668a.js"><link rel="prefetch" href="/noteSite/assets/js/29.6cba673a.js"><link rel="prefetch" href="/noteSite/assets/js/290.af4b9a88.js"><link rel="prefetch" href="/noteSite/assets/js/291.f0eb4185.js"><link rel="prefetch" href="/noteSite/assets/js/292.67f5b7d5.js"><link rel="prefetch" href="/noteSite/assets/js/293.93355ff9.js"><link rel="prefetch" href="/noteSite/assets/js/294.cee6242c.js"><link rel="prefetch" href="/noteSite/assets/js/295.78bb95f7.js"><link rel="prefetch" href="/noteSite/assets/js/296.87b69904.js"><link rel="prefetch" href="/noteSite/assets/js/297.12c68168.js"><link rel="prefetch" href="/noteSite/assets/js/298.eabbd03c.js"><link rel="prefetch" href="/noteSite/assets/js/299.3cc9c9e8.js"><link rel="prefetch" href="/noteSite/assets/js/3.01ff9906.js"><link rel="prefetch" href="/noteSite/assets/js/30.0be426ff.js"><link rel="prefetch" href="/noteSite/assets/js/300.7215ac2f.js"><link rel="prefetch" href="/noteSite/assets/js/301.1f7507df.js"><link rel="prefetch" href="/noteSite/assets/js/302.02a4394d.js"><link rel="prefetch" href="/noteSite/assets/js/303.4d47ce8a.js"><link rel="prefetch" href="/noteSite/assets/js/304.0f46dc9c.js"><link rel="prefetch" href="/noteSite/assets/js/305.f03ff520.js"><link rel="prefetch" href="/noteSite/assets/js/306.dce070cf.js"><link rel="prefetch" href="/noteSite/assets/js/307.2495f1d8.js"><link rel="prefetch" href="/noteSite/assets/js/308.7ed44a2e.js"><link rel="prefetch" href="/noteSite/assets/js/31.3affb8bf.js"><link rel="prefetch" href="/noteSite/assets/js/32.437b68d8.js"><link rel="prefetch" href="/noteSite/assets/js/33.0d8d1ace.js"><link rel="prefetch" href="/noteSite/assets/js/34.85f8d0f4.js"><link rel="prefetch" href="/noteSite/assets/js/35.956398a7.js"><link rel="prefetch" href="/noteSite/assets/js/36.a2f9b5ef.js"><link rel="prefetch" href="/noteSite/assets/js/37.ed56e679.js"><link rel="prefetch" href="/noteSite/assets/js/38.caf7b4b1.js"><link rel="prefetch" href="/noteSite/assets/js/39.3235028f.js"><link rel="prefetch" href="/noteSite/assets/js/4.80421812.js"><link rel="prefetch" href="/noteSite/assets/js/40.20882ae0.js"><link rel="prefetch" href="/noteSite/assets/js/41.2a0678f6.js"><link rel="prefetch" href="/noteSite/assets/js/42.191a81ff.js"><link rel="prefetch" href="/noteSite/assets/js/43.f7570860.js"><link rel="prefetch" href="/noteSite/assets/js/44.10633104.js"><link rel="prefetch" href="/noteSite/assets/js/45.26a82295.js"><link rel="prefetch" href="/noteSite/assets/js/46.2ffa92cf.js"><link rel="prefetch" href="/noteSite/assets/js/48.7e7b91db.js"><link rel="prefetch" href="/noteSite/assets/js/49.b1c28419.js"><link rel="prefetch" href="/noteSite/assets/js/5.4170108b.js"><link rel="prefetch" href="/noteSite/assets/js/50.6f09ab11.js"><link rel="prefetch" href="/noteSite/assets/js/51.7d986c4e.js"><link rel="prefetch" href="/noteSite/assets/js/52.6f79a86f.js"><link rel="prefetch" href="/noteSite/assets/js/53.32be0296.js"><link rel="prefetch" href="/noteSite/assets/js/54.186fd282.js"><link rel="prefetch" href="/noteSite/assets/js/55.2a874220.js"><link rel="prefetch" href="/noteSite/assets/js/56.9a735ade.js"><link rel="prefetch" href="/noteSite/assets/js/57.106c99d0.js"><link rel="prefetch" href="/noteSite/assets/js/58.d28c84f2.js"><link rel="prefetch" href="/noteSite/assets/js/59.285a831b.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.42583b94.js"><link rel="prefetch" href="/noteSite/assets/js/61.8729ece7.js"><link rel="prefetch" href="/noteSite/assets/js/62.a8804c76.js"><link rel="prefetch" href="/noteSite/assets/js/63.7f590648.js"><link rel="prefetch" href="/noteSite/assets/js/64.1d0b611f.js"><link rel="prefetch" href="/noteSite/assets/js/65.445b3f90.js"><link rel="prefetch" href="/noteSite/assets/js/66.944ecaa7.js"><link rel="prefetch" href="/noteSite/assets/js/67.e8296499.js"><link rel="prefetch" href="/noteSite/assets/js/68.11521d20.js"><link rel="prefetch" href="/noteSite/assets/js/69.c793ef18.js"><link rel="prefetch" href="/noteSite/assets/js/7.f685cce4.js"><link rel="prefetch" href="/noteSite/assets/js/70.c7cfccac.js"><link rel="prefetch" href="/noteSite/assets/js/71.69a8329a.js"><link rel="prefetch" href="/noteSite/assets/js/72.94c682ad.js"><link rel="prefetch" href="/noteSite/assets/js/73.4aa52a09.js"><link rel="prefetch" href="/noteSite/assets/js/74.3dd31a8d.js"><link rel="prefetch" href="/noteSite/assets/js/75.35eafb0f.js"><link rel="prefetch" href="/noteSite/assets/js/76.707f6d7d.js"><link rel="prefetch" href="/noteSite/assets/js/77.4e7c39d5.js"><link rel="prefetch" href="/noteSite/assets/js/78.c42519cf.js"><link rel="prefetch" href="/noteSite/assets/js/79.df35c1a1.js"><link rel="prefetch" href="/noteSite/assets/js/8.976ce270.js"><link rel="prefetch" href="/noteSite/assets/js/80.d29db4a3.js"><link rel="prefetch" href="/noteSite/assets/js/81.fc934844.js"><link rel="prefetch" href="/noteSite/assets/js/82.e90de050.js"><link rel="prefetch" href="/noteSite/assets/js/83.abbff5a2.js"><link rel="prefetch" href="/noteSite/assets/js/84.69ddc064.js"><link rel="prefetch" href="/noteSite/assets/js/85.b72fae5f.js"><link rel="prefetch" href="/noteSite/assets/js/86.84b7db2f.js"><link rel="prefetch" href="/noteSite/assets/js/87.b25dddaf.js"><link rel="prefetch" href="/noteSite/assets/js/88.f837c1cf.js"><link rel="prefetch" href="/noteSite/assets/js/89.0bb511ab.js"><link rel="prefetch" href="/noteSite/assets/js/9.599a8138.js"><link rel="prefetch" href="/noteSite/assets/js/90.3fd489aa.js"><link rel="prefetch" href="/noteSite/assets/js/91.8885479b.js"><link rel="prefetch" href="/noteSite/assets/js/92.8c5081db.js"><link rel="prefetch" href="/noteSite/assets/js/93.003ec9bd.js"><link rel="prefetch" href="/noteSite/assets/js/94.897ace9f.js"><link rel="prefetch" href="/noteSite/assets/js/95.fae86dc8.js"><link rel="prefetch" href="/noteSite/assets/js/96.83af16dc.js"><link rel="prefetch" href="/noteSite/assets/js/97.a0104751.js"><link rel="prefetch" href="/noteSite/assets/js/98.1d4e53ce.js"><link rel="prefetch" href="/noteSite/assets/js/99.89a53379.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.2b5d8ceb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link router-link-active">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link">
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/distribute/" class="nav-link">
  分布式
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>入门</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>进阶</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>底层</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/golang/03-advance/01-为什么要使用Go.html" class="sidebar-link">1. 为什么要使用 Go 语言？</a></li><li><a href="/noteSite/backend/golang/03-advance/02-什么是Runtime.html" class="sidebar-link">2. 何为 Runtime？</a></li><li><a href="/noteSite/backend/golang/03-advance/03-Go是面向对象吗.html" class="sidebar-link">3. Go 是面向对象吗？</a></li><li><a href="/noteSite/backend/golang/03-advance/04-Go程序是如何编译的.html" class="sidebar-link">4. Go 程序是如何编译的？</a></li><li><a href="/noteSite/backend/golang/03-advance/05-Go程序是如何启动的.html" class="sidebar-link">5. Go 程序是如何启动起来的？</a></li><li><a href="/noteSite/backend/golang/03-advance/06-大小为0字节的变量.html" class="sidebar-link">6. 大小为 0 字节的变量</a></li><li><a href="/noteSite/backend/golang/03-advance/07-string.html" class="sidebar-link">7. string</a></li><li><a href="/noteSite/backend/golang/03-advance/08-slice.html" class="sidebar-link">8. slice</a></li><li><a href="/noteSite/backend/golang/03-advance/09-map.html" class="sidebar-link">9. map</a></li><li><a href="/noteSite/backend/golang/03-advance/10-interface.html" class="sidebar-link">10. interface</a></li><li><a href="/noteSite/backend/golang/03-advance/11-内存对齐.html" class="sidebar-link">11. 内存对齐</a></li><li><a href="/noteSite/backend/golang/03-advance/12-goroutine.html" class="sidebar-link">12. Goroutine</a></li><li><a href="/noteSite/backend/golang/03-advance/13-锁.html" class="sidebar-link">13. 锁</a></li><li><a href="/noteSite/backend/golang/03-advance/14-channel.html" class="sidebar-link">14. channel</a></li><li><a href="/noteSite/backend/golang/03-advance/15-net.html" aria-current="page" class="active sidebar-link">15. 网络编程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-1-前置知识" class="sidebar-link">15.1 前置知识</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-2-socket" class="sidebar-link">15.2 Socket</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-3-io-模型" class="sidebar-link">15.3 IO 模型</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-4-go-对-epoll-的抽象-network-poller" class="sidebar-link">15.4 Go 对 Epoll 的抽象 - network poller</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-4-1-netpollinit-epoll-create" class="sidebar-link">15.4.1 netpollinit -&gt; epoll_create</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-4-2-netpollopen-epoll-ctl" class="sidebar-link">15.4.2 netpollopen -&gt; epoll_ctl</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-4-3-netpoll-epoll-wait" class="sidebar-link">15.4.3 netpoll -&gt; epoll_wait</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-5-network-poll-对-socket-的抽象-polldesc" class="sidebar-link">15.5 network poll 对 socket 的抽象 —— pollDesc</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-5-1-pollcache" class="sidebar-link">15.5.1 pollCache</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-5-2-polldesc" class="sidebar-link">15.5.2 pollDesc</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-6-network-poller-工作细节" class="sidebar-link">15.6 network poller 工作细节</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-6-1-初始化-poll-runtime-pollserverinit" class="sidebar-link">15.6.1 初始化 pollruntimepollServerInit</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-6-2-新增监听-poll-runtime-pollopen" class="sidebar-link">15.6.2 新增监听 pollruntimepollOpen</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-6-3-判断是否就绪-poll-runtime-pollwait" class="sidebar-link">15.6.3 判断是否就绪 pollruntimepollWait</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-6-4-调度协程去读写-socket" class="sidebar-link">15.6.4 调度协程去读写 socket</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-7-net-包" class="sidebar-link">15.7 net 包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-7-1-net-netfd" class="sidebar-link">15.7.1 net.netFD</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-7-2-net-listen-listenter" class="sidebar-link">15.7.2 net.Listen() Listenter</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-7-3-listener-accept" class="sidebar-link">15.7.3 listener.Accept()</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-7-4-conn-read-conn-write" class="sidebar-link">15.7.4 conn.Read() / conn.Write()</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-7-3-net-dialtcp" class="sidebar-link">15.7.3 net.DialTCP()</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/golang/03-advance/15-net.html#_15-8-goroutine-per-connection" class="sidebar-link">15.8 goroutine-per-connection</a></li></ul></li><li><a href="/noteSite/backend/golang/03-advance/16-memory.html" class="sidebar-link">16. 内存模型</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>常用技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_15-网络编程"><a href="#_15-网络编程" class="header-anchor">#</a> 15. 网络编程</h1> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5lh6uxgk3j21770u0773.jpg" alt="image-20220827175755343"></p> <h2 id="_15-1-前置知识"><a href="#_15-1-前置知识" class="header-anchor">#</a> 15.1 前置知识</h2> <ul><li><a href="https://hedon954.github.io/noteSite/cs/cn/cn-transfer-layer.html" target="_blank" rel="noopener noreferrer">计算机网络 - 传输层<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://hedon954.github.io/noteSite/cs/cn/cn-apply-layer.html#_5-socket" target="_blank" rel="noopener noreferrer">计算机网络 - 应用层 - Socket<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://hedon954.github.io/noteSite/linux/linux-io/0-concept.html" target="_blank" rel="noopener noreferrer">Linux IO 模型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://hedon954.github.io/noteSite/backend/golang/high/net.html" target="_blank" rel="noopener noreferrer">Go 网络编程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="_15-2-socket"><a href="#_15-2-socket" class="header-anchor">#</a> 15.2 Socket</h2> <ul><li>很多系统都提供 Socket 作为 TCP 网络连接的抽象</li> <li>Linux  -&gt; Internet domain socket -&gt; SOCK_STREAM</li> <li>Linux 中 Socket 以“文件描述符” FD 作为标识</li></ul> <h2 id="_15-3-io-模型"><a href="#_15-3-io-模型" class="header-anchor">#</a> 15.3 IO 模型</h2> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5khhvfgg9j21hi0peq7l.jpg" alt="image-20220826212254482"></p> <p>在网络编程中，IO 模型指的就是同时操作 Socket 的方案：BIO/NIO/AIO</p> <p>Go：阻塞模型（协程调度） + 多路复用（系统底层）</p> <h2 id="_15-4-go-对-epoll-的抽象-network-poller"><a href="#_15-4-go-对-epoll-的抽象-network-poller" class="header-anchor">#</a> 15.4 Go 对 Epoll 的抽象 - network poller</h2> <p>多路复用器：</p> <ul><li><p>Linux：Epoll</p> <ul><li><p>新建多路复用器：<code>epoll_create()</code></p></li> <li><p>插入监听事件：<code>epoll_ctl()</code></p></li> <li><p>查询发生了什么事件：<code>epoll_wait()</code></p></li></ul></li> <li><p>Mac：kqueue</p></li> <li><p>Windows：IOCP</p></li></ul> <blockquote><p>本文仅介绍针对 Linux 的实现。</p></blockquote> <p>Go NetWork Poll 是对各个平台多路复用器的抽象和适配：</p> <ul><li>netpollinit -&gt; epoll_create</li> <li>netpollopen -&gt; epoll_ctl</li> <li>netpoll -&gt; epoll_wait</li></ul> <h3 id="_15-4-1-netpollinit-epoll-create"><a href="#_15-4-1-netpollinit-epoll-create" class="header-anchor">#</a> 15.4.1 netpollinit -&gt; epoll_create</h3> <ol><li><p>系统指令：<strong>syscall/zsysnum_linux_amd64.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code>	SYS_EPOLL_CREATE <span class="token operator">=</span> <span class="token number">213</span>
</code></pre></div></li> <li><p>汇编：<strong>sys_linux_amd64.s</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// int32 runtime·epollcreate(int32 size);</span>
TEXT runtime·<span class="token function">epollcreate</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span>
	MOVL    size<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> DI
	MOVL    $SYS_epoll_create<span class="token punctuation">,</span> AX
	SYSCALL
	MOVL	AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
	RET
</code></pre></div></li> <li><p>Go 中的声明：<strong>runtime/netpoll_epoll.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">epollcreate</span><span class="token punctuation">(</span>size <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">int32</span>
<span class="token keyword">func</span> <span class="token function">epollcreate1</span><span class="token punctuation">(</span>flags <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">int32</span>
</code></pre></div><p>epollcreate1 中的 <code>flags</code>：</p> <ul><li><p><code>0</code>：此时 epollcreate1 和 epollcreate 功能一致</p></li> <li><p><code>_EPOLL_CLOEXEC</code>：创建的 epfd 会设置 <code>FD_CLOEXEC</code>，它是一个 fd 的标识说明，用来设置文件的 close-on-exec 状态的。</p> <p>当 close-on-exec 状态为 0 时，调用 exec 时，fd 不会被关闭；</p> <p>非零状态时则会被关系，这样做可以防止 fd 泄露给执行 exec 后的进程。</p></li> <li><p><code>_EPOLL_NONBLOCK</code>：创建的 epfd 会设置为非阻塞</p></li></ul></li> <li><p>针对 Linux 的实现：<strong>runtime/netpoll_poll.go</strong></p> <p>① 新建 epoll；</p> <p>② 新建一个 pipe 管道用于中断 epoll；</p> <p>③ 将“管道有数据到达”事件注册到 epoll 中。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// netpollinit 新建多路复用器</span>
<span class="token keyword">func</span> <span class="token function">netpollinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 新建一个 epoll fd</span>
	epfd <span class="token operator">=</span> <span class="token function">epollcreate1</span><span class="token punctuation">(</span>_EPOLL_CLOEXEC<span class="token punctuation">)</span>
	<span class="token keyword">if</span> epfd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		epfd <span class="token operator">=</span> <span class="token function">epollcreate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> epfd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: epollcreate failed with&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>epfd<span class="token punctuation">)</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: netpollinit failed&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">closeonexec</span><span class="token punctuation">(</span>epfd<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 2. 新建一个 linux 下的非阻塞管道，用来关闭 epoll 的</span>
	r<span class="token punctuation">,</span> w<span class="token punctuation">,</span> errno <span class="token operator">:=</span> <span class="token function">nonblockingPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> errno <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: pipe failed with&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>errno<span class="token punctuation">)</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: pipe failed&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 3. 创建一个 epoll 事件，并将其与 netpollBreakRd 关联在一起</span>
  
	ev <span class="token operator">:=</span> epollevent<span class="token punctuation">{</span>
		events<span class="token punctuation">:</span> _EPOLLIN<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>netpollBreakRd
  <span class="token comment">// 4. 调用 epollctl 将 ev 注册到 epfd 上</span>
  <span class="token comment">//   _EPOLL_CTL_ADD 表示向 interet list 添加一个需要监视的描述符</span>
  <span class="token comment">//	这里表示添加对之前创建的 nonblockingPipe 的 _EPOLLIN 事件</span>
  <span class="token comment">//  即监控是否有数据到达 nonblockingPipe </span>
  <span class="token comment">//  综上可以得知，nonblockingPipe 和 netpollBreakRd 是关联在一起的</span>
  <span class="token comment">//  即 nonblockingPipe 是用来关闭 epoll 的</span>
	errno <span class="token operator">=</span> <span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
	<span class="token keyword">if</span> errno <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: epollctl failed with&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>errno<span class="token punctuation">)</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: epollctl failed&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	netpollBreakRd <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	netpollBreakWr <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_15-4-2-netpollopen-epoll-ctl"><a href="#_15-4-2-netpollopen-epoll-ctl" class="header-anchor">#</a> 15.4.2 netpollopen -&gt; epoll_ctl</h3> <ol><li><p>系统指令：<strong>syscall/zsysnum_linux_amd64.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code>	SYS_EPOLL_CTL <span class="token operator">=</span> <span class="token number">233</span>
</code></pre></div></li> <li><p>汇编：<strong>sys_linux_amd64.s</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// func epollctl(epfd, op, fd int32, ev *epollEvent) int</span>
TEXT runtime·<span class="token function">epollctl</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span>
	MOVL	epfd<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> DI
	MOVL	op<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> SI
	MOVL	fd<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVQ	ev<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> R10
	MOVL	$SYS_epoll_ctl<span class="token punctuation">,</span> AX
	SYSCALL
	MOVL	AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
	RET
</code></pre></div></li> <li><p>Go 中的声明：<strong>runtime/netpoll_epoll.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> op<span class="token punctuation">,</span> fd <span class="token builtin">int32</span><span class="token punctuation">,</span> ev <span class="token operator">*</span>epollevent<span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token comment">// 0: 成功，-1: 失败</span>
</code></pre></div><ul><li><code>epfd</code>：epoll_create 函数返回的文件描述符，用于标识内核中的 epoll 实例</li> <li><code>op</code>：对 fd 文件描述符的操作类型：
<ul><li><code>EPOLL_CTL_ADD</code>：向 interest list 添加一个需要监视的描述符</li> <li><code>EPOLL_CTL_DEL</code>：向 interest list 删除一个描述符</li> <li><code>EPOLL_CTL_MOD</code>：修改 interst list 中的一个描述符</li></ul></li> <li><code>fd</code>：需要被操作的文件描述符</li> <li><code>ev</code>：一个指向名为 epoll_event 的结构的指针，它存储了我们实际要监视的 fd 的事件
<ul><li><code>EPOLLIN</code>：表示对应的文件描述符可以读（包括对端 SOCKET 正常关闭）；</li> <li><code>EPOLLOUT</code>：表示对应的文件描述符可以写；</li> <li><code>EPOLLPRI</code>：表示对应的文件描述符有紧急的数据可读；</li> <li><code>EPOLLERR</code>：表示对应的文件描述符发生错误；</li> <li><code>EPOLLHUP</code>：表示对应的文件描述符被挂断；</li> <li><code>EPOLLET</code>： 将 epoll 设为边缘触发（Edge Triggered）模式，相对于水平触发（Level Triggered）来说的；</li> <li><code>EPOLLONESHOT</code>：只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个 socket的话，需要再次把这个 socket 加入到 epoll 队列里；</li></ul></li></ul></li> <li><p>针对 Linux 的实现：<strong>runtime/netpoll_poll.go</strong></p> <p>① 传入一个 socket 的 fd，和 pollDesc 指针，pollDesc 是 Go 中对 socket 的抽象。pollDesc 中记录了 socket 的详细信息，以及哪个协程休眠在等待此 socket；</p> <p>② 将 socket 的可读、可写、断开事件注册到 epoll 中；</p> <p>③ 将 epoll 设置为 ET 模式。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 将 fd 的四个事件  _EPOLLIN | _EPOLLOUT | _EPOLLRDHUP | _EPOLLET 注册到 epfd 上</span>
<span class="token keyword">func</span> <span class="token function">netpollopen</span><span class="token punctuation">(</span>fd <span class="token builtin">uintptr</span><span class="token punctuation">,</span> pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token builtin">int32</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> ev epollevent
	ev<span class="token punctuation">.</span>events <span class="token operator">=</span> _EPOLLIN <span class="token operator">|</span> _EPOLLOUT <span class="token operator">|</span> _EPOLLRDHUP <span class="token operator">|</span> _EPOLLET
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> pd
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token function">epollctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> _EPOLL_CTL_ADD<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="_15-4-3-netpoll-epoll-wait"><a href="#_15-4-3-netpoll-epoll-wait" class="header-anchor">#</a> 15.4.3 netpoll -&gt; epoll_wait</h3> <ol><li><p>系统指令：<strong>syscall/zsysnum_linux_amd64.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code>	SYS_EPOLL_WAIT  <span class="token operator">=</span> <span class="token number">232</span>
</code></pre></div></li> <li><p>汇编：<strong>sys_linux_amd64.s</strong></p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// int32 runtime·epollwait(int32 epfd, EpollEvent *ev, int32 nev, int32 timeout);</span>
TEXT runtime·<span class="token function">epollwait</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span>
	<span class="token comment">// This uses pwait instead of wait, because Android O blocks wait.</span>
	MOVL	epfd<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> DI
	MOVQ	ev<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> SI
	MOVL	nev<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> DX
	MOVL	timeout<span class="token operator">+</span><span class="token number">20</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> R10
	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> R8
	MOVL	$SYS_epoll_pwait<span class="token punctuation">,</span> AX
	SYSCALL
	MOVL	AX<span class="token punctuation">,</span> ret<span class="token operator">+</span><span class="token number">24</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span>
	RET
</code></pre></div></li> <li><p>Go 中的声明：<strong>runtime/netpoll_epoll.go</strong></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd <span class="token builtin">int32</span><span class="token punctuation">,</span> ev <span class="token operator">*</span>epollevent<span class="token punctuation">,</span> nev<span class="token punctuation">,</span> timeout <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">int32</span>
</code></pre></div><ul><li><code>epfd</code>：epoll_create 函数返回的文件描述符，用于标识内核中的 epoll 实例</li> <li><code>ev</code> 已经分配好的 epoll_event 结构体数组的指针（即 ev[0]），epoll 会把发生的事件存入 events 中</li> <li><code>maxevents</code>：告诉内核 ev 有多大，必须大于 0</li> <li><code>timeout</code>：超时时间 <strong>-1</strong> 表示 epoll 将无限制等待下去</li></ul></li> <li><p>针对 Linux 的实现：<strong>runtime/netpoll_poll.go</strong></p> <p>① 根据 delay 确定要轮询多久；</p> <p>② 创建一个长度为 128 的事件列表；</p> <p>③ 调用系统底层的 epollwait，查询有多少事件发生了；</p> <p>④ 新建一个协程列表；</p> <p>⑤ 遍历事件列表；</p> <p>⑥ 获取 go 中对 fd 的抽象结构体的值 pd；</p> <p>⑦ 将 pd 中的 g 取出来加入到 toRun 列表中；</p> <p>⑧ 返回可执行的 <font color="red">goroutine</font> 列表。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// netpoll checks for ready network connections.</span>
<span class="token comment">// Returns list of goroutines that become runnable -&gt; 注意，返回的是 goroutine</span>
<span class="token comment">// delay &lt; 0: blocks indefinitely										无限期阻塞</span>
<span class="token comment">// delay == 0: does not block, just polls    				不阻塞，只是轮询</span>
<span class="token comment">// delay &gt; 0: block for up to that many nanoseconds	阻塞长达数纳秒</span>
<span class="token keyword">func</span> <span class="token function">netpoll</span><span class="token punctuation">(</span>delay <span class="token builtin">int64</span><span class="token punctuation">)</span> gList <span class="token punctuation">{</span>
	<span class="token keyword">if</span> epfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> gList<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  
  <span class="token comment">// 1. 根据 delay 确定要轮询多久</span>
	<span class="token keyword">var</span> waitms <span class="token builtin">int32</span>
	<span class="token keyword">if</span> delay <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		waitms <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> delay <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		waitms <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> delay <span class="token operator">&lt;</span> <span class="token number">1e6</span> <span class="token punctuation">{</span>
		waitms <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> delay <span class="token operator">&lt;</span> <span class="token number">1e15</span> <span class="token punctuation">{</span>
		waitms <span class="token operator">=</span> <span class="token function">int32</span><span class="token punctuation">(</span>delay <span class="token operator">/</span> <span class="token number">1e6</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		waitms <span class="token operator">=</span> <span class="token number">1e9</span>
	<span class="token punctuation">}</span>
  
  <span class="token comment">// 2. 创建一个长度为 128 的事件列表</span>
	<span class="token keyword">var</span> events <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span>epollevent
retry<span class="token punctuation">:</span>
  <span class="token comment">// 3. 调用系统底层的 epollwait，查询有多少事件发生了</span>
	n <span class="token operator">:=</span> <span class="token function">epollwait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> waitms<span class="token punctuation">)</span>
	<span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> n <span class="token operator">!=</span> <span class="token operator">-</span>_EINTR <span class="token punctuation">{</span>
			<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: epollwait on fd&quot;</span><span class="token punctuation">,</span> epfd<span class="token punctuation">,</span> <span class="token string">&quot;failed with&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span>n<span class="token punctuation">)</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: netpoll failed&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// If a timed sleep was interrupted, just return to</span>
		<span class="token comment">// recalculate how long we should sleep now.</span>
		<span class="token keyword">if</span> waitms <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> gList<span class="token punctuation">{</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">goto</span> retry
	<span class="token punctuation">}</span>
  <span class="token comment">// 4. 新建一个协程列表</span>
	<span class="token keyword">var</span> toRun gList
  <span class="token comment">// 5. 遍历事件列表，</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		ev <span class="token operator">:=</span> <span class="token operator">&amp;</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token keyword">if</span> ev<span class="token punctuation">.</span>events <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		
    <span class="token comment">// 断开事件</span>
		<span class="token keyword">if</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">&amp;</span>netpollBreakRd <span class="token punctuation">{</span>
			<span class="token keyword">if</span> ev<span class="token punctuation">.</span>events <span class="token operator">!=</span> _EPOLLIN <span class="token punctuation">{</span>
				<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: netpoll: break fd ready for&quot;</span><span class="token punctuation">,</span> ev<span class="token punctuation">.</span>events<span class="token punctuation">)</span>
				<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: netpoll: break fd ready for something unexpected&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> delay <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token comment">// netpollBreak could be picked up by a</span>
				<span class="token comment">// nonblocking poll. Only read the byte</span>
				<span class="token comment">// if blocking.</span>
				<span class="token keyword">var</span> tmp <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
				<span class="token function">read</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span>netpollBreakRd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">noescape</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollWakeSig<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

    <span class="token comment">// 可读事件</span>
		<span class="token keyword">var</span> mode <span class="token builtin">int32</span>
		<span class="token keyword">if</span> ev<span class="token punctuation">.</span>events<span class="token operator">&amp;</span><span class="token punctuation">(</span>_EPOLLIN<span class="token operator">|</span>_EPOLLRDHUP<span class="token operator">|</span>_EPOLLHUP<span class="token operator">|</span>_EPOLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			mode <span class="token operator">+=</span> <span class="token string">'r'</span>
		<span class="token punctuation">}</span>
    
    <span class="token comment">// 可写事件</span>
		<span class="token keyword">if</span> ev<span class="token punctuation">.</span>events<span class="token operator">&amp;</span><span class="token punctuation">(</span>_EPOLLOUT<span class="token operator">|</span>_EPOLLHUP<span class="token operator">|</span>_EPOLLERR<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			mode <span class="token operator">+=</span> <span class="token string">'w'</span>
		<span class="token punctuation">}</span>
    
		<span class="token keyword">if</span> mode <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token comment">// 6. 获取 go 中对 fd 的抽象结构体的值 fd</span>
			pd <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>pollDesc<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
			pd<span class="token punctuation">.</span>everr <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token keyword">if</span> ev<span class="token punctuation">.</span>events <span class="token operator">==</span> _EPOLLERR <span class="token punctuation">{</span>
				pd<span class="token punctuation">.</span>everr <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// 7. 将 pd 中的 g 取出来加入到 toRun 列表中</span>
			<span class="token function">netpollready</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>toRun<span class="token punctuation">,</span> pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  
  <span class="token comment">// 8. 返回可执行的 goroutine 列表</span>
	<span class="token keyword">return</span> toRun
<span class="token punctuation">}</span>
</code></pre></div><p>netpollready 表示 pd 底层的 fd 已经可以进行 IO 操作了：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// netpollready is called by the platform-specific netpoll function.</span>
<span class="token comment">// It declares that the fd associated with pd is ready for I/O.</span>
<span class="token comment">// The toRun argument is used to build a list of goroutines to return</span>
<span class="token comment">// from netpoll. The mode argument is 'r', 'w', or 'r'+'w' to indicate</span>
<span class="token comment">// whether the fd is ready for reading or writing or both.</span>
<span class="token comment">//</span>
<span class="token comment">// This may run while the world is stopped, so write barriers are not allowed.</span>
<span class="token comment">//go:nowritebarrier</span>
<span class="token keyword">func</span> <span class="token function">netpollready</span><span class="token punctuation">(</span>toRun <span class="token operator">*</span>gList<span class="token punctuation">,</span> pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> rg<span class="token punctuation">,</span> wg <span class="token operator">*</span>g
   <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'r'</span> <span class="token operator">||</span> mode <span class="token operator">==</span> <span class="token string">'r'</span><span class="token operator">+</span><span class="token string">'w'</span> <span class="token punctuation">{</span>
      rg <span class="token operator">=</span> <span class="token function">netpollunblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'w'</span> <span class="token operator">||</span> mode <span class="token operator">==</span> <span class="token string">'r'</span><span class="token operator">+</span><span class="token string">'w'</span> <span class="token punctuation">{</span>
      wg <span class="token operator">=</span> <span class="token function">netpollunblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> rg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      toRun<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rg<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> wg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      toRun<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>wg<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <div class="custom-block warning"><p class="custom-block-title">谁在调用 netpoll()？</p> <ul><li><p><code>runtime/proc.go</code> 中的 <code>startTheWorldWithSema()</code>  会调用 <code>netpoll()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span>emitTraceEvent <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> <span class="token function">netpollinited</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">//调用 netpoll</span>
		<span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>runtime/mgc.go</code> 中的 <code>gcStart()</code> 会调用 <code>startTheWorldWithSema()</code></p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// gcStart starts the GC. </span>
<span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>trigger gcTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// Concurrent mark.</span>
  <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    now <span class="token operator">=</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>enabled<span class="token punctuation">)</span>	<span class="token comment">// 调用 startTheWorldWithSema</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>而 <code>gcStart()</code> 又会被我们的 g0 协程一直循环执行。</p></li></ul> <p>综上：<code>netpoll()</code> 不是由应用进程来调用的，而且 <code>g0</code> 协程在循环 gc 的时候，顺带执行了 netpoll() 来检查是否有事件发生。</p></div> <h2 id="_15-5-network-poll-对-socket-的抽象-polldesc"><a href="#_15-5-network-poll-对-socket-的抽象-polldesc" class="header-anchor">#</a> 15.5 network poll 对 socket 的抽象 —— pollDesc</h2> <h3 id="_15-5-1-pollcache"><a href="#_15-5-1-pollcache" class="header-anchor">#</a> 15.5.1 pollCache</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> pollCache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock  mutex				<span class="token comment">// 锁，锁住整个链表</span>
	first <span class="token operator">*</span>pollDesc		<span class="token comment">// 表示 pollCache 就是 pollDesc 链表的表头</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_15-5-2-polldesc"><a href="#_15-5-2-polldesc" class="header-anchor">#</a> 15.5.2 pollDesc</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Network poller descriptor.</span>
<span class="token comment">//</span>
<span class="token comment">// No heap pointers.</span>
<span class="token comment">//</span>
<span class="token comment">//go:notinheap</span>
<span class="token keyword">type</span> pollDesc <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	link <span class="token operator">*</span>pollDesc  <span class="token comment">// 连接到下一个 pollDesc</span>
	lock    mutex 	<span class="token comment">// 锁</span>
  
	fd      <span class="token builtin">uintptr</span>		<span class="token comment">// 指向底层的 socket 文件描述符，不可变</span>
  
  <span class="token comment">// 以下 4 个操作过程中上锁</span>
  rseq    <span class="token builtin">uintptr</span>   <span class="token comment">// 避免读计时器过期，用来重置计时器</span>
  wseq    <span class="token builtin">uintptr</span>   <span class="token comment">// 避免写计时器过期，用来重置计时器</span>
  rt      timer     <span class="token comment">// 读计时器</span>
  wt      timer     <span class="token comment">// 写计时器</span>
	
  <span class="token comment">// 以下 6 个操作过程中不上锁</span>
  everr   <span class="token builtin">bool</span>      <span class="token comment">// 标记是否有异常事件发生</span>
	rg      <span class="token builtin">uintptr</span>   <span class="token comment">// pdReady, pdWait, G waiting for read or nil</span>
	rd      <span class="token builtin">int64</span>     <span class="token comment">// 读截止时间</span>
	wg      <span class="token builtin">uintptr</span>   <span class="token comment">// pdReady, pdWait, G waiting for write or nil</span>
	wd      <span class="token builtin">int64</span>     <span class="token comment">// 写截止时间</span>
	closing <span class="token builtin">bool</span>
  
	self    <span class="token operator">*</span>pollDesc <span class="token comment">// storage for indirect interface. See (*pollDesc).makeArg.</span>
	user    <span class="token builtin">uint32</span>    <span class="token comment">// user settable cookie</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li><p><code>link</code>：链接到下一个 pollDesc，说明这是一个链表结构。</p></li> <li><p><code>lock</code>：锁。</p> <ul><li>该锁可保护 pollOpen、pollSetDeadline、pollUnblock 和 deadlineimpl 操作，这些操作覆盖到 rseq、wseq、rt 和 wt 变量；</li> <li>fd 在整个 pollDesc 生命周期都是不可变的；</li> <li>pollReset，pollWait，pollWaitCanceled 和 runtime·netpollready 执行是不带锁的，因此 everr、rg、rd、wg 和 wd 的所有操作都是以无锁方式进行的。</li></ul></li> <li><p><code>fd</code>：指向底层的 socket 文件描述符。</p></li> <li><p><code>rseq</code>、<code>wseq</code>：用来重置读写计时器，防止过期。</p></li> <li><p><code>rg</code>、<code>wg</code>：是两个用来休眠读写协程的二进制信号量，该信号量可以有以下 4 种值：</p> <ul><li><code>nil</code>：即 0，初始状态；</li> <li><code>pdReady</code>：即 1，网络 IO 就绪，Goroutine 消费完后应置为 nil；</li> <li><code>pdWait</code>：即 2
<ol><li>Groutine 被调度器挂起，置为 Groutine 地址；</li> <li>收到 IO 就绪通知，置改为 pdReady；</li> <li>超时或被关闭，置为 nil；</li></ol></li> <li><code>G pointer</code>：等待读写当前 socket 的 Goroutine 指针地址，当 io 就绪、超时或者被关闭的时候，此 Goroutine 将被唤醒，同时将值置为 pdReady 或者 nil。</li></ul> <blockquote><p>因为 <code>rg</code>、<code>wg</code> 是 Goroutine 的地址，因此当发生 GC 后，如果 Goroutine 在 heap 区的话，就可能被回收，那指针就无效了，会导致代码崩溃。</p> <p>所以，在进行 net IO 的 Goroutine 不能在 heap 区分配内存。</p></blockquote></li></ul> <div class="custom-block tip"><p class="custom-block-title">总结</p> <ul><li><p>pollCache：是 pollDesc 链表的表头；</p></li> <li><p>pollDesc 主要描述两点：</p> <ol><li><p>封装了操作系统底层的 socket：<code>fd</code></p></li> <li><p>对该 socket 有兴趣的协程：<code>wg</code>、<code>rg</code></p></li></ol></li></ul></div> <h2 id="_15-6-network-poller-工作细节"><a href="#_15-6-network-poller-工作细节" class="header-anchor">#</a> 15.6 network poller 工作细节</h2> <h3 id="_15-6-1-初始化-poll-runtime-pollserverinit"><a href="#_15-6-1-初始化-poll-runtime-pollserverinit" class="header-anchor">#</a> 15.6.1 初始化 poll_runtime_pollServerInit</h3> <p>通过原子操作 &amp; 双重检查来执行一次 <code>netpollinit()</code>，创建一个 epoll。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//go:linkname poll_runtime_pollServerInit internal/poll.runtime_pollServerInit</span>
<span class="token keyword">func</span> <span class="token function">poll_runtime_pollServerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">netpollGenericInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">netpollGenericInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 类似于 双重检查 的单例模式</span>
  <span class="token comment">// 保证只执行一次 netpollinit()</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollInited<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">lockInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollInitLock<span class="token punctuation">,</span> lockRankNetpollInit<span class="token punctuation">)</span>
		<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollInitLock<span class="token punctuation">)</span>
		<span class="token keyword">if</span> netpollInited <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
      <span class="token function">netpollinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// epoll_create() 创建一个多路复用器</span>
			atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollInited<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollInitLock<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">补充：go:linkname</p> <blockquote><p>The //go:linkname directive instructs the compiler to use “importpath.name” as the object file symbol name for the variable or function declared as “localname” in the source code. Because this directive can subvert the type system and package modularity, it is only enabled in files that have imported “unsafe”.</p></blockquote> <p><code>//go:linkname</code>的目的是告诉编译器使用<code>importpath.name</code>来对本来不可导出的（localname）函数或者变量实现导出功能。由于这种方法是破坏了 Go 语言的模块化规则的，所以必须在导入了<code>&quot;unsafe&quot;</code>包的情况下使用。</p> <p>即：</p> <blockquote><p>由于 Go 语法规则限制，小写字母开头的函数或者变量是本模块私有的，不可被包外的代码访问；但是如果必须要能被外部模块访问到，又要限制为私有方法呢？只能在编译器上做手脚，通过一个特殊的 <strong>标记</strong> 来实现这种功能。</p></blockquote> <p>具体到上面的例子：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//go:linkname poll_runtime_pollServerInit internal/poll.runtime_pollServerInit</span>
</code></pre></div><ul><li>表示调用 <code>internal/poll.runtime_pollServerInit</code> 相当于调用当前的 <code>poll_runtime_pollServerInit</code></li></ul></div> <h3 id="_15-6-2-新增监听-poll-runtime-pollopen"><a href="#_15-6-2-新增监听-poll-runtime-pollopen" class="header-anchor">#</a> 15.6.2 新增监听 poll_runtime_pollOpen</h3> <ol><li>在 pollcache 链表中分配一个 pollDesc，用来描述要新增将它的 socket；</li> <li>初始化 pollDesc，主要是将 rg、wg 置为 0；</li> <li>调用 netpollopen，将底层 socket 及其读、写和断开事件注册到 epoll 上；</li></ol> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//go:linkname poll_runtime_pollOpen internal/poll.runtime_pollOpen</span>
<span class="token keyword">func</span> <span class="token function">poll_runtime_pollOpen</span><span class="token punctuation">(</span>fd <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 1. 分配一个 pollDesc，用来描述要新增监听的 socket</span>
   pd <span class="token operator">:=</span> pollcache<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// 2. 上锁</span>
   <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pd<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
   <span class="token keyword">if</span> pd<span class="token punctuation">.</span>wg <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pd<span class="token punctuation">.</span>wg <span class="token operator">!=</span> pdReady <span class="token punctuation">{</span>
      <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: blocked write on free polldesc&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> pd<span class="token punctuation">.</span>rg <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pd<span class="token punctuation">.</span>rg <span class="token operator">!=</span> pdReady <span class="token punctuation">{</span>
      <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: blocked read on free polldesc&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 3. 赋值</span>
   pd<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd						<span class="token comment">// 监听的 socket</span>
   pd<span class="token punctuation">.</span>closing <span class="token operator">=</span> <span class="token boolean">false</span>
   pd<span class="token punctuation">.</span>everr <span class="token operator">=</span> <span class="token boolean">false</span>
   pd<span class="token punctuation">.</span>rseq<span class="token operator">++</span>
   pd<span class="token punctuation">.</span>rg <span class="token operator">=</span> <span class="token number">0</span>			<span class="token comment">// 初始值，还没感兴趣的 Goroutine</span>
   pd<span class="token punctuation">.</span>rd <span class="token operator">=</span> <span class="token number">0</span>
   pd<span class="token punctuation">.</span>wseq<span class="token operator">++</span>
   pd<span class="token punctuation">.</span>wg <span class="token operator">=</span> <span class="token number">0</span>			<span class="token comment">// 初始化，还没感兴趣的 Goroutine</span>
   pd<span class="token punctuation">.</span>wd <span class="token operator">=</span> <span class="token number">0</span>
   pd<span class="token punctuation">.</span>self <span class="token operator">=</span> pd
   <span class="token comment">// 4. 解锁</span>
   <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pd<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

   <span class="token keyword">var</span> errno <span class="token builtin">int32</span>
   <span class="token comment">// 5. 调用 netpollopen  -&gt; epoll_ctl</span>
   <span class="token comment">// 将 pd 关联的 fd 的相关事件注册到 epoll 上</span>
   errno <span class="token operator">=</span> <span class="token function">netpollopen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> pd<span class="token punctuation">)</span>
   <span class="token keyword">return</span> pd<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_15-6-3-判断是否就绪-poll-runtime-pollwait"><a href="#_15-6-3-判断是否就绪-poll-runtime-pollwait" class="header-anchor">#</a> 15.6.3 判断是否就绪 poll_runtime_pollWait</h3> <ol><li>协程要对 socket 进行 read 或者 write 的时候，底层就会调用 poll_runtime_pollWait；</li> <li>该方法循环调用 netpollblock()，直到 netpollblock() 返回 true，表明 rg 或 wg 已经置为 pdReady 了，可以进行读或者写了。</li> <li>netpollblock()：
<ol><li>根据 mode，取出 rg 或者 wg，命名为 gpp；</li> <li>如果 gpp 是 pdReady，直接返回 true，否则，置为 pdWait，返回 false。</li></ol></li></ol> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">)</span> <span class="token function">wait</span><span class="token punctuation">(</span>mode <span class="token builtin">int</span><span class="token punctuation">,</span> isFile <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> pd<span class="token punctuation">.</span>runtimeCtx <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;waiting for unsupported file type&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	res <span class="token operator">:=</span> <span class="token function">runtime_pollWait</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>runtimeCtx<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">convertErr</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> isFile<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">runtime_pollWait</span><span class="token punctuation">(</span>ctx <span class="token builtin">uintptr</span><span class="token punctuation">,</span> mode <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//go:linkname poll_runtime_pollWait internal/poll.runtime_pollWait</span>
<span class="token keyword">func</span> <span class="token function">poll_runtime_pollWait</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
   <span class="token comment">// 循环调用 netpollblock，直到 netpollblock 返回 true</span>
   <span class="token comment">// 也就是 rg 或 wg 已经置为 pdReady 了，可以读 / 写了</span>
   <span class="token keyword">for</span> <span class="token operator">!</span><span class="token function">netpollblock</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> <span class="token function">int32</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> pollNoError
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// returns true if IO is ready, or false if timedout or closed</span>
<span class="token comment">// waitio - wait only for completed IO, ignore errors</span>
<span class="token keyword">func</span> <span class="token function">netpollblock</span><span class="token punctuation">(</span>pd <span class="token operator">*</span>pollDesc<span class="token punctuation">,</span> mode <span class="token builtin">int32</span><span class="token punctuation">,</span> waitio <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
  
   <span class="token comment">// 1. 根据 mode，看看是要读还是要写</span>
   gpp <span class="token operator">:=</span> <span class="token operator">&amp;</span>pd<span class="token punctuation">.</span>rg
   <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">'w'</span> <span class="token punctuation">{</span>
      gpp <span class="token operator">=</span> <span class="token operator">&amp;</span>pd<span class="token punctuation">.</span>wg
   <span class="token punctuation">}</span>

   <span class="token keyword">for</span> <span class="token punctuation">{</span>
      old <span class="token operator">:=</span> <span class="token operator">*</span>gpp
      <span class="token comment">// 2. 已经 pdReady 了，返回 true，完成</span>
      <span class="token keyword">if</span> old <span class="token operator">==</span> pdReady <span class="token punctuation">{</span>
         <span class="token operator">*</span>gpp <span class="token operator">=</span> <span class="token number">0</span>
         <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> old <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
         <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;runtime: double wait&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 3. 没有 pdReady，则先置为 pdWait，再往下走</span>
      <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span>gpp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pdWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
     
       <span class="token keyword">if</span> waitio <span class="token operator">||</span> <span class="token function">netpollcheckerr</span><span class="token punctuation">(</span>pd<span class="token punctuation">,</span> mode<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
          <span class="token comment">// 4. 休眠当前协程，并将调用 netpollblockcommit</span>
         	<span class="token comment">// 它会将 rg 或者 wg 置为 G Pointer</span>
          <span class="token function">gopark</span><span class="token punctuation">(</span>netpollblockcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonIOWait<span class="token punctuation">,</span> traceEvGoBlockNet<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token operator">...</span>
   <span class="token keyword">return</span> old <span class="token operator">==</span> pdReady
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">netpollblockcommit</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> gpp unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
   r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>gpp<span class="token punctuation">)</span><span class="token punctuation">,</span> pdWait<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> r <span class="token punctuation">{</span>
      <span class="token comment">// Bump the count of goroutines waiting for the poller.</span>
      <span class="token comment">// The scheduler uses this to decide whether to block</span>
      <span class="token comment">// waiting for the poller if there is nothing else to do.</span>
      atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netpollWaiters<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_15-6-4-调度协程去读写-socket"><a href="#_15-6-4-调度协程去读写-socket" class="header-anchor">#</a> 15.6.4 调度协程去读写 socket</h3> <ul><li><p>socket 已经可以读写：</p> <ol><li><p><font color="red">runtime</font> 循环调用 netpoll() 方法；</p> <blockquote><p>前面分析过了，是 g0 协程在 gc 的时候顺便调用了 netpoll。</p></blockquote></li> <li><p>发现 socket 可读写时，给对应的 rg 或 wg 置为 pdReady(1)；</p></li> <li><p><font color="red">协程</font>调用 poll_runtime_pollWait() 判断 socket 是否就绪；判断 rg 或者 wg 已经置为 <strong>pdReady(1)</strong>，那就返回 0；</p></li> <li><p>runtime 就知道 socket 可以操作了。</p></li></ol></li> <li><p>socket 暂时不可读写：</p> <ol><li><font color="red">runtime</font> 循环调用 netpoll() 方法；</li> <li>netpoll 中没有监听到任何事件，执行不到 netpollready，没有对 pd 做任何改变；</li> <li><font color="red">协程</font>调用 poll_runtime_pollWait() 判断 socket 是否就绪：
<ol><li>判断 rg 或 wg 还是 <strong>nil(0)</strong>，就将 rg 或者 wg 置为 <strong>pdWait(2)</strong>；</li> <li>调用 gopark 将协程进行休眠等待；</li> <li>然后再进入 netpollblockcommit 将 rg 或者 wg 置为 <strong>G pointer</strong>；</li></ol></li> <li>假如 runtime 后面再循环调用 netpoll() 方法；</li> <li>发现 socket 可读写时，进入 netpollready 再检查对应的 rg 或者 wg；</li> <li>netpollready 再进入 netpollunblock，它会检查 rg 或者 wg；</li> <li>若为 <strong>G pointer</strong>，那么就将 rg 或者 wg 置为 <strong>pdReady</strong>，然后返回协程地址给 runtime；</li> <li>runtime 就会去调度对应协程进行 socket 的读写操作。</li></ol></li> <li><p>读写后都会再将 rg 或者 wg 置为 <strong>nil</strong></p></li></ul> <div class="custom-block tip"><p class="custom-block-title">总结</p> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5laualr25j21im0u079y.jpg" alt="image-20220827141814750"></p> <p>Go 的网络操作底层为 <strong>阻塞模型（协程调度） + 多路复用（系统底层）</strong>，具体情况为：</p> <ul><li>BIO：go 协程从网络读取数据，读取失败并且返回<code>syscall.EAGAIN</code> 时，依次调用 <code>waitRead-&gt;runtime_pollWait-&gt;poll_runtime_pollWait-&gt;netpollblock-&gt;gopark</code> 将当前协程挂起。</li> <li>NIO：runtime 的 g0 协程在 gc 的时候会顺便调用 <code>netpoll()</code> 检查 socket 事件是否发生，当 socket 可操作的时候，重新唤醒对应协程，进行调度。</li></ul> <p>具体细节为：</p> <ul><li>runtime
<ol><li>runtime 会一直循环去检查 socket 的可读写状态 —— <code>netpoll()</code></li> <li>然后再看是否有协程在等待对应的 socket：—— <code>netpollready()</code> <ol><li>没有，那就单纯记录 pollDesc；</li> <li>有那就唤醒协程，将 g 加入 toRun 列表，进行调度 —— <code>netpollunblock()</code></li></ol></li></ol></li> <li>goroutine
<ol><li>表明想要操作 socket ——  <code>poll_runtime_pollWait(pd,mode)</code></li> <li>循环检查自己关心的 socket 是否可操作 —— <code>netpollblock()</code> <ol><li>可以操作，goroutine 就会对 socket 进行读或写操作了；</li> <li>不可操作：
<ol><li>就将自己休眠 —— <code>gopark()</code>；</li> <li>将 rg 或 wg 置为自己的地址 —— <code>netpollblockcommit()</code></li></ol></li></ol></li></ol></li></ul></div> <h2 id="_15-7-net-包"><a href="#_15-7-net-包" class="header-anchor">#</a> 15.7 net 包</h2> <ul><li><p>net 包是 go 原生的网络包；</p></li> <li><p>net 包实现了 TCP、UDP、HTTP 等网络操作；</p></li> <li><p>使用 net.Listen() 可以得到 LISTEN 状态的 socket —— listener；</p></li> <li><p>使用 listener.Accept() 可以得到 ESTABLISHED 状态的 socket —— conn；</p></li> <li><p>conn.Read() / Writer() 可以进行读写 socket 的操作；</p></li> <li><p>network poll 作为上述功能的底层支撑；</p> <blockquote><p>本文仅介绍 TCP 相关的部分。</p></blockquote></li></ul> <h3 id="_15-7-1-net-netfd"><a href="#_15-7-1-net-netfd" class="header-anchor">#</a> 15.7.1 net.netFD</h3> <p>netFD 是 Go 中 net 包对 socket 之类的网络文件描述符的抽象。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Network file descriptor.</span>
<span class="token keyword">type</span> netFD <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	pfd poll<span class="token punctuation">.</span>FD

	<span class="token comment">// immutable until Close</span>
	family      <span class="token builtin">int</span>
	sotype      <span class="token builtin">int</span>
	isConnected <span class="token builtin">bool</span> <span class="token comment">// handshake completed or use of association with peer</span>
	net         <span class="token builtin">string</span>
	laddr       Addr
	raddr       Addr
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5ldvdxiy6j21h80i6759.jpg" alt="image-20220827160306264"></p> <h3 id="_15-7-2-net-listen-listenter"><a href="#_15-7-2-net-listen-listenter" class="header-anchor">#</a> 15.7.2 net.Listen() Listenter</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Listen</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Listener<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> lc ListenConfig
	<span class="token keyword">return</span> lc<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> network<span class="token punctuation">,</span> address<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>新建 socket，并执行 bind 操作；</li> <li>新建一个 netFD，它是 net 包对 socket 的详情描述；</li> <li>返回一个 TCPListener 对象，底层是调用了 runtime_pollOpen 方法，将 TCPListener 的 FD 信息加入监听。TCPListener 对象本质是一个 <strong>LISTEN</strong> 状态的 socket。</li></ol> <img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5leaayjlcj20u010zn0e.jpg" alt="image-20220827161726301" style="zoom:50%;"> <h3 id="_15-7-3-listener-accept"><a href="#_15-7-3-listener-accept" class="header-anchor">#</a> 15.7.3 listener.Accept()</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Accept implements the Accept method in the Listener interface; </span>
<span class="token comment">//it waits for the next call and returns a generic Conn.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>TCPListener<span class="token punctuation">)</span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token operator">!</span>l<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>EINVAL
   <span class="token punctuation">}</span>
   c<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>OpError<span class="token punctuation">{</span>Op<span class="token punctuation">:</span> <span class="token string">&quot;accept&quot;</span><span class="token punctuation">,</span> Net<span class="token punctuation">:</span> l<span class="token punctuation">.</span>fd<span class="token punctuation">.</span>net<span class="token punctuation">,</span> Source<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> Addr<span class="token punctuation">:</span> l<span class="token punctuation">.</span>fd<span class="token punctuation">.</span>laddr<span class="token punctuation">,</span> Err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>调用 tcpListener 的 accept，本质上就是调用处于 LISTEN 状态的 socket 的 accept 方法，看看有无新的连接；</li> <li>如果失败，休眠等待新的连接，底层调用了 runtime_pollWait；</li> <li>如果有新的连接，那就包装成一个新的 socket，最后返回为一个 TCPConn 变量，底层是调用了 runtime_pollOpen 方法，将 TCPConn 的 FD 信息加入监听。TCPConn 对象本质是一个 <strong>ESTABLISHED</strong> 状态的 socket。</li></ol> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5lf3th4jjj21cz0u0gpf.jpg" alt="image-20220827164548081"></p> <h3 id="_15-7-4-conn-read-conn-write"><a href="#_15-7-4-conn-read-conn-write" class="header-anchor">#</a> 15.7.4 conn.Read() / conn.Write()</h3> <p>这两个方法原理差不多，下面以 Read() 为例。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Read implements the Conn Read method.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
   n<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
	 <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Read implements io.Reader.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>fd <span class="token operator">*</span>FD<span class="token punctuation">)</span> <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
   <span class="token operator">...</span>
   <span class="token comment">// 循环读数据</span>
   <span class="token keyword">for</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. 调用系统命令 syscall.Read，读取 sysfd 上的数据，然后往 p 写数据</span>
      n<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">ignoringEINTRIO</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>Read<span class="token punctuation">,</span> fd<span class="token punctuation">.</span>Sysfd<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
         n <span class="token operator">=</span> <span class="token number">0</span>
         <span class="token comment">// 2. syscall.EAGAIN 说明还没数据，得先等等</span>
         <span class="token keyword">if</span> err <span class="token operator">==</span> syscall<span class="token punctuation">.</span>EAGAIN <span class="token operator">&amp;&amp;</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">pollable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3. 挂起，休眠等待</span>
            <span class="token keyword">if</span> err <span class="token operator">=</span> fd<span class="token punctuation">.</span>pd<span class="token punctuation">.</span><span class="token function">waitRead</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>isFile<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
               <span class="token comment">// 4. 当有数据来的时候，会被唤醒走到这里，然后在回到 for 循环读取数据</span>
               <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      err <span class="token operator">=</span> fd<span class="token punctuation">.</span><span class="token function">eofError</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token keyword">return</span> n<span class="token punctuation">,</span> err
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>底层直接调用 socket 原生读写方法（syscall.Read、syscall.Write）；</li> <li>成功则直接返回；</li> <li>如果失败，休眠等待可读 / 可写事件的发生；</li> <li>被唤醒后重新调用系统 socket 进行读写；</li></ol> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5lfqryruej21ir0u0n3b.jpg" alt="image-20220827170751948"></p> <h3 id="_15-7-3-net-dialtcp"><a href="#_15-7-3-net-dialtcp" class="header-anchor">#</a> 15.7.3 net.DialTCP()</h3> <p><code>Dial()</code> 方法支持 TCP、UDP、IP、unix、unixgram 和 unixpacket 网络通讯方式，它是一个统共的方法，通过传入 <code>network</code> 字段来区分不同的网络类型，所以它前面很多的操作，都是在判断当前是什么网络类型。本文主要讲 TCP 的实现底层，故直接进入 <code>DialTCP()</code> 即可，其他的网络类型，也是大同小异的。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">DialTCP</span><span class="token punctuation">(</span>network <span class="token builtin">string</span><span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr <span class="token operator">*</span>TCPAddr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TCPConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   
   <span class="token comment">// 1. 看看具体是哪种 tcp 连接</span>
   <span class="token keyword">switch</span> network <span class="token punctuation">{</span>
     <span class="token keyword">case</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tcp4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tcp6&quot;</span><span class="token punctuation">:</span>
     <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>OpError<span class="token punctuation">{</span>Op<span class="token punctuation">:</span> <span class="token string">&quot;dial&quot;</span><span class="token punctuation">,</span> Net<span class="token punctuation">:</span> network<span class="token punctuation">,</span> Source<span class="token punctuation">:</span> laddr<span class="token punctuation">.</span><span class="token function">opAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Addr<span class="token punctuation">:</span> raddr<span class="token punctuation">.</span><span class="token function">opAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Err<span class="token punctuation">:</span> <span class="token function">UnknownNetworkError</span><span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> raddr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>OpError<span class="token punctuation">{</span>Op<span class="token punctuation">:</span> <span class="token string">&quot;dial&quot;</span><span class="token punctuation">,</span> Net<span class="token punctuation">:</span> network<span class="token punctuation">,</span> Source<span class="token punctuation">:</span> laddr<span class="token punctuation">.</span><span class="token function">opAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Addr<span class="token punctuation">:</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> Err<span class="token punctuation">:</span> errMissingAddress<span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 2. 创建一个系统的网络连接工具</span>
   sd <span class="token operator">:=</span> <span class="token operator">&amp;</span>sysDialer<span class="token punctuation">{</span>network<span class="token punctuation">:</span> network<span class="token punctuation">,</span> address<span class="token punctuation">:</span> raddr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
   <span class="token comment">// 3. 进行 TCP 连接</span>
   c<span class="token punctuation">,</span> err <span class="token operator">:=</span> sd<span class="token punctuation">.</span><span class="token function">dialTCP</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr<span class="token punctuation">)</span>
   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>OpError<span class="token punctuation">{</span>Op<span class="token punctuation">:</span> <span class="token string">&quot;dial&quot;</span><span class="token punctuation">,</span> Net<span class="token punctuation">:</span> network<span class="token punctuation">,</span> Source<span class="token punctuation">:</span> laddr<span class="token punctuation">.</span><span class="token function">opAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Addr<span class="token punctuation">:</span> raddr<span class="token punctuation">.</span><span class="token function">opAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Err<span class="token punctuation">:</span> err<span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>sd <span class="token operator">*</span>sysDialer<span class="token punctuation">)</span> <span class="token function">dialTCP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr <span class="token operator">*</span>TCPAddr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TCPConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> testHookDialTCP <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">testHookDialTCP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sd<span class="token punctuation">.</span>network<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// 4. 进入 doDialTCP</span>
   <span class="token keyword">return</span> sd<span class="token punctuation">.</span><span class="token function">doDialTCP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>sd <span class="token operator">*</span>sysDialer<span class="token punctuation">)</span> <span class="token function">doDialTCP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr <span class="token operator">*</span>TCPAddr<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>TCPConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 5. 有了前面的基础，到这就明白了</span>
   <span class="token comment">// internetSocket 创建一个 fd，生成一个新的 socket，并注册到 epoll 中监听</span>
   fd<span class="token punctuation">,</span> err <span class="token operator">:=</span> internetSocket 创建一个 <span class="token function">fd</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> sd<span class="token punctuation">.</span>network<span class="token punctuation">,</span> laddr<span class="token punctuation">,</span> raddr<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;dial&quot;</span><span class="token punctuation">,</span> sd<span class="token punctuation">.</span>Dialer<span class="token punctuation">.</span>Control<span class="token punctuation">)</span>
		<span class="token operator">...</span>
   <span class="token comment">// 6. 返回一个 TCPConn</span>
   <span class="token keyword">return</span> <span class="token function">newTCPConn</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>创建一个系统的网络连接工具 sysDialer；</li> <li>dial 进行 TCP 连接，连接不上那就是 connect refused；</li> <li>连接上的话，创建一个新的 socket，并最后返回为一个 TCPConn 变量，底层是调用了 runtime_pollOpen 方法，将 TCPConn 的 FD 信息加入监听。TCPConn 对象本质是一个 <strong>ESTABLISHED</strong> 状态的 socket。</li></ol> <p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h5lgqvxxivj21nd0u0q67.jpg" alt="image-20220827174234771"></p> <h2 id="_15-8-goroutine-per-connection"><a href="#_15-8-goroutine-per-connection" class="header-anchor">#</a> 15.8 goroutine-per-connection</h2> <p><code>goroutine-per-connection</code> 是一种编程思想，需要开发者自主实现。在 Go 的开发中，我们即希望利用底层多路复用 IO，来支持高并发高性能的 IO 操作。我们又希望编码可以简单些，于是我们可以利用 Go 的协程调度来实现类似阻塞 IO 的方式，一个协程负责一个 socket。</p> <p>即：阻塞模型（协程调度） + 多路复用（系统底层），兼顾性能与简洁。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	listener<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;:8888&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
  <span class="token comment">// always accpet</span>
	<span class="token keyword">for</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> listener<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;error occured: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// goroutine per connection</span>
		<span class="token keyword">go</span> <span class="token function">handleAccept</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">handleAccept</span><span class="token punctuation">(</span>conn net<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> body <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token keyword">for</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>body<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/27/2022, 5:58:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/golang/03-advance/14-channel.html" class="prev">
        14. channel
      </a></span> <span class="next"><a href="/noteSite/backend/golang/03-advance/16-memory.html">
        16. 内存模型
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.bcda4898.js" defer></script><script src="/noteSite/assets/js/2.6ff1f0ac.js" defer></script><script src="/noteSite/assets/js/47.3e3893e2.js" defer></script>
  </body>
</html>
