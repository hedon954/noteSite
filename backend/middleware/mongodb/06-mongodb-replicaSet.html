<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hedon</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/noteSite/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/noteSite/assets/css/0.styles.0f3b0cbd.css" as="style"><link rel="preload" href="/noteSite/assets/js/app.a267b983.js" as="script"><link rel="preload" href="/noteSite/assets/js/2.691adf44.js" as="script"><link rel="preload" href="/noteSite/assets/js/82.1add1f8b.js" as="script"><link rel="prefetch" href="/noteSite/assets/js/10.fb6e2fc9.js"><link rel="prefetch" href="/noteSite/assets/js/100.6bfbbd9f.js"><link rel="prefetch" href="/noteSite/assets/js/101.ea1e0e3c.js"><link rel="prefetch" href="/noteSite/assets/js/102.e1301430.js"><link rel="prefetch" href="/noteSite/assets/js/103.87a19cde.js"><link rel="prefetch" href="/noteSite/assets/js/104.693efe2a.js"><link rel="prefetch" href="/noteSite/assets/js/105.9bb09dc0.js"><link rel="prefetch" href="/noteSite/assets/js/106.ea3f390c.js"><link rel="prefetch" href="/noteSite/assets/js/107.800187cc.js"><link rel="prefetch" href="/noteSite/assets/js/108.76344368.js"><link rel="prefetch" href="/noteSite/assets/js/109.aa3975ef.js"><link rel="prefetch" href="/noteSite/assets/js/11.c8c52c63.js"><link rel="prefetch" href="/noteSite/assets/js/110.a95d0c94.js"><link rel="prefetch" href="/noteSite/assets/js/111.bd1b4637.js"><link rel="prefetch" href="/noteSite/assets/js/112.d40cdac8.js"><link rel="prefetch" href="/noteSite/assets/js/113.eb01895e.js"><link rel="prefetch" href="/noteSite/assets/js/114.e1d1bb02.js"><link rel="prefetch" href="/noteSite/assets/js/115.c6476a71.js"><link rel="prefetch" href="/noteSite/assets/js/116.53b0aaac.js"><link rel="prefetch" href="/noteSite/assets/js/117.2fc05eab.js"><link rel="prefetch" href="/noteSite/assets/js/118.0ef6bb30.js"><link rel="prefetch" href="/noteSite/assets/js/119.0eeb22ab.js"><link rel="prefetch" href="/noteSite/assets/js/12.18d29461.js"><link rel="prefetch" href="/noteSite/assets/js/120.d8b8e4c4.js"><link rel="prefetch" href="/noteSite/assets/js/121.7016cb87.js"><link rel="prefetch" href="/noteSite/assets/js/122.15902f3b.js"><link rel="prefetch" href="/noteSite/assets/js/123.82953c9e.js"><link rel="prefetch" href="/noteSite/assets/js/124.b868d571.js"><link rel="prefetch" href="/noteSite/assets/js/125.9287d2f5.js"><link rel="prefetch" href="/noteSite/assets/js/126.03de7492.js"><link rel="prefetch" href="/noteSite/assets/js/127.99d4a875.js"><link rel="prefetch" href="/noteSite/assets/js/128.a42496a0.js"><link rel="prefetch" href="/noteSite/assets/js/129.3030bfc9.js"><link rel="prefetch" href="/noteSite/assets/js/13.08211613.js"><link rel="prefetch" href="/noteSite/assets/js/130.e5e3f924.js"><link rel="prefetch" href="/noteSite/assets/js/131.90540a74.js"><link rel="prefetch" href="/noteSite/assets/js/132.1b1f6c69.js"><link rel="prefetch" href="/noteSite/assets/js/133.9d75be5e.js"><link rel="prefetch" href="/noteSite/assets/js/134.f054a786.js"><link rel="prefetch" href="/noteSite/assets/js/135.a4cac5e4.js"><link rel="prefetch" href="/noteSite/assets/js/136.ab6f7e84.js"><link rel="prefetch" href="/noteSite/assets/js/137.8921ebaa.js"><link rel="prefetch" href="/noteSite/assets/js/138.70d41df2.js"><link rel="prefetch" href="/noteSite/assets/js/139.f8d512d3.js"><link rel="prefetch" href="/noteSite/assets/js/14.07f62b45.js"><link rel="prefetch" href="/noteSite/assets/js/140.ccb9ee7c.js"><link rel="prefetch" href="/noteSite/assets/js/141.9b6d5c35.js"><link rel="prefetch" href="/noteSite/assets/js/142.375bbe9f.js"><link rel="prefetch" href="/noteSite/assets/js/143.a06cf061.js"><link rel="prefetch" href="/noteSite/assets/js/144.36e908c6.js"><link rel="prefetch" href="/noteSite/assets/js/145.904d3ef1.js"><link rel="prefetch" href="/noteSite/assets/js/146.a7a111c7.js"><link rel="prefetch" href="/noteSite/assets/js/147.f4154cf3.js"><link rel="prefetch" href="/noteSite/assets/js/148.c31fe065.js"><link rel="prefetch" href="/noteSite/assets/js/149.fd5c8a5d.js"><link rel="prefetch" href="/noteSite/assets/js/15.2b6ee04e.js"><link rel="prefetch" href="/noteSite/assets/js/150.a6454c6e.js"><link rel="prefetch" href="/noteSite/assets/js/151.78d0ad9c.js"><link rel="prefetch" href="/noteSite/assets/js/152.8d029e9d.js"><link rel="prefetch" href="/noteSite/assets/js/153.c7ee05d7.js"><link rel="prefetch" href="/noteSite/assets/js/154.e7e65f08.js"><link rel="prefetch" href="/noteSite/assets/js/155.7c71fa58.js"><link rel="prefetch" href="/noteSite/assets/js/156.dc45eef8.js"><link rel="prefetch" href="/noteSite/assets/js/157.281523da.js"><link rel="prefetch" href="/noteSite/assets/js/158.b5272c42.js"><link rel="prefetch" href="/noteSite/assets/js/159.1352118f.js"><link rel="prefetch" href="/noteSite/assets/js/16.7ab703a2.js"><link rel="prefetch" href="/noteSite/assets/js/160.d2444132.js"><link rel="prefetch" href="/noteSite/assets/js/161.8741a6ef.js"><link rel="prefetch" href="/noteSite/assets/js/162.7bd10cd9.js"><link rel="prefetch" href="/noteSite/assets/js/163.e649c188.js"><link rel="prefetch" href="/noteSite/assets/js/164.1c10a45f.js"><link rel="prefetch" href="/noteSite/assets/js/165.5dd3f976.js"><link rel="prefetch" href="/noteSite/assets/js/166.dd9ed452.js"><link rel="prefetch" href="/noteSite/assets/js/167.3a041ed2.js"><link rel="prefetch" href="/noteSite/assets/js/168.858a5c53.js"><link rel="prefetch" href="/noteSite/assets/js/169.7f0a3aea.js"><link rel="prefetch" href="/noteSite/assets/js/17.3d6b3528.js"><link rel="prefetch" href="/noteSite/assets/js/170.974554d2.js"><link rel="prefetch" href="/noteSite/assets/js/171.c796bf41.js"><link rel="prefetch" href="/noteSite/assets/js/172.e272a176.js"><link rel="prefetch" href="/noteSite/assets/js/173.35e46c0d.js"><link rel="prefetch" href="/noteSite/assets/js/174.1ebd7975.js"><link rel="prefetch" href="/noteSite/assets/js/175.a2a7b267.js"><link rel="prefetch" href="/noteSite/assets/js/176.7fc95ba6.js"><link rel="prefetch" href="/noteSite/assets/js/177.44a20713.js"><link rel="prefetch" href="/noteSite/assets/js/178.6f51f1e3.js"><link rel="prefetch" href="/noteSite/assets/js/179.836a69a9.js"><link rel="prefetch" href="/noteSite/assets/js/18.920cb685.js"><link rel="prefetch" href="/noteSite/assets/js/180.bacaf898.js"><link rel="prefetch" href="/noteSite/assets/js/181.c9853f57.js"><link rel="prefetch" href="/noteSite/assets/js/182.c4691e95.js"><link rel="prefetch" href="/noteSite/assets/js/183.8658339c.js"><link rel="prefetch" href="/noteSite/assets/js/184.00438e69.js"><link rel="prefetch" href="/noteSite/assets/js/185.1d421add.js"><link rel="prefetch" href="/noteSite/assets/js/186.9d86eac6.js"><link rel="prefetch" href="/noteSite/assets/js/187.f8fbb2f0.js"><link rel="prefetch" href="/noteSite/assets/js/188.8af03e8c.js"><link rel="prefetch" href="/noteSite/assets/js/189.164eb875.js"><link rel="prefetch" href="/noteSite/assets/js/19.7e79d0e6.js"><link rel="prefetch" href="/noteSite/assets/js/190.8a2dc4f5.js"><link rel="prefetch" href="/noteSite/assets/js/191.718b87f4.js"><link rel="prefetch" href="/noteSite/assets/js/192.47bd179a.js"><link rel="prefetch" href="/noteSite/assets/js/193.81ad3bd2.js"><link rel="prefetch" href="/noteSite/assets/js/194.efaee2ed.js"><link rel="prefetch" href="/noteSite/assets/js/195.fc1263a2.js"><link rel="prefetch" href="/noteSite/assets/js/196.89fd4d1e.js"><link rel="prefetch" href="/noteSite/assets/js/197.a453ece5.js"><link rel="prefetch" href="/noteSite/assets/js/198.b7369d7d.js"><link rel="prefetch" href="/noteSite/assets/js/199.da40f892.js"><link rel="prefetch" href="/noteSite/assets/js/20.08e969da.js"><link rel="prefetch" href="/noteSite/assets/js/200.08b37d44.js"><link rel="prefetch" href="/noteSite/assets/js/201.ba15c6ed.js"><link rel="prefetch" href="/noteSite/assets/js/202.9fbe065a.js"><link rel="prefetch" href="/noteSite/assets/js/203.fc190649.js"><link rel="prefetch" href="/noteSite/assets/js/204.2974cc72.js"><link rel="prefetch" href="/noteSite/assets/js/205.a91d248c.js"><link rel="prefetch" href="/noteSite/assets/js/21.0f5e752e.js"><link rel="prefetch" href="/noteSite/assets/js/22.441bc82c.js"><link rel="prefetch" href="/noteSite/assets/js/23.137ee52c.js"><link rel="prefetch" href="/noteSite/assets/js/24.1640db4c.js"><link rel="prefetch" href="/noteSite/assets/js/25.09fae025.js"><link rel="prefetch" href="/noteSite/assets/js/26.1f4b9c45.js"><link rel="prefetch" href="/noteSite/assets/js/27.28e3df64.js"><link rel="prefetch" href="/noteSite/assets/js/28.a662f3da.js"><link rel="prefetch" href="/noteSite/assets/js/29.9ffd706d.js"><link rel="prefetch" href="/noteSite/assets/js/3.569e38a8.js"><link rel="prefetch" href="/noteSite/assets/js/30.8ab39f0e.js"><link rel="prefetch" href="/noteSite/assets/js/31.9f2ce52a.js"><link rel="prefetch" href="/noteSite/assets/js/32.e91b24e8.js"><link rel="prefetch" href="/noteSite/assets/js/33.84858f62.js"><link rel="prefetch" href="/noteSite/assets/js/34.430255a3.js"><link rel="prefetch" href="/noteSite/assets/js/35.01e59039.js"><link rel="prefetch" href="/noteSite/assets/js/36.4eec506d.js"><link rel="prefetch" href="/noteSite/assets/js/37.22cb6c0d.js"><link rel="prefetch" href="/noteSite/assets/js/38.5e902c68.js"><link rel="prefetch" href="/noteSite/assets/js/39.5436193a.js"><link rel="prefetch" href="/noteSite/assets/js/4.a61e4cea.js"><link rel="prefetch" href="/noteSite/assets/js/40.97578d32.js"><link rel="prefetch" href="/noteSite/assets/js/41.edc1ac35.js"><link rel="prefetch" href="/noteSite/assets/js/42.0d758d73.js"><link rel="prefetch" href="/noteSite/assets/js/43.97140e9b.js"><link rel="prefetch" href="/noteSite/assets/js/44.27e3ca91.js"><link rel="prefetch" href="/noteSite/assets/js/45.9cc78c82.js"><link rel="prefetch" href="/noteSite/assets/js/46.4b85b5bc.js"><link rel="prefetch" href="/noteSite/assets/js/47.5bfff6e6.js"><link rel="prefetch" href="/noteSite/assets/js/48.3035b015.js"><link rel="prefetch" href="/noteSite/assets/js/49.1d1230b8.js"><link rel="prefetch" href="/noteSite/assets/js/5.2bccd6df.js"><link rel="prefetch" href="/noteSite/assets/js/50.ff934a4d.js"><link rel="prefetch" href="/noteSite/assets/js/51.1f20694e.js"><link rel="prefetch" href="/noteSite/assets/js/52.55b0f39a.js"><link rel="prefetch" href="/noteSite/assets/js/53.214e234c.js"><link rel="prefetch" href="/noteSite/assets/js/54.ae0d8e55.js"><link rel="prefetch" href="/noteSite/assets/js/55.73ad7f4b.js"><link rel="prefetch" href="/noteSite/assets/js/56.4119ac1f.js"><link rel="prefetch" href="/noteSite/assets/js/57.6b0cd9d1.js"><link rel="prefetch" href="/noteSite/assets/js/58.4d7f55fa.js"><link rel="prefetch" href="/noteSite/assets/js/59.d4645e2a.js"><link rel="prefetch" href="/noteSite/assets/js/6.f3d86aa7.js"><link rel="prefetch" href="/noteSite/assets/js/60.bdab7ec9.js"><link rel="prefetch" href="/noteSite/assets/js/61.cb2968fd.js"><link rel="prefetch" href="/noteSite/assets/js/62.c3edc28f.js"><link rel="prefetch" href="/noteSite/assets/js/63.8e1cfd74.js"><link rel="prefetch" href="/noteSite/assets/js/64.b4f28835.js"><link rel="prefetch" href="/noteSite/assets/js/65.6fccd2ec.js"><link rel="prefetch" href="/noteSite/assets/js/66.efd1bd90.js"><link rel="prefetch" href="/noteSite/assets/js/67.d666fa08.js"><link rel="prefetch" href="/noteSite/assets/js/68.c9892b4c.js"><link rel="prefetch" href="/noteSite/assets/js/69.dde052f6.js"><link rel="prefetch" href="/noteSite/assets/js/7.da9921ea.js"><link rel="prefetch" href="/noteSite/assets/js/70.281d05cc.js"><link rel="prefetch" href="/noteSite/assets/js/71.a9d85afc.js"><link rel="prefetch" href="/noteSite/assets/js/72.1c5c3a9a.js"><link rel="prefetch" href="/noteSite/assets/js/73.867866a4.js"><link rel="prefetch" href="/noteSite/assets/js/74.4bc19442.js"><link rel="prefetch" href="/noteSite/assets/js/75.16e92168.js"><link rel="prefetch" href="/noteSite/assets/js/76.86937257.js"><link rel="prefetch" href="/noteSite/assets/js/77.f4ad26d2.js"><link rel="prefetch" href="/noteSite/assets/js/78.ca7ad444.js"><link rel="prefetch" href="/noteSite/assets/js/79.34351ee1.js"><link rel="prefetch" href="/noteSite/assets/js/8.8a4cb7ae.js"><link rel="prefetch" href="/noteSite/assets/js/80.b8a75c4a.js"><link rel="prefetch" href="/noteSite/assets/js/81.034c7b6c.js"><link rel="prefetch" href="/noteSite/assets/js/83.6ff6392d.js"><link rel="prefetch" href="/noteSite/assets/js/84.87941616.js"><link rel="prefetch" href="/noteSite/assets/js/85.da9b7db6.js"><link rel="prefetch" href="/noteSite/assets/js/86.92df1bf4.js"><link rel="prefetch" href="/noteSite/assets/js/87.0b6ca2a3.js"><link rel="prefetch" href="/noteSite/assets/js/88.96d4f08b.js"><link rel="prefetch" href="/noteSite/assets/js/89.5b6f6d3e.js"><link rel="prefetch" href="/noteSite/assets/js/9.68444ec6.js"><link rel="prefetch" href="/noteSite/assets/js/90.326effc7.js"><link rel="prefetch" href="/noteSite/assets/js/91.e8b6e101.js"><link rel="prefetch" href="/noteSite/assets/js/92.a2a1328c.js"><link rel="prefetch" href="/noteSite/assets/js/93.686b1a6d.js"><link rel="prefetch" href="/noteSite/assets/js/94.1fef0753.js"><link rel="prefetch" href="/noteSite/assets/js/95.1a48d6d4.js"><link rel="prefetch" href="/noteSite/assets/js/96.9e50a8cd.js"><link rel="prefetch" href="/noteSite/assets/js/97.2f78cc82.js"><link rel="prefetch" href="/noteSite/assets/js/98.743f19a0.js"><link rel="prefetch" href="/noteSite/assets/js/99.e60c1ca5.js">
    <link rel="stylesheet" href="/noteSite/assets/css/0.styles.0f3b0cbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/noteSite/" class="home-link router-link-active"><img src="/noteSite/images/hedon.png" alt="Hedon" class="logo"> <span class="site-name can-hide">Hedon</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link router-link-active">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/noteSite/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/noteSite/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CS Menu" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="CS Menu" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/cs/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/cn/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/cs/component/" class="nav-link">
  计算机组成原理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Backend Menu" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="Backend Menu" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/noteSite/backend/java/" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/golang/" class="nav-link">
  Golang
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/go-full/" class="nav-link">
  Go 开发工程师
</a></li><li class="dropdown-item"><!----> <a href="/noteSite/backend/middleware/" class="nav-link router-link-active">
  中间件
</a></li></ul></div></div><div class="nav-item"><a href="/noteSite/frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/noteSite/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/noteSite/mac/" class="nav-link">
  Mac
</a></div><div class="nav-item"><a href="/noteSite/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/noteSite/paper/" class="nav-link">
  Paper
</a></div><div class="nav-item"><a href="https://github.com/hedon954/noteSite" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis 实战</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MongoDB</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/noteSite/backend/middleware/mongodb/01-mongodb-intro.html" class="sidebar-link">一、MongoDB 快速入门</a></li><li><a href="/noteSite/backend/middleware/mongodb/02-mongodb-install.html" class="sidebar-link">二、MongoDB 单机部署</a></li><li><a href="/noteSite/backend/middleware/mongodb/03-mongodb-crud.html" class="sidebar-link">三、MongoDB CRUD</a></li><li><a href="/noteSite/backend/middleware/mongodb/04-mongodb-aggregation.html" class="sidebar-link">四、MongoDB 聚合</a></li><li><a href="/noteSite/backend/middleware/mongodb/05-mongodb-index.html" class="sidebar-link">五、MongoDB 索引</a></li><li><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html" aria-current="page" class="active sidebar-link">/backend/middleware/mongodb/06-mongodb-replicaSet.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_1-复制目标" class="sidebar-link">1. 复制目标</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_2-复制基础" class="sidebar-link">2. 复制基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_2-1-复制集" class="sidebar-link">2.1 复制集</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_2-2-主服务器" class="sidebar-link">2.2 主服务器</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_2-3-辅助服务器" class="sidebar-link">2.3 辅助服务器</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_2-4-仲裁服务器" class="sidebar-link">2.4 仲裁服务器</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_3-oplog" class="sidebar-link">3. oplog</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-复制集搭建" class="sidebar-link">4. 复制集搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-1-创建-docker-network" class="sidebar-link">4.1 创建 docker network</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-2-启动-3-个-mongod" class="sidebar-link">4.2 启动 3 个 mongod</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-3-创建复制集" class="sidebar-link">4.3 创建复制集</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-4-向复制集中添加服务器" class="sidebar-link">4.4 向复制集中添加服务器</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-5-向复制集中移除服务器" class="sidebar-link">4.5 向复制集中移除服务器</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-6-配置复制集" class="sidebar-link">4.6 配置复制集</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_4-7-向复制集中添加仲裁服务器" class="sidebar-link">4.7 向复制集中添加仲裁服务器</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_5-复制集命令" class="sidebar-link">5. 复制集命令</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_6-复制集数据同步原理" class="sidebar-link">6. 复制集数据同步原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_6-1-initial-sync" class="sidebar-link">6.1 initial_sync</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_6-2-steady-sync" class="sidebar-link">6.2 steady_sync</a></li></ul></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_7-复制集选举原理" class="sidebar-link">7. 复制集选举原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_7-1-主节点降级" class="sidebar-link">7.1 主节点降级</a></li><li class="sidebar-sub-header"><a href="/noteSite/backend/middleware/mongodb/06-mongodb-replicaSet.html#_7-2-选举主节点" class="sidebar-link">7.2 选举主节点</a></li></ul></li></ul></li><li><a href="/noteSite/backend/middleware/mongodb/07-mongodb-sharding.html" class="sidebar-link">七、MongoDB 数据分片</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>MongoDB 复制集</p> <p>如同许多关系型数据库一样，MongoDB 支持以实时或准实时的方式，将数据内容复制到另一台服务器中。</p> <h2 id="_1-复制目标"><a href="#_1-复制目标" class="header-anchor">#</a> 1. 复制目标</h2> <ul><li>提高可扩展性
<ul><li>提高冗余度</li> <li>改善性能</li></ul></li> <li>改善持久性/可靠性</li> <li>提供隔离性</li></ul> <h2 id="_2-复制基础"><a href="#_2-复制基础" class="header-anchor">#</a> 2. 复制基础</h2> <blockquote><ul><li>主动成员：有数据，可以投票，可能成为主服务器</li> <li>主服务器：负责读写</li> <li>辅助服务器：负责读</li> <li>被动成员：有数据，可以投票，不会成为主服务器</li> <li>仲裁成员：无数据，可以投票，不会成为主服务器</li></ul></blockquote> <h3 id="_2-1-复制集"><a href="#_2-1-复制集" class="header-anchor">#</a> 2.1 复制集</h3> <p>在 MongoDB 中，复制集由一个主节点以及许多辅助节点或仲裁节点组成。复制集需要大量的主动成员才能维护主服务器。因此最少应该有 3 个成员。通常的建议是有奇数个成员。在 MongoDB 3.0 中，复制集最多可以有 50 个被动成员和 7 个主动成员。这条规则主要是为了避免“脑裂”问题，也就是当网络出现问题时，有两台服务器称为主服务器的情况，如下图所示：</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx4hji3lngj316c0naabt.jpg" alt="image-20211206223244525"></p> <div class="custom-block tip"><p class="custom-block-title">脑裂</p> <p>在 HA 集群系统中，假设有同一个整体、动作协调的节点 A 和节点 B，节点 A 和 B 之间通过 heartBeat 来检查对方的存活状态，负责协调保证整个集群服务的可用性。</p> <p>正常情况下，如果节点 A 通过心跳检测不到 B 的存在的时候，就会接管 B 的资源，同理节点 B 检查不到 A 的存活状态的时候也会接管 A 的资源。如果出现网络故障，就会导致 A 和 B 同时检查不到对方的存活状态认为对方出现异常，这个时候就会导致 A 接管 B 的资源，B 也会接管 A 的资源。原来被一个节点访问的资源就会出现被多个节点同时访问的情况，这种情况就是脑裂现象。</p></div> <h3 id="_2-2-主服务器"><a href="#_2-2-主服务器" class="header-anchor">#</a> 2.2 主服务器</h3> <ul><li>复制集的数据来源；</li> <li>数据集中唯一用来写入的节点；</li></ul> <h3 id="_2-3-辅助服务器"><a href="#_2-3-辅助服务器" class="header-anchor">#</a> 2.3 辅助服务器</h3> <ul><li>具有数据的非主服务器成员，理论上可以成为主服务器；</li> <li>用于读取数据；</li> <li>以尽可能接近于实时的方式从主服务器复制数据；</li> <li>默认情况下，如果连接到辅助服务器但不使用任何读取偏好，就不能执行读操作，因为复制有延迟，读到的可能是旧数据。可以使用 <code>rs.slaveOK()</code> 将当前连接设置为可以从辅助服务器读取数据；</li></ul> <h3 id="_2-4-仲裁服务器"><a href="#_2-4-仲裁服务器" class="header-anchor">#</a> 2.4 仲裁服务器</h3> <ul><li><p>不含数据；</p></li> <li><p>如果复制集中的主动成员数是偶数，它就用于提供额外的主动成员。它不会投出决定性的一票或者直接决定哪个节点是主服务器，但会参与并作为主动成员中的一员，决定哪个节点成员主服务器；</p></li> <li><p>仲裁服务器用于帮助避免“脑裂”问题。如下图：</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx4i0i5xtfj316u0p040n.jpg" alt="image-20211206224909028"></p> <p>有了站点 A 中的仲裁服务器，我们总是可以在某一边成立完成大多数服务器的投票选举。这意味着当网络出现问题时，不会出现两个主服务器。</p> <p>我们可以进一步增加冗余性，在第 3 个站点 C 中添加一个仲裁服务器。这样如果站点 A 宕机，站点 B 和 C 仍然可以成功完成投票选举。通过以这种方式使用第 3 个站点，哪怕失去任何一个站点的连接，服务器都可以正常运行。</p></li></ul> <h2 id="_3-oplog"><a href="#_3-oplog" class="header-anchor">#</a> 3. oplog</h2> <p>oplog（操作日志）就是一个固定大小的集合，保存了主服务器实例对数据库做出修改的记录，目的是在辅助服务器上重做这些操作，保证数据库处于一致状态；服务器的每个成员都将维护自己的 oplog，并且辅助服务器将查询主服务器（或者通过复制链进行其他数据更新的辅助服务器）的 oplog，从而获得新条目，并应用到自己的数据副本中。</p> <p>oplog 将为每个条目创建一个时间戳。通过这种方式，辅助服务器可以记录从上一次读取开始过去了多久，以及有多少 oplog 需要读取。如果终止辅助服务器并在较短的时间内重启它，它将从主服务器的 oplog 中读取在它离线的时间内所发生的所有修改。</p> <p>因为具有一个无限大的 oplog 是不现实的，所以 oplog 通过具有固定的大小。</p> <p>可将 oplog 看成主服务器最近活动的窗口：如果窗口太小，那么记录中的某些操作在被应用到辅助服务器之前将丢失。如果当前实例的 oplog 尚未创建，那么使用 <code>--oplogSize</code> 启动选项可以设置 oplog 的代下（以  MB 为单位）。在 linux 和 Window64 系统中，<code>oplogSize</code> 默认设置为可用磁盘空间的 5%，最小位 1GB，最大为 50GB。如果系统是写入/更新密集型的，那么可能需要增加该大小，以保证辅助服务器在合理的时间范围内处于离线状态而不会丢失数据。</p> <p>例如，如果需要从辅助服务器执行日常备份，这个任务需要花费一个小时，那么 oplog 的大小将不得不被重新设置，该大小应该允许辅助服务器离线一个小时再加上一定的安全边际时间。</p> <p>通过执行 <code>db.printReplicationInfo()</code> 命令可以得到一些 oplog 大小方面的参考，该命令将运行在主服务器上。</p> <h2 id="_4-复制集搭建"><a href="#_4-复制集搭建" class="header-anchor">#</a> 4. 复制集搭建</h2> <blockquote><p>Docker</p> <ul><li>创建复制集</li> <li>向复制集中添加服务器</li> <li>向复制集中删除服务器</li> <li>配置复制集</li> <li>向复制集中添加仲裁服务器</li></ul></blockquote> <h3 id="_4-1-创建-docker-network"><a href="#_4-1-创建-docker-network" class="header-anchor">#</a> 4.1 创建 docker network</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>docker network create mynetwork
</code></pre></div><h3 id="_4-2-启动-3-个-mongod"><a href="#_4-2-启动-3-个-mongod" class="header-anchor">#</a> 4.2 启动 3 个 mongod</h3> <div class="language-sh extra-class"><pre class="language-sh"><code>docker run --net mynetwork --name mongo1 -v <span class="token environment constant">$HOME</span>/mymongo/data1:/data/db -p <span class="token number">27017</span>:27017 -d mongo:4 --replSet myset --port <span class="token number">27017</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>docker run --net mynetwork --name mongo2 -v <span class="token environment constant">$HOME</span>/mymongo/data2:/data/db -p <span class="token number">27018</span>:27018 -d mongo:4 --replSet myset --port <span class="token number">27018</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>docker run --net mynetwork --name mongo3 -v <span class="token environment constant">$HOME</span>/mymongo/data3:/data/db -p <span class="token number">27019</span>:27019 -d mongo:4 --replSet myset --port <span class="token number">27019</span>
</code></pre></div><ul><li><code>--net</code>: 指定 Docker 网络，这样不同容器才可以进行连接</li> <li><code>--replSet</code>: 声明复制集名字</li> <li><code>--port</code>: 指定 mongod 启动的端口</li> <li><code>-p</code>: 指定容器与主机的端口映射</li></ul> <h3 id="_4-3-创建复制集"><a href="#_4-3-创建复制集" class="header-anchor">#</a> 4.3 创建复制集</h3> <ol><li><p>启动 mongo1</p> <div class="language-sh extra-class"><pre class="language-sh"><code>docker <span class="token builtin class-name">exec</span> -it mongo1 mongo
</code></pre></div></li> <li><p>使用 <code>rs.initiate()</code> 初始化复制集中的第一个成员，创建它的 oplog 和默认的配置文档</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>输出：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">{</span>
	<span class="token string">&quot;info2&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;no configuration specified. Using a default configuration for the set&quot;</span>,
	<span class="token string">&quot;me&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2b6433ebe83c:27017&quot;</span>,
	<span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><p>也可以直接用 <code>rs.initiate()</code> 来直接将 3 个 mongod 绑定到 myset 复制集中，如下</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.initiate<span class="token punctuation">(</span>
	<span class="token punctuation">{</span>
		id: <span class="token string">&quot;myset&quot;</span>,
		members: <span class="token punctuation">[</span>
			<span class="token punctuation">{</span>_id: <span class="token number">0</span>, host: <span class="token string">&quot;mongo1: 27017&quot;</span><span class="token punctuation">}</span>,
			<span class="token punctuation">{</span>_id: <span class="token number">1</span>, host: <span class="token string">&quot;mongo2: 27018&quot;</span><span class="token punctuation">}</span>,
			<span class="token punctuation">{</span>_id: <span class="token number">2</span>, host: <span class="token string">&quot;mongo3: 27019&quot;</span><span class="token punctuation">}</span>
		<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>为了演示添加复制集成员，本次实验没有如此运行。</p></li> <li><p>检查复制集状态</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>输出：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">{</span>
	<span class="token string">&quot;set&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;myset&quot;</span>,
	<span class="token string">&quot;heartbeatIntervalMillis&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,   <span class="token comment"># 默认心跳间隙为 2s</span>
	<span class="token comment"># 省略...</span>
	<span class="token comment"># 复制集成员</span>
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2b6433ebe83c:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PRIMARY&quot;</span>,
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">535</span>,
		<span class="token comment"># 省略...</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
	<span class="token comment"># 省略...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这输出表示没有问题，已经成功配置、创建和初始化一个新的复制集 myset 了。</p></li></ol> <h3 id="_4-4-向复制集中添加服务器"><a href="#_4-4-向复制集中添加服务器" class="header-anchor">#</a> 4.4 向复制集中添加服务器</h3> <ol><li><p>使用 <code>rs.add()</code> 命令并提供实例的主机名和端口来添加</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.add<span class="token punctuation">(</span><span class="token string">&quot;mongo2:27018&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>输出：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">{</span>
	<span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
	<span class="token string">&quot;<span class="token variable">$clusterTime</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;clusterTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1638846493</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
		<span class="token string">&quot;signature&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;hash&quot;</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;keyId&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>,
	<span class="token string">&quot;operationTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1638846493</span>, <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>再使用 <code>rs.status()</code> 看复制集状态</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">{</span>
	<span class="token string">&quot;set&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;myset&quot;</span>,
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2b6433ebe83c:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PRIMARY&quot;</span>,
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;mongo2:27018&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>,
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>PRIMARY</code>: 主服务器</li> <li><code>SECONDARY</code>: 辅助服务器</li></ul></li> <li><p>再添加第三个 mongod</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.add<span class="token punctuation">(</span><span class="token string">&quot;mongo3:27019&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>输出同上。</p></li></ol> <h3 id="_4-5-向复制集中移除服务器"><a href="#_4-5-向复制集中移除服务器" class="header-anchor">#</a> 4.5 向复制集中移除服务器</h3> <p>这里我们使用 <code>rs.remove(&quot;hostname:port&quot;)</code> 将 mongo3 移除</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.remove<span class="token punctuation">(</span><span class="token string">&quot;mongo3:27019&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-6-配置复制集"><a href="#_4-6-配置复制集" class="header-anchor">#</a> 4.6 配置复制集</h3> <ol><li><p>使用 <code>rs.conf()</code> 获取复制集配置文档</p> <div class="language-sh extra-class"><pre class="language-sh"><code>conf <span class="token operator">=</span> rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>输出：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">{</span>
	<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;myset&quot;</span>,
	<span class="token string">&quot;version&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,
	<span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
	<span class="token string">&quot;protocolVersion&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;writeConcernMajorityJournalDefault&quot;</span> <span class="token builtin class-name">:</span> true,
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
			<span class="token string">&quot;host&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2b6433ebe83c:27017&quot;</span>,
			<span class="token string">&quot;arbiterOnly&quot;</span> <span class="token builtin class-name">:</span> false,
			<span class="token string">&quot;buildIndexes&quot;</span> <span class="token builtin class-name">:</span> true,
			<span class="token string">&quot;hidden&quot;</span> <span class="token builtin class-name">:</span> false,
			<span class="token string">&quot;priority&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;tags&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

			<span class="token punctuation">}</span>,
			<span class="token string">&quot;slaveDelay&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;votes&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;host&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;mongo2:27018&quot;</span>,
			<span class="token string">&quot;arbiterOnly&quot;</span> <span class="token builtin class-name">:</span> false,
			<span class="token string">&quot;buildIndexes&quot;</span> <span class="token builtin class-name">:</span> true,
			<span class="token string">&quot;hidden&quot;</span> <span class="token builtin class-name">:</span> false,
			<span class="token string">&quot;priority&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;tags&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

			<span class="token punctuation">}</span>,
			<span class="token string">&quot;slaveDelay&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;votes&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
	<span class="token string">&quot;settings&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;chainingAllowed&quot;</span> <span class="token builtin class-name">:</span> true,
		<span class="token string">&quot;heartbeatIntervalMillis&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2000</span>,
		<span class="token string">&quot;heartbeatTimeoutSecs&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">10</span>,
		<span class="token string">&quot;electionTimeoutMillis&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">10000</span>,
		<span class="token string">&quot;catchUpTimeoutMillis&quot;</span> <span class="token builtin class-name">:</span> -1,
		<span class="token string">&quot;catchUpTakeoverDelayMillis&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">30000</span>,
		<span class="token string">&quot;getLastErrorModes&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>

		<span class="token punctuation">}</span>,
		<span class="token string">&quot;getLastErrorDefaults&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;w&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;wtimeout&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;replicaSetId&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;61aece806b7c62feba73e982&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>memebers</code> 就是复制集成员的详细信息了。</p></li> <li><p>我们来修改 <code>members[1]</code>， 将其设置为隐藏（hidden: true），并且优先级为 0（priority: 0），这样它就不会被选举为主服务器了，运行</p> <div class="language-sh extra-class"><pre class="language-sh"><code>conf.members<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>.hidden <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>conf.members<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>.priority <span class="token operator">=</span> <span class="token number">0</span>
</code></pre></div></li> <li><p>使用 <code>rs.reconfig(conf)</code> 刷新配置</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.reconfig<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
</code></pre></div></li></ol> <h3 id="_4-7-向复制集中添加仲裁服务器"><a href="#_4-7-向复制集中添加仲裁服务器" class="header-anchor">#</a> 4.7 向复制集中添加仲裁服务器</h3> <ol><li><p>使用 <code>rs.addArb(&quot;hostname:port&quot;)</code> 来添加仲裁服务器</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;mongo3:27019&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>输出：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">{</span>
	<span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>查看复制集状态</p> <div class="language-sh extra-class"><pre class="language-sh"><code>rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>输出：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token punctuation">{</span>
	<span class="token string">&quot;set&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;myset&quot;</span>,
	<span class="token string">&quot;myState&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
	<span class="token string">&quot;heartbeatIntervalMillis&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;majorityVoteCount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
	<span class="token string">&quot;writeMajorityCount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
	<span class="token string">&quot;votingMembersCount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
	<span class="token string">&quot;writableVotingMembersCount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;2b6433ebe83c:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PRIMARY&quot;</span>,
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;mongo2:27018&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>,
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;mongo3:27019&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;ARBITER&quot;</span>,
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>ARBITER</code>: 仲裁服务器</li></ul></li></ol> <h2 id="_5-复制集命令"><a href="#_5-复制集命令" class="header-anchor">#</a> 5. 复制集命令</h2> <table><thead><tr><th>命令</th> <th>描述</th></tr></thead> <tbody><tr><td>rs.help()</td> <td>返回命令列表</td></tr> <tr><td>rs.status()</td> <td>返回复制集当前的状态信息。该命令列出了每个成员服务器及其状态信息，包括最后联系时间。该调用可被用于提供整个集群的简单健康检查。</td></tr> <tr><td>rs.initiate()</td> <td>使用默认参数初始化复制集。</td></tr> <tr><td>rs.initiate(replSetCfg)</td> <td>使用配置描述初始化复制集。</td></tr> <tr><td>rs.add(&quot;host:port&quot;)</td> <td>使用含有主机名和特定端口（可选）的简单字符串向复制集中添加成员服务器。</td></tr> <tr><td>rs.add(membercfg)</td> <td>使用配置描述向复制集中添加成员服务器。如果希望指定特定的属性（如设置新成员服务器的优先级），那么必须使用这种方法。</td></tr> <tr><td>rs.addArb(&quot;host:port&quot;)</td> <td>添加新的成员服务器作为仲裁者。该成员不需要使用 <code>--replSet</code> 选项：任何运行在可达机器上的 mongod 实例都可以执行该任务。注意该服务器必须对复制集中的所有成员可达。</td></tr> <tr><td>rs.remove(&quot;host:port&quot;)</td> <td>从复制集中删除指定成员。</td></tr> <tr><td>rs.stepDown()</td> <td>在复制集的主服务器成员中使用该命令时，将使主服务器放弃它的角色，并且在集群中重新选举新的主服务器。注意只有主动辅助服务器可用作主服务器的候选，并且在 60 秒（默认）之内如果没有出现其它可用的成员，那么原有的主服务器将重新成为主服务器。</td></tr> <tr><td>rs.syncFrom(&quot;host:port&quot;)</td> <td>使辅助服务器从指定的成员同步数据，可用于组成复制链。</td></tr> <tr><td>rs.freeze(secs)</td> <td>冻结指定的成员，并使它在指定秒数内无法成为主服务器。</td></tr> <tr><td>rs.slaveOk()</td> <td>通过该选项，可以允许从辅助服务器读取数据，默认是不允许的。</td></tr> <tr><td>rs.conf()</td> <td>重新显示当前副本集的配置结构。改配置结构可以被修改，然后用作 rs.reconfig() 的参数，从而修改结构的配置。</td></tr> <tr><td>rs.reconfig(conf)</td> <td>使用 conf 配置来刷新配置。</td></tr> <tr><td>db.isMaster()</td> <td>该函数不只可作用于复制集：它是一个通用的复制支持函数。通过它，应用或驱动可以判断出被连接的特定实例在复制拓扑结构中是否是主服务器。</td></tr></tbody></table> <h2 id="_6-复制集数据同步原理"><a href="#_6-复制集数据同步原理" class="header-anchor">#</a> 6. 复制集数据同步原理</h2> <blockquote><p>参考：https://www.cnblogs.com/purpleraintear/p/6035111.html</p></blockquote> <h3 id="_6-1-initial-sync"><a href="#_6-1-initial-sync" class="header-anchor">#</a> 6.1 initial_sync</h3> <p>当一个节点刚加入集群时，它需要初始化数据使得 自身与集群中其它节点的数据量差距尽量少，这个过程称为 <strong>initial-sync</strong>。</p> <p>一个 <strong>initial-sync</strong> 包括六步：</p> <p>① 删除本地除 local 库以外的所有 db；</p> <p>② 选取一个源节点，将源节点中的所有 db 导入到本地（注意，此处只导入数据，不导入索引）；</p> <p>③ 将 ② 开始执行到执行结束中源产生的 oplog 应用到本地；</p> <p>④ 将 ③ 开始执行到执行结束中源产生的 oplog 应用到本地；</p> <p>⑤ 从源将所有 table 的索引在本地重建（导入索引）；</p> <p>⑥ 将 ⑤ 开始执行到执行结束中源产生的 oplog 应用到本地；</p> <p>⑦ 当第 ⑥ 步结束后，源和本地的差距足够小，MongoDB 进入 Secondary（从节点）状态。</p> <p>第 ② 步要拷贝所有数据，因此一般第 ② 步消耗时间最长，第 ③ 与第 ④ 步是一个连续逼近的过程，MongoDB 这里做了两次是因为第② 步一般耗时太长，导致第 ③ 步数据量变多，间接受到影响。</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx54b5g7l1j30ef0iajsu.jpg" alt="img"></p> <h3 id="_6-2-steady-sync"><a href="#_6-2-steady-sync" class="header-anchor">#</a> 6.2 steady_sync</h3> <p>当节点初始化完成后，会进入 <strong>steady-sync</strong> 状态，顾名思义，正常情况下，这是一个稳定静默运行于后台的，从复制源不断同步新 oplog 的过程。该过程一般会出现这两种问题：</p> <ol><li><p>复制源写入过快（或者相对的，本地写入速度过慢），复制源的 oplog 覆盖了本地用于同步源 oplog 而维持在源的游标。</p></li> <li><p>本节点在宕机之前是 Primary，在重启后本地 oplog 有和当前 Primary 不一致的 oplog。</p> <p>这两种情况分别如下图所示：</p> <p><img src="https://mc.qcloudimg.com/static/img/d72eb13c214da4197d63ef3666fd8d6d/image.png" alt="img"></p></li></ol> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx54bkqnybj307604v0so.jpg" alt="img"></p> <p>这两种情况在 <code>bgsync.cpp:_produce</code> 函数中，虽然这两种情况很不一样，但是最终都会进入  <code>bgsync.cpp:_rollback</code>函数处理，</p> <p>对于第二种情况，处理过程在 <code>rs_rollback.cpp</code> 中，具体步骤为：</p> <ol><li><p>维持本地与远程的两个反向游标，以线性的时间复杂度找到 LCA（最近公共祖先，上 conflict.png 中为 Record4）</p> <p>该过程与经典的两个有序链表找公共节点的过程类似，具体实现在 <code>roll_back_local_operations.cpp:syncRollBackLocalOperations</code> 中，读者可以自行思考这一过程如何以线性时间复杂度实现。</p></li> <li><p>针对本地每个冲突的 oplog，枚举该 oplog 的类型，推断出回滚该 oplog 需要的逆操作并记录，如下：</p> <blockquote><ol><li>create_table -&gt; drop_table；</li> <li>drop_table -&gt; 重新同步该表；</li> <li>drop_index -&gt; 重新同步并构建索引；</li> <li>drop_db -&gt; 放弃 rollback，改由用户手工 init_resync；</li> <li>apply_ops -&gt; 针对 apply_ops 中的每一条子 oplog，递归执行 2 )这一过程；</li> <li>create_index -&gt; drop_index</li> <li>普通文档的 CUD 操作 -&gt; 从 primary 重新读取真实值并替换。</li></ol> <p>相关函数为：<code>rs_rollback.cpp:refetch</code></p></blockquote></li> <li><p>针对 2）中分析出的每条 oplog 的处理方式，执行处理，相关函数为 <code>rs_rollback.cpp:syncFixUp</code>，此处操作主要是对步骤 2）的实践，实际处理过程相当繁琐。</p></li> <li><p>truncate 掉本地冲突的 oplog。</p> <p>上面我们说到，对于本地失速（stale）的情况，也是走 _rollback 流程统一处理的，对于失速，走 _rollback 时会在找 LCA 这步失败，之后会尝试更换复制源。</p> <p>方法为：从当前存活的所有 secondary 和 primary 节点中找一个使自己“不处于失速”的节点。</p> <p>这里有必要解释一下，oplog 是一个有限大小的 ring-buffer，失速的唯一判断条件为：<strong>本地维护在复制源的游标被复制源的写覆盖（想象一下你和同学同时开始绕着操场跑步，当你被同学超过一圈时，你和同学相遇了）</strong>。因此如果某些节点的 oplog 设置的比较大，绕完一圈的时间就更长，利用这样的节点作为复制源，失速的可能性会更小。</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx54blqymnj30aj093aa6.jpg" alt="img"></p></li></ol> <p><strong>steady-sync 的线程模型与 oplog 指令乱序加速</strong></p> <p>与 steady-sync 相关的代码有 bgsync.cpp， sync_tail.cpp。</p> <p>上面我们介绍过，steady-sync 过程从复制源读取新产生的 oplog，并应用到本地，这样的过程脱不离是一个 producer-consumer 模型。</p> <p>由于 oplog 需要保证顺序性，producer 只能单线程实现。对于 consumer 端，是否有并发提速机制呢?</p> <ol><li><p>首先，不相干的文档之间无需保证 oplog apply 的顺序，因此可以对 oplog 按照 objid 哈希分组。每一组内必须保证严格的写入顺序性。</p> <div class="language- extra-class"><pre class="language-text"><code>572 void fillWriterVectors(OperationContext* txn,
573                        MultiApplier::Operations* ops,
574                        std::vector&lt;MultiApplier::OperationPtrs&gt;* writerVectors) {
581     for (auto&amp;&amp; op : *ops) {
582         StringMapTraits::HashedKey hashedNs(op.ns);
583         uint32_t hash = hashedNs.hash();
584
585         // For doc locking engines, include the _id of the document in the hash so we get
586         // parallelism even if all writes are to a single collection. We can't do this for capped
587         // collections because the order of inserts is a guaranteed property, unlike for normal
588         // collections.
589         if (supportsDocLocking &amp;&amp; op.isCrudOpType() &amp;&amp; !isCapped(txn, hashedNs)) {
590             BSONElement id = op.getIdElement();
591             const size_t idHash = BSONElement::Hasher()(id);
592             MurmurHash3_x86_32(&amp;idHash, sizeof(idHash), hash, &amp;hash);
593         }
601         auto&amp; writer = (*writerVectors)[hash % numWriters];
602         if (writer.empty())
603             writer.reserve(8);  // skip a few growth rounds.
604         writer.push_back(&amp;op);
605     }
606 }
</code></pre></div></li> <li><p>其次对于 command 命令，会对表或者库有全局性的影响，因此 command 命令必须在当前的 consumer 完成工作之后单独处理，而且在处理 command oplog 时，不能有其他命令同时执行。这里可以类比 SMP 体系结构下的 <code>cpu-memory-barrior</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>899     // Check for ops that must be processed one at a time.
900     if (entry.raw.isEmpty() ||       // sentinel that network queue is drained.
901         (entry.opType[0] == 'c') ||  // commands.
902         // Index builds are achieved through the use of an insert op, not a command op.
903         // The following line is the same as what the insert code uses to detect an index build.
904         (!entry.ns.empty() &amp;&amp; nsToCollectionSubstring(entry.ns) == &quot;system.indexes&quot;)) {
905         if (ops-&gt;getCount() == 1) {
906             // apply commands one-at-a-time
907             _networkQueue-&gt;consume(txn);
908         } else {
909             // This op must be processed alone, but we already had ops in the queue so we can't
910             // include it in this batch. Since we didn't call consume(), we'll see this again next
911             // time and process it alone.
912             ops-&gt;pop_back();
913         }
</code></pre></div></li> <li><p>从库和主库的 oplog 顺序必须完全一致，因此不管 1、2 步写入用户数据的顺序如何，oplog 的必须保证顺序性。对于 mmap 引擎的 capped-collection，只能以顺序插入来保证，因此对 oplog 的插入是单线程进行的。对于 wiredtiger 引擎的 capped-collection，可以在 ts（时间戳字段）上加上索引，从而保证读取的顺序与插入的顺序无关。</p> <div class="language- extra-class"><pre class="language-text"><code>517     // Only doc-locking engines support parallel writes to the oplog because they are required to
518     // ensure that oplog entries are ordered correctly, even if inserted out-of-order. Additionally,
519     // there would be no way to take advantage of multiple threads if a storage engine doesn't
520     // support document locking.
521     if (!enoughToMultiThread ||
522         !txn-&gt;getServiceContext()-&gt;getGlobalStorageEngine()-&gt;supportsDocLocking()) {
523
524         threadPool-&gt;schedule(makeOplogWriterForRange(0, ops.size()));
525         return false;
526     }
</code></pre></div></li></ol> <p>steady-sync 的类依赖与线程模型总结如下图：</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx54bmoqllj30dj0d9my1.jpg" alt="img"></p> <h2 id="_7-复制集选举原理"><a href="#_7-复制集选举原理" class="header-anchor">#</a> 7. 复制集选举原理</h2> <blockquote><p>参考：https://www.cnblogs.com/purpleraintear/p/6035111.html</p></blockquote> <h3 id="_7-1-主节点降级"><a href="#_7-1-主节点降级" class="header-anchor">#</a> 7.1 主节点降级</h3> <p>MongoDB 的主节点选举由心跳触发。一个复制集 N 个节点中的任意两个节点维持心跳，每个节点维护其他 N-1 个节点的状态（该状态仅是该节点的 POV，比如因为网络分区，在同一时刻 A 观察 C 处于 down 状态，B 观察 C 处于 seconary 状态）。</p> <p>以任意一个节点的 POV，在每一次心跳后会企图将主节点降级（step down primary），主节点降级的理由如下：</p> <ol><li>心跳检测到有其他 primary 节点的优先级高于当前主节点，则尝试将主节点降级（stepDown) 为 secondary， primary 值的动态变更提供给了运维一个可以热变更主节点的方式；</li> <li>本节点若是主节点，但是无法 ping 通集群中超过半数的节点（majority原则），则将自身降级为 secondary。</li></ol> <h3 id="_7-2-选举主节点"><a href="#_7-2-选举主节点" class="header-anchor">#</a> 7.2 选举主节点</h3> <p>secondary 节点检测到当前集群没有存活的主节点，则尝试将自身选举为 primary。主节点选举是一个 <strong>二阶段过程+多数派协议</strong>。</p> <p><strong>第一阶段</strong></p> <p>以自身 POV，检测自身是否有被选举的资格：</p> <ol><li>能 ping 通集群的过半数节点；</li> <li>priority 必须大于 0；</li> <li>不能是 arbitor 节点（仲裁服务器）；</li></ol> <p>如果检测通过，向集群中所有存活节点发送 <code>FreshnessCheck</code>（询问其他节点关于“我”是否有被选举的资格）</p> <p><strong>同僚仲裁</strong></p> <p>选举第一阶段中，某节点收到其他节点的选举请求后，会执行更严格的同僚仲裁：</p> <ol><li>集群中有其他节点的 primary 比发起者高；</li> <li>不能是 arbitor 节点；</li> <li>primary 必须大于 0；</li> <li>以冲裁者的 POV，发起者的 oplog 必须是集群存活节点中 oplog 最新的（可以有相等的情况，大家都是最新的）；</li></ol> <p><strong>第二阶段</strong></p> <p>发起者向集群中存活节点发送 <code>Elect</code> 请求，仲裁者收到请求的节点会执行一系列合法性检查，如果检查通过，则仲裁者给发起者投一票，并获得 30 秒钟“选举锁”，选举锁的作用是：<strong>在持有锁的时间内不得给其他发起者投票</strong>。</p> <p>发起者如果或者超过半数的投票，则选举通过，自身成为 primary 节点。获得低于半数选票的原因，除了常见的网络问题外，相同优先级的节点同时通过第一阶段的同僚仲裁并进入第二阶段也是一个原因。因此，当选票不足时，会 sleep[0,1] 秒内的随机时间，之后再次尝试选举。</p> <!----></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">12/8/2021, 10:11:56 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/noteSite/backend/middleware/mongodb/05-mongodb-index.html" class="prev">
        五、MongoDB 索引
      </a></span> <span class="next"><a href="/noteSite/backend/middleware/mongodb/07-mongodb-sharding.html">
        七、MongoDB 数据分片
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/noteSite/assets/js/app.a267b983.js" defer></script><script src="/noteSite/assets/js/2.691adf44.js" defer></script><script src="/noteSite/assets/js/82.1add1f8b.js" defer></script>
  </body>
</html>
